(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 12.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[   1018231,      25598]
NotebookOptionsPosition[    981150,      25138]
NotebookOutlinePosition[    981915,      25163]
CellTagsIndexPosition[    981872,      25160]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{":", "Title", ":", " ", "Fretica"}], " ", "*)"}], " ", "\n", 
  RowBox[{"(*", " ", 
   RowBox[{":", "Author", ":", " ", 
    RowBox[{"Daniel", " ", "Nettels"}]}], " ", "*)"}], "\n", 
  RowBox[{"(*", " ", 
   RowBox[{":", "Summary", ":", " ", 
    RowBox[{"Summary", " ", "goes", " ", 
     RowBox[{"here", "."}]}]}], " ", "*)"}], "\n", 
  RowBox[{"(*", " ", 
   RowBox[{":", "Context", ":", " ", "Fretica`Fretica`"}], " ", "*)"}], "\n", 
  RowBox[{"(*", " ", 
   RowBox[{":", 
    RowBox[{"Package", " ", "version"}], ":", " ", "1.0"}], " ", "*)"}], "\n", 
  RowBox[{"(*", " ", 
   RowBox[{":", "History", ":", "  ", 
    RowBox[{"Version", " ", "1.0", " ", "October", " ", "12", " ", "2018"}]}],
    " ", "*)"}], "\n", 
  RowBox[{"(*", " ", 
   RowBox[{":", 
    RowBox[{"Mathematica", " ", "version"}], ":", " ", 
    RowBox[{"11.2", ".0", " ", "for", " ", "Microsoft", " ", "Windows", " ", 
     RowBox[{"(", 
      RowBox[{"64", "-", "bit"}], ")"}], " ", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{"September", " ", "11"}], ",", " ", "2017"}], ")"}]}]}], " ", 
   "*)"}], "\n", 
  RowBox[{"(*", " ", 
   RowBox[{":", "Discussion", ":", " ", 
    RowBox[{"Give", " ", "more", " ", "details", " ", 
     RowBox[{"here", "."}]}]}], "*)"}]}]], "Code",ExpressionUUID->"5da14fe6-\
0a4c-47d9-84fc-9c5c36c7eaef"],

Cell[BoxData[
 RowBox[{
  RowBox[{"Get", "[", "\"\<Fretica`Usage`\>\"", "]"}], ";"}]], "Input",Express\
ionUUID->"13d1e953-44db-4551-b4e3-e4ab92efdeb1"],

Cell[BoxData[
 RowBox[{
  RowBox[{"BeginPackage", "[", "\"\<Fretica`\>\"", "]"}], ";"}]], "Code",
 CellChangeTimes->{
  3.7921558627536726`*^9},ExpressionUUID->"8acfce9a-4628-438e-8ba8-\
adb1acc480d1"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"$FreticaExamples", "=", 
     RowBox[{"FileNameJoin", "[", 
      RowBox[{"{", " ", 
       RowBox[{
       "$UserBaseDirectory", ",", "\"\<Applications\>\"", ",", 
        "\"\<Fretica\>\"", ",", "\"\<Documentation\>\"", ",", 
        "\"\<Example Data\>\""}], "}"}], "]"}]}], ";"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"$FreticaExamples", "=", 
    RowBox[{"FileNameJoin", "[", 
     RowBox[{"{", " ", 
      RowBox[{
       RowBox[{
        RowBox[{"PacletObject", "[", "\"\<Fretica\>\"", "]"}], "[", 
        "\"\<Location\>\"", "]"}], ",", "\"\<Example Data\>\""}], "}"}], 
     "]"}]}], ";"}]}]], "Input",
 CellChangeTimes->{
  3.762250657571762*^9, {3.8578115763091855`*^9, 3.8578115790032735`*^9}, {
   3.8578116280575447`*^9, 3.857811638738771*^9}, 
   3.8578122839378695`*^9},ExpressionUUID->"b5aaa088-b671-413c-bc61-\
c06706fea52c"],

Cell[BoxData[
 RowBox[{"(*", " ", 
  RowBox[{":", 
   RowBox[{"Code", " ", "Section", " ", 
    RowBox[{"(", 
     RowBox[{"Call", " ", "Unprotect", " ", "and", " ", "ClearAll"}], ")"}]}],
    ":"}], " ", "*)"}]], "Input",ExpressionUUID->"6247b2a0-bf5c-4df7-bdff-\
ae1809f0babc"],

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{
   RowBox[{
    RowBox[{"FpdaIntrinsicDistributionPlotOptions", "::", "usage"}], "=", 
    "\"\<Option of FpdaEHisto and FpdaFitEHisto\>\""}], ";"}], 
  "*)"}]], "Input",
 CellChangeTimes->{
  3.7488616304578905`*^9, 3.79395173254325*^9, {3.7939518295620985`*^9, 
   3.79395185007522*^9}, {3.793951890992762*^9, 3.7939519004205675`*^9}, 
   3.793952481563862*^9, {3.80502233421197*^9, 
   3.8050223405390387`*^9}},ExpressionUUID->"9f6655d2-e071-48cb-b8b8-\
413a531203b3"],

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{
   RowBox[{
    RowBox[{"FTSSimulateFRETStateTrajectories", "::", "usage"}], "=", 
    "\"\<FTSSimulateFRETStateTrajectories[{species_Integer,rateparams:{{_?\
NumericQ, _?NumericQ, \
_?NumericQ}..},p0:{_?FRealNumberQ..},Kmatrix:_?(MatrixQ[#,FRealNumberQ]&), \
rcm:_?(MatrixQ[#,FRealNumberQ]&),AcceptorDirectExcitation_?NumericQ}]\>\""}], 
   ";"}], "*)"}]], "Input",
 CellChangeTimes->{{3.800013841576942*^9, 3.800013870472709*^9}, {
   3.8050223446280994`*^9, 3.8050223483551316`*^9}, 
   3.8062955073232284`*^9},ExpressionUUID->"7eeb3db9-c3ac-4c47-a223-\
29a212877451"],

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{
   RowBox[{
    RowBox[{"FGetPIEAnisotropyRoutes", "::", "usage"}], "=", 
    "\"\<FGetPIEAnisotropyRoutes[]\>\""}], ";"}], "*)"}]], "Input",
 CellChangeTimes->{{3.8116723066002216`*^9, 3.811672329110999*^9}, {
  3.8129714622854633`*^9, 
  3.81297146722226*^9}},ExpressionUUID->"64afba57-5648-4775-a5bd-\
6ab6ae871979"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"FShufflePhotonsForT2Alex", "::", "usage"}], "=", 
    "\"\<FShufflePhotonsForT2Alex[{tdex1_Integer,tdex2_Integer},{taex1_\
Integer,taex2_Integer}, ADroute_Integer, AAroute_Integer]\>\""}], ";"}], 
  "\[IndentingNewLine]"}]], "Input",
 CellChangeTimes->{{3.8062954026720057`*^9, 3.8062954183281403`*^9}, {
   3.8062954572770205`*^9, 3.806295460561243*^9}, {3.80629551326235*^9, 
   3.8062955250408916`*^9}, {3.8104605423394456`*^9, 3.810460544068824*^9}, {
   3.811672338545762*^9, 3.8116723412116356`*^9}, 
   3.8116723820274496`*^9},ExpressionUUID->"fd38d1a9-1cd1-40f9-963f-\
a69ec23de402"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"FPhotonTimeRelativeToMarkerHistogram", "::", "usage"}], "=", 
   "\"\<FPhotonTimeRelativeToMarkerHistogram[routelist_FRouteList,\
markerChannel_Integer,tmaxps_Integer]\>\""}], ";"}]], "Input",
 CellChangeTimes->{{3.8062958427676215`*^9, 
  3.806295855010883*^9}},ExpressionUUID->"f74cb62d-0f4e-444d-8fc9-\
3df72f21d694"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"FGetPhotonData", "::", "usage"}], "=", 
   "\"\<FGetPhotonData[{\!\(\*StyleBox[\"tstart\",FontSlant->\"Italic\"]\), \
\!\(\*StyleBox[\"tend\",FontSlant->\"Italic\"]\)}, \!\(\*StyleBox[\"routelist\
\",FontSlant->\"Italic\"]\)] returns all photon records of the time interval \
{\!\(\*StyleBox[\"tstart\",FontSlant->\"Italic\"]\), \
\!\(\*StyleBox[\"tend\",FontSlant->\"Italic\"]\)} (in units of seconds) of \
the detection routes specified by \
\!\(\*StyleBox[\"routelist\",FontSlant->\"Italic\"]\). \
\!\(\*StyleBox[\"routlist\",FontSlant->\"Italic\"]\) is of the form of \
\!\(\*FormBox[RowBox[{\"{\", SubscriptBox[StyleBox[\"r\", \"TI\"], \
\"1\"]}],TraditionalForm]\), \!\(\*FormBox[SubscriptBox[StyleBox[\"r\", \
\"TI\"], \"2\"],TraditionalForm]\), ...\!\(\(TraditionalForm\`}\)\), that is \
a sequence of ones and zeros defining which detector routes are contained or \
not contained in the output.\nThe output of of FGetPhotonData is of the form \
{\!\(\*StyleBox[\"t0\",FontSlant->\"Italic\"]\), { \
{\!\(\*SubscriptBox[StyleBox[\"dt\",FontSlant->\"Italic\"], \"1\"]\), \
\!\(\*StyleBox[\"route1\",FontSlant->\"Italic\"]\), \!\(\*StyleBox[\"channel1\
\",FontSlant->\"Italic\"]\)}, {\!\(\*SubscriptBox[StyleBox[\"dt\",FontSlant->\
\"Italic\"], \"2\"]\), \!\(\*StyleBox[\"route2\",FontSlant->\"Italic\"]\), \!\
\(\*StyleBox[\"channel2\",FontSlant->\"Italic\"]\)}...}}, where \
\!\(\*StyleBox[\"t0\",FontSlant->\"Italic\"]\) is the time origin. \
\!\(\*StyleBox[SubscriptBox[\"dt\", \"i\"],FontSlant->\"Italic\"]\) is the \
inter-photon time of the \!\(\*StyleBox[\"i\",FontSlant->\"Italic\"]\)th \
photon, such that the absolute time is given by \
\!\(\*StyleBox[SubscriptBox[\"t\", \
\"i\"],FontSlant->\"Italic\"]\)\!\(\*StyleBox[\"=\",FontSlant->\"Italic\"]\)\
t0+\!\(\*UnderoverscriptBox[\(\[Sum]\), \(k = 1\), \
\(i\)]\)\!\(\*StyleBox[SubscriptBox[\"dt\", \"i\"],FontSlant->\"Italic\"]\)\!\
\(\*StyleBox[\".\",FontSlant->\"Italic\"]\)\>\""}], ";"}]], "Input",
 CellChangeTimes->{{3.809424247665872*^9, 3.8094242619007463`*^9}, {
  3.858249152971237*^9, 3.8582491728343897`*^9}, {3.858249387851576*^9, 
  3.858249679476185*^9}, {3.85824971882294*^9, 3.858249722900792*^9}, {
  3.858249754378419*^9, 3.8582498565748405`*^9}, {3.8582498943529634`*^9, 
  3.8582501132661543`*^9}, {3.858250145231639*^9, 3.858250218516046*^9}, {
  3.858320865794228*^9, 3.85832086736462*^9}, {3.858320906040182*^9, 
  3.858320916100629*^9}, {3.858320951465706*^9, 3.858320951748599*^9}, {
  3.858320987625572*^9, 3.858321060911747*^9}, {3.858321129565346*^9, 
  3.8583212085598297`*^9}, {3.85832124006433*^9, 3.8583213333691373`*^9}, {
  3.8583225618687363`*^9, 3.858322580068869*^9}, {3.8583241197592535`*^9, 
  3.8583241461257706`*^9}},ExpressionUUID->"f9808b69-9bbf-40fc-ac65-\
cd6e597ddf9d"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"FGetPhotonDataRaw", "::", "usage"}], "=", 
   "\"\<FGetPhotonDataRaw[{\!\(\*StyleBox[\"tstart\",FontSlant->\"Italic\"]\),\
 \!\(\*StyleBox[\"tend\",FontSlant->\"Italic\"]\)}, \
\!\(\*StyleBox[\"routelist\",FontSlant->\"Italic\"]\)] returns all photon \
records of the time interval \
{\!\(\*StyleBox[\"tstart\",FontSlant->\"Italic\"]\), \
\!\(\*StyleBox[\"tend\",FontSlant->\"Italic\"]\)} (in units of seconds) of \
the detection routes specified by \
\!\(\*StyleBox[\"routelist\",FontSlant->\"Italic\"]\). \
\!\(\*StyleBox[\"routlist\",FontSlant->\"Italic\"]\) is of the form of \
\!\(\*FormBox[RowBox[{\"{\", SubscriptBox[StyleBox[\"r\", \"TI\"], \
\"1\"]}],TraditionalForm]\), \!\(\*FormBox[SubscriptBox[StyleBox[\"r\", \
\"TI\"], \"2\"],TraditionalForm]\), ...\!\(\(TraditionalForm\`}\)\), that is \
a sequence of ones and zeros defining which detector routes are contained or \
not contained in the output.\nThe output of of FGetPhotonData is of the form \
{header, {dmicrotimes, routes, microtimes}} with\nheader: \
{\\\"MacroTimeToPicoseconds\\\" \[Rule] macro2ps, \
\\\"MicroTimeToPicoseconds\\\" \[Rule] micro2ps, }, \\\"StartTime\\\"\[Rule] \
t0}\ndmacrotimes: List of inter-photon times. The absolute time in units of \
seconds is given by \!\(\*StyleBox[SubscriptBox[\"t\", \
\"i\"],FontSlant->\"Italic\"]\)\!\(\*StyleBox[\"=\",FontSlant->\"Italic\"]\)\
t0+(\!\(\*UnderoverscriptBox[\(\[Sum]\), \(k = 1\), \
\(i\)]\)\!\(\*StyleBox[\"dmacrotimes\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\
\"\[LeftDoubleBracket]\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\"i\",\
FontSlant->\"Italic\"]\)\!\(\*StyleBox[\"\[RightDoubleBracket]\",FontSlant->\"\
Italic\"]\)\!\(\*StyleBox[\")\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\"*\",\
FontSlant->\"Italic\"]\)macro2ps*\!\(\*SuperscriptBox[\(10\), \
\(-12\)]\)\!\(\*StyleBox[\".\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\" \
\",FontSlant->\"Italic\"]\) \nmicrotimes: List of micro times. They need to \
be mutiplied with micro2ps to obtain the microtimes in picoseconds.\n\n\
\>\""}], ";"}]], "Input",
 CellChangeTimes->{{3.810037375899479*^9, 3.810037384410719*^9}, {
   3.8583243023212576`*^9, 3.8583244174953413`*^9}, {3.858324483043662*^9, 
   3.85832465008527*^9}, {3.8583247175866785`*^9, 3.858324784435378*^9}, {
   3.8583248387544017`*^9, 3.858324932176507*^9}, {3.8583250170244446`*^9, 
   3.8583251948615265`*^9}, {3.8583255120553756`*^9, 3.858325575484295*^9}, {
   3.858333240459138*^9, 3.858333245191885*^9}, {3.858333450971225*^9, 
   3.8583334921788483`*^9}, {3.858333529662998*^9, 3.858333586114969*^9}, {
   3.8583336163312693`*^9, 3.858333750881985*^9}, 3.8583340156177464`*^9, {
   3.8583342180590515`*^9, 3.8583342182841406`*^9}, 3.8648903510525064`*^9, {
   3.864890781391285*^9, 
   3.8648907961741304`*^9}},ExpressionUUID->"e473ebd6-7043-4a3b-bd45-\
c883ac9c4908"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"FExportTTTRToH5", "::", "usage"}], "=", 
   "\"\<FExportTTTRToH5[\\\"\!\(\*StyleBox[\"filename\",FontSlant->\"Italic\"]\
\).h5\\\", {\!\(\*StyleBox[\"tstart\",FontSlant->\"Italic\"]\), \
\!\(\*StyleBox[\"tend\",FontSlant->\"Italic\"]\)}, \!\(\*StyleBox[\"routelist\
\",FontSlant->\"Italic\"]\)] exports the output of \
FGetPhotonDataRaw:[{\!\(\*StyleBox[\"tstart\",FontSlant->\"Italic\"]\), \
\!\(\*StyleBox[\"tend\",FontSlant->\"Italic\"]\)}, \!\(\*StyleBox[\"routelist\
\",FontSlant->\"Italic\"]\)] into a H5 binary file named \
\\\"\!\(\*StyleBox[\"filename\",FontSlant->\"Italic\"]\).h5\\\".\>\""}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.810374915688609*^9, 3.8103749307393584`*^9}, {
  3.858325657654825*^9, 3.858325758456933*^9}, {3.858325804172343*^9, 
  3.8583258146860924`*^9}, {3.858325884841009*^9, 3.8583259111245813`*^9}, {
  3.858325945006831*^9, 
  3.8583259799022703`*^9}},ExpressionUUID->"e3f22fce-f285-4f6e-9f94-\
2907529e7ed0"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"FSetBurstList", "::", "usage"}], "=", 
   "\"\<FSetBurstList[{ {\!\(\*SubscriptBox[\(t\), \(11\)]\), \
\!\(\*SubscriptBox[\(t\), \(12\)]\)}, {\!\(\*SubscriptBox[\(t\), \(21\)]\), \
\!\(\*SubscriptBox[\(t\), \(22\)]\)} ..}] sets the burst list such that the \
\!\(\*StyleBox[\"i\",FontSlant->\"Italic\"]\)th burst starts and ends with \
the photons in closest proximity to \!\(\*SubscriptBox[\(t\), \(i1\)]\) and \
\!\(\*SubscriptBox[\(t\), \(i2\)]\), respectively.\>\""}], ";"}]], "Input",
 CellChangeTimes->{{3.8134959886531677`*^9, 3.8134960060186844`*^9}, {
  3.8583214915261135`*^9, 3.85832152462286*^9}, {3.858321561495244*^9, 
  3.858321637329558*^9}, {3.858321813933671*^9, 3.8583219020218973`*^9}, {
  3.8583226895130463`*^9, 3.85832275291403*^9}, {3.8583293424414043`*^9, 
  3.8583293830325346`*^9}},ExpressionUUID->"9570c7e0-4c0b-4b8e-9c3e-\
f1f1e4407376"],

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{
   RowBox[{
    RowBox[{"F1DHMMSetPinPfin", "::", "usages"}], "=", 
    "\"\<F1DHMMSetPinPfin[pinpfin:{{{_?NumericQ..},{_?NumericQ..}}..}]\>\""}],
    ";"}], "*)"}]], "Input",
 CellChangeTimes->{{3.8121001727698784`*^9, 3.81210018243701*^9}, {
  3.812971722261175*^9, 
  3.812971727440324*^9}},ExpressionUUID->"830f8bbe-9adc-478f-8b05-\
5a8947dd33b8"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"FRawData", "::", "usage"}], "=", 
   "\"\<Option value for FOutput, applicable e.g. in FFCS, FFCSW, FnsFCS, \
FTimeCorrelateWeighted, and FSimulateNanoSecondFCS\>\""}], ";"}]], "Input",
 CellChangeTimes->{{3.814613447885723*^9, 3.814613483725517*^9}, {
   3.8583231019594684`*^9, 3.858323110944065*^9}, {3.8583231518461742`*^9, 
   3.858323158867426*^9}, {3.858323230783408*^9, 3.858323273102313*^9}, {
   3.8583233183716745`*^9, 3.8583233197670174`*^9}, {3.8583233838238816`*^9, 
   3.8583233855783997`*^9}, 
   3.8583240056280375`*^9},ExpressionUUID->"1a7c93c4-eb1c-4b55-a29e-\
5fb7397052bf"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"FMLHGetLikelihoodVpeqFromK", "::", "usage"}], "=", 
   "\"\<FMLHGetLikelihoodVpeqFromK[Km_?FNumericSquareMatrixQ,VList:{_?\
FNumericSquareMatrixQ ..}]\>\""}], ";"}]], "Input",
 CellChangeTimes->{{3.828154894007986*^9, 
  3.8281549051492968`*^9}},ExpressionUUID->"03232659-e573-46a9-ac20-\
3377db5849e1"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"FCalcAV", "::", "usage"}], "=", 
   "\"\<FCalcAV[atoms_?(FNumericMatrixQ[#] && \
Dimensions[#][[2]]==4)&,dyeattachmentpoint:{_?NumericQ,_?NumericQ,_?NumericQ},\
linkerL_?NumericQ,linkerD_?NumericQ,dyeradii:{_?NumericQ,_?NumericQ,_?\
NumericQ},gridspaceing_?NumericQ]\>\""}], ";"}]], "Input",
 CellChangeTimes->{{3.8739798332996902`*^9, 
  3.873979842164742*^9}},ExpressionUUID->"5a157596-aec1-4d74-868b-\
aec9e17f243e"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"FCalcAVMinLinkerLength", "::", "usage"}], "=", 
   "\"\<FCalcAVMinLinkerLength[atoms_?(FNumericMatrixQ[#] && \
Dimensions[#][[2]]==4&),dyeparams:{{{_?NumericQ,_?NumericQ,_?NumericQ},_?\
NumericQ,_?NumericQ,_?NumericQ}..},gridspaceing_?NumericQ]\>\""}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.874642114302684*^9, 
  3.8746421289275565`*^9}},ExpressionUUID->"f91c8ab9-cb19-4514-9289-\
c0b8ea0a6058"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"FTRBPInit", "::", "usage"}], "=", 
   "\"\<FTRBPInit[minmaxpos_,kofflist_,prlist_,pDifflist_,statelist_]\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FTRBPGetKMatrix", "::", "usage"}], "=", 
   "\"\<FTRBPGetKMatrix[]\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FTRBPGetPeq", "::", "usage"}], "=", "\"\<FTRBPGetPeq[]\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FTRBPGetPeqFast", "::", "usage"}], "=", 
   "\"\<FTRBPGetPeqFast[]\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FTRBPSimulatePhotonByPhotonTrace", "::", "usage"}], "=", 
   "\"\<FTRBPSimulatePhotonByPhotonTrace[params:{{photonrates_?\
FNumericMatrixQ,pini:{_?NumericQ..},t_}..}]\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FTRBPSimulateBinnedTrace", "::", "usage"}], "=", 
   "\"\<FTRBPSimulateBinnedTrace[params:{{(*photonrates*)_?FNumericMatrixQ,(*\
pini:*){_?NumericQ..},(*t*)_}..},binning_]\>\""}], ";"}]}], "Input",
 CellChangeTimes->{{3.8378454895498114`*^9, 3.837845500328208*^9}, {
  3.837845574736454*^9, 3.8378455924927197`*^9}, {3.83811588216448*^9, 
  3.8381159062069893`*^9}, {3.8381812362006702`*^9, 3.8381812482383156`*^9}, {
  3.8395839707403135`*^9, 3.8395839878889093`*^9}, {3.8600606943889875`*^9, 
  3.860060718593466*^9}},ExpressionUUID->"cb433ffd-cc15-45aa-8504-\
f3233184262a"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"FTimeCorrelateWeighted", "::", "usage"}], "=", 
   "\"\<FTimeCorrelateWeighted[ { {t11, w11}, {t12, w12}},..}, { {t21, w21}, \
{t22, w22}},..}, taumin, taumax, \
\!\(\*StyleBox[\"inttime2realtime\",FontSlant->\"Italic\"]\)] correlates to \
time series using weights. FTimeCorrelateWeighted uses the algorithm \
described by Wahl et al. (https://doi.org/10.1364/OE.11.003583). The weights \
wij are real numbers. taumin and taumax define the wanted range of lagtimes \
(in real time units). Multiplication with \
\!\(\*StyleBox[\"inttime2realtime\",FontSlant->\"Italic\"]\) converts from \
integer time units to real time units.  \n\nOptions:\n\!\(\(TraditionalForm\`\
\\\ \\\ \)\)FOutput\!\(\(TraditionalForm\` \[Rule] \)\)FData (default) or \
FOutput\!\(\(TraditionalForm\` \[Rule] \)\)FGraph or \
FOutput\!\(\(TraditionalForm\` \[Rule] \)\)FRawData\n\
\!\(\(TraditionalForm\`\\\ \\\ \
\)\)FNumberOfStepsInCascade\!\(\(TraditionalForm\` \[Rule] \)\)10 (default) \
or any other integer value \!\(\(TraditionalForm\` > \)\)0\n\>\""}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.8459872932256117`*^9, 3.8459873131599245`*^9}, {
  3.8460600395928946`*^9, 3.8460600442341537`*^9}, {3.858327671153442*^9, 
  3.858327796593671*^9}, {3.8583278288632903`*^9, 3.8583278342191286`*^9}, {
  3.858327870798006*^9, 3.858327892085354*^9}, {3.8583279500754395`*^9, 
  3.8583279566647873`*^9}, {3.858328036272044*^9, 3.858328039531412*^9}, {
  3.858328086619791*^9, 3.8583281405073323`*^9}, {3.858328249368333*^9, 
  3.858328265660591*^9}, {3.8583283979846983`*^9, 3.858328509069829*^9}, {
  3.8583285704756374`*^9, 3.8583285718240943`*^9}, {3.858328604277376*^9, 
  3.858328724955284*^9}},ExpressionUUID->"5ad63650-decf-44f1-a3b7-\
88aeeb3eccdc"],

Cell[BoxData[
 RowBox[{
  RowBox[{"F1DHMMGetLogLikelihoodList", "::", "usage"}], "=", 
  "\"\<F1DHMMGetLogLikelihoodList[] returns list with the loglikelihoods of \
each trajectory that where calculated in the last call of F1DHMMLogLikelihood\
\>\""}]], "Input",
 CellChangeTimes->{{3.846240382136697*^9, 3.8462405428426266`*^9}, 
   3.8463020795303984`*^9, 
   3.8463021113439903`*^9},ExpressionUUID->"643907c9-1a4b-4c82-9634-\
bffa22b272a2"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FHMMGetLogLikelihoodList", "::", "usage"}], "=", 
  "\"\<FHMMGetLogLikelihoodList[] returns list with the loglikelihoods of \
each trajectory that where calculated in the last call of \
FHMMLogLikelihood.\>\""}]], "Input",
 CellChangeTimes->{{3.8463020463121595`*^9, 3.8463020723987694`*^9}, {
  3.8463021227743664`*^9, 
  3.846302127274397*^9}},ExpressionUUID->"dedee7db-ef5b-4c70-9d25-\
7deca165ab32"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"FGetRouteAssignment", "::", "usage"}], "=", 
   "\"\<FGetRouteAssignment[] returns a list with the route assginment for \
all detectors for the main channels.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FGetPIERouteAssignment", "::", "usage"}], "=", 
   "\"\<FGetPIERouteAssignment[] returns a list with the route assginment for \
all detectors for the PIE channels\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FGetRoutes", "::", "usage"}], "=", 
   "\"\<FGetRoutes[{\\\"A\\\"|\\\"D\\\",\\\"P\\\"|\\\"S\\\"}] or \
FGetRoutes[\\\"A\\\"|\\\"D\\\"], or FGetRoutes[\\\"P\\\"|\\\"S\\\"] return \
the detection route numbers corresponding to assignment of color and/or \
polarisation for the main channels.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"FGetPIERoutes", "::", "usage"}], "=", 
    "\"\<FGetPIERoutes[{\\\"A\\\"|\\\"D\\\",\\\"P\\\"|\\\"S\\\"}] or \
FGetPIERoutes[\\\"A\\\"|\\\"D\\\"], or FGetPIERoutes[\\\"P\\\"|\\\"S\\\"] \
return the detection route numbers corresponding to assignment of color \
and/or polarisation for the PIE channels\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FGetRouteList", "::", "usage"}], "=", 
   "\"\<FGetRouteList[routesnumbers:{_Integer..}] or \
FGetRouteList[routeassignment]  returns a routelist. For example \
FGetRouteList[\\\"A\\\"] might return {1,0,1,0,0,0} or  FGetRouteList[{1,4}] \
returns {1,0,0,1,0,0} \>\""}], ";"}]}], "Input",
 CellChangeTimes->{{3.865495454933755*^9, 3.8654956808462934`*^9}, {
  3.8654957304187255`*^9, 3.8654960372082243`*^9}, {3.8654961827205205`*^9, 
  3.8654961977277718`*^9}, {3.865496235413067*^9, 
  3.865496465594369*^9}},ExpressionUUID->"f5bf219e-d205-43d2-82a8-\
fc644478660b"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"FPIECorrectionFactors", "::", "usage"}], "=", 
   "\"\<FPIECorrectionFactors[EappDonly_,SappAonly_,{ {Eapp1, Sapp1}, {Eapp2, \
Sapp2 }..}] returns the FRET correction factors calculated from the peak \
positions in the Sapp vs Eapp 2D histogram.\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"FSetFretCorrectionFactors", "::", "usage"}], "=", 
    "\"\<FSetFretCorrectionFactors[{\[Alpha], \[Beta], \[Gamma], \
\[Gamma]pie}, G] changes the FRET correction setting according to the values \
provided. The RCM is constructed according to the current detection routes \
assignment.\>\""}], ";"}], " "}]}], "Input",
 CellChangeTimes->{{3.865496727878096*^9, 3.86549705464826*^9}, {
  3.865497089668294*^9, 3.8654972532635317`*^9}, {3.865497504800514*^9, 
  3.865497574653241*^9}},ExpressionUUID->"c7c288d9-05aa-498b-97da-\
779174fdbef5"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FFCSModel", "::", "usage"}], "=", 
  "\"\<FFCSModel[{{\!\(\*SubscriptBox[\(n\), \(1\)]\),\!\(\*SubscriptBox[\(Q1\
\), \(1\)]\),\!\(\*SubscriptBox[\(Q2\), \
\(1\)]\),\!\(\*SubscriptBox[\(\[Tau]diff\), \
\(1\)]\),{{\!\(\*SubscriptBox[\(c1\), \
\(1\)]\),\!\(\*SubscriptBox[\(\[Tau]1\), \
\(1\)]\)},{\!\(\*SubscriptBox[\(c2\), \
\(1\)]\),\!\(\*SubscriptBox[\(\[Tau]2\), \(1\)]\)}..}}, \
{\!\(\*SubscriptBox[\(n\), \(2\)]\),\!\(\*SubscriptBox[\(Q1\), \
\(2\)]\),\!\(\*SubscriptBox[\(Q2\), \
\(2\)]\),\!\(\*SubscriptBox[\(\[Tau]diff\), \
\(2\)]\),{{\!\(\*SubscriptBox[\(c1\), \
\(2\)]\),\!\(\*SubscriptBox[\(\[Tau]1\), \
\(2\)]\)},{\!\(\*SubscriptBox[\(c2\), \
\(2\)]\),\!\(\*SubscriptBox[\(\[Tau]2\), \(2\)]\)}..}}..},a , bg1, bg2][t] \
retruns FCS model for the given parameters as a function of t.\>\""}]], \
"Input",
 CellChangeTimes->{{3.8654976951750393`*^9, 3.8654977409418087`*^9}, {
  3.865497802718977*^9, 3.865498028481478*^9}, {3.8667945247542963`*^9, 
  3.8667945372679424`*^9}},ExpressionUUID->"8f371adf-d376-45a1-b325-\
e342e2d30af9"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"FMakePeakModel2D", "::", "usage"}], "=", 
   "\"\<FMakePeakModel2D[peaknames] returns a {model, var}, where model is \
function with 2D Gaussian peaks. The peaks are assigned to symbols listed in \
peaknames. For example peaknames={\\\"a\\\",\\\"b\\\",...}. var is the list \
of peak parameters.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FFitPeaks2DMakeGuess", "::", "usage"}], "=", 
   "\"\<FFitPeaks2DMakeGuess[xyfdata, peaknames, \
positionguess:{{_?NumericQ,_?NumericQ}..}] returns a list of initial guesses \
for the model defined by FMakePeakModel2D[peaknames] based on the density \
data xyfdat and the xy positions defined in positionguess.\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FFitPeaks2D", "::", "usage"}], "=", 
   "\"\<FFitPeaks2D[xyfdata, peaknames, guess] or FFitPeaks2D[xyfdata, \
peaknames, positionguess:{{_?NumericQ,_?NumericQ}..} fits peaks in a 2D \
distribution  yxfdata with 2D Gaussians. The peaks to be fit are assigned to \
symbols listed in peaknames.\>\""}], ";"}]}], "Input",
 CellChangeTimes->{{3.8654982288841057`*^9, 3.865498492948324*^9}, {
  3.8654985380921955`*^9, 3.865498730842857*^9}, {3.8654987672015305`*^9, 
  3.8654990994113035`*^9}},ExpressionUUID->"93b57c06-f236-4a2a-aa5d-\
1dbc6bcb4a06"],

Cell[CellGroupData[{

Cell["Other Messages", "Subsection",
 CellChangeTimes->{{3.7483292477283816`*^9, 3.7483292579032097`*^9}, {
  3.748329292529594*^9, 
  3.748329293968751*^9}},ExpressionUUID->"3de04541-925b-4b8e-adf0-\
48a12b6f33a1"],

Cell[BoxData[
 RowBox[{"(*", " ", 
  RowBox[{":", 
   RowBox[{"Code", " ", "Section"}], ":"}], " ", "*)"}]], "Input",ExpressionUU\
ID->"2a7e1ec1-f417-4d9c-a13b-9d56c48b08e2"],

Cell[BoxData[
 RowBox[{"(*", " ", 
  RowBox[{":", 
   RowBox[{"Error", " ", "Messages"}], ":"}], " ", "*)"}]], "Code",ExpressionU\
UID->"ecc55701-bc99-4a40-b396-005bf96c4b17"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"FOpenTTTR", "::", "filenotexist"}], "=", 
    "\"\<The file \\\"`1`\\\" does not exist.\>\""}], ";"}], 
  " "}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"FOpenHistoData", "::", "filenotexist"}], "=", 
    "\"\<The file \\\"`1`\\\" does not exist.\>\""}], ";"}], 
  " "}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"FSetRCM", "::", "filenotexist"}], "=", 
    "\"\<The file \\\"`1`\\\" does not exist.\>\""}], ";"}], " "}]}], "Input",
 CellChangeTimes->{
  3.7788513127774076`*^9, {3.778851346865283*^9, 3.77885136801674*^9}, {
   3.778851423369788*^9, 
   3.7788514242733727`*^9}},ExpressionUUID->"ca9242ee-8804-4f9d-953a-\
4484fce52547"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"FHMMSetPhotonRates", "::", "dimerr"}], "=", 
   "\"\<Photon rate vectors are of unequal lenght.\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FHMMSetPhotonRates", "::", "noinit"}], "=", 
   "\"\<HMM system is not initialized.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FHMMLogLikelihood", "::", "erroptval"}], "=", 
   RowBox[{
    RowBox[{"FHMMViterbi", "::", "erroptval"}], "=", 
    "\"\<FHMMpinpfin: Unknown option value.\>\""}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FHMMLogLikelihood", "::", "noinit"}], "=", 
   RowBox[{
    RowBox[{"FHMMViterbi", "::", "noinit"}], "=", 
    "\"\<HMM system is not initialized\>\""}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FHMMLogLikelihood", "::", "dimerr"}], "=", 
   RowBox[{
    RowBox[{"FHMMViterbi", "::", "dimerr"}], "=", 
    "\"\<Missmatch of dimensions.\>\""}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.7501504556830316`*^9, 
  3.750150462506077*^9}},ExpressionUUID->"472c0f29-1489-493a-906c-\
a24ee3842714"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"FpdaFitEHisto", "::", "dimerr"}], "=", 
   "\"\<Mismatch between number of peaks and number of burst size \
distributions.\>\""}], ";"}]], "Input",
 CellChangeTimes->{{3.7939498044328947`*^9, 3.7939498268379664`*^9}, {
   3.7939498591006517`*^9, 3.7939498821342306`*^9}, {3.7939499220555515`*^9, 
   3.79394992668118*^9}, 3.8105430540486*^9, {3.8378455609624863`*^9, 
   3.837845561909529*^9}},ExpressionUUID->"e5747f1f-893d-49ea-a8d9-\
f63333b350ae"],

Cell[BoxData[
 RowBox[{"(*", " ", 
  RowBox[{":", 
   RowBox[{"Code", " ", "Section"}], ":"}], " ", "*)"}]], "Input",ExpressionUU\
ID->"9e6dbcd1-5a0e-4578-9a23-d38686f58633"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Private Section", "Subchapter",ExpressionUUID->"406c29a5-b1ed-4193-953a-f1a696efe4d5"],

Cell[BoxData[
 RowBox[{
  RowBox[{"Begin", "[", "\"\<`Private`\>\"", "]"}], ";"}]], "Code",
 CellChangeTimes->{{3.7759824299729586`*^9, 
  3.775982431319374*^9}},ExpressionUUID->"3cae0149-d38b-4d4d-a6f0-\
10feb90442ab"],

Cell[BoxData[
 RowBox[{"\n", 
  RowBox[{
   RowBox[{"Fretica", " ", "=", " ", 
    RowBox[{"Which", "[", "\n", 
     RowBox[{
      RowBox[{"$System", "==", "\"\<Microsoft Windows (64-bit)\>\""}], ",", 
      " ", 
      RowBox[{"Install", "[", 
       RowBox[{
        RowBox[{"PacletObject", "[", "\"\<Fretica\>\"", "]"}], "[", 
        RowBox[{"\"\<AssetLocation\>\"", ",", "\"\<Fretica64_exe\>\""}], 
        "]"}], "]"}], ",", "\n", 
      RowBox[{"$System", "==", "\"\<Microsoft Windows (32-bit)\>\""}], ",", 
      RowBox[{"(*", 
       RowBox[{"Install", "[", "\"\<Fretica\\\\Fretica32.exe\>\"", "]"}], 
       "*)"}], "\"\<Microsoft Windows (32-bit) is not supported\>\"", ",", 
      "\n", "True", ",", " ", "\"\<Could not link to Fretica\>\""}], "\n", 
     "]"}]}], "\n", 
   RowBox[{"(*", "\n", 
    RowBox[{
     RowBox[{"Install", "[", 
      RowBox[{"LinkConnect", "[", "\"\<freti\>\"", "]"}], "]"}], ";"}], "\n", 
    "*)"}], "s", "\n", 
   RowBox[{"(*", 
    RowBox[{"Set", " ", "up", " ", "FreticaDocumentation", " ", "Kernel"}], 
    "*)"}], "\n", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", "op", "}"}], ",", 
     RowBox[{
      RowBox[{"op", "=", 
       RowBox[{"EvaluatorNames", "/.", 
        RowBox[{"Options", "[", 
         RowBox[{"$FrontEnd", ",", "EvaluatorNames"}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"!", 
         RowBox[{"MemberQ", "[", 
          RowBox[{
           RowBox[{"op", "[", 
            RowBox[{"[", 
             RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", 
           "\"\<FreticaDocumentation\>\""}], "]"}]}], ",", 
        RowBox[{"SetOptions", "[", 
         RowBox[{"$FrontEnd", ",", 
          RowBox[{"EvaluatorNames", "->", 
           RowBox[{"Join", "[", 
            RowBox[{"op", ",", 
             RowBox[{"{", 
              RowBox[{"\"\<FreticaDocumentation\>\"", "\[Rule]", 
               RowBox[{"{", 
                RowBox[{"\"\<AutoStartOnLaunch\>\"", "\[Rule]", "False"}], 
                "}"}]}], "}"}]}], "]"}]}]}], "]"}]}], "]"}], ";"}]}], 
    "\[IndentingNewLine]", "]"}]}]}]], "Code",
 CellChangeTimes->{{3.748329530571887*^9, 3.748329544067837*^9}, {
   3.7536974999373846`*^9, 3.753697516640221*^9}, {3.7536989084803853`*^9, 
   3.7536989111771965`*^9}, {3.7542247334803376`*^9, 
   3.7542247395797524`*^9}, {3.757756044897924*^9, 3.757756047593751*^9}, {
   3.757756188681187*^9, 3.7577562316274595`*^9}, {3.7582615053070393`*^9, 
   3.7582615210330296`*^9}, {3.760885712894597*^9, 3.7608857213180847`*^9}, {
   3.761042559480258*^9, 3.7610425703432107`*^9}, {3.7626022237867603`*^9, 
   3.762602232778737*^9}, {3.76260259804005*^9, 3.7626026089829793`*^9}, {
   3.7626056712701054`*^9, 3.762605681082075*^9}, {3.763978661769025*^9, 
   3.763978670164585*^9}, {3.763978716102032*^9, 3.763978727778817*^9}, {
   3.764313993219839*^9, 3.764314004684201*^9}, {3.764411861967225*^9, 
   3.76441187513004*^9}, {3.7652687687282743`*^9, 3.7652687854983797`*^9}, {
   3.765630066275861*^9, 3.765630090547947*^9}, {3.7656301797759414`*^9, 
   3.7656301800199766`*^9}, {3.765791996192966*^9, 3.7657920045822115`*^9}, {
   3.766986257296179*^9, 3.7669862720782843`*^9}, {3.7673537144743023`*^9, 
   3.7673537249173856`*^9}, {3.7679333353991075`*^9, 3.767933387621004*^9}, {
   3.7680353793600135`*^9, 3.7680353939993687`*^9}, {3.7686494631942244`*^9, 
   3.768649473541785*^9}, {3.7686518798837895`*^9, 3.7686518892133064`*^9}, {
   3.769402613665565*^9, 3.769402624130571*^9}, {3.774346962995569*^9, 
   3.7743469805227203`*^9}, {3.774787055787445*^9, 3.7747870687857246`*^9}, {
   3.7758005538357744`*^9, 3.775800564316736*^9}, {3.7758085099558554`*^9, 
   3.775808535255706*^9}, {3.7759820430716257`*^9, 3.7759820577882676`*^9}, {
   3.7760708391440644`*^9, 3.7760708623549957`*^9}, {3.778326841037871*^9, 
   3.7783268686282716`*^9}, {3.778855235664424*^9, 3.778855259442862*^9}, {
   3.778924010631522*^9, 3.778924023980796*^9}, {3.7801424956931357`*^9, 
   3.7801425124194317`*^9}, {3.7802208861087894`*^9, 
   3.7802209145717297`*^9}, {3.7808948484531374`*^9, 3.780894859555457*^9}, {
   3.7831612861789627`*^9, 3.783161295628704*^9}, {3.784448370435175*^9, 
   3.7844483805970154`*^9}, {3.7857663456603956`*^9, 
   3.7857663578949437`*^9}, {3.792139662699483*^9, 3.79213967858795*^9}, {
   3.792143750125737*^9, 3.792143753838811*^9}, {3.7921438092074995`*^9, 
   3.792143812986397*^9}, {3.792498104901816*^9, 3.79249811729469*^9}, {
   3.79250110968388*^9, 3.7925011285624228`*^9}, {3.792748215173032*^9, 
   3.7927482254944444`*^9}, {3.79275179334269*^9, 3.792751804572651*^9}, {
   3.792752643514773*^9, 3.792752665585723*^9}, {3.792828143814645*^9, 
   3.7928281547035093`*^9}, {3.793950105460039*^9, 3.793950116964282*^9}, {
   3.7946613784019885`*^9, 3.7946613916146326`*^9}, {3.7954292825028114`*^9, 
   3.7954292925459414`*^9}, {3.8000729805550065`*^9, 3.800072993076538*^9}, {
   3.8000800393751893`*^9, 3.8000800658733664`*^9}, {3.8062963033150415`*^9, 
   3.8062963151673975`*^9}, {3.807518450086014*^9, 3.8075184619263515`*^9}, {
   3.8081937699486685`*^9, 3.808193785444238*^9}, {3.808554434122382*^9, 
   3.8085544433905916`*^9}, {3.809422228185289*^9, 3.80942224125734*^9}, {
   3.810185235511831*^9, 3.8101852511391773`*^9}, {3.810374115268134*^9, 
   3.8103741217667856`*^9}, {3.8103743756920586`*^9, 3.810374376213722*^9}, {
   3.8103749697121344`*^9, 3.8103749779919896`*^9}, {3.810465591577989*^9, 
   3.810465600579936*^9}, {3.8105430614937057`*^9, 3.8105430876368313`*^9}, {
   3.8106149871138196`*^9, 3.8106149992703323`*^9}, {3.8116778160083733`*^9, 
   3.81167782776991*^9}, {3.8121007143585787`*^9, 3.8121007357523575`*^9}, {
   3.8129711842448463`*^9, 3.8129711891587057`*^9}, {3.812977150451468*^9, 
   3.812977158793157*^9}, {3.8134965056894855`*^9, 3.813496516938402*^9}, {
   3.8134973001281*^9, 3.813497313691827*^9}, {3.813564350545387*^9, 
   3.8135643677773013`*^9}, {3.8135945768338356`*^9, 3.813594588039912*^9}, {
   3.8139268033302455`*^9, 3.8139268131709256`*^9}, {3.8146161451968575`*^9, 
   3.8146161642250037`*^9}, {3.817195377906085*^9, 3.8171953856255445`*^9}, {
   3.8171963118658514`*^9, 3.8171963272730722`*^9}, {3.8281549131589317`*^9, 
   3.8281549206256995`*^9}, {3.8281589766808662`*^9, 3.828158985234726*^9}, {
   3.830337097713395*^9, 3.830337106193423*^9}, {3.8303419516032915`*^9, 
   3.8303419619281144`*^9}, {3.8317112502243657`*^9, 
   3.8317112614790907`*^9}, {3.8317200069095263`*^9, 3.831720016805624*^9}, {
   3.8317221461566315`*^9, 3.831722156846097*^9}, {3.832236987770665*^9, 
   3.8322369952880135`*^9}, {3.8326598528451233`*^9, 
   3.8326598646945004`*^9}, {3.8326611994004545`*^9, 3.832661210178191*^9}, {
   3.832739096727394*^9, 3.8327391112403316`*^9}, {3.837845217614502*^9, 
   3.83784522463093*^9}, {3.8382789815785985`*^9, 3.8382789978476753`*^9}, {
   3.8383558201473837`*^9, 3.838355829058422*^9}, {3.8395906760820203`*^9, 
   3.839590682963255*^9}, {3.840183450524194*^9, 3.840183458959306*^9}, {
   3.846069556582427*^9, 3.846069567418272*^9}, {3.846302470563867*^9, 
   3.846302478706564*^9}, {3.846302846419216*^9, 3.8463028570518465`*^9}, 
   3.857811821864854*^9, {3.858844655986655*^9, 3.858844669100424*^9}, {
   3.8588516157105236`*^9, 3.8588516291196213`*^9}, {3.8600578055493*^9, 
   3.8600578165058193`*^9}, {3.8600610577967577`*^9, 
   3.8600610667941856`*^9}, {3.8624678763845654`*^9, 3.862467895755129*^9}, {
   3.8629922141824155`*^9, 3.862992224868103*^9}, {3.8648898502967267`*^9, 
   3.864889863948409*^9}, {3.8649048839535522`*^9, 3.864904892163452*^9}, {
   3.865310940052043*^9, 3.865310952516366*^9}, {3.8653927090594006`*^9, 
   3.86539271992767*^9}, {3.872141875187623*^9, 3.8721418843419485`*^9}, {
   3.8721447746291833`*^9, 3.87214478230122*^9}, {3.8721552305986094`*^9, 
   3.8721552396862926`*^9}, {3.872839775810835*^9, 3.872839800701353*^9}, {
   3.873977699863634*^9, 3.873977707985856*^9}, {3.874149821847615*^9, 
   3.8741498312488894`*^9}, {3.8746418019120092`*^9, 
   3.8746418116986103`*^9}, {3.874665388400366*^9, 3.8746654036542997`*^9}, {
   3.8750945119817295`*^9, 3.8750945259299*^9}, {3.8752593384479485`*^9, 
   3.8752593472173595`*^9}, {3.883045656816891*^9, 3.883045666261531*^9}, {
   3.8830508567320223`*^9, 3.883050867473006*^9}, {3.8872524194778147`*^9, 
   3.8872524966259212`*^9}, {3.8886541128759394`*^9, 3.888654123306141*^9}, {
   3.8901930438715796`*^9, 
   3.8901930545994444`*^9}},ExpressionUUID->"43ffc1c7-7840-4a7e-86e5-\
54e86305cf8c"],

Cell[BoxData[
 RowBox[{"(*", " ", 
  RowBox[{":", 
   RowBox[{"Code", " ", "Section"}], ":"}], " ", "*)"}]], "Input",
 CellChangeTimes->{{3.775808519254974*^9, 
  3.775808520828761*^9}},ExpressionUUID->"5b22b420-2183-42fc-8828-\
690704fffe53"],

Cell[CellGroupData[{

Cell["General Functions", "Subsection",ExpressionUUID->"47c7e253-c030-4aa1-bb0c-0430554025dd"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"XYFromYGraph", "[", "wg_YGraph", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"x0", "=", 
       RowBox[{
        RowBox[{"WGx0", "/.", 
         RowBox[{"wg", "[", 
          RowBox[{"[", "1", "]"}], "]"}]}], "//", "N"}]}], ",", 
      RowBox[{"dx", "=", 
       RowBox[{
        RowBox[{"WGdx", "/.", 
         RowBox[{"wg", "[", 
          RowBox[{"[", "1", "]"}], "]"}]}], "//", "N"}]}], ",", 
      RowBox[{"length", "=", 
       RowBox[{"Length", "[", 
        RowBox[{"wg", "[", 
         RowBox[{"[", "2", "]"}], "]"}], "]"}]}]}], "}"}], ",", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{"length", ">", "0"}], ",", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"NestList", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"(", 
             RowBox[{"#", "+", "dx"}], ")"}], "&"}], ",", "x0", ",", 
           RowBox[{"length", "-", "1"}]}], "]"}], ",", 
         RowBox[{"wg", "[", 
          RowBox[{"[", "2", "]"}], "]"}]}], "}"}], "//", "Transpose"}], ",", 
      RowBox[{"{", "}"}]}], "]"}]}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{"HistogramFromYGraph", "[", "wg_YGraph", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"x0", "=", 
       RowBox[{
        RowBox[{"WGx0", "/.", 
         RowBox[{"wg", "[", 
          RowBox[{"[", "1", "]"}], "]"}]}], "//", "N"}]}], ",", 
      RowBox[{"dx", "=", 
       RowBox[{
        RowBox[{"WGdx", "/.", 
         RowBox[{"wg", "[", 
          RowBox[{"[", "1", "]"}], "]"}]}], "//", "N"}]}], ",", 
      RowBox[{"length", "=", 
       RowBox[{"Length", "[", 
        RowBox[{"wg", "[", 
         RowBox[{"[", "2", "]"}], "]"}], "]"}]}]}], "}"}], ",", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"NestList", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"(", 
           RowBox[{"#", "+", "dx"}], ")"}], "&"}], ",", 
         RowBox[{"x0", "+", 
          RowBox[{"0.5", " ", "dx"}]}], ",", 
         RowBox[{"length", "-", "1"}]}], "]"}], ",", 
       RowBox[{"wg", "[", 
        RowBox[{"[", "2", "]"}], "]"}], ",", 
       RowBox[{"Table", "[", 
        RowBox[{"dx", ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "length"}], "}"}]}], "]"}]}], "}"}], "//", 
     "Transpose"}]}], "]"}]}], "\n"}], "Code",ExpressionUUID->"128ef719-0a02-\
4d4a-9772-2fed5f5c78ef"],

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "Histo", "]"}], "=", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"FOutput", "->", "FGraph"}], "}"}], "~", "Join", "~", 
     RowBox[{"Options", "[", "FPlotHisto", "]"}]}]}], ";", "\n", 
   RowBox[{
    RowBox[{"Histo", "[", 
     RowBox[{"dat_List", ",", 
      RowBox[{"{", 
       RowBox[{"min_", ",", "max_", ",", "dx_"}], "}"}], ",", " ", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "histo", "}"}], ",", "\n", 
      RowBox[{
       RowBox[{"histo", "=", 
        RowBox[{"BinCounts", "[", 
         RowBox[{"dat", ",", 
          RowBox[{"{", 
           RowBox[{"min", ",", "max", ",", "dx"}], "}"}]}], "]"}]}], ";", 
       "\n", 
       RowBox[{"histo", "=", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"min", "+", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"i", "-", "0.5"}], ")"}], "dx"}]}], ",", 
            RowBox[{"histo", "[", 
             RowBox[{"[", "i", "]"}], "]"}], ",", "dx"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", 
            RowBox[{"Length", "[", "histo", "]"}]}], "}"}]}], "]"}]}], ";", 
       "\n", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FGraph"}], 
         ",", "\n", 
         RowBox[{"FPlotHisto", "[", 
          RowBox[{"histo", ",", 
           RowBox[{"FilterRules", "[", 
            RowBox[{
             RowBox[{"{", "opts", "}"}], ",", " ", 
             RowBox[{"Options", "[", "FPlotHisto", "]"}]}], "]"}], ",", 
           RowBox[{"ImageSize", "->", "400"}], ",", 
           RowBox[{"AspectRatio", "->", 
            RowBox[{"1", "/", "2"}]}], ",", 
           RowBox[{"Axes", "->", "False"}], ",", 
           RowBox[{"Frame", "->", "True"}], ",", 
           RowBox[{"LabelStyle", "->", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"FontFamily", "->", " ", "\"\<Helvetica\>\""}], ",", 
              RowBox[{"FontSize", "->", " ", "12"}], ",", 
              RowBox[{"FontWeight", "->", " ", "Bold"}]}], "}"}]}], ",", 
           RowBox[{"FrameStyle", "->", " ", 
            RowBox[{"Directive", "[", 
             RowBox[{"Black", ",", 
              RowBox[{"AbsoluteThickness", "[", "1", "]"}]}], "]"}]}]}], 
          "]"}], "\n", ",", "histo"}], "]"}]}]}], "\n", "]"}]}]}], 
  "*)"}]], "Code",
 CellChangeTimes->{{3.7498954125792065`*^9, 3.7498954175718517`*^9}, {
  3.749897024312169*^9, 
  3.749897024320119*^9}},ExpressionUUID->"4fc5406d-e493-4a73-9318-\
c569eaf9f1dc"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "Histo", "]"}], "=", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"FOutput", "->", "FGraph"}], "}"}], "~", "Join", "~", 
    RowBox[{"Options", "[", "Histogram", "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"Histo", "[", 
   RowBox[{
    RowBox[{"dat_List", "|", "dat_WeightedData"}], ",", 
    RowBox[{"{", 
     RowBox[{"min_", ",", "max_", ",", "dx_"}], "}"}], ",", " ", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "histo", "}"}], ",", "\n", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FGraph"}], ",", 
      "\n", 
      RowBox[{"Histogram", "[", 
       RowBox[{"dat", ",", 
        RowBox[{"{", 
         RowBox[{"min", ",", "max", ",", "dx"}], "}"}], ",", 
        RowBox[{"FilterRules", "[", 
         RowBox[{
          RowBox[{"{", "opts", "}"}], ",", " ", 
          RowBox[{"Options", "[", "Histogram", "]"}]}], "]"}], ",", 
        RowBox[{"ImageSize", "->", "400"}], ",", 
        RowBox[{"AspectRatio", "->", 
         RowBox[{"1", "/", "2"}]}], ",", 
        RowBox[{"Axes", "->", "False"}], ",", 
        RowBox[{"Frame", "->", "True"}], ",", 
        RowBox[{"LabelStyle", "->", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"FontFamily", "->", " ", "\"\<Helvetica\>\""}], ",", 
           RowBox[{"FontSize", "->", " ", "12"}], ",", 
           RowBox[{"FontWeight", "->", " ", "Bold"}]}], "}"}]}], ",", 
        RowBox[{"FrameStyle", "->", " ", 
         RowBox[{"Directive", "[", 
          RowBox[{"Black", ",", 
           RowBox[{"AbsoluteThickness", "[", "1", "]"}]}], "]"}]}]}], "]"}], 
      "\n", ",", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"histo", "=", 
         RowBox[{
          RowBox[{"HistogramList", "[", 
           RowBox[{"dat", ",", 
            RowBox[{"{", 
             RowBox[{"min", ",", "max", ",", "dx"}], "}"}]}], "]"}], "[", 
          RowBox[{"[", "2", "]"}], "]"}]}], ";", "\n", 
        RowBox[{"histo", "=", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"min", "+", 
              RowBox[{
               RowBox[{"(", 
                RowBox[{"i", "-", "0.5"}], ")"}], "dx"}]}], ",", 
             RowBox[{"histo", "[", 
              RowBox[{"[", "i", "]"}], "]"}], ",", "dx"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "[", "histo", "]"}]}], "}"}]}], "]"}]}], ";", 
        "\n", "histo"}], ")"}]}], "]"}]}], "\n", "]"}]}]}], "Input",
 CellChangeTimes->{{3.7498952665281253`*^9, 3.7498952706212215`*^9}, {
   3.8653919717015166`*^9, 3.865391975728075*^9}, 
   3.8653921177495947`*^9},ExpressionUUID->"08d66829-9388-482c-b506-\
53579a7ace6d"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FPlotHisto", "]"}], "=", 
   RowBox[{"Options", "[", "Histogram", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FPlotHisto", "[", 
    RowBox[{
     RowBox[{"dat", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"_", ",", "_", ",", "_"}], "}"}], ",", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"_", ",", "_", ",", "_"}], "}"}], ".."}]}], "}"}]}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"xmin", ",", "xmax", ",", "dx"}], "}"}], ",", "\n", 
     RowBox[{
      RowBox[{"dx", "=", 
       RowBox[{"dat", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "3"}], "]"}], "]"}]}], ";", "\n", 
      RowBox[{"xmin", "=", 
       RowBox[{
        RowBox[{"dat", "[", 
         RowBox[{"[", 
          RowBox[{"1", ",", "1"}], "]"}], "]"}], "-", 
        RowBox[{"dx", "/", "2"}]}]}], ";", "\n", 
      RowBox[{"xmax", "=", 
       RowBox[{
        RowBox[{"dat", "[", 
         RowBox[{"[", 
          RowBox[{
           RowBox[{"-", "1"}], ",", "1"}], "]"}], "]"}], "+", 
        RowBox[{"dx", "/", "2"}]}]}], ";", "\n", 
      RowBox[{"Histogram", "[", 
       RowBox[{
        RowBox[{"WeightedData", "[", 
         RowBox[{
          RowBox[{"dat", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", 
          RowBox[{"dat", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "2"}], "]"}], "]"}]}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"xmin", ",", "xmax", ",", "dx"}], "}"}], ",", 
        RowBox[{"FilterRules", "[", 
         RowBox[{
          RowBox[{"{", "opts", "}"}], ",", " ", 
          RowBox[{"Options", "[", "Histogram", "]"}]}], "]"}]}], "]"}]}]}], 
    "\n", "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"FPlotHisto", "[", 
   RowBox[{
    RowBox[{"dat", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"_", ",", "_", ",", "_"}], "}"}], ",", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"_", ",", "_", ",", "_"}], "}"}], ".."}]}], "}"}], ".."}], 
      "}"}]}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"xmin", ",", "xmax", ",", "dx"}], "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"dx", "=", 
      RowBox[{"dat", "[", 
       RowBox[{"[", 
        RowBox[{"1", ",", "1", ",", "3"}], "]"}], "]"}]}], ";", "\n", 
     RowBox[{"xmin", "=", 
      RowBox[{
       RowBox[{"dat", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "1", ",", "1"}], "]"}], "]"}], "-", 
       RowBox[{"dx", "/", "2"}]}]}], ";", "\n", 
     RowBox[{"xmax", "=", 
      RowBox[{
       RowBox[{"dat", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", 
          RowBox[{"-", "1"}], ",", "1"}], "]"}], "]"}], "+", 
       RowBox[{"dx", "/", "2"}]}]}], ";", "\n", 
     RowBox[{"Histogram", "[", 
      RowBox[{
       RowBox[{"MapThread", "[", 
        RowBox[{"WeightedData", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"dat", "[", 
            RowBox[{"[", 
             RowBox[{"All", ",", "All", ",", "1"}], "]"}], "]"}], ",", 
           RowBox[{"dat", "[", 
            RowBox[{"[", 
             RowBox[{"All", ",", "All", ",", "2"}], "]"}], "]"}]}], "}"}]}], 
        "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"xmin", ",", "xmax", ",", "dx"}], "}"}], ",", 
       RowBox[{"FilterRules", "[", 
        RowBox[{
         RowBox[{"{", "opts", "}"}], ",", " ", 
         RowBox[{"Options", "[", "Histogram", "]"}]}], "]"}]}], "]"}]}]}], 
   "\n", "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.7498970499809847`*^9, 
  3.749897068190235*^9}},ExpressionUUID->"c333ae48-f6a9-4cd5-98f4-\
e2e00d3514d9"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "Histo2D", "]"}], "=", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"FOutput", "->", "FGraph"}], "}"}], "~", "Join", "~", 
    RowBox[{"Options", "[", "ListContourPlot", "]"}], "~", "Join", "~", 
    RowBox[{"Options", "[", "ListPlot3D", "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"Histo2D", "[", 
   RowBox[{
    RowBox[{"dat", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"_", ",", "_"}], "}"}], ".."}], "}"}]}], ",", 
    RowBox[{"{", 
     RowBox[{"min1_", ",", "max1_", ",", "d1_"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"min2_", ",", "max2_", ",", "d2_"}], "}"}], ",", " ", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"bc", ",", "xv", ",", "yv", ",", "xyz"}], "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"bc", "=", 
      RowBox[{"BinCounts", "[", 
       RowBox[{"dat", ",", 
        RowBox[{"{", 
         RowBox[{"min1", ",", "max1", ",", "d1"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"min2", ",", "max2", ",", "d2"}], "}"}]}], "]"}]}], ";", 
     "\n", 
     RowBox[{"xv", "=", 
      RowBox[{"Drop", "[", 
       RowBox[{
        RowBox[{"Range", "[", 
         RowBox[{
          RowBox[{"min1", "+", 
           RowBox[{"0.5", " ", "d1"}]}], ",", 
          RowBox[{"max1", "+", 
           RowBox[{"0.5", " ", "d1"}]}], ",", "d1"}], "]"}], ",", 
        RowBox[{"-", "1"}]}], "]"}]}], ";", "\n", 
     RowBox[{"yv", "=", 
      RowBox[{"Drop", "[", 
       RowBox[{
        RowBox[{"Range", "[", 
         RowBox[{
          RowBox[{"min2", "+", 
           RowBox[{"0.5", " ", "d2"}]}], ",", 
          RowBox[{"max2", "+", 
           RowBox[{"0.5", " ", "d2"}]}], ",", "d2"}], "]"}], ",", 
        RowBox[{"-", "1"}]}], "]"}]}], ";", "\n", 
     RowBox[{"xyz", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"xv", "[", 
             RowBox[{"[", "i", "]"}], "]"}], ",", 
            RowBox[{"yv", "[", 
             RowBox[{"[", "j", "]"}], "]"}], ",", 
            RowBox[{"bc", "[", 
             RowBox[{"[", 
              RowBox[{"i", ",", "j"}], "]"}], "]"}]}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", "1", ",", 
            RowBox[{"Length", "[", "xv", "]"}]}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"j", ",", "1", ",", 
            RowBox[{"Length", "[", "yv", "]"}]}], "}"}]}], "]"}], ",", "1"}], 
       "]"}]}], ";", "\n", 
     RowBox[{"Which", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FGraph"}], ",", 
       "\n", 
       RowBox[{"ListContourPlot", "[", 
        RowBox[{"xyz", ",", 
         RowBox[{"FilterRules", "[", 
          RowBox[{
           RowBox[{"{", "opts", "}"}], ",", " ", 
           RowBox[{"Options", "[", "ListContourPlot", "]"}]}], "]"}], ",", 
         RowBox[{"ColorFunction", "->", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"#", "!=", "0"}], ",", 
              RowBox[{"Hue", "[", 
               RowBox[{"(", 
                RowBox[{"0.75", "-", 
                 RowBox[{".75", "#"}]}], ")"}], "]"}], ",", "White"}], "]"}], 
            "&"}], ")"}]}], ",", 
         RowBox[{"LabelStyle", "->", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"FontFamily", "->", " ", "\"\<Helvetica\>\""}], ",", 
            RowBox[{"FontSize", "->", " ", "12"}], ",", 
            RowBox[{"FontWeight", "->", " ", "Bold"}]}], "}"}]}], ",", 
         RowBox[{"PlotRange", "->", "Automatic"}], ",", 
         RowBox[{"FrameStyle", "->", " ", 
          RowBox[{"Directive", "[", 
           RowBox[{"Black", ",", 
            RowBox[{"AbsoluteThickness", "[", "0.8", "]"}]}], "]"}]}], ",", 
         RowBox[{"ImageSize", "->", " ", "400"}], ",", 
         RowBox[{"AspectRatio", "->", 
          RowBox[{"1", "/", "GoldenRatio"}]}]}], "]"}], "\n", ",", 
       RowBox[{
        RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FGraph3D"}], 
       "\n", ",", 
       RowBox[{"ListPlot3D", "[", 
        RowBox[{"xyz", ",", 
         RowBox[{"FilterRules", "[", 
          RowBox[{
           RowBox[{"{", "opts", "}"}], ",", " ", 
           RowBox[{"Options", "[", "ListPlot3D", "]"}]}], "]"}], ",", 
         RowBox[{"LabelStyle", "->", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"FontFamily", "->", " ", "\"\<Helvetica\>\""}], ",", 
            RowBox[{"FontSize", "->", " ", "12"}], ",", 
            RowBox[{"FontWeight", "->", " ", "Bold"}]}], "}"}]}], ",", 
         RowBox[{"PlotRange", "->", "Automatic"}]}], "]"}], "\n", ",", "True",
        ",", "xyz"}], "\n", "]"}]}]}], "\n", "]"}]}]}], "Code",ExpressionUUID->\
"b74bf700-d247-4aa7-adec-e9c8a909fe56"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"IsInPolygonQ", "::", "usage"}], "=", 
   "\"\<\n  IsInPolygonQ[{testx,testy},{{x1,y1},{x2,y2},...}] return true if \
{testx,testy} in inside polygon. \n  Polygon can be closed or not. A point \
will be inside exactly one member of a polygonal partitioning.\n  C-code by \
W. Randolph Franklin \
(http://www.ecse.rpi.edu/Homepages/wrf/Research/Short_Notes/pnpoly.html). \n  \
J. Wesenberg, 2008\>\""}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"IsInPolygonQ", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"testx_", ",", "testy_"}], "}"}], ",", "pts_List"}], "]"}], ":=", 
   RowBox[{"Xor", "@@", 
    RowBox[{"(", 
     RowBox[{
      RowBox[{
       RowBox[{"(", 
        RowBox[{
         RowBox[{"Xor", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"#", "[", 
             RowBox[{"[", 
              RowBox[{"1", ",", "2"}], "]"}], "]"}], ">", "testy"}], ",", 
           RowBox[{
            RowBox[{"#", "[", 
             RowBox[{"[", 
              RowBox[{"2", ",", "2"}], "]"}], "]"}], ">", "testy"}]}], "]"}], 
         "&&", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{"testx", "-", 
             RowBox[{"#", "[", 
              RowBox[{"[", 
               RowBox[{"2", ",", "1"}], "]"}], "]"}]}], ")"}], "<", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"#", "[", 
               RowBox[{"[", 
                RowBox[{"1", ",", "1"}], "]"}], "]"}], "-", 
              RowBox[{"#", "[", 
               RowBox[{"[", 
                RowBox[{"2", ",", "1"}], "]"}], "]"}]}], ")"}], " ", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"testy", "-", 
               RowBox[{"#", "[", 
                RowBox[{"[", 
                 RowBox[{"2", ",", "2"}], "]"}], "]"}]}], ")"}], "/", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"#", "[", 
                RowBox[{"[", 
                 RowBox[{"1", ",", "2"}], "]"}], "]"}], "-", 
               RowBox[{"#", "[", 
                RowBox[{"[", 
                 RowBox[{"2", ",", "2"}], "]"}], "]"}]}], ")"}]}]}]}], 
          ")"}]}], ")"}], "&"}], "/@", 
      RowBox[{"Partition", "[", 
       RowBox[{"pts", ",", "2", ",", "1", ",", 
        RowBox[{"{", 
         RowBox[{"2", ",", "2"}], "}"}]}], "]"}]}], ")"}]}]}], 
  "\n"}], "\n"}], "Code",ExpressionUUID->"96e63556-10ad-4167-ac36-\
0a31d2fc3b3f"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FFindGlobalFit", "]"}], "=", 
   RowBox[{"Options", "[", "FindFit", "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"FFindGlobalFit", "[", 
   RowBox[{"dats_", ",", "models_List", ",", "guess_", ",", "var_", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"gm", ",", "gdat", ",", "pars", ",", "n", ",", "gvar"}], "}"}], 
    ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"pars", "=", 
      RowBox[{"guess", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ";", 
     RowBox[{"gdat", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"Map", "[", 
           RowBox[{
            RowBox[{
             RowBox[{
              RowBox[{"{", "i", "}"}], "~", "Join", "~", "#"}], "&"}], ",", 
            RowBox[{"dats", "[", 
             RowBox[{"[", "i", "]"}], "]"}]}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", "1.", ",", 
            RowBox[{"Length", "[", "dats", "]"}]}], "}"}]}], "]"}], ",", 
        "1"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"gvar", "=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"ListQ", "[", "var", "]"}], ",", "var", ",", 
        RowBox[{"{", "var", "}"}]}], "]"}]}], ";", 
     RowBox[{
      RowBox[{
       RowBox[{"gm", "[", 
        RowBox[{"i_", "?", "NumberQ"}], "]"}], "[", 
       RowBox[{"v_", ",", "p_"}], "]"}], ":=", 
      RowBox[{
       RowBox[{
        RowBox[{"models", "[", 
         RowBox[{"[", 
          RowBox[{"Round", "[", "i", "]"}], "]"}], "]"}], "/.", 
        RowBox[{"(", 
         RowBox[{"Map", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Rule", "[", 
             RowBox[{
              RowBox[{"#", "[", 
               RowBox[{"[", "1", "]"}], "]"}], ",", 
              RowBox[{"#", "[", 
               RowBox[{"[", "2", "]"}], "]"}]}], "]"}], "&"}], ",", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"pars", ",", "p"}], "}"}], "\[Transpose]"}]}], "]"}], 
         ")"}]}], "/.", 
       RowBox[{"(", 
        RowBox[{"Map", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Rule", "[", 
            RowBox[{
             RowBox[{"#", "[", 
              RowBox[{"[", "1", "]"}], "]"}], ",", 
             RowBox[{"#", "[", 
              RowBox[{"[", "2", "]"}], "]"}]}], "]"}], "&"}], ",", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"gvar", ",", "v"}], "}"}], "\[Transpose]"}]}], "]"}], 
        ")"}]}]}], ";", 
     RowBox[{"FindFit", "[", 
      RowBox[{"gdat", ",", 
       RowBox[{
        RowBox[{"gm", "[", "n", "]"}], "[", 
        RowBox[{"gvar", ",", "pars"}], "]"}], ",", "guess", ",", 
       RowBox[{"Join", "[", 
        RowBox[{
         RowBox[{"{", "n", "}"}], ",", "gvar"}], "]"}], ",", 
       RowBox[{"FilterRules", "[", 
        RowBox[{
         RowBox[{"{", "opts", "}"}], ",", " ", 
         RowBox[{"Options", "[", "FindFit", "]"}]}], "]"}]}], "]"}]}]}], "\n",
    "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FFindGlobalFit", "[", 
   RowBox[{
   "dats_", ",", "models_List", ",", "constraints_", ",", "guess_", ",", 
    "var_", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"gm", ",", "gdat", ",", "gvar", ",", "pars", ",", "n"}], "}"}], 
    ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"pars", "=", 
      RowBox[{"guess", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ";", 
     RowBox[{"gdat", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"Map", "[", 
           RowBox[{
            RowBox[{
             RowBox[{
              RowBox[{"{", "i", "}"}], "~", "Join", "~", "#"}], "&"}], ",", 
            RowBox[{"dats", "[", 
             RowBox[{"[", "i", "]"}], "]"}]}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", "1.", ",", 
            RowBox[{"Length", "[", "dats", "]"}]}], "}"}]}], "]"}], ",", 
        "1"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"gvar", "=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"ListQ", "[", "var", "]"}], ",", "var", ",", 
        RowBox[{"{", "var", "}"}]}], "]"}]}], ";", 
     RowBox[{
      RowBox[{
       RowBox[{"gm", "[", 
        RowBox[{"i_", "?", "NumberQ"}], "]"}], "[", 
       RowBox[{"v_", ",", "p_"}], "]"}], ":=", 
      RowBox[{
       RowBox[{
        RowBox[{"models", "[", 
         RowBox[{"[", 
          RowBox[{"Round", "[", "i", "]"}], "]"}], "]"}], "/.", 
        RowBox[{"(", 
         RowBox[{"Map", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Rule", "[", 
             RowBox[{
              RowBox[{"#", "[", 
               RowBox[{"[", "1", "]"}], "]"}], ",", 
              RowBox[{"#", "[", 
               RowBox[{"[", "2", "]"}], "]"}]}], "]"}], "&"}], ",", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"pars", ",", "p"}], "}"}], "\[Transpose]"}]}], "]"}], 
         ")"}]}], "/.", 
       RowBox[{"(", 
        RowBox[{"Map", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Rule", "[", 
            RowBox[{
             RowBox[{"#", "[", 
              RowBox[{"[", "1", "]"}], "]"}], ",", 
             RowBox[{"#", "[", 
              RowBox[{"[", "2", "]"}], "]"}]}], "]"}], "&"}], ",", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"gvar", ",", "v"}], "}"}], "\[Transpose]"}]}], "]"}], 
        ")"}]}]}], ";", 
     RowBox[{"FindFit", "[", 
      RowBox[{"gdat", ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"gm", "[", "n", "]"}], "[", 
          RowBox[{"gvar", ",", "pars"}], "]"}], ",", "constraints"}], "}"}], 
       ",", "guess", ",", 
       RowBox[{"Join", "[", 
        RowBox[{
         RowBox[{"{", "n", "}"}], ",", "gvar"}], "]"}], ",", 
       RowBox[{"FilterRules", "[", 
        RowBox[{
         RowBox[{"{", "opts", "}"}], ",", " ", 
         RowBox[{"Options", "[", "FindFit", "]"}]}], "]"}]}], "]"}]}]}], "\n",
    "]"}]}], "\n"}], "Input",
 CellChangeTimes->{{3.815110234482727*^9, 3.8151102391572323`*^9}, {
  3.8151116018883033`*^9, 3.815111722184413*^9}, {3.815111776769515*^9, 
  3.8151118579684896`*^9}},ExpressionUUID->"3c8596a7-94e8-48e2-919d-\
f06daa734f2e"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FNonlinearModelGlobalFit", "]"}], "=", 
   RowBox[{"Options", "[", "NonlinearModelFit", "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FNonlinearModelGlobalFit", "[", 
    RowBox[{"dats_", ",", "models_List", ",", "guess_", ",", "var_", ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   "\[IndentingNewLine]", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"gm", ",", "gdat", ",", "gvar", ",", "pars", ",", "n"}], "}"}], 
     ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"pars", "=", 
       RowBox[{"guess", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ";", 
      RowBox[{"gdat", "=", 
       RowBox[{"Flatten", "[", 
        RowBox[{
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"Map", "[", 
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{"{", "i", "}"}], "~", "Join", "~", "#"}], "&"}], ",", 
             RowBox[{"dats", "[", 
              RowBox[{"[", "i", "]"}], "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", "1.", ",", 
             RowBox[{"Length", "[", "dats", "]"}]}], "}"}]}], "]"}], ",", 
         "1"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"gvar", "=", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"ListQ", "[", "var", "]"}], ",", "var", ",", 
         RowBox[{"{", "var", "}"}]}], "]"}]}], ";", 
      RowBox[{
       RowBox[{
        RowBox[{"gm", "[", 
         RowBox[{"i_", "?", "NumberQ"}], "]"}], "[", 
        RowBox[{"v_", ",", "p_"}], "]"}], ":=", 
       RowBox[{
        RowBox[{
         RowBox[{"models", "[", 
          RowBox[{"[", 
           RowBox[{"Round", "[", "i", "]"}], "]"}], "]"}], "/.", 
         RowBox[{"(", 
          RowBox[{"Map", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Rule", "[", 
              RowBox[{
               RowBox[{"#", "[", 
                RowBox[{"[", "1", "]"}], "]"}], ",", 
               RowBox[{"#", "[", 
                RowBox[{"[", "2", "]"}], "]"}]}], "]"}], "&"}], ",", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"pars", ",", "p"}], "}"}], "\[Transpose]"}]}], "]"}], 
          ")"}]}], "/.", "\[IndentingNewLine]", 
        RowBox[{"(", 
         RowBox[{"Map", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Rule", "[", 
             RowBox[{
              RowBox[{"#", "[", 
               RowBox[{"[", "1", "]"}], "]"}], ",", 
              RowBox[{"#", "[", 
               RowBox[{"[", "2", "]"}], "]"}]}], "]"}], "&"}], ",", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"gvar", ",", "v"}], "}"}], "\[Transpose]"}]}], "]"}], 
         ")"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"NonlinearModelFit", "[", 
       RowBox[{"gdat", ",", 
        RowBox[{
         RowBox[{"gm", "[", "n", "]"}], "[", 
         RowBox[{"gvar", ",", "pars"}], "]"}], ",", "guess", ",", 
        RowBox[{"Join", "[", 
         RowBox[{
          RowBox[{"{", "n", "}"}], ",", "gvar"}], "]"}], ",", 
        RowBox[{"FilterRules", "[", 
         RowBox[{
          RowBox[{"{", "opts", "}"}], ",", 
          RowBox[{"Options", "[", "NonlinearModelFit", "]"}]}], "]"}]}], 
       "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  "\n"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FNonlinearModelGlobalFit", "[", 
   RowBox[{
   "dats_", ",", "models_List", ",", "constraints_", ",", "guess_", ",", 
    "var_", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"gm", ",", "gdat", ",", "gvar", ",", "pars", ",", "n"}], "}"}], 
    ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"pars", "=", 
      RowBox[{"guess", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ";", 
     RowBox[{"gdat", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"Map", "[", 
           RowBox[{
            RowBox[{
             RowBox[{
              RowBox[{"{", "i", "}"}], "~", "Join", "~", "#"}], "&"}], ",", 
            RowBox[{"dats", "[", 
             RowBox[{"[", "i", "]"}], "]"}]}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", "1.", ",", 
            RowBox[{"Length", "[", "dats", "]"}]}], "}"}]}], "]"}], ",", 
        "1"}], "]"}]}], ";", "  ", "\[IndentingNewLine]", 
     RowBox[{"gvar", "=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"ListQ", "[", "var", "]"}], ",", "var", ",", 
        RowBox[{"{", "var", "}"}]}], "]"}]}], ";", 
     RowBox[{
      RowBox[{
       RowBox[{"gm", "[", 
        RowBox[{"i_", "?", "NumberQ"}], "]"}], "[", 
       RowBox[{"v_", ",", "p_"}], "]"}], ":=", 
      RowBox[{
       RowBox[{
        RowBox[{"models", "[", 
         RowBox[{"[", 
          RowBox[{"Round", "[", "i", "]"}], "]"}], "]"}], "/.", 
        RowBox[{"(", 
         RowBox[{"Map", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Rule", "[", 
             RowBox[{
              RowBox[{"#", "[", 
               RowBox[{"[", "1", "]"}], "]"}], ",", 
              RowBox[{"#", "[", 
               RowBox[{"[", "2", "]"}], "]"}]}], "]"}], "&"}], ",", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"pars", ",", "p"}], "}"}], "\[Transpose]"}]}], "]"}], 
         ")"}]}], "/.", 
       RowBox[{"(", 
        RowBox[{"Map", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Rule", "[", 
            RowBox[{
             RowBox[{"#", "[", 
              RowBox[{"[", "1", "]"}], "]"}], ",", 
             RowBox[{"#", "[", 
              RowBox[{"[", "2", "]"}], "]"}]}], "]"}], "&"}], ",", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"gvar", ",", "v"}], "}"}], "\[Transpose]"}]}], "]"}], 
        ")"}]}]}], ";", " ", 
     RowBox[{"NonlinearModelFit", "[", 
      RowBox[{"gdat", ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"gm", "[", "n", "]"}], "[", 
          RowBox[{"gvar", ",", "pars"}], "]"}], ",", "constraints"}], "}"}], 
       ",", "guess", ",", 
       RowBox[{"Join", "[", 
        RowBox[{
         RowBox[{"{", "n", "}"}], ",", "gvar"}], "]"}], ",", 
       RowBox[{"FilterRules", "[", 
        RowBox[{
         RowBox[{"{", "opts", "}"}], ",", 
         RowBox[{"Options", "[", "NonlinearModelFit", "]"}]}], "]"}]}], 
      "]"}]}]}], "\[IndentingNewLine]", "]"}]}], "\n"}], "Input",
 CellChangeTimes->{{3.8151119437721806`*^9, 3.8151119617770505`*^9}, {
  3.815112001662447*^9, 
  3.815112267586706*^9}},ExpressionUUID->"0f93c200-3fed-4caf-852f-\
82b70f18166c"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"Options", "[", "FLMFit", "]"}], "=", 
     RowBox[{"Options", "[", "FindMinimum", "]"}]}], ";"}], "*)"}], "\n", 
  RowBox[{
   RowBox[{"Clear", "[", "FLMFit", "]"}], "\n", 
   RowBox[{
    RowBox[{"FLMFit", "[", 
     RowBox[{
      RowBox[{"dat", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumberQ"}], ",", 
           RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}]}], ",", 
      "modelfunc_", ",", 
      RowBox[{"guess", ":", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"_", ",", 
            RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}], "|", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"_", ",", 
            RowBox[{"_", "?", "NumberQ"}], ",", 
            RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}]}]}]}], 
     "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "f", ",", "R", ",", "chisq", ",", "params", ",", "fitresult", ",", 
        "tmp"}], "}"}], ",", "\n", 
      RowBox[{
       RowBox[{"params", "=", 
        RowBox[{"guess", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ";", "\n", 
       RowBox[{
        RowBox[{"f", "[", 
         RowBox[{"var", ":", 
          RowBox[{"{", 
           RowBox[{"___", "?", "NumberQ"}], "}"}]}], "]"}], ":=", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{"modelfunc", "/.", 
           RowBox[{"Map", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Rule", "@@", "#"}], "&"}], ",", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"params", ",", "var"}], "}"}], "\[Transpose]"}]}], 
            "]"}]}], ")"}], "[", 
         RowBox[{"dat", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "1"}], "]"}], "]"}], "]"}]}], ";", "\n", 
       RowBox[{
        RowBox[{"R", "[", 
         RowBox[{"var", ":", 
          RowBox[{"{", 
           RowBox[{"___", "?", "NumberQ"}], "}"}]}], "]"}], ":=", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"tmp", "=", 
           RowBox[{"f", "[", "var", "]"}]}], ";", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{"tmp", "-", 
             RowBox[{"dat", "[", 
              RowBox[{"[", 
               RowBox[{"All", ",", "2"}], "]"}], "]"}]}], ")"}], "/", 
           RowBox[{"Sqrt", "[", "tmp", "]"}]}]}], ")"}]}], ";", "\n", 
       RowBox[{
        RowBox[{"chisq", "[", 
         RowBox[{"var", ":", 
          RowBox[{"{", 
           RowBox[{"___", "?", "NumberQ"}], "}"}]}], "]"}], ":=", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"tmp", "=", 
           RowBox[{"R", "[", "var", "]"}]}], ";", 
          RowBox[{"tmp", ".", "tmp"}]}], ")"}]}], ";", "\n", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"MatchQ", "[", 
          RowBox[{"guess", ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"_", ",", 
               RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}]}], "]"}],
          ",", "\n", 
         RowBox[{
          RowBox[{"fitresult", "=", 
           RowBox[{"FindMinimum", "[", 
            RowBox[{"1", ",", "guess", ",", 
             RowBox[{"Method", "->", 
              RowBox[{"{", 
               RowBox[{"\"\<LevenbergMarquardt\>\"", ",", 
                RowBox[{"\"\<Residual\>\"", "->", 
                 RowBox[{"R", "[", "params", "]"}]}]}], "}"}]}]}], "]"}]}], 
          ";", 
          RowBox[{
           RowBox[{"fitresult", "[", 
            RowBox[{"[", "1", "]"}], "]"}], "*=", 
           RowBox[{"2.", "/", 
            RowBox[{"Length", "[", "tmp", "]"}]}]}]}], ",", "\n", 
         RowBox[{
          RowBox[{"fitresult", "=", 
           RowBox[{"FindMinimum", "[", 
            RowBox[{
             RowBox[{"chisq", "[", "params", "]"}], ",", "guess"}], "]"}]}], 
          ";", 
          RowBox[{
           RowBox[{"fitresult", "[", 
            RowBox[{"[", "1", "]"}], "]"}], "*=", 
           RowBox[{"1.", "/", 
            RowBox[{"Length", "[", "tmp", "]"}]}]}]}]}], "]"}], ";", "\n", 
       "fitresult"}]}], "\n", "]"}]}], "\n", "\n", 
   RowBox[{
    RowBox[{"FLMFit", "[", 
     RowBox[{
      RowBox[{"dat", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"_", "?", "NumberQ"}], ",", 
             RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}], ".."}], 
        "}"}]}], ",", "modelfunc_", ",", 
      RowBox[{"guess", ":", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"_", ",", 
            RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}], "|", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"_", ",", 
            RowBox[{"_", "?", "NumberQ"}], ",", 
            RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}]}]}], ",", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "f", ",", "R", ",", "chisq", ",", "params", ",", "fitresult", ",", 
        "tmp"}], "}"}], ",", "\n", 
      RowBox[{
       RowBox[{"params", "=", 
        RowBox[{"guess", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ";", 
       RowBox[{
        RowBox[{"f", "[", 
         RowBox[{"var", ":", 
          RowBox[{"{", 
           RowBox[{"___", "?", "NumberQ"}], "}"}]}], "]"}], ":=", 
        RowBox[{"Flatten", "[", 
         RowBox[{"Map", "[", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"#", "[", 
              RowBox[{"[", "1", "]"}], "]"}], "[", 
             RowBox[{"#", "[", 
              RowBox[{"[", "2", "]"}], "]"}], "]"}], "&"}], ",", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"modelfunc", "/.", 
                RowBox[{"Map", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Rule", "@@", "#"}], "&"}], ",", 
                  RowBox[{
                   RowBox[{"{", 
                    RowBox[{"params", ",", "var"}], "}"}], "\[Transpose]"}]}],
                  "]"}]}], ")"}], ",", 
              RowBox[{"dat", "[", 
               RowBox[{"[", 
                RowBox[{"All", ",", "All", ",", "1"}], "]"}], "]"}]}], "}"}], 
            "\[Transpose]"}]}], "]"}], "]"}]}], ";", 
       RowBox[{
        RowBox[{"R", "[", 
         RowBox[{"var", ":", 
          RowBox[{"{", 
           RowBox[{"___", "?", "NumberQ"}], "}"}]}], "]"}], ":=", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"tmp", "=", 
           RowBox[{"f", "[", "var", "]"}]}], ";", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{"tmp", "-", 
             RowBox[{"Flatten", "[", 
              RowBox[{"dat", "[", 
               RowBox[{"[", 
                RowBox[{"All", ",", "All", ",", "2"}], "]"}], "]"}], "]"}]}], 
            ")"}], "/", 
           RowBox[{"Sqrt", "[", "tmp", "]"}]}]}], ")"}]}], ";", "\n", 
       RowBox[{
        RowBox[{"chisq", "[", 
         RowBox[{"var", ":", 
          RowBox[{"{", 
           RowBox[{"___", "?", "NumberQ"}], "}"}]}], "]"}], ":=", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"tmp", "=", 
           RowBox[{"R", "[", "var", "]"}]}], ";", 
          RowBox[{"tmp", ".", "tmp"}]}], ")"}]}], ";", "\n", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"MatchQ", "[", 
          RowBox[{"guess", ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"_", ",", 
               RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}]}], "]"}],
          ",", "\n", 
         RowBox[{
          RowBox[{"fitresult", "=", 
           RowBox[{"FindMinimum", "[", 
            RowBox[{"1", ",", "guess", ",", 
             RowBox[{"Method", "->", 
              RowBox[{"{", 
               RowBox[{"\"\<LevenbergMarquardt\>\"", ",", 
                RowBox[{"\"\<Residual\>\"", "->", 
                 RowBox[{"R", "[", "params", "]"}]}]}], "}"}]}]}], "]"}]}], 
          ";", 
          RowBox[{
           RowBox[{"fitresult", "[", 
            RowBox[{"[", "1", "]"}], "]"}], "*=", 
           RowBox[{"2.", "/", 
            RowBox[{"Length", "[", "tmp", "]"}]}]}]}], ",", "\n", 
         RowBox[{
          RowBox[{"fitresult", "=", 
           RowBox[{"FindMinimum", "[", 
            RowBox[{
             RowBox[{"chisq", "[", "params", "]"}], ",", "guess"}], "]"}]}], 
          ";", 
          RowBox[{
           RowBox[{"fitresult", "[", 
            RowBox[{"[", "1", "]"}], "]"}], "*=", 
           RowBox[{"1.", "/", 
            RowBox[{"Length", "[", "tmp", "]"}]}]}]}]}], "]"}], ";", "\n", 
       "fitresult"}]}], "\n", "]"}]}]}]}]], "Input",ExpressionUUID->"f401cc4a-\
62bb-42e5-a905-1481c214d409"],

Cell[CellGroupData[{

Cell["Read coordinates from an image", "Subsubsection",ExpressionUUID->"c89a5c52-1392-40aa-9384-1b394385bbaf"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"Clear", "[", "FReadCoordinatesFromImage", "]"}], ";"}], "\n", 
 RowBox[{"SetAttributes", "[", 
  RowBox[{"FReadCoordinatesFromImage", ",", "HoldFirst"}], "]"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FReadCoordinatesFromImage", "[", 
    RowBox[{"outputcurve_", ",", "image_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "whiteLocatorRing", ",", "color", ",", "thickness", ",", "size", ",", 
       "radius", ",", "lineThickness", ",", "opacity", ",", "help"}], "}"}], 
     ",", "\n", 
     RowBox[{"Manipulate", "[", "\n", 
      RowBox[{
       RowBox[{
        RowBox[{
        "help", "=", 
         "\"\<Operation sequence\n1. Enter the reference points at the plot x \
axes into the input fields.\n2. Alt+Click on the point with x-coordinate x1. \
This brings up the first locator visible as a circle. Alt+Click (Command + \
Click for Mac OS X) on that with x2 which gives rise to the second locator. \
Adjust the locators, if necessary. Press the button \\\"Set x scale\\\".\n3. \
Enter the reference points at the plot y axes into the input fields. Press \
Enter. Move the two already existing locators to the points with the \
coordinates y1 and y2. Press the button \\\"Set y scale\\\". Now the both \
scales are captured.\n4. Move the two already existing locators to the first \
two points of the curve to be captured. Alt+Click on other points of the \
curve. Each Alt+Click will generate an additional locator. Adjust locators, \
if necessary. To remove, press Alt+Click on unnecessary locators.\n5. Press \
the button \\\"Update 'listOfPoints'\\\". This assigns the captured list to \
the global variable listOfPoints. Done.\n\n(Adapted from 'copyCurve' of \
Alexei Boulbitch, see http://mathematica.stackexchange.com\>\""}], ";", "\n", 
        RowBox[{"DynamicModule", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"pts", "=", 
             RowBox[{"{", "}"}]}], ",", 
            RowBox[{"x1", "=", "Null"}], ",", 
            RowBox[{"x2", "=", "Null"}], ",", 
            RowBox[{"y1", "=", "Null"}], ",", 
            RowBox[{"y2", "=", "Null"}], ",", "X1", ",", "X2", ",", "Y1", ",",
             "Y2", ",", "\[CapitalDelta]X", ",", "\[CapitalDelta]Y", ",", "g",
             ",", "myRound"}], "}"}], ",", "\n", 
          RowBox[{
           RowBox[{
            RowBox[{"myRound", "[", "x_", "]"}], ":=", 
            RowBox[{
             RowBox[{
              RowBox[{"Round", "[", 
               RowBox[{"1000", "*", "x"}], "]"}], "/", "1000"}], "//", 
             "N"}]}], ";", "\n", 
           RowBox[{"(*", 
            RowBox[{
            "Begins", " ", "the", " ", "column", " ", "with", " ", "all", " ",
              "the", " ", "content", " ", "of", " ", "the", " ", 
             "manipulate"}], "*)"}], 
           RowBox[{"Column", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"(*", 
               RowBox[{"Begin", " ", "LocatorPane"}], "*)"}], 
              RowBox[{
               RowBox[{"Row", "[", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{"Dynamic", "@", 
                   RowBox[{"LocatorPane", "[", 
                    RowBox[{
                    RowBox[{"Union", "[", 
                    RowBox[{"Dynamic", "[", "pts", "]"}], "]"}], ",", 
                    RowBox[{"Dynamic", "@", 
                    RowBox[{"Show", "[", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"Image", "[", 
                    RowBox[{"image", ",", 
                    RowBox[{"ImageSize", "->", "size"}]}], "]"}], ",", 
                    RowBox[{"Graphics", "[", 
                    RowBox[{"{", 
                    RowBox[{"color", ",", 
                    RowBox[{"AbsoluteThickness", "[", "lineThickness", "]"}], 
                    ",", 
                    RowBox[{"Opacity", "[", "opacity", "]"}], ",", 
                    RowBox[{"Line", "[", 
                    RowBox[{"Union", "[", "pts", "]"}], "]"}]}], "}"}], 
                    "]"}]}], "}"}], "]"}]}], ",", 
                    RowBox[{"LocatorAutoCreate", "->", "True"}], ",", "\n", 
                    RowBox[{"(*", 
                    RowBox[{"Begin", " ", "Locator", " ", "appearance"}], 
                    "*)"}], 
                    RowBox[{"Appearance", "->", 
                    RowBox[{"If", "[", 
                    RowBox[{"whiteLocatorRing", ",", "\n", 
                    RowBox[{"Graphics", "[", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"color", ",", 
                    RowBox[{"AbsoluteThickness", "[", "thickness", "]"}], ",", 
                    RowBox[{"Circle", "[", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"0", ",", "0"}], "}"}], ",", 
                    RowBox[{"radius", "+", 
                    RowBox[{"thickness", "/", "2"}]}]}], "]"}]}], "}"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"White", ",", 
                    RowBox[{"AbsoluteThickness", "[", "thickness", "]"}], ",", 
                    RowBox[{"Circle", "[", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"0", ",", "0"}], "}"}], ",", "radius"}], "]"}]}], 
                    "}"}]}], "}"}], ",", 
                    RowBox[{"ImageSize", "->", "10"}]}], "]"}], ",", 
                    RowBox[{"Graphics", "[", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"{", 
                    RowBox[{"color", ",", 
                    RowBox[{"AbsoluteThickness", "[", "thickness", "]"}], ",", 
                    RowBox[{"Circle", "[", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"0", ",", "0"}], "}"}], ",", 
                    RowBox[{"radius", "+", 
                    RowBox[{"thickness", "/", "2"}]}]}], "]"}]}], "}"}], 
                    "}"}], ",", 
                    RowBox[{"ImageSize", "->", "10"}]}], "]"}]}], "]"}]}]}], 
                    RowBox[{"(*", 
                    RowBox[{"End", " ", "Locator", " ", "appearance"}], 
                    "*)"}], "]"}]}], ",", 
                  RowBox[{"Tooltip", "[", 
                   RowBox[{
                    RowBox[{"Style", "[", 
                    RowBox[{"\"\<Help\>\"", ",", "Bold"}], "]"}], ",", 
                    "help"}], "]"}]}], "}"}], "]"}], ",", 
               RowBox[{"(*", 
                RowBox[{"End", " ", "LocatorPane"}], "*)"}], 
               RowBox[{"(*", 
                RowBox[{
                "Begin", " ", "of", " ", "the", " ", "block", " ", "of", " ", 
                 "InputFields"}], "*)"}], "\n", 
               RowBox[{"Row", "[", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{"Spacer", "[", "20", "]"}], ",", 
                  RowBox[{"Button", "[", 
                   RowBox[{
                    RowBox[{"Style", "[", 
                    RowBox[{"\"\<Clear\>\"", ",", "Bold"}], "]"}], ",", 
                    RowBox[{
                    RowBox[{"pts", "=", 
                    RowBox[{"{", "}"}]}], ";"}]}], "]"}]}], "}"}], "]"}], ",", 
               RowBox[{"Row", "[", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{
                  "Style", "[", 
                   "\"\<\\!\\(\\*SubscriptBox[\\(x\\), \\(1\\)]\\):\>\"", 
                   "]"}], ",", 
                  RowBox[{"InputField", "[", 
                   RowBox[{
                    RowBox[{"Dynamic", "[", "x1", "]"}], ",", 
                    RowBox[{
                    "FieldHint", "->", 
                    "\"\<Type  \\!\\(\\*SubscriptBox[\\(x\\), \
\\(1\\)]\\)\>\""}], ",", 
                    RowBox[{"FieldSize", "->", "7"}], ",", 
                    RowBox[{"FieldHintStyle", "->", 
                    RowBox[{"{", "Red", "}"}]}]}], "]"}], ",", 
                  RowBox[{"Spacer", "[", "20", "]"}], ",", 
                  RowBox[{
                  "Style", "[", 
                   "\"\<   \\!\\(\\*SubscriptBox[\\(y\\), \\(1\\)]\\):\>\"", 
                   "]"}], ",", 
                  RowBox[{"InputField", "[", 
                   RowBox[{
                    RowBox[{"Dynamic", "[", "y1", "]"}], ",", 
                    RowBox[{
                    "FieldHint", "->", 
                    "\"\<Type  \\!\\(\\*SubscriptBox[\\(y\\), \
\\(1\\)]\\)\>\""}], ",", 
                    RowBox[{"FieldSize", "->", "7"}], ",", 
                    RowBox[{"FieldHintStyle", "->", 
                    RowBox[{"{", "Red", "}"}]}]}], "]"}]}], "}"}], "]"}], ",", 
               RowBox[{"Row", "[", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{
                  "Style", "[", 
                   "\"\<\\!\\(\\*SubscriptBox[\\(x\\), \\(2\\)]\\):\>\"", 
                   "]"}], ",", 
                  RowBox[{"InputField", "[", 
                   RowBox[{
                    RowBox[{"Dynamic", "[", "x2", "]"}], ",", 
                    RowBox[{
                    "FieldHint", "->", 
                    "\"\<Type \\!\\(\\*SubscriptBox[\\(x\\), \
\\(2\\)]\\)\>\""}], ",", 
                    RowBox[{"FieldSize", "->", "7"}], ",", 
                    RowBox[{"FieldHintStyle", "->", 
                    RowBox[{"{", "Red", "}"}]}]}], "]"}], ",", 
                  RowBox[{"Spacer", "[", "20", "]"}], ",", 
                  RowBox[{
                  "Style", "[", 
                   "\"\<   \\!\\(\\*SubscriptBox[\\(y\\), \\(2\\)]\\):\>\"", 
                   "]"}], ",", 
                  RowBox[{"InputField", "[", 
                   RowBox[{
                    RowBox[{"Dynamic", "[", "y2", "]"}], ",", 
                    RowBox[{
                    "FieldHint", "->", 
                    "\"\<Type  \\!\\(\\*SubscriptBox[\\(y\\), \
\\(2\\)]\\)\>\""}], ",", 
                    RowBox[{"FieldSize", "->", "7"}], ",", 
                    RowBox[{"FieldHintStyle", "->", 
                    RowBox[{"{", "Red", "}"}]}]}], "]"}]}], "}"}], "]"}], ",", 
               RowBox[{"(*", 
                RowBox[{
                "End", " ", "of", " ", "the", " ", "block", " ", "of", " ", 
                 "InputFields"}], "*)"}], 
               RowBox[{"(*", 
                RowBox[{"Begin", " ", "the", " ", "buttons", " ", "row"}], 
                "*)"}], "\n", 
               RowBox[{"Row", "[", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{"Spacer", "[", "15", "]"}], ",", 
                  RowBox[{"(*", 
                   RowBox[{
                   "Begin", " ", "button", " ", "\"\<Memorize scale X\>\""}], 
                   "*)"}], "\n", 
                  RowBox[{"Button", "[", 
                   RowBox[{"\"\<Set x scale\>\"", ",", 
                    RowBox[{
                    RowBox[{"X1", "=", 
                    RowBox[{"Min", "[", 
                    RowBox[{
                    RowBox[{"Transpose", "[", 
                    RowBox[{"myRound", "/@", 
                    RowBox[{"Union", "[", "pts", "]"}]}], "]"}], "[", 
                    RowBox[{"[", "1", "]"}], "]"}], "]"}]}], ";", "\n", 
                    RowBox[{"X2", "=", 
                    RowBox[{"Max", "[", 
                    RowBox[{
                    RowBox[{"Transpose", "[", 
                    RowBox[{"myRound", "/@", 
                    RowBox[{"Union", "[", "pts", "]"}]}], "]"}], "[", 
                    RowBox[{"[", "1", "]"}], "]"}], "]"}]}], ";", "\n", 
                    RowBox[{"\[CapitalDelta]X", "=", 
                    RowBox[{"X2", "-", "X1"}]}], ";"}]}], "]"}], ",", 
                  RowBox[{"(*", 
                   RowBox[{
                   "End", " ", "of", " ", "button", " ", 
                    "\"\<Memorize scale X\>\""}], "*)"}], 
                  RowBox[{"Spacer", "[", "70", "]"}], ",", "\n", 
                  RowBox[{"(*", 
                   RowBox[{
                   "Begin", " ", "button", " ", "\"\<Memorize scale Y\>\""}], 
                   "*)"}], "\n", 
                  RowBox[{"Button", "[", 
                   RowBox[{"\"\<Set y scale\>\"", ",", 
                    RowBox[{
                    RowBox[{"Y1", "=", 
                    RowBox[{"Min", "[", 
                    RowBox[{
                    RowBox[{"Transpose", "[", 
                    RowBox[{"myRound", "/@", 
                    RowBox[{"Union", "[", "pts", "]"}]}], "]"}], "[", 
                    RowBox[{"[", "2", "]"}], "]"}], "]"}]}], ";", "\n", 
                    RowBox[{"Y2", "=", 
                    RowBox[{"Max", "[", 
                    RowBox[{
                    RowBox[{"Transpose", "[", 
                    RowBox[{"myRound", "/@", 
                    RowBox[{"Union", "[", "pts", "]"}]}], "]"}], "[", 
                    RowBox[{"[", "2", "]"}], "]"}], "]"}]}], ";", "\n", 
                    RowBox[{"\[CapitalDelta]Y", "=", 
                    RowBox[{"Y2", "-", "Y1"}]}], ";"}]}], "]"}]}], 
                 RowBox[{"(*", 
                  RowBox[{
                  "End", " ", "of", " ", "button", " ", 
                   "\"\<Memorize scale Y\>\""}], "*)"}], "}"}], "]"}], ",", 
               RowBox[{"(*", 
                RowBox[{"End", " ", "the", " ", "buttons", " ", "row"}], 
                "*)"}], 
               RowBox[{"Spacer", "[", "0", "]"}], ",", "\n", 
               RowBox[{"(*", 
                RowBox[{
                "Begin", " ", "button", " ", 
                 "\"\<Make the list of the curve's points\>\""}], "*)"}], 
               "\n", 
               RowBox[{"Button", "[", 
                RowBox[{
                 RowBox[{"Style", "[", 
                  RowBox[{
                   RowBox[{"\"\<Write coordinates to '\>\"", "<>", 
                    RowBox[{"SymbolName", "[", 
                    RowBox[{"Unevaluated", "[", "outputcurve", "]"}], "]"}], 
                    "<>", "\"\<'\>\""}], ",", "Bold"}], "]"}], ",", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"g", "[", 
                    RowBox[{"{", 
                    RowBox[{"a_", ",", "b_"}], "}"}], "]"}], ":=", 
                   RowBox[{"{", 
                    RowBox[{
                    RowBox[{
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"x1", "*", "X2"}], "-", 
                    RowBox[{"x2", "*", "X1"}]}], ")"}], "/", 
                    "\[CapitalDelta]X"}], "+", 
                    RowBox[{
                    RowBox[{"a", "/", "\[CapitalDelta]X"}], "*", 
                    RowBox[{"Abs", "[", 
                    RowBox[{"x2", "-", "x1"}], "]"}]}]}], ",", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"y1", "*", "Y2"}], "-", 
                    RowBox[{"y2", "*", "Y1"}]}], ")"}], "/", 
                    "\[CapitalDelta]Y"}], "+", 
                    RowBox[{
                    RowBox[{"b", "/", "\[CapitalDelta]Y"}], "*", 
                    RowBox[{"Abs", "[", 
                    RowBox[{"y2", "-", "y1"}], "]"}]}]}]}], "}"}]}], ";", 
                  "\n", 
                  RowBox[{"Clear", "[", "outputcurve", "]"}], ";", "\n", 
                  RowBox[{"outputcurve", "=", 
                   RowBox[{"Map", "[", 
                    RowBox[{"myRound", ",", 
                    RowBox[{"Map", "[", 
                    RowBox[{"g", ",", "pts"}], "]"}]}], "]"}]}]}]}], "]"}]}], 
              RowBox[{"(*", 
               RowBox[{
               "End", " ", "of", " ", "button", " ", 
                "\"\<Make the list...\>\""}], "*)"}], "}"}], "\n", ",", 
             RowBox[{"Alignment", "->", "Center"}]}], "\n", "]"}]}]}], 
         RowBox[{"(*", 
          RowBox[{
          "End", " ", "of", " ", "column", " ", "with", " ", "all", " ", 
           "the", " ", "content", " ", "of", " ", "the", " ", "manipulate"}], 
          "*)"}], "\n", "]"}]}], ",", 
       RowBox[{"(*", 
        RowBox[{"End", " ", "of", " ", "the", " ", "DynamicModule"}], "*)"}], 
       "\n", 
       RowBox[{"(*", 
        RowBox[{
        "The", " ", "massive", " ", "of", " ", "sliders", " ", "begins"}], 
        "*)"}], 
       RowBox[{"Column", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Row", "[", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"Control", "[", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{
                  "whiteLocatorRing", ",", "True", ",", 
                   "\"\<white locator ring\>\""}], "}"}], ",", 
                 RowBox[{"{", 
                  RowBox[{"True", ",", "False"}], "}"}]}], "}"}], "]"}], ",", 
              RowBox[{"Spacer", "[", "50", "]"}]}], "}"}], "]"}], ",", 
           RowBox[{"Row", "[", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"Spacer", "[", "32.35", "]"}], ",", 
              RowBox[{"Control", "[", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{
                  "size", ",", "450", ",", " ", "\"\<image size\>\""}], "}"}],
                  ",", "300", ",", "800"}], "}"}], "]"}], ",", 
              RowBox[{"Spacer", "[", "38.5`", "]"}], ",", 
              RowBox[{"Control", "[", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{"opacity", ",", "0.5", ",", "\"\<Opacity\>\""}], 
                  "}"}], ",", "0", ",", "1"}], "}"}], "]"}]}], "}"}], "]"}], 
           ",", 
           RowBox[{"Row", "[", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"Spacer", "[", "10.", "]"}], ",", 
              RowBox[{"Control", "[", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{
                  "thickness", ",", "1", ",", "\"\<Circle thickness\>\""}], 
                  "}"}], ",", "0.5", ",", "5"}], "}"}], "]"}], ",", 
              RowBox[{"Spacer", "[", "13.65", "]"}], ",", 
              RowBox[{"Control", "[", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{
                  "lineThickness", ",", "1", ",", "\"\<Line thickness\>\""}], 
                  "}"}], ",", "0", ",", "10"}], "}"}], "]"}]}], "}"}], "]"}], 
           ",", 
           RowBox[{"Row", "[", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"Spacer", "[", "22.8", "]"}], ",", 
              RowBox[{"Control", "[", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{"color", ",", "Red", ",", "\"\<Color\>\""}], "}"}], 
                 ",", "Red"}], "}"}], "]"}], ",", 
              RowBox[{"Spacer", "[", "59.3", "]"}], ",", 
              RowBox[{"Control", "[", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{"radius", ",", "0.5", ",", "\"\<Radius\>\""}], 
                  "}"}], ",", "0", ",", "3"}], "}"}], "]"}]}], "}"}], "]"}]}],
           "}"}], ",", 
         RowBox[{"Alignment", "->", "Center"}]}], "]"}], ",", "\n", 
       RowBox[{"(*", 
        RowBox[{
        "The", " ", "massive", " ", "of", " ", "sliders", " ", "ends"}], 
        "*)"}], 
       RowBox[{"(*", 
        RowBox[{"Definitions", " ", "of", " ", "sliders"}], "*)"}], 
       RowBox[{"ControlType", "->", 
        RowBox[{"{", 
         RowBox[{
         "Checkbox", ",", "Slider", ",", "Slider", ",", "Slider", ",", 
          "Slider", ",", "ColorSlider", ",", "Slider"}], "}"}]}], ",", 
       RowBox[{"ControlPlacement", "->", "Top"}], ",", 
       RowBox[{"SaveDefinitions", "->", "True"}], ",", 
       RowBox[{"FrameLabel", "->", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"None", ",", "None"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"None", ",", 
            RowBox[{"Style", "[", 
             RowBox[{"\"\<Curve reader\>\"", ",", "Bold"}], "]"}]}], "}"}]}], 
         "}"}]}]}], "]"}]}], "\n", "]"}]}], ";"}]}], "Input",ExpressionUUID->\
"2050be54-b1ec-43e2-8739-fe7ad6f355ab"]
}, Open  ]]
}, Closed]],

Cell[CellGroupData[{

Cell["Fretica Functions", "Subsection",ExpressionUUID->"a1a4b916-3d2d-439e-93a0-7cd4457bdb62"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FUnlinkFretica", "[", "]"}], ":=", 
  RowBox[{"Uninstall", "[", "Fretica", "]"}]}]], "Input",ExpressionUUID->\
"99c9c72b-8fa8-4967-be81-e1ed4ce7a501"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FAboutFretica", "[", "]"}], ":=", 
  RowBox[{"FPAboutFretica", "[", "]"}], " "}]], "Input",
 CellChangeTimes->{{3.807524012347722*^9, 3.807524038498427*^9}, 
   3.8075253116009483`*^9},ExpressionUUID->"8f3a755e-410a-4152-972e-\
b2dea542b9c1"],

Cell[CellGroupData[{

Cell["Little helpers", "Subsubsection",ExpressionUUID->"08f3d953-c94b-4926-a07f-88f392733a5e"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FNumberOfRoutes", "=", "6"}], ";"}], "\n", 
 RowBox[{
  RowBox[{"FMaxChannel", "=", "32767"}], ";"}]}], "Code",
 CellChangeTimes->{
  3.7489471033191185`*^9},ExpressionUUID->"c9c25d50-38cf-454a-b87e-\
eff8d7728272"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"FGetMaxChannel", "[", "]"}], ":=", "FMaxChannel"}], ";"}]], "Code",\
ExpressionUUID->"1444c74d-6967-481e-be5a-22045075d525"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FRouteList", "=", 
   RowBox[{"{", 
    RowBox[{"Repeated", "[", 
     RowBox[{
      RowBox[{"0", "|", "1"}], ",", "FNumberOfRoutes"}], "]"}], "}"}]}], 
  ";"}]], "Code",ExpressionUUID->"5758ca9d-e0b3-40b5-835a-e4abc858b437"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FExpandRoutelist", "[", "rlist_List", "]"}], ":=", 
  RowBox[{"PadRight", "[", 
   RowBox[{"rlist", ",", "FNumberOfRoutes"}], "]"}]}]], "Code",ExpressionUUID->\
"9c71fa9b-1f43-4dc5-9e54-42a092fea69e"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FRouteListToByte", "[", 
   RowBox[{"route", ":", "FRouteList"}], "]"}], ":=", 
  RowBox[{"Total", "@", 
   RowBox[{"MapIndexed", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"#1", " ", 
       RowBox[{"2", "^", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"#2", "[", 
           RowBox[{"[", "1", "]"}], "]"}], "-", "1"}], ")"}]}]}], "&"}], ",", 
     RowBox[{"FExpandRoutelist", "@", "route"}]}], "]"}]}]}]], "Code",Expressi\
onUUID->"39a92572-ab4d-41ed-bb92-5f25a278d75b"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FValidRouteQ", "[", "route_", "]"}], ":=", 
  RowBox[{"(", 
   RowBox[{
    RowBox[{"IntegerQ", "[", "route", "]"}], " ", "&&", " ", 
    RowBox[{"1", "<=", "route", "<=", "FNumberOfRoutes"}]}], ")"}]}], "\n", 
 RowBox[{
  RowBox[{"FValidChannelQ", "[", "ch_", "]"}], ":=", 
  RowBox[{"(", 
   RowBox[{
    RowBox[{"IntegerQ", "[", "ch", "]"}], " ", "&&", " ", 
    RowBox[{"1", "<=", "ch", "<=", "FMaxChannel"}]}], ")"}]}]}], "Code",Expres\
sionUUID->"f194950f-65ad-478b-8f55-c69f103fe900"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FChannelConstraintsList", "=", 
   RowBox[{"{", 
    RowBox[{"Repeated", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "FValidChannelQ"}], ",", 
        RowBox[{"_", "?", "FValidChannelQ"}]}], "}"}], ",", 
      RowBox[{"{", "FNumberOfRoutes", "}"}]}], "]"}], "}"}]}], ";"}]], "Code",\
ExpressionUUID->"a438be64-3f99-43c9-a60e-c9e86c6d35fa"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FMakeChannelList", "[", 
   RowBox[{"ch", ":", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"_", "?", "FValidChannelQ"}], ",", 
      RowBox[{"_", "?", "FValidChannelQ"}]}], "}"}]}], "]"}], ":=", 
  RowBox[{"ConstantArray", "[", 
   RowBox[{"ch", ",", "FNumberOfRoutes"}], "]"}]}]], "Code",ExpressionUUID->\
"1365dfa5-6b38-4828-9f98-958c4dfe9557"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FRealNumberQ", "=", 
   RowBox[{
    RowBox[{
     RowBox[{"NumberQ", "[", "#", "]"}], "&&", 
     RowBox[{"!", 
      RowBox[{"MatchQ", "[", 
       RowBox[{"#", ",", "_Complex"}], "]"}]}]}], "&"}]}], ";"}]], "Code",Expr\
essionUUID->"2896fbdf-911c-47b1-9e78-8f61a694838d"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FPowerSpectrum", "[", 
   RowBox[{"xydat_", ",", "first\[Nu]_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "fft", ",", "dt", ",", "\[Nu]max", ",", "length", ",", "\[Delta]\[Nu]", 
      ",", "\[Nu]0", ",", "result"}], "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"fft", "=", 
      RowBox[{"Fourier", "[", 
       RowBox[{"xydat", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}]}], ";", "\n", 
     RowBox[{"dt", "=", 
      RowBox[{
       RowBox[{"xydat", "[", 
        RowBox[{"[", 
         RowBox[{"2", ",", "1"}], "]"}], "]"}], "-", 
       RowBox[{"xydat", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "1"}], "]"}], "]"}]}]}], ";", "\n", 
     RowBox[{"\[Nu]max", "=", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"1", " ", "0.5"}], ")"}], "/", " ", "dt"}]}], ";", "\n", 
     RowBox[{"length", "=", 
      RowBox[{"Length", "[", "fft", "]"}]}], ";", 
     RowBox[{"\[Delta]\[Nu]", "=", 
      RowBox[{"1.", "/", 
       RowBox[{"(", 
        RowBox[{"length", " ", "dt"}], ")"}]}]}], ";", 
     RowBox[{"\[Nu]0", "=", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"first\[Nu]", "-", "1"}], ")"}], " ", "\[Delta]\[Nu]"}]}], 
     ";", "\n", 
     RowBox[{"result", "=", 
      RowBox[{"2.", " ", "dt", " ", 
       RowBox[{
        RowBox[{"Abs", "[", 
         RowBox[{"Take", "[", 
          RowBox[{"fft", ",", 
           RowBox[{"{", 
            RowBox[{"first\[Nu]", ",", 
             RowBox[{"Floor", "[", 
              RowBox[{
               RowBox[{"length", "/", "2"}], "+", "1"}], "]"}]}], "}"}]}], 
          "]"}], "]"}], "^", "2"}]}]}], ";", "\n", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"\[Nu]0", "+", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"i", "-", "1"}], ")"}], "\[Delta]\[Nu]"}]}], ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", 
            RowBox[{"Length", "[", "result", "]"}]}], "}"}]}], "]"}], ",", 
        "result"}], "}"}], "\[Transpose]"}]}]}], "\n", "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FPowerSpectrum", "[", "xydat_", "]"}], ":=", 
  RowBox[{"FPowerSpectrum", "[", 
   RowBox[{"xydat", ",", "1"}], "]"}]}]}], "Code",
 CellChangeTimes->{{3.7505900089382515`*^9, 
  3.75059001097381*^9}},ExpressionUUID->"f7bd3ad6-7825-439c-ac46-\
c4803c64c606"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FNumericMatrixQ", "[", "m_", "]"}], ":=", 
  RowBox[{"MatrixQ", "[", 
   RowBox[{"m", ",", "NumericQ"}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FNumericSquareMatrixQ", "[", "m_", "]"}], ":=", 
  RowBox[{
   RowBox[{"SquareMatrixQ", "[", "m", "]"}], " ", "&&", " ", 
   RowBox[{"MatrixQ", "[", 
    RowBox[{"m", ",", "NumericQ"}], "]"}]}]}]}], "Code",ExpressionUUID->\
"226ec1eb-8aeb-4e57-9f03-e801c6e7d356"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FPlotContourHisto", "]"}], "=", 
   RowBox[{"Options", "[", "ListLinePlot", "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FPlotContourHisto", "[", 
    RowBox[{
     RowBox[{"histodat", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"_", ",", "_", ",", "_"}], "}"}], "..."}], "}"}]}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "pts", "}"}], ",", "\n", 
     RowBox[{
      RowBox[{"pts", "=", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Sequence", "@@", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"#", "[", 
                 RowBox[{"[", "1", "]"}], "]"}], "-", 
                RowBox[{"0.5", 
                 RowBox[{"#", "[", 
                  RowBox[{"[", "3", "]"}], "]"}]}]}], ",", 
               RowBox[{"#", "[", 
                RowBox[{"[", "2", "]"}], "]"}]}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"#", "[", 
                 RowBox[{"[", "1", "]"}], "]"}], "+", 
                RowBox[{"0.5", 
                 RowBox[{"#", "[", 
                  RowBox[{"[", "3", "]"}], "]"}]}]}], ",", 
               RowBox[{"#", "[", 
                RowBox[{"[", "2", "]"}], "]"}]}], "}"}]}], "}"}]}], "&"}], 
         ",", "histodat"}], "]"}]}], ";", "\n", 
      RowBox[{"ListLinePlot", "[", 
       RowBox[{"pts", ",", 
        RowBox[{"Evaluate", "@", 
         RowBox[{"FilterRules", "[", 
          RowBox[{
           RowBox[{"{", "opts", "}"}], ",", 
           RowBox[{"Options", "[", "ListLinePlot", "]"}]}], "]"}]}], ",", 
        RowBox[{"PlotRange", "->", "All"}]}], "]"}]}]}], "\n", "]"}]}], 
  "\n"}], "\n", 
 RowBox[{
  RowBox[{"FPlotContourHisto", "[", 
   RowBox[{
    RowBox[{"histodat", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"_", ",", "_", ",", "_"}], "}"}], "..."}], "}"}], ".."}], 
      "}"}]}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "pts", "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"pts", "=", 
      RowBox[{"Map", "[", 
       RowBox[{
        RowBox[{"Sequence", "@@", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{
              RowBox[{"#", "[", 
               RowBox[{"[", "1", "]"}], "]"}], "-", 
              RowBox[{"0.5", 
               RowBox[{"#", "[", 
                RowBox[{"[", "3", "]"}], "]"}]}]}], ",", 
             RowBox[{"#", "[", 
              RowBox[{"[", "2", "]"}], "]"}]}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{
              RowBox[{"#", "[", 
               RowBox[{"[", "1", "]"}], "]"}], "+", 
              RowBox[{"0.5", 
               RowBox[{"#", "[", 
                RowBox[{"[", "3", "]"}], "]"}]}]}], ",", 
             RowBox[{"#", "[", 
              RowBox[{"[", "2", "]"}], "]"}]}], "}"}]}], "}"}]}], "&"}], 
       "]"}]}], ";", "\n", 
     RowBox[{"ListLinePlot", "[", 
      RowBox[{
       RowBox[{"pts", "/@", "histodat"}], ",", 
       RowBox[{"Evaluate", "@", 
        RowBox[{"FilterRules", "[", 
         RowBox[{
          RowBox[{"{", "opts", "}"}], ",", 
          RowBox[{"Options", "[", "ListLinePlot", "]"}]}], "]"}]}], ",", 
       RowBox[{"PlotRange", "->", "All"}]}], "]"}]}]}], "\n", 
   "]"}]}]}], "Code",ExpressionUUID->"3dedd067-5238-4898-a506-fcf3a0b9e62f"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Open TTTR file ", "Subsubsection",ExpressionUUID->"dba62beb-c9a8-4cc0-81f7-48487602bad4"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "FOpenTTTR", "]"}], "=", 
    RowBox[{"{", 
     RowBox[{"FCopyToLocalDisk", "->", "False"}], "}"}]}], ";"}], 
  "\n"}], "\n", 
 RowBox[{
  RowBox[{"FOpenTTTR", "[", 
   RowBox[{"filename_String", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"tmp", ",", 
      RowBox[{"i", "=", "2"}], ",", "result"}], "}"}], ",", "\n", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{"FileExistsQ", "[", "filename", "]"}], ",", "\n", 
      RowBox[{
       RowBox[{"FMaxChannel", "=", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"FileExtension", "[", "filename", "]"}], "===", 
           "\"\<ht3\>\""}], ",", "32767", ",", "32767"}], 
         RowBox[{"(*", "4096", "*)"}], "]"}]}], ";", "\n", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"OptionValue", "[", "FCopyToLocalDisk", "]"}], "==", 
          "True"}], ",", 
         RowBox[{"(", "\n", 
          RowBox[{
           RowBox[{"tmp", "=", 
            RowBox[{"$TemporaryDirectory", "<>", 
             RowBox[{"FileNameTake", "[", "filename", "]"}]}]}], ";", "\n", 
           RowBox[{"While", "[", 
            RowBox[{
             RowBox[{"FileExistsQ", "[", "tmp", "]"}], ",", "\n", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"tmp", "=", 
                RowBox[{"FileNameSplit", "[", "tmp", "]"}]}], ";", 
               RowBox[{
                RowBox[{"tmp", "[", 
                 RowBox[{"[", 
                  RowBox[{"-", "1"}], "]"}], "]"}], "=", 
                RowBox[{"\"\<v\>\"", "<>", 
                 RowBox[{"ToString", "[", "i", "]"}], "<>", 
                 RowBox[{"tmp", "[", 
                  RowBox[{"[", 
                   RowBox[{"-", "1"}], "]"}], "]"}]}]}], ";", 
               RowBox[{"i", "++"}], ";", 
               RowBox[{"tmp", "=", 
                RowBox[{"FileNameJoin", "[", "tmp", "]"}]}], ";"}], ")"}]}], 
            "]"}], ";", 
           RowBox[{"CopyFile", "[", 
            RowBox[{"filename", ",", "tmp"}], "]"}], ";", "\n", 
           RowBox[{"result", "=", 
            RowBox[{"FOpenT3r", "[", 
             RowBox[{"StringReplace", "[", 
              RowBox[{
               RowBox[{"ExpandFileName", "[", "tmp", "]"}], ",", 
               RowBox[{"\"\<\\\\\>\"", "->", "\"\</\>\""}]}], "]"}], "]"}]}], 
           ";", "\n", 
           RowBox[{"DeleteFile", "[", "tmp", "]"}], ";", "\n", "result"}], 
          ")"}], "\n", ",", 
         RowBox[{"FOpenT3r", "[", 
          RowBox[{"StringReplace", "[", 
           RowBox[{
            RowBox[{"ExpandFileName", "[", "filename", "]"}], ",", 
            RowBox[{"\"\<\\\\\>\"", "->", "\"\</\>\""}]}], "]"}], "]"}]}], 
        "\n", "]"}]}], "\n", ",", 
      RowBox[{"Message", "[", 
       RowBox[{
        RowBox[{"FOpenTTTR", "::", "filenotexist"}], ",", "filename"}], 
       "]"}]}], "]"}]}], "\n", "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FOpenTTTR", "[", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"fn", "=", 
      RowBox[{"SystemDialogInput", "[", 
       RowBox[{"\"\<FileOpen\>\"", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"NotebookDirectory", "[", "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"\"\<TTTR\>\"", "->", 
            RowBox[{"{", 
             RowBox[{
             "\"\<*.t3r\>\"", ",", "\"\<*.pt2\>\"", ",", "\"\<*.pt3\>\"", 
              ",", "\"\<*.ht2\>\"", ",", "\"\<*.ht3\>\"", ",", 
              "\"\<*.ptu\>\""}], "}"}]}], "}"}]}], "}"}]}], "]"}]}], "}"}], 
    ",", "\n", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{"fn", "===", "$Canceled"}], ",", "fn", ",", " ", 
      RowBox[{"FOpenTTTR", "[", "fn", "]"}]}], "]"}]}], "\n", "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FOpenTTTR", "[", 
   RowBox[{"filename_String", ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"tstartSec_", "?", "NumberQ"}], ",", 
      RowBox[{"tstopSec_", "?", "NumberQ"}]}], "}"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"tmp", ",", 
      RowBox[{"t1", "=", "tstartSec"}], ",", 
      RowBox[{"t2", "=", "tstopSec"}]}], "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"t1", "<", "0"}], ",", 
       RowBox[{"t1", "=", "0"}]}], "]"}], ";", "\n", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"t2", "<", "0"}], ",", 
       RowBox[{"t2", "=", "0"}]}], "]"}], ";", "\n", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"t1", ">", "t2"}], ",", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"tmp", "=", "t1"}], ";", 
         RowBox[{"t1", "=", "t2"}], ";", 
         RowBox[{"t2", "=", "tmp"}], ";"}], ")"}]}], "]"}], ";", "\n", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"FileExistsQ", "[", "filename", "]"}], ",", 
       RowBox[{"FOpenT3r", "[", 
        RowBox[{
         RowBox[{"StringReplace", "[", 
          RowBox[{
           RowBox[{"ExpandFileName", "[", "filename", "]"}], ",", 
           RowBox[{"\"\<\\\\\>\"", "->", "\"\</\>\""}]}], "]"}], ",", 
         RowBox[{"N", "@", "t1"}], ",", 
         RowBox[{"N", "@", "t2"}]}], "]"}], ",", 
       RowBox[{"Message", "[", 
        RowBox[{
         RowBox[{"FOpenTTTR", "::", "filenotexist"}], ",", "filename"}], 
        "]"}]}], "]"}]}]}], "\n", "]"}]}]}], "Input",
 CellChangeTimes->{
  3.7788513315671773`*^9},ExpressionUUID->"8d559a9a-0418-4c8a-8a63-\
cf7b23a5e5f9"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FSaveAsHT3", "[", "filename_String", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "fn", "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"fn", "=", 
      RowBox[{"StringReplace", "[", 
       RowBox[{
        RowBox[{"ExpandFileName", "[", "filename", "]"}], ",", 
        RowBox[{"\"\<\\\\\>\"", "->", "\"\</\>\""}]}], "]"}]}], ";", "\n", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"!", 
        RowBox[{"FileExistsQ", "[", "fn", "]"}]}], ",", 
       RowBox[{"FPSaveAsHt3", "[", "fn", "]"}], ",", "0"}], "]"}]}]}], "\n", 
   "\n", "]"}]}]], "Input",ExpressionUUID->"6809ee8b-282a-4220-88e2-\
7ea8d1d1b1c6"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FTTTRCreationTime", "[", "]"}], ":=", " ", 
  RowBox[{"DateList", "[", 
   RowBox[{"FTTTRCreationDateStr", "[", "]"}], "]"}]}]], "Input",ExpressionUUI\
D->"2958cd6a-aff6-40d3-9404-cc91359e9adb"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FGetFromHeader", "[", "s_String", "]"}], ":=", 
  RowBox[{"ToExpression", "[", 
   RowBox[{
    RowBox[{"StringCases", "[", 
     RowBox[{
      RowBox[{"FShowHeader", "[", "]"}], ",", 
      RowBox[{
       RowBox[{
       "s", "~~", "Whitespace", "~~", "\"\<:\>\"", "~~", "Whitespace", "~~", 
        RowBox[{"v", ":", 
         RowBox[{"NumberString", ".."}]}]}], "->", "v"}]}], "]"}], "[", 
    RowBox[{"[", "1", "]"}], "]"}], "]"}]}]], "Input",ExpressionUUID->\
"19436db9-611a-4af6-b178-b7f805520c36"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FGetMarkerList", "[", "]"}], ":=", 
  RowBox[{"FPGetMarkerList", "[", "]"}]}]], "Input",ExpressionUUID->"18298a43-\
b03d-4b84-8861-cf7098d907a7"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"FGetT3rFilename", "[", "]"}], ":=", 
   RowBox[{"FPGetT3rFilename", "[", "]"}]}], ";"}]], "Input",ExpressionUUID->\
"71f8278d-7905-4847-b655-e3edb9780d45"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"FGetStartTime", "[", "]"}], ":=", 
   RowBox[{"FPGetStartTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FGetStopTime", "[", "]"}], ":=", 
   RowBox[{"FPGetStopTime", "[", "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.80941809370138*^9, 
  3.8094181393563166`*^9}},ExpressionUUID->"b7f1cb43-6dfb-4d9d-89cc-\
18a90eeb66cd"]
}, Closed]],

Cell[CellGroupData[{

Cell["\<\
Open PicoQuant histogram data files: \".phd\" or \".hhd\" (Lifetimecurves)\
\>", "Subsubsection",ExpressionUUID->"ccb381ff-30d1-4f94-80e2-8f2837c56f64"],

Cell[BoxData[
 RowBox[{"\n", 
  RowBox[{
   RowBox[{
    RowBox[{"FOpenHistoData", "[", "filename_String", "]"}], ":=", "\n", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "}"}], ",", "\n", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"FileExistsQ", "[", "filename", "]"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"Which", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"FileExtension", "[", "filename", "]"}], "\[Equal]", 
            "\"\<phd\>\""}], " ", "||", " ", 
           RowBox[{
            RowBox[{"FileExtension", "[", "filename", "]"}], "\[Equal]", 
            "\"\<hhd\>\""}]}], ",", "\[IndentingNewLine]", 
          RowBox[{"(", "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{"XYFromYGraph", "/@", 
             RowBox[{"(", 
              RowBox[{"List", "@@", 
               RowBox[{"ToExpression", "[", 
                RowBox[{"FOpenHHDStr", "[", 
                 RowBox[{"StringReplace", "[", 
                  RowBox[{
                   RowBox[{"ExpandFileName", "[", "filename", "]"}], ",", 
                   RowBox[{"\"\<\\\\\>\"", "->", "\"\</\>\""}]}], "]"}], 
                 "]"}], "]"}]}], ")"}]}], "*)"}], "\[IndentingNewLine]", 
           RowBox[{"FOpenHHDStr", "[", 
            RowBox[{"StringReplace", "[", 
             RowBox[{
              RowBox[{"ExpandFileName", "[", "filename", "]"}], ",", 
              RowBox[{"\"\<\\\\\>\"", "->", "\"\</\>\""}]}], "]"}], "]"}], 
           "\[IndentingNewLine]", ")"}], "\[IndentingNewLine]", ",", 
          RowBox[{
           RowBox[{"FileExtension", "[", "filename", "]"}], "\[Equal]", 
           "\"\<phu\>\""}], ",", "\[IndentingNewLine]", 
          RowBox[{"(", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{
              RowBox[{"{", 
               RowBox[{
                RowBox[{
                 RowBox[{"#", "[", 
                  RowBox[{"[", "1", "]"}], "]"}], 
                 SuperscriptBox["10.", "9"], 
                 RowBox[{"Range", "[", 
                  RowBox[{"Length", "[", 
                   RowBox[{"#", "[", 
                    RowBox[{"[", "2", "]"}], "]"}], "]"}], "]"}]}], ",", 
                RowBox[{"#", "[", 
                 RowBox[{"[", "2", "]"}], "]"}]}], "}"}], "\[Transpose]"}], 
             "&"}], "/@", 
            RowBox[{"FPOpenPHU", "[", 
             RowBox[{"ExpandFileName", "[", "filename", "]"}], "]"}]}], 
           "\[IndentingNewLine]", ")"}], "\[IndentingNewLine]", ",", "True", 
          ",", 
          RowBox[{"{", "}"}]}], "\[IndentingNewLine]", "]"}], 
        "\[IndentingNewLine]", ",", 
        RowBox[{"Message", "[", 
         RowBox[{
          RowBox[{"FOpenHistoData", "::", "filenotexist"}], ",", "filename"}],
          "]"}]}], "]"}]}], "\n", "]"}]}], "\n", 
   RowBox[{
    RowBox[{"FOpenHistoData", "[", "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"fn", "=", 
        RowBox[{"SystemDialogInput", "[", 
         RowBox[{"\"\<FileOpen\>\"", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"NotebookDirectory", "[", "]"}], ",", 
            RowBox[{"{", 
             RowBox[{"\"\<TTTR\>\"", "->", 
              RowBox[{"{", 
               RowBox[{
               "\"\<*.phu\>\"", ",", "\"\<*.phd\>\"", ",", "\"\<*.hhd\>\""}], 
               "}"}]}], "}"}]}], "}"}]}], "]"}]}], "}"}], ",", "\n", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"fn", "===", "$Canceled"}], ",", "fn", ",", " ", 
        RowBox[{"FOpenHistoData", "[", "fn", "]"}]}], "]"}]}], "\n", 
     "]"}]}]}]}]], "Input",
 CellChangeTimes->{{3.7679572291501913`*^9, 3.767957235949543*^9}, 
   3.7679572974424343`*^9, {3.7679574271886454`*^9, 3.7679576516910753`*^9}, {
   3.767957697080017*^9, 3.7679577064780006`*^9}, {3.7679578170187883`*^9, 
   3.7679578438458815`*^9}, {3.76795822376626*^9, 3.7679582773507657`*^9}, 
   3.7679583192053933`*^9, {3.7680352739616385`*^9, 3.7680353005718575`*^9}, 
   3.7788514032854595`*^9, {3.808207160549013*^9, 3.8082071742114873`*^9}, 
   3.808207236218279*^9, {3.808207302563905*^9, 3.8082073233313875`*^9}, {
   3.830336417365774*^9, 3.830336429855504*^9}, {3.8303364769954147`*^9, 
   3.8303365220626183`*^9}},ExpressionUUID->"9f015de6-5570-4559-ac20-\
34d038997742"]
}, Closed]],

Cell[CellGroupData[{

Cell["Settings (RCM,  etc.)", "Subsubsection",ExpressionUUID->"833ab911-f50a-4143-b31c-c93edc3c7b9d"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FGetRCM", "[", "]"}], ":=", 
  RowBox[{"FGetRCMStr", "[", "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FSetRCM", "[", 
   RowBox[{"rcm_", "?", 
    RowBox[{"(", 
     RowBox[{
      RowBox[{
       RowBox[{"MatrixQ", "[", 
        RowBox[{"#", ",", "NumberQ"}], "]"}], "&&", " ", 
       RowBox[{"Apply", "[", 
        RowBox[{"SameQ", ",", 
         RowBox[{"Dimensions", "[", "#", "]"}]}], "]"}]}], "&"}], ")"}]}], 
   "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"dim", "=", 
       RowBox[{"Length", "[", "rcm", "]"}]}], ",", 
      RowBox[{"newrcm", "=", 
       RowBox[{"PadRight", "[", 
        RowBox[{
         RowBox[{"N", "@", "rcm"}], ",", 
         RowBox[{"{", 
          RowBox[{"FNumberOfRoutes", ",", "FNumberOfRoutes"}], "}"}]}], 
        "]"}]}], ",", "i"}], "}"}], ",", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"dim", "<", "FNumberOfRoutes"}], ",", 
       RowBox[{"For", "[", 
        RowBox[{
         RowBox[{"i", "=", 
          RowBox[{"dim", "+", "1"}]}], ",", 
         RowBox[{"i", "<=", "FNumberOfRoutes"}], ",", 
         RowBox[{"i", "++"}], ",", 
         RowBox[{
          RowBox[{"newrcm", "[", 
           RowBox[{"[", 
            RowBox[{"i", ",", "i"}], "]"}], "]"}], "=", "1"}]}], "]"}]}], 
      "]"}], ";", 
     RowBox[{"FSetRCMStr", "[", "newrcm", "]"}]}]}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FSetRCM", "[", "filename_String", "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"rcm", ",", "fn"}], "}"}], ",", "\n", 
     RowBox[{
      RowBox[{"fn", "=", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"DirectoryQ", "[", "filename", "]"}], ",", " ", 
         RowBox[{"SystemDialogInput", "[", 
          RowBox[{"\"\<FileOpen\>\"", ",", 
           RowBox[{"{", 
            RowBox[{"filename", ",", 
             RowBox[{"{", 
              RowBox[{"\"\<Alle Files\>\"", "->", 
               RowBox[{"{", "\"\<*\>\"", "}"}]}], "}"}]}], "}"}]}], "]"}], 
         ",", "filename"}], "]"}]}], ";", "\n", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"FileExistsQ", "[", "fn", "]"}], ",", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"FPLoadRCM", "[", 
           RowBox[{"StringReplace", "[", 
            RowBox[{
             RowBox[{"ExpandFileName", "[", "filename", "]"}], ",", 
             RowBox[{"\"\<\\\\\>\"", "->", "\"\</\>\""}]}], "]"}], "]"}], ";", 
          RowBox[{"FGetRCM", "[", "]"}]}], ")"}], ",", " ", 
        RowBox[{"Message", "[", 
         RowBox[{
          RowBox[{"FSetRCM", "::", "filenotexist"}], ",", "filename"}], 
         "]"}]}], "]"}]}]}], "\n", "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{"FSetRCM", "[", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"fn", "=", 
      RowBox[{"SystemDialogInput", "[", 
       RowBox[{"\"\<FileOpen\>\"", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"NotebookDirectory", "[", "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"\"\<Alle Files\>\"", "->", 
            RowBox[{"{", "\"\<*\>\"", "}"}]}], "}"}]}], "}"}]}], "]"}]}], 
     "}"}], ",", "\n", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{"fn", "===", "$Canceled"}], ",", "fn", ",", " ", 
      RowBox[{"FSetRCM", "[", "fn", "]"}]}], "]"}]}], "\n", "]"}]}]}], "Input",
 CellChangeTimes->{{3.77885024749998*^9, 3.7788502820585985`*^9}, {
   3.77885031628211*^9, 3.7788503355875025`*^9}, {3.7788503854073243`*^9, 
   3.7788504099768457`*^9}, {3.7788504674213204`*^9, 
   3.7788504860225706`*^9}, {3.7788505344431305`*^9, 3.778850540315432*^9}, 
   3.778850577084831*^9, {3.778850614897748*^9, 3.778850651243587*^9}, {
   3.7788511063864975`*^9, 3.7788511426959524`*^9}, {3.7788514622239523`*^9, 
   3.778851462944031*^9}, {3.7788517485637684`*^9, 3.7788517600151567`*^9}, {
   3.7788557572410936`*^9, 3.7788557875123453`*^9}, {3.778856032586485*^9, 
   3.7788560581462913`*^9}, {3.778856089641828*^9, 3.778856097003151*^9}, {
   3.792740344102234*^9, 
   3.792740366701747*^9}},ExpressionUUID->"d617e34a-f211-4dbd-a349-\
cef8b2f383d1"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FGetActiveRoutes", "[", "]"}], ":=", 
  RowBox[{"FPActiveDetectionRoutes", "[", "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FSetActiveRoutes", "[", 
   RowBox[{"routes", ":", "FRouteList"}], "]"}], ":=", 
  RowBox[{"(", 
   RowBox[{
    RowBox[{"FPSetActiveDetectionRoutes", "[", 
     RowBox[{"FExpandRoutelist", "@", "routes"}], "]"}], ";", 
    RowBox[{"FPActiveDetectionRoutes", "[", "]"}]}], ")"}]}]}], "Input",Expres\
sionUUID->"4aded511-0862-473a-ab11-4c5a4c1fca19"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FSetDirectAcceptorExcitation", "[", 
   RowBox[{"value_", "?", "NumberQ"}], "]"}], ":=", 
  RowBox[{"FPSetDirectAcceptorExcitation", "[", 
   RowBox[{"N", "[", "value", "]"}], "]"}]}]], "Input",ExpressionUUID->\
"b6119ebb-4c68-4f4d-8dcd-1259cc5c107e"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FSetAnisotropyL1", "[", 
   RowBox[{"value_", "?", "NumberQ"}], "]"}], ":=", 
  RowBox[{"FPSetAnisotropyL1", "[", 
   RowBox[{"N", "@", "value"}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FSetAnisotropyL2", "[", 
   RowBox[{"value_", "?", "NumberQ"}], "]"}], ":=", 
  RowBox[{"FPSetAnisotropyL2", "[", 
   RowBox[{"N", "@", "value"}], "]"}]}]}], "Input",ExpressionUUID->"5e37eb47-\
947a-4787-ba7d-1c3cf183277d"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"FGetDonorRoutes", "[", "]"}], ":=", 
   RowBox[{"FPGetDonorRoutes", "[", "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FSetDonorRoutes", "[", 
    RowBox[{"routes", ":", "FRouteList"}], "]"}], ":=", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{"FPSetDonorRoutes", "[", 
      RowBox[{"FExpandRoutelist", "@", "routes"}], "]"}], ";", 
     RowBox[{"FPGetDonorRoutes", "[", "]"}]}], ")"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FGetAcceptorRoutes", "[", "]"}], ":=", 
   RowBox[{"FPGetAcceptorRoutes", "[", "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"FSetAcceptorRoutes", "[", 
   RowBox[{"routes", ":", "FRouteList"}], "]"}], ":=", 
  RowBox[{"(", 
   RowBox[{
    RowBox[{"FPSetAcceptorRoutes", "[", 
     RowBox[{"FExpandRoutelist", "@", "routes"}], "]"}], ";", 
    RowBox[{"FPGetAcceptorRoutes", "[", "]"}]}], ")"}]}]}], "Input",Expression\
UUID->"6fa8f4dd-195f-43af-9cd7-cf15cc601e30"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FSetFRETRoutes", "[", 
   RowBox[{"val", ":", 
    RowBox[{"{", 
     RowBox[{"Repeated", "[", 
      RowBox[{
       RowBox[{"\"\<D\>\"", "|", "\"\<A\>\"", "|", "0"}], ",", 
       "FNumberOfRoutes"}], "]"}], "}"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"v", "=", 
      RowBox[{"PadRight", "[", 
       RowBox[{"val", ",", "FNumberOfRoutes"}], "]"}]}], "}"}], ",", "\n", 
    "\n", 
    RowBox[{
     RowBox[{"FSetDonorRoutes", "[", 
      RowBox[{"v", "/.", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"\"\<D\>\"", "->", "1"}], ",", 
         RowBox[{"\"\<A\>\"", "->", "0"}]}], "}"}]}], "]"}], ";", "\n", 
     RowBox[{"FSetAcceptorRoutes", "[", 
      RowBox[{"v", "/.", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"\"\<D\>\"", "->", "0"}], ",", 
         RowBox[{"\"\<A\>\"", "->", "1"}]}], "}"}]}], "]"}], ";"}]}], "\n", 
   "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FGetFRETRoutes", "[", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"a", ",", "d"}], "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"d", "=", 
      RowBox[{
       RowBox[{"FGetDonorRoutes", "[", "]"}], "/.", " ", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"1", "->", "\"\<D\>\""}], ",", 
         RowBox[{"0", "->", "1"}]}], "}"}]}]}], ";", "\n", 
     RowBox[{"a", "=", 
      RowBox[{
       RowBox[{"FGetAcceptorRoutes", "[", "]"}], "/.", " ", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"1", "->", "\"\<A\>\""}], ",", 
         RowBox[{"0", "->", "1"}]}], "}"}]}]}], ";", "\n", 
     RowBox[{
      RowBox[{"a", "*", "d"}], "/.", " ", 
      RowBox[{"{", 
       RowBox[{"1", "->", "0"}], "}"}]}]}]}], "\n", "]"}]}]}], "Input",Express\
ionUUID->"81fea334-871d-497d-8428-240c21f4f0e3"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FSetAnisotropyRoutes", "[", 
   RowBox[{
    RowBox[{"main", ":", 
     RowBox[{"{", 
      RowBox[{"Repeated", "[", 
       RowBox[{
        RowBox[{"\"\<P\>\"", "|", "\"\<S\>\"", "|", "0"}], ",", 
        "FNumberOfRoutes"}], "]"}], "}"}]}], ",", " ", 
    RowBox[{"pie", ":", 
     RowBox[{"{", 
      RowBox[{"Repeated", "[", 
       RowBox[{
        RowBox[{"\"\<P\>\"", "|", "\"\<S\>\"", "|", "0"}], ",", 
        "FNumberOfRoutes"}], "]"}], "}"}]}]}], "]"}], ":=", 
  "\[IndentingNewLine]", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"m", "=", 
       RowBox[{"PadRight", "[", 
        RowBox[{"main", ",", "FNumberOfRoutes"}], "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"p", "=", 
       RowBox[{"PadRight", "[", 
        RowBox[{"pie", ",", "FNumberOfRoutes"}], "]"}]}]}], 
     "\[IndentingNewLine]", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"FPSetMainChannelAnisotropyRoutes", "[", 
      RowBox[{
       RowBox[{"m", "/.", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"\"\<P\>\"", "->", "1"}], ",", 
          RowBox[{"\"\<S\>\"", "->", "0"}]}], "}"}]}], ",", " ", 
       RowBox[{"m", "/.", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"\"\<P\>\"", "->", "0"}], ",", 
          RowBox[{"\"\<S\>\"", "->", "1"}]}], "}"}]}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"FPSetPIEChannelAnisotropyRoutes", "[", 
      RowBox[{
       RowBox[{"p", "/.", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"\"\<P\>\"", "->", "1"}], ",", 
          RowBox[{"\"\<S\>\"", "->", "0"}]}], "}"}]}], ",", " ", 
       RowBox[{"p", "/.", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"\"\<P\>\"", "->", "0"}], ",", 
          RowBox[{"\"\<S\>\"", "->", "1"}]}], "}"}]}]}], "]"}], ";"}]}], 
   "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"FSetAnisotropyRoutes", "[", 
     RowBox[{"val", ":", 
      RowBox[{"{", 
       RowBox[{"Repeated", "[", 
        RowBox[{
         RowBox[{"\"\<P\>\"", "|", "\"\<S\>\"", "|", "0"}], ",", 
         "FNumberOfRoutes"}], "]"}], "}"}]}], "]"}], ":=", 
    RowBox[{"FSetAnisotropyRoutes", "[", 
     RowBox[{"val", ",", " ", "val"}], "]"}]}], ";"}], 
  "\n"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FGetAnisotropyRoutes", "[", "]"}], ":=", "\[IndentingNewLine]", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"p", ",", "s"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"{", 
        RowBox[{"p", ",", "s"}], "}"}], "=", 
       RowBox[{"FPGetMainChannelAnisotropyRoutes", "[", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"p", ",", "s"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"p", "/.", " ", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"1", "->", "\"\<P\>\""}], ",", 
            RowBox[{"0", "->", "1"}]}], "}"}]}], ",", 
         RowBox[{"s", "/.", " ", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"1", "->", "\"\<S\>\""}], ",", 
            RowBox[{"0", "->", "1"}]}], "}"}]}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"p", "*", "s"}], "/.", " ", 
       RowBox[{"{", 
        RowBox[{"1", "->", "0"}], "}"}]}]}]}], "\[IndentingNewLine]", "]"}]}],
   "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FGetPIEAnisotropyRoutes", "[", "]"}], ":=", "\[IndentingNewLine]", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"p", ",", "s"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"p", ",", "s"}], "}"}], "=", 
      RowBox[{"FPGetPIEChannelAnisotropyRoutes", "[", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"p", ",", "s"}], "}"}], "=", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"p", "/.", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"1", "->", "\"\<P\>\""}], ",", 
           RowBox[{"0", "->", "1"}]}], "}"}]}], ",", 
        RowBox[{"s", "/.", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"1", "->", "\"\<S\>\""}], ",", 
           RowBox[{"0", "->", "1"}]}], "}"}]}]}], "}"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"p", "*", "s"}], "/.", " ", 
      RowBox[{"{", 
       RowBox[{"1", "->", "0"}], "}"}]}]}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.8116703540428658`*^9, 3.8116704044490576`*^9}, {
   3.8116704821421986`*^9, 3.811670491096246*^9}, {3.8116705289809027`*^9, 
   3.8116705394957733`*^9}, 3.8116706100934486`*^9, {3.811670685224526*^9, 
   3.811670833685497*^9}, {3.81167128103611*^9, 3.8116712910912237`*^9}, {
   3.8116714931816545`*^9, 3.8116715240590677`*^9}, {3.8116715778471317`*^9, 
   3.8116717777957735`*^9}, {3.811671817246293*^9, 
   3.8116718380485954`*^9}},ExpressionUUID->"879e76ad-9fbf-4bfc-904e-\
a5f9372e7c02"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FShiftPhotonTimesByPicoseconds", "[", 
   RowBox[{"dtps", ":", 
    RowBox[{"{", 
     RowBox[{"_Integer", ".."}], "}"}]}], "]"}], ":=", 
  RowBox[{"FPShiftPhotonTimesByPicoseconds", "[", "dtps", "]"}]}]], "Input",
 CellChangeTimes->{{3.778838415765766*^9, 
  3.7788384803421717`*^9}},ExpressionUUID->"90613110-976a-4282-8f6a-\
4556c4f969a2"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FShiftPhotonTimesByPicoseconds", "[", 
   RowBox[{"dt_Integer", ",", "route_Integer"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "dtlist", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"route", "\[LessEqual]", "0"}], ",", 
       RowBox[{"Return", " ", "[", "0", "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"dtlist", "=", 
      RowBox[{"ConstantArray", "[", 
       RowBox[{"0", ",", "route"}], "]"}]}], ";", 
     RowBox[{
      RowBox[{"dtlist", "[", 
       RowBox[{"[", 
        RowBox[{"-", "1"}], "]"}], "]"}], "=", "dt"}], ";", 
     RowBox[{"FShiftPhotonTimesByPicoseconds", "[", "dtlist", "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.7608761412335033`*^9, 3.760876181549738*^9}, {
  3.760880131178011*^9, 3.760880131752475*^9}, {3.778838500413519*^9, 
  3.778838641729745*^9}, {3.7788386834292746`*^9, 3.778838725191801*^9}, {
  3.778841097622017*^9, 
  3.778841099555851*^9}},ExpressionUUID->"e9c42455-3a98-42ca-9417-\
7ec39139d878"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FGetRouteAssignment", "[", "]"}], ":=", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{
     RowBox[{
      RowBox[{"\"\<A\>\"", 
       RowBox[{"FGetAcceptorRoutes", "[", "]"}]}], "+", 
      RowBox[{"\"\<D\>\"", 
       RowBox[{"FGetDonorRoutes", "[", "]"}]}]}], ",", 
     RowBox[{"FGetAnisotropyRoutes", "[", "]"}]}], "}"}], 
   "\[Transpose]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FGetPIERouteAssignment", "[", "]"}], ":=", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{
       RowBox[{"\"\<A\>\"", 
        RowBox[{"FGetAcceptorRoutes", "[", "]"}]}], "+", 
       RowBox[{"\"\<D\>\"", 
        RowBox[{"FGetDonorRoutes", "[", "]"}]}]}], ",", 
      RowBox[{"FGetPIEAnisotropyRoutes", "[", "]"}]}], "}"}], 
    "\[Transpose]"}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FGetRoutes", "[", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"fretch", ":", 
      RowBox[{"\"\<A\>\"", "|", "\"\<D\>\""}]}], ",", 
     RowBox[{"polarization", ":", 
      RowBox[{"\"\<P\>\"", "|", "\"\<S\>\""}]}]}], "}"}], "]"}], ":=", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"Position", "[", 
    RowBox[{
     RowBox[{"FGetRouteAssignment", "[", "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"fretch", ",", "polarization"}], "}"}]}], "]"}], "//", 
   "Flatten"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FGetRoutes", "[", 
   RowBox[{"fretch", ":", 
    RowBox[{"\"\<A\>\"", "|", "\"\<D\>\""}]}], "]"}], ":=", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"Position", "[", 
    RowBox[{
     RowBox[{"FGetRouteAssignment", "[", "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"fretch", ",", "_"}], "}"}]}], "]"}], "//", 
   "Flatten"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FGetRoutes", "[", 
    RowBox[{"polarization", ":", 
     RowBox[{"\"\<P\>\"", "|", "\"\<S\>\""}]}], "]"}], ":=", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Position", "[", 
     RowBox[{
      RowBox[{"FGetRouteAssignment", "[", "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"_", ",", "polarization"}], "}"}]}], "]"}], "//", 
    "Flatten"}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FGetPIERoutes", "[", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"fretch", ":", 
      RowBox[{"\"\<A\>\"", "|", "\"\<D\>\""}]}], ",", 
     RowBox[{"polarization", ":", 
      RowBox[{"\"\<P\>\"", "|", "\"\<S\>\""}]}]}], "}"}], "]"}], ":=", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"Position", "[", 
    RowBox[{
     RowBox[{"FGetPIERouteAssignment", "[", "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"fretch", ",", "polarization"}], "}"}]}], "]"}], "//", 
   "Flatten"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FGetPIERoutes", "[", 
   RowBox[{"fretch", ":", 
    RowBox[{"\"\<A\>\"", "|", "\"\<D\>\""}]}], "]"}], ":=", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"Position", "[", 
    RowBox[{
     RowBox[{"FGetPIERouteAssignment", "[", "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"fretch", ",", "_"}], "}"}]}], "]"}], "//", 
   "Flatten"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FGetPIERoutes", "[", 
   RowBox[{"polarization", ":", 
    RowBox[{"\"\<P\>\"", "|", "\"\<S\>\""}]}], "]"}], ":=", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"Position", "[", 
    RowBox[{
     RowBox[{"FGetPIERouteAssignment", "[", "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"_", ",", "polarization"}], "}"}]}], "]"}], "//", 
   "Flatten"}]}]}], "Input",
 CellChangeTimes->{{3.815392244488454*^9, 3.815392286113482*^9}, {
  3.8653298616716146`*^9, 3.865329882551385*^9}, {3.8653347312227716`*^9, 
  3.865334794184234*^9}, {3.8653348352499914`*^9, 3.8653348373638773`*^9}, {
  3.865334881804883*^9, 3.8653349067330017`*^9}, {3.86539466011868*^9, 
  3.8653946656525774`*^9}, {3.865394707751223*^9, 3.8653947386868324`*^9}, {
  3.865395827461631*^9, 3.865395875430452*^9}, {3.865395972648816*^9, 
  3.865395991334223*^9}, {3.865495397189166*^9, 
  3.8654954093124347`*^9}},ExpressionUUID->"08e68066-a6da-4e37-9d0a-\
fea34f0b022c"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FGetRouteList", "[", 
   RowBox[{"routes", ":", 
    RowBox[{"{", 
     RowBox[{"_Integer", ".."}], "}"}]}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"rl", "=", 
      RowBox[{"ConstantArray", "[", 
       RowBox[{"0", ",", "6"}], "]"}]}], "}"}], ",", 
    RowBox[{
     RowBox[{
      RowBox[{"rl", "[", 
       RowBox[{"[", "routes", "]"}], "]"}], "=", "1"}], ";", "rl"}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FGetRouteList", "[", "routes_", "]"}], ":=", 
  RowBox[{"FGetRouteList", "[", 
   RowBox[{"FGetRoutes", "[", "routes", "]"}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.865396123320115*^9, 3.865396244665561*^9}, {
  3.865396282422776*^9, 3.865396284509536*^9}, {3.8653963181082497`*^9, 
  3.865396340580714*^9}, {3.865396379502243*^9, 3.865396417292144*^9}},
 CellLabel->
  "In[176]:=",ExpressionUUID->"bcf93a95-ea9e-423b-9dd9-331f7cc6a235"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FPIECorrectionFactors", "[", 
   RowBox[{"Edonly_", ",", "Saonly_", ",", 
    RowBox[{"EvsSfret", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"_", ",", "_"}], "}"}], ",", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"_", ",", "_"}], "}"}], ".."}]}], "}"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "\[Alpha]H", ",", "\[Beta]H", ",", "\[Gamma]H", ",", "\[Delta]H", ",", 
      "esc", ",", "es", ",", "e", ",", "fit", ",", "\[Gamma]", ",", 
      "\[Beta]"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"\[Alpha]H", "=", 
      RowBox[{"Mean", "@", 
       RowBox[{"Flatten", "@", 
        RowBox[{"{", 
         RowBox[{"Edonly", "/", 
          RowBox[{"(", 
           RowBox[{"1", "-", "Edonly"}], ")"}]}], "}"}]}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Gamma]H", "=", "1"}], ";", "\[IndentingNewLine]", 
     RowBox[{"\[Beta]H", "=", "1"}], ";", "\[IndentingNewLine]", 
     RowBox[{"\[Delta]H", "=", 
      RowBox[{"Mean", "@", 
       RowBox[{"Flatten", "@", 
        RowBox[{"{", 
         RowBox[{"Saonly", "/", 
          RowBox[{"(", 
           RowBox[{"1", "-", "Saonly"}], ")"}]}], "}"}]}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"esc", "[", 
       RowBox[{"{", 
        RowBox[{"eapp_", ",", "sapp_"}], "}"}], "]"}], ":=", 
      RowBox[{"{", 
       RowBox[{
        FractionBox[
         RowBox[{
          RowBox[{"sapp", " ", 
           RowBox[{"(", 
            RowBox[{"eapp", "+", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{
                RowBox[{"-", "1"}], "+", "eapp"}], ")"}], " ", 
              "\[Alpha]H"}]}], ")"}]}], "+", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             RowBox[{"-", "1"}], "+", "sapp"}], ")"}], " ", "\[Delta]H"}]}], 
         RowBox[{
          RowBox[{"-", "\[Delta]H"}], "+", 
          RowBox[{"sapp", " ", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"-", "\[Alpha]H"}], "+", 
             RowBox[{"eapp", " ", 
              RowBox[{"(", 
               RowBox[{"1", "+", "\[Alpha]H", "-", "\[Gamma]H"}], ")"}]}], 
             "+", "\[Gamma]H", "+", "\[Delta]H"}], ")"}]}]}]], ",", 
        RowBox[{"1", "+", 
         FractionBox[
          RowBox[{
           RowBox[{"-", "1"}], "+", "sapp"}], 
          RowBox[{"1", "-", 
           RowBox[{"\[Beta]H", " ", "\[Delta]H"}], "+", 
           RowBox[{"sapp", " ", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"-", "1"}], "+", 
              RowBox[{"\[Beta]H", " ", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"-", "\[Alpha]H"}], "+", 
                 RowBox[{"eapp", " ", 
                  RowBox[{"(", 
                   RowBox[{"1", "+", "\[Alpha]H", "-", "\[Gamma]H"}], ")"}]}],
                  "+", "\[Gamma]H", "+", "\[Delta]H"}], ")"}]}]}], 
             ")"}]}]}]]}]}], "}"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"es", "=", 
      RowBox[{"esc", "/@", "EvsSfret"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"fit", "=", 
      RowBox[{"NonlinearModelFit", "[", 
       RowBox[{"es", ",", 
        SuperscriptBox[
         RowBox[{"(", 
          RowBox[{"1", "+", 
           RowBox[{"\[Gamma]", " ", "\[Beta]"}], " ", "+", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"1", "-", "\[Gamma]"}], ")"}], "\[Beta]", " ", "e"}]}], 
          ")"}], 
         RowBox[{"-", "1"}]], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"\[Gamma]", ",", "1."}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"\[Beta]", ",", "1."}], "}"}]}], "}"}], ",", "e"}], 
       "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"\[Beta]H", ",", "\[Gamma]H"}], "}"}], "=", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"\[Beta]", ",", "\[Gamma]"}], "}"}], "/.", 
       RowBox[{"fit", "[", "\"\<BestFitParameters\>\"", "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"\"\<Fretica\[Alpha]\[Beta]\[Gamma]\[Gamma]pie\>\"", "->", 
        RowBox[{"{", 
         RowBox[{
          FractionBox[
           RowBox[{"\[Delta]H", " ", "\[Beta]H"}], 
           RowBox[{"1", "+", 
            RowBox[{"\[Delta]H", " ", "\[Beta]H"}]}]], " ", ",", "\[Alpha]H", 
          ",", "\[Gamma]H", ",", 
          RowBox[{"1", "/", "\[Beta]H"}]}], "}"}]}], ",", 
       RowBox[{"\"\<Hellenkamp\[Alpha]\[Beta]\[Gamma]\[Delta]\>\"", "->", 
        RowBox[{"{", 
         RowBox[{
         "\[Alpha]H", ",", "\[Beta]H", ",", "\[Gamma]H", ",", "\[Delta]H"}], 
         "}"}]}], ",", 
       RowBox[{"\"\<EvsScorrected\>\"", "->", 
        RowBox[{"esc", "/@", "EvsSfret"}]}], ",", 
       RowBox[{"\"\<\[Gamma]fit\>\"", "->", "fit"}]}], "}"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",ExpressionUUID->"330e259a-f412-\
41f8-91c6-795b22cc826b"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FSetFretCorrectionFactors", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "\[Alpha]_", " ", ",", "\[Beta]_", ",", "\[Gamma]_", ",", 
      "\[Gamma]pie_"}], "}"}], ",", "G_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"rcm", ",", 
      RowBox[{"routes", "=", 
       RowBox[{"FGetRouteAssignment", "[", "]"}]}]}], "}"}], ",", 
    "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"rcm", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"Outer", "[", 
         RowBox[{"List", ",", "routes", ",", "routes", ",", "1"}], "]"}], "/.", 
        RowBox[{"{", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<A\>\"", ",", "\"\<P\>\""}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"\"\<A\>\"", ",", "\"\<P\>\""}], "}"}]}], "}"}], "->", 
           "1"}], ",", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<D\>\"", ",", "\"\<P\>\""}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"\"\<D\>\"", ",", "\"\<P\>\""}], "}"}]}], "}"}], "->", 
           "\[Gamma]"}], ",", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<A\>\"", ",", "\"\<P\>\""}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"\"\<D\>\"", ",", "\"\<P\>\""}], "}"}]}], "}"}], "->", 
           RowBox[{"-", "\[Beta]"}]}], ",", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<A\>\"", ",", "\"\<S\>\""}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"\"\<A\>\"", ",", "\"\<S\>\""}], "}"}]}], "}"}], "->", 
           "G"}], ",", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<D\>\"", ",", "\"\<S\>\""}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"\"\<D\>\"", ",", "\"\<S\>\""}], "}"}]}], "}"}], "->", 
           RowBox[{"G", " ", "\[Gamma]"}]}], ",", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<A\>\"", ",", "\"\<S\>\""}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"\"\<D\>\"", ",", "\"\<S\>\""}], "}"}]}], "}"}], "->", 
           RowBox[{
            RowBox[{"-", "\[Beta]"}], " ", "G"}]}]}], "}"}]}], "/.", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"_", ",", "_"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"_", ",", "_"}], "}"}]}], "}"}], "->", "0"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"FSetRCM", "[", "rcm", "]"}], ",", 
       RowBox[{"FSetDirectAcceptorExcitation", "[", "\[Alpha]", "]"}], ",", 
       RowBox[{"FSetPIEGamma", "[", "\[Gamma]pie", "]"}]}], "}"}]}]}], 
   "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FSetFretCorrectionFactors", "[", 
   RowBox[{"{", 
    RowBox[{
    "\[Alpha]_", " ", ",", "\[Beta]_", ",", "\[Gamma]_", ",", 
     "\[Gamma]pie_"}], "}"}], "]"}], ":=", 
  RowBox[{"FSetFretCorrectionFactors", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "\[Alpha]", " ", ",", "\[Beta]", ",", "\[Gamma]", ",", "\[Gamma]pie"}], 
     "}"}], ",", "1"}], "]"}]}]}], "Input",ExpressionUUID->"384d21e4-6362-\
4d68-9c30-cb879f1d943f"]
}, Closed]],

Cell[CellGroupData[{

Cell["Lifetime channel constraints", "Subsubsection",ExpressionUUID->"6c3afbbc-44f9-4575-83e4-96989598816e"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FEnableChannelConstraints", "[", 
   RowBox[{"enable", ":", 
    RowBox[{"True", "|", "False"}]}], "]"}], ":=", 
  RowBox[{"If", "[", 
   RowBox[{"enable", ",", 
    RowBox[{"FEnableChannelConstraints", "[", "1", "]"}], ",", 
    RowBox[{"FEnableChannelConstraints", "[", "0", "]"}]}], "]"}]}]], "Code",E\
xpressionUUID->"94659f00-2dd0-4087-8002-0d60ee8c55af"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FGetChannelConstraints", "[", 
   RowBox[{"route_", "?", "FValidRouteQ"}], "]"}], ":=", 
  RowBox[{"ToExpression", "[", 
   RowBox[{"FGetChannelConstraintsStr", "[", 
    RowBox[{"route", "-", "1"}], "]"}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FGetChannelConstraints", "[", "]"}], ":=", 
  RowBox[{"Map", "[", 
   RowBox[{"FGetChannelConstraints", ",", 
    RowBox[{"Range", "[", "FNumberOfRoutes", "]"}]}], "]"}]}]}], "Code",Expres\
sionUUID->"f0fc9216-4e8f-4e0f-b877-e12350da02d4"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FSetChannelConstraints", "[", 
   RowBox[{
    RowBox[{"route_", "?", "FValidRouteQ"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"ch1_", "?", "FValidChannelQ"}], ",", 
      RowBox[{"ch2_", "?", "FValidChannelQ"}]}], "}"}]}], "]"}], ":=", 
  RowBox[{"ToExpression", "@", 
   RowBox[{"FSetChannelConstraintsStr", "[", 
    RowBox[{
     RowBox[{"route", "-", "1"}], ",", 
     RowBox[{"{", 
      RowBox[{"ch1", ",", "ch2"}], "}"}]}], "]"}]}]}], "\n", 
 RowBox[{
  RowBox[{"FSetChannelConstraints", "[", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"ch1_", "?", "FValidChannelQ"}], ",", 
     RowBox[{"ch2_", "?", "FValidChannelQ"}]}], "}"}], "]"}], ":=", 
  RowBox[{"Map", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"FSetChannelConstraints", "[", 
      RowBox[{"#", ",", 
       RowBox[{"{", 
        RowBox[{"ch1", ",", "ch2"}], "}"}]}], "]"}], "&"}], ",", 
    RowBox[{"Range", "[", "FNumberOfRoutes", "]"}]}], "]"}]}]}], "Code",Expres\
sionUUID->"405917ca-9fad-4453-a1ef-d6f5d7de1a69"]
}, Closed]],

Cell[CellGroupData[{

Cell["PIE channel constraints, PIE gamma", "Subsubsection",ExpressionUUID->"0d655b6b-cb3d-4d1f-bd30-78f4516cee18"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FEnablePie", "[", 
   RowBox[{"enable", ":", 
    RowBox[{"True", "|", "False"}]}], "]"}], ":=", 
  RowBox[{"If", "[", 
   RowBox[{"enable", ",", 
    RowBox[{"FEnablePie", "[", "1", "]"}], ",", 
    RowBox[{"FEnablePie", "[", "0", "]"}]}], "]"}]}]], "Code",ExpressionUUID->\
"c1c6cef6-3141-4fc8-b683-873d069d84c6"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"FGetPIERoutes", "[", "]"}], ":=", 
   RowBox[{"FPGetPIERoutes", "[", "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"FSetPIERoutes", "[", 
   RowBox[{"routes", ":", "FRouteList"}], "]"}], ":=", 
  RowBox[{"(", 
   RowBox[{
    RowBox[{"FPSetPIERoutes", "[", 
     RowBox[{"FExpandRoutelist", "@", "routes"}], "]"}], ";", 
    RowBox[{"FPGetPIERoutes", "[", "]"}]}], ")"}]}]}], "Code",ExpressionUUID->\
"8ac0b758-162e-4c3c-9bde-9e1dce923f6c"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FGetPIEChannelConstraints", "[", 
   RowBox[{"route_", "?", "FValidRouteQ"}], "]"}], ":=", 
  RowBox[{"ToExpression", "[", 
   RowBox[{"FGetPIEChannelConstraintsStr", "[", 
    RowBox[{"route", "-", "1"}], "]"}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FGetPIEChannelConstraints", "[", "]"}], ":=", 
  RowBox[{"Map", "[", 
   RowBox[{"FGetPIEChannelConstraints", ",", 
    RowBox[{"Range", "[", "FNumberOfRoutes", "]"}]}], "]"}]}]}], "Code",Expres\
sionUUID->"7c2dfb7e-ed1b-4889-838c-5abff0c4c826"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FSetPIEChannelConstraints", "[", 
   RowBox[{
    RowBox[{"route_", "?", "FValidRouteQ"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"ch1_", "?", "FValidChannelQ"}], ",", 
      RowBox[{"ch2_", "?", "FValidChannelQ"}]}], "}"}]}], "]"}], ":=", 
  RowBox[{"ToExpression", "@", 
   RowBox[{"FSetPIEChannelConstraintsStr", "[", 
    RowBox[{
     RowBox[{"route", "-", "1"}], ",", 
     RowBox[{"{", 
      RowBox[{"ch1", ",", "ch2"}], "}"}]}], "]"}]}]}], "\n", 
 RowBox[{
  RowBox[{"FSetPIEChannelConstraints", "[", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"ch1_", "?", "FValidChannelQ"}], ",", 
     RowBox[{"ch2_", "?", "FValidChannelQ"}]}], "}"}], "]"}], ":=", 
  RowBox[{"Map", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"FSetPIEChannelConstraints", "[", 
      RowBox[{"#", ",", 
       RowBox[{"{", 
        RowBox[{"ch1", ",", "ch2"}], "}"}]}], "]"}], "&"}], ",", 
    RowBox[{"Range", "[", "FNumberOfRoutes", "]"}]}], "]"}]}]}], "Code",Expres\
sionUUID->"362899c5-e89e-4b62-93aa-ad941e610cb8"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FSetPIEGamma", "[", 
   RowBox[{"gamma_", "?", "NumberQ"}], "]"}], ":=", 
  RowBox[{"FPSetPIEGamma", "[", 
   RowBox[{"N", "[", "gamma", "]"}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FGetPIEGamma", "[", "]"}], ":=", 
  RowBox[{"FPGetPIEGamma", "[", "]"}]}]}], "Code",
 CellChangeTimes->{{3.865068124828679*^9, 
  3.865068155985504*^9}},ExpressionUUID->"535f336b-d79a-47c8-800f-\
784f4198b557"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FPIEChannelSelector", "[", "routelist_List", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "dat", ",", "maxy", ",", "lp", ",", "c1", ",", "c2", ",", "ntot"}], 
     "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"dat", "=", 
      RowBox[{"FLifeTimeHisto", "[", 
       RowBox[{
        RowBox[{"FRoutes", "->", "routelist"}], ",", 
        RowBox[{"FOutput", "->", "FData"}], ",", 
        RowBox[{"FPhotonData", "->", "All"}]}], "]"}]}], ";", "\n", 
     RowBox[{
      RowBox[{"dat", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "All", ",", "1"}], "]"}], "]"}], "=", 
      RowBox[{"Range", "[", 
       RowBox[{"Length", "[", 
        RowBox[{"dat", "[", 
         RowBox[{"[", 
          RowBox[{"1", ",", "All", ",", "1"}], "]"}], "]"}], "]"}], "]"}]}], 
     ";", 
     RowBox[{"(*", 
      RowBox[{"replace", " ", "time", " ", "by", " ", "channel", " ", 
       RowBox[{"(", "bin", ")"}], " ", "number"}], "*)"}], "\n", 
     RowBox[{"ntot", "=", 
      RowBox[{"Map", "[", 
       RowBox[{"Total", ",", 
        RowBox[{
         RowBox[{"dat", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "All", ",", "2"}], "]"}], "]"}], 
         "\[Transpose]"}]}], "]"}]}], ";", "\n", 
     RowBox[{"c1", "=", 
      RowBox[{
       RowBox[{"LengthWhile", "[", 
        RowBox[{"ntot", ",", 
         RowBox[{
          RowBox[{"#", "==", "0"}], "&"}]}], "]"}], "+", "1"}]}], ";", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"find", " ", "first", " ", "non"}], "-", 
       RowBox[{"empty", " ", "bin"}]}], "*)"}], "\n", 
     RowBox[{"c1", "=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"c1", ">", "FMaxChannel"}], "  ", "||", " ", 
         RowBox[{"c1", "<", "1"}]}], ",", "1", ",", "c1"}], "]"}]}], ";", 
     "\n", 
     RowBox[{"c2", "=", 
      RowBox[{
       RowBox[{"Length", "[", "ntot", "]"}], "-", 
       RowBox[{"LengthWhile", "[", 
        RowBox[{
         RowBox[{"Reverse", "@", "ntot"}], ",", 
         RowBox[{
          RowBox[{"#", "==", "0"}], "&"}]}], "]"}]}]}], ";", "\n", 
     RowBox[{"c2", "=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"c2", ">", "FMaxChannel"}], " ", "||", " ", 
         RowBox[{"c2", "<", "1"}]}], ",", "FMaxChannel", ",", "c2"}], "]"}]}],
      ";", "\n", 
     RowBox[{"dat", "=", 
      RowBox[{"dat", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", 
         RowBox[{"c1", ";;", "c2"}]}], "]"}], "]"}]}], ";", "\n", 
     RowBox[{
      RowBox[{"dat", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "All", ",", "2"}], "]"}], "]"}], "=", 
      RowBox[{
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Log", "[", 
           RowBox[{"10", ",", "#"}], "]"}], "&"}], ",", 
         RowBox[{"dat", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "All", ",", "2"}], "]"}], "]"}]}], "]"}], "/.", 
       RowBox[{"Indeterminate", "->", "0"}]}]}], ";", "\n", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"dat", "=", 
        RowBox[{"dat", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", 
           RowBox[{"c1", ";;", "c2"}]}], "]"}], "]"}]}], ";"}], "*)"}], "\n", 
     RowBox[{"maxy", "=", 
      RowBox[{"Max", "[", 
       RowBox[{"dat", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "All", ",", "2"}], "]"}], "]"}], "]"}]}], ";", 
     "\n", 
     RowBox[{"lp", "=", 
      RowBox[{"ListPlot", "[", 
       RowBox[{"dat", ",", 
        RowBox[{"PlotRange", "->", "All"}], ",", 
        RowBox[{"PlotStyle", "->", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Darker", "@", "Red"}], ",", 
           RowBox[{"Darker", "@", "Green"}]}], "}"}]}]}], "]"}]}], ";", "\n", 
     RowBox[{"Manipulate", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"FSetChannelConstraints", "[", 
         RowBox[{"{", 
          RowBox[{"t1fret", ",", "t2fret"}], "}"}], "]"}], ";", 
        RowBox[{"FSetPIEChannelConstraints", "[", 
         RowBox[{"{", 
          RowBox[{"t1pie", ",", "t2pie"}], "}"}], "]"}], ";", 
        RowBox[{"FPIEChannelSelectorFirst", "=", "False"}], ";", "\n", 
        RowBox[{"Show", "[", 
         RowBox[{"lp", ",", 
          RowBox[{"Graphics", "[", 
           RowBox[{"{", "\n", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"Green", ",", 
               RowBox[{"Line", "[", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{"t1fret", ",", "0"}], "}"}], ",", 
                  RowBox[{"{", 
                   RowBox[{"t1fret", ",", "maxy"}], "}"}]}], "}"}], "]"}], 
               ",", "\n", 
               RowBox[{"Line", "[", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{"t2fret", ",", "0"}], "}"}], ",", 
                  RowBox[{"{", 
                   RowBox[{"t2fret", ",", "maxy"}], "}"}]}], "}"}], "]"}], 
               ",", "\n", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"Opacity", "[", "0.1", "]"}], ",", "Green", ",", 
                 RowBox[{"Rectangle", "[", 
                  RowBox[{
                   RowBox[{"{", 
                    RowBox[{"t1fret", ",", "0"}], "}"}], ",", 
                   RowBox[{"{", 
                    RowBox[{"t2fret", ",", "maxy"}], "}"}]}], "]"}]}], 
                "}"}]}], "}"}], ",", "\n", 
             RowBox[{"{", 
              RowBox[{"Red", ",", 
               RowBox[{"Line", "[", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{"t1pie", ",", "0"}], "}"}], ",", 
                  RowBox[{"{", 
                   RowBox[{"t1pie", ",", "maxy"}], "}"}]}], "}"}], "]"}], ",",
                "\n", 
               RowBox[{"Line", "[", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{"t2pie", ",", "0"}], "}"}], ",", 
                  RowBox[{"{", 
                   RowBox[{"t2pie", ",", "maxy"}], "}"}]}], "}"}], "]"}], ",",
                "\n", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"Opacity", "[", "0.1", "]"}], ",", "Red", ",", 
                 RowBox[{"Rectangle", "[", 
                  RowBox[{
                   RowBox[{"{", 
                    RowBox[{"t1pie", ",", "0"}], "}"}], ",", 
                   RowBox[{"{", 
                    RowBox[{"t2pie", ",", "maxy"}], "}"}]}], "]"}]}], "}"}]}],
               "}"}]}], "\n", "}"}], "]"}], ",", 
          RowBox[{"Frame", "->", "True"}], ",", 
          RowBox[{"PlotRange", "->", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"c1", ",", "c2"}], "}"}], ",", "All"}], "}"}]}], ",", 
          RowBox[{"AspectRatio", "->", "0.2"}], ",", 
          RowBox[{"ImageSize", "->", "600"}], ",", 
          RowBox[{"Axes", "->", "False"}], ",", 
          RowBox[{"FrameLabel", "->", 
           RowBox[{"{", 
            RowBox[{
            "\"\<channel number\>\"", ",", 
             "\"\<\\!\\(\\*SuperscriptBox[\\(10\\), \\(x\\)]\\)\>\""}], 
            "}"}]}]}], "\n", "]"}]}], "\n", ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"t1fret", ",", "c1", ",", "\"\<FRET ch1\>\""}], "}"}], ",", 
         "c1", ",", "c2", ",", "1"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"t2fret", ",", "c1", ",", "\"\<FRET ch2\>\""}], "}"}], ",", 
         "c1", ",", "c2", ",", "1"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"t1pie", ",", "c1", ",", "\"\<PIE ch1\>\""}], "}"}], ",", 
         "c1", ",", "c2", ",", "1"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"t2pie", ",", "c1", ",", "\"\<PIE ch2\>\""}], "}"}], ",", 
         "c1", ",", "c2", ",", "1"}], "}"}]}], "]"}]}]}], "\n", 
   "]"}]}]], "Code",ExpressionUUID->"ef098b91-b16b-4bd1-b460-c85857c3647c"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FShufflePhotonsForT2Alex", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"tdex1_Integer", ",", "tdex2_Integer"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"taex1_Integer", ",", "taex2_Integer"}], "}"}], ",", " ", 
    "ADroute_Integer", ",", " ", "AAroute_Integer"}], "]"}], ":=", 
  RowBox[{"FPShuffelPhotonsForT2Alex", "[", 
   RowBox[{"tdex1", ",", "tdex2", ",", "taex1", ",", "taex2", ",", 
    RowBox[{"ADroute", "-", "1"}], ",", 
    RowBox[{"AAroute", "-", "1"}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.806295053029728*^9, 3.8062950968435955`*^9}, {
  3.8062951338406887`*^9, 3.806295248872163*^9}, {3.8062952882768183`*^9, 
  3.8062953508056555`*^9}, {3.8063872038512225`*^9, 3.8063872096616893`*^9}, {
  3.8104605519527645`*^9, 
  3.810460554853997*^9}},ExpressionUUID->"e9cfd54d-8bf0-4847-b440-\
5757a4c31119"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FPhotonTimeRelativeToMarkerHistogram", "[", 
   RowBox[{
    RowBox[{"routelist", ":", "FRouteList"}], ",", "markerChannel_Integer", 
    ",", "tmaxps_Integer", ",", "binning_Integer"}], "]"}], ":=", 
  RowBox[{"FPPhotonTimeRelativeToMarkerHistogram", "[", 
   RowBox[{"routelist", ",", "markerChannel", ",", "tmaxps", ",", "binning"}],
    "]"}]}]], "Input",
 CellChangeTimes->{{3.806295672616414*^9, 3.8062957286944904`*^9}, 
   3.8062957918926697`*^9, {3.8063008513415184`*^9, 3.8063008527029076`*^9}, {
   3.806302788424172*^9, 
   3.806302801967967*^9}},ExpressionUUID->"19bbd7e4-3ce0-4090-b15c-\
d20c891ba960"]
}, Closed]],

Cell[CellGroupData[{

Cell["PCH", "Subsubsection",ExpressionUUID->"01705c34-4d66-4819-8009-5a81088e3fc0"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FReturnChannelConstraintsFromOption", "[", "opt_", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "}"}], ",", "\n", 
    RowBox[{"Which", "[", "\n", 
     RowBox[{
      RowBox[{"opt", "===", "Automatic"}], ",", "Automatic", ",", "\n", 
      RowBox[{"opt", "===", "None"}], ",", 
      RowBox[{"FMakeChannelList", "[", 
       RowBox[{"{", 
        RowBox[{"1", ",", "FMaxChannel"}], "}"}], "]"}], ",", "\n", 
      RowBox[{"MatchQ", "[", 
       RowBox[{"opt", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "FValidChannelQ"}], ",", 
          RowBox[{"_", "?", "FValidChannelQ"}]}], "}"}]}], "]"}], ",", 
      RowBox[{"FMakeChannelList", "[", "opt", "]"}], ",", "\n", 
      RowBox[{"MatchQ", "[", 
       RowBox[{"opt", ",", "FChannelConstraintsList"}], "]"}], ",", "opt", 
      ",", "\n", "True", ",", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"Message", "[", 
         RowBox[{"FChannelConstraints", "::", "invalid"}], "]"}], ";", 
        "Automatic"}], ")"}]}], "\n", "]"}]}], "\n", "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FReturnTimeintervalFromOption", "[", "opt_", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "}"}], ",", "\n", 
    RowBox[{"Which", "[", "\n", 
     RowBox[{
      RowBox[{"opt", "===", "All"}], ",", "All", ",", "\n", 
      RowBox[{"MatchQ", "[", 
       RowBox[{"opt", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumberQ"}], ",", 
          RowBox[{"_", "?", "NumberQ"}]}], "}"}]}], "]"}], ",", "opt", ",", 
      "\n", "True", ",", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"Message", "[", 
         RowBox[{"FTimeWindow", "::", "invalid"}], "]"}], ";", "All"}], 
       ")"}]}], "\n", "]"}]}], "\n", "]"}]}]}], "Code",ExpressionUUID->\
"8b48a083-3437-44a3-8c1b-0b181733688a"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"FChannelConstraints", "::", "invalid"}], "=", 
   "\"\<Invalid channel range option. Automatic is used.\>\""}], 
  ";"}]], "Code",ExpressionUUID->"4dd590c3-c7f9-4183-b0f8-783b3bd0d32b"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"FTimeWindow", "::", "invalid"}], "=", 
   "\"\<Invalid time interval option. All is used.\>\""}], ";"}]], "Code",Expr\
essionUUID->"2855e9e2-88b1-41a4-8cdd-7026353d3440"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "FPCH", "]"}], " ", "=", " ", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"FOutput", " ", "->", " ", "FGraph"}], ",", 
       RowBox[{"FTimeWindow", "->", "All"}], ",", 
       RowBox[{"FChannelConstraints", "->", "Automatic"}]}], "}"}], "~", 
     "Join", "~", 
     RowBox[{"Options", "[", "ListLogPlot", "]"}]}]}], ";"}], 
  "\[IndentingNewLine]"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FPCH", "[", 
    RowBox[{
     RowBox[{"routes", " ", ":", " ", 
      RowBox[{"{", 
       RowBox[{"FRouteList", " ", "..."}], "}"}]}], ",", " ", 
     RowBox[{"binwidthMs_", "?", "NumberQ"}], ",", " ", 
     RowBox[{"opts", " ", ":", " ", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
   "\[IndentingNewLine]", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"dat", ",", "timeinterval", ",", "ch"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"ch", "=", 
       RowBox[{"FReturnChannelConstraintsFromOption", "[", 
        RowBox[{"OptionValue", "[", "FChannelConstraints", "]"}], "]"}]}], 
      ";", 
      RowBox[{"timeinterval", "=", 
       RowBox[{"FReturnTimeintervalFromOption", "[", 
        RowBox[{"OptionValue", "[", "FTimeWindow", "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"dat", "=", "\[IndentingNewLine]", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"(", "\[IndentingNewLine]", 
           RowBox[{"Which", "[", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{"ch", "===", " ", "Automatic"}], " ", "&&", " ", 
              RowBox[{"timeinterval", " ", "===", " ", "All"}]}], ",", 
             RowBox[{"FPPCH", "[", 
              RowBox[{
               RowBox[{"FRouteListToByte", "[", "#", "]"}], ",", " ", 
               RowBox[{"N", "[", "binwidthMs", "]"}]}], "]"}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"ch", "===", " ", "Automatic"}], " ", ",", 
             RowBox[{"FPPCH2", "[", 
              RowBox[{
               RowBox[{"FRouteListToByte", "[", "#", "]"}], ",", " ", 
               RowBox[{"N", "[", "binwidthMs", "]"}], ",", 
               RowBox[{"N", "@", 
                RowBox[{"timeinterval", "[", 
                 RowBox[{"[", "1", "]"}], "]"}]}], ",", 
               RowBox[{"N", "@", 
                RowBox[{"timeinterval", "[", 
                 RowBox[{"[", "2", "]"}], "]"}]}]}], "]"}], ",", 
             RowBox[{"timeinterval", " ", "===", " ", "All"}], ",", " ", 
             RowBox[{"FPPCH4", "[", 
              RowBox[{
               RowBox[{"FRouteListToByte", "[", "#", "]"}], ",", " ", 
               RowBox[{"N", "[", "binwidthMs", "]"}], ",", 
               RowBox[{"Flatten", "[", "ch", "]"}]}], "]"}], ",", 
             "\[IndentingNewLine]", "True", ",", 
             RowBox[{"FPPCH3", "[", 
              RowBox[{
               RowBox[{"FRouteListToByte", "[", "#", "]"}], ",", " ", 
               RowBox[{"N", "[", "binwidthMs", "]"}], ",", 
               RowBox[{"N", "@", 
                RowBox[{"timeinterval", "[", 
                 RowBox[{"[", "1", "]"}], "]"}]}], ",", 
               RowBox[{"N", "@", 
                RowBox[{"timeinterval", "[", 
                 RowBox[{"[", "2", "]"}], "]"}]}], ",", 
               RowBox[{"Flatten", "[", "ch", "]"}]}], "]"}]}], "]"}], 
           "\[IndentingNewLine]", ")"}], "&"}], ",", 
         RowBox[{"FExpandRoutelist", "/@", "routes"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "FOutput", "]"}], " ", "===", " ", 
         "FGraph"}], ",", "\[IndentingNewLine]", 
        RowBox[{"ListLogPlot", "[", 
         RowBox[{"dat", ",", " ", 
          RowBox[{"FilterRules", "[", 
           RowBox[{
            RowBox[{"{", "opts", "}"}], ",", " ", 
            RowBox[{"Options", "[", "ListLogPlot", "]"}]}], "]"}], ",", " ", 
          RowBox[{"ImageSize", " ", "->", " ", "400"}], ",", " ", 
          RowBox[{"AspectRatio", " ", "->", " ", 
           RowBox[{"1", "/", "2"}]}], ",", " ", 
          RowBox[{"Axes", " ", "->", " ", "False"}], ",", " ", 
          RowBox[{"Frame", " ", "->", " ", "True"}], ",", " ", 
          RowBox[{"FrameLabel", " ", "->", " ", 
           RowBox[{"{", 
            RowBox[{"\"\<photons in bin\>\"", ",", " ", "\"\<frequency\>\""}],
             "}"}]}], ",", " ", 
          RowBox[{"PlotLabel", " ", "->", " ", 
           RowBox[{"\"\<PCH (time binning: \>\"", " ", "<>", " ", 
            RowBox[{"ToString", "[", "binwidthMs", "]"}], " ", "<>", " ", 
            "\"\<ms)\>\""}]}], ",", " ", 
          RowBox[{"LabelStyle", " ", "->", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"FontFamily", " ", "->", " ", "\"\<Helvetica\>\""}], ",",
              " ", 
             RowBox[{"FontSize", " ", "->", " ", "12"}], ",", " ", 
             RowBox[{"FontWeight", " ", "->", " ", "Bold"}]}], "}"}]}], ",", 
          " ", 
          RowBox[{"FrameStyle", " ", "->", " ", 
           RowBox[{"Directive", "[", 
            RowBox[{"Black", ",", " ", 
             RowBox[{"AbsoluteThickness", "[", "1", "]"}]}], "]"}]}]}], "]"}],
         "\[IndentingNewLine]", ",", "dat"}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], "\n"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"FPCH", "[", 
     RowBox[{
      RowBox[{"routes", ":", " ", "FRouteList"}], ",", " ", 
      RowBox[{"binwidthMs_", "?", "NumberQ"}], ",", " ", 
      RowBox[{"opts", " ", ":", " ", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"pch", "=", 
        RowBox[{"FPCH", "[", 
         RowBox[{
          RowBox[{"{", "routes", "}"}], ",", " ", "binwidthMs", ",", " ", 
          "opts"}], " ", "]"}]}], "}"}], ",", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "FOutput", "]"}], " ", "===", " ", 
         "FGraph"}], ",", "pch", ",", 
        RowBox[{"pch", "[", 
         RowBox[{"[", "1", "]"}], " ", "]"}]}], "]"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "\n", 
   RowBox[{
    RowBox[{"FPCH", "[", 
     RowBox[{
      RowBox[{"routes", ":", " ", "FRouteList"}], ",", " ", 
      RowBox[{"binwidthMs_", "?", "NumberQ"}], ",", " ", 
      RowBox[{"opts", " ", ":", " ", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "dat", "}"}], ",", "\n", 
      RowBox[{
       RowBox[{"dat", " ", "=", 
        RowBox[{"FPCH", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"FExpandRoutelist", "@", "routes"}], "}"}], " ", ",", 
          "binwidthMs", ",", 
          RowBox[{"FOutput", "->", " ", "FData"}], ",", "opts"}], " ", 
         "]"}]}], ";", "\n", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"OptionValue", "[", "FOutput", "]"}], " ", "===", " ", 
          "FGraph"}], ",", "\n", 
         RowBox[{"ListLogPlot", "[", 
          RowBox[{"dat", ",", " ", 
           RowBox[{"FilterRules", "[", 
            RowBox[{
             RowBox[{"{", "opts", "}"}], ",", " ", 
             RowBox[{"Options", "[", "ListLogPlot", "]"}]}], "]"}], ",", " ", 
           RowBox[{"ImageSize", " ", "->", " ", "400"}], ",", " ", 
           RowBox[{"AspectRatio", " ", "->", " ", 
            RowBox[{"1", "/", "2"}]}], ",", " ", 
           RowBox[{"Axes", " ", "->", " ", "False"}], ",", " ", 
           RowBox[{"Frame", " ", "->", " ", "True"}], ",", " ", 
           RowBox[{"FrameLabel", " ", "->", " ", 
            RowBox[{"{", 
             RowBox[{
             "\"\<photons in bin\>\"", ",", " ", "\"\<frequency\>\""}], 
             "}"}]}], ",", " ", 
           RowBox[{"PlotLabel", " ", "->", " ", 
            RowBox[{"\"\<PCH (time binning: \>\"", " ", "<>", " ", 
             RowBox[{"ToString", "[", "binwidthMs", "]"}], " ", "<>", " ", 
             "\"\<ms)\>\""}]}], ",", " ", 
           RowBox[{"LabelStyle", " ", "->", " ", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"FontFamily", " ", "->", " ", "\"\<Helvetica\>\""}], 
              ",", " ", 
              RowBox[{"FontSize", " ", "->", " ", "12"}], ",", " ", 
              RowBox[{"FontWeight", " ", "->", " ", "Bold"}]}], "}"}]}], ",", 
           " ", 
           RowBox[{"FrameStyle", " ", "->", " ", 
            RowBox[{"Directive", "[", 
             RowBox[{"Black", ",", " ", 
              RowBox[{"AbsoluteThickness", "[", "1", "]"}]}], "]"}]}]}], 
          "]"}], ",", "\n", "dat"}], "\n", "]"}]}]}], "\n", "]"}]}], "\n", 
   "*)"}]}], "\n", 
 RowBox[{
  RowBox[{"FPCH", "[", 
   RowBox[{
    RowBox[{"binwidthMs_", "?", "NumberQ"}], ",", " ", 
    RowBox[{"opts", " ", ":", " ", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
  RowBox[{"FPCH", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"1", ",", " ", "1", ",", " ", "1", ",", " ", "1"}], "}"}], ",", 
    " ", "binwidthMs", ",", " ", "opts"}], "]"}]}], "\n"}], "Input",
 CellChangeTimes->{{3.8064037579953384`*^9, 3.806403877330307*^9}, 
   3.8064039335310607`*^9, {3.8064039816633863`*^9, 3.8064040307102747`*^9}, 
   3.8064041837140055`*^9, {3.8064042356132665`*^9, 3.806404301056306*^9}, {
   3.806404369125362*^9, 
   3.8064045015438595`*^9}},ExpressionUUID->"65addf99-5e27-4dce-b07e-\
aea365b8f9e5"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"FPCH3DG", "::", "overflow"}], "=", "\"\<Numerical Error\>\""}], 
  ";"}]], "Code",ExpressionUUID->"fa2abef7-6a17-4267-bd7b-c4f5b675e248"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FPCH3DG", "[", 
   RowBox[{"nmax_Integer", ",", 
    RowBox[{"species", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumberQ"}], ",", 
         RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}]}], ",", 
    RowBox[{"nbg_", "?", "NumberQ"}], ",", 
    RowBox[{"F1_", "?", "NumberQ"}], ",", 
    RowBox[{"F2_", "?", "NumberQ"}]}], "]"}], ":=", " ", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{
     RowBox[{"Range", "[", 
      RowBox[{"0", ",", "nmax"}], "]"}], ",", 
     RowBox[{"FP3DGPCH", "[", 
      RowBox[{"nmax", ",", 
       RowBox[{"N", "@", 
        RowBox[{"species", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ",", 
       RowBox[{"N", "@", 
        RowBox[{"species", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "2"}], "]"}], "]"}]}], ",", 
       RowBox[{"N", "@", "nbg"}], ",", 
       RowBox[{"N", "@", "F1"}], ",", 
       RowBox[{"N", "@", "F2"}]}], "]"}]}], "}"}], "\[Transpose]"}]}]], "Code",\
ExpressionUUID->"7a309d8e-765b-4378-adf3-c9d702d6dbde"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FPCHFida", "[", 
   RowBox[{"nmax_Integer", ",", 
    RowBox[{"species", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumberQ"}], ",", 
         RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}]}], ",", 
    RowBox[{"nbg_", "?", "NumberQ"}], ",", 
    RowBox[{"dvdx", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumberQ"}], ",", 
         RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}]}]}], "]"}], ":=",
   " ", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{
     RowBox[{"Range", "[", 
      RowBox[{"0", ",", "nmax"}], "]"}], ",", 
     RowBox[{"FPPCHdVdX", "[", 
      RowBox[{"nmax", ",", 
       RowBox[{"N", "@", 
        RowBox[{"species", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ",", 
       RowBox[{"N", "@", 
        RowBox[{"species", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "2"}], "]"}], "]"}]}], ",", 
       RowBox[{"N", "@", "nbg"}], ",", 
       RowBox[{"N", "@", 
        RowBox[{"Flatten", "[", "dvdx", "]"}]}]}], "]"}]}], "}"}], 
   "\[Transpose]"}]}]], "Code",ExpressionUUID->"56c36983-d025-4646-9c82-\
82572ebeb012"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FPCHFidaFit", "]"}], "=", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"FConstraints", "->", "None"}], "}"}], "~", "Join", "~", " ", 
    RowBox[{"Options", "[", "ListLogPlot", "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"FPCHFidaFit", "[", 
   RowBox[{
    RowBox[{"pchdat", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumericQ"}], ",", 
         RowBox[{"_", "?", "NumericQ"}]}], "}"}], ".."}], "}"}]}], ",", 
    RowBox[{"species", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"_", ",", "_"}], "}"}], ".."}], "}"}]}], ",", "nbg_", ",", 
    RowBox[{"dvdx", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"_", ",", 
         RowBox[{"_", "?", "NumericQ"}]}], "}"}], ".."}], "}"}]}], ",", 
    RowBox[{"guess", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"_", ",", 
         RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}]}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "chisq", ",", "nbins", ",", "nmax", ",", "params", ",", "f", ",", "R", 
      ",", "objectiveFunction", ",", "fitresult", ",", "modelpch"}], "}"}], 
    ",", "\n", 
    RowBox[{
     RowBox[{"nbins", "=", 
      RowBox[{"Total", "[", 
       RowBox[{"pchdat", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}]}], " ", ";", "\n", 
     RowBox[{"nmax", "=", 
      RowBox[{
       RowBox[{"Length", "[", "pchdat", "]"}], "-", "1"}]}], ";", "\n", 
     RowBox[{"params", "=", 
      RowBox[{"guess", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ";", "\n", 
     RowBox[{
      RowBox[{"f", "[", 
       RowBox[{"var", ":", 
        RowBox[{"{", 
         RowBox[{"___", "?", "NumberQ"}], "}"}]}], "]"}], ":=", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{
         RowBox[{"FPCHFida", "[", 
          RowBox[{"nmax", ",", 
           RowBox[{"Abs", "@", "species"}], ",", 
           RowBox[{"Abs", "@", "nbg"}], " ", ",", "dvdx"}], "]"}], "/.", 
         RowBox[{"Map", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Rule", "@@", "#"}], "&"}], ",", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"params", ",", "var"}], "}"}], "\[Transpose]"}]}], 
          "]"}]}], ")"}], "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "2"}], "]"}], "]"}]}], ";", "\n", "\n", 
     RowBox[{
      RowBox[{"R", "[", 
       RowBox[{"{", 
        RowBox[{"vars___", "?", "NumericQ"}], "}"}], "]"}], ":=", 
      RowBox[{"Module", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"model", ",", "\[Sigma]sqr"}], "}"}], ",", "\n", 
        RowBox[{
         RowBox[{"model", "=", 
          RowBox[{"f", "[", 
           RowBox[{"{", "vars", "}"}], "]"}]}], ";", "\n", 
         RowBox[{"\[Sigma]sqr", "=", 
          RowBox[{"Abs", "[", 
           RowBox[{"nbins", " ", "model", " ", 
            RowBox[{"(", 
             RowBox[{"1", "-", "model"}], ")"}]}], "]"}]}], ";", "\n", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            RowBox[{"nbins", " ", "model"}], "-", 
            RowBox[{"pchdat", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "2"}], "]"}], "]"}]}], ")"}], "/", 
          RowBox[{"Sqrt", "[", "\[Sigma]sqr", "]"}]}]}]}], "\n", "]"}]}], ";",
      "\n", 
     RowBox[{
      RowBox[{"objectiveFunction", "[", 
       RowBox[{"{", 
        RowBox[{"vars___", "?", "NumericQ"}], "}"}], "]"}], ":=", 
      RowBox[{"Norm", "[", 
       RowBox[{
        RowBox[{"R", "[", 
         RowBox[{"{", "vars", "}"}], "]"}], ",", "2"}], "]"}]}], ";", "\n", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FConstraints", "]"}], "=!=", "None"}], 
       ",", 
       RowBox[{"fitresult", "=", 
        RowBox[{"FindMinimum", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"objectiveFunction", "[", "params", "]"}], ",", 
            RowBox[{"OptionValue", "[", "FConstraints", "]"}]}], "}"}], ",", 
          "guess", ",", 
          RowBox[{"PrecisionGoal", "->", "4"}], ",", 
          RowBox[{"AccuracyGoal", "->", "4"}]}], "]"}]}], ",", 
       RowBox[{
        RowBox[{"fitresult", "=", 
         RowBox[{"FindMinimum", "[", 
          RowBox[{
           RowBox[{"objectiveFunction", "[", "params", "]"}], ",", "guess", 
           ",", 
           RowBox[{"PrecisionGoal", "->", "4"}], ",", 
           RowBox[{"AccuracyGoal", "->", "4"}], ",", 
           RowBox[{"Method", "->", 
            RowBox[{"{", 
             RowBox[{"\"\<LevenbergMarquardt\>\"", ",", 
              RowBox[{"\"\<Residual\>\"", "->", 
               RowBox[{"R", "[", "params", "]"}]}]}], "}"}]}]}], "]"}]}], ";", 
        RowBox[{
         RowBox[{"fitresult", "[", 
          RowBox[{"[", "1", "]"}], "]"}], "*=", "2."}], ";"}]}], "\n", "]"}], 
     ";", "\n", 
     RowBox[{
      RowBox[{"fitresult", "[", 
       RowBox[{"[", "1", "]"}], "]"}], "/=", 
      RowBox[{"(", 
       RowBox[{"nmax", "-", 
        RowBox[{"Length", "[", "guess", "]"}]}], ")"}]}], ";", "\n", 
     RowBox[{"modelpch", "=", 
      RowBox[{
       RowBox[{"FPCHFida", "[", 
        RowBox[{"nmax", ",", 
         RowBox[{"Abs", "@", "species"}], ",", 
         RowBox[{"Abs", "@", "nbg"}], ",", "dvdx"}], "]"}], "/.", 
       RowBox[{"Rule", "@@@", 
        RowBox[{"Transpose", "[", 
         RowBox[{"{", 
          RowBox[{"params", ",", 
           RowBox[{"params", "/.", 
            RowBox[{"fitresult", "[", 
             RowBox[{"[", "2", "]"}], "]"}]}]}], "}"}], "]"}]}]}]}], ";", 
     "\n", 
     RowBox[{
      RowBox[{"modelpch", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "2"}], "]"}], "]"}], "*=", "nbins"}], ";", "\n", 
     RowBox[{"fitresult", "~", "Join", "~", 
      RowBox[{"{", 
       RowBox[{"Show", "[", 
        RowBox[{
         RowBox[{"ListLogPlot", "[", 
          RowBox[{"pchdat", ",", 
           RowBox[{"PlotRange", "->", "All"}]}], "]"}], ",", 
         RowBox[{"ListLogPlot", "[", 
          RowBox[{
           RowBox[{"{", "modelpch", "}"}], ",", 
           RowBox[{"PlotRange", "->", "All"}], ",", 
           RowBox[{"Joined", "->", "True"}]}], "]"}], ",", 
         RowBox[{"FilterRules", "[", 
          RowBox[{
           RowBox[{"{", "opts", "}"}], ",", " ", 
           RowBox[{"Options", "[", "ListLogPlot", "]"}]}], "]"}], ",", 
         RowBox[{"PlotRange", "->", "All"}], ",", " ", 
         RowBox[{"AspectRatio", " ", "->", " ", 
          RowBox[{"1", "/", "2"}]}], ",", " ", 
         RowBox[{"Axes", " ", "->", " ", "False"}], ",", " ", 
         RowBox[{"Frame", " ", "->", " ", "True"}], ",", " ", 
         RowBox[{"FrameLabel", " ", "->", " ", 
          RowBox[{"{", 
           RowBox[{"\"\<photons in bin\>\"", ",", " ", "\"\<frequency\>\""}], 
           "}"}]}], ",", " ", 
         RowBox[{"LabelStyle", " ", "->", " ", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"FontFamily", " ", "->", " ", "\"\<Helvetica\>\""}], ",", 
            " ", 
            RowBox[{"FontSize", " ", "->", " ", "10"}], ",", " ", 
            RowBox[{"FontWeight", " ", "->", " ", "Bold"}]}], "}"}]}], ",", 
         " ", 
         RowBox[{"FrameStyle", " ", "->", " ", 
          RowBox[{"Directive", "[", 
           RowBox[{"Black", ",", " ", 
            RowBox[{"AbsoluteThickness", "[", "1", "]"}]}], "]"}]}]}], "]"}], 
       "}"}]}]}]}], "\n", "]"}]}]}], "Code",ExpressionUUID->"9d91f019-8811-\
4303-9fda-8c62acbdad89"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FPCHFidaGlobalFit", "]"}], "=", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"FConstraints", "->", "None"}], "}"}], "~", "Join", "~", " ", 
    RowBox[{"Options", "[", "ListLogPlot", "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"FPCHFidaGlobalFit", "[", 
   RowBox[{
    RowBox[{"pchdat", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"_", "?", "NumericQ"}], ",", 
             RowBox[{"_", "?", "NumericQ"}]}], "}"}], ".."}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"_", ",", "_"}], "}"}], ".."}], "}"}], ",", "_"}], "}"}], 
       ".."}], "}"}]}], ",", 
    RowBox[{"dvdx", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"_", ",", 
         RowBox[{"_", "?", "NumericQ"}]}], "}"}], ".."}], "}"}]}], ",", 
    RowBox[{"guess", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"_", ",", 
         RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}]}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "chisq", ",", "nbins", ",", "nmax", ",", "params", ",", "f", ",", "R", 
      ",", "objectiveFunction", ",", "fitresult", ",", "modelpch", ",", "dat",
       ",", "modelparams"}], "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"dat", "=", 
      RowBox[{"pchdat", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "1", ",", "All", ",", "2"}], "]"}], "]"}]}], ";", 
     "\n", 
     RowBox[{"modelparams", "=", 
      RowBox[{"pchdat", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", 
         RowBox[{"2", ";;", "3"}]}], "]"}], "]"}]}], ";", "\n", 
     RowBox[{"nbins", "=", 
      RowBox[{"Map", "[", 
       RowBox[{"Total", ",", "dat"}], "]"}]}], " ", ";", "\n", 
     RowBox[{"nmax", "=", 
      RowBox[{
       RowBox[{"Map", "[", 
        RowBox[{"Length", ",", "dat"}], "]"}], "-", "1"}]}], ";", "\n", "\n", 
     RowBox[{"params", "=", 
      RowBox[{"guess", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ";", "\n", 
     RowBox[{
      RowBox[{"f", "[", 
       RowBox[{"var", ":", 
        RowBox[{"{", 
         RowBox[{"___", "?", "NumberQ"}], "}"}]}], "]"}], ":=", 
      RowBox[{"MapThread", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            RowBox[{"FPCHFida", "[", 
             RowBox[{"#1", ",", 
              RowBox[{"Abs", "@", 
               RowBox[{"#2", "[", 
                RowBox[{"[", "1", "]"}], "]"}]}], ",", 
              RowBox[{"Abs", "@", 
               RowBox[{"#2", "[", 
                RowBox[{"[", "2", "]"}], "]"}]}], " ", ",", "dvdx"}], "]"}], "/.", 
            RowBox[{"Rule", "@@@", 
             RowBox[{"Transpose", "[", 
              RowBox[{"{", 
               RowBox[{"params", ",", "var"}], "}"}], "]"}]}]}], ")"}], "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "2"}], "]"}], "]"}], "&"}], ",", 
        RowBox[{"{", 
         RowBox[{"nmax", ",", "modelparams"}], "}"}]}], "]"}]}], ";", "\n", 
     "\n", 
     RowBox[{
      RowBox[{"R", "[", 
       RowBox[{"{", 
        RowBox[{"vars___", "?", "NumericQ"}], "}"}], "]"}], ":=", 
      RowBox[{"Module", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"model", ",", "\[Sigma]sqr"}], "}"}], ",", "\n", 
        RowBox[{
         RowBox[{"model", "=", 
          RowBox[{"f", "[", 
           RowBox[{"{", "vars", "}"}], "]"}]}], ";", "\n", 
         RowBox[{"\[Sigma]sqr", "=", 
          RowBox[{"Abs", "[", 
           RowBox[{"nbins", " ", "model", " ", 
            RowBox[{"(", 
             RowBox[{"1", "-", "model"}], ")"}]}], "]"}]}], ";", "\n", 
         RowBox[{"Flatten", "[", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             RowBox[{"nbins", " ", "model"}], "-", "dat"}], ")"}], "/", 
           RowBox[{"Sqrt", "[", "\[Sigma]sqr", "]"}]}], "]"}]}]}], "\n", 
       "]"}]}], ";", "\n", 
     RowBox[{"R", "[", 
      RowBox[{"guess", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}], ";", "\n", 
     RowBox[{
      RowBox[{"objectiveFunction", "[", 
       RowBox[{"{", 
        RowBox[{"vars___", "?", "NumericQ"}], "}"}], "]"}], ":=", 
      RowBox[{"Norm", "[", 
       RowBox[{
        RowBox[{"R", "[", 
         RowBox[{"{", "vars", "}"}], "]"}], ",", "2"}], "]"}]}], ";", "\n", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FConstraints", "]"}], "=!=", "None"}], 
       ",", 
       RowBox[{"fitresult", "=", 
        RowBox[{"FindMinimum", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"objectiveFunction", "[", "params", "]"}], ",", 
            RowBox[{"OptionValue", "[", "FConstraints", "]"}]}], "}"}], ",", 
          "guess", ",", 
          RowBox[{"PrecisionGoal", "->", "4"}], ",", 
          RowBox[{"AccuracyGoal", "->", "4"}]}], "]"}]}], ",", 
       RowBox[{
        RowBox[{"fitresult", "=", 
         RowBox[{"FindMinimum", "[", 
          RowBox[{
           RowBox[{"objectiveFunction", "[", "params", "]"}], ",", "guess", 
           ",", 
           RowBox[{"PrecisionGoal", "->", "4"}], ",", 
           RowBox[{"AccuracyGoal", "->", "4"}], ",", 
           RowBox[{"Method", "->", 
            RowBox[{"{", 
             RowBox[{"\"\<LevenbergMarquardt\>\"", ",", 
              RowBox[{"\"\<Residual\>\"", "->", 
               RowBox[{"R", "[", "params", "]"}]}]}], "}"}]}]}], "]"}]}], ";", 
        RowBox[{
         RowBox[{"fitresult", "[", 
          RowBox[{"[", "1", "]"}], "]"}], "*=", "2."}], ";"}]}], "\n", "]"}], 
     ";", "\n", 
     RowBox[{
      RowBox[{"fitresult", "[", 
       RowBox[{"[", "1", "]"}], "]"}], "/=", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"Total", "[", "nmax", "]"}], "-", 
        RowBox[{"Length", "[", "guess", "]"}]}], ")"}]}], ";", "\n", 
     RowBox[{"modelpch", "=", 
      RowBox[{
       RowBox[{"MapThread", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"FPCHFida", "[", 
           RowBox[{"#1", ",", 
            RowBox[{"Abs", "@", 
             RowBox[{"#2", "[", 
              RowBox[{"[", "1", "]"}], "]"}]}], ",", 
            RowBox[{"Abs", "@", 
             RowBox[{"#2", "[", 
              RowBox[{"[", "2", "]"}], "]"}]}], ",", "dvdx"}], "]"}], "&"}], 
         ",", 
         RowBox[{"{", 
          RowBox[{"nmax", ",", "modelparams"}], "}"}]}], "]"}], "/.", 
       RowBox[{"Rule", "@@@", 
        RowBox[{"Transpose", "[", 
         RowBox[{"{", 
          RowBox[{"params", ",", 
           RowBox[{"params", "/.", 
            RowBox[{"fitresult", "[", 
             RowBox[{"[", "2", "]"}], "]"}]}]}], "}"}], "]"}]}]}]}], ";", 
     "\n", 
     RowBox[{
      RowBox[{"modelpch", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "All", ",", "2"}], "]"}], "]"}], "*=", "nbins"}], 
     ";", "\n", "modelpch", ";", "\n", 
     RowBox[{"fitresult", "~", "Join", "~", 
      RowBox[{"{", 
       RowBox[{"Show", "[", 
        RowBox[{
         RowBox[{"ListLogPlot", "[", 
          RowBox[{
           RowBox[{"pchdat", "[", 
            RowBox[{"[", 
             RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", 
           RowBox[{"PlotRange", "->", "All"}]}], "]"}], ",", 
         RowBox[{"ListLogPlot", "[", 
          RowBox[{"modelpch", ",", 
           RowBox[{"PlotRange", "->", "All"}], ",", 
           RowBox[{"Joined", "->", "True"}]}], "]"}], ",", 
         RowBox[{"FilterRules", "[", 
          RowBox[{
           RowBox[{"{", "opts", "}"}], ",", " ", 
           RowBox[{"Options", "[", "ListLogPlot", "]"}]}], "]"}], ",", 
         RowBox[{"PlotRange", "->", "All"}], ",", " ", 
         RowBox[{"AspectRatio", " ", "->", " ", 
          RowBox[{"1", "/", "2"}]}], ",", " ", 
         RowBox[{"Axes", " ", "->", " ", "False"}], ",", " ", 
         RowBox[{"Frame", " ", "->", " ", "True"}], ",", " ", 
         RowBox[{"FrameLabel", " ", "->", " ", 
          RowBox[{"{", 
           RowBox[{"\"\<photons in bin\>\"", ",", " ", "\"\<frequency\>\""}], 
           "}"}]}], ",", " ", 
         RowBox[{"LabelStyle", " ", "->", " ", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"FontFamily", " ", "->", " ", "\"\<Helvetica\>\""}], ",", 
            " ", 
            RowBox[{"FontSize", " ", "->", " ", "10"}], ",", " ", 
            RowBox[{"FontWeight", " ", "->", " ", "Bold"}]}], "}"}]}], ",", 
         " ", 
         RowBox[{"FrameStyle", " ", "->", " ", 
          RowBox[{"Directive", "[", 
           RowBox[{"Black", ",", " ", 
            RowBox[{"AbsoluteThickness", "[", "1", "]"}]}], "]"}]}]}], "]"}], 
       "}"}]}]}]}], "\n", "]"}]}]}], "Code",ExpressionUUID->"678dd477-a1ce-\
4661-a2a0-d5269b570c26"]
}, Closed]],

Cell[CellGroupData[{

Cell["Burst identification", "Subsubsection",ExpressionUUID->"786470b7-b211-48cf-84f4-7cae729a3903"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FSetBurstList", "[", 
   RowBox[{"timeintervals", ":", 
    RowBox[{"{", " ", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumericQ"}], ",", " ", 
        RowBox[{"_", "?", "NumericQ"}]}], "}"}], " ", ".."}], "}"}]}], "]"}], 
  ":=", 
  RowBox[{"FPSetBurstList", "[", 
   RowBox[{"N", "@", "timeintervals"}], "]"}]}]], "Input",
 CellChangeTimes->{{3.8134957776768045`*^9, 
  3.813495922420701*^9}},ExpressionUUID->"1922385f-9c93-4409-b228-\
1ef1a1a240c7"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FFindBurstsDeltaT", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{
    "FPIEBurstIdentificationMethod", "->", "FMainChannelAboveThreshold"}], 
    "}"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"FFindBurstsDeltaT", "[", 
   RowBox[{
    RowBox[{"\[CapitalDelta]t_", "?", "NumberQ"}], ",", 
    RowBox[{"minburstcount_", "?", "NumberQ"}], ",", 
    RowBox[{"maxburstcount_", "?", "NumberQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  "\[IndentingNewLine]", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"tA", ",", "tD"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"OptionValue", "[", "FPIEBurstIdentificationMethod", "]"}], "=!=",
        "FDualChannelBurstSearch"}], ",", "\[IndentingNewLine]", 
      RowBox[{"FFindBurstsDeltaTP", "[", 
       RowBox[{
        RowBox[{"N", "[", "\[CapitalDelta]t", "]"}], ",", 
        RowBox[{"Round", "[", "minburstcount", "]"}], ",", 
        RowBox[{"Round", "[", "maxburstcount", "]"}], ",", 
        RowBox[{"Which", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"OptionValue", "[", "FPIEBurstIdentificationMethod", "]"}],
            "===", "FMainChannelAboveThreshold"}], ",", "0", ",", 
          RowBox[{
           RowBox[{"OptionValue", "[", "FPIEBurstIdentificationMethod", "]"}],
            "===", "FMainChannelOrPieChannelAboveThreshold"}], ",", "1", ",", 
          RowBox[{
           RowBox[{"OptionValue", "[", "FPIEBurstIdentificationMethod", "]"}],
            "===", "FMainChannelPlusPieChannelAboveThreshold"}], ",", "2", 
          ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"OptionValue", "[", "FPIEBurstIdentificationMethod", "]"}],
            "===", "FPieChannelAboveThreshold"}], ",", "3", ",", "True", ",", 
          "0"}], "]"}]}], "]"}], "\[IndentingNewLine]", ",", 
      "\[IndentingNewLine]", 
      RowBox[{"(", 
       RowBox[{"(*", "DCBS", "*)"}], "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"FFindBurstsDeltaT", "[", 
         RowBox[{
         "\[CapitalDelta]t", ",", "minburstcount", ",", "maxburstcount", ",", 
          RowBox[{
          "FPIEBurstIdentificationMethod", "->", 
           "FMainChannelAboveThreshold"}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"tD", "=", 
         RowBox[{"Interval", "@@", 
          RowBox[{"Transpose", "[", 
           RowBox[{"FGetFromBurstList", "[", 
            RowBox[{"{", 
             RowBox[{"\"\<StartTime\>\"", ",", "\"\<EndTime\>\""}], "}"}], 
            "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"FFindBurstsDeltaT", "[", 
         RowBox[{
         "\[CapitalDelta]t", ",", "minburstcount", ",", "maxburstcount", ",", 
          RowBox[{
          "FPIEBurstIdentificationMethod", "->", 
           "FPieChannelAboveThreshold"}]}], "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"tA", "=", 
         RowBox[{"Interval", "@@", 
          RowBox[{"Transpose", "[", 
           RowBox[{"FGetFromBurstList", "[", 
            RowBox[{"{", 
             RowBox[{"\"\<StartTime\>\"", ",", "\"\<EndTime\>\""}], "}"}], 
            "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"FSetBurstList", "[", 
         RowBox[{"List", "@@", 
          RowBox[{"IntervalIntersection", "[", 
           RowBox[{"tA", ",", "tD"}], "]"}]}], "]"}]}], "\[IndentingNewLine]",
        ")"}]}], "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.8604928356590433`*^9, 3.860492859580208*^9}, {
   3.865522356680252*^9, 3.865522435588642*^9}, {3.865522485853944*^9, 
   3.865522670507866*^9}, 3.8655227535259295`*^9, {3.8655232566376038`*^9, 
   3.8655233847099104`*^9}, 3.865523770327058*^9, {3.8655256894436135`*^9, 
   3.8655256919809027`*^9}},ExpressionUUID->"9631ae43-ccd5-44c3-bebc-\
cdc51383f735"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FFindBurstsFromTimeBinnedData", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"FCombineContiguousBins", "->", "True"}], ",", 
     RowBox[{
     "FPIEBurstIdentificationMethod", "->", "FMainChannelAboveThreshold"}]}], 
    "}"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"FFindBurstsFromTimeBinnedData", "[", 
   RowBox[{
    RowBox[{"binwidth_", "?", "NumberQ"}], ",", 
    RowBox[{"minbincount_", "?", "NumberQ"}], ",", 
    RowBox[{"minburstcount_", "?", "NumberQ"}], ",", 
    RowBox[{"maxburstcount_", "?", "NumberQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"tA", ",", "tD"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"OptionValue", "[", "FPIEBurstIdentificationMethod", "]"}], "=!=",
        "FDualChannelBurstSearch"}], ",", "\[IndentingNewLine]", 
      RowBox[{"FPFindBurstsBinning", "[", 
       RowBox[{
        RowBox[{"N", "[", "binwidth", "]"}], ",", 
        RowBox[{"N", "[", "minbincount", "]"}], ",", 
        RowBox[{"N", "[", "minburstcount", "]"}], ",", 
        RowBox[{"Round", "[", "maxburstcount", "]"}], ",", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"OptionValue", "[", "FCombineContiguousBins", "]"}], "==", 
           "True"}], ",", "1", ",", "0"}], "]"}], ",", 
        RowBox[{"Which", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"OptionValue", "[", "FPIEBurstIdentificationMethod", "]"}],
            "===", "FMainChannelAboveThreshold"}], ",", "0", ",", 
          RowBox[{
           RowBox[{"OptionValue", "[", "FPIEBurstIdentificationMethod", "]"}],
            "===", "FMainChannelOrPieChannelAboveThreshold"}], ",", "1", ",", 
          RowBox[{
           RowBox[{"OptionValue", "[", "FPIEBurstIdentificationMethod", "]"}],
            "===", "FMainChannelPlusPieChannelAboveThreshold"}], ",", "2", 
          ",", 
          RowBox[{
           RowBox[{"OptionValue", "[", "FPIEBurstIdentificationMethod", "]"}],
            "===", "FPieChannelAboveThreshold"}], ",", "3", ",", "True", ",", 
          "0"}], "]"}]}], "]"}], "\[IndentingNewLine]", ",", 
      "\[IndentingNewLine]", 
      RowBox[{"(", 
       RowBox[{"(*", "DCBS", "*)"}], "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"FFindBurstsFromTimeBinnedData", "[", 
         RowBox[{
         "binwidth", ",", "minbincount", ",", "minburstcount", ",", 
          "maxburstcount", ",", 
          RowBox[{
          "FPIEBurstIdentificationMethod", "->", 
           "FMainChannelAboveThreshold"}], ",", 
          RowBox[{"FCombineContiguousBins", "->", "True"}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"tD", "=", 
         RowBox[{"Interval", "@@", 
          RowBox[{"Transpose", "[", 
           RowBox[{"FGetFromBurstList", "[", 
            RowBox[{"{", 
             RowBox[{"\"\<StartTime\>\"", ",", "\"\<EndTime\>\""}], "}"}], 
            "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"FFindBurstsFromTimeBinnedData", "[", 
         RowBox[{
         "binwidth", ",", "minbincount", ",", "minburstcount", ",", 
          "maxburstcount", ",", 
          RowBox[{
          "FPIEBurstIdentificationMethod", "->", 
           "FPieChannelAboveThreshold"}], ",", 
          RowBox[{"FCombineContiguousBins", "->", "True"}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"tA", "=", 
         RowBox[{"Interval", "@@", 
          RowBox[{"Transpose", "[", 
           RowBox[{"FGetFromBurstList", "[", 
            RowBox[{"{", 
             RowBox[{"\"\<StartTime\>\"", ",", "\"\<EndTime\>\""}], "}"}], 
            "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"FSetBurstList", "[", 
         RowBox[{"List", "@@", 
          RowBox[{"IntervalIntersection", "[", 
           RowBox[{"tA", ",", "tD"}], "]"}]}], "]"}]}], "\[IndentingNewLine]",
        ")"}]}], "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.8604929008483667`*^9, 3.860492903789544*^9}, {
   3.8655235056067743`*^9, 3.8655235346873236`*^9}, {3.8655235802425423`*^9, 
   3.8655236095796423`*^9}, {3.8655236619784575`*^9, 3.8655236873955*^9}, {
   3.865523752836005*^9, 3.865523759789501*^9}, {3.865525240087353*^9, 
   3.865525264335701*^9}, 3.8655254200440254`*^9, {3.8655254582533827`*^9, 
   3.8655254629079237`*^9}, {3.865525499244743*^9, 
   3.8655255021920433`*^9}},ExpressionUUID->"a2364b3e-e193-46cd-86f2-\
7dfdd14c7b39"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"FSplitBursts", "[", 
     RowBox[{"t_", "?", "FRealNumberQ"}], "]"}], ":=", 
    RowBox[{"FSplitburstsP", "[", 
     RowBox[{"t", "*", "1000."}], "]"}]}], ";"}], "\n"}]], "Code",ExpressionUU\
ID->"1a4ead41-d37b-4e6d-a6ca-9406da32ee9d"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"FExpandBurstsSymmetrically", "[", 
    RowBox[{"t_", "?", "FRealNumberQ"}], "]"}], ":=", 
   RowBox[{"FExpandBurstsSymmetricallyP", "[", 
    RowBox[{"N", "[", "t", "]"}], "]"}]}], ";"}]], "Code",ExpressionUUID->\
"331dc274-c359-40e1-9c16-ae62d8f8001a"]
}, Closed]],

Cell[CellGroupData[{

Cell["Time Binned Photon trajectory (MCS)", "Subsubsection",ExpressionUUID->"5be665fc-33dd-42aa-9435-ab09e2e4442b"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "FMCStrace", "]"}], "=", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"FOutput", "->", "FGraph"}], ",", 
       RowBox[{"Weights", "->", 
        RowBox[{"{", "1", "}"}]}], ",", 
       RowBox[{"FShowBursts", "->", "False"}], ",", 
       RowBox[{"FShowBurstsLevel", "->", "10"}], ",", 
       RowBox[{"FBurstData", "\[Rule]", "All"}]}], "}"}], "~", "Join", "~", 
     RowBox[{"Options", "[", "ListLogPlot", "]"}]}]}], ";"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]"}], "\n", 
 RowBox[{
  RowBox[{"FMCStrace", "[", 
   RowBox[{
    RowBox[{"routes", ":", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"FRouteList", ".."}], "}"}], "|", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"FRouteList", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "FValidChannelQ"}], ",", 
            RowBox[{"_", "?", "FValidChannelQ"}]}], "}"}]}], "}"}], ".."}], 
       "}"}]}]}], ",", 
    RowBox[{"binwidthMs_", "?", "NumberQ"}], ",", 
    RowBox[{"t1_", "?", "NumberQ"}], ",", 
    RowBox[{"t2_", "?", "NumberQ"}], ",", " ", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  "\[IndentingNewLine]", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "dat", ",", "mcs", ",", "bl", ",", "blevel", ",", "weights", ",", "f"}], 
     "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"weights", "=", 
      RowBox[{"PadRight", "[", 
       RowBox[{
        RowBox[{"OptionValue", "[", "Weights", "]"}], ",", 
        RowBox[{"Length", "[", "routes", "]"}], ",", "1"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"f", "[", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"r", ":", "FRouteList"}], ",", 
         RowBox[{"{", 
          RowBox[{"c1_", ",", "c2_"}], "}"}]}], "}"}], "]"}], ":=", 
      RowBox[{"FPPhotonTrajectoryWithChannelConstraints", "[", 
       RowBox[{
        RowBox[{"FRouteListToByte", "[", 
         RowBox[{"FExpandRoutelist", "@", "r"}], "]"}], ",", 
        RowBox[{"N", "@", "binwidthMs"}], ",", 
        RowBox[{"N", "@", "t1"}], ",", 
        RowBox[{"N", "@", "t2"}], ",", 
        RowBox[{"c1", "-", "1"}], ",", 
        RowBox[{"c2", "-", "1"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"dat", "=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"MatchQ", "[", 
         RowBox[{"routes", ",", 
          RowBox[{"{", 
           RowBox[{"FRouteList", ".."}], "}"}]}], "]"}], 
        "\[IndentingNewLine]", ",", 
        RowBox[{"FPPhotonTrajectory", "[", 
         RowBox[{
          RowBox[{"FRouteListToByte", "/@", "routes"}], ",", 
          RowBox[{"N", "@", "binwidthMs"}], ",", 
          RowBox[{"N", "@", "t1"}], ",", 
          RowBox[{"N", "@", "t2"}]}], "]"}], "\[IndentingNewLine]", ",", 
        RowBox[{"Map", "[", 
         RowBox[{"f", ",", "routes"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"dat", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "All", ",", "2"}], "]"}], "]"}], "*=", 
      "weights"}], ";", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FGraph"}], ",", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"mcs", "=", 
          RowBox[{"ListPlot", "[", 
           RowBox[{"dat", ",", 
            RowBox[{"FilterRules", "[", 
             RowBox[{
              RowBox[{"{", "opts", "}"}], ",", " ", 
              RowBox[{"Options", "[", "ListPlot", "]"}]}], "]"}], ",", 
            RowBox[{"Joined", "->", "True"}], ",", 
            RowBox[{"PlotRange", "->", "All"}], ",", 
            RowBox[{"ImageSize", "->", "600"}], ",", 
            RowBox[{"AspectRatio", "->", "0.2"}], ",", 
            RowBox[{"Axes", "->", "False"}], ",", 
            RowBox[{"Frame", "->", "True"}], ",", 
            RowBox[{"FrameLabel", "->", 
             RowBox[{"{", 
              RowBox[{"\"\<time (sec)\>\"", ",", "\"\<photons\>\""}], "}"}]}],
             ",", 
            RowBox[{"PlotStyle", "->", 
             RowBox[{"{", 
              RowBox[{"Red", ",", "Green", ",", 
               RowBox[{"Darker", "[", "Red", "]"}], ",", 
               RowBox[{"Darker", "[", "Green", "]"}]}], "}"}]}], ",", 
            RowBox[{"LabelStyle", "->", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"FontFamily", "->", " ", "\"\<Helvetica\>\""}], ",", 
               RowBox[{"FontSize", "->", " ", "12"}], ",", 
               RowBox[{"FontWeight", "->", " ", "Bold"}]}], "}"}]}], ",", 
            RowBox[{"FrameStyle", "->", " ", 
             RowBox[{"Directive", "[", 
              RowBox[{"Black", ",", 
               RowBox[{"AbsoluteThickness", "[", "1", "]"}]}], "]"}]}]}], 
           "]"}]}], ";", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"OptionValue", "[", "FShowBursts", "]"}], "==", "True"}], 
           ",", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"bl", "=", 
              RowBox[{
               RowBox[{"FGetFromBurstList", "[", 
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{"\"\<StartTime\>\"", ",", "\"\<EndTime\>\""}], 
                  "}"}], ",", 
                 RowBox[{"FilterRules", "[", 
                  RowBox[{
                   RowBox[{"{", "opts", "}"}], ",", " ", 
                   RowBox[{"Options", "[", "FGetFromBurstList", "]"}]}], 
                  "]"}]}], "]"}], "\[Transpose]"}]}], ";", 
             RowBox[{"bl", "=", 
              RowBox[{"Select", "[", 
               RowBox[{"bl", ",", 
                RowBox[{
                 RowBox[{"t1", "<", 
                  RowBox[{"#", "[", 
                   RowBox[{"[", "1", "]"}], "]"}], "<", "t2"}], "&"}]}], 
               "]"}]}], ";", 
             RowBox[{"blevel", "=", 
              RowBox[{"OptionValue", "[", "FShowBurstsLevel", "]"}]}], ";", 
             RowBox[{"Show", "[", 
              RowBox[{"mcs", ",", 
               RowBox[{"Graphics", "[", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{"AbsoluteThickness", "[", "2", "]"}], ",", 
                  RowBox[{"Map", "[", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"Line", "[", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"#", "[", 
                    RowBox[{"[", "1", "]"}], "]"}], ",", "blevel"}], "}"}], 
                    ",", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"#", "[", 
                    RowBox[{"[", "2", "]"}], "]"}], ",", "blevel"}], "}"}]}], 
                    "}"}], "]"}], "&"}], ",", "bl"}], "]"}]}], "}"}], "]"}], 
               ",", 
               RowBox[{"PlotRange", "->", "All"}]}], "]"}]}], ")"}], ",", 
           "mcs"}], "]"}]}], ")"}], ",", 
       RowBox[{"(*", "else", "*)"}], "\n", "dat"}], "\n", "]"}]}]}], "\n", 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.7489405123225026`*^9, 3.748940533310344*^9}, {
   3.7501377859671116`*^9, 3.75013780093408*^9}, {3.765265833190453*^9, 
   3.7652659074561963`*^9}, {3.7652659476826515`*^9, 3.765265988353964*^9}, {
   3.7652660195679026`*^9, 3.765266071973497*^9}, {3.7652661525520487`*^9, 
   3.7652661791056604`*^9}, {3.765266226881649*^9, 3.7652662691195126`*^9}, {
   3.765282850233099*^9, 3.7652828606806335`*^9}, {3.80638315116528*^9, 
   3.8063832101127195`*^9}, 3.806383381877507*^9, {3.806384652192458*^9, 
   3.8063848447437367`*^9}, {3.8063849022998123`*^9, 
   3.8063849532775383`*^9}, {3.806384990172925*^9, 3.80638500890382*^9}, {
   3.8063854671231127`*^9, 3.806385477154295*^9}, 
   3.8063869297826166`*^9},ExpressionUUID->"c0466ca5-e107-42d5-a618-\
d859a4cec108"]
}, Closed]],

Cell[CellGroupData[{

Cell["Cutting TTTR data", "Subsubsection",ExpressionUUID->"20bbccc3-26c4-409c-b5f4-b99b941ca4a1"],

Cell["\<\
FPDeleteTTTRTimeInterval[t1,t2] deletes all photons between t1 and t2. All \
later photon arrival times are shtifted in time by t1-t2. The time unit of t1 \
and t2 is seconds.
The cutting cannot be redone. One has to reopen the TTTR file for obtaining \
the complete photon trajectory again.   \
\>", "Text",ExpressionUUID->"52672ceb-e179-472a-9794-bebed40930d8"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FDeleteTTTRTimeInterval", "]"}], " ", "=", " ", 
   RowBox[{"{", 
    RowBox[{"FCloseGap", " ", "->", " ", "True"}], "}"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FDeleteTTTRTimeInterval", "[", 
    RowBox[{
     RowBox[{"times", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumberQ"}], ",", 
          RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}]}], ",", 
     RowBox[{"opts", " ", ":", " ", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"FPDeleteTTTRTimeIntervals", "[", 
    RowBox[{
     RowBox[{"N", "@", 
      RowBox[{"Flatten", "@", "times"}]}], ",", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FCloseGap", "]"}], "===", "True"}], ",", 
       "1", ",", "0"}], "]"}]}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FDeleteTTTRTimeInterval", "[", 
    RowBox[{
     RowBox[{"t1sec_", "?", "NumberQ"}], ",", 
     RowBox[{"t2sec_", "?", "NumberQ"}], ",", 
     RowBox[{"opts", " ", ":", " ", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"FPDeleteTTTRTimeIntervals", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"N", "@", "t1sec"}], ",", 
       RowBox[{"N", "@", "t2sec"}]}], "}"}], ",", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FCloseGap", "]"}], "===", "True"}], ",", 
       "1", ",", "0"}], "]"}]}], "]"}]}], ";"}], "\n"}], "Code",ExpressionUUID\
->"fdfaeb12-105f-4de0-aaf1-8896e875c545"]
}, Closed]],

Cell[CellGroupData[{

Cell["Lifetime ", "Subsubsection",
 CellChangeTimes->{
  3.8580460359982634`*^9},ExpressionUUID->"3b5bd711-c32f-4857-a443-\
8ebfd037a155"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FLifeTimeHisto", "]"}], "=", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"FOutput", "->", "FGraph"}], ",", 
      RowBox[{"FPhotonData", "->", "FBursts"}], ",", 
      RowBox[{"FRoutes", "->", "All"}]}], "}"}], "~", "Join", "~", 
    RowBox[{"Options", "[", "ListLogPlot", "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"FLifeTimeHisto", "[", 
   RowBox[{"opts", ":", 
    RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"dat", ",", "routes", ",", 
      RowBox[{"mode", "=", "0"}]}], "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"routes", "=", 
      RowBox[{"OptionValue", "[", "FRoutes", "]"}]}], ";", "\n", 
     RowBox[{"Which", "[", "\n", 
      RowBox[{
       RowBox[{"routes", "===", "All"}], ",", 
       RowBox[{"routes", "=", 
        RowBox[{"Range", "[", "FNumberOfRoutes", "]"}]}], ",", "\n", 
       RowBox[{"MatchQ", "[", 
        RowBox[{"routes", ",", 
         RowBox[{"{", 
          RowBox[{"_Integer", ".."}], "}"}]}], "]"}], ",", "True", ",", "\n", 
       "True", ",", " ", 
       RowBox[{"Return", "[", "$Failed", "]"}]}], "\n", "]"}], ";", "\n", 
     RowBox[{"Which", "[", "\n", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", "All"}], ",", 
       RowBox[{"mode", "=", "0"}], ",", "\n", 
       RowBox[{
        RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", "FBursts"}], 
       ",", 
       RowBox[{"mode", "=", "1"}], ",", "\n", 
       RowBox[{
        RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", 
        "FNonBursts"}], ",", 
       RowBox[{"mode", "=", "2"}], ",", "\n", 
       RowBox[{
        RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", 
        "FSelectedBursts"}], ",", 
       RowBox[{"mode", "=", "3"}], ",", "\n", "True", ",", " ", 
       RowBox[{"Return", "[", "$Failed", "]"}]}], "\n", "]"}], ";", "\n", 
     RowBox[{"dat", "=", 
      RowBox[{"Map", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"FPLifeTimeHisto", "[", 
          RowBox[{
           RowBox[{"#", "-", "1"}], ",", "mode"}], "]"}], "&"}], ",", 
        "routes"}], "]"}]}], ";", "\n", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FGraph"}], ",", 
       RowBox[{"ListLogPlot", "[", 
        RowBox[{"dat", ",", 
         RowBox[{"FilterRules", "[", 
          RowBox[{
           RowBox[{"{", "opts", "}"}], ",", " ", 
           RowBox[{"Options", "[", "ListLogPlot", "]"}]}], "]"}], ",", 
         RowBox[{"FrameLabel", "->", 
          RowBox[{"{", 
           RowBox[{"\"\<ns\>\"", ",", "None"}], "}"}]}], ",", 
         RowBox[{"Axes", "->", "False"}], ",", 
         RowBox[{"Frame", "->", "True"}], ",", 
         RowBox[{"LabelStyle", "->", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"FontFamily", "->", " ", "\"\<Helvetica\>\""}], ",", 
            RowBox[{"FontSize", "->", " ", "12"}], ",", 
            RowBox[{"FontWeight", "->", " ", "Bold"}]}], "}"}]}], ",", 
         RowBox[{"FrameStyle", "->", " ", 
          RowBox[{"Directive", "[", 
           RowBox[{"Black", ",", 
            RowBox[{"AbsoluteThickness", "[", "1", "]"}]}], "]"}]}], ",", 
         RowBox[{"PlotRange", "->", "All"}], ",", 
         RowBox[{"PlotStyle", "->", 
          RowBox[{"{", 
           RowBox[{"Red", ",", "Green", ",", 
            RowBox[{"Darker", "[", "Red", "]"}], ",", 
            RowBox[{"Darker", "[", "Green", "]"}]}], "}"}]}]}], "]"}], "\n", 
       ",", "dat"}], "\n", "]"}]}]}], "\n", "]"}]}], "\n"}], "Code",
 CellChangeTimes->{
  3.7651877693048925`*^9},ExpressionUUID->"53256f91-6bf9-41b7-a9dd-\
603c375d797b"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"FConvolve", "[", 
     RowBox[{
      RowBox[{"irf", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"_", ",", "_"}], "}"}], ".."}], "}"}]}], ",", 
      "timeshift_Integer", ",", "model_"}], "]"}], "[", 
    RowBox[{"times", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"irfdat", ",", "modeldat"}], "}"}], ",", "\n", 
     RowBox[{
      RowBox[{"modeldat", "=", 
       RowBox[{"ListConvolve", "[", 
        RowBox[{
         RowBox[{"N", "@", 
          RowBox[{"RotateRight", "[", 
           RowBox[{
            RowBox[{"irf", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "2"}], "]"}], "]"}], ",", "timeshift"}], 
           "]"}]}], ",", 
         RowBox[{"model", "[", "times", "]"}], ",", "1"}], "]"}]}], ";", "\n", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"times", ",", "modeldat"}], "}"}], "\[Transpose]"}]}]}], "\n",
     "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FLifeTimeFit", "]"}], "=", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"FOutput", " ", "->", " ", "FGraph"}], "}"}], "~", "Join", "~", 
    RowBox[{"Options", "[", "ListLogPlot", "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"FLifeTimeFit", "[", 
   RowBox[{
    RowBox[{"dat", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumberQ"}], ",", 
         RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}]}], ",", 
    RowBox[{"irf", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumberQ"}], ",", 
         RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}]}], ",", 
    "modelfunc_", ",", 
    RowBox[{"guess", ":", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"_", ",", 
          RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}], "|", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"_", ",", 
          RowBox[{"_", "?", "NumberQ"}], ",", 
          RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}]}]}], ",", 
    "timeshift_Integer", ",", 
    RowBox[{"opts", " ", ":", " ", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "times", ",", "func", ",", "fitresult", ",", "fitdat", ",", 
      "residuals"}], "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"times", "=", 
      RowBox[{"dat", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ";", "\n", 
     RowBox[{
      RowBox[{"func", "[", 
       RowBox[{"t", ":", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], "]"}], ":=", 
      RowBox[{
       RowBox[{
        RowBox[{"FConvolve", "[", 
         RowBox[{"irf", ",", "timeshift", ",", "modelfunc"}], "]"}], "[", "t",
         "]"}], "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "2"}], "]"}], "]"}]}], ";", "\n", 
     RowBox[{"fitresult", "=", 
      RowBox[{"FLMFit", "[", 
       RowBox[{"dat", ",", "func", ",", "guess"}], "]"}]}], ";", "\n", 
     RowBox[{"fitdat", "=", 
      RowBox[{
       RowBox[{"FConvolve", "[", 
        RowBox[{"irf", ",", "timeshift", ",", 
         RowBox[{"modelfunc", "/.", 
          RowBox[{"fitresult", "[", 
           RowBox[{"[", "2", "]"}], "]"}]}]}], "]"}], "[", "times", "]"}]}], 
     ";", "\n", 
     RowBox[{"residuals", "=", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"dat", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", 
         RowBox[{
          RowBox[{"dat", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "2"}], "]"}], "]"}], "-", 
          RowBox[{"fitdat", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "2"}], "]"}], "]"}]}]}], "}"}], 
       "\[Transpose]"}]}], ";", "\n", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FOutput", "]"}], " ", "===", " ", 
        "FGraph"}], ",", "\n", 
       RowBox[{"{", 
        RowBox[{"fitresult", ",", "\n", 
         RowBox[{"ListLogPlot", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"dat", ",", "fitdat"}], "}"}], ",", 
           RowBox[{"Evaluate", "@", 
            RowBox[{"FilterRules", "[", 
             RowBox[{
              RowBox[{"{", "opts", "}"}], ",", " ", 
              RowBox[{"Options", "[", "ListLogPlot", "]"}]}], "]"}]}], ",", 
           RowBox[{"PlotRange", "->", "All"}], ",", 
           RowBox[{"Frame", "->", "True"}], ",", 
           RowBox[{"Axes", "->", "False"}]}], "]"}], ",", "\n", 
         RowBox[{"ListPlot", "[", 
          RowBox[{"residuals", ",", 
           RowBox[{"PlotRange", "->", "All"}], ",", 
           RowBox[{"Frame", "->", "True"}], ",", 
           RowBox[{"Axes", "->", "False"}]}], "]"}]}], "}"}], ",", "\n", 
       RowBox[{"{", 
        RowBox[{"fitresult", ",", "fitdat", ",", "residuals"}], "}"}]}], "\n",
       "]"}]}]}], "\n", "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FLifeTimeFit", "[", 
   RowBox[{
    RowBox[{"dat", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumberQ"}], ",", 
           RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}], ".."}], 
      "}"}]}], ",", 
    RowBox[{"irf", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumberQ"}], ",", 
           RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}], ".."}], 
      "}"}]}], ",", "modelfunc_", ",", 
    RowBox[{"guess", ":", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"_", ",", 
          RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}], "|", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"_", ",", 
          RowBox[{"_", "?", "NumberQ"}], ",", 
          RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}]}]}], ",", 
    RowBox[{"timeshift", ":", 
     RowBox[{"{", 
      RowBox[{"_Integer", ".."}], "}"}]}], ",", 
    RowBox[{"opts", " ", ":", " ", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "times", ",", "func", ",", "fitresult", ",", "fitdat", ",", "residuals", 
      ",", "model"}], "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"times", "=", 
      RowBox[{"dat", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "All", ",", "1"}], "]"}], "]"}]}], ";", "\n", 
     RowBox[{
      RowBox[{
       RowBox[{"func", "[", "i_", "]"}], "[", "t_", "]"}], ":=", 
      RowBox[{
       RowBox[{
        RowBox[{"FConvolve", "[", 
         RowBox[{
          RowBox[{"irf", "[", 
           RowBox[{"[", "i", "]"}], "]"}], ",", 
          RowBox[{"timeshift", "[", 
           RowBox[{"[", "i", "]"}], "]"}], ",", 
          RowBox[{"modelfunc", "[", 
           RowBox[{"[", "i", "]"}], "]"}]}], "]"}], "[", " ", "t", " ", "]"}],
        "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "2"}], "]"}], "]"}]}], ";", "\n", 
     RowBox[{"model", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"func", "[", "i", "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", 
          RowBox[{"Length", "[", "modelfunc", "]"}]}], "}"}]}], "]"}]}], ";", 
     "\n", 
     RowBox[{"fitresult", "=", 
      RowBox[{"FLMFit", "[", 
       RowBox[{"dat", ",", "model", ",", "guess"}], "]"}]}], ";", "\n", 
     RowBox[{"fitdat", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"FConvolve", "[", 
          RowBox[{
           RowBox[{"irf", "[", 
            RowBox[{"[", "i", "]"}], "]"}], ",", 
           RowBox[{"timeshift", "[", 
            RowBox[{"[", "i", "]"}], "]"}], ",", 
           RowBox[{
            RowBox[{"modelfunc", "[", 
             RowBox[{"[", "i", "]"}], "]"}], "/.", 
            RowBox[{"fitresult", "[", 
             RowBox[{"[", "2", "]"}], "]"}]}]}], "]"}], "[", 
         RowBox[{"times", "[", 
          RowBox[{"[", "i", "]"}], "]"}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", 
          RowBox[{"Length", "[", "modelfunc", "]"}]}], "}"}]}], "]"}]}], ";", 
     "\n", 
     RowBox[{"residuals", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"dat", "[", 
            RowBox[{"[", 
             RowBox[{"i", ",", "All", ",", "1"}], "]"}], "]"}], ",", 
           RowBox[{
            RowBox[{"dat", "[", 
             RowBox[{"[", 
              RowBox[{"i", ",", "All", ",", "2"}], "]"}], "]"}], "-", 
            RowBox[{"fitdat", "[", 
             RowBox[{"[", 
              RowBox[{"i", ",", "All", ",", "2"}], "]"}], "]"}]}]}], "}"}], 
         "\[Transpose]"}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", 
          RowBox[{"Length", "[", "modelfunc", "]"}]}], "}"}]}], "]"}]}], ";", 
     "\n", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FOutput", "]"}], " ", "===", " ", 
        "FGraph"}], ",", "\n", 
       RowBox[{"{", 
        RowBox[{"fitresult", ",", "\n", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"ListLogPlot", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{
               RowBox[{"dat", "[", 
                RowBox[{"[", "i", "]"}], "]"}], ",", 
               RowBox[{"fitdat", "[", 
                RowBox[{"[", "i", "]"}], "]"}]}], "}"}], ",", 
             RowBox[{"FilterRules", "[", 
              RowBox[{
               RowBox[{"{", "opts", "}"}], ",", " ", 
               RowBox[{"Options", "[", "ListLogPlot", "]"}]}], "]"}], ",", 
             RowBox[{"PlotRange", "->", "All"}], ",", 
             RowBox[{"Frame", "->", "True"}], ",", 
             RowBox[{"Axes", "->", "False"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "[", "modelfunc", "]"}]}], "}"}]}], "]"}], ",",
          "\n", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"ListPlot", "[", 
            RowBox[{
             RowBox[{"residuals", "[", 
              RowBox[{"[", "i", "]"}], "]"}], ",", 
             RowBox[{"PlotRange", "->", "All"}], ",", 
             RowBox[{"Frame", "->", "True"}], ",", 
             RowBox[{"Axes", "->", "False"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "[", "modelfunc", "]"}]}], "}"}]}], "]"}]}], 
        "}"}], ",", "\n", 
       RowBox[{"{", 
        RowBox[{"fitresult", ",", "fitdat", ",", "residuals"}], "}"}]}], "\n",
       "]"}]}]}], "\n", "\n", "]"}]}]}], "Code",ExpressionUUID->"a02bb63f-\
aa44-4028-b375-a3a4b7401fd0"]
}, Closed]],

Cell[CellGroupData[{

Cell["Background photon rates", "Subsubsection",ExpressionUUID->"cc40fb79-e6ef-4d3d-b2e2-e4215483eabf"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FDetermineBackground", "[", "]"}], ":=", 
  RowBox[{"FPDetermineBackground", "[", "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FGetBackground", "[", "]"}], ":=", 
  RowBox[{"FPGetBackground", "[", "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FSetBackground", "[", 
   RowBox[{"bg", ":", 
    RowBox[{"{", 
     RowBox[{"Repeated", "[", 
      RowBox[{
       RowBox[{"_", "?", "NumberQ"}], ",", "FNumberOfRoutes"}], "]"}], 
     "}"}]}], "]"}], ":=", 
  RowBox[{"FPSetBackground", "[", 
   RowBox[{"N", "/@", 
    RowBox[{"FExpandRoutelist", "@", "bg"}]}], "]"}]}]}], "Code",ExpressionUUI\
D->"64c0f068-1db9-41b0-8bbf-ae1f692743eb"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FGetPIEBackground", "[", "]"}], ":=", 
  RowBox[{"FPGetPIEBackground", "[", "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FSetPIEBackground", "[", 
   RowBox[{"bg", ":", 
    RowBox[{"{", 
     RowBox[{"Repeated", "[", 
      RowBox[{
       RowBox[{"_", "?", "NumberQ"}], ",", "FNumberOfRoutes"}], "]"}], 
     "}"}]}], "]"}], ":=", 
  RowBox[{"FPSetPIEBackground", "[", 
   RowBox[{"N", "/@", 
    RowBox[{"FExpandRoutelist", "@", "bg"}]}], "]"}]}]}], "Code",ExpressionUUI\
D->"d2d65750-398c-412b-8e2e-1dd12a6ccaa9"]
}, Closed]],

Cell[CellGroupData[{

Cell["Burst parameter extraction, selection and visualisation", \
"Subsubsection",
 CellChangeTimes->{
  3.82757535946984*^9},ExpressionUUID->"dfd9f3c9-ef33-4010-8060-cbb825c0288c"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "FGetFromBurstList", "]"}], "=", 
    RowBox[{"{", 
     RowBox[{"FBurstData", "->", "All"}], "}"}]}], ";"}], "\n", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"SetAttributes", "[", 
     RowBox[{"FGetFromBurstList", ",", "HoldFirst"}], "]"}], ";"}], 
   "*)"}]}], "\n", 
 RowBox[{
  RowBox[{"FGetFromBurstList", "[", 
   RowBox[{"param_String", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", "\n", 
  RowBox[{"Which", "[", "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"OptionValue", "[", "FBurstData", "]"}], "===", "All"}], ",", 
    RowBox[{"FPGetFromBurstList", "[", "param", "]"}], "\n", ",", 
    RowBox[{
     RowBox[{"OptionValue", "[", "FBurstData", "]"}], "===", 
     "FSelectedBursts"}], ",", 
    RowBox[{"FPGetSelectedFromBurstList", "[", "param", "]"}], "\n", ",", 
    "True", ",", 
    RowBox[{"{", "}"}]}], "\n", "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FGetFromBurstList", "[", 
   RowBox[{"expr_", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"ReleaseHold", "[", 
   RowBox[{"expr", "/.", 
    RowBox[{"param_String", ":>", "  ", 
     RowBox[{"FGetFromBurstList", "[", 
      RowBox[{"param", ",", "opts"}], "]"}]}]}], "]"}]}], "\n"}], "Input",
 CellChangeTimes->{{3.8275516324083643`*^9, 3.8275516953102193`*^9}, {
  3.827574300653064*^9, 3.827574323310442*^9}, {3.827575620495837*^9, 
  3.8275756620737915`*^9}, {3.8275758974947104`*^9, 3.8275759234582305`*^9}, {
  3.8275759575085516`*^9, 
  3.827575988823409*^9}},ExpressionUUID->"ba171a15-4093-4d88-a828-\
e375e854ad82"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"FGetFromBurst", ",", "HoldFirst"}], "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FGetFromBurst", "[", 
    RowBox[{"param_String", ",", "burstindex_Integer"}], "]"}], ":=", 
   RowBox[{"If", "[", 
    RowBox[{
     RowBox[{"1", "<=", "burstindex", "<=", 
      RowBox[{"FGetBurstListSize", "[", "]"}]}], ",", 
     RowBox[{"FPGetFromBurst", "[", 
      RowBox[{"param", ",", 
       RowBox[{"burstindex", "-", "1"}]}], "]"}], ",", "Null"}], "]"}]}], 
  "\n"}], "\n", 
 RowBox[{
  RowBox[{"FGetFromBurst", "[", 
   RowBox[{"expr_", ",", "burstindex_Integer"}], "]"}], ":=", 
  RowBox[{"ReleaseHold", "[", 
   RowBox[{"expr", "/.", 
    RowBox[{"param_String", ":>", "  ", 
     RowBox[{"FGetFromBurst", "[", 
      RowBox[{"param", ",", "burstindex"}], "]"}]}]}], 
   "]"}]}], "\n"}], "Input",
 CellChangeTimes->{{3.8275517334059954`*^9, 3.8275517940025544`*^9}, 
   3.8275744544202747`*^9, {3.827576673212394*^9, 
   3.8275766834968967`*^9}},ExpressionUUID->"38ad409e-e6b7-47a9-8ced-\
d1055e94351d"],

Cell[BoxData[
 RowBox[{"\n", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"Options", "[", "FParamHisto", "]"}], "=", 
     RowBox[{"Join", "[", 
      RowBox[{
       RowBox[{"Options", "[", "Histo", "]"}], ",", 
       RowBox[{"Options", "[", "FGetFromBurstList", "]"}]}], "]"}]}], ";"}], 
   "\n", 
   RowBox[{
    RowBox[{"FParamHisto", "[", 
     RowBox[{"param_", ",", 
      RowBox[{"{", 
       RowBox[{"min1_", ",", "max1_", ",", "d1_"}], "}"}], ",", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{"Histo", "[", 
     RowBox[{
      RowBox[{"FGetFromBurstList", "[", 
       RowBox[{"param", ",", 
        RowBox[{"FilterRules", "[", 
         RowBox[{
          RowBox[{"{", "opts", "}"}], ",", " ", 
          RowBox[{"Options", "[", "FGetFromBurstList", "]"}]}], "]"}]}], 
       "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"min1", ",", "max1", ",", "d1"}], "}"}], ",", 
      RowBox[{"FilterRules", "[", 
       RowBox[{
        RowBox[{"{", "opts", "}"}], ",", " ", 
        RowBox[{"Options", "[", "Histo", "]"}]}], "]"}], ",", 
      RowBox[{"FrameLabel", "->", 
       RowBox[{"{", 
        RowBox[{"param", ",", "\"\<Number of bursts\>\""}], "}"}]}]}], 
     "]"}]}]}]}]], "Input",
 CellChangeTimes->{{3.8275541557784553`*^9, 3.827554164978547*^9}, 
   3.8275767063072166`*^9},ExpressionUUID->"b3e30207-a1a0-410c-8f02-\
e6bda300a9b8"],

Cell[BoxData[
 RowBox[{"\n", 
  RowBox[{
   RowBox[{"FParamHisto2D", "[", 
    RowBox[{"param1_", ",", "param2_", ",", 
     RowBox[{"{", 
      RowBox[{"min1_", ",", "max1_", ",", "d1_"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"min2_", ",", "max2_", ",", "d2_"}], "}"}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Histo2D", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"FGetFromBurstList", "[", 
         RowBox[{"param1", ",", 
          RowBox[{"FilterRules", "[", 
           RowBox[{
            RowBox[{"{", "opts", "}"}], ",", " ", 
            RowBox[{"Options", "[", "FGetFromBurstList", "]"}]}], "]"}]}], 
         "]"}], ",", 
        RowBox[{"FGetFromBurstList", "[", 
         RowBox[{"param2", ",", 
          RowBox[{"FilterRules", "[", 
           RowBox[{
            RowBox[{"{", "opts", "}"}], ",", " ", 
            RowBox[{"Options", "[", "FGetFromBurstList", "]"}]}], "]"}]}], 
         "]"}]}], "}"}], "\[Transpose]"}], ",", 
     RowBox[{"{", 
      RowBox[{"min1", ",", "max1", ",", "d1"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"min2", ",", "max2", ",", "d2"}], "}"}], ",", 
     RowBox[{"FilterRules", "[", 
      RowBox[{
       RowBox[{"{", "opts", "}"}], ",", " ", 
       RowBox[{"Options", "[", "Histo2D", "]"}]}], "]"}], ",", 
     RowBox[{"FrameLabel", "->", 
      RowBox[{"{", 
       RowBox[{"param1", ",", "param2"}], "}"}]}]}], "]"}]}]}]], "Input",
 CellChangeTimes->{{3.827554213491406*^9, 3.8275542351551604`*^9}, 
   3.8275551640766454`*^9, 
   3.8275767127029543`*^9},ExpressionUUID->"3a1d042a-1bde-4521-a2fa-\
4ce57eb76415"],

Cell[BoxData[
 RowBox[{"(*", "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"SetAttributes", "[", 
     RowBox[{"FSelectBursts", ",", "HoldFirst"}], "]"}], "\n", 
    RowBox[{"FSelectBursts", "[", 
     RowBox[{"paramlist_List", ",", "crit_"}], "]"}]}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"bl", ",", "sel"}], "}"}], ",", "\n", 
     RowBox[{
      RowBox[{"bl", "=", 
       RowBox[{
        RowBox[{"FGetFromBurstList", "[", 
         RowBox[{"paramlist", ",", 
          RowBox[{"FBurstData", "->", "All"}]}], "]"}], "\[Transpose]"}]}], 
      ";", "\n", 
      RowBox[{"sel", "=", 
       RowBox[{
        RowBox[{"Map", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"TrueQ", "[", 
            RowBox[{"crit", "[", "#", "]"}], "]"}], "&"}], ",", "bl"}], "]"}],
         "/.", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"True", "->", "1"}], ",", 
          RowBox[{"False", "->", "0"}]}], "}"}]}]}], ";", "\n", 
      RowBox[{"MapIndexed", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"FPSelectBurst", "[", 
          RowBox[{
           RowBox[{"#2", "[", 
            RowBox[{"[", "1", "]"}], "]"}], ",", "#1"}], "]"}], "&"}], ",", 
        "sel"}], "]"}], ";"}]}], "\n", "]"}]}], "\[IndentingNewLine]", 
  "*)"}]], "Input",
 CellChangeTimes->{{3.8275543623526177`*^9, 3.8275543711966825`*^9}, {
  3.82755462008955*^9, 
  3.827554626862079*^9}},ExpressionUUID->"e59d199e-0728-4f94-ab2c-\
350ae66de1cc"],

Cell[BoxData[
 RowBox[{"\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"FSelectBursts", "[", 
    RowBox[{"paramlist_List", ",", "crit_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"bl", ",", "sel"}], "}"}], ",", "\n", 
     RowBox[{
      RowBox[{"bl", "=", 
       RowBox[{
        RowBox[{"FGetFromBurstList", "[", 
         RowBox[{"paramlist", ",", 
          RowBox[{"FBurstData", "->", "All"}]}], "]"}], "\[Transpose]"}]}], 
      ";", "\n", 
      RowBox[{"sel", "=", 
       RowBox[{
        RowBox[{"Map", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"TrueQ", "[", 
            RowBox[{"crit", "[", "#", "]"}], "]"}], "&"}], ",", "bl"}], "]"}],
         "/.", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"True", "->", "1"}], ",", 
          RowBox[{"False", "->", "0"}]}], "}"}]}]}], ";", "\n", 
      RowBox[{"FPSelectBursts", "[", "sel", "]"}]}]}], "\n", 
    "]"}]}]}]], "Input",
 CellChangeTimes->{{3.778839645869129*^9, 3.778839663100069*^9}, {
   3.827554632869675*^9, 3.8275546343802156`*^9}, 
   3.8275767205079536`*^9},ExpressionUUID->"eea74870-afdd-4261-83a4-\
39b6ee89f119"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FSelectBurst", "[", 
   RowBox[{"index_Integer", ",", "val_Integer"}], "]"}], ":=", 
  RowBox[{"FPSelectBurst", "[", 
   RowBox[{"index", ",", "val"}], "]"}]}]], "Code",ExpressionUUID->"255e70d1-\
285a-4767-bac0-b5dbe351309e"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FGetPhotonList", "[", 
   RowBox[{
    RowBox[{"t1_", "?", "NumberQ"}], ",", 
    RowBox[{"t2_", "?", "NumberQ"}]}], "]"}], ":=", 
  RowBox[{"FGetPhotonInformation", "[", 
   RowBox[{
    RowBox[{"N", "@", "t1"}], ",", 
    RowBox[{"N", "@", "t2"}]}], "]"}]}]], "Code",ExpressionUUID->"c205e4b3-\
b633-4fc4-8712-37faccbdd5f3"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FBurstPhotonExport", "[", "filename_String", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "fn", "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"fn", "=", 
      RowBox[{"StringReplace", "[", 
       RowBox[{
        RowBox[{"ExpandFileName", "[", "filename", "]"}], ",", 
        RowBox[{"\"\<\\\\\>\"", "->", "\"\</\>\""}]}], "]"}]}], ";", "\n", 
     RowBox[{"FBurstPhotonExportP", "[", "fn", "]"}]}]}], "\n", 
   "]"}]}]], "Code",ExpressionUUID->"9285795e-0686-49e1-9bab-f8b615a32693"]
}, Closed]],

Cell[CellGroupData[{

Cell["FRET histogram fitting", "Subsubsection",ExpressionUUID->"a33f7e8c-ecaa-4bca-b9a3-c92051c7d2ca"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FLogNormal", "[", 
   RowBox[{"e_", ",", "pos_", ",", "ampl_", ",", "width_", ",", "asym_"}], 
   "]"}], ":=", 
  RowBox[{"Piecewise", "[", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{
        RowBox[{"Abs", "[", "ampl", "]"}], " ", 
        RowBox[{"2", "^", 
         RowBox[{"(", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{
              RowBox[{"Log", "[", 
               RowBox[{"1", "+", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"asym", "^", "2"}], "-", "1"}], ")"}], 
                   RowBox[{"(", 
                    RowBox[{"e", "-", "pos"}], ")"}]}], ")"}], "/", 
                 RowBox[{"(", 
                  RowBox[{"asym", " ", "width"}], ")"}]}]}], "]"}], "^", 
              "2"}], "/", 
             RowBox[{
              RowBox[{"Log", "[", "asym", "]"}], "^", "2"}]}], ")"}]}], 
          ")"}]}]}], ",", 
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             RowBox[{"asym", "^", "2"}], "-", "1"}], ")"}], " ", 
           RowBox[{"(", 
            RowBox[{"e", "-", "pos"}], ")"}]}], ")"}], "/", 
         RowBox[{"(", 
          RowBox[{"asym", " ", "width"}], ")"}]}], ">", 
        RowBox[{"-", "1"}]}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"0", ",", 
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             RowBox[{"asym", "^", "2"}], "-", "1"}], ")"}], " ", 
           RowBox[{"(", 
            RowBox[{"e", "-", "pos"}], ")"}]}], ")"}], "/", 
         RowBox[{"(", 
          RowBox[{"asym", " ", "width"}], ")"}]}], "<=", 
        RowBox[{"-", "1"}]}]}], "}"}]}], "}"}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FGaussian", "[", 
   RowBox[{"e_", ",", "pos_", ",", "ampl_", ",", "width_"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"Abs", "[", "ampl", "]"}], " ", 
   RowBox[{"Exp", "[", 
    RowBox[{"-", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{
        RowBox[{"(", 
         RowBox[{"e", "-", "pos"}], ")"}], "^", "2"}], "/", 
       RowBox[{"(", 
        RowBox[{"2", " ", 
         RowBox[{"width", "^", "2"}]}], ")"}]}], ")"}]}], "]"}]}]}]}], "Input",\
ExpressionUUID->"6d49cd1a-8636-486b-ba84-5baf6433cd53"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FLogNormal", "[", 
   RowBox[{"pos_", ",", "ampl_", ",", "width_", ",", "asym_"}], "]"}], ":=", 
  RowBox[{"Function", "[", 
   RowBox[{
    RowBox[{"{", "Global`e", "}"}], ",", 
    RowBox[{"FLogNormal", "[", 
     RowBox[{"Global`e", ",", "pos", ",", "ampl", ",", "width", ",", "asym"}],
      "]"}]}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FGaussian", "[", 
   RowBox[{"pos_", ",", "ampl_", ",", "width_"}], "]"}], ":=", 
  RowBox[{"Function", "[", 
   RowBox[{
    RowBox[{"{", "Global`e", "}"}], ",", 
    RowBox[{"FGaussian", "[", 
     RowBox[{"Global`e", ",", "pos", ",", "ampl", ",", "width"}], "]"}]}], 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.859963352988145*^9, 3.8599633573442864`*^9}, {
  3.859965529830814*^9, 3.859965543166936*^9}, {3.8599655847822046`*^9, 
  3.859965588799481*^9}, {3.8599656942414026`*^9, 3.8599656981351633`*^9}, {
  3.859967563070668*^9, 3.859967634364259*^9}, {3.859968050657754*^9, 
  3.8599681128518276`*^9}},ExpressionUUID->"7c1828bc-8e94-4f83-a4e3-\
18cf51eb215e"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"FMakeFRETPeakModel", "[", 
    RowBox[{"peaks", ":", 
     RowBox[{"{", 
      RowBox[{"Repeated", "[", 
       RowBox[{"\"\<G\>\"", "|", "\"\<L\>\""}], "]"}], "}"}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "modelrules", ",", "paramrules", ",", "varrules", ",", "pos", ",", 
       "ampl", ",", "width", ",", "asym"}], "}"}], ",", 
     RowBox[{
      RowBox[{"modelrules", "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"\"\<G\>\"", "->", 
          RowBox[{"FGaussian", "[", 
           RowBox[{"pos", ",", "ampl", ",", "width"}], "]"}]}], ",", 
         RowBox[{"\"\<L\>\"", "->", 
          RowBox[{"FLogNormal", "[", 
           RowBox[{"pos", ",", "ampl", ",", "width", ",", "asym"}], "]"}]}]}],
         "}"}]}], ";", 
      RowBox[{"paramrules", "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"\"\<G\>\"", "->", 
          RowBox[{"List", "[", 
           RowBox[{"pos", ",", "ampl", ",", "width"}], "]"}]}], ",", 
         RowBox[{"\"\<L\>\"", "->", 
          RowBox[{"List", "[", 
           RowBox[{"pos", ",", "ampl", ",", "width", ",", "asym"}], "]"}]}]}],
         "}"}]}], ";", 
      RowBox[{
       RowBox[{"varrules", "[", "i_", "]"}], ":=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"pos", "->", 
          RowBox[{"Pos", "[", "i", "]"}]}], ",", 
         RowBox[{"ampl", "->", 
          RowBox[{"Ampl", "[", "i", "]"}]}], ",", 
         RowBox[{"width", "->", 
          RowBox[{"Width", "[", "i", "]"}]}], ",", 
         RowBox[{"asym", "->", 
          RowBox[{"Asym", "[", "i", "]"}]}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"MapIndexed", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"(", 
             RowBox[{"#1", "/.", "modelrules"}], ")"}], "/.", 
            RowBox[{"varrules", "[", 
             RowBox[{"#2", "[", 
              RowBox[{"[", "1", "]"}], "]"}], "]"}]}], "&"}], ",", "peaks"}], 
         "]"}], ",", 
        RowBox[{"MapIndexed", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"(", 
             RowBox[{"#1", "/.", "paramrules"}], ")"}], "/.", 
            RowBox[{"varrules", "[", 
             RowBox[{"#2", "[", 
              RowBox[{"[", "1", "]"}], "]"}], "]"}]}], "&"}], ",", "peaks"}], 
         "]"}]}], "}"}]}]}], "\n", "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{"FMakeFRETPeakModel", "[", 
   RowBox[{
    RowBox[{"peaks", ":", 
     RowBox[{"{", 
      RowBox[{"Repeated", "[", 
       RowBox[{"\"\<G\>\"", "|", "\"\<L\>\""}], "]"}], "}"}]}], ",", 
    "numberofmodels_Integer"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"model", ",", "var", ",", "j"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"model", "=", 
      RowBox[{"FMakeFRETPeakModel", "[", "peaks", "]"}]}], ";", 
     RowBox[{"model", "=", 
      RowBox[{
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"model", "/.", 
          RowBox[{
           RowBox[{"var_Symbol", "[", "j_Integer", "]"}], "->", 
           RowBox[{"var", "[", 
            RowBox[{"i", ",", "j"}], "]"}]}]}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "numberofmodels"}], "}"}]}], "]"}], 
       "\[Transpose]"}]}], ";", 
     RowBox[{
      RowBox[{"model", "[", 
       RowBox[{"[", "2", "]"}], "]"}], "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{"model", "[", 
        RowBox[{"[", "2", "]"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     "model"}]}], "\n", "]"}]}]}], "Input",
 CellChangeTimes->{{3.7489263894981613`*^9, 3.748926442663517*^9}, {
   3.7489265924756675`*^9, 3.748926614304246*^9}, 3.7489266680036287`*^9, {
   3.7489285545997524`*^9, 3.748928555469579*^9}, 3.7489286185979586`*^9, {
   3.8595318775645638`*^9, 3.859531910524623*^9}, {3.8598798832504063`*^9, 
   3.859879886800126*^9}, {3.8599564557386827`*^9, 3.8599565308262424`*^9}, {
   3.8599567846384935`*^9, 3.859956801093506*^9}, {3.8599573662721395`*^9, 
   3.8599573801268425`*^9}, {3.859963251415978*^9, 3.859963262888482*^9}, {
   3.8599657130237436`*^9, 3.859965718744966*^9}, {3.859973687794917*^9, 
   3.8599737003469477`*^9}},ExpressionUUID->"2fcf7ccc-573e-4297-bd06-\
759753fca825"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FMakeFRETPeakModel", "[", 
   RowBox[{
    RowBox[{"peaks", ":", 
     RowBox[{"{", 
      RowBox[{"Repeated", "[", 
       RowBox[{"\"\<G\>\"", "|", "\"\<L\>\""}], "]"}], "}"}]}], ",", 
    "numberofmodels_", ",", 
    RowBox[{"globalparams", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_Symbol", "[", "_Integer", "]"}], ".."}], "}"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"model", ",", "rules"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"model", "=", 
      RowBox[{"FMakeFRETPeakModel", "[", 
       RowBox[{"peaks", ",", "numberofmodels"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"rules", "=", 
      RowBox[{"Map", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"#", "[", 
             RowBox[{"[", "0", "]"}], "]"}], "[", 
            RowBox[{"i_", ",", 
             RowBox[{"#", "[", 
              RowBox[{"[", "1", "]"}], "]"}]}], "]"}], "->", "#"}], ")"}], 
         "&"}], ",", "globalparams"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"model", "=", 
      RowBox[{"model", "/.", "rules"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"model", "[", 
       RowBox[{"[", "2", "]"}], "]"}], "=", 
      RowBox[{"DeleteDuplicates", "[", 
       RowBox[{"model", "[", 
        RowBox[{"[", "2", "]"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     "model"}]}], "\n", "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FMakeFRETPeakModel", "[", 
   RowBox[{
    RowBox[{"peaks", ":", 
     RowBox[{"{", 
      RowBox[{"Repeated", "[", 
       RowBox[{"\"\<G\>\"", "|", "\"\<L\>\""}], "]"}], "}"}]}], ",", 
    "numberofmodels_", ",", 
    RowBox[{"{", "}"}]}], "]"}], ":=", 
  RowBox[{"FMakeFRETPeakModel", "[", 
   RowBox[{"peaks", ",", "numberofmodels"}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.859956863103089*^9, 3.8599569083205857`*^9}, {
  3.8599632648443255`*^9, 
  3.8599632721589365`*^9}},ExpressionUUID->"dd69b5ab-dafc-44b4-9d90-\
08485fa057bb"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"FMakeModel", "[", 
    RowBox[{"peaks", ":", 
     RowBox[{"{", 
      RowBox[{"Repeated", "[", 
       RowBox[{"\"\<G\>\"", "|", "\"\<L\>\""}], "]"}], "}"}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "modelrules", ",", "paramrules", ",", "varrules", ",", "pos", ",", 
       "ampl", ",", "width", ",", "asym"}], "}"}], ",", 
     RowBox[{
      RowBox[{"modelrules", "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"\"\<G\>\"", "->", 
          RowBox[{"FGaussian", "[", 
           RowBox[{"Global`e", ",", "pos", ",", "ampl", ",", "width"}], 
           "]"}]}], ",", 
         RowBox[{"\"\<L\>\"", "->", 
          RowBox[{"FLogNormal", "[", 
           RowBox[{
           "Global`e", ",", "pos", ",", "ampl", ",", "width", ",", "asym"}], 
           "]"}]}]}], "}"}]}], ";", 
      RowBox[{"paramrules", "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"\"\<G\>\"", "->", 
          RowBox[{"List", "[", 
           RowBox[{"pos", ",", "ampl", ",", "width"}], "]"}]}], ",", 
         RowBox[{"\"\<L\>\"", "->", 
          RowBox[{"List", "[", 
           RowBox[{"pos", ",", "ampl", ",", "width", ",", "asym"}], "]"}]}]}],
         "}"}]}], ";", 
      RowBox[{
       RowBox[{"varrules", "[", "i_", "]"}], ":=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"pos", "->", 
          RowBox[{"Pos", "[", "i", "]"}]}], ",", 
         RowBox[{"ampl", "->", 
          RowBox[{"Ampl", "[", "i", "]"}]}], ",", 
         RowBox[{"width", "->", 
          RowBox[{"Width", "[", "i", "]"}]}], ",", 
         RowBox[{"asym", "->", 
          RowBox[{"Asym", "[", "i", "]"}]}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"MapIndexed", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"(", 
             RowBox[{"#1", "/.", "modelrules"}], ")"}], "/.", 
            RowBox[{"varrules", "[", 
             RowBox[{"#2", "[", 
              RowBox[{"[", "1", "]"}], "]"}], "]"}]}], "&"}], ",", "peaks"}], 
         "]"}], ",", 
        RowBox[{"MapIndexed", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"(", 
             RowBox[{"#1", "/.", "paramrules"}], ")"}], "/.", 
            RowBox[{"varrules", "[", 
             RowBox[{"#2", "[", 
              RowBox[{"[", "1", "]"}], "]"}], "]"}]}], "&"}], ",", "peaks"}], 
         "]"}]}], "}"}]}]}], "\n", "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{"FMakeModel", "[", 
   RowBox[{
    RowBox[{"peaks", ":", 
     RowBox[{"{", 
      RowBox[{"Repeated", "[", 
       RowBox[{"\"\<G\>\"", "|", "\"\<L\>\""}], "]"}], "}"}]}], ",", 
    "numberofmodels_Integer"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "model", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"model", "=", 
      RowBox[{"FMakeModel", "[", "peaks", "]"}]}], ";", 
     RowBox[{"model", "=", 
      RowBox[{
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"model", "/.", 
          RowBox[{
           RowBox[{"var_Symbol", "[", "j_Integer", "]"}], "->", 
           RowBox[{"var", "[", 
            RowBox[{"i", ",", "j"}], "]"}]}]}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "numberofmodels"}], "}"}]}], "]"}], 
       "\[Transpose]"}]}], ";", 
     RowBox[{
      RowBox[{"model", "[", 
       RowBox[{"[", "2", "]"}], "]"}], "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{"model", "[", 
        RowBox[{"[", "2", "]"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     "model"}]}], "\n", "]"}]}]}], "Input",
 CellChangeTimes->{{3.7489263894981613`*^9, 3.748926442663517*^9}, {
   3.7489265924756675`*^9, 3.748926614304246*^9}, 3.7489266680036287`*^9, {
   3.7489285545997524`*^9, 3.748928555469579*^9}, 3.7489286185979586`*^9, {
   3.8595318775645638`*^9, 3.859531910524623*^9}, {3.8598798832504063`*^9, 
   3.859879886800126*^9}, {3.8599564557386827`*^9, 3.8599565308262424`*^9}, {
   3.8599567846384935`*^9, 3.859956801093506*^9}, {3.8599573662721395`*^9, 
   3.8599573801268425`*^9}},ExpressionUUID->"f83d90c6-73cb-49ef-9dab-\
f93c4e2687cf"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FMakeModel", "[", 
   RowBox[{
    RowBox[{"peaks", ":", 
     RowBox[{"{", 
      RowBox[{"Repeated", "[", 
       RowBox[{"\"\<G\>\"", "|", "\"\<L\>\""}], "]"}], "}"}]}], ",", 
    "numberofmodels_", ",", 
    RowBox[{"globalparams", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_Symbol", "[", "_Integer", "]"}], ".."}], "}"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"model", ",", "rules"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"model", "=", 
      RowBox[{"FMakeModel", "[", 
       RowBox[{"peaks", ",", "numberofmodels"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"rules", "=", 
      RowBox[{"Map", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"#", "[", 
             RowBox[{"[", "0", "]"}], "]"}], "[", 
            RowBox[{"i_", ",", 
             RowBox[{"#", "[", 
              RowBox[{"[", "1", "]"}], "]"}]}], "]"}], "->", "#"}], ")"}], 
         "&"}], ",", "globalparams"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"model", "=", 
      RowBox[{"model", "/.", "rules"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"model", "[", 
       RowBox[{"[", "2", "]"}], "]"}], "=", 
      RowBox[{"DeleteDuplicates", "[", 
       RowBox[{"model", "[", 
        RowBox[{"[", "2", "]"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     "model"}]}], "\n", "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FMakeModel", "[", 
   RowBox[{
    RowBox[{"peaks", ":", 
     RowBox[{"{", 
      RowBox[{"Repeated", "[", 
       RowBox[{"\"\<G\>\"", "|", "\"\<L\>\""}], "]"}], "}"}]}], ",", 
    "numberofmodels_", ",", 
    RowBox[{"{", "}"}]}], "]"}], ":=", 
  RowBox[{"FMakeModel", "[", 
   RowBox[{"peaks", ",", "numberofmodels"}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.859956863103089*^9, 
  3.8599569083205857`*^9}},ExpressionUUID->"49d3c036-891d-43c0-bfa0-\
b28a67a62200"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FFindGuess", "[", 
   RowBox[{
    RowBox[{"dat", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumberQ"}], ",", 
         RowBox[{"_", "?", "NumberQ"}], ",", "___"}], "}"}], ".."}], "}"}]}], 
    ",", 
    RowBox[{"peaks", ":", 
     RowBox[{"{", 
      RowBox[{"Repeated", "[", 
       RowBox[{"\"\<G\>\"", "|", "\"\<L\>\""}], "]"}], "}"}]}], ",", 
    RowBox[{"peakpos", ":", 
     RowBox[{"{", 
      RowBox[{"Repeated", "[", 
       RowBox[{
        RowBox[{"_", "?", "NumberQ"}], "|", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumberQ"}], ",", 
          RowBox[{"_", "?", "NumberQ"}]}], "}"}]}], "]"}], "}"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"paramlist", ",", "tmpdat", ",", "GetPos", ",", "GetAmpl"}], 
     "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"paramlist", "=", 
      RowBox[{
       RowBox[{"FMakeFRETPeakModel", "[", "peaks", "]"}], "[", 
       RowBox[{"[", "2", "]"}], "]"}]}], ";", "\n", 
     RowBox[{
      RowBox[{"GetPos", "[", "i_", "]"}], ":=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"NumberQ", "[", 
         RowBox[{"peakpos", "[", 
          RowBox[{"[", "i", "]"}], "]"}], "]"}], ",", 
        RowBox[{"peakpos", "[", 
         RowBox[{"[", "i", "]"}], "]"}], ",", "\n", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"tmpdat", "=", 
           RowBox[{"Select", "[", 
            RowBox[{"dat", ",", 
             RowBox[{
              RowBox[{"IntervalMemberQ", "[", 
               RowBox[{
                RowBox[{"Interval", "[", 
                 RowBox[{"peakpos", "[", 
                  RowBox[{"[", "i", "]"}], "]"}], "]"}], ",", " ", 
                RowBox[{"#", "[", 
                 RowBox[{"[", "1", "]"}], "]"}]}], "]"}], "&"}]}], "]"}]}], 
          ";", 
          RowBox[{
           RowBox[{"Select", "[", 
            RowBox[{"dat", ",", 
             RowBox[{
              RowBox[{
               RowBox[{"#", "[", 
                RowBox[{"[", "2", "]"}], "]"}], "==", 
               RowBox[{"Max", "[", 
                RowBox[{"tmpdat", "[", 
                 RowBox[{"[", 
                  RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}]}], "&"}]}], 
            "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "1"}], "]"}], "]"}]}], ")"}]}], "]"}]}], ";", 
     RowBox[{
      RowBox[{"GetAmpl", "[", "i_", "]"}], ":=", 
      RowBox[{
       RowBox[{"Select", "[", 
        RowBox[{"dat", ",", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"Nearest", "[", 
             RowBox[{
              RowBox[{"dat", "[", 
               RowBox[{"[", 
                RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", 
              RowBox[{"GetPos", "[", "i", "]"}]}], "]"}], "[", 
            RowBox[{"[", "1", "]"}], "]"}], "==", 
           RowBox[{"#", "[", 
            RowBox[{"[", "1", "]"}], "]"}]}], "&"}]}], "]"}], "[", 
       RowBox[{"[", 
        RowBox[{"1", ",", "2"}], "]"}], "]"}]}], ";", 
     RowBox[{"Flatten", "[", 
      RowBox[{
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"{", 
            RowBox[{"#", ",", 
             RowBox[{"#", "/.", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{
                 RowBox[{"Pos", "[", "i_", "]"}], ":>", " ", 
                 RowBox[{"GetPos", "[", "i", "]"}]}], ",", 
                RowBox[{
                 RowBox[{"Ampl", "[", "i_", "]"}], ":>", " ", 
                 RowBox[{"GetAmpl", "[", "i", "]"}]}], ",", 
                RowBox[{
                 RowBox[{"Width", "[", "i_", "]"}], "->", "0.12"}], ",", 
                RowBox[{
                 RowBox[{"Asym", "[", "i_", "]"}], "->", "0.9"}]}], "}"}]}]}],
             "}"}], "\[Transpose]"}], "&"}], ",", "paramlist"}], "]"}], ",", 
       "1"}], "]"}]}]}], "\n", "]"}]}]], "Input",
 CellChangeTimes->{{3.7489269870057464`*^9, 3.7489270068261805`*^9}, {
  3.8599683336479864`*^9, 
  3.85996834806855*^9}},ExpressionUUID->"31ea8635-6265-4a93-9972-\
ae5418307d65"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FFindGuess", "[", 
   RowBox[{
    RowBox[{"dat", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumberQ"}], ",", 
           RowBox[{"_", "?", "NumberQ"}], ",", "___"}], "}"}], ".."}], "}"}], 
       ".."}], "}"}]}], ",", 
    RowBox[{"peaks", ":", 
     RowBox[{"{", 
      RowBox[{"Repeated", "[", 
       RowBox[{"\"\<G\>\"", "|", "\"\<L\>\""}], "]"}], "}"}]}], ",", 
    RowBox[{"peakpos", ":", 
     RowBox[{"{", 
      RowBox[{"Repeated", "[", 
       RowBox[{
        RowBox[{"_", "?", "NumberQ"}], "|", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumberQ"}], ",", 
          RowBox[{"_", "?", "NumberQ"}]}], "}"}]}], "]"}], "}"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"paramlist", ",", "guess"}], "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"paramlist", "=", 
      RowBox[{
       RowBox[{"FMakeFRETPeakModel", "[", 
        RowBox[{"peaks", ",", 
         RowBox[{"Length", "[", "dat", "]"}]}], "]"}], "[", 
       RowBox[{"[", "2", "]"}], "]"}]}], ";", "\n", 
     RowBox[{"guess", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{"Map", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"FFindGuess", "[", 
            RowBox[{"#", ",", "peaks", ",", "peakpos"}], "]"}], "&"}], ",", 
          "dat"}], "]"}], ",", "1"}], "]"}]}], ";", "\n", 
     RowBox[{
      RowBox[{"guess", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "1"}], "]"}], "]"}], "=", "paramlist"}], ";", 
     "\n", "guess"}]}], "\n", "]"}]}]], "Input",
 CellChangeTimes->{
  3.859968362645575*^9},ExpressionUUID->"7ae271ee-13f5-47bf-90c4-\
f976f022a296"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"FFindGuess", "[", 
    RowBox[{
     RowBox[{"dat", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumberQ"}], ",", 
            RowBox[{"_", "?", "NumberQ"}], ",", "___"}], "}"}], ".."}], "}"}],
         ".."}], "}"}]}], ",", 
     RowBox[{"peaks", ":", 
      RowBox[{"{", 
       RowBox[{"Repeated", "[", 
        RowBox[{"\"\<G\>\"", "|", "\"\<L\>\""}], "]"}], "}"}]}], ",", 
     RowBox[{"globalparams", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_Symbol", "[", "_Integer", "]"}], ".."}], "}"}]}], ",", 
     RowBox[{"peakpos", ":", 
      RowBox[{"{", 
       RowBox[{"Repeated", "[", 
        RowBox[{
         RowBox[{"_", "?", "NumberQ"}], "|", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumberQ"}], ",", 
           RowBox[{"_", "?", "NumberQ"}]}], "}"}]}], "]"}], "}"}]}]}], "]"}], 
   ":=", "\n", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"paramlist", ",", "guess", ",", "globalguess"}], "}"}], ",", 
     "\n", 
     RowBox[{
      RowBox[{"paramlist", "=", 
       RowBox[{
        RowBox[{"FMakeFRETPeakModel", "[", 
         RowBox[{"peaks", ",", 
          RowBox[{"Length", "[", "dat", "]"}], ",", "globalparams"}], "]"}], 
        "[", 
        RowBox[{"[", "2", "]"}], "]"}]}], ";", "\n", 
      RowBox[{"guess", "=", 
       RowBox[{"FFindGuess", "[", 
        RowBox[{"dat", ",", "peaks", ",", "peakpos"}], "]"}]}], ";", "\n", 
      RowBox[{"globalguess", "=", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"#", "->", 
           RowBox[{"Mean", "[", 
            RowBox[{
             RowBox[{"Cases", "[", 
              RowBox[{"guess", ",", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{
                  RowBox[{"#", "[", 
                   RowBox[{"[", "0", "]"}], "]"}], "[", 
                  RowBox[{"_Integer", ",", 
                   RowBox[{"#", "[", 
                    RowBox[{"[", "1", "]"}], "]"}]}], "]"}], ",", "_"}], 
                "}"}]}], "]"}], "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}]}], "&"}], ",", 
         "globalparams"}], "]"}]}], ";", "\n", 
      RowBox[{"guess", "=", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Rule", "@@", "#"}], "&"}], ",", "guess"}], "]"}]}], ";", 
      "\n", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"paramlist", ",", 
         RowBox[{
          RowBox[{"paramlist", "/.", "guess"}], "/.", "globalguess"}]}], 
        "}"}], "\[Transpose]"}]}]}], "\n", "]"}]}], "\n"}]], "Input",
 CellChangeTimes->{
  3.859968373561592*^9},ExpressionUUID->"83b905ba-addc-4d23-a62a-\
5be777d31f88"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FPlotFRETFit", "]"}], "=", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"FFitCurveOptions", "\[Rule]", 
       RowBox[{"{", 
        RowBox[{"PlotRange", "->", "All"}], "}"}]}], ",", 
      RowBox[{"FSubPopOptions", "\[Rule]", 
       RowBox[{"{", 
        RowBox[{"PlotRange", "->", "All"}], "}"}]}], ",", 
      RowBox[{"FFitCurveStyle", "->", 
       RowBox[{"{", 
        RowBox[{"Gray", ",", 
         RowBox[{"AbsoluteThickness", "[", "2", "]"}]}], "}"}]}], ",", 
      RowBox[{"FSubPopStyle", "->", "Automatic"}]}], "}"}], "~", "Join", "~", 
    RowBox[{"Options", "[", "Graphics", "]"}], "~", "Join", "~", 
    RowBox[{"Options", "[", "Plot", "]"}], "~", "Join", "~", 
    RowBox[{"Options", "[", "FPlotHisto", "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"FPlotFRETFit", "[", 
   RowBox[{
    RowBox[{"histodat", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumberQ"}], ",", 
         RowBox[{"_", "?", "NumberQ"}], ",", 
         RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}]}], ",", 
    RowBox[{"peaks", ":", 
     RowBox[{"{", 
      RowBox[{"Repeated", "[", 
       RowBox[{"\"\<G\>\"", "|", "\"\<L\>\""}], "]"}], "}"}]}], ",", 
    "fitresult_", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "model", ",", "pldat", ",", "plfit", ",", "plsubpop", ",", "subfunc", 
      ",", "e"}], "}"}], ",", 
    RowBox[{
     RowBox[{
      RowBox[{"model", "[", "e_", "]"}], "=", 
      RowBox[{"Through", "[", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{
           RowBox[{"FMakeFRETPeakModel", "[", "peaks", "]"}], "[", 
           RowBox[{"[", "1", "]"}], "]"}], "/.", "fitresult"}], ")"}], "[", 
        "e", "]"}], "]"}]}], ";", 
     RowBox[{"pldat", "=", 
      RowBox[{"FPlotHisto", "[", 
       RowBox[{"histodat", ",", 
        RowBox[{"FilterRules", "[", 
         RowBox[{
          RowBox[{"{", "opts", "}"}], ",", " ", 
          RowBox[{"Options", "[", "FPlotHisto", "]"}]}], "]"}], ",", 
        RowBox[{"PlotRange", "->", "All"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"plfit", "=", 
      RowBox[{"Plot", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Evaluate", "[", 
         RowBox[{"Total", "[", 
          RowBox[{"model", "[", "e", "]"}], "]"}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"e", ",", 
          RowBox[{"Min", "[", 
           RowBox[{"histodat", "[", 
            RowBox[{"[", 
             RowBox[{"All", ",", "1"}], "]"}], "]"}], "]"}], ",", 
          RowBox[{"Max", "[", 
           RowBox[{"histodat", "[", 
            RowBox[{"[", 
             RowBox[{"All", ",", "1"}], "]"}], "]"}], "]"}]}], "}"}], ",", 
        RowBox[{"Evaluate", "@", 
         RowBox[{"OptionValue", "[", "FFitCurveOptions", "]"}]}], ",", 
        RowBox[{"PlotRange", "\[Rule]", "All"}], ",", 
        RowBox[{"PlotStyle", "->", 
         RowBox[{"OptionValue", "[", "FFitCurveStyle", "]"}]}]}], 
       "\[IndentingNewLine]", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"plsubpop", "=", 
      RowBox[{"Plot", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Evaluate", "[", 
         RowBox[{"model", "[", "e", "]"}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"e", ",", 
          RowBox[{"Min", "[", 
           RowBox[{"histodat", "[", 
            RowBox[{"[", 
             RowBox[{"All", ",", "1"}], "]"}], "]"}], "]"}], ",", 
          RowBox[{"Max", "[", 
           RowBox[{"histodat", "[", 
            RowBox[{"[", 
             RowBox[{"All", ",", "1"}], "]"}], "]"}], "]"}]}], "}"}], ",", 
        RowBox[{"Evaluate", "@", 
         RowBox[{"OptionValue", "[", "FSubPopOptions", " ", "]"}]}], ",", 
        RowBox[{"PlotRange", "\[Rule]", "All"}], ",", 
        RowBox[{"PlotStyle", "->", 
         RowBox[{"OptionValue", "[", "FSubPopStyle", "]"}]}]}], 
       "\[IndentingNewLine]", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Show", "[", 
      RowBox[{"pldat", ",", "plsubpop", ",", "plfit", ",", 
       RowBox[{"FilterRules", "[", 
        RowBox[{
         RowBox[{"{", "opts", "}"}], ",", " ", 
         RowBox[{"Options", "[", "Graphics", "]"}]}], "]"}], ",", 
       RowBox[{"ImageSize", "->", "400"}], ",", 
       RowBox[{"AspectRatio", "->", 
        RowBox[{"1", "/", "2"}]}], ",", 
       RowBox[{"Axes", "->", "False"}], ",", 
       RowBox[{"Frame", "->", "True"}], ",", 
       RowBox[{"LabelStyle", "->", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"FontFamily", "->", " ", "\"\<Helvetica\>\""}], ",", 
          RowBox[{"FontSize", "->", " ", "12"}], ",", 
          RowBox[{"FontWeight", "->", " ", "Bold"}]}], "}"}]}], ",", 
       RowBox[{"FrameStyle", "->", " ", 
        RowBox[{"Directive", "[", 
         RowBox[{"Black", ",", 
          RowBox[{"AbsoluteThickness", "[", "1", "]"}]}], "]"}]}], ",", 
       RowBox[{"FrameLabel", "->", 
        RowBox[{"{", 
         RowBox[{"\"\<E\>\"", ",", 
          RowBox[{"\"\<# (total: \>\"", "<>", 
           RowBox[{"ToString", "[", 
            RowBox[{"Total", "@", 
             RowBox[{"histodat", "[", 
              RowBox[{"[", 
               RowBox[{"All", ",", "2"}], "]"}], "]"}]}], "]"}], "<>", 
           "\"\<)\>\""}]}], "}"}]}]}], "]"}]}]}], "\n", "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FPlotFRETFit", "[", 
   RowBox[{
    RowBox[{"histodat", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumberQ"}], ",", 
         RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}]}], ",", 
    RowBox[{"peaks", ":", 
     RowBox[{"{", 
      RowBox[{"Repeated", "[", 
       RowBox[{"\"\<G\>\"", "|", "\"\<L\>\""}], "]"}], "}"}]}], ",", 
    "fitresult_", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "barwidth", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"barwidth", "=", 
      RowBox[{
       RowBox[{"histodat", "[", 
        RowBox[{"[", 
         RowBox[{"2", ",", "1"}], "]"}], "]"}], "-", 
       RowBox[{"histodat", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "1"}], "]"}], "]"}]}]}], ";", 
     RowBox[{"FPlotFRETFit", "[", 
      RowBox[{
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Append", "[", 
           RowBox[{"#", ",", "barwidth"}], "]"}], "&"}], ",", "histodat"}], 
        "]"}], ",", "peaks", ",", "fitresult", ",", "opts"}], "]"}]}]}], "\n",
    "]"}]}], "\n"}], "Input",
 CellChangeTimes->{{3.7489286461698785`*^9, 3.748928653082664*^9}, {
   3.748932308852731*^9, 3.7489323172768955`*^9}, {3.7498970243340826`*^9, 
   3.749897024349042*^9}, {3.7498976023721952`*^9, 3.749897617613454*^9}, {
   3.749897731843956*^9, 3.7498977435406265`*^9}, 3.749898846349148*^9, {
   3.7498988876347284`*^9, 3.7498989379890976`*^9}, 3.749899031700856*^9, {
   3.7499004969488764`*^9, 3.749900501717123*^9}, 3.7499013941013994`*^9, 
   3.749967759618232*^9, 3.7499677921432395`*^9, {3.7499678609930964`*^9, 
   3.7499678837582073`*^9}, {3.749968039135411*^9, 3.7499680477134333`*^9}, {
   3.7525733970365496`*^9, 3.752573411966613*^9}, {3.75257351121621*^9, 
   3.7525735247804313`*^9}, {3.7525735714875345`*^9, 3.752573644928089*^9}, {
   3.7525736750784645`*^9, 3.7525736795783987`*^9}, {3.7525737169873457`*^9, 
   3.752573765421809*^9}, {3.752575178362985*^9, 3.752575186442175*^9}, {
   3.752575843921666*^9, 3.752575854918391*^9}, {3.7525760987201123`*^9, 
   3.7525761334177113`*^9}, {3.7525766797826786`*^9, 3.75257670646566*^9}, {
   3.752576951896496*^9, 3.752576985836807*^9}, 3.7525770872240715`*^9, {
   3.752577491793432*^9, 3.752577494302515*^9}, {3.752577680767113*^9, 
   3.752577683111594*^9}, {3.8599555707932205`*^9, 3.8599555939425507`*^9}, 
   3.859968390676853*^9, {3.859969244013753*^9, 3.859969300457636*^9}, {
   3.85996933432973*^9, 3.8599693356520433`*^9}, {3.859969368276764*^9, 
   3.859969458589712*^9}, {3.8599695294577684`*^9, 3.859969571763275*^9}, {
   3.859969605248066*^9, 3.8599696791018934`*^9}, {3.85997262902637*^9, 
   3.8599726295086746`*^9}},ExpressionUUID->"0375373b-2b00-49d4-bbe5-\
ed2cac089932"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FPlotFRETFit", "[", 
   RowBox[{
    RowBox[{"histodat", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumberQ"}], ",", 
           RowBox[{"_", "?", "NumberQ"}], ",", "___"}], "}"}], ".."}], "}"}], 
       ".."}], "}"}]}], ",", 
    RowBox[{"peaks", ":", 
     RowBox[{"{", 
      RowBox[{"Repeated", "[", 
       RowBox[{"\"\<G\>\"", "|", "\"\<L\>\""}], "]"}], "}"}]}], ",", 
    "fitresult_", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  "\[IndentingNewLine]", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"rule", ",", "fitresulti"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{"Table", "[", 
     RowBox[{
      RowBox[{"FPlotFRETFit", "[", 
       RowBox[{
        RowBox[{"histodat", "[", 
         RowBox[{"[", "i", "]"}], "]"}], ",", "peaks", ",", 
        RowBox[{"fitresult", "/.", 
         RowBox[{
          RowBox[{"p_Symbol", "[", 
           RowBox[{"i", ",", "j_Integer"}], "]"}], "->", 
          RowBox[{"p", "[", "j", "]"}]}]}], ",", "opts"}], "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"i", ",", 
        RowBox[{"Length", "[", "histodat", "]"}]}], "}"}]}], "]"}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.8599697915761337`*^9, 
  3.859969818136647*^9}},ExpressionUUID->"1124f70d-efd0-4695-be9c-\
522a08757d7c"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "FFitFretHistogram", "]"}], "=", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"FConstraints", "->", "None"}], ",", 
       RowBox[{"FFixParams", "->", 
        RowBox[{"{", "}"}]}]}], "}"}], "~", "Join", "~", 
     RowBox[{"Options", "[", "NonlinearModelFit", "]"}], "~", "Join", "~", 
     " ", 
     RowBox[{"Options", "[", "FPlotFRETFit", "]"}], "~", "Join", "~", " ", 
     RowBox[{"Options", "[", "FParamHisto", "]"}]}]}], ";"}], "\n"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FFitFretHistogram", "[", 
    RowBox[{
     RowBox[{"histodat", ":", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumberQ"}], ",", 
           RowBox[{"_", "?", "NumberQ"}], ",", 
           RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}], "|", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumberQ"}], ",", 
           RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}]}]}], ",", 
     RowBox[{"peaks", ":", 
      RowBox[{"{", 
       RowBox[{"Repeated", "[", 
        RowBox[{"\"\<G\>\"", "|", "\"\<L\>\""}], "]"}], "}"}]}], ",", 
     RowBox[{"guess", ":", 
      RowBox[{"{", 
       RowBox[{"Repeated", "[", 
        RowBox[{
         RowBox[{"_", "[", "_", "]"}], "|", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "[", "_", "]"}], ",", 
           RowBox[{"_", "?", "NumberQ"}]}], "}"}]}], "]"}], "}"}]}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "dat", ",", "model", ",", "fixparams", ",", "unfixedguess", ",", "nmf", 
       ",", "fitresult", ",", "subpopplstyle"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"dat", "=", 
       RowBox[{"histodat", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", 
          RowBox[{"1", ";;", "2"}]}], "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"fixparams", "=", 
       RowBox[{"OptionValue", "[", "FFixParams", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"model", "=", 
       RowBox[{"Total", "[", 
        RowBox[{"Through", "[", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            RowBox[{
             RowBox[{"FMakeFRETPeakModel", "[", "peaks", "]"}], "[", 
             RowBox[{"[", "1", "]"}], "]"}], "/.", "fixparams"}], ")"}], "[", 
          "e", "]"}], "]"}], "]"}]}], ";", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "FConstraints", "]"}], "=!=", "None"}], 
        ",", 
        RowBox[{"model", "=", 
         RowBox[{"{", 
          RowBox[{"model", ",", 
           RowBox[{"OptionValue", "[", "FConstraints", "]"}]}], "}"}]}]}], 
       "]"}], ";", 
      RowBox[{"unfixedguess", "=", 
       RowBox[{"Select", "[", 
        RowBox[{
         RowBox[{"guess", "/.", "fixparams"}], ",", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{"!", 
            RowBox[{"NumberQ", "[", 
             RowBox[{"#", "[", 
              RowBox[{"[", "1", "]"}], "]"}], "]"}]}], " ", ")"}], "&"}]}], 
        "]"}]}], ";", 
      RowBox[{"nmf", "=", 
       RowBox[{"NonlinearModelFit", "[", 
        RowBox[{"dat", ",", "model", ",", "unfixedguess", ",", "e", ",", 
         RowBox[{"FilterRules", "[", 
          RowBox[{
           RowBox[{"{", "opts", "}"}], ",", " ", 
           RowBox[{"Options", "[", "NonlinearModelFit", "]"}]}], "]"}]}], 
        "]"}]}], ";", 
      RowBox[{"fitresult", "=", 
       RowBox[{
        RowBox[{"nmf", "[", "\"\<BestFitParameters\>\"", "]"}], "~", "Join", 
        "~", "fixparams"}]}], ";", 
      RowBox[{"fitresult", "=", 
       RowBox[{"fitresult", "/.", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Ampl", "[", "i_", "]"}], "->", "x_"}], ")"}], ":>", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Ampl", "[", "i", "]"}], "->", 
           RowBox[{"Abs", "[", "x", "]"}]}], ")"}]}]}]}], ";", 
      RowBox[{"{", 
       RowBox[{"fitresult", ",", 
        RowBox[{"FPlotFRETFit", "[", 
         RowBox[{"histodat", ",", "peaks", ",", "fitresult", ",", 
          RowBox[{"FilterRules", "[", 
           RowBox[{
            RowBox[{"{", "opts", "}"}], ",", " ", 
            RowBox[{"Options", "[", "FPlotFRETFit", "]"}]}], "]"}]}], "]"}], 
        ",", "nmf"}], "}"}]}]}], "\n", "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FFitFretHistogram", "[", 
    RowBox[{
     RowBox[{"histodat", ":", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumberQ"}], ",", 
           RowBox[{"_", "?", "NumberQ"}], ",", "___"}], "}"}], ".."}], "}"}], 
       "|", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"_", "?", "NumberQ"}], ",", 
             RowBox[{"_", "?", "NumberQ"}], ",", "___"}], "}"}], ".."}], 
          "}"}], ".."}], "}"}]}]}], ",", "peaks_", ",", 
     RowBox[{"peakposguess", ":", 
      RowBox[{"{", 
       RowBox[{"Repeated", "[", 
        RowBox[{
         RowBox[{"_", "?", "NumberQ"}], "|", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumberQ"}], ",", 
           RowBox[{"_", "?", "NumberQ"}]}], "}"}]}], "]"}], "}"}]}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"FFitFretHistogram", "[", 
    RowBox[{"histodat", ",", "peaks", ",", 
     RowBox[{"FFindGuess", "[", 
      RowBox[{"histodat", ",", "peaks", ",", "peakposguess"}], "]"}], ",", 
     "opts"}], "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{"FFitFretHistogram", "[", 
   RowBox[{
    RowBox[{"Erange", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumberQ"}], ",", 
       RowBox[{"_", "?", "NumberQ"}], ",", 
       RowBox[{"_", "?", "NumberQ"}]}], "}"}]}], ",", "etc__", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"FFitFretHistogram", "[", 
   RowBox[{
    RowBox[{"FParamHisto", "[", 
     RowBox[{"\"\<E\>\"", ",", "Erange", ",", 
      RowBox[{"FOutput", "->", "FData"}], ",", 
      RowBox[{"FilterRules", "[", 
       RowBox[{
        RowBox[{"{", "opts", "}"}], ",", " ", 
        RowBox[{"Options", "[", "FParamHisto", "]"}]}], "]"}]}], "]"}], ",", 
    "etc", ",", "opts"}], "]"}]}]}], "Input",
 CellChangeTimes->{
  3.748928676814579*^9, {3.7525791133479743`*^9, 3.7525791234956474`*^9}, {
   3.752579171607046*^9, 3.7525791881617093`*^9}, {3.752579232987982*^9, 
   3.752579266832463*^9}, 3.752579322963146*^9, 3.859532028665797*^9, 
   3.8598798930586987`*^9, {3.8599698670401125`*^9, 3.859969878997798*^9}, {
   3.8599699211405153`*^9, 3.859969941095993*^9}, {3.8599699928737774`*^9, 
   3.859970040351493*^9}, {3.859970225223611*^9, 3.859970234000522*^9}, 
   3.8654910240908985`*^9},ExpressionUUID->"ed37c1e1-23c1-4a2e-a5b1-\
dffb863cbc13"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"FFitFretHistogram", "[", "expr_", "]"}], "[", 
   RowBox[{
    RowBox[{"Erange", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumberQ"}], ",", 
       RowBox[{"_", "?", "NumberQ"}], ",", 
       RowBox[{"_", "?", "NumberQ"}]}], "}"}]}], ",", "etc__", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"FFitFretHistogram", "[", 
   RowBox[{
    RowBox[{"FParamHisto", "[", 
     RowBox[{"expr", ",", "Erange", ",", 
      RowBox[{"FOutput", "->", "FData"}], ",", 
      RowBox[{"FilterRules", "[", 
       RowBox[{
        RowBox[{"{", "opts", "}"}], ",", " ", 
        RowBox[{"Options", "[", "FParamHisto", "]"}]}], "]"}]}], "]"}], ",", 
    "etc", ",", 
    RowBox[{"FrameLabel", "->", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"ToString", "[", "expr", "]"}], ",", "\"\<Events\>\""}], 
      "}"}]}], ",", "opts"}], "]"}]}]], "Input",ExpressionUUID->"d7d25d64-\
cbee-4488-a71f-ce0057af91e8"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"FFRETPeakIntegrate", "[", 
    RowBox[{
     RowBox[{"peaks", ":", 
      RowBox[{"{", 
       RowBox[{"Repeated", "[", 
        RowBox[{"\"\<G\>\"", "|", "\"\<L\>\""}], "]"}], "}"}]}], ",", 
     "fretfitresult_", ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"E1_", "?", "NumberQ"}], ",", 
       RowBox[{"E2_", "?", "NumberQ"}]}], "}"}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"globparams", ",", "numberofmodels", ",", "models"}], "}"}], 
     ",", 
     RowBox[{
      RowBox[{"globparams", "=", 
       RowBox[{
        RowBox[{"Cases", "[", 
         RowBox[{"fretfitresult", ",", 
          RowBox[{"HoldPattern", "[", 
           RowBox[{
            RowBox[{"_Symbol", "[", "_Integer", "]"}], "->", " ", "_"}], 
           "]"}]}], "]"}], "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ";", 
      RowBox[{"numberofmodels", "=", 
       RowBox[{"Max", "@@", 
        RowBox[{
         RowBox[{"Cases", "[", 
          RowBox[{"fretfitresult", ",", 
           RowBox[{"HoldPattern", "[", 
            RowBox[{
             RowBox[{"_Symbol", "[", 
              RowBox[{"_Integer", ",", "_Integer"}], "]"}], "->", " ", "_"}], 
            "]"}]}], "]"}], "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "1", ",", "1"}], "]"}], "]"}]}]}], ";", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"numberofmodels", ">", "0"}], ",", "\[IndentingNewLine]", 
        RowBox[{"(", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"models", "=", 
           RowBox[{
            RowBox[{
             RowBox[{"FMakeFRETPeakModel", "[", 
              RowBox[{"peaks", ",", "numberofmodels", ",", "globparams"}], 
              "]"}], "[", 
             RowBox[{"[", "1", "]"}], "]"}], "/.", "fretfitresult"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"Map", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"NIntegrate", "[", 
              RowBox[{
               RowBox[{"Through", "[", 
                RowBox[{"#", "[", "e", "]"}], "]"}], ",", 
               RowBox[{"{", 
                RowBox[{"e", ",", "E1", ",", "E2"}], "}"}]}], "]"}], "&"}], 
            ",", "models"}], "]"}]}], "\[IndentingNewLine]", ")"}], 
        "\[IndentingNewLine]", ",", 
        RowBox[{"NIntegrate", "[", 
         RowBox[{
          RowBox[{"Through", "[", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{
               RowBox[{"FMakeFRETPeakModel", "[", "peaks", "]"}], "[", 
               RowBox[{"[", "1", "]"}], "]"}], "/.", "fretfitresult"}], ")"}],
             "[", "e", "]"}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"e", ",", "E1", ",", "E2"}], "}"}]}], "]"}]}], "\n", 
       "]"}]}]}], "\n", "]"}]}], "\n"}]], "Input",
 CellChangeTimes->{{3.748928683465139*^9, 3.748928694162184*^9}, {
  3.8599708639810243`*^9, 3.8599709297254066`*^9}, {3.8599711209479194`*^9, 
  3.859971200055416*^9}, {3.85997158242898*^9, 3.859971622674923*^9}, {
  3.859971655836856*^9, 3.8599716972133703`*^9}, {3.8599720620350122`*^9, 
  3.859972064087365*^9}},ExpressionUUID->"a740eb6d-b2ae-4a15-82d5-\
ea0ce333ca52"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"FFitFretHistogram", "[", 
    RowBox[{
     RowBox[{"histodat", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumberQ"}], ",", 
            RowBox[{"_", "?", "NumberQ"}], ",", "___"}], "}"}], ".."}], "}"}],
         ".."}], "}"}]}], ",", 
     RowBox[{"peaks", ":", 
      RowBox[{"{", 
       RowBox[{"Repeated", "[", 
        RowBox[{"\"\<G\>\"", "|", "\"\<L\>\""}], "]"}], "}"}]}], ",", 
     RowBox[{"guess", ":", 
      RowBox[{"{", 
       RowBox[{"Repeated", "[", 
        RowBox[{
         RowBox[{"_", "[", "__", "]"}], "|", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "[", "__", "]"}], ",", 
           RowBox[{"_", "?", "NumberQ"}]}], "}"}]}], "]"}], "}"}]}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "dat", ",", "model", ",", "fixparams", ",", "unfixedguess", ",", "nmf", 
       ",", "fitresult", ",", "subpopplstyle", ",", "globparams", ",", "e"}], 
      "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"dat", "=", 
       RowBox[{"histodat", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "All", ",", 
          RowBox[{"1", ";;", "2"}]}], "]"}], "]"}]}], ";", 
      RowBox[{"globparams", "=", 
       RowBox[{"Cases", "[", 
        RowBox[{"guess", ",", 
         RowBox[{
          RowBox[{"_Symbol", "[", "_Integer", "]"}], "|", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_Symbol", "[", "_Integer", "]"}], ",", 
            RowBox[{"_", "?", "NumberQ"}]}], "}"}]}]}], "]"}]}], ";", 
      RowBox[{"globparams", "=", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"MatchQ", "[", 
             RowBox[{"#", ",", 
              RowBox[{"_Symbol", "[", "_Integer", "]"}]}], "]"}], ",", "#", 
            ",", 
            RowBox[{"#", "[", 
             RowBox[{"[", "1", "]"}], "]"}]}], "]"}], "&"}], ",", 
         "globparams"}], "]"}]}], ";", 
      RowBox[{"fixparams", "=", 
       RowBox[{"OptionValue", "[", "FFixParams", "]"}]}], ";", 
      RowBox[{"model", "=", 
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"globparams", "==", 
           RowBox[{"{", "}"}]}], ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"FMakeFRETPeakModel", "[", 
            RowBox[{"peaks", ",", 
             RowBox[{"Length", "[", "dat", "]"}]}], "]"}], "[", 
           RowBox[{"[", "1", "]"}], "]"}], ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"FMakeFRETPeakModel", "[", 
            RowBox[{"peaks", ",", 
             RowBox[{"Length", "[", "dat", "]"}], ",", "globparams"}], "]"}], 
           "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], "\[IndentingNewLine]", "]"}], "/.",
         "fixparams"}]}], ";", 
      RowBox[{"model", "=", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Total", "@", 
           RowBox[{"Through", "[", 
            RowBox[{"#", "[", "e", "]"}], "]"}]}], "&"}], ",", "model"}], 
        "]"}]}], ";", 
      RowBox[{"unfixedguess", "=", 
       RowBox[{"Select", "[", 
        RowBox[{
         RowBox[{"guess", "/.", "fixparams"}], ",", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{"!", 
            RowBox[{"NumberQ", "[", 
             RowBox[{"#", "[", 
              RowBox[{"[", "1", "]"}], "]"}], "]"}]}], " ", ")"}], "&"}]}], 
        "]"}]}], ";", 
      RowBox[{"nmf", "=", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"OptionValue", "[", "FConstraints", "]"}], "=!=", "None"}], 
         ",", 
         RowBox[{"FNonlinearModelGlobalFit", "[", 
          RowBox[{"dat", ",", "model", ",", 
           RowBox[{"OptionValue", "[", "FConstraints", "]"}], ",", 
           "unfixedguess", ",", 
           RowBox[{"{", "e", "}"}], ",", 
           RowBox[{"FilterRules", "[", 
            RowBox[{
             RowBox[{"{", "opts", "}"}], ",", " ", 
             RowBox[{"Options", "[", "FindFit", "]"}]}], "]"}]}], "]"}], ",", 
         RowBox[{"FNonlinearModelGlobalFit", "[", 
          RowBox[{"dat", ",", "model", ",", "unfixedguess", ",", 
           RowBox[{"{", "e", "}"}], ",", 
           RowBox[{"FilterRules", "[", 
            RowBox[{
             RowBox[{"{", "opts", "}"}], ",", " ", 
             RowBox[{"Options", "[", "FindFit", "]"}]}], "]"}]}], "]"}]}], 
        "]"}]}], ";", 
      RowBox[{"fitresult", "=", 
       RowBox[{
        RowBox[{"nmf", "[", "\"\<BestFitParameters\>\"", "]"}], "~", "Join", 
        "~", "fixparams"}]}], ";", 
      RowBox[{"fitresult", "=", 
       RowBox[{
        RowBox[{"fitresult", "/.", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            RowBox[{
             RowBox[{"Ampl", "[", "j_", "]"}], "[", "i_", "]"}], "->", "x_"}],
            ")"}], ":>", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{
             RowBox[{"Ampl", "[", "j", "]"}], "[", "i", "]"}], "->", 
            RowBox[{"Abs", "[", "x", "]"}]}], ")"}]}]}], "/.", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Ampl", "[", "i_", "]"}], "->", "x_"}], ")"}], ":>", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Ampl", "[", "i", "]"}], "->", 
           RowBox[{"Abs", "[", "x", "]"}]}], ")"}]}]}]}], ";", 
      RowBox[{"{", 
       RowBox[{"fitresult", ",", 
        RowBox[{"FPlotFRETFit", "[", 
         RowBox[{"histodat", ",", "peaks", ",", "fitresult", ",", 
          RowBox[{"FilterRules", "[", 
           RowBox[{
            RowBox[{"{", "opts", "}"}], ",", " ", 
            RowBox[{"Options", "[", "FPlotFRETFit", "]"}]}], "]"}]}], "]"}], 
        ",", "nmf"}], "}"}]}]}], "\n", "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{"FFitFretHistogram", "[", 
   RowBox[{
    RowBox[{"histodat", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumberQ"}], ",", 
           RowBox[{"_", "?", "NumberQ"}], ",", "___"}], "}"}], ".."}], "}"}], 
       ".."}], "}"}]}], ",", 
    RowBox[{"peaks", ":", 
     RowBox[{"{", 
      RowBox[{"Repeated", "[", 
       RowBox[{"\"\<G\>\"", "|", "\"\<L\>\""}], "]"}], "}"}]}], ",", 
    RowBox[{"globalparams", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_Symbol", "[", "_Integer", "]"}], ".."}], "}"}]}], ",", 
    RowBox[{"peakposguess", ":", 
     RowBox[{"{", 
      RowBox[{"Repeated", "[", 
       RowBox[{
        RowBox[{"_", "?", "NumberQ"}], "|", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumberQ"}], ",", 
          RowBox[{"_", "?", "NumberQ"}]}], "}"}]}], "]"}], "}"}]}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"FFitFretHistogram", "[", 
   RowBox[{"histodat", ",", "peaks", ",", 
    RowBox[{"FFindGuess", "[", 
     RowBox[{
     "histodat", ",", "peaks", ",", "globalparams", ",", "peakposguess"}], 
     "]"}], ",", "opts"}], "]"}]}], "\n"}], "Input",
 CellChangeTimes->{{3.7489287289158125`*^9, 3.7489287430833545`*^9}, {
   3.7525799862347713`*^9, 3.752580085393237*^9}, {3.859532071290485*^9, 
   3.859532075077347*^9}, 3.859879901988741*^9, {3.859970395507227*^9, 
   3.8599704465952973`*^9}, {3.859972212241462*^9, 3.8599722125764236`*^9}, {
   3.8599723127421985`*^9, 3.8599723147767997`*^9}, {3.859972348672488*^9, 
   3.8599723803785243`*^9}, {3.8599724310085416`*^9, 3.859972434128215*^9}, {
   3.8599724923504505`*^9, 3.8599725440358124`*^9}, 3.859972601503233*^9, {
   3.859973580140357*^9, 
   3.8599735805403614`*^9}},ExpressionUUID->"a688e9aa-b637-45a3-b4a9-\
04e259cfe99a"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FDetermineShotNoiseWidths", "]"}], "=", 
   RowBox[{
    RowBox[{"{", "}"}], "~", "Join", "~", 
    RowBox[{"Options", "[", "FFitFretHistogram", "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"FDetermineShotNoiseWidths", "[", 
   RowBox[{
    RowBox[{"Erange", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumberQ"}], ",", 
       RowBox[{"_", "?", "NumberQ"}], ",", 
       RowBox[{"_", "?", "NumberQ"}]}], "}"}]}], ",", 
    RowBox[{"peaks", ":", 
     RowBox[{"{", 
      RowBox[{"Repeated", "[", 
       RowBox[{"\"\<G\>\"", "|", "\"\<L\>\""}], "]"}], "}"}]}], ",", 
    RowBox[{"peakposguess", ":", 
     RowBox[{"{", 
      RowBox[{"Repeated", "[", 
       RowBox[{
        RowBox[{"_", "?", "NumberQ"}], "|", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumberQ"}], ",", 
          RowBox[{"_", "?", "NumberQ"}]}], "}"}]}], "]"}], "}"}]}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", "\n", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "proxhisto", ",", "proxfit", ",", "pA", ",", "pstate", ",", "aroutes", 
      ",", "droutes", ",", "ntotlist", ",", "proute", ",", "proutelist", ",", 
      "blrc", ",", "rcm", ",", "bg", ",", "blrc2", ",", "fit", ",", "fitrc", 
      ",", "recoloredhisto", ",", "pl", ",", "ExcessWidth", ",", "nA", ",", 
      "nD", ",", "func"}], "}"}], ",", "\n", "\n", 
    RowBox[{
     RowBox[{"proxhisto", "=", 
      RowBox[{"FParamHisto", "[", 
       RowBox[{"\"\<ProximityRatio\>\"", ",", "Erange", ",", 
        RowBox[{"FOutput", "->", "FData"}], ",", 
        RowBox[{"FilterRules", "[", 
         RowBox[{
          RowBox[{"{", "opts", "}"}], ",", " ", 
          RowBox[{"Options", "[", "FParamHisto", "]"}]}], "]"}]}], "]"}]}], 
     ";", "\n", 
     RowBox[{"proxfit", "=", 
      RowBox[{"FFitFretHistogram", "[", 
       RowBox[{"proxhisto", ",", "peaks", ",", "peakposguess", ",", 
        RowBox[{"FilterRules", "[", 
         RowBox[{
          RowBox[{"{", "opts", "}"}], ",", " ", 
          RowBox[{"Options", "[", "FFitFretHistogram", "]"}]}], "]"}]}], 
       "]"}]}], ";", "\n", 
     RowBox[{"pA", "=", 
      RowBox[{
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"Pos", "[", "i", "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", 
           RowBox[{"Length", "[", "peaks", "]"}]}], "}"}]}], "]"}], "/.", 
       RowBox[{"proxfit", "[", 
        RowBox[{"[", "1", "]"}], "]"}]}]}], ";", "\n", 
     RowBox[{"pstate", "=", 
      RowBox[{"FFRETPeakIntegrate", "[", 
       RowBox[{"peaks", ",", 
        RowBox[{"proxfit", "[", 
         RowBox[{"[", "1", "]"}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"-", "0"}], ",", "1"}], "}"}]}], "]"}]}], ";", "\n", 
     RowBox[{"pstate", "/=", 
      RowBox[{"Total", "[", "pstate", "]"}]}], ";", "\n", 
     RowBox[{"aroutes", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{"Position", "[", 
        RowBox[{
         RowBox[{"FGetAcceptorRoutes", "[", "]"}], ",", "1"}], "]"}], "]"}]}],
      ";", "\n", 
     RowBox[{"droutes", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{"Position", "[", 
        RowBox[{
         RowBox[{"FGetDonorRoutes", "[", "]"}], ",", "1"}], "]"}], "]"}]}], 
     ";", "\n", 
     RowBox[{"nA", "=", 
      RowBox[{"Round", "@", 
       RowBox[{"FGetFromBurstList", "[", 
        RowBox[{
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"\"\<n\>\"", "<>", 
            RowBox[{"ToString", "[", "i", "]"}]}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", "aroutes"}], "}"}]}], "]"}], ",", 
         RowBox[{"FilterRules", "[", 
          RowBox[{
           RowBox[{"{", "opts", "}"}], ",", " ", 
           RowBox[{"Options", "[", "FGetFromBurstList", "]"}]}], "]"}]}], 
        "]"}]}]}], ";", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{
        RowBox[{"eg", ".", " ", "MT200"}], " ", "nA"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"n1", "..."}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"n3", "..."}], "}"}]}], "  "}]}], "*)"}], "\n", 
     RowBox[{"nD", "=", 
      RowBox[{"Round", "@", 
       RowBox[{"FGetFromBurstList", "[", 
        RowBox[{
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"\"\<n\>\"", "<>", 
            RowBox[{"ToString", "[", "i", "]"}]}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", "droutes"}], "}"}]}], "]"}], ",", 
         RowBox[{"FilterRules", "[", 
          RowBox[{
           RowBox[{"{", "opts", "}"}], ",", " ", 
           RowBox[{"Options", "[", "FGetFromBurstList", "]"}]}], "]"}]}], 
        "]"}]}]}], ";", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{
        RowBox[{"eg", ".", " ", "MT200"}], " ", "nD"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"n2", "..."}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"n4", "..."}], "}"}]}], "  "}]}], "*)"}], "\n", 
     RowBox[{"ntotlist", "=", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"Plus", "@@", "nA"}], ")"}], "+", 
       RowBox[{"(", 
        RowBox[{"Plus", "@@", "nD"}], ")"}]}]}], ";", "\n", 
     RowBox[{"proute", "=", 
      RowBox[{"Map", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Flatten", "@", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"#", " ", 
             RowBox[{
              RowBox[{"Total", "/@", "nA"}], "/", 
              RowBox[{"Total", "[", 
               RowBox[{"Total", "/@", "nA"}], "]"}]}]}], ",", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"1", "-", "#"}], ")"}], " ", 
             RowBox[{
              RowBox[{"Total", "/@", "nD"}], "/", 
              RowBox[{"Total", "[", 
               RowBox[{"Total", "/@", "nD"}], "]"}]}]}]}], "}"}]}], "&"}], 
        ",", "pA"}], "]"}]}], ";", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{
        RowBox[{"Total", "/@", "nA"}], "/", 
        RowBox[{"Total", "[", 
         RowBox[{"Total", "/@", "nA"}], "]"}]}], "=", 
       RowBox[{
       "distribution", " ", "of", " ", "acceptor", " ", "photons", " ", 
        "onto", " ", "the", " ", "acceptor", " ", "detectors"}]}], "*)"}], 
     "\n", 
     RowBox[{"proutelist", "=", 
      RowBox[{"RandomChoice", "[", 
       RowBox[{
        RowBox[{"pstate", "->", "proute"}], ",", 
        RowBox[{"Length", "[", 
         RowBox[{"nA", "[", 
          RowBox[{"[", "1", "]"}], "]"}], "]"}]}], "]"}]}], ";", "\n", 
     RowBox[{"blrc", "=", 
      RowBox[{"MapThread", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"RandomVariate", "[", 
          RowBox[{"MultinomialDistribution", "[", 
           RowBox[{"#1", ",", "#2"}], "]"}], "]"}], "&"}], ",", 
        RowBox[{"{", 
         RowBox[{"ntotlist", ",", "proutelist"}], "}"}]}], "]"}]}], ";", "\n", 
     RowBox[{"rcm", "=", 
      RowBox[{
       RowBox[{"FGetRCM", "[", "]"}], "[", 
       RowBox[{"[", 
        RowBox[{
         RowBox[{"aroutes", "~", "Join", "~", "droutes"}], ",", 
         RowBox[{"aroutes", "~", "Join", "~", "droutes"}]}], "]"}], "]"}]}], 
     ";", "\n", 
     RowBox[{"bg", "=", 
      RowBox[{"Map", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"FGetBackground", "[", "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"aroutes", "~", "Join", "~", "droutes"}], "]"}], "]"}], 
          "*", "#"}], "&"}], ",", 
        RowBox[{"FGetFromBurstList", "[", 
         RowBox[{"\"\<BurstDuration\>\"", ",", 
          RowBox[{"FilterRules", "[", 
           RowBox[{
            RowBox[{"{", "opts", "}"}], ",", " ", 
            RowBox[{"Options", "[", "FGetFromBurstList", "]"}]}], "]"}]}], 
         " ", "]"}]}], "]"}]}], ";", "\n", "\n", 
     RowBox[{"blrc2", "=", 
      RowBox[{"Map", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"rcm", ".", "#"}], "&"}], ",", 
        RowBox[{"blrc", "-", "bg"}]}], "]"}]}], ";", "\n", "\n", 
     RowBox[{"recoloredhisto", "=", 
      RowBox[{"Histo", "[", 
       RowBox[{
        RowBox[{"With", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"na", "=", 
             RowBox[{"Total", "/@", 
              RowBox[{"blrc2", "[", 
               RowBox[{"[", 
                RowBox[{"All", ",", 
                 RowBox[{"1", ";;", 
                  RowBox[{"Length", "[", "aroutes", "]"}]}]}], "]"}], 
               "]"}]}]}], ",", 
            RowBox[{"ntot", "=", 
             RowBox[{"Total", "/@", "blrc2"}]}], ",", 
            RowBox[{"\[Alpha]", "=", 
             RowBox[{"FGetDirectAcceptorExcitation", "[", "]"}]}]}], "}"}], 
          ",", 
          RowBox[{"N", "@", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"na", "-", 
               RowBox[{"\[Alpha]", " ", "ntot"}]}], ")"}], "/", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"(", 
                RowBox[{"1", "-", "\[Alpha]"}], ")"}], "ntot"}], ")"}]}], 
            ")"}]}]}], "]"}], ",", "Erange", ",", 
        RowBox[{"FOutput", "->", "FData"}]}], "]"}]}], ";", "\n", 
     RowBox[{"fitrc", "=", 
      RowBox[{"FFitFretHistogram", "[", 
       RowBox[{"recoloredhisto", ",", "peaks", ",", "peakposguess", ",", 
        RowBox[{"ChartStyle", "->", 
         RowBox[{"Directive", "[", 
          RowBox[{
           RowBox[{"Opacity", "[", "0.5", "]"}], ",", "LightGray"}], "]"}]}], 
        ",", 
        RowBox[{"FFitCurveStyle", "->", 
         RowBox[{"{", 
          RowBox[{"Red", ",", 
           RowBox[{"AbsoluteThickness", "[", "3", "]"}]}], "}"}]}], ",", 
        RowBox[{"FilterRules", "[", 
         RowBox[{
          RowBox[{"{", "opts", "}"}], ",", " ", 
          RowBox[{"Options", "[", "FFitFretHistogram", "]"}]}], "]"}]}], 
       "]"}]}], ";", "\n", 
     RowBox[{"fit", "=", 
      RowBox[{"FFitFretHistogram", "[", 
       RowBox[{"Erange", ",", "peaks", ",", "peakposguess", ",", 
        RowBox[{"FilterRules", "[", 
         RowBox[{
          RowBox[{"{", "opts", "}"}], ",", " ", 
          RowBox[{"Options", "[", "FFitFretHistogram", "]"}]}], "]"}]}], 
       "]"}]}], ";", "\n", 
     RowBox[{
      RowBox[{"func", "[", "et_", "]"}], ":=", 
      RowBox[{"Module", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"x", ",", "y"}], "}"}], ",", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"Through", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"FMakeFRETPeakModel", "[", "peaks", "]"}], "[", 
               RowBox[{"[", "1", "]"}], "]"}], "[", "et", "]"}], "]"}], "/.", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"Ampl", "->", "x"}], ",", 
              RowBox[{"Pos", "->", "y"}]}], "}"}]}], "/.", 
           RowBox[{"fitrc", "[", 
            RowBox[{"[", "1", "]"}], "]"}]}], "/.", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"x", "->", "Ampl"}], ",", 
            RowBox[{"y", "->", "Pos"}]}], "}"}]}], "/.", 
         RowBox[{"fit", "[", 
          RowBox[{"[", "1", "]"}], "]"}]}]}], "]"}]}], ";", "\n", 
     RowBox[{"pl", "=", 
      RowBox[{"Module", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"x", ",", "y", ",", "et"}], "}"}], ",", "\n", 
        RowBox[{"Show", "[", 
         RowBox[{
          RowBox[{"fit", "[", 
           RowBox[{"[", "2", "]"}], "]"}], ",", 
          RowBox[{"Plot", "[", 
           RowBox[{
            RowBox[{"Evaluate", "[", 
             RowBox[{"func", "[", "et", "]"}], "]"}], ",", 
            RowBox[{"{", 
             RowBox[{"et", ",", 
              RowBox[{"Erange", "[", 
               RowBox[{"[", "1", "]"}], "]"}], ",", 
              RowBox[{"Erange", "[", 
               RowBox[{"[", "2", "]"}], "]"}]}], "}"}], ",", 
            RowBox[{"PlotRange", "->", "All"}], ",", 
            RowBox[{"PlotStyle", "->", "Red"}]}], "]"}]}], "]"}]}], "\n", 
       "]"}]}], ";", "\n", 
     RowBox[{"ExcessWidth", "=", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{
         RowBox[{"Abs", "[", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{"Width", "[", "i", "]"}], ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", 
              RowBox[{"Length", "[", "peaks", "]"}]}], "}"}]}], "]"}], "]"}], 
         "/.", 
         RowBox[{"fit", "[", 
          RowBox[{"[", "1", "]"}], "]"}]}], ")"}], "-", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"Abs", "[", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{"Width", "[", "i", "]"}], ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", 
              RowBox[{"Length", "[", "peaks", "]"}]}], "}"}]}], "]"}], "]"}], 
         "/.", 
         RowBox[{"fitrc", "[", 
          RowBox[{"[", "1", "]"}], "]"}]}], ")"}]}]}], ";", "\n", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"\"\<Original data\>\"", "->", "fit"}], ",", 
       RowBox[{"\"\<Recolored data\>\"", "->", "fitrc"}], ",", 
       RowBox[{"\"\<overlay\>\"", "->", "pl"}], ",", 
       RowBox[{"\"\<ExcessWidths\>\"", "->", "ExcessWidth"}]}], "}"}]}]}], 
   "\n", "\n", "]"}]}]}], "Input",
 CellChangeTimes->{{3.7489282831993027`*^9, 3.7489283386710725`*^9}, 
   3.7489287669926643`*^9, {3.750578683861035*^9, 3.75057868828922*^9}, {
   3.859532104723903*^9, 3.859532107751031*^9}, 3.85987990841827*^9, {
   3.859973433830643*^9, 
   3.8599734740148683`*^9}},ExpressionUUID->"9484be41-06ba-4e8e-9581-\
47bd869040c0"]
}, Closed]],

Cell[CellGroupData[{

Cell["Fit Peaks with 2D Gaussians", "Subsubsection",
 CellChangeTimes->{{3.526821593889758*^9, 3.526821626900416*^9}, {
   3.527341670860113*^9, 3.527341672654171*^9}, {3.527341837769863*^9, 
   3.527341842481214*^9}, {3.7951724877198615`*^9, 3.79517250056469*^9}, {
   3.7951785137128854`*^9, 3.7951785230104885`*^9}, {3.8305940502568274`*^9, 
   3.8305940544122677`*^9}, {3.865491680585971*^9, 3.865491692748315*^9}, 
   3.8654981394627695`*^9},ExpressionUUID->"50445282-856f-451f-a2bf-\
dc5f9e0d90b3"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"FGaussian2D", "[", 
    RowBox[{"A_", ",", 
     RowBox[{"x0", ":", 
      RowBox[{"{", 
       RowBox[{"_", ",", "_"}], "}"}]}], ",", 
     RowBox[{"\[Sigma]", ":", 
      RowBox[{"{", 
       RowBox[{"_", ",", "_"}], "}"}]}], ",", "\[Alpha]_"}], "]"}], "[", 
   RowBox[{"x", ":", 
    RowBox[{"{", 
     RowBox[{"_", ",", "_"}], "}"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"rot", ",", "B"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"rot", "=", 
      RowBox[{"RotationMatrix", "[", "\[Alpha]", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"B", "=", 
      RowBox[{"DiagonalMatrix", "[", 
       RowBox[{"1", "/", 
        RowBox[{"(", 
         RowBox[{"2", 
          SuperscriptBox["\[Sigma]", "2"]}], ")"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"A", " ", 
      RowBox[{
       RowBox[{"Exp", "[", 
        RowBox[{"-", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"rot", ".", 
            RowBox[{"(", 
             RowBox[{"x", "-", "x0"}], ")"}]}], "}"}], ".", "B", ".", 
          RowBox[{"(", 
           RowBox[{"rot", ".", 
            RowBox[{"(", 
             RowBox[{"x", "-", "x0"}], ")"}]}], ")"}]}]}], "]"}], "[", 
       RowBox[{"[", "1", "]"}], "]"}]}]}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.662962800743594*^9, 3.662963063280332*^9}, {
   3.662963404061018*^9, 3.662963420184057*^9}, {3.662986555597593*^9, 
   3.6629865744440193`*^9}, {3.663046203194639*^9, 3.6630462149133425`*^9}, {
   3.6630669092080207`*^9, 3.6630669120516796`*^9}, 3.8220403603445415`*^9, {
   3.822043031355938*^9, 3.8220430334039555`*^9}, {3.8220435785653515`*^9, 
   3.822043757626074*^9}, {3.823689361860365*^9, 3.823689369202669*^9}, {
   3.8305777297074757`*^9, 3.830577779713318*^9}, {3.830578300095262*^9, 
   3.8305783002358575`*^9}, {3.8654807756630526`*^9, 
   3.8654808043323054`*^9}, {3.865481978943214*^9, 3.865481981382043*^9}, {
   3.865482043982626*^9, 3.865482054115587*^9}},
 CellLabel->
  "In[1028]:=",ExpressionUUID->"e5aae152-ba0c-401b-9439-364de2d6935e"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FGetEllipsoid", "[", 
   RowBox[{
    RowBox[{"x0", ":", 
     RowBox[{"{", 
      RowBox[{"_", ",", "_"}], "}"}]}], ",", 
    RowBox[{"\[Sigma]", ":", 
     RowBox[{"{", 
      RowBox[{"_", ",", "_"}], "}"}]}], ",", "\[Alpha]_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "rot", ",", "B", ",", "elipsoid", ",", "pxy", ",", "pxz", ",", "pyz"}], 
     "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"rot", "=", 
      RowBox[{"RotationMatrix", "[", "\[Alpha]", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"B", "=", 
      RowBox[{"DiagonalMatrix", "[", 
       SuperscriptBox["\[Sigma]", "2"], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"elipsoid", "=", 
      RowBox[{"Ellipsoid", "[", 
       RowBox[{"x0", ",", 
        RowBox[{
         RowBox[{"rot", "\[Transpose]"}], ".", "B", ".", "rot"}]}], 
       "]"}]}]}]}], "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.830582379663666*^9, 3.8305824063927608`*^9}, 
   3.8654807993555202`*^9},
 CellLabel->
  "In[1020]:=",ExpressionUUID->"38233775-3347-4ec3-9a3d-f70fda13d5da"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FMakePeakModel2D", "[", "peaknames_List", "]"}], ":=", 
  "\[IndentingNewLine]", 
  RowBox[{"{", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Function", "[", 
     RowBox[{"xy", ",", 
      RowBox[{"Total", "@", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"FGaussian2D", "[", 
           RowBox[{
            RowBox[{"amplitudepeak", "[", "i", "]"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"x0peak", "[", "i", "]"}], ",", 
              RowBox[{"y0peak", "[", "i", "]"}]}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"\[Sigma]xpeak", "[", "i", "]"}], ",", 
              RowBox[{"\[Sigma]ypeak", "[", "i", "]"}]}], "}"}], ",", 
            RowBox[{"anglepeak", "[", "i", "]"}]}], "]"}], "[", "xy", "]"}], 
         ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "peaknames"}], "}"}]}], "]"}]}]}], "]"}], ",", 
    RowBox[{"Flatten", "@", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"amplitudepeak", "[", "i", "]"}], ",", 
         RowBox[{"x0peak", "[", "i", "]"}], ",", 
         RowBox[{"y0peak", "[", "i", "]"}], ",", 
         RowBox[{"\[Sigma]xpeak", "[", "i", "]"}], ",", 
         RowBox[{"\[Sigma]ypeak", "[", "i", "]"}], ",", 
         RowBox[{"anglepeak", "[", "i", "]"}]}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", "peaknames"}], "}"}]}], "]"}]}]}], 
   "\[IndentingNewLine]", "}"}]}]], "Input",
 CellChangeTimes->{{3.8305789583563104`*^9, 3.830579012642502*^9}, {
  3.865480818976934*^9, 3.8654808634592967`*^9}, {3.865481355097266*^9, 
  3.865481363063943*^9}, {3.8654814523400607`*^9, 3.865481480249202*^9}, {
  3.8654817747776403`*^9, 3.865482027160287*^9}, {3.865482061006482*^9, 
  3.8654820833929462`*^9}, {3.86549186363922*^9, 3.8654918804274244`*^9}},
 CellLabel->
  "In[1142]:=",ExpressionUUID->"aacec986-0e69-4f24-ba78-4eca118885cc"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FFitPeaks2DMakeGuess", "[", 
   RowBox[{"data_", ",", "peaknames_", ",", 
    RowBox[{"positionguess", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumericQ"}], ",", 
         RowBox[{"_", "?", "NumericQ"}]}], "}"}], ".."}], "}"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"f", ",", "params"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"f", "=", 
      RowBox[{"Interpolation", "[", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"#", "[", 
             RowBox[{"[", 
              RowBox[{"1", ";;", "2"}], "]"}], "]"}], ",", 
            RowBox[{"#", "[", 
             RowBox[{"[", "3", "]"}], "]"}]}], "}"}], "&"}], ",", "data"}], 
        "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"params", "=", 
      RowBox[{"{", 
       RowBox[{"peaknames", ",", "positionguess", ",", 
        RowBox[{"Map", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"f", "[", 
            RowBox[{"Sequence", "@@", "#"}], "]"}], "&"}], ",", 
          RowBox[{"positionguess", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", 
             RowBox[{"1", ";;", "2"}]}], "]"}], "]"}]}], "]"}]}], "}"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"Flatten", "[", 
      RowBox[{
       RowBox[{"MapThread", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"amplitudepeak", "[", "#1", "]"}], ",", "#3"}], "}"}], 
            ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"x0peak", "[", "#1", "]"}], ",", 
              RowBox[{"#2", "[", 
               RowBox[{"[", "1", "]"}], "]"}]}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"y0peak", "[", "#1", "]"}], ",", 
              RowBox[{"#2", "[", 
               RowBox[{"[", "2", "]"}], "]"}]}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"\[Sigma]xpeak", "[", "#1", "]"}], ",", "0.1"}], "}"}], 
            ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"\[Sigma]ypeak", "[", "#1", "]"}], ",", "0.1"}], "}"}], 
            ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"anglepeak", "[", "#1", "]"}], ",", "0"}], "}"}]}], 
           "}"}], "&"}], ",", "params"}], "]"}], ",", "1"}], "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.8654830329526653`*^9, 3.865483037627885*^9}, {
  3.865483073877803*^9, 3.8654830983374653`*^9}, {3.865483273435305*^9, 
  3.8654833283930893`*^9}, {3.865483372010146*^9, 3.8654834274315634`*^9}, {
  3.865484321298954*^9, 3.865484379625656*^9}, {3.865484426401574*^9, 
  3.8654844672458215`*^9}, {3.86548452204712*^9, 3.8654845435127435`*^9}, {
  3.865484576637607*^9, 3.8654846379998145`*^9}, {3.8654846791497564`*^9, 
  3.865484741858945*^9}, {3.8654847835472364`*^9, 3.8654848173455067`*^9}, {
  3.8654848557066345`*^9, 3.8654849857366705`*^9}, {3.8654850541145687`*^9, 
  3.8654851594603305`*^9}, {3.8654852461144724`*^9, 3.865485250634219*^9}, {
  3.8654852820812984`*^9, 3.865485311789287*^9}, {3.8654855773204412`*^9, 
  3.865485653882989*^9}, {3.8654917478087153`*^9, 
  3.865491821180651*^9}},ExpressionUUID->"a3ac5a1c-df30-4d73-8a5f-\
04e7c6de2373"],

Cell[BoxData[{
 RowBox[{"Clear", "[", "FFitPeaks2D", "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FFitPeaks2D", "]"}], "=", 
   RowBox[{"Join", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"FConstraints", "->", "None"}], ",", 
       RowBox[{"FFixParams", "->", 
        RowBox[{"{", "}"}]}]}], "}"}], ",", 
     RowBox[{"Options", "[", "ListContourPlot", "]"}], ",", 
     RowBox[{"Options", "[", "NonlinearModelFit", "]"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FFitPeaks2D", "[", 
    RowBox[{"data_", ",", "peaknames_List", ",", "guess_List", ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "modelf", ",", "model", ",", "var", ",", "x", ",", "y", ",", "fit", ",",
        "pl", ",", "ellipses", ",", "eslist", ",", "fixparams", ",", 
       "unfixedguess", ",", "fitresult", ",", "labels"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"{", 
        RowBox[{"modelf", ",", "var"}], "}"}], "=", 
       RowBox[{"FMakePeakModel2D", "[", "peaknames", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"fixparams", "=", 
       RowBox[{"OptionValue", "[", "FFixParams", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"model", "[", 
        RowBox[{"{", 
         RowBox[{"x_", ",", "y_"}], "}"}], "]"}], "=", 
       RowBox[{
        RowBox[{"modelf", "[", 
         RowBox[{"{", 
          RowBox[{"x", ",", "y"}], "}"}], "]"}], "/.", "fixparams"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"unfixedguess", "=", 
       RowBox[{"Select", "[", 
        RowBox[{
         RowBox[{"guess", "/.", "fixparams"}], ",", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{"!", 
            RowBox[{"NumberQ", "[", 
             RowBox[{"#", "[", 
              RowBox[{"[", "1", "]"}], "]"}], "]"}]}], " ", ")"}], "&"}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"fit", "=", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"OptionValue", "[", "FConstraints", "]"}], "===", "None"}], 
         ",", "\[IndentingNewLine]", 
         RowBox[{"NonlinearModelFit", "[", 
          RowBox[{"data", ",", 
           RowBox[{"model", "[", 
            RowBox[{"{", 
             RowBox[{"x", ",", "y"}], "}"}], "]"}], ",", "unfixedguess", ",", 
           RowBox[{"{", 
            RowBox[{"x", ",", "y"}], "}"}], ",", 
           RowBox[{"FilterRules", "[", 
            RowBox[{
             RowBox[{"{", "opts", "}"}], ",", " ", 
             RowBox[{"Options", "[", "NonlinearModelFit", "]"}]}], "]"}]}], 
          "]"}], ",", "\[IndentingNewLine]", 
         RowBox[{"NonlinearModelFit", "[", 
          RowBox[{"data", ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"model", "[", 
              RowBox[{"{", 
               RowBox[{"x", ",", "y"}], "}"}], "]"}], ",", 
             RowBox[{"OptionValue", "[", "FConstraints", "]"}]}], "}"}], ",", 
           "unfixedguess", ",", 
           RowBox[{"{", 
            RowBox[{"x", ",", "y"}], "}"}], ",", 
           RowBox[{"FilterRules", "[", 
            RowBox[{
             RowBox[{"{", "opts", "}"}], ",", " ", 
             RowBox[{"Options", "[", "NonlinearModelFit", "]"}]}], "]"}]}], 
          "]"}]}], "\[IndentingNewLine]", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"fitresult", "=", 
       RowBox[{
        RowBox[{"fit", "[", "\"\<BestFitParameters\>\"", "]"}], "~", "Join", 
        "~", "fixparams"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"pl", "=", 
       RowBox[{"ListContourPlot", "[", 
        RowBox[{"data", ",", 
         RowBox[{"FilterRules", "[", 
          RowBox[{
           RowBox[{"{", "opts", "}"}], ",", " ", 
           RowBox[{"Options", "[", "ListContourPlot", "]"}]}], "]"}], ",", 
         RowBox[{"ColorFunction", "->", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"#", "!=", "0"}], ",", 
              RowBox[{"Hue", "[", 
               RowBox[{"(", 
                RowBox[{"0.75", "-", 
                 RowBox[{".75", "#"}]}], ")"}], "]"}], ",", "White"}], "]"}], 
            "&"}], ")"}]}], ",", 
         RowBox[{"LabelStyle", "->", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"FontFamily", "->", " ", "\"\<Helvetica\>\""}], ",", 
            RowBox[{"FontSize", "->", " ", "12"}], ",", 
            RowBox[{"FontWeight", "->", " ", "Bold"}]}], "}"}]}], ",", 
         RowBox[{"PlotRange", "->", "Automatic"}], ",", 
         RowBox[{"FrameStyle", "->", " ", 
          RowBox[{"Directive", "[", 
           RowBox[{"Black", ",", 
            RowBox[{"AbsoluteThickness", "[", "0.8", "]"}]}], "]"}]}], ",", 
         RowBox[{"ImageSize", "->", " ", "400"}], ",", 
         RowBox[{"AspectRatio", "->", 
          RowBox[{"1", "/", "GoldenRatio"}]}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"ellipses", "=", 
       RowBox[{
        RowBox[{"FGetEllipsoid", "@@@", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{
               RowBox[{"x0peak", "[", "i", "]"}], ",", 
               RowBox[{"y0peak", "[", "i", "]"}]}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"\[Sigma]xpeak", "[", "i", "]"}], ",", 
               RowBox[{"\[Sigma]ypeak", "[", "i", "]"}]}], "}"}], ",", 
             RowBox[{"anglepeak", "[", "i", "]"}]}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", "peaknames"}], "}"}]}], "]"}]}], "/.", 
        "fitresult"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eslist", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"x0peak", "[", "s", "]"}], ",", 
            RowBox[{"y0peak", "[", "s", "]"}]}], "}"}], "/.", "fitresult"}], 
         ",", 
         RowBox[{"{", 
          RowBox[{"s", ",", "peaknames"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"labels", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Text", "[", 
           RowBox[{
            RowBox[{"ToString", "[", "s", "]"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"x0peak", "[", "s", "]"}], ",", 
              RowBox[{
               RowBox[{"y0peak", "[", "s", "]"}], "+", 
               RowBox[{"2", 
                RowBox[{"Abs", "@", 
                 RowBox[{"\[Sigma]ypeak", "[", "s", "]"}]}]}]}]}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"0", ",", 
              RowBox[{"-", "1"}]}], "}"}]}], "]"}], "/.", "fitresult"}], ",", 
         RowBox[{"{", 
          RowBox[{"s", ",", "peaknames"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"pl", "=", 
       RowBox[{"Show", "[", 
        RowBox[{"pl", ",", 
         RowBox[{"Graphics", "[", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"EdgeForm", "[", 
               RowBox[{"{", 
                RowBox[{"Thick", ",", "Red"}], "}"}], "]"}], ",", 
              RowBox[{"FaceForm", "[", "]"}], ",", "ellipses"}], "}"}], ",", 
            "labels"}], "}"}], "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"{", 
       RowBox[{"eslist", ",", "pl", ",", "fitresult", ",", "fit"}], "}"}]}]}],
     "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FFitPeaks2D", "[", 
   RowBox[{"data_", ",", "peaknames_List", ",", 
    RowBox[{"positionguess", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumericQ"}], ",", 
         RowBox[{"_", "?", "NumericQ"}]}], "}"}], ".."}], "}"}]}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"FFitPeaks2D", "[", 
   RowBox[{"data", ",", "peaknames", ",", 
    RowBox[{"FFitPeaks2DMakeGuess", "[", 
     RowBox[{"data", ",", "peaknames", ",", "positionguess"}], "]"}], ",", 
    "opts"}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.8654810991132574`*^9, 3.8654811195357237`*^9}, 
   3.865482135118052*^9, {3.865482262131033*^9, 3.865482262761639*^9}, {
   3.865482294535514*^9, 3.8654823870103235`*^9}, {3.8654824335410614`*^9, 
   3.8654825370709696`*^9}, {3.8654826262359524`*^9, 3.865482641780283*^9}, {
   3.865482838141968*^9, 3.8654828995980873`*^9}, {3.8654857103582697`*^9, 
   3.8654857565752926`*^9}, {3.8654861899208193`*^9, 3.865486233054268*^9}, {
   3.8654864219657583`*^9, 3.865486562502491*^9}, {3.865486610397363*^9, 
   3.8654866162765617`*^9}, {3.86548664782405*^9, 3.8654866637716737`*^9}, {
   3.865486704933771*^9, 3.8654867414414034`*^9}, {3.865486794792143*^9, 
   3.865486968919828*^9}, {3.865487429996609*^9, 3.8654874637518363`*^9}, 
   3.8654900736340294`*^9, {3.8654901308622484`*^9, 3.865490151901975*^9}, {
   3.8654902135138445`*^9, 3.865490268420518*^9}, {3.8654906153726406`*^9, 
   3.865490616149437*^9}, {3.865490655093468*^9, 3.8654906565844245`*^9}, {
   3.865490731735528*^9, 3.8654907381271553`*^9}, {3.865490776716823*^9, 
   3.865490842172243*^9}, {3.8654909315028296`*^9, 3.8654909341929436`*^9}, {
   3.8654909775756855`*^9, 3.8654909933769026`*^9}, {3.8654910718301096`*^9, 
   3.8654911711038895`*^9}, {3.8654912866890993`*^9, 3.865491289712815*^9}, {
   3.8654913614565544`*^9, 3.865491373044819*^9}, {3.865491448151822*^9, 
   3.865491451906141*^9}, {3.865491830908946*^9, 3.865491852895814*^9}, {
   3.8654918978438435`*^9, 3.865491905427227*^9}, {3.8654919698871703`*^9, 
   3.865492115764065*^9}, {3.8654932153572283`*^9, 3.865493219807912*^9}, {
   3.8654933022120075`*^9, 3.8654933305320673`*^9}, {3.865493361267972*^9, 
   3.8654933625786138`*^9}, {3.865493403986303*^9, 3.865493559820479*^9}, 
   3.865493623566987*^9, {3.8654936739786134`*^9, 3.8654937045134497`*^9}, {
   3.8654940422656283`*^9, 3.86549404307432*^9}, 
   3.872753775221218*^9},ExpressionUUID->"862a85b7-fdce-442a-ab57-\
8050479a9229"]
}, Closed]],

Cell[CellGroupData[{

Cell["Burst Asymmetry Cut", "Subsubsection",ExpressionUUID->"a103a181-6394-4b7f-9c94-486f72a15755"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FBurstAsymmetry", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"Emin_", ",", "Emax_", ",", "dE_"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"Amin_", ",", "Amax_", ",", "dA_"}], "}"}], ",", 
    RowBox[{"sigma_", "?", "NumberQ"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "dat", ",", "outlyer", ",", "bc", ",", "xv", ",", "yv", ",", "xyz"}], 
     "}"}], ",", "\n", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"dat", ",", "outlyer"}], "}"}], "=", 
      RowBox[{"FPBurstAsymmetry", "[", "sigma", "]"}]}], ";", "\n", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"ListPlot", "[", 
        RowBox[{
         RowBox[{"Select", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"dat", ",", "outlyer"}], "}"}], ",", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"Length", "[", "#", "]"}], ">", "0"}], ")"}], "&"}]}], 
          "]"}], ",", 
         RowBox[{"Frame", "->", "True"}], ",", 
         RowBox[{"Axes", "->", "False"}], ",", 
         RowBox[{"PlotRange", "->", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"Emin", ",", "Emax"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"Amin", ",", "Amax"}], "}"}]}], "}"}]}], ",", 
         RowBox[{"LabelStyle", "->", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"FontFamily", "->", " ", "\"\<Helvetica\>\""}], ",", 
            RowBox[{"FontSize", "->", " ", "12"}], ",", 
            RowBox[{"FontWeight", "->", " ", "Bold"}]}], "}"}]}], ",", 
         RowBox[{"ImageSize", "->", " ", "400"}], ",", 
         RowBox[{"PlotLabel", "->", 
          RowBox[{"\"\<Total=\>\"", "<>", 
           RowBox[{"ToString", "[", 
            RowBox[{"Length", "[", "dat", "]"}], "]"}], "<>", 
           "\"\<; Outlyer=\>\"", "<>", 
           RowBox[{"ToString", "[", 
            RowBox[{"Length", "[", "outlyer", "]"}], "]"}]}]}], ",", 
         RowBox[{"PlotStyle", "->", 
          RowBox[{"{", 
           RowBox[{"Blue", ",", "Red"}], "}"}]}]}], "]"}], ",", "\n", 
       RowBox[{"Histo2D", "[", 
        RowBox[{"dat", ",", 
         RowBox[{"{", 
          RowBox[{"Emin", ",", "Emax", ",", "dE"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"Amin", ",", "Amax", ",", "dA"}], "}"}], ",", 
         RowBox[{"FOutput", "->", "FGraph"}]}], "]"}], ",", "\n", 
       RowBox[{"Histo2D", "[", 
        RowBox[{"outlyer", ",", 
         RowBox[{"{", 
          RowBox[{"Emin", ",", "Emax", ",", "dE"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"Amin", ",", "Amax", ",", "dA"}], "}"}], ",", 
         RowBox[{"FOutput", "->", "FGraph"}]}], "]"}]}], "\n", "}"}]}]}], 
   "\n", "]"}]}]], "Input",ExpressionUUID->"7a89ccf8-3900-4656-a4b5-\
bdb1e91a7d4d"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FCutAsymmetricBursts", "[", 
   RowBox[{"\[Sigma]_", "?", "NumberQ"}], "]"}], ":=", 
  RowBox[{"FCutAsymmetricBursts", "[", 
   RowBox[{"N", "[", "\[Sigma]", "]"}], "]"}]}]], "Input",ExpressionUUID->\
"1c61d8df-9986-41c0-9a29-fc798174944a"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FPIEBurstAsymmetry", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"Emin_", ",", "Emax_", ",", "dE_"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"Amin_", ",", "Amax_", ",", "dA_"}], "}"}], ",", 
    RowBox[{"sigma_", "?", "NumberQ"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "dat", ",", "outlyer", ",", "bc", ",", "xv", ",", "yv", ",", "xyz"}], 
     "}"}], ",", "\n", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"dat", ",", "outlyer"}], "}"}], "=", 
      RowBox[{"FPPIEBurstAsymmetry", "[", "sigma", "]"}]}], ";", "\n", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"ListPlot", "[", 
        RowBox[{
         RowBox[{"Select", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"dat", ",", "outlyer"}], "}"}], ",", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"Length", "[", "#", "]"}], ">", "0"}], ")"}], "&"}]}], 
          "]"}], ",", 
         RowBox[{"Frame", "->", "True"}], ",", 
         RowBox[{"Axes", "->", "False"}], ",", 
         RowBox[{"PlotRange", "->", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"Emin", ",", "Emax"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"Amin", ",", "Amax"}], "}"}]}], "}"}]}], ",", 
         RowBox[{"LabelStyle", "->", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"FontFamily", "->", " ", "\"\<Helvetica\>\""}], ",", 
            RowBox[{"FontSize", "->", " ", "12"}], ",", 
            RowBox[{"FontWeight", "->", " ", "Bold"}]}], "}"}]}], ",", 
         RowBox[{"ImageSize", "->", " ", "400"}], ",", 
         RowBox[{"PlotLabel", "->", 
          RowBox[{"\"\<Total=\>\"", "<>", 
           RowBox[{"ToString", "[", 
            RowBox[{"Length", "[", "dat", "]"}], "]"}], "<>", 
           "\"\<; Outlyer=\>\"", "<>", 
           RowBox[{"ToString", "[", 
            RowBox[{"Length", "[", "outlyer", "]"}], "]"}]}]}], ",", 
         RowBox[{"PlotStyle", "->", 
          RowBox[{"{", 
           RowBox[{"Blue", ",", "Red"}], "}"}]}]}], "]"}], ",", "\n", 
       RowBox[{"Histo2D", "[", 
        RowBox[{"dat", ",", 
         RowBox[{"{", 
          RowBox[{"Emin", ",", "Emax", ",", "dE"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"Amin", ",", "Amax", ",", "dA"}], "}"}], ",", 
         RowBox[{"FOutput", "->", "FGraph"}]}], "]"}], ",", "\n", 
       RowBox[{"Histo2D", "[", 
        RowBox[{"outlyer", ",", 
         RowBox[{"{", 
          RowBox[{"Emin", ",", "Emax", ",", "dE"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"Amin", ",", "Amax", ",", "dA"}], "}"}], ",", 
         RowBox[{"FOutput", "->", "FGraph"}]}], "]"}]}], "\n", "}"}]}]}], 
   "\n", "]"}]}]], "Input",
 CellChangeTimes->{{3.8117407636675177`*^9, 3.8117407644634113`*^9}, {
  3.811740805200415*^9, 
  3.811740805872614*^9}},ExpressionUUID->"ec4b012c-71ed-48b0-95c4-\
8d4e4ffba1dd"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FPIECutAsymmetricBursts", "[", 
   RowBox[{"\[Sigma]_", "?", "NumberQ"}], "]"}], ":=", 
  RowBox[{"FPIECutAsymmetricBursts", "[", 
   RowBox[{"N", "[", "\[Sigma]", "]"}], "]"}]}]], "Input",
 CellChangeTimes->{{3.8117408217451625`*^9, 
  3.811740831819208*^9}},ExpressionUUID->"02dfdf07-bb3e-47e6-8f6b-\
66107cdd994f"]
}, Closed]],

Cell[CellGroupData[{

Cell["FCS", "Subsubsection",ExpressionUUID->"cccf334b-db88-4a4b-8cc2-f82e353465ac"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FCorrelTransformRawData", "[", "correldat_", "]"}], ":=", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{
     RowBox[{"Drop", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"CorrelikonTauBins", "*", "CorrelikonTimeUnitSec"}], "/.", 
        "correldat"}], ",", 
       RowBox[{"-", "1"}]}], "]"}], ",", 
     RowBox[{"CorrelikonG12", "/.", "correldat"}]}], "}"}], 
   "\[Transpose]"}]}]], "Input",ExpressionUUID->"a0e1f2c7-1121-4822-8831-\
21de1f3396c8"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FTimeCorrelate", "[", 
   RowBox[{
    RowBox[{"tau", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
    RowBox[{"t1", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
    RowBox[{"t2", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}]}], "]"}], ":=", 
  RowBox[{"FCorrelTransformRawData", "@", 
   RowBox[{"FCorrelateStr", "[", 
    RowBox[{
     RowBox[{"N", "[", "tau", "]"}], ",", 
     RowBox[{"N", "[", "t1", "]"}], ",", 
     RowBox[{"N", "[", "t2", "]"}]}], "]"}]}]}]], "Input",
 CellChangeTimes->{
  3.7924998925640607`*^9},ExpressionUUID->"d39ca530-afb0-4deb-9f7e-\
5163fdfc21a5"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FTimeCorrelateWeighted", "]"}], "=", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"FNumberOfStepsInCascade", "->", "10"}], ",", 
      RowBox[{"FOutput", "->", "FData"}]}], "}"}], "~", "Join", "~", " ", 
    RowBox[{"Options", "[", "ListPlot", "]"}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FTimeCorrelateWeighted", "[", 
   RowBox[{
    RowBox[{"t1", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"_Integer", ",", 
         RowBox[{"_", "?", "NumericQ"}]}], "}"}], ".."}], "}"}]}], ",", 
    RowBox[{"t2", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"_Integer", ",", 
         RowBox[{"_", "?", "NumericQ"}]}], "}"}], ".."}], "}"}]}], ",", 
    RowBox[{"taumin_", "?", "NumericQ"}], ",", " ", 
    RowBox[{"taumax_", "?", "NumericQ"}], ",", " ", 
    RowBox[{"timeunit_", "?", "NumericQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  "\[IndentingNewLine]", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"tau1", ",", "tau2", ",", 
      RowBox[{"B", "=", "10"}], ",", "dat"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"tau1", "=", 
      RowBox[{"Max", "[", 
       RowBox[{"1", ",", 
        RowBox[{"Round", "[", 
         RowBox[{"taumin", "/", "timeunit"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"tau2", "=", 
      RowBox[{"Max", "[", 
       RowBox[{"1", ",", 
        RowBox[{"Round", "[", 
         RowBox[{"taumax", "/", "timeunit"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"B", "=", 
      RowBox[{"OptionValue", "[", "FNumberOfStepsInCascade", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"dat", "=", 
      RowBox[{"FPCorrelateWeighted", "[", 
       RowBox[{"tau1", ",", "tau2", ",", "B", ",", 
        RowBox[{"N", "@", "timeunit"}], ",", 
        RowBox[{"t1", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", 
        RowBox[{"t2", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", 
        RowBox[{"N", "@", 
         RowBox[{"t1", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "2"}], "]"}], "]"}]}], ",", 
        RowBox[{"N", "@", 
         RowBox[{"t2", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "2"}], "]"}], "]"}]}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Which", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FOutput", "]"}], " ", "===", " ", 
        "FGraph"}], ",", "\[IndentingNewLine]", 
       RowBox[{"(", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"dat", "=", 
          RowBox[{"N", "@", 
           RowBox[{"FCorrelTransformRawData", "@", "dat"}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"dat", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "1"}], "]"}], "]"}], "=", 
          RowBox[{"Log", "[", 
           RowBox[{"10.", ",", 
            RowBox[{"dat", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "1"}], "]"}], "]"}]}], "]"}]}], ";", 
         RowBox[{"ListPlot", "[", 
          RowBox[{"dat", ",", 
           RowBox[{"FilterRules", "[", 
            RowBox[{
             RowBox[{"{", "opts", "}"}], ",", " ", 
             RowBox[{"Options", "[", "ListPlot", "]"}]}], "]"}], ",", 
           RowBox[{"Joined", "->", "True"}], ",", 
           RowBox[{"PlotRange", "->", "All"}], ",", 
           RowBox[{"Frame", "->", "True"}], ",", 
           RowBox[{"Axes", "->", "False"}], ",", 
           RowBox[{"FrameLabel", "->", 
            RowBox[{"{", 
             RowBox[{
             "\"\<log(\[Tau]/sec)\>\"", ",", " ", "\"\<G(\[Tau])\>\""}], 
             "}"}]}], ",", 
           RowBox[{"LabelStyle", "->", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"FontFamily", "->", " ", "\"\<Helvetica\>\""}], ",", 
              RowBox[{"FontSize", "->", " ", "Medium"}], ",", 
              RowBox[{"FontWeight", "->", " ", "Bold"}]}], "}"}]}]}], "]"}]}],
         "\[IndentingNewLine]", ")"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FData"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"(", "\[IndentingNewLine]", 
        RowBox[{"N", "@", 
         RowBox[{"FCorrelTransformRawData", "@", "dat"}]}], 
        "\[IndentingNewLine]", ")"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FRawData"}], 
       ",", "\[IndentingNewLine]", 
       RowBox[{
       "(", "\[IndentingNewLine]", "dat", "\[IndentingNewLine]", ")"}]}], 
      "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.8459849643327155`*^9, 3.845985005636853*^9}, {
  3.845985141897768*^9, 3.8459851808680696`*^9}, {3.845985240246339*^9, 
  3.845985267221442*^9}, {3.845985317372853*^9, 3.8459855401958313`*^9}, {
  3.845985601105362*^9, 3.845985601735193*^9}, {3.845987092227927*^9, 
  3.8459871821487103`*^9}, {3.8459872206193*^9, 3.8459872291047444`*^9}, {
  3.845988406384717*^9, 3.845988410077943*^9}, {3.8459888751596923`*^9, 
  3.8459888772278075`*^9}, {3.846059673405034*^9, 3.8460597082593784`*^9}, {
  3.8460597502170143`*^9, 
  3.84605992192389*^9}},ExpressionUUID->"cacad20e-d68d-400b-8179-\
1f595c491965"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FFCS", "]"}], "=", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"FPhotonData", "->", "All"}], ",", 
      RowBox[{"FOutput", "->", "FData"}], ",", " ", 
      RowBox[{"FUseMicrotime", "\[Rule]", "False"}]}], "}"}], "~", "Join", 
    "~", " ", 
    RowBox[{"Options", "[", "ListPlot", "]"}]}]}], ";"}]], "Input",
 CellChangeTimes->{{3.7506741060904665`*^9, 3.750674140895426*^9}, {
  3.762769703243518*^9, 
  3.7627697044133873`*^9}},ExpressionUUID->"6f24a41b-3942-403e-ab3d-\
5975ffdddb80"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FFCS", "[", 
   RowBox[{
    RowBox[{"tau", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
    RowBox[{"route1", ":", "FRouteList"}], ",", 
    RowBox[{"route2", ":", "FRouteList"}], ",", 
    RowBox[{"tstart_", "?", "NumberQ"}], ",", 
    RowBox[{"tstop_", "?", "NumberQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  "\[IndentingNewLine]", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"mode", "=", "0"}], ",", "dat", ",", "usemicrotime"}], "}"}], 
    ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"Which", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", "All"}], ",", 
       RowBox[{"mode", "=", "0"}], ",", "\n", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{
          RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", 
          "FBursts"}], ",", 
         RowBox[{"mode", "=", "1"}], ","}], "*)"}], "\n", 
       RowBox[{
       "(*", "\"\<OptionValue[FPhotonData]===FNonBursts,mode=2,\>\"", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", 
        "FSelectedBursts"}], ",", 
       RowBox[{"mode", "=", "2"}], "\[IndentingNewLine]", ",", "True", ",", 
       " ", 
       RowBox[{"Return", "[", "$Failed", "]"}]}], "\[IndentingNewLine]", 
      "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"usemicrotime", "=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "FUseMicrotime", "]"}], "===", "True"}], 
        ",", "1", ",", "0"}], "]"}]}], ";", 
     RowBox[{"dat", "=", 
      RowBox[{"FFCSStr", "[", 
       RowBox[{
        RowBox[{"N", "[", "tstart", "]"}], ",", 
        RowBox[{"N", "[", "tstop", "]"}], ",", 
        RowBox[{"N", "[", "tau", "]"}], ",", 
        RowBox[{"FRouteListToByte", "[", "route1", "]"}], ",", 
        RowBox[{"FRouteListToByte", "[", "route2", "]"}], ",", "usemicrotime",
         ",", "mode"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Which", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FOutput", "]"}], " ", "===", " ", 
        "FGraph"}], ",", "\[IndentingNewLine]", 
       RowBox[{"(", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"dat", "=", 
          RowBox[{"N", "@", 
           RowBox[{"FCorrelTransformRawData", "@", "dat"}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"dat", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "1"}], "]"}], "]"}], "=", 
          RowBox[{"Log", "[", 
           RowBox[{"10.", ",", 
            RowBox[{"dat", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "1"}], "]"}], "]"}]}], "]"}]}], ";", 
         RowBox[{"ListPlot", "[", 
          RowBox[{"dat", ",", 
           RowBox[{"FilterRules", "[", 
            RowBox[{
             RowBox[{"{", "opts", "}"}], ",", " ", 
             RowBox[{"Options", "[", "ListPlot", "]"}]}], "]"}], ",", 
           RowBox[{"Joined", "->", "True"}], ",", 
           RowBox[{"PlotRange", "->", "All"}], ",", 
           RowBox[{"Frame", "->", "True"}], ",", 
           RowBox[{"Axes", "->", "False"}], ",", 
           RowBox[{"FrameLabel", "->", 
            RowBox[{"{", 
             RowBox[{
             "\"\<log(\[Tau]/sec)\>\"", ",", " ", "\"\<G(\[Tau])\>\""}], 
             "}"}]}], ",", 
           RowBox[{"LabelStyle", "->", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"FontFamily", "->", " ", "\"\<Helvetica\>\""}], ",", 
              RowBox[{"FontSize", "->", " ", "Medium"}], ",", 
              RowBox[{"FontWeight", "->", " ", "Bold"}]}], "}"}]}]}], "]"}]}],
         "\[IndentingNewLine]", ")"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FData"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"(", "\[IndentingNewLine]", 
        RowBox[{"N", "@", 
         RowBox[{"FCorrelTransformRawData", "@", "dat"}]}], 
        "\[IndentingNewLine]", ")"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FRawData"}], 
       ",", "\[IndentingNewLine]", 
       RowBox[{
       "(", "\[IndentingNewLine]", "dat", "\[IndentingNewLine]", ")"}]}], 
      "\[IndentingNewLine]", "]"}]}]}], "\n", "]"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FFCS", "[", 
    RowBox[{
     RowBox[{"tau", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
     RowBox[{"route1", ":", "FRouteList"}], ",", 
     RowBox[{"route2", ":", "FRouteList"}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"FFCS", "[", 
    RowBox[{"tau", ",", "route1", ",", "route2", ",", 
     RowBox[{"-", "1."}], ",", 
     RowBox[{"-", "1."}], ",", "opts"}], "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{"FFCS", "[", 
   RowBox[{
    RowBox[{"tau", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
    RowBox[{"route1", ":", "FRouteList"}], ",", 
    RowBox[{"route2", ":", "FRouteList"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"ch11_", "?", "FValidChannelQ"}], " ", ",", 
      RowBox[{"ch12_", "?", "FValidChannelQ"}]}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"ch21_", "?", "FValidChannelQ"}], " ", ",", 
      RowBox[{"ch22_", "?", "FValidChannelQ"}]}], "}"}], ",", 
    RowBox[{"tstart_", "?", "NumberQ"}], ",", 
    RowBox[{"tstop_", "?", "NumberQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"mode", "=", "0"}], ",", "dat", ",", "usemicrotime"}], "}"}], 
    ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"Which", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", "All"}], ",", 
       RowBox[{"mode", "=", "0"}], ",", "\n", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{
          RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", 
          "FBursts"}], ",", 
         RowBox[{"mode", "=", "1"}], ","}], "*)"}], "\n", 
       RowBox[{
       "(*", "\"\<OptionValue[FPhotonData]===FNonBursts,mode=2,\>\"", "*)"}], 
       RowBox[{
        RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", 
        "FSelectedBursts"}], ",", 
       RowBox[{"mode", "=", "2"}], ",", "\[IndentingNewLine]", "True", ",", 
       " ", 
       RowBox[{"Return", "[", "$Failed", "]"}]}], "\[IndentingNewLine]", 
      "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"usemicrotime", "=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "FUseMicrotime", "]"}], "===", "True"}], 
        ",", "1", ",", "0"}], "]"}]}], ";", 
     RowBox[{"dat", "=", 
      RowBox[{"FFCSStr", "[", 
       RowBox[{
        RowBox[{"N", "[", "tstart", "]"}], ",", 
        RowBox[{"N", "[", "tstop", "]"}], ",", 
        RowBox[{"N", "[", "tau", "]"}], ",", 
        RowBox[{"FRouteListToByte", "[", "route1", "]"}], ",", 
        RowBox[{"FRouteListToByte", "[", "route2", "]"}], ",", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"ch11", ",", "ch12"}], "}"}], "-", "1"}], ",", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"ch21", ",", "ch22"}], "}"}], "-", "1"}], ",", 
        "usemicrotime", ",", "mode"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Which", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FOutput", "]"}], " ", "===", " ", 
        "FGraph"}], ",", "\[IndentingNewLine]", 
       RowBox[{"(", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"dat", "=", 
          RowBox[{"N", "@", 
           RowBox[{"FCorrelTransformRawData", "@", "dat"}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"dat", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "1"}], "]"}], "]"}], "=", 
          RowBox[{"Log", "[", 
           RowBox[{"10.", ",", 
            RowBox[{"dat", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "1"}], "]"}], "]"}]}], "]"}]}], ";", 
         RowBox[{"ListPlot", "[", 
          RowBox[{"dat", ",", 
           RowBox[{"FilterRules", "[", 
            RowBox[{
             RowBox[{"{", "opts", "}"}], ",", " ", 
             RowBox[{"Options", "[", "ListPlot", "]"}]}], "]"}], ",", 
           RowBox[{"Joined", "->", "True"}], ",", 
           RowBox[{"PlotRange", "->", "All"}], ",", 
           RowBox[{"Frame", "->", "True"}], ",", 
           RowBox[{"Axes", "->", "False"}], ",", 
           RowBox[{"FrameLabel", "->", 
            RowBox[{"{", 
             RowBox[{
             "\"\<log(\[Tau]/sec)\>\"", ",", " ", "\"\<G(\[Tau])\>\""}], 
             "}"}]}], ",", 
           RowBox[{"LabelStyle", "->", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"FontFamily", "->", " ", "\"\<Helvetica\>\""}], ",", 
              RowBox[{"FontSize", "->", " ", "Medium"}], ",", 
              RowBox[{"FontWeight", "->", " ", "Bold"}]}], "}"}]}]}], "]"}]}],
         "\[IndentingNewLine]", ")"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FData"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"(", "\[IndentingNewLine]", 
        RowBox[{"N", "@", 
         RowBox[{"FCorrelTransformRawData", "@", "dat"}]}], 
        "\[IndentingNewLine]", ")"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FRawData"}], 
       ",", "\[IndentingNewLine]", 
       RowBox[{
       "(", "\[IndentingNewLine]", "dat", "\[IndentingNewLine]", ")"}]}], 
      "\[IndentingNewLine]", "]"}]}]}], "\n", "]"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FFCS", "[", 
    RowBox[{
     RowBox[{"tau", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
     RowBox[{"route1", ":", "FRouteList"}], ",", 
     RowBox[{"route2", ":", "FRouteList"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"ch11_", "?", "FValidChannelQ"}], " ", ",", 
       RowBox[{"ch12_", "?", "FValidChannelQ"}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"ch21_", "?", "FValidChannelQ"}], " ", ",", 
       RowBox[{"ch22_", "?", "FValidChannelQ"}]}], "}"}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"FFCS", "[", 
    RowBox[{"tau", ",", "route1", ",", "route2", ",", 
     RowBox[{"{", 
      RowBox[{"ch11", " ", ",", "ch12"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"ch21", " ", ",", "ch22"}], "}"}], ",", 
     RowBox[{"-", "1."}], ",", 
     RowBox[{"-", "1."}], ",", "opts"}], "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{"FFCS", "[", 
   RowBox[{
    RowBox[{"logtaumin_", "?", "NumberQ"}], ",", 
    RowBox[{"logtaumax_", "?", "NumberQ"}], ",", 
    RowBox[{"dlogtau_", "?", "NumberQ"}], ",", 
    RowBox[{"route1", ":", "FRouteList"}], ",", 
    RowBox[{"route2", ":", "FRouteList"}], ",", 
    RowBox[{"tstart_", "?", "NumberQ"}], ",", 
    RowBox[{"tstop_", "?", "NumberQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"FFCS", "[", 
   RowBox[{
    RowBox[{"Table", "[", 
     RowBox[{
      RowBox[{"10", "^", "logt"}], ",", 
      RowBox[{"{", 
       RowBox[{"logt", ",", "logtaumin", ",", "logtaumax", ",", "dlogtau"}], 
       "}"}]}], "]"}], ",", "route1", ",", "route2", ",", "tstart", ",", 
    "tstop", ",", "opts"}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FFCS", "[", 
   RowBox[{
    RowBox[{"logtaumin_", "?", "NumberQ"}], ",", 
    RowBox[{"logtaumax_", "?", "NumberQ"}], ",", 
    RowBox[{"dlogtau_", "?", "NumberQ"}], ",", 
    RowBox[{"route1", ":", "FRouteList"}], ",", 
    RowBox[{"route2", ":", "FRouteList"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", "\n", 
  RowBox[{"FFCS", "[", 
   RowBox[{
   "logtaumin", ",", "logtaumax", ",", "dlogtau", ",", "route1", ",", 
    "route2", ",", 
    RowBox[{"-", "1."}], ",", 
    RowBox[{"-", "1."}], ",", "opts"}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FFCS", "[", 
   RowBox[{
    RowBox[{"logtaumin_", "?", "NumberQ"}], ",", 
    RowBox[{"logtaumax_", "?", "NumberQ"}], ",", 
    RowBox[{"dlogtau_", "?", "NumberQ"}], ",", 
    RowBox[{"route1", ":", "FRouteList"}], ",", 
    RowBox[{"route2", ":", "FRouteList"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"ch11_", "?", "FValidChannelQ"}], " ", ",", 
      RowBox[{"ch12_", "?", "FValidChannelQ"}]}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"ch21_", "?", "FValidChannelQ"}], " ", ",", 
      RowBox[{"ch22_", "?", "FValidChannelQ"}]}], "}"}], ",", 
    RowBox[{"tstart_", "?", "NumberQ"}], ",", 
    RowBox[{"tstop_", "?", "NumberQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"FFCS", "[", 
   RowBox[{
    RowBox[{"Table", "[", 
     RowBox[{
      RowBox[{"10", "^", "logt"}], ",", 
      RowBox[{"{", 
       RowBox[{"logt", ",", "logtaumin", ",", "logtaumax", ",", "dlogtau"}], 
       "}"}]}], "]"}], ",", "route1", ",", "route2", ",", 
    RowBox[{"{", 
     RowBox[{"ch11", ",", "ch12"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"ch21", ",", "ch22"}], "}"}], ",", "tstart", ",", "tstop", ",", 
    "opts"}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FFCS", "[", 
   RowBox[{
    RowBox[{"logtaumin_", "?", "NumberQ"}], ",", 
    RowBox[{"logtaumax_", "?", "NumberQ"}], ",", 
    RowBox[{"dlogtau_", "?", "NumberQ"}], ",", 
    RowBox[{"route1", ":", "FRouteList"}], ",", 
    RowBox[{"route2", ":", "FRouteList"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"ch11_", "?", "FValidChannelQ"}], " ", ",", 
      RowBox[{"ch12_", "?", "FValidChannelQ"}]}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"ch21_", "?", "FValidChannelQ"}], " ", ",", 
      RowBox[{"ch22_", "?", "FValidChannelQ"}]}], "}"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"FFCS", "[", 
   RowBox[{
   "logtaumin", ",", "logtaumax", ",", "dlogtau", ",", "route1", ",", 
    "route2", ",", 
    RowBox[{"{", 
     RowBox[{"ch11", ",", "ch12"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"ch21", ",", "ch22"}], "}"}], ",", 
    RowBox[{"-", "1."}], ",", 
    RowBox[{"-", "1"}], ",", "opts"}], "]"}]}], "\n"}], "Input",
 CellChangeTimes->{{3.7506741774346876`*^9, 3.7506741836909204`*^9}, {
   3.750674234188903*^9, 3.750674242653223*^9}, {3.750674282660215*^9, 
   3.7506743398353424`*^9}, {3.7506743719783287`*^9, 3.750674422865224*^9}, {
   3.7506744557044044`*^9, 3.7506744994593663`*^9}, {3.765187771477013*^9, 
   3.7651877726874185`*^9}, {3.7924973883912697`*^9, 3.792497412256469*^9}, {
   3.8302377673740425`*^9, 3.830237815758135*^9}, {3.830237878308279*^9, 
   3.830237966008378*^9}, {3.830238020338499*^9, 3.8302381123469334`*^9}, {
   3.830255248339811*^9, 3.8302552503469677`*^9}, {3.8302553443042064`*^9, 
   3.830255371268916*^9}, {3.8302554432669463`*^9, 3.830255476431178*^9}, 
   3.830317261019248*^9},ExpressionUUID->"e610a7a9-c345-421b-abf1-\
8942f797ae83"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FFCS", "[", 
   RowBox[{
    RowBox[{"tau", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
    RowBox[{"routepairs", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"MatchQ", "[", 
             RowBox[{"#", ",", "FRouteList"}], "]"}], "&"}], ")"}]}], ",", 
         RowBox[{"_", "?", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"MatchQ", "[", 
             RowBox[{"#", ",", "FRouteList"}], "]"}], "&"}], ")"}]}]}], "}"}],
        ".."}], "}"}]}], ",", 
    RowBox[{"tstart_", "?", "NumberQ"}], ",", 
    RowBox[{"tstop_", "?", "NumberQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", "\n", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"mode", "=", "0"}], ",", "dat", ",", "usemicrotime"}], "}"}], 
    ",", "\n", 
    RowBox[{
     RowBox[{"Which", "[", "\n", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", "All"}], ",", 
       RowBox[{"mode", "=", "0"}], ",", "\n", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{
          RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", 
          "FBursts"}], ",", 
         RowBox[{"mode", "=", "1"}], ","}], "*)"}], "\n", 
       RowBox[{
       "(*", "\"\<OptionValue[FPhotonData]===FNonBursts,mode=2,\>\"", "*)"}], 
       "\n", 
       RowBox[{
        RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", 
        "FSelectedBursts"}], ",", 
       RowBox[{"mode", "=", "2"}], ",", "\n", "True", ",", " ", 
       RowBox[{"Return", "[", "$Failed", "]"}]}], "\n", "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"usemicrotime", "=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "FUseMicrotime", "]"}], "===", "True"}], 
        ",", "1", ",", "0"}], "]"}]}], ";", "\n", 
     RowBox[{"dat", "=", 
      RowBox[{"FFCSParallelStr", "[", 
       RowBox[{
        RowBox[{"N", "[", "tstart", "]"}], ",", 
        RowBox[{"N", "[", "tstop", "]"}], ",", 
        RowBox[{"N", "[", "tau", "]"}], ",", 
        RowBox[{"Map", "[", 
         RowBox[{"FRouteListToByte", ",", 
          RowBox[{"Flatten", "[", 
           RowBox[{"routepairs", ",", "1"}], "]"}]}], "]"}], ",", 
        "usemicrotime", ",", "mode"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Which", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FOutput", "]"}], " ", "===", " ", 
        "FGraph"}], ",", "\[IndentingNewLine]", 
       RowBox[{"(", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"dat", "=", 
          RowBox[{"N", "@", 
           RowBox[{"Map", "[", 
            RowBox[{"FCorrelTransformRawData", ",", "dat"}], "]"}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"dat", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "All", ",", "1"}], "]"}], "]"}], "=", 
          RowBox[{"Log", "[", 
           RowBox[{"10.", ",", 
            RowBox[{"dat", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "All", ",", "1"}], "]"}], "]"}]}], "]"}]}], 
         ";", 
         RowBox[{"ListPlot", "[", 
          RowBox[{"dat", ",", 
           RowBox[{"FilterRules", "[", 
            RowBox[{
             RowBox[{"{", "opts", "}"}], ",", " ", 
             RowBox[{"Options", "[", "ListPlot", "]"}]}], "]"}], ",", 
           RowBox[{"Joined", "->", "True"}], ",", 
           RowBox[{"PlotRange", "->", "All"}], ",", 
           RowBox[{"Frame", "->", "True"}], ",", 
           RowBox[{"Axes", "->", "False"}], ",", 
           RowBox[{"FrameLabel", "->", 
            RowBox[{"{", 
             RowBox[{
             "\"\<log(\[Tau]/sec)\>\"", ",", " ", "\"\<G(\[Tau])\>\""}], 
             "}"}]}], ",", 
           RowBox[{"LabelStyle", "->", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"FontFamily", "->", " ", "\"\<Helvetica\>\""}], ",", 
              RowBox[{"FontSize", "->", " ", "Medium"}], ",", 
              RowBox[{"FontWeight", "->", " ", "Bold"}]}], "}"}]}]}], "]"}]}],
         "\[IndentingNewLine]", ")"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FData"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"(", "\[IndentingNewLine]", 
        RowBox[{"N", "@", 
         RowBox[{"Map", "[", 
          RowBox[{"FCorrelTransformRawData", ",", "dat"}], "]"}]}], 
        "\[IndentingNewLine]", ")"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FRawData"}], 
       ",", "\[IndentingNewLine]", 
       RowBox[{
       "(", "\[IndentingNewLine]", "dat", "\[IndentingNewLine]", ")"}]}], 
      "\[IndentingNewLine]", "]"}]}]}], "\n", "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FFCS", "[", 
   RowBox[{
    RowBox[{"tau", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
    RowBox[{"routepairs", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"MatchQ", "[", 
             RowBox[{"#", ",", "FRouteList"}], "]"}], "&"}], ")"}]}], ",", 
         RowBox[{"_", "?", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"MatchQ", "[", 
             RowBox[{"#", ",", "FRouteList"}], "]"}], "&"}], ")"}]}]}], "}"}],
        ".."}], "}"}]}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"FFCS", "[", 
   RowBox[{"tau", ",", "routepairs", ",", 
    RowBox[{"-", "1."}], ",", 
    RowBox[{"-", "1."}], ",", "opts"}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FFCS", "[", 
   RowBox[{
    RowBox[{"logtaumin_", "?", "NumberQ"}], ",", 
    RowBox[{"logtaumax_", "?", "NumberQ"}], ",", 
    RowBox[{"dlogtau_", "?", "NumberQ"}], ",", 
    RowBox[{"routepairs", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"MatchQ", "[", 
             RowBox[{"#", ",", "FRouteList"}], "]"}], "&"}], ")"}]}], ",", 
         RowBox[{"_", "?", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"MatchQ", "[", 
             RowBox[{"#", ",", "FRouteList"}], "]"}], "&"}], ")"}]}]}], "}"}],
        ".."}], "}"}]}], ",", 
    RowBox[{"tstart_", "?", "NumberQ"}], ",", 
    RowBox[{"tstop_", "?", "NumberQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"FFCS", "[", 
   RowBox[{
    RowBox[{"Table", "[", 
     RowBox[{
      RowBox[{"10", "^", "logt"}], ",", 
      RowBox[{"{", 
       RowBox[{"logt", ",", "logtaumin", ",", "logtaumax", ",", "dlogtau"}], 
       "}"}]}], "]"}], ",", "routepairs", ",", "tstart", ",", "tstop", ",", 
    "opts"}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FFCS", "[", 
    RowBox[{
     RowBox[{"logtaumin_", "?", "NumberQ"}], ",", 
     RowBox[{"logtaumax_", "?", "NumberQ"}], ",", 
     RowBox[{"dlogtau_", "?", "NumberQ"}], ",", 
     RowBox[{"routepairs", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"MatchQ", "[", 
              RowBox[{"#", ",", "FRouteList"}], "]"}], "&"}], ")"}]}], ",", 
          RowBox[{"_", "?", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"MatchQ", "[", 
              RowBox[{"#", ",", "FRouteList"}], "]"}], "&"}], ")"}]}]}], 
         "}"}], ".."}], "}"}]}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", "\n", 
   RowBox[{"FFCS", "[", 
    RowBox[{
    "logtaumin", ",", "logtaumax", ",", "dlogtau", ",", "routepairs", ",", 
     RowBox[{"-", "1."}], ",", 
     RowBox[{"-", "1."}], ",", "opts"}], "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{"FFCS", "[", 
   RowBox[{
    RowBox[{"tau", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
    RowBox[{"routepairs", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"MatchQ", "[", 
             RowBox[{"#", ",", "FRouteList"}], "]"}], "&"}], ")"}]}], ",", 
         RowBox[{"_", "?", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"MatchQ", "[", 
             RowBox[{"#", ",", "FRouteList"}], "]"}], "&"}], ")"}]}]}], "}"}],
        ".."}], "}"}]}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"ch11_", "?", "FValidChannelQ"}], " ", ",", 
      RowBox[{"ch12_", "?", "FValidChannelQ"}]}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"ch21_", "?", "FValidChannelQ"}], " ", ",", 
      RowBox[{"ch22_", "?", "FValidChannelQ"}]}], "}"}], ",", 
    RowBox[{"tstart_", "?", "NumberQ"}], ",", 
    RowBox[{"tstop_", "?", "NumberQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"mode", "=", "0"}], ",", "dat", ",", "usemicrotime"}], "}"}], 
    ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"Which", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", "All"}], ",", 
       RowBox[{"mode", "=", "0"}], ",", "\n", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{
          RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", 
          "FBursts"}], ",", 
         RowBox[{"mode", "=", "1"}], ","}], "*)"}], "\n", 
       RowBox[{
       "(*", "\"\<OptionValue[FPhotonData]===FNonBursts,mode=2,\>\"", "*)"}], 
       RowBox[{
        RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", 
        "FSelectedBursts"}], ",", 
       RowBox[{"mode", "=", "2"}], ",", "\[IndentingNewLine]", "True", ",", 
       " ", 
       RowBox[{"Return", "[", "$Failed", "]"}]}], "\[IndentingNewLine]", 
      "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"usemicrotime", "=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "FUseMicrotime", "]"}], "===", "True"}], 
        ",", "1", ",", "0"}], "]"}]}], ";", 
     RowBox[{"dat", "=", 
      RowBox[{"FFCSParallelStr", "[", 
       RowBox[{
        RowBox[{"N", "[", "tstart", "]"}], ",", 
        RowBox[{"N", "[", "tstop", "]"}], ",", 
        RowBox[{"N", "[", "tau", "]"}], ",", 
        RowBox[{"Map", "[", 
         RowBox[{"FRouteListToByte", ",", 
          RowBox[{"Flatten", "[", 
           RowBox[{"routepairs", ",", "1"}], "]"}]}], "]"}], ",", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"ch11", ",", "ch12"}], "}"}], "-", "1"}], ",", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"ch21", ",", "ch22"}], "}"}], "-", "1"}], ",", 
        "usemicrotime", ",", "mode"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Which", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FOutput", "]"}], " ", "===", " ", 
        "FGraph"}], ",", "\[IndentingNewLine]", 
       RowBox[{"(", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"dat", "=", 
          RowBox[{"N", "@", 
           RowBox[{"Map", "[", 
            RowBox[{"FCorrelTransformRawData", ",", "dat"}], "]"}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"dat", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "All", ",", "1"}], "]"}], "]"}], "=", 
          RowBox[{"Log", "[", 
           RowBox[{"10.", ",", 
            RowBox[{"dat", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "All", ",", "1"}], "]"}], "]"}]}], "]"}]}], 
         ";", 
         RowBox[{"ListPlot", "[", 
          RowBox[{"dat", ",", 
           RowBox[{"FilterRules", "[", 
            RowBox[{
             RowBox[{"{", "opts", "}"}], ",", " ", 
             RowBox[{"Options", "[", "ListPlot", "]"}]}], "]"}], ",", 
           RowBox[{"Joined", "->", "True"}], ",", 
           RowBox[{"PlotRange", "->", "All"}], ",", 
           RowBox[{"Frame", "->", "True"}], ",", 
           RowBox[{"Axes", "->", "False"}], ",", 
           RowBox[{"FrameLabel", "->", 
            RowBox[{"{", 
             RowBox[{
             "\"\<log(\[Tau]/sec)\>\"", ",", " ", "\"\<G(\[Tau])\>\""}], 
             "}"}]}], ",", 
           RowBox[{"LabelStyle", "->", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"FontFamily", "->", " ", "\"\<Helvetica\>\""}], ",", 
              RowBox[{"FontSize", "->", " ", "Medium"}], ",", 
              RowBox[{"FontWeight", "->", " ", "Bold"}]}], "}"}]}]}], "]"}]}],
         "\[IndentingNewLine]", ")"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FData"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"(", "\[IndentingNewLine]", 
        RowBox[{"N", "@", 
         RowBox[{"Map", "[", 
          RowBox[{"FCorrelTransformRawData", ",", "dat"}], "]"}]}], 
        "\[IndentingNewLine]", ")"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FRawData"}], 
       ",", "\[IndentingNewLine]", 
       RowBox[{
       "(", "\[IndentingNewLine]", "dat", "\[IndentingNewLine]", ")"}]}], 
      "\[IndentingNewLine]", "]"}]}]}], "\n", "]"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FFCS", "[", 
    RowBox[{
     RowBox[{"tau", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
     RowBox[{"routepairs", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"MatchQ", "[", 
              RowBox[{"#", ",", "FRouteList"}], "]"}], "&"}], ")"}]}], ",", 
          RowBox[{"_", "?", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"MatchQ", "[", 
              RowBox[{"#", ",", "FRouteList"}], "]"}], "&"}], ")"}]}]}], 
         "}"}], ".."}], "}"}]}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"ch11_", "?", "FValidChannelQ"}], " ", ",", 
       RowBox[{"ch12_", "?", "FValidChannelQ"}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"ch21_", "?", "FValidChannelQ"}], " ", ",", 
       RowBox[{"ch22_", "?", "FValidChannelQ"}]}], "}"}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"FFCS", "[", 
    RowBox[{"tau", ",", "routepairs", ",", 
     RowBox[{"{", 
      RowBox[{"ch11", " ", ",", "ch12"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"ch21", " ", ",", "ch22"}], "}"}], ",", 
     RowBox[{"-", "1."}], ",", 
     RowBox[{"-", "1."}], ",", "opts"}], "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{"FFCS", "[", 
   RowBox[{
    RowBox[{"tau", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
    RowBox[{"params", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"MatchQ", "[", 
               RowBox[{"#", ",", "FRouteList"}], "]"}], "&"}], ")"}]}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"_", "?", "FValidChannelQ"}], " ", ",", 
             RowBox[{"_", "?", "FValidChannelQ"}]}], "}"}]}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"MatchQ", "[", 
               RowBox[{"#", ",", "FRouteList"}], "]"}], "&"}], ")"}]}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"_", "?", "FValidChannelQ"}], " ", ",", 
             RowBox[{"_", "?", "FValidChannelQ"}]}], "}"}]}], "}"}]}], "}"}], 
       ".."}], "}"}]}], ",", 
    RowBox[{"tstart_", "?", "NumberQ"}], ",", 
    RowBox[{"tstop_", "?", "NumberQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"params2", ",", 
      RowBox[{"mode", "=", "0"}], ",", "dat", ",", "usemicrotime"}], "}"}], 
    ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"params2", "=", 
      RowBox[{"Map", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"FRouteListToByte", "[", 
            RowBox[{"#", "[", 
             RowBox[{"[", 
              RowBox[{"1", ",", "1"}], "]"}], "]"}], "]"}], ",", 
           RowBox[{"FRouteListToByte", "[", 
            RowBox[{"#", "[", 
             RowBox[{"[", 
              RowBox[{"2", ",", "1"}], "]"}], "]"}], "]"}], ",", 
           RowBox[{"Sequence", "@@", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"#", "[", 
               RowBox[{"[", 
                RowBox[{"1", ",", "2"}], "]"}], "]"}], "-", "1"}], ")"}]}], 
           ",", 
           RowBox[{"Sequence", "@@", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"#", "[", 
               RowBox[{"[", 
                RowBox[{"2", ",", "2"}], "]"}], "]"}], "-", "1"}], ")"}]}]}], 
          "}"}], "&"}], ",", "params"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Which", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", "All"}], ",", 
       RowBox[{"mode", "=", "0"}], ",", "\n", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{
          RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", 
          "FBursts"}], ",", 
         RowBox[{"mode", "=", "1"}], ","}], "*)"}], "\n", 
       RowBox[{
       "(*", "\"\<OptionValue[FPhotonData]===FNonBursts,mode=2,\>\"", "*)"}], 
       RowBox[{
        RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", 
        "FSelectedBursts"}], ",", 
       RowBox[{"mode", "=", "2"}], ",", "\[IndentingNewLine]", "True", ",", 
       " ", 
       RowBox[{"Return", "[", "$Failed", "]"}]}], "\[IndentingNewLine]", 
      "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"usemicrotime", "=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "FUseMicrotime", "]"}], "===", "True"}], 
        ",", "1", ",", "0"}], "]"}]}], ";", 
     RowBox[{"dat", "=", 
      RowBox[{"FFCSWithChannelConstraintsParallelStr", "[", 
       RowBox[{
        RowBox[{"N", "[", "tstart", "]"}], ",", 
        RowBox[{"N", "[", "tstop", "]"}], ",", 
        RowBox[{"N", "[", "tau", "]"}], ",", "usemicrotime", ",", "mode", ",",
         "params2"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Which", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FOutput", "]"}], " ", "===", " ", 
        "FGraph"}], ",", "\[IndentingNewLine]", 
       RowBox[{"(", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"dat", "=", 
          RowBox[{"N", "@", 
           RowBox[{"Map", "[", 
            RowBox[{"FCorrelTransformRawData", ",", "dat"}], "]"}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"dat", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "All", ",", "1"}], "]"}], "]"}], "=", 
          RowBox[{"Log", "[", 
           RowBox[{"10.", ",", 
            RowBox[{"dat", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "All", ",", "1"}], "]"}], "]"}]}], "]"}]}], 
         ";", 
         RowBox[{"ListPlot", "[", 
          RowBox[{"dat", ",", 
           RowBox[{"FilterRules", "[", 
            RowBox[{
             RowBox[{"{", "opts", "}"}], ",", " ", 
             RowBox[{"Options", "[", "ListPlot", "]"}]}], "]"}], ",", 
           RowBox[{"Joined", "->", "True"}], ",", 
           RowBox[{"PlotRange", "->", "All"}], ",", 
           RowBox[{"Frame", "->", "True"}], ",", 
           RowBox[{"Axes", "->", "False"}], ",", 
           RowBox[{"FrameLabel", "->", 
            RowBox[{"{", 
             RowBox[{
             "\"\<log(\[Tau]/sec)\>\"", ",", " ", "\"\<G(\[Tau])\>\""}], 
             "}"}]}], ",", 
           RowBox[{"LabelStyle", "->", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"FontFamily", "->", " ", "\"\<Helvetica\>\""}], ",", 
              RowBox[{"FontSize", "->", " ", "Medium"}], ",", 
              RowBox[{"FontWeight", "->", " ", "Bold"}]}], "}"}]}]}], "]"}]}],
         "\[IndentingNewLine]", ")"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FData"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"(", "\[IndentingNewLine]", 
        RowBox[{"N", "@", 
         RowBox[{"Map", "[", 
          RowBox[{"FCorrelTransformRawData", ",", "dat"}], "]"}]}], 
        "\[IndentingNewLine]", ")"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FRawData"}], 
       ",", "\[IndentingNewLine]", 
       RowBox[{
       "(", "\[IndentingNewLine]", "dat", "\[IndentingNewLine]", ")"}]}], 
      "\[IndentingNewLine]", "]"}]}]}], "\n", "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FFCS", "[", 
   RowBox[{
    RowBox[{"tau", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
    RowBox[{"params", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"MatchQ", "[", 
               RowBox[{"#", ",", "FRouteList"}], "]"}], "&"}], ")"}]}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"_", "?", "FValidChannelQ"}], " ", ",", 
             RowBox[{"_", "?", "FValidChannelQ"}]}], "}"}]}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"MatchQ", "[", 
               RowBox[{"#", ",", "FRouteList"}], "]"}], "&"}], ")"}]}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"_", "?", "FValidChannelQ"}], " ", ",", 
             RowBox[{"_", "?", "FValidChannelQ"}]}], "}"}]}], "}"}]}], "}"}], 
       ".."}], "}"}]}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"FFCS", "[", 
   RowBox[{"tau", ",", "params", ",", 
    RowBox[{"-", "1."}], ",", 
    RowBox[{
     RowBox[{"-", "1."}], "opts"}]}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FFCS", "[", 
   RowBox[{
    RowBox[{"logtaumin_", "?", "NumberQ"}], ",", 
    RowBox[{"logtaumax_", "?", "NumberQ"}], ",", 
    RowBox[{"dlogtau_", "?", "NumberQ"}], ",", 
    RowBox[{"params", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"MatchQ", "[", 
               RowBox[{"#", ",", "FRouteList"}], "]"}], "&"}], ")"}]}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"_", "?", "FValidChannelQ"}], " ", ",", 
             RowBox[{"_", "?", "FValidChannelQ"}]}], "}"}]}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"MatchQ", "[", 
               RowBox[{"#", ",", "FRouteList"}], "]"}], "&"}], ")"}]}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"_", "?", "FValidChannelQ"}], " ", ",", 
             RowBox[{"_", "?", "FValidChannelQ"}]}], "}"}]}], "}"}]}], "}"}], 
       ".."}], "}"}]}], ",", 
    RowBox[{"tstart_", "?", "NumberQ"}], ",", 
    RowBox[{"tstop_", "?", "NumberQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"FFCS", "[", 
   RowBox[{
    RowBox[{"Table", "[", 
     RowBox[{
      RowBox[{"10", "^", "logt"}], ",", 
      RowBox[{"{", 
       RowBox[{"logt", ",", "logtaumin", ",", "logtaumax", ",", "dlogtau"}], 
       "}"}]}], "]"}], ",", "params", ",", "tstart", ",", "tstop", ",", 
    "opts"}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FFCS", "[", 
   RowBox[{
    RowBox[{"logtaumin_", "?", "NumberQ"}], ",", 
    RowBox[{"logtaumax_", "?", "NumberQ"}], ",", 
    RowBox[{"dlogtau_", "?", "NumberQ"}], ",", 
    RowBox[{"params", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"MatchQ", "[", 
               RowBox[{"#", ",", "FRouteList"}], "]"}], "&"}], ")"}]}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"_", "?", "FValidChannelQ"}], " ", ",", 
             RowBox[{"_", "?", "FValidChannelQ"}]}], "}"}]}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"MatchQ", "[", 
               RowBox[{"#", ",", "FRouteList"}], "]"}], "&"}], ")"}]}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"_", "?", "FValidChannelQ"}], " ", ",", 
             RowBox[{"_", "?", "FValidChannelQ"}]}], "}"}]}], "}"}]}], "}"}], 
       ".."}], "}"}]}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"FFCS", "[", 
   RowBox[{"logtaumin", ",", "logtaumax", ",", "dlogtau", ",", "params", ",", 
    RowBox[{"-", "1."}], ",", 
    RowBox[{"-", "1."}], ",", "opts"}], "]"}]}], "\n"}], "Input",
 CellChangeTimes->{{3.7506745891115866`*^9, 3.7506747210537*^9}, 
   3.7506777301431494`*^9, {3.7651877739690976`*^9, 3.765187775918412*^9}, {
   3.79249744828203*^9, 3.792497520648415*^9}, {3.7928187213819304`*^9, 
   3.7928187346385164`*^9}, {3.792818772381503*^9, 3.792818822197217*^9}, 
   3.8075945619991083`*^9, 3.807594611141698*^9, {3.8075965114121094`*^9, 
   3.807596552275798*^9}, {3.807597019526623*^9, 3.8075970571200953`*^9}, {
   3.830255540017315*^9, 3.830255549317852*^9}, {3.830255702564227*^9, 
   3.830255708638633*^9}, 3.830255749860718*^9, {3.8302557894170036`*^9, 
   3.8302558040204697`*^9}, {3.8302558706185126`*^9, 3.8302558968090544`*^9}, 
   3.830255970476919*^9, {3.8302560049662976`*^9, 3.8302560055802083`*^9}, {
   3.8302560421827183`*^9, 3.8302560652014713`*^9}, {3.830256120703701*^9, 
   3.8302562149833775`*^9}},ExpressionUUID->"066bc509-88f8-409a-a289-\
982b26641e86"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FFCSW", "]"}], "=", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"FPhotonData", "->", "All"}], ",", 
      RowBox[{"FNumberOfStepsInCascade", "->", "10"}], ",", 
      RowBox[{"FOutput", "->", "FData"}], ",", " ", 
      RowBox[{"FUseMicrotime", "\[Rule]", "False"}]}], "}"}], "~", "Join", 
    "~", " ", 
    RowBox[{"Options", "[", "ListPlot", "]"}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FFCSW", "[", 
    RowBox[{
     RowBox[{"logtaumin_", "?", "NumberQ"}], ",", 
     RowBox[{"logtaumax_", "?", "NumberQ"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"route1", ":", "FRouteList"}], ",", 
       RowBox[{"weights1", ":", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"route2", ":", "FRouteList"}], ",", 
       RowBox[{"weights2", ":", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}]}], "}"}], ",", 
     RowBox[{"tstart_", "?", "NumberQ"}], ",", 
     RowBox[{"tstop_", "?", "NumberQ"}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"mode", "=", "0"}], ",", 
       RowBox[{"B", "=", "10"}], ",", "dat"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Which", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", "All"}], 
        ",", 
        RowBox[{"mode", "=", "0"}], ",", "\n", 
        RowBox[{"(*", 
         RowBox[{
          RowBox[{
           RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", 
           "FBursts"}], ",", 
          RowBox[{"mode", "=", "1"}], ","}], "*)"}], "\n", 
        RowBox[{
        "(*", "\"\<OptionValue[FPhotonData]===FNonBursts,mode=2,\>\"", "*)"}], 
        RowBox[{
         RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", 
         "FSelectedBursts"}], ",", 
        RowBox[{"mode", "=", "2"}], ",", "\[IndentingNewLine]", "True", ",", 
        " ", 
        RowBox[{"Return", "[", "$Failed", "]"}]}], "\[IndentingNewLine]", 
       "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"B", "=", 
       RowBox[{"OptionValue", "[", "FNumberOfStepsInCascade", "]"}]}], ";", 
      RowBox[{"dat", "=", 
       RowBox[{"FFCSWeightedStr", "[", 
        RowBox[{
         RowBox[{"N", "[", "tstart", "]"}], ",", 
         RowBox[{"N", "[", "tstop", "]"}], ",", 
         RowBox[{"N", "[", 
          RowBox[{"10", "^", "logtaumin"}], "]"}], ",", 
         RowBox[{"N", "[", 
          RowBox[{"10", "^", "logtaumax"}], "]"}], ",", "B", ",", 
         RowBox[{"FRouteListToByte", "[", "route1", "]"}], ",", 
         RowBox[{"FRouteListToByte", "[", "route2", "]"}], ",", 
         RowBox[{"N", "@", "weights1"}], ",", 
         RowBox[{"N", "@", "weights2"}], ",", "mode"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Which", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "FOutput", "]"}], " ", "===", " ", 
         "FGraph"}], ",", "\[IndentingNewLine]", 
        RowBox[{"(", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"dat", "=", 
           RowBox[{"N", "@", 
            RowBox[{"FCorrelTransformRawData", "@", "dat"}]}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"dat", "[", 
            RowBox[{"[", 
             RowBox[{"All", ",", "1"}], "]"}], "]"}], "=", 
           RowBox[{"Log", "[", 
            RowBox[{"10.", ",", 
             RowBox[{"dat", "[", 
              RowBox[{"[", 
               RowBox[{"All", ",", "1"}], "]"}], "]"}]}], "]"}]}], ";", 
          RowBox[{"ListPlot", "[", 
           RowBox[{"dat", ",", 
            RowBox[{"FilterRules", "[", 
             RowBox[{
              RowBox[{"{", "opts", "}"}], ",", " ", 
              RowBox[{"Options", "[", "ListPlot", "]"}]}], "]"}], ",", 
            RowBox[{"Joined", "->", "True"}], ",", 
            RowBox[{"PlotRange", "->", "All"}], ",", 
            RowBox[{"Frame", "->", "True"}], ",", 
            RowBox[{"Axes", "->", "False"}], ",", 
            RowBox[{"FrameLabel", "->", 
             RowBox[{"{", 
              RowBox[{
              "\"\<log(\[Tau]/sec)\>\"", ",", " ", "\"\<G(\[Tau])\>\""}], 
              "}"}]}], ",", 
            RowBox[{"LabelStyle", "->", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"FontFamily", "->", " ", "\"\<Helvetica\>\""}], ",", 
               RowBox[{"FontSize", "->", " ", "Medium"}], ",", 
               RowBox[{"FontWeight", "->", " ", "Bold"}]}], "}"}]}]}], 
           "]"}]}], "\[IndentingNewLine]", ")"}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FData"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"(", "\[IndentingNewLine]", 
         RowBox[{"N", "@", 
          RowBox[{"FCorrelTransformRawData", "@", "dat"}]}], 
         "\[IndentingNewLine]", ")"}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FRawData"}], 
        ",", "\[IndentingNewLine]", 
        RowBox[{
        "(", "\[IndentingNewLine]", "dat", "\[IndentingNewLine]", ")"}]}], 
       "\[IndentingNewLine]", "]"}]}]}], "\n", "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FFCSW", "[", 
    RowBox[{
     RowBox[{"logtaumin_", "?", "NumberQ"}], ",", 
     RowBox[{"logtaumax_", "?", "NumberQ"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"route1", ":", "FRouteList"}], ",", 
       RowBox[{"weights1", ":", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"Rule", "[", 
           RowBox[{"_Integer", ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], "]"}], ".."}], 
         "}"}]}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"route2", ":", "FRouteList"}], ",", 
       RowBox[{"weights2", ":", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"Rule", "[", 
           RowBox[{"_Integer", ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], "]"}], ".."}], 
         "}"}]}]}], "}"}], ",", 
     RowBox[{"tstart_", "?", "NumberQ"}], ",", 
     RowBox[{"tstop_", "?", "NumberQ"}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"mode", "=", "0"}], ",", 
       RowBox[{"B", "=", "10"}], ",", "dat", ",", "w1", ",", "w2"}], "}"}], 
     ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Which", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", "All"}], 
        ",", 
        RowBox[{"mode", "=", "0"}], ",", "\n", "     ", 
        RowBox[{"(*", 
         RowBox[{
          RowBox[{
           RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", 
           "FBursts"}], ",", 
          RowBox[{"mode", "=", "1"}], ","}], "*)"}], "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", 
         "FSelectedBursts"}], ",", 
        RowBox[{"mode", "=", "2"}], ",", "\[IndentingNewLine]", "True", ",", 
        " ", 
        RowBox[{"Return", "[", "$Failed", "]"}]}], "\[IndentingNewLine]", 
       "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"B", "=", 
       RowBox[{"OptionValue", "[", "FNumberOfStepsInCascade", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"w1", "=", 
       RowBox[{
        RowBox[{"Range", "[", "FNumberOfRoutes", "]"}], "/.", "weights1"}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"w1", "=", 
       RowBox[{"Replace", "[", 
        RowBox[{"w1", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_Integer", "->", 
            RowBox[{"ConstantArray", "[", 
             RowBox[{"0.", ",", "FMaxChannel"}], "]"}]}], ",", 
           RowBox[{"x_List", ":>", 
            RowBox[{"PadRight", "[", 
             RowBox[{"x", ",", "FMaxChannel", ",", "0."}], "]"}]}]}], "}"}], 
         ",", "1"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"w2", "=", 
       RowBox[{
        RowBox[{"Range", "[", "FNumberOfRoutes", "]"}], "/.", "weights2"}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"w2", "=", 
       RowBox[{"Replace", "[", 
        RowBox[{"w2", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_Integer", "->", 
            RowBox[{"ConstantArray", "[", 
             RowBox[{"0.", ",", "FMaxChannel"}], "]"}]}], ",", 
           RowBox[{"x_List", ":>", 
            RowBox[{"PadRight", "[", 
             RowBox[{"x", ",", "FMaxChannel", ",", "0."}], "]"}]}]}], "}"}], 
         ",", "1"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"dat", "=", 
       RowBox[{"FFCSWeightedStr2", "[", 
        RowBox[{
         RowBox[{"N", "[", "tstart", "]"}], ",", 
         RowBox[{"N", "[", "tstop", "]"}], ",", 
         RowBox[{"N", "[", 
          RowBox[{"10", "^", "logtaumin"}], "]"}], ",", 
         RowBox[{"N", "[", 
          RowBox[{"10", "^", "logtaumax"}], "]"}], ",", "B", ",", 
         RowBox[{"FRouteListToByte", "[", "route1", "]"}], ",", 
         RowBox[{"FRouteListToByte", "[", "route2", "]"}], ",", "mode", ",", 
         " ", "w1", ",", " ", "w2"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Which", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "FOutput", "]"}], " ", "===", " ", 
         "FGraph"}], ",", "\[IndentingNewLine]", 
        RowBox[{"(", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"dat", "=", 
           RowBox[{"N", "@", 
            RowBox[{"FCorrelTransformRawData", "@", "dat"}]}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"dat", "[", 
            RowBox[{"[", 
             RowBox[{"All", ",", "1"}], "]"}], "]"}], "=", 
           RowBox[{"Log", "[", 
            RowBox[{"10.", ",", 
             RowBox[{"dat", "[", 
              RowBox[{"[", 
               RowBox[{"All", ",", "1"}], "]"}], "]"}]}], "]"}]}], ";", 
          RowBox[{"ListPlot", "[", 
           RowBox[{"dat", ",", 
            RowBox[{"FilterRules", "[", 
             RowBox[{
              RowBox[{"{", "opts", "}"}], ",", " ", 
              RowBox[{"Options", "[", "ListPlot", "]"}]}], "]"}], ",", 
            RowBox[{"Joined", "->", "True"}], ",", 
            RowBox[{"PlotRange", "->", "All"}], ",", 
            RowBox[{"Frame", "->", "True"}], ",", 
            RowBox[{"Axes", "->", "False"}], ",", 
            RowBox[{"FrameLabel", "->", 
             RowBox[{"{", 
              RowBox[{
              "\"\<log(\[Tau]/sec)\>\"", ",", " ", "\"\<G(\[Tau])\>\""}], 
              "}"}]}], ",", 
            RowBox[{"LabelStyle", "->", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"FontFamily", "->", " ", "\"\<Helvetica\>\""}], ",", 
               RowBox[{"FontSize", "->", " ", "Medium"}], ",", 
               RowBox[{"FontWeight", "->", " ", "Bold"}]}], "}"}]}]}], 
           "]"}]}], "\[IndentingNewLine]", ")"}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FData"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"(", "\[IndentingNewLine]", 
         RowBox[{"N", "@", 
          RowBox[{"FCorrelTransformRawData", "@", "dat"}]}], 
         "\[IndentingNewLine]", ")"}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FRawData"}], 
        ",", "\[IndentingNewLine]", 
        RowBox[{
        "(", "\[IndentingNewLine]", "dat", "\[IndentingNewLine]", ")"}]}], 
       "\[IndentingNewLine]", "]"}]}]}], "\n", "]"}]}], 
  "\n"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FFCSW", "[", 
    RowBox[{
     RowBox[{"logtaumin_", "?", "NumberQ"}], ",", 
     RowBox[{"logtaumax_", "?", "NumberQ"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"route1", ":", "FRouteList"}], ",", "weights1_"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"route2", ":", "FRouteList"}], ",", "weights2_"}], "}"}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"FFCSW", "[", 
    RowBox[{"logtaumin", ",", "logtaumax", ",", 
     RowBox[{"{", 
      RowBox[{"route1", ",", "weights1"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"route2", ",", "weights2"}], "}"}], ",", 
     RowBox[{"-", "1"}], ",", 
     RowBox[{"-", "1"}], ",", "opts"}], "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FFCSW", "[", 
    RowBox[{
     RowBox[{"logtaumin_", "?", "NumberQ"}], ",", 
     RowBox[{"logtaumax_", "?", "NumberQ"}], ",", 
     RowBox[{"route1", ":", "FRouteList"}], ",", 
     RowBox[{"route2", ":", "FRouteList"}], ",", 
     RowBox[{"tstart_", "?", "NumberQ"}], ",", 
     RowBox[{"tstop_", "?", "NumberQ"}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"FFCSW", "[", 
    RowBox[{"logtaumin", ",", "logtaumax", ",", 
     RowBox[{"{", 
      RowBox[{"route1", ",", 
       RowBox[{"ConstantArray", "[", 
        RowBox[{"1", ",", "FMaxChannel"}], "]"}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"route2", ",", 
       RowBox[{"ConstantArray", "[", 
        RowBox[{"1", ",", "FMaxChannel"}], "]"}]}], "}"}], ",", "tstart", ",",
      "tstop", ",", "opts"}], "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{"FFCSW", "[", 
   RowBox[{
    RowBox[{"logtaumin_", "?", "NumberQ"}], ",", 
    RowBox[{"logtaumax_", "?", "NumberQ"}], ",", 
    RowBox[{"route1", ":", "FRouteList"}], ",", 
    RowBox[{"route2", ":", "FRouteList"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"FFCSW", "[", 
   RowBox[{"logtaumin", ",", "logtaumax", ",", "route1", ",", "route2", ",", 
    RowBox[{"-", "1"}], ",", 
    RowBox[{"-", "1"}], ",", "opts"}], "]"}]}]}], "Input",
 CellChangeTimes->{
  3.7627693768177705`*^9, {3.7627694216209764`*^9, 3.762769430455351*^9}, {
   3.7627695395192814`*^9, 3.762769547964695*^9}, {3.762769643662812*^9, 
   3.7627696552049522`*^9}, 3.765187777601487*^9, {3.778501339621401*^9, 
   3.778501346239708*^9}, 3.7924975458170776`*^9, {3.830256422768761*^9, 
   3.830256512550266*^9}, {3.8826068411411085`*^9, 3.8826068562342324`*^9}, {
   3.8826069319012513`*^9, 3.88260693396987*^9}, {3.8826069924101677`*^9, 
   3.8826070128349032`*^9}, {3.8826070473096933`*^9, 
   3.8826070642256994`*^9}, {3.8826071070010796`*^9, 
   3.8826071080769887`*^9}, {3.8826071657247534`*^9, 
   3.8826072252301545`*^9}, {3.8826076484447613`*^9, 
   3.8826076919161673`*^9}, {3.8826077280291524`*^9, 3.882607746884582*^9}, 
   3.882607879026374*^9, {3.882607939221917*^9, 3.8826080071122255`*^9}, {
   3.88260815755661*^9, 3.8826081635715694`*^9}, {3.882608414624996*^9, 
   3.8826084893265295`*^9}, {3.8826085932867675`*^9, 3.882608672371743*^9}, {
   3.882608838472062*^9, 3.8826088900408983`*^9}, 3.8865075712167597`*^9, 
   3.8865076029831095`*^9},ExpressionUUID->"86dca3ab-e2d9-4d4a-b9a0-\
fb1a7dbc97c7"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"FFCSModel", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"\[Tau]D_", ",", 
       RowBox[{"expdecays", ":", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"_", ",", "_"}], "}"}], "..."}], "}"}]}]}], "}"}], ",", 
     "a_"}], "]"}], "[", "t_", "]"}], ":=", 
  FractionBox[
   RowBox[{"  ", 
    RowBox[{"Fold", "[", 
     RowBox[{"Times", ",", "1", ",", 
      RowBox[{"Map", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"1", "+", 
          RowBox[{
           RowBox[{"#", "[", 
            RowBox[{"[", "1", "]"}], "]"}], 
           RowBox[{"Exp", "[", 
            RowBox[{
             RowBox[{"-", "t"}], "/", 
             RowBox[{"#", "[", 
              RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}]}], "&"}], ",", 
        "expdecays"}], "]"}]}], "]"}]}], 
   RowBox[{
    RowBox[{"(", 
     RowBox[{"1", "+", 
      RowBox[{"t", "/", "\[Tau]D"}]}], ")"}], 
    SuperscriptBox[
     RowBox[{"(", 
      RowBox[{"1", "+", 
       RowBox[{
        SuperscriptBox["a", 
         RowBox[{"-", "2"}]], " ", 
        RowBox[{"t", "/", "\[Tau]D"}]}]}], ")"}], 
     RowBox[{"1", "/", "2"}]]}]]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FFCSModel", "[", 
    RowBox[{
     RowBox[{"species", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"_", ",", "_", ",", "_", ",", "_", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"_", ",", "_"}], "}"}], "..."}], "}"}]}], "}"}], ".."}], 
       "}"}]}], ",", "a_", ",", "bg1_", ",", "bg2_"}], "]"}], "[", "t_", 
   "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"n", ",", "Q1", ",", "Q2", ",", "g"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"n", "=", 
      RowBox[{"species", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Q1", "=", 
      RowBox[{"species", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "2"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Q2", "=", 
      RowBox[{"species", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "3"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"g", "=", 
      RowBox[{"species", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", 
         RowBox[{"4", ";;", "5"}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"1", "+", 
      FractionBox[
       RowBox[{
        RowBox[{"Total", "[", 
         RowBox[{"n", " ", "Q1", " ", "Q2", " ", 
          RowBox[{"Map", "[", 
           RowBox[{
            RowBox[{
             RowBox[{
              RowBox[{"FFCSModel", "[", 
               RowBox[{"#", ",", "a"}], "]"}], "[", "t", "]"}], "&"}], ",", 
            "g"}], "]"}]}], "]"}], " "}], 
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Total", "[", 
           RowBox[{"n", " ", "Q1"}], " ", "]"}], "+", "bg1"}], ")"}], 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Total", "[", 
           RowBox[{"n", " ", "Q2"}], " ", "]"}], "+", "bg2"}], ")"}]}]]}]}]}],
    "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FFCSModel", "[", 
    RowBox[{
     RowBox[{"species", ":", 
      RowBox[{"{", 
       RowBox[{"_", ",", "_", ",", "_", ",", "_", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"_", ",", "_"}], "}"}], "..."}], "}"}]}], "}"}]}], ",", 
     "a_", ",", "bg1_", ",", "bg2_"}], "]"}], "[", "t_", "]"}], ":=", 
  RowBox[{
   RowBox[{"FFCSModel", "[", 
    RowBox[{
     RowBox[{"{", "species", "}"}], ",", "a", ",", "bg1", ",", "bg2"}], "]"}],
    "[", "t", "]"}]}]}], "Input",
 CellChangeTimes->{{3.8667944276720605`*^9, 
  3.8667944712947583`*^9}},ExpressionUUID->"25b08610-fbb7-41a4-9bf9-\
3d45ec80f91a"],

Cell[BoxData[
 RowBox[{
  RowBox[{"F2DFLCSLifeTimeChannelMap", "[", 
   RowBox[{
    RowBox[{"tstart_", "?", "NumericQ"}], ",", 
    RowBox[{"tstop_", "?", "NumericQ"}], ",", 
    RowBox[{"tau", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], ",", 
    RowBox[{"route1", ":", "FRouteList"}], ",", 
    RowBox[{"route2", ":", "FRouteList"}], ",", 
    RowBox[{"channelranges", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "FValidChannelQ"}], " ", ",", 
         RowBox[{"_", "?", "FValidChannelQ"}]}], "}"}], ".."}], "}"}]}]}], 
   "]"}], ":=", "\n", 
  RowBox[{"F2DFLCSLifeTimeChannelMapP", "[", 
   RowBox[{
    RowBox[{"N", "@", "tstart"}], ",", 
    RowBox[{"N", "@", "tstop"}], ",", 
    RowBox[{"N", "@", "tau"}], ",", 
    RowBox[{"FRouteListToByte", "[", "route1", "]"}], ",", 
    RowBox[{"FRouteListToByte", "[", "route2", "]"}], ",", 
    RowBox[{"Flatten", "@", "channelranges"}], ",", "0"}], "]"}]}]], "Code",Ex\
pressionUUID->"7c7e7da4-98de-4239-87dc-9c99b9d23422"]
}, Open  ]],

Cell[CellGroupData[{

Cell["nsFCS", "Subsubsection",
 CellChangeTimes->{{3.7651939952699986`*^9, 
  3.765193997189594*^9}},ExpressionUUID->"3530d1b6-48b1-4877-9d8c-\
8f08fc67858a"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FnsFCS", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"FPhotonData", "->", "All"}], ",", " ", 
     RowBox[{"FOutput", "->", "FData"}]}], "}"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"FnsFCS", "[", 
   RowBox[{
    RowBox[{"route1", ":", "FRouteList"}], ",", 
    RowBox[{"route2", ":", "FRouteList"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"taumin_", "?", "NumberQ"}], ",", 
      RowBox[{"taumx_", "?", "NumberQ"}], ",", 
      RowBox[{"dtau_", "?", "NumberQ"}]}], "}"}], ",", 
    RowBox[{"tstart_", "?", "NumberQ"}], ",", 
    RowBox[{"tstop_", "?", "NumberQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"cdat", ",", 
      RowBox[{"mode", "=", "0"}]}], "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"Which", "[", "\n", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", "All"}], ",", 
       RowBox[{"mode", "=", "0"}], ",", "\n", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{
          RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", 
          "FBursts"}], ",", 
         RowBox[{"mode", "=", "1"}], ","}], "*)"}], "\n", 
       RowBox[{
       "(*", "\"\<OptionValue[FPhotonData]===FNonBursts,mode=2,\>\"", "*)"}], 
       "\n", 
       RowBox[{
        RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", 
        "FSelectedBursts"}], ",", 
       RowBox[{"mode", "=", "2"}], ",", "\n", "True", ",", " ", 
       RowBox[{"Return", "[", "$Failed", "]"}]}], "\n", "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"cdat", "=", 
      RowBox[{"FBunchStr", "[", 
       RowBox[{
        RowBox[{"N", "[", "tstart", "]"}], ",", 
        RowBox[{"N", "[", "tstop", "]"}], ",", 
        RowBox[{"FRouteListToByte", "[", "route1", "]"}], ",", 
        RowBox[{"FRouteListToByte", "[", "route2", "]"}], ",", 
        RowBox[{"N", "[", "taumin", "]"}], ",", 
        RowBox[{"N", "[", "taumx", "]"}], ",", 
        RowBox[{"N", "[", "dtau", "]"}], ",", "mode"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Which", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FData"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"(", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"cdat", "=", 
          RowBox[{"FCorrelTransformRawData", "[", "cdat", "]"}]}], ";", 
         RowBox[{
          RowBox[{"cdat", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "1"}], "]"}], "]"}], "/=", 
          RowBox[{"10.", "^", 
           RowBox[{"-", "6"}]}]}], ";", 
         RowBox[{
          RowBox[{"cdat", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "1"}], "]"}], "]"}], "+=", "taumin"}], ";", 
         "\[IndentingNewLine]", "cdat"}], "\[IndentingNewLine]", ")"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FRawData"}], 
       ",", "\[IndentingNewLine]", "cdat"}], "\[IndentingNewLine]", "]"}]}]}],
    "\n", "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FnsFCS", "[", 
   RowBox[{
    RowBox[{"route1", ":", "FRouteList"}], ",", 
    RowBox[{"route2", ":", "FRouteList"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"taumin_", "?", "NumberQ"}], ",", 
      RowBox[{"taumx_", "?", "NumberQ"}], ",", 
      RowBox[{"dtau_", "?", "NumberQ"}]}], "}"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"FnsFCS", "[", 
   RowBox[{"route1", ",", "route2", ",", 
    RowBox[{"{", 
     RowBox[{"taumin", ",", "taumx", ",", "dtau"}], "}"}], ",", 
    RowBox[{"-", "1."}], ",", 
    RowBox[{"-", "1."}], ",", "opts"}], "]"}]}]}], "Input",
 CellChangeTimes->{
  3.765187779101108*^9, {3.7651915765253963`*^9, 3.765191630312943*^9}, 
   3.7924975731579833`*^9, {3.8146126421532187`*^9, 3.814612643920494*^9}, {
   3.81461276073129*^9, 3.814612924475611*^9}, {3.8146129566391535`*^9, 
   3.8146130866586423`*^9}, {3.814613126067359*^9, 3.8146131397088547`*^9}, {
   3.8146164640227575`*^9, 
   3.814616464582261*^9}},ExpressionUUID->"899cd1f8-ef89-4a93-bd22-\
5f2dab6efea6"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FnsFCS", "[", 
   RowBox[{
    RowBox[{"routepairs", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"MatchQ", "[", 
             RowBox[{"#", ",", "FRouteList"}], "]"}], "&"}], ")"}]}], ",", 
         RowBox[{"_", "?", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"MatchQ", "[", 
             RowBox[{"#", ",", "FRouteList"}], "]"}], "&"}], ")"}]}]}], "}"}],
        ".."}], "}"}]}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"taumin_", "?", "NumberQ"}], ",", 
      RowBox[{"taumx_", "?", "NumberQ"}], ",", 
      RowBox[{"dtau_", "?", "NumberQ"}]}], "}"}], ",", 
    RowBox[{"tstart_", "?", "NumberQ"}], ",", 
    RowBox[{"tstop_", "?", "NumberQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"cdat", ",", 
      RowBox[{"mode", "=", "0"}]}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"Which", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", "All"}], ",", 
       RowBox[{"mode", "=", "0"}], ",", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{
          RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", 
          "FBursts"}], ",", 
         RowBox[{"mode", "=", "1"}], ","}], "*)"}], 
       RowBox[{
       "(*", "\"\<OptionValue[FPhotonData]===FNonBursts,mode=2,\>\"", "*)"}], 
       RowBox[{
        RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", 
        "FSelectedBursts"}], ",", 
       RowBox[{"mode", "=", "2"}], ",", "True", ",", " ", 
       RowBox[{"Return", "[", "$Failed", "]"}]}], "\[IndentingNewLine]", 
      "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"cdat", "=", 
      RowBox[{"FBunchParallelStr", "[", 
       RowBox[{
        RowBox[{"N", "[", "tstart", "]"}], ",", 
        RowBox[{"N", "[", "tstop", "]"}], ",", 
        RowBox[{"Map", "[", 
         RowBox[{"FRouteListToByte", ",", 
          RowBox[{"Flatten", "[", 
           RowBox[{"routepairs", ",", "1"}], "]"}]}], "]"}], ",", 
        RowBox[{"N", "[", "taumin", "]"}], ",", 
        RowBox[{"N", "[", "taumx", "]"}], ",", 
        RowBox[{"N", "[", "dtau", "]"}], ",", "mode"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Which", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FData"}], ",", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"cdat", "=", 
          RowBox[{"Map", "[", 
           RowBox[{"FCorrelTransformRawData", ",", "cdat"}], "]"}]}], ";", 
         RowBox[{
          RowBox[{"cdat", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "All", ",", "1"}], "]"}], "]"}], "/=", 
          RowBox[{"10.", "^", 
           RowBox[{"-", "6"}]}]}], ";", 
         RowBox[{
          RowBox[{"cdat", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "All", ",", "1"}], "]"}], "]"}], "+=", 
          "taumin"}], ";", "\[IndentingNewLine]", "cdat"}], 
        "\[IndentingNewLine]", ")"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FRawData"}], 
       ",", "\[IndentingNewLine]", "cdat"}], "\[IndentingNewLine]", "]"}]}]}],
    "\n", "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FnsFCS", "[", 
   RowBox[{
    RowBox[{"routepairs", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"MatchQ", "[", 
             RowBox[{"#", ",", "FRouteList"}], "]"}], "&"}], ")"}]}], ",", 
         RowBox[{"_", "?", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"MatchQ", "[", 
             RowBox[{"#", ",", "FRouteList"}], "]"}], "&"}], ")"}]}]}], "}"}],
        ".."}], "}"}]}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"taumin_", "?", "NumberQ"}], ",", 
      RowBox[{"taumx_", "?", "NumberQ"}], ",", 
      RowBox[{"dtau_", "?", "NumberQ"}]}], "}"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"FnsFCS", "[", 
   RowBox[{"routepairs", ",", 
    RowBox[{"{", 
     RowBox[{"taumin", ",", "taumx", ",", "dtau"}], "}"}], ",", 
    RowBox[{"-", "1."}], ",", 
    RowBox[{"-", "1."}], ",", "opts"}], "]"}]}]}], "Input",
 CellChangeTimes->{
  3.7651877833634396`*^9, {3.76519163661935*^9, 3.765191663870103*^9}, 
   3.7924975815315228`*^9, {3.8146131825144835`*^9, 3.8146132638381257`*^9}, {
   3.8146133129428864`*^9, 3.8146133624405966`*^9}, {3.814616473424633*^9, 
   3.814616473867445*^9}},ExpressionUUID->"9f54689f-0a49-4ccd-9265-\
b9b90537c1fd"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FBunch", ":=", "FnsFCS"}], ";"}]], "Input",
 CellChangeTimes->{{3.765193133607011*^9, 
  3.765193159371478*^9}},ExpressionUUID->"cde10978-f8ef-470b-b369-\
bd171a5aa611"]
}, Closed]],

Cell[CellGroupData[{

Cell["Second Order nsFCS", "Subsubsection",
 CellChangeTimes->{{3.765193976030623*^9, 
  3.765193977707653*^9}},ExpressionUUID->"598ddec6-ef22-46aa-b459-\
cd2900c016b4"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FCorrelSecondOrderTransformRawData", "[", "cdat_", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"dat", ",", "t1", ",", "t2"}], "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"dat", "=", 
      RowBox[{"CorrelikonG123", "/.", "cdat"}]}], ";", "\n", 
     RowBox[{"t1", "=", 
      RowBox[{"Drop", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"CorrelikonTauBins1", " ", "CorrelikonTimeUnitSec", " ", 
          RowBox[{"10", "^", "6"}]}], "/.", "cdat"}], ",", "1"}], "]"}]}], 
     ";", "\n", 
     RowBox[{"t2", "=", 
      RowBox[{"Drop", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"CorrelikonTauBins2", " ", "CorrelikonTimeUnitSec", " ", 
          RowBox[{"10", "^", "6"}]}], "/.", "cdat"}], ",", "1"}], "]"}]}], 
     ";", "\n", 
     RowBox[{"MapThread", "[", 
      RowBox[{"Append", ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"Outer", "[", 
          RowBox[{"List", ",", "t1", ",", "t2"}], "]"}], ",", "dat"}], "}"}], 
       ",", "2"}], "]"}]}]}], "]"}]}]], "Code",ExpressionUUID->"2a092ad0-760f-\
4d24-ad69-56d0abc6ea90"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FnsFCSSecondOrder", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"FPhotonData", "->", "All"}], "}"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"FnsFCSSecondOrder", "[", 
   RowBox[{
    RowBox[{"route1", ":", "FRouteList"}], ",", 
    RowBox[{"route2", ":", "FRouteList"}], ",", 
    RowBox[{"route3", ":", "FRouteList"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"tau1min_", "?", "NumberQ"}], ",", 
      RowBox[{"tau1mx_", "?", "NumberQ"}], ",", 
      RowBox[{"dtau1_", "?", "NumberQ"}]}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"tau2min_", "?", "NumberQ"}], ",", 
      RowBox[{"tau2mx_", "?", "NumberQ"}], ",", 
      RowBox[{"dtau2_", "?", "NumberQ"}]}], "}"}], ",", 
    RowBox[{"tstart_", "?", "NumberQ"}], ",", 
    RowBox[{"tstop_", "?", "NumberQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", "\n", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"cdat", ",", 
      RowBox[{"mode", "=", "0"}]}], "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"Which", "[", "\n", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", "All"}], ",", 
       RowBox[{"mode", "=", "0"}], ",", "\n", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{
          RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", 
          "FBursts"}], ",", 
         RowBox[{"mode", "=", "1"}], ","}], "*)"}], "\n", 
       RowBox[{
       "(*", "\"\<OptionValue[FPhotonData]===FNonBursts,mode=2,\>\"", "*)"}], 
       "\n", 
       RowBox[{
        RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", 
        "FSelectedBursts"}], ",", 
       RowBox[{"mode", "=", "2"}], ",", "\n", "True", ",", " ", 
       RowBox[{"Return", "[", "$Failed", "]"}]}], "\n", "]"}], ";", "\n", 
     "\n", 
     RowBox[{"cdat", "=", 
      RowBox[{"FBunchSecondOrderStr", "[", 
       RowBox[{
        RowBox[{"N", "[", "tstart", "]"}], ",", 
        RowBox[{"N", "[", "tstop", "]"}], ",", 
        RowBox[{"FRouteListToByte", "[", "route1", "]"}], ",", 
        RowBox[{"FRouteListToByte", "[", "route2", "]"}], ",", 
        RowBox[{"FRouteListToByte", "[", "route3", "]"}], ",", 
        RowBox[{"N", "[", "tau1min", "]"}], ",", 
        RowBox[{"N", "[", "tau1mx", "]"}], ",", 
        RowBox[{"N", "[", "dtau1", "]"}], ",", 
        RowBox[{"N", "[", "tau2min", "]"}], ",", 
        RowBox[{"N", "[", "tau2mx", "]"}], ",", 
        RowBox[{"N", "[", "dtau2", "]"}], ",", "mode"}], "]"}]}], ";", "\n", 
     RowBox[{"FCorrelSecondOrderTransformRawData", "[", "cdat", "]"}]}]}], 
   "\n", "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FnsFCSSecondOrder", "[", 
   RowBox[{
    RowBox[{"route1", ":", "FRouteList"}], ",", 
    RowBox[{"route2", ":", "FRouteList"}], ",", 
    RowBox[{"route3", ":", "FRouteList"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"tau1min_", "?", "NumberQ"}], ",", 
      RowBox[{"tau1mx_", "?", "NumberQ"}], ",", 
      RowBox[{"dtau1_", "?", "NumberQ"}]}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"tau2min_", "?", "NumberQ"}], ",", 
      RowBox[{"tau2mx_", "?", "NumberQ"}], ",", 
      RowBox[{"dtau2_", "?", "NumberQ"}]}], "}"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"FnsFCSSecondOrder", "[", 
   RowBox[{"route1", ",", "route2", ",", "route3", ",", 
    RowBox[{"{", 
     RowBox[{"tau1min", ",", "tau1mx", ",", "dtau1"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"tau2min", ",", "tau2mx", ",", "dtau2"}], "}"}], ",", 
    RowBox[{"-", "1."}], ",", 
    RowBox[{"-", "1."}], ",", "opts"}], "]"}]}]}], "Code",
 CellChangeTimes->{
  3.765187784744599*^9, {3.7651917010281353`*^9, 
   3.7651917258967113`*^9}},ExpressionUUID->"4fcc71aa-e2bf-4890-9405-\
ec9fc89ab40d"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FnsFCSSecondOrder", "[", 
   RowBox[{
    RowBox[{"routetriples", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"MatchQ", "[", 
             RowBox[{"#", ",", "FRouteList"}], "]"}], "&"}], ")"}]}], ",", 
         RowBox[{"_", "?", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"MatchQ", "[", 
             RowBox[{"#", ",", "FRouteList"}], "]"}], "&"}], ")"}]}], ",", 
         RowBox[{"_", "?", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"MatchQ", "[", 
             RowBox[{"#", ",", "FRouteList"}], "]"}], "&"}], ")"}]}]}], "}"}],
        ".."}], "}"}]}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"tau1min_", "?", "NumberQ"}], ",", 
      RowBox[{"tau1mx_", "?", "NumberQ"}], ",", 
      RowBox[{"dtau1_", "?", "NumberQ"}]}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"tau2min_", "?", "NumberQ"}], ",", 
      RowBox[{"tau2mx_", "?", "NumberQ"}], ",", 
      RowBox[{"dtau2_", "?", "NumberQ"}]}], "}"}], ",", 
    RowBox[{"tstart_", "?", "NumberQ"}], ",", 
    RowBox[{"tstop_", "?", "NumberQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", "\n", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"cdat", ",", "dat", ",", "t1", ",", "t2", ",", 
      RowBox[{"mode", "=", "0"}]}], "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"Which", "[", "\n", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", "All"}], ",", 
       RowBox[{"mode", "=", "0"}], ",", "\n", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{
          RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", 
          "FBursts"}], ",", 
         RowBox[{"mode", "=", "1"}], ","}], "*)"}], "\n", 
       RowBox[{
       "(*", "\"\<OptionValue[FPhotonData]===FNonBursts,mode=2,\>\"", "*)"}], 
       "\n", 
       RowBox[{
        RowBox[{"OptionValue", "[", "FPhotonData", "]"}], "===", 
        "FSelectedBursts"}], ",", 
       RowBox[{"mode", "=", "2"}], ",", "\n", "True", ",", " ", 
       RowBox[{"Return", "[", "$Failed", "]"}]}], "\n", "]"}], ";", "\n", 
     RowBox[{"cdat", "=", 
      RowBox[{
       RowBox[{"FBunchSecondOrderParallelStr", "[", 
        RowBox[{
         RowBox[{"N", "[", "tstart", "]"}], ",", 
         RowBox[{"N", "[", "tstop", "]"}], ",", 
         RowBox[{"Map", "[", 
          RowBox[{"FRouteListToByte", ",", 
           RowBox[{"Flatten", "[", 
            RowBox[{"routetriples", ",", "1"}], "]"}]}], "]"}], ",", 
         RowBox[{"N", "[", "tau1min", "]"}], ",", 
         RowBox[{"N", "[", "tau1mx", "]"}], ",", 
         RowBox[{"N", "[", "dtau1", "]"}], ",", 
         RowBox[{"N", "[", "tau2min", "]"}], ",", 
         RowBox[{"N", "[", "tau2mx", "]"}], ",", 
         RowBox[{"N", "[", "dtau2", "]"}], ",", "mode"}], "]"}], "\n", 
       RowBox[{"Map", "[", 
        RowBox[{"FCorrelSecondOrderTransformRawData", ",", "cdat"}], 
        "]"}]}]}]}]}], "\n", "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FnsFCSSecondOrder", "[", 
   RowBox[{
    RowBox[{"routetriples", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"MatchQ", "[", 
             RowBox[{"#", ",", "FRouteList"}], "]"}], "&"}], ")"}]}], ",", 
         RowBox[{"_", "?", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"MatchQ", "[", 
             RowBox[{"#", ",", "FRouteList"}], "]"}], "&"}], ")"}]}], ",", 
         RowBox[{"_", "?", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"MatchQ", "[", 
             RowBox[{"#", ",", "FRouteList"}], "]"}], "&"}], ")"}]}]}], "}"}],
        ".."}], "}"}]}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"tau1min_", "?", "NumberQ"}], ",", 
      RowBox[{"tau1mx_", "?", "NumberQ"}], ",", 
      RowBox[{"dtau1_", "?", "NumberQ"}]}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"tau2min_", "?", "NumberQ"}], ",", 
      RowBox[{"tau2mx_", "?", "NumberQ"}], ",", 
      RowBox[{"dtau2_", "?", "NumberQ"}]}], "}"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"FnsFCSSecondOrder", "[", 
   RowBox[{"routetriples", ",", 
    RowBox[{"{", 
     RowBox[{"tau1min", ",", "tau1mx", ",", "dtau1"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"tau2min", ",", "tau2mx", ",", "dtau2"}], "}"}], ",", 
    RowBox[{"-", "1."}], ",", 
    RowBox[{"-", "1."}], ",", "opts"}], "]"}]}]}], "Code",
 CellChangeTimes->{
  3.7651877858483086`*^9, {3.765191729026041*^9, 
   3.7651917400538807`*^9}},ExpressionUUID->"0202f3c5-8029-4267-9f57-\
13c3ea038df1"]
}, Closed]],

Cell[CellGroupData[{

Cell["Correlation of binned data", "Subsubsection",ExpressionUUID->"f25a2094-2c0e-4920-b686-67b0800d63cd"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FCorrelateBinnedData", "[", 
   RowBox[{"dat1_List", ",", "dat2_List", ",", "n_Integer"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"max", ",", "ab"}], "}"}], ",", "\n", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"Length", "[", "dat1", "]"}], "!=", 
       RowBox[{"Length", "[", "dat2", "]"}]}], ",", "$Failed", ",", 
      RowBox[{"(", "\n", 
       RowBox[{
        RowBox[{"max", "=", 
         RowBox[{"Min", "[", 
          RowBox[{
           RowBox[{"n", "+", "1"}], ",", 
           RowBox[{"Length", "[", "dat1", "]"}]}], "]"}]}], ";", "\n", 
        RowBox[{"ab", "=", 
         RowBox[{"ListCorrelate", "[", 
          RowBox[{"dat1", ",", "dat2", ",", 
           RowBox[{"{", 
            RowBox[{"1", ",", 
             RowBox[{
              RowBox[{"Length", "[", "dat1", "]"}], "-", "max", "+", "1"}]}], 
            "}"}], ",", "0"}], "]"}]}], ";", "\n", 
        RowBox[{"ab", "/=", 
         RowBox[{"Reverse", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Accumulate", "[", "dat1", "]"}], "[", 
            RowBox[{"[", 
             RowBox[{
              RowBox[{"-", "max"}], ";;"}], "]"}], "]"}], 
           RowBox[{
            RowBox[{"Accumulate", "[", 
             RowBox[{"Reverse", "[", "dat2", "]"}], "]"}], "[", 
            RowBox[{"[", 
             RowBox[{
              RowBox[{"-", "max"}], ";;"}], "]"}], "]"}]}], " ", "]"}]}], ";",
         "\n", 
        RowBox[{"Rest", "[", 
         RowBox[{"ab", "*", 
          RowBox[{"Reverse", "[", 
           RowBox[{"Range", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Length", "[", "dat1", "]"}], "-", "max", "+", "1"}], 
             ",", 
             RowBox[{"Length", "[", "dat2", "]"}]}], "]"}], "]"}]}], "]"}]}], 
       ")"}]}], "\n", "]"}]}], "\n", "]"}]}]], "Input",ExpressionUUID->\
"b80c42b3-2a99-4116-9658-54fc610ee0b9"]
}, Closed]],

Cell[CellGroupData[{

Cell["Recurrence analysis", "Subsubsection",ExpressionUUID->"c9d78b76-f4a7-48da-9fa6-10af450da720"],

Cell["\<\
FSameMoleculeProbability calculates the probability that a molecule measured \
a time tau after a first measurement is still the same one, i.e. the molecule \
has \"recurred\".
The probabilty is given by 1-1/G(\[Tau])where G(\[Tau]) is the \
autocorrelation of the burst times. \
\>", "Text",ExpressionUUID->"c4fd7b84-423c-4bea-9610-2e93363c83ab"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "FSameMoleculeProbability", "]"}], "=", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"FOutput", "->", "FGraph"}], "}"}], "~", "Join", "~", 
     RowBox[{"Options", "[", "ListPlot", "]"}], "~", "Join", "~", 
     RowBox[{"Options", "[", "ListLogLinearPlot", "]"}]}]}], ";"}], 
  "\n"}], "\n", 
 RowBox[{
  RowBox[{"FSameMoleculeProbability", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"taumin_", ",", "taumax_", ",", "dtau_"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"bursttimes1", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
      RowBox[{"bursttimes2", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}]}], "}"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"tau", ",", "PSdata"}], "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"tau", "=", 
      RowBox[{"Range", "[", 
       RowBox[{"taumin", ",", "taumax", ",", "dtau"}], "]"}]}], ";", "\n", 
     RowBox[{"PSdata", "=", 
      RowBox[{"Map", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"#", "[", 
            RowBox[{"[", "1", "]"}], "]"}], ",", 
           RowBox[{"1", "-", 
            RowBox[{"1", "/", 
             RowBox[{"#", "[", 
              RowBox[{"[", "2", "]"}], "]"}]}]}]}], "}"}], "&"}], ",", 
        RowBox[{"FTimeCorrelate", "[", 
         RowBox[{"tau", ",", "bursttimes1", ",", "bursttimes2"}], "]"}]}], 
       "]"}]}], ";", "\n", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FGraph"}], ",", 
       "\n", 
       RowBox[{"ListPlot", "[", 
        RowBox[{"PSdata", ",", 
         RowBox[{"FilterRules", "[", 
          RowBox[{
           RowBox[{"{", "opts", "}"}], ",", " ", 
           RowBox[{"Options", "[", "ListPlot", "]"}]}], "]"}], ",", 
         RowBox[{"PlotRange", "->", "All"}], ",", 
         RowBox[{"Frame", "->", "True"}], ",", 
         RowBox[{"Axes", "->", "False"}], ",", 
         RowBox[{"FrameLabel", "->", 
          RowBox[{"{", 
           RowBox[{
           "\"\<\[Tau](ms)\>\"", ",", " ", 
            "\"\<\\!\\(\\*SubscriptBox[\\(p\\), \\(Same\\)]\\)\>\""}], 
           "}"}]}], ",", 
         RowBox[{"LabelStyle", "->", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"FontFamily", "->", " ", "\"\<Helvetica\>\""}], ",", 
            RowBox[{"FontSize", "->", " ", "12"}], ",", 
            RowBox[{"FontWeight", "->", " ", "Bold"}]}], "}"}]}]}], "]"}], 
       ",", "\n", "PSdata"}], "]"}]}]}], "\n", "]"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FSameMoleculeProbability", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"taumin_", ",", "taumax_", ",", "dtau_"}], "}"}], ",", 
     RowBox[{"bursttimes", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"FSameMoleculeProbability", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"taumin", ",", "taumax", ",", "dtau"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"bursttimes", ",", "bursttimes"}], "}"}], ",", "opts"}], 
    "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FSameMoleculeProbability", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"taumin_", ",", "taumax_", ",", "dtau_"}], "}"}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "bursttimes", "}"}], ",", "\n", 
     RowBox[{
      RowBox[{"bursttimes", "=", 
       RowBox[{"FGetFromBurstList", "[", 
        RowBox[{"1000.", 
         RowBox[{"Mean", "[", 
          RowBox[{"{", 
           RowBox[{"\"\<EndTime\>\"", ",", "\"\<StartTime\>\""}], "}"}], 
          "]"}]}], "]"}]}], ";", "\n", 
      RowBox[{"FSameMoleculeProbability", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"taumin", ",", "taumax", ",", "dtau"}], "}"}], ",", 
        "bursttimes", ",", "opts"}], "]"}]}]}], "\n", "]"}]}], 
  "\n"}], "\n"}], "Code",ExpressionUUID->"5b8b54f2-ad05-42e7-89c9-\
070abf96f92a"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FSameMoleculeProbability", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"MinimalTauBin_", "?", "NumberQ"}], ",", 
      RowBox[{"taumax_", "?", "NumberQ"}]}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"bursttimes1", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
      RowBox[{"bursttimes2", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}]}], "}"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "tau", ",", "\[CapitalDelta]", ",", "k", ",", "correldat", ",", "PSdata",
       ",", "st"}], "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"st", "=", "0"}], ";", "\n", 
     RowBox[{"tau", "=", 
      RowBox[{"{", "}"}]}], ";", "\n", 
     RowBox[{"k", "=", "0"}], ";", "\n", 
     RowBox[{"\[CapitalDelta]", "=", "MinimalTauBin"}], ";", "\n", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"\[CapitalDelta]", "<=", "0"}], ",", 
       RowBox[{"\[CapitalDelta]", "=", "1."}]}], "]"}], ";", "\n", 
     RowBox[{"While", "[", 
      RowBox[{
       RowBox[{"st", "<", "taumax"}], ",", "\n", 
       RowBox[{
        RowBox[{"AppendTo", "[", 
         RowBox[{"tau", ",", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{"st", "+=", " ", 
             RowBox[{"\[CapitalDelta]", " ", 
              RowBox[{"2", "^", "k"}]}]}], ",", 
            RowBox[{"{", 
             RowBox[{"n", ",", "1", ",", "10"}], "}"}]}], "]"}]}], "]"}], ";",
         "\n", 
        RowBox[{"k", "++"}], ";"}]}], "\n", "]"}], ";", "\n", 
     RowBox[{"tau", "=", 
      RowBox[{"Flatten", "[", "tau", "]"}]}], ";", "\n", 
     RowBox[{"tau", "=", 
      RowBox[{"Select", "[", 
       RowBox[{"tau", ",", 
        RowBox[{
         RowBox[{"#", "<=", "taumax"}], "&"}]}], "]"}]}], ";", "\n", 
     RowBox[{"correldat", "=", 
      RowBox[{"FTimeCorrelate", "[", 
       RowBox[{"tau", ",", "bursttimes1", ",", "bursttimes2"}], "]"}]}], ";", 
     "\n", 
     RowBox[{"PSdata", "=", 
      RowBox[{"Map", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"#", "[", 
            RowBox[{"[", "1", "]"}], "]"}], ",", 
           RowBox[{"1", "-", 
            RowBox[{"1", "/", 
             RowBox[{"#", "[", 
              RowBox[{"[", "2", "]"}], "]"}]}]}]}], "}"}], "&"}], ",", 
        "correldat"}], "]"}]}], ";", "\n", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FGraph"}], ",", 
       "\n", 
       RowBox[{"ListLogLinearPlot", "[", 
        RowBox[{"PSdata", ",", 
         RowBox[{"FilterRules", "[", 
          RowBox[{
           RowBox[{"{", "opts", "}"}], ",", " ", 
           RowBox[{"Options", "[", "ListLogLinearPlot", "]"}]}], "]"}], ",", 
         RowBox[{"PlotRange", "->", "All"}], ",", 
         RowBox[{"Frame", "->", "True"}], ",", 
         RowBox[{"Axes", "->", "False"}], ",", 
         RowBox[{"FrameLabel", "->", 
          RowBox[{"{", 
           RowBox[{
           "\"\<\[Tau](ms)\>\"", ",", " ", 
            "\"\<\\!\\(\\*SubscriptBox[\\(p\\), \\(Same\\)]\\)\>\""}], 
           "}"}]}], ",", 
         RowBox[{"LabelStyle", "->", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"FontFamily", "->", " ", "\"\<Helvetica\>\""}], ",", 
            RowBox[{"FontSize", "->", " ", "12"}], ",", 
            RowBox[{"FontWeight", "->", " ", "Bold"}]}], "}"}]}]}], "]"}], 
       ",", "\n", "PSdata"}], "]"}]}]}], "\n", "]"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FSameMoleculeProbability", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"MinimalTauBin_", "?", "NumberQ"}], ",", 
       RowBox[{"taumax_", "?", "NumberQ"}]}], "}"}], ",", 
     RowBox[{"bursttimes", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"FSameMoleculeProbability", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"MinimalTauBin", ",", "taumax"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"bursttimes", ",", "bursttimes"}], "}"}], ",", "opts"}], 
    "]"}]}], "\n"}], "\n"}], "Code",ExpressionUUID->"f0f12ea8-0af2-425a-942c-\
c3fdd6a580a4"],

Cell["\<\
In the following burstlist must be of the form {{E,t}...}. Here E can be the \
transfer efficiency (or proximity ratio, etc.), t is the burst time.
burstlist can be obtained e.g. by
       burstlist = FGetFromBurstList[{\"E\", 1000. \"EndTime\"}]\[Transpose]; 
The times are then given in miliseconds.\
\>", "Text",ExpressionUUID->"90eef429-b4db-4424-87f5-5b0f7e5d44ff"],

Cell["\<\
FRecurrenceList needs as input an initial E range {E1,E2} for selecting  \
initial bursts b1 and a time range {t1,t2}
For each burst b1 all subseqent bursts b2 are searched with \
\[CapitalDelta]t=tb2-tb1 \[Element](t1,t2) The function returns {{E1,E2,\
\[CapitalDelta]t,{pos1,pos2}},...}, where {pos1,pos2} are the positions of b1 \
and b2 in the burst list.
\
\>", "Text",
 CellChangeTimes->{
  3.7651978525173607`*^9},ExpressionUUID->"ecd360d5-c7da-4b1b-a016-\
c8a9434ce45b"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"OLD", " ", "\n", 
     RowBox[{"FRecurrenceList", "[", 
      RowBox[{"burstlist_List", ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"E1_", "?", "NumberQ"}], ",", 
         RowBox[{"E2_", "?", "NumberQ"}]}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"t1_", "?", "NumberQ"}], ",", 
         RowBox[{"t2_", "?", "NumberQ"}]}], "}"}], ",", "opts___"}], "]"}]}], 
    ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"pos", ",", "f"}], "}"}], ",", "\n", 
      RowBox[{
       RowBox[{"pos", "=", 
        RowBox[{"Flatten", "[", 
         RowBox[{"Position", "[", 
          RowBox[{"burstlist", ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"_", "?", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"E1", "<", "#", "<", "E2"}], ")"}], "&"}], ")"}]}], 
             ",", "t_", ",", "___"}], "}"}]}], "]"}], "]"}]}], ";", "\n", 
       RowBox[{
        RowBox[{"f", "[", "position_", "]"}], ":=", " ", 
        RowBox[{"Module", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"j", "=", 
             RowBox[{"position", "+", "1"}]}], ",", 
            RowBox[{"elist", "=", 
             RowBox[{"{", "}"}]}], ",", 
            RowBox[{"t0", "=", 
             RowBox[{"burstlist", "[", 
              RowBox[{"[", 
               RowBox[{"position", ",", "2"}], "]"}], "]"}]}]}], "}"}], ",", 
          "\n", 
          RowBox[{
           RowBox[{"While", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"j", "<=", 
               RowBox[{"Length", "[", "burstlist", "]"}]}], "&&", 
              RowBox[{
               RowBox[{
                RowBox[{"burstlist", "[", 
                 RowBox[{"[", 
                  RowBox[{"j", ",", "2"}], "]"}], "]"}], "-", "t0"}], "<", 
               "t1"}]}], ",", 
             RowBox[{"j", "++"}]}], "]"}], ";", "\n", 
           RowBox[{"While", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"j", "<=", 
               RowBox[{"Length", "[", "burstlist", "]"}]}], "&&", 
              RowBox[{
               RowBox[{
                RowBox[{"burstlist", "[", 
                 RowBox[{"[", 
                  RowBox[{"j", ",", "2"}], "]"}], "]"}], "-", "t0"}], "<=", 
               "t2"}]}], ",", "\n", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"AppendTo", "[", 
                RowBox[{"elist", ",", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"burstlist", "[", 
                    RowBox[{"[", 
                    RowBox[{"position", ",", "1"}], "]"}], "]"}], ",", 
                   RowBox[{"burstlist", "[", 
                    RowBox[{"[", 
                    RowBox[{"j", ",", "1"}], "]"}], "]"}], ",", 
                   RowBox[{
                    RowBox[{"burstlist", "[", 
                    RowBox[{"[", 
                    RowBox[{"j", ",", "2"}], "]"}], "]"}], "-", "t0"}], ",", 
                   RowBox[{"{", 
                    RowBox[{"position", ",", "j"}], "}"}]}], "}"}]}], "]"}], 
               ";", "\n", 
               RowBox[{"j", "++"}], ";"}], ")"}]}], "]"}], ";", "\n", 
           "elist"}]}], "]"}]}], ";", "\n", 
       RowBox[{"Flatten", "[", 
        RowBox[{
         RowBox[{"Map", "[", 
          RowBox[{"f", ",", "pos"}], "]"}], ",", "1"}], "]"}]}]}], "\n", 
     "]"}]}], "\n", "*)"}], "\n", "\n", 
  RowBox[{
   RowBox[{"FRecurrenceList", "[", 
    RowBox[{"burstlist_List", ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"E1_", "?", "NumberQ"}], ",", 
       RowBox[{"E2_", "?", "NumberQ"}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"t1_", "?", "NumberQ"}], ",", 
       RowBox[{"t2_", "?", "NumberQ"}]}], "}"}], ",", "opts___"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"pos", ",", "f"}], "}"}], ",", "\n", 
     RowBox[{
      RowBox[{"pos", "=", 
       RowBox[{"Flatten", "[", 
        RowBox[{"Position", "[", 
         RowBox[{"burstlist", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"(", 
                RowBox[{"E1", "<", "#", "<", "E2"}], ")"}], "&"}], ")"}]}], 
            ",", "t_", ",", "___"}], "}"}]}], "]"}], "]"}]}], ";", "\n", 
      RowBox[{
       RowBox[{"f", "[", "position_", "]"}], ":=", " ", 
       RowBox[{"Module", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"j", "=", 
            RowBox[{"position", "+", "1"}]}], ",", 
           RowBox[{"elist", "=", 
            RowBox[{"{", "}"}]}], ",", 
           RowBox[{"t0", "=", 
            RowBox[{"burstlist", "[", 
             RowBox[{"[", 
              RowBox[{"position", ",", "2"}], "]"}], "]"}]}]}], "}"}], ",", 
         "\n", 
         RowBox[{
          RowBox[{"While", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"j", "<=", 
              RowBox[{"Length", "[", "burstlist", "]"}]}], "&&", 
             RowBox[{
              RowBox[{
               RowBox[{"burstlist", "[", 
                RowBox[{"[", 
                 RowBox[{"j", ",", "2"}], "]"}], "]"}], "-", "t0"}], "<", 
              "t1"}]}], ",", 
            RowBox[{"j", "++"}]}], "]"}], ";", "\n", 
          RowBox[{"elist", "=", 
           RowBox[{"Last", "@", 
            RowBox[{"Reap", "[", "\n", 
             RowBox[{"While", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"j", "<=", 
                 RowBox[{"Length", "[", "burstlist", "]"}]}], "&&", 
                RowBox[{
                 RowBox[{
                  RowBox[{"burstlist", "[", 
                   RowBox[{"[", 
                    RowBox[{"j", ",", "2"}], "]"}], "]"}], "-", "t0"}], "<=", 
                 "t2"}]}], ",", "\n", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"Sow", "[", 
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{"burstlist", "[", 
                    RowBox[{"[", 
                    RowBox[{"position", ",", "1"}], "]"}], "]"}], ",", 
                    RowBox[{"burstlist", "[", 
                    RowBox[{"[", 
                    RowBox[{"j", ",", "1"}], "]"}], "]"}], ",", 
                    RowBox[{
                    RowBox[{"burstlist", "[", 
                    RowBox[{"[", 
                    RowBox[{"j", ",", "2"}], "]"}], "]"}], "-", "t0"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"position", ",", "j"}], "}"}]}], "}"}], "]"}], 
                 ";", "\n", 
                 RowBox[{"j", "++"}], ";"}], ")"}]}], "]"}], "\n", "]"}]}]}], 
          ";", "\n", "elist"}]}], "]"}]}], ";", "\n", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{"Map", "[", 
         RowBox[{"f", ",", "pos"}], "]"}], ",", "2"}], "]"}]}]}], "\n", 
    "]"}]}]}]], "Code",ExpressionUUID->"c583f88f-059a-4595-a2f0-07425bacad1f"],

Cell["\<\
In another version of FRecurrenceList the E range and the time intervall are \
given by functions, e.g. by (0.8<#<0.9)& and (0<#<20)& instead of {0.8,0.9} \
and {0,20} in the previous version. This is more general as one could use \
here also other criteria, however this version is less performant as in \
principle all subsequent bursts have to be tested.
For avoiding this, one can use the option FCheckTimeMaxB2Count to set a \
maximum of subseqent bursts which should be considered. The default value is \
100.
This is a reasonable value if for example the time range is {0,20} ms as it \
is very unlikely that there are more than 100  bursts coming in 20 ms.
If possible one should not use this version of FRecurrenceList but the one \
described before as it is more performent.\
\>", "Text",
 CellChangeTimes->{
  3.7651976533754177`*^9},ExpressionUUID->"51dc4c4b-4119-406a-b806-\
9f44162efb4a"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "FRecurrenceList", "]"}], "=", 
    RowBox[{"{", 
     RowBox[{"FCheckTimeMaxB2Count", "->", "100"}], "}"}]}], ";"}], "\n", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"FRecurrenceList", "[", 
     RowBox[{"burstlist_List", ",", "E1select_", ",", "dtselect_", ",", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"pos", ",", "f", ",", "maxb2"}], "}"}], ",", "\n", 
      RowBox[{
       RowBox[{"pos", "=", 
        RowBox[{"Flatten", "[", 
         RowBox[{"Position", "[", 
          RowBox[{"burstlist", ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"_", "?", "E1select"}], ",", "t_"}], "}"}]}], "]"}], 
         "]"}]}], ";", "\n", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"OptionValue", "[", "FCheckTimeMaxB2Count", "]"}], "===", 
          "All"}], ",", 
         RowBox[{"maxb2", "=", 
          RowBox[{"Length", "[", "burstlist", "]"}]}], ",", 
         RowBox[{"maxb2", "=", 
          RowBox[{"OptionValue", "[", "FCheckTimeMaxB2Count", "]"}]}], ",", 
         RowBox[{"maxb2", "=", 
          RowBox[{"Length", "[", "burstlist", "]"}]}]}], "]"}], ";", "\n", 
       RowBox[{
        RowBox[{"f", "[", "position_", "]"}], ":=", " ", 
        RowBox[{"Module", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"elist", "=", 
             RowBox[{"{", "}"}]}], ",", 
            RowBox[{"t0", "=", 
             RowBox[{"burstlist", "[", 
              RowBox[{"[", 
               RowBox[{"position", ",", "2"}], "]"}], "]"}]}]}], "}"}], ",", 
          "\n", 
          RowBox[{
           RowBox[{"Do", "[", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{
               RowBox[{"If", "[", 
                RowBox[{
                 RowBox[{"dtselect", "[", 
                  RowBox[{
                   RowBox[{"burstlist", "[", 
                    RowBox[{"[", 
                    RowBox[{"j", ",", "2"}], "]"}], "]"}], "-", "t0"}], "]"}],
                  ",", 
                 RowBox[{"AppendTo", "[", 
                  RowBox[{"elist", ",", 
                   RowBox[{"{", 
                    RowBox[{
                    RowBox[{"burstlist", "[", 
                    RowBox[{"[", 
                    RowBox[{"position", ",", "1"}], "]"}], "]"}], ",", 
                    RowBox[{"burstlist", "[", 
                    RowBox[{"[", 
                    RowBox[{"j", ",", "1"}], "]"}], "]"}], ",", 
                    RowBox[{
                    RowBox[{"burstlist", "[", 
                    RowBox[{"[", 
                    RowBox[{"j", ",", "2"}], "]"}], "]"}], "-", "t0"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"position", ",", "j"}], "}"}]}], "}"}]}], "]"}]}],
                 "]"}], ";"}], ")"}], "\n", ",", 
             RowBox[{"{", 
              RowBox[{"j", ",", 
               RowBox[{"position", "+", "1"}], ",", 
               RowBox[{"Min", "[", 
                RowBox[{
                 RowBox[{"position", "+", "maxb2"}], ",", 
                 RowBox[{"Length", "[", "burstlist", "]"}]}], "]"}]}], 
              "}"}]}], "]"}], ";", "\n", "elist"}]}], "]"}]}], ";", "\n", 
       RowBox[{"Flatten", "[", 
        RowBox[{
         RowBox[{"Map", "[", 
          RowBox[{"f", ",", "pos"}], "]"}], ",", "1"}], "]"}]}]}], "\n", 
     "]"}]}], "\n", "*)"}], "\n"}], "\n", 
 RowBox[{
  RowBox[{"FRecurrenceList", "[", 
   RowBox[{"burstlist_List", ",", "E1select_", ",", "dtselect_", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"pos", ",", "f", ",", "maxb2"}], "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"pos", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{"Position", "[", 
        RowBox[{"burstlist", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "E1select"}], ",", "t_"}], "}"}]}], "]"}], 
       "]"}]}], ";", "\n", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FCheckTimeMaxB2Count", "]"}], "===", 
        "All"}], ",", 
       RowBox[{"maxb2", "=", 
        RowBox[{"Length", "[", "burstlist", "]"}]}], ",", 
       RowBox[{"maxb2", "=", 
        RowBox[{"OptionValue", "[", "FCheckTimeMaxB2Count", "]"}]}], ",", 
       RowBox[{"maxb2", "=", 
        RowBox[{"Length", "[", "burstlist", "]"}]}]}], "]"}], ";", "\n", 
     RowBox[{
      RowBox[{"f", "[", "position_", "]"}], ":=", " ", 
      RowBox[{"Module", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"elist", "=", 
           RowBox[{"{", "}"}]}], ",", 
          RowBox[{"t0", "=", 
           RowBox[{"burstlist", "[", 
            RowBox[{"[", 
             RowBox[{"position", ",", "2"}], "]"}], "]"}]}]}], "}"}], ",", 
        "\n", 
        RowBox[{
         RowBox[{"elist", "=", 
          RowBox[{"First", "@", 
           RowBox[{"Last", "@", 
            RowBox[{"Reap", "[", "\n", 
             RowBox[{
              RowBox[{"Do", "[", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"If", "[", 
                   RowBox[{
                    RowBox[{"dtselect", "[", 
                    RowBox[{
                    RowBox[{"burstlist", "[", 
                    RowBox[{"[", 
                    RowBox[{"j", ",", "2"}], "]"}], "]"}], "-", "t0"}], "]"}],
                     ",", 
                    RowBox[{"Sow", "[", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"burstlist", "[", 
                    RowBox[{"[", 
                    RowBox[{"position", ",", "1"}], "]"}], "]"}], ",", 
                    RowBox[{"burstlist", "[", 
                    RowBox[{"[", 
                    RowBox[{"j", ",", "1"}], "]"}], "]"}], ",", 
                    RowBox[{
                    RowBox[{"burstlist", "[", 
                    RowBox[{"[", 
                    RowBox[{"j", ",", "2"}], "]"}], "]"}], "-", "t0"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"position", ",", "j"}], "}"}]}], "}"}], "]"}]}], 
                   "]"}], ";"}], ")"}], "\n", ",", 
                RowBox[{"{", 
                 RowBox[{"j", ",", 
                  RowBox[{"position", "+", "1"}], ",", 
                  RowBox[{"Min", "[", 
                   RowBox[{
                    RowBox[{"position", "+", "maxb2"}], ",", 
                    RowBox[{"Length", "[", "burstlist", "]"}]}], "]"}]}], 
                 "}"}]}], "]"}], ";"}], "\n", "]"}]}]}]}], ";", "\n", 
         "elist"}]}], "]"}]}], ";", "\n", 
     RowBox[{"Flatten", "[", 
      RowBox[{
       RowBox[{"Map", "[", 
        RowBox[{"f", ",", "pos"}], "]"}], ",", "1"}], "]"}]}]}], "\n", 
   "]"}]}]}], "Code",ExpressionUUID->"43df7618-5086-4aef-88bb-84f641dc85db"],

Cell["\<\
FRecurrenceHisto makes a transfer efficiency histogram of all burst (E2,t2) \
fullfilling dtselect[\[CapitalDelta]t=t2-t1], where t1 are the burst times of \
the bursts (E1,t1) selected by  E1select.\
\>", "Text",ExpressionUUID->"995c3a32-8fb7-4c33-9a24-45d8fa060ec6"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FRecurrenceHisto", "[", 
   RowBox[{"burstlist_List", ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"E1_", "?", "NumberQ"}], ",", 
      RowBox[{"E2_", "?", "NumberQ"}]}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"t1_", "?", "NumberQ"}], ",", 
      RowBox[{"t2_", "?", "NumberQ"}]}], "}"}], ",", 
    RowBox[{"historange", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumberQ"}], ",", 
       RowBox[{"_", "?", "NumberQ"}], ",", 
       RowBox[{"_", "?", "NumberQ"}]}], "}"}]}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "recdat", "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"recdat", "=", 
      RowBox[{
       RowBox[{"FRecurrenceList", "[", 
        RowBox[{"burstlist", ",", 
         RowBox[{"{", 
          RowBox[{"E1", ",", "E2"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"t1", ",", "t2"}], "}"}], ",", 
         RowBox[{"FilterRules", "[", 
          RowBox[{
           RowBox[{"{", "opts", "}"}], ",", " ", 
           RowBox[{"Options", "[", "FRecurrenceList", "]"}]}], "]"}]}], "]"}],
        "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "2"}], "]"}], "]"}]}], ";", "\n", 
     RowBox[{"Histo", "[", 
      RowBox[{"recdat", ",", "historange", ",", 
       RowBox[{"FilterRules", "[", 
        RowBox[{
         RowBox[{"{", "opts", "}"}], ",", " ", 
         RowBox[{"Options", "[", "Histo", "]"}]}], "]"}], ",", 
       RowBox[{"PlotRange", "->", "All"}]}], "]"}]}]}], "\n", "]"}]}]], "Code",\
ExpressionUUID->"18468321-90a4-4a5e-9c0e-eb8879e8baeb"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FRecurrenceHisto", "[", 
   RowBox[{"burstlist_List", ",", "E1select_", ",", "dtselect_", ",", 
    RowBox[{"historange", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumberQ"}], ",", 
       RowBox[{"_", "?", "NumberQ"}], ",", 
       RowBox[{"_", "?", "NumberQ"}]}], "}"}]}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "recdat", "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"recdat", "=", 
      RowBox[{
       RowBox[{"FRecurrenceList", "[", 
        RowBox[{"burstlist", ",", "E1select", ",", "dtselect", ",", 
         RowBox[{"FilterRules", "[", 
          RowBox[{
           RowBox[{"{", "opts", "}"}], ",", " ", 
           RowBox[{"Options", "[", "FRecurrenceList", "]"}]}], "]"}]}], "]"}],
        "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "2"}], "]"}], "]"}]}], ";", "\n", 
     RowBox[{"Histo", "[", 
      RowBox[{"recdat", ",", "historange", ",", 
       RowBox[{"FilterRules", "[", 
        RowBox[{
         RowBox[{"{", "opts", "}"}], ",", " ", 
         RowBox[{"Options", "[", "Histo", "]"}]}], "]"}], ",", 
       RowBox[{"PlotRange", "->", "All"}]}], "]"}]}]}], "\n", "]"}]}]], "Code",\
ExpressionUUID->"06736f6c-968d-476d-a1f0-d00d41e02848"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"Plot", " ", "Recurrence", " ", "Histogram"}], ",", " ", 
    RowBox[{"Complete", " ", "Histogram"}]}], "*)"}], "\n", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"Options", "[", "FRecurrenceHistoN", "]"}], "=", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"LabelStyle", "->", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"FontFamily", "->", " ", "\"\<Helvetica\>\""}], ",", 
          RowBox[{"FontSize", "->", " ", "12"}]}], 
         RowBox[{"(*", 
          RowBox[{",", 
           RowBox[{"FontWeight", "->", " ", "Bold"}]}], "*)"}], "}"}]}], ",", 
       RowBox[{"FrameStyle", "->", 
        RowBox[{"Directive", "[", 
         RowBox[{"Black", ",", 
          RowBox[{"AbsoluteThickness", "[", "1", "]"}]}], "]"}]}], ",", 
       RowBox[{"ChartStyle", "->", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"Directive", "[", 
           RowBox[{
            RowBox[{"Opacity", "[", 
             RowBox[{"0.5", ",", 
              RowBox[{"Lighter", "[", 
               RowBox[{"Gray", ",", "0.9"}], "]"}]}], "]"}], ",", 
            RowBox[{"EdgeForm", "[", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"AbsoluteThickness", "[", "1", "]"}], ",", 
               RowBox[{"Lighter", "[", 
                RowBox[{"Gray", ",", "0.4"}], "]"}]}], "}"}], "]"}]}], "]"}], 
          ",", 
          RowBox[{"Directive", "[", 
           RowBox[{
            RowBox[{"Opacity", "[", 
             RowBox[{"0.2", ",", 
              RowBox[{"Darker", "[", 
               RowBox[{"Blue", ",", "0.2"}], "]"}]}], "]"}], ",", 
            RowBox[{"EdgeForm", "[", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"AbsoluteThickness", "[", "1", "]"}], ",", 
               RowBox[{"Opacity", "[", 
                RowBox[{"0.5", ",", 
                 RowBox[{"Darker", "[", 
                  RowBox[{"Blue", ",", "0.2"}], "]"}]}], "]"}]}], "}"}], 
             "]"}]}], "]"}]}], "}"}]}], ",", 
       RowBox[{"FrameTicksStyle", "->", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"FontFamily", "->", " ", "\"\<Helvetica\>\""}], ",", 
            RowBox[{"FontSize", "->", " ", "12"}]}], 
           RowBox[{"(*", 
            RowBox[{",", 
             RowBox[{"FontWeight", "->", " ", "Bold"}]}], "*)"}], "}"}], ",", 
          RowBox[{"Directive", "[", 
           RowBox[{"Black", ",", 
            RowBox[{"AbsoluteThickness", "[", "1", "]"}]}], "]"}]}], "}"}]}], 
       ",", 
       RowBox[{"Frame", "->", "True"}], ",", 
       RowBox[{"Axes", "->", "False"}], ",", 
       RowBox[{"AspectRatio", "->", "0.6"}], ",", 
       RowBox[{"ImageSize", "->", "500"}]}], "}"}]}], 
    RowBox[{"(*", 
     RowBox[{"~", "Join", "~", 
      RowBox[{"Options", "[", "FPlotHisto", "]"}]}], "*)"}], ";"}], "\n", 
   "\n", 
   RowBox[{
    RowBox[{"FRecurrenceHistoN", "[", 
     RowBox[{"burstlist_List", ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"E1_", "?", "NumberQ"}], ",", 
        RowBox[{"E2_", "?", "NumberQ"}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"t1_", "?", "NumberQ"}], ",", 
        RowBox[{"t2_", "?", "NumberQ"}]}], "}"}], ",", 
      RowBox[{"historange", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumberQ"}], ",", 
         RowBox[{"_", "?", "NumberQ"}], ",", 
         RowBox[{"_", "?", "NumberQ"}]}], "}"}]}], ",", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "recdat", ",", "HistFull", ",", "MaxFull", ",", "HistRec", ",", 
        "MaxRec", ",", "NumRec", ",", "ticks", ",", "texttemp", ",", 
        "PlotRec"}], "}"}], ",", "\n", 
      RowBox[{
       RowBox[{"PlotRec", ":=", 
        RowBox[{"Module", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
           "SpacingToHist", ",", "SpacingToFrame", ",", "Facto", ",", "y1", 
            ",", "y2", ",", "yRange", ",", 
            RowBox[{"LineThickness", "=", "1.5"}]}], "}"}], ",", "\n", 
          RowBox[{
           RowBox[{"SpacingToHist", "=", "0.0"}], ";", 
           RowBox[{"SpacingToFrame", "=", "0.04"}], ";", 
           RowBox[{"Facto", "=", "300"}], ";", "\n", 
           RowBox[{"y1", "=", 
            RowBox[{
             RowBox[{
              RowBox[{"-", "LineThickness"}], "/", "Facto"}], "-", 
             "SpacingToHist"}]}], ";", 
           RowBox[{"y2", "=", 
            RowBox[{"1.1", "+", 
             RowBox[{"LineThickness", "/", "Facto"}], "+", 
             "SpacingToHist"}]}], ";", 
           RowBox[{"yRange", "=", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"y1", "-", "SpacingToFrame"}], ",", 
              RowBox[{"y2", "+", 
               RowBox[{"3", " ", "SpacingToFrame"}]}]}], "}"}]}], ";", "\n", 
           RowBox[{"{", 
            RowBox[{"Red", ",", 
             RowBox[{"AbsoluteThickness", "[", "LineThickness", "]"}], ",", 
             RowBox[{"Line", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"{", 
                 RowBox[{"E1", ",", "y1"}], "}"}], ",", 
                RowBox[{"{", 
                 RowBox[{"E2", ",", "y1"}], "}"}], ",", 
                RowBox[{"{", 
                 RowBox[{"E2", ",", "y2"}], "}"}], ",", 
                RowBox[{"{", 
                 RowBox[{"E1", ",", "y2"}], "}"}], ",", 
                RowBox[{"{", 
                 RowBox[{"E1", ",", "y1"}], "}"}]}], "}"}], "]"}]}], 
            "}"}]}]}], "]"}]}], ";", "\n", 
       RowBox[{"recdat", "=", 
        RowBox[{
         RowBox[{"FRecurrenceList", "[", 
          RowBox[{"burstlist", ",", 
           RowBox[{"{", 
            RowBox[{"E1", ",", "E2"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"t1", ",", "t2"}], "}"}], ",", "opts"}], "]"}], "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "2"}], "]"}], "]"}]}], ";", "\n", 
       RowBox[{"HistRec", "=", 
        RowBox[{"Histo", "[", 
         RowBox[{"recdat", ",", "historange", ",", "opts", ",", 
          RowBox[{"FOutput", "->", "Data"}]}], "]"}]}], ";", 
       RowBox[{"NumRec", "=", 
        RowBox[{"Total", "[", 
         RowBox[{"HistRec", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}]}], ";", "\n", 
       RowBox[{"MaxRec", "=", 
        RowBox[{"Max", "[", 
         RowBox[{"HistRec", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}]}], ";", "\n", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"MaxRec", "!=", "0"}], ",", 
         RowBox[{
          RowBox[{"HistRec", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "2"}], "]"}], "]"}], "/=", "MaxRec"}]}], 
        "]"}], ";", "\n", 
       RowBox[{"HistFull", "=", 
        RowBox[{"Histo", "[", 
         RowBox[{
          RowBox[{"burstlist", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", "historange", ",", 
          RowBox[{"FOutput", "->", "Data"}]}], "]"}]}], ";", "\n", 
       RowBox[{"MaxFull", "=", 
        RowBox[{"Max", "[", 
         RowBox[{"HistFull", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}]}], ";", "\n", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"MaxFull", "!=", "0"}], ",", 
         RowBox[{
          RowBox[{"HistFull", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "2"}], "]"}], "]"}], "/=", "MaxFull"}]}], 
        "]"}], ";", "\n", "\n", 
       RowBox[{"texttemp", "=", 
        RowBox[{
        "\"\<\\!\\(\\*\nStyleBox[\\\"T\\\",\\nFontSlant->\\\"Italic\\\"]\\)=(\
\>\"", "<>", 
         RowBox[{"ToString", "[", "t1", "]"}], "<>", "\"\<,\>\"", "<>", 
         RowBox[{"ToString", "[", "t2", "]"}], "<>", "\"\<) ms\>\""}]}], ";", 
       "\n", 
       RowBox[{"FPlotHisto", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"HistFull", ",", "HistRec"}], "}"}], ",", 
         RowBox[{"Evaluate", "[", 
          RowBox[{"FilterRules", "[", 
           RowBox[{
            RowBox[{"{", "opts", "}"}], ",", " ", 
            RowBox[{"Options", "[", "FPlotHisto", "]"}]}], "]"}], "]"}], ",", 
         RowBox[{"FilterRules", "[", 
          RowBox[{
           RowBox[{"Options", "[", "FRecurrenceHistoN", "]"}], ",", " ", 
           RowBox[{"Options", "[", "FPlotHisto", "]"}]}], "]"}], ",", 
         RowBox[{"FrameLabel", "->", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"Style", "[", 
             RowBox[{"\"\<E\>\"", ",", "Italic"}], "]"}], ",", 
            RowBox[{"Style", "[", 
             RowBox[{
              RowBox[{"\"\<\[Times] \>\"", "<>", 
               RowBox[{"ToString", "[", "MaxRec", "]"}]}], ",", 
              RowBox[{"RGBColor", "[", 
               RowBox[{
               "0.360784", ",", " ", "0.611765", ",", " ", "0.921569"}], 
               "]"}]}], "]"}]}], "}"}]}], ",", "\n", 
         RowBox[{"PlotLabel", "->", "texttemp"}], ",", 
         RowBox[{"Epilog", "->", 
          RowBox[{"{", "PlotRec", "}"}]}], ",", 
         RowBox[{"PlotRange", "->", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"-", "0.02"}], ",", "1.15"}], "}"}]}]}], "]"}]}]}], "\n", 
     "]"}]}]}]}]], "Input",
 CellChangeTimes->{{3.749897024170521*^9, 3.7498970241864777`*^9}, {
   3.7505787314039145`*^9, 3.7505787357719955`*^9}, {3.7505789166957703`*^9, 
   3.7505789192240334`*^9}, {3.750578998988666*^9, 3.7505790156041355`*^9}, {
   3.7505792383326263`*^9, 3.75057925617935*^9}, {3.750579286780567*^9, 
   3.7505792952209826`*^9}, 3.750579342557377*^9, {3.750579387924983*^9, 
   3.750579470484173*^9}},ExpressionUUID->"bcc4ea39-0a38-4c48-9e27-\
9e73e589c5c4"],

Cell["\<\
FRecurrenceHisto2D histograms E1 and E2 in a  2D transfer efficiency \
histogram.\
\>", "Text",ExpressionUUID->"79b3110e-f9e1-464d-ab04-fd48d18e8191"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FRecurrenceHisto2D", "[", 
   RowBox[{"burstlist_List", ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"t1_", "?", "NumberQ"}], ",", 
      RowBox[{"t2_", "?", "NumberQ"}]}], "}"}], ",", 
    RowBox[{"historange", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumberQ"}], ",", 
       RowBox[{"_", "?", "NumberQ"}], ",", 
       RowBox[{"_", "?", "NumberQ"}]}], "}"}]}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"recdat", ",", "sbl"}], "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"sbl", "=", 
      RowBox[{"FRecurrenceList", "[", 
       RowBox[{"burstlist", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"historange", "[", 
           RowBox[{"[", "1", "]"}], "]"}], ",", 
          RowBox[{"historange", "[", 
           RowBox[{"[", "2", "]"}], "]"}]}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"t1", ",", "t2"}], "}"}], ",", 
        RowBox[{"FilterRules", "[", 
         RowBox[{
          RowBox[{"{", "opts", "}"}], ",", " ", 
          RowBox[{"Options", "[", "FRecurrenceList", "]"}]}], "]"}]}], 
       "]"}]}], ";", "\n", 
     RowBox[{"Histo2D", "[", 
      RowBox[{
       RowBox[{"sbl", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", 
          RowBox[{"1", ";;", "2"}]}], "]"}], "]"}], ",", "historange", ",", 
       "historange", ",", 
       RowBox[{"FilterRules", "[", 
        RowBox[{
         RowBox[{"{", "opts", "}"}], ",", " ", 
         RowBox[{"Options", "[", "Histo2D", "]"}]}], "]"}], ",", 
       RowBox[{"FrameLabel", "->", 
        RowBox[{"{", 
         RowBox[{
         "\"\<\\!\\(\\*SubscriptBox[\\(E\\), \\(1\\)]\\)\>\"", ",", 
          "\"\<\\!\\(\\*SubscriptBox[\\(E\\), \\(2\\)]\\)\>\"", ",", 
          RowBox[{"Style", "[", 
           RowBox[{
            RowBox[{
            "\"\<\\!\\(\\*\n\
StyleBox[\\\"T\\\",\\nFontSlant->\\\"Italic\\\"]\\)=(\>\"", "<>", " ", 
             RowBox[{"ToString", "[", "t1", "]"}], "<>", "\"\<,\>\"", "<>", 
             RowBox[{"ToString", "[", "t2", "]"}], "<>", "\"\<) ms,  #\>\"", "<>", 
             RowBox[{"ToString", "[", 
              RowBox[{"Length", "[", "sbl", "]"}], "]"}]}], ",", "Black"}], 
           "]"}]}], "}"}]}], ",", 
       RowBox[{"ClippingStyle", "->", 
        RowBox[{"{", 
         RowBox[{"White", ",", 
          RowBox[{"RGBColor", "[", 
           RowBox[{"0", ",", "0", ",", "0.5"}], "]"}]}], "}"}]}], ",", 
       RowBox[{"PlotRange", "->", 
        RowBox[{"{", 
         RowBox[{"All", ",", "All", ",", "All"}], "}"}]}], ",", 
       RowBox[{"ContourStyle", "->", "Gray"}], ",", 
       RowBox[{"InterpolationOrder", "->", "1"}], ",", 
       RowBox[{"Contours", "->", "12"}], ",", 
       RowBox[{"ColorFunction", "->", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"RGBColor", "[", 
           RowBox[{
            RowBox[{"0.3", " ", 
             RowBox[{"#", "/", "2"}]}], ",", 
            RowBox[{"0", " ", 
             RowBox[{"#", "/", "2"}]}], ",", "0.66", ",", 
            RowBox[{"0.8", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{
                RowBox[{"#", "/", "1"}], " ", "1"}], "+", "0.1"}], ")"}]}]}], 
           " ", "]"}], "&"}], ")"}]}], ",", 
       RowBox[{"AspectRatio", "->", "Automatic"}], ",", 
       RowBox[{"LabelStyle", "->", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"FontFamily", "->", " ", "\"\<Helvetica\>\""}], ",", 
          RowBox[{"FontSize", "->", " ", "16"}]}], "}"}]}], ",", 
       RowBox[{"FrameStyle", "->", " ", 
        RowBox[{"AbsoluteThickness", "[", "2", "]"}]}], ",", 
       RowBox[{"FrameTicksStyle", "->", 
        RowBox[{"AbsoluteThickness", "[", "2", "]"}]}]}], "]"}]}]}], "\n", 
   "]"}]}]], "Code",ExpressionUUID->"66489b1d-eadb-455e-aac6-9c6b7d2964e7"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FRecurrenceHisto2D", "[", 
   RowBox[{"burstlist_List", ",", "dtselect_", ",", 
    RowBox[{"historange", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumberQ"}], ",", 
       RowBox[{"_", "?", "NumberQ"}], ",", 
       RowBox[{"_", "?", "NumberQ"}]}], "}"}]}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"recdat", ",", "sbl"}], "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"sbl", "=", 
      RowBox[{"FRecurrenceList", "[", 
       RowBox[{"burstlist", ",", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"historange", "[", 
            RowBox[{"[", "1", "]"}], "]"}], "<", "#", "<", 
           RowBox[{"historange", "[", 
            RowBox[{"[", "2", "]"}], "]"}]}], ")"}], "&"}], ",", "dtselect", 
        ",", 
        RowBox[{"FilterRules", "[", 
         RowBox[{
          RowBox[{"{", "opts", "}"}], ",", " ", 
          RowBox[{"Options", "[", "FRecurrenceList", "]"}]}], "]"}]}], 
       "]"}]}], ";", "\n", 
     RowBox[{"Histo2D", "[", 
      RowBox[{
       RowBox[{"sbl", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", 
          RowBox[{"1", ";;", "2"}]}], "]"}], "]"}], ",", "historange", ",", 
       "historange", ",", 
       RowBox[{"FilterRules", "[", 
        RowBox[{
         RowBox[{"{", "opts", "}"}], ",", " ", 
         RowBox[{"Options", "[", "Histo2D", "]"}]}], "]"}], ",", 
       RowBox[{"FrameLabel", "->", 
        RowBox[{"{", 
         RowBox[{
         "\"\<\\!\\(\\*SubscriptBox[\\(E\\), \\(1\\)]\\)\>\"", ",", 
          "\"\<\\!\\(\\*SubscriptBox[\\(E\\), \\(2\\)]\\)\>\""}], "}"}]}], 
       ",", 
       RowBox[{"PlotLabel", "->", " ", 
        RowBox[{
         RowBox[{"ToString", "[", 
          RowBox[{"dtselect", "[", "\[CapitalDelta]t", "]"}], "]"}], "<>", 
         "\"\< ms\>\""}]}], ",", 
       RowBox[{"ContourStyle", "->", "Gray"}], ",", 
       RowBox[{"BoundaryStyle", "->", "Gray"}], ",", 
       RowBox[{"ClippingStyle", "->", 
        RowBox[{"{", 
         RowBox[{"White", ",", 
          RowBox[{"RGBColor", "[", 
           RowBox[{"0", ",", "0", ",", "0.5"}], "]"}]}], "}"}]}], ",", 
       RowBox[{"PlotRange", "->", 
        RowBox[{"{", 
         RowBox[{"All", ",", "All", ",", "All"}], "}"}]}], ",", 
       RowBox[{"InterpolationOrder", "->", "1"}], ",", 
       RowBox[{"Contours", "->", "12"}], ",", 
       RowBox[{"ColorFunction", "->", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"RGBColor", "[", 
           RowBox[{
            RowBox[{"0.3", " ", 
             RowBox[{"#", "/", "2"}]}], ",", 
            RowBox[{"0", " ", 
             RowBox[{"#", "/", "2"}]}], ",", "0.66", ",", 
            RowBox[{"0.8", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{
                RowBox[{"#", "/", "1"}], " ", "1"}], "+", "0.1"}], ")"}]}]}], 
           " ", "]"}], "&"}], ")"}]}], ",", 
       RowBox[{"AspectRatio", "->", "Automatic"}]}], "]"}]}]}], "\n", 
   "]"}]}]], "Code",ExpressionUUID->"b2f1f802-17f2-46e0-9a71-95378b7c626b"]
}, Closed]],

Cell[CellGroupData[{

Cell["Gdiff", "Subsubsection",ExpressionUUID->"54a36465-1c8a-4d6e-a02f-11449ca184d0"],

Cell[BoxData[
 RowBox[{"(*", "\n", 
  RowBox[{
   RowBox[{
    RowBox[{"Clear", "[", "FFCSModel", "]"}], "\n", 
    RowBox[{
     RowBox[{"Options", "[", "FFCSModel", "]"}], "=", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"FOutput", "->", "FGraph"}], ",", 
        RowBox[{"F2fFCSLambdaex", "->", ".485"}], ",", 
        RowBox[{"F2fFCSLambdaem", "->", ".515"}], ",", 
        RowBox[{"F2fFCSpinhole", "->", "100."}], ",", 
        RowBox[{"F2fFCSmagnification", "->", "60"}]}], "}"}], "~", "Join", 
      "~", " ", 
      RowBox[{"Options", "[", "ListPlot", "]"}]}]}]}], ";", "\n", "\n", 
   RowBox[{"(*", 
    RowBox[{
    "Version", " ", "where", " ", "amplitudes", " ", "are", " ", "obtained", 
     " ", 
     RowBox[{"internally", "."}]}], "*)"}], "\n", 
   RowBox[{
    RowBox[{"FFCSModel", "[", 
     RowBox[{
      RowBox[{"logtaus", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
      RowBox[{"diffs", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
      RowBox[{"velocities", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"vy_", "?", "NumberQ"}], ",", 
         RowBox[{"vz_", "?", "NumberQ"}]}], "}"}]}], ",", 
      RowBox[{"w0_", "?", "NumberQ"}], ",", 
      RowBox[{"R0_", "?", "NumberQ"}], ",", 
      RowBox[{"nrefractive_", "?", "NumberQ"}], ",", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"model", ",", "output", ",", "pl1", ",", "pl2"}], "}"}], ",", 
      "\n", "\n", 
      RowBox[{
       RowBox[{"model", "=", 
        RowBox[{"FPGdiff", "[", 
         RowBox[{
          RowBox[{"N", "@", "logtaus"}], ",", 
          RowBox[{"N", "@", "diffs"}], ",", 
          RowBox[{"N", "@", "w0"}], ",", 
          RowBox[{"N", "@", "R0"}], ",", 
          RowBox[{"N", "@", "vy"}], ",", 
          RowBox[{"N", "@", "vz"}], ",", 
          RowBox[{
           RowBox[{"N", "@", 
            RowBox[{"OptionValue", "[", "F2fFCSLambdaex", "]"}]}], "/", 
           "nrefractive"}], ",", 
          RowBox[{
           RowBox[{"N", "@", 
            RowBox[{"OptionValue", "[", "F2fFCSLambdaem", "]"}]}], "/", 
           "nrefractive"}], ",", 
          RowBox[{"N", "@", 
           RowBox[{"OptionValue", "@", "F2fFCSpinhole"}]}], ",", 
          RowBox[{"N", "@", 
           RowBox[{"OptionValue", "@", "F2fFCSmagnification"}]}]}], "]"}]}], 
       ";", "\n", "model"}]}], "\n", "]"}]}]}], "\n", "*)"}]], "Code",
 CellChangeTimes->{{3.80750768599228*^9, 3.8075076859962425`*^9}, {
  3.8075077200481853`*^9, 3.8075077200541997`*^9}, {3.865500325309529*^9, 
  3.865500344121319*^9}},ExpressionUUID->"1602d177-bdf1-45b3-88dd-\
3a6c39a24759"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"FAExplambdat", "[", 
    RowBox[{
     RowBox[{"A", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
     RowBox[{"lambda", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
     RowBox[{"times", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}]}], "]"}], ":=", 
   RowBox[{"FPAExplambdat", "[", 
    RowBox[{
     RowBox[{"N", "@", "A"}], ",", 
     RowBox[{"N", "@", "lambda"}], ",", 
     RowBox[{"N", "@", "times"}]}], "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{"FExpkAbst", "[", 
   RowBox[{
    RowBox[{"k_", "?", "NumberQ"}], ",", 
    RowBox[{"times", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}]}], "]"}], ":=", 
  RowBox[{"FPExpkAbst", "[", 
   RowBox[{
    RowBox[{"N", "@", "k"}], ",", 
    RowBox[{"N", "@", "times"}]}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FOneMinusExpkAbst", "[", 
   RowBox[{
    RowBox[{"k_", "?", "NumberQ"}], ",", 
    RowBox[{"times", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}]}], "]"}], ":=", 
  RowBox[{"FPOneMinusExpkAbst", "[", 
   RowBox[{
    RowBox[{"N", "@", "k"}], ",", 
    RowBox[{"N", "@", "times"}]}], "]"}]}]}], "Code",ExpressionUUID->\
"b4e15537-67e7-437d-bee9-1a64f5d9740a"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"FV2expKtV1pss", "[", 
    RowBox[{"K_", ",", 
     RowBox[{"V1pss", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
     RowBox[{"TotV2", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
     RowBox[{"times", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}]}], "]"}], ":=", 
   RowBox[{"FPV2expKtV1pss", "[", 
    RowBox[{
     RowBox[{"N", "@", 
      RowBox[{"Flatten", "@", "K"}]}], ",", 
     RowBox[{"N", "@", "V1pss"}], ",", 
     RowBox[{"N", "@", "TotV2"}], ",", 
     RowBox[{"N", "@", "times"}]}], "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{"FEigenSystem", "[", 
   RowBox[{"Km_", "?", 
    RowBox[{"(", 
     RowBox[{
      RowBox[{"MatrixQ", "[", 
       RowBox[{"#", ",", "NumberQ"}], "]"}], "&"}], ")"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"\[Lambda]", ",", "U", ",", "Uinv"}], "}"}], ",", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"\[Lambda]", ",", "U", ",", "Uinv"}], "}"}], "=", 
      RowBox[{"FPEigenSystem", "[", 
       RowBox[{
        RowBox[{"N", "@", 
         RowBox[{"Flatten", "[", 
          RowBox[{"Km", "\[Transpose]"}], "]"}]}], ",", 
        RowBox[{"Length", "[", "Km", "]"}]}], "]"}]}], ";", 
     RowBox[{"Chop", "@", 
      RowBox[{"{", 
       RowBox[{"\[Lambda]", ",", 
        RowBox[{"U", "\[Transpose]"}], ",", 
        RowBox[{"Uinv", "\[Transpose]"}]}], "}"}]}]}]}], "]"}]}]}], "Code",Exp\
ressionUUID->"2d664a9e-e1da-49da-97c2-33cae3bb5f81"]
}, Open  ]],

Cell[CellGroupData[{

Cell["2-focusFCS", "Subsubsection",ExpressionUUID->"f7c3aa43-612f-4bb4-9f71-3157856a3e0f"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "F2focusFCSExport", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"FPrintPlot", "->", "True"}], "}"}]}], ";"}]], "Code",ExpressionUU\
ID->"77d2befc-7edb-4cd2-97d1-185e80c45ed5"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"F2focusFCSExport", "[", 
    RowBox[{
    "filename_String", ",", " ", "logtaumin_", ",", " ", "logtaumax_", ",", 
     " ", "dlogtau_", ",", " ", 
     RowBox[{"route1", ":", "FRouteList"}], ",", " ", 
     RowBox[{"route2", ":", "FRouteList"}], ",", " ", "\n", "   ", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{
        RowBox[{"(", "ch11_", ")"}], "?", "FValidChannelQ"}], ",", " ", 
       RowBox[{
        RowBox[{"(", "ch12_", ")"}], "?", "FValidChannelQ"}]}], "}"}], ",", 
     " ", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{
        RowBox[{"(", "ch21_", ")"}], "?", "FValidChannelQ"}], ",", " ", 
       RowBox[{
        RowBox[{"(", "ch22_", ")"}], "?", "FValidChannelQ"}]}], "}"}], ",", 
     " ", "\n", "   ", 
     RowBox[{
      RowBox[{"(", "tstart_", ")"}], "?", "NumberQ"}], ",", " ", 
     RowBox[{
      RowBox[{"(", "tstop_", ")"}], "?", "NumberQ"}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "fcspl", ",", " ", "correldat", ",", " ", "logcorreldat", ",", " ", 
       "c11", ",", " ", "c12", ",", " ", "c21", ",", " ", "c22"}], "}"}], ",",
      " ", "\n", "   ", 
     RowBox[{
      RowBox[{"logcorreldat", " ", ":=", " ", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"Log", "[", 
             RowBox[{"10", ",", " ", 
              RowBox[{"#1", "[", 
               RowBox[{"[", "1", "]"}], "]"}]}], "]"}], ",", " ", 
            RowBox[{"#1", "[", 
             RowBox[{"[", "2", "]"}], "]"}]}], "}"}], " ", "&"}], " ", ")"}], 
        " ", "/@", " ", "correldat"}]}], ";", " ", 
      RowBox[{"fcspl", " ", ":=", " ", 
       RowBox[{"ListPlot", "[", 
        RowBox[{"logcorreldat", ",", " ", 
         RowBox[{"Joined", " ", "->", " ", "True"}], ",", " ", 
         RowBox[{"PlotRange", " ", "->", " ", "All"}], ",", " ", "\n", 
         "      ", 
         RowBox[{"Frame", " ", "->", " ", "True"}], ",", " ", 
         RowBox[{"Axes", " ", "->", " ", "False"}], ",", " ", 
         RowBox[{"FrameLabel", " ", "->", " ", 
          RowBox[{"{", 
           RowBox[{"\"\<log(\[Tau]/sec)\>\"", ",", " ", "\"\<G(\[Tau])\>\""}],
            "}"}]}], ",", " ", "\n", "      ", 
         RowBox[{"LabelStyle", " ", "->", " ", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"FontFamily", " ", "->", " ", "\"\<Helvetica\>\""}], ",", 
            " ", 
            RowBox[{"FontSize", " ", "->", " ", "12"}], ",", " ", 
            RowBox[{"FontWeight", " ", "->", " ", "Bold"}]}], "}"}]}]}], 
        "]"}]}], ";", " ", "\n", "    ", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"c11", ",", " ", "c22", ",", " ", "c12", ",", " ", "c21"}], 
        "}"}], " ", "=", " ", 
       RowBox[{"FFCS", "[", 
        RowBox[{
        "logtaumin", ",", " ", "logtaumax", ",", " ", "dlogtau", ",", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"route1", ",", " ", 
               RowBox[{"{", 
                RowBox[{"ch11", ",", " ", "ch12"}], "}"}]}], "}"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{"route2", ",", " ", 
               RowBox[{"{", 
                RowBox[{"ch11", ",", " ", "ch12"}], "}"}]}], "}"}]}], "}"}], 
           ",", " ", "\n", "       ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"route1", ",", " ", 
               RowBox[{"{", 
                RowBox[{"ch21", ",", " ", "ch22"}], "}"}]}], "}"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{"route2", ",", " ", 
               RowBox[{"{", 
                RowBox[{"ch21", ",", " ", "ch22"}], "}"}]}], "}"}]}], "}"}], 
           ",", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"route1", ",", " ", 
               RowBox[{"{", 
                RowBox[{"ch11", ",", " ", "ch12"}], "}"}]}], "}"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{"route2", ",", " ", 
               RowBox[{"{", 
                RowBox[{"ch21", ",", " ", "ch22"}], "}"}]}], "}"}]}], "}"}], 
           ",", " ", "\n", "       ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"route2", ",", " ", 
               RowBox[{"{", 
                RowBox[{"ch21", ",", " ", "ch22"}], "}"}]}], "}"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{"route1", ",", " ", 
               RowBox[{"{", 
                RowBox[{"ch11", ",", " ", "ch12"}], "}"}]}], "}"}]}], "}"}]}],
           "}"}], ",", " ", "tstart", ",", " ", "tstop"}], "]"}]}], ";", " ", 
      "\n", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "FPrintPlot", "]"}], "===", "True"}], 
        ",", " ", 
        RowBox[{"Print", "[", 
         RowBox[{"ListLogLinearPlot", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
            "c11", ",", " ", "c22", ",", " ", "c12", ",", " ", "c21"}], "}"}],
            ",", " ", 
           RowBox[{"Joined", " ", "->", " ", "True"}], " ", ",", 
           RowBox[{"PlotLabel", "->", "filename"}], ",", 
           RowBox[{"PlotRange", " ", "->", " ", "All"}], ",", " ", 
           RowBox[{"Frame", " ", "->", " ", "True"}], ",", " ", 
           RowBox[{"Axes", " ", "->", " ", "False"}], ",", "  ", 
           RowBox[{"FrameLabel", " ", "->", " ", 
            RowBox[{"{", 
             RowBox[{"\"\<\[Tau]/sec\>\"", ",", " ", "\"\<G(\[Tau])\>\""}], 
             "}"}]}], ",", 
           RowBox[{"LabelStyle", " ", "->", " ", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"FontFamily", " ", "->", " ", "\"\<Helvetica\>\""}], 
              ",", " ", 
              RowBox[{"FontSize", " ", "->", " ", "12"}], ",", " ", 
              RowBox[{"FontWeight", " ", "->", " ", "Bold"}]}], "}"}]}]}], 
          "]"}], "]"}]}], "\n", "]"}], ";", " ", "\n", "    ", 
      RowBox[{
       RowBox[{"c11", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "1"}], "]"}], "]"}], " ", "*=", " ", "1000."}], 
      ";", " ", 
      RowBox[{
       RowBox[{"c12", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "1"}], "]"}], "]"}], " ", "*=", " ", "1000."}], 
      ";", " ", 
      RowBox[{
       RowBox[{"c22", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "1"}], "]"}], "]"}], " ", "*=", " ", "1000."}], 
      ";", " ", 
      RowBox[{
       RowBox[{"c21", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "1"}], "]"}], "]"}], " ", "*=", " ", "1000."}], 
      ";", " ", "\n", "    ", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"Export", "[", 
         RowBox[{
          RowBox[{"StringJoin", "[", 
           RowBox[{"filename", ",", " ", "\"\<_c11.dat\>\""}], "]"}], ",", 
          " ", 
          RowBox[{"Prepend", "[", 
           RowBox[{"c11", ",", " ", 
            RowBox[{"{", 
             RowBox[{
             "\"\<Corr.Time[ms]\>\"", ",", " ", "\"\<Correlation(1->2)\>\""}],
              "}"}]}], "]"}], ",", " ", "\"\<Table\>\""}], "]"}], ",", " ", 
        "\n", "     ", 
        RowBox[{"Export", "[", 
         RowBox[{
          RowBox[{"StringJoin", "[", 
           RowBox[{"filename", ",", " ", "\"\<_c12.dat\>\""}], "]"}], ",", 
          " ", 
          RowBox[{"Prepend", "[", 
           RowBox[{
            RowBox[{"Transpose", "[", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"c12", "[", 
                RowBox[{"[", 
                 RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", " ", 
               RowBox[{"c12", "[", 
                RowBox[{"[", 
                 RowBox[{"All", ",", "2"}], "]"}], "]"}], ",", " ", 
               RowBox[{"c12", "[", 
                RowBox[{"[", 
                 RowBox[{"All", ",", "2"}], "]"}], "]"}], ",", " ", 
               RowBox[{"c12", "[", 
                RowBox[{"[", 
                 RowBox[{"All", ",", "2"}], "]"}], "]"}], ",", " ", "\n", 
               "         ", 
               RowBox[{"c21", "[", 
                RowBox[{"[", 
                 RowBox[{"All", ",", "2"}], "]"}], "]"}], ",", " ", 
               RowBox[{"c21", "[", 
                RowBox[{"[", 
                 RowBox[{"All", ",", "2"}], "]"}], "]"}]}], "}"}], "]"}], ",",
             " ", 
            RowBox[{"{", 
             RowBox[{
             "\"\<Corr.Time[ms]\>\"", ",", " ", "\"\<Correlation(1->2)\>\"", 
              ",", " ", "\"\<Correlation(1->2)\>\"", ",", " ", 
              "\"\<Correlation(1->2)\>\"", ",", " ", "\n", "        ", 
              "\"\<Correlation(2->1)\>\"", ",", " ", 
              "\"\<Correlation(2->1)\>\""}], "}"}]}], "]"}], ",", " ", 
          "\"\<Table\>\""}], "]"}], ",", " ", 
        RowBox[{"Export", "[", 
         RowBox[{
          RowBox[{"StringJoin", "[", 
           RowBox[{"filename", ",", " ", "\"\<_c22.dat\>\""}], "]"}], ",", 
          " ", "\n", "      ", 
          RowBox[{"Prepend", "[", 
           RowBox[{"c22", ",", " ", 
            RowBox[{"{", 
             RowBox[{
             "\"\<Corr.Time[ms]\>\"", ",", " ", "\"\<Correlation(1->2)\>\""}],
              "}"}]}], "]"}], ",", " ", "\"\<Table\>\""}], "]"}]}], "}"}]}]}],
     "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{"F2focusFCSExport", "[", 
   RowBox[{
   "filename_String", ",", " ", "logtaumin_", ",", " ", "logtaumax_", ",", 
    " ", "dlogtau_", ",", " ", 
    RowBox[{"route1", ":", "FRouteList"}], ",", " ", 
    RowBox[{"route2", ":", "FRouteList"}], ",", " ", "\n", "   ", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{
       RowBox[{"(", "ch11_", ")"}], "?", "FValidChannelQ"}], ",", " ", 
      RowBox[{
       RowBox[{"(", "ch12_", ")"}], "?", "FValidChannelQ"}]}], "}"}], ",", 
    " ", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{
       RowBox[{"(", "ch21_", ")"}], "?", "FValidChannelQ"}], ",", " ", 
      RowBox[{
       RowBox[{"(", "ch22_", ")"}], "?", "FValidChannelQ"}]}], "}"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", "\n", 
  "  ", 
  RowBox[{"F2focusFCSExport", "[", 
   RowBox[{
   "filename", ",", " ", "logtaumin", ",", " ", "logtaumax", ",", " ", 
    "dlogtau", ",", " ", "route1", ",", " ", "route2", ",", " ", 
    RowBox[{"{", 
     RowBox[{"ch11", ",", " ", "ch12"}], "}"}], ",", " ", 
    RowBox[{"{", 
     RowBox[{"ch21", ",", " ", "ch22"}], "}"}], ",", " ", 
    RowBox[{"-", "1."}], ",", " ", 
    RowBox[{"-", "1."}], ",", "opts"}], "]"}]}]}], "Code",ExpressionUUID->\
"1e0da07f-f19c-4ada-91a9-1aba3e52b7b9"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"F2fFCSFromTTTR", "[", " ", 
    RowBox[{
    "logtaumin_", ",", " ", "logtaumax_", ",", " ", "dlogtau_", ",", " ", 
     RowBox[{"route1", ":", "FRouteList"}], ",", " ", 
     RowBox[{"route2", ":", "FRouteList"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{
        RowBox[{"(", "ch11_", ")"}], "?", "FValidChannelQ"}], ",", " ", 
       RowBox[{
        RowBox[{"(", "ch12_", ")"}], "?", "FValidChannelQ"}]}], "}"}], ",", 
     " ", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{
        RowBox[{"(", "ch21_", ")"}], "?", "FValidChannelQ"}], ",", " ", 
       RowBox[{
        RowBox[{"(", "ch22_", ")"}], "?", "FValidChannelQ"}]}], "}"}], ",", 
     RowBox[{
      RowBox[{"(", "tstart_", ")"}], "?", "NumberQ"}], ",", " ", 
     RowBox[{
      RowBox[{"(", "tstop_", ")"}], "?", "NumberQ"}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", "\n", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "fcspl", ",", " ", "correldat", ",", " ", "logcorreldat", ",", " ", 
       "c11", ",", " ", "c12", ",", " ", "c21", ",", " ", "c22"}], "}"}], ",",
      "\[IndentingNewLine]", " ", 
     RowBox[{
      RowBox[{"logcorreldat", " ", ":=", " ", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"Log", "[", 
             RowBox[{"10", ",", " ", 
              RowBox[{"#1", "[", 
               RowBox[{"[", "1", "]"}], "]"}]}], "]"}], ",", " ", 
            RowBox[{"#1", "[", 
             RowBox[{"[", "2", "]"}], "]"}]}], "}"}], " ", "&"}], " ", ")"}], 
        " ", "/@", " ", "correldat"}]}], ";", " ", 
      RowBox[{"fcspl", " ", ":=", " ", 
       RowBox[{"ListPlot", "[", 
        RowBox[{"logcorreldat", ",", " ", 
         RowBox[{"Joined", " ", "->", " ", "True"}], ",", " ", 
         RowBox[{"PlotRange", " ", "->", " ", "All"}], ",", "  ", 
         RowBox[{"Frame", " ", "->", " ", "True"}], ",", " ", 
         RowBox[{"Axes", " ", "->", " ", "False"}], ",", " ", 
         RowBox[{"FrameLabel", " ", "->", " ", 
          RowBox[{"{", 
           RowBox[{"\"\<log(\[Tau]/sec)\>\"", ",", " ", "\"\<G(\[Tau])\>\""}],
            "}"}]}], ",", 
         RowBox[{"LabelStyle", " ", "->", " ", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"FontFamily", " ", "->", " ", "\"\<Helvetica\>\""}], ",", 
            " ", 
            RowBox[{"FontSize", " ", "->", " ", "12"}], ",", " ", 
            RowBox[{"FontWeight", " ", "->", " ", "Bold"}]}], "}"}]}]}], 
        "]"}]}], ";", " ", "\n", "    ", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"c11", ",", " ", "c22", ",", " ", "c12", ",", " ", "c21"}], 
        "}"}], " ", "=", " ", 
       RowBox[{"FFCS", "[", 
        RowBox[{
        "logtaumin", ",", " ", "logtaumax", ",", " ", "dlogtau", ",", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"route1", ",", " ", 
               RowBox[{"{", 
                RowBox[{"ch11", ",", " ", "ch12"}], "}"}]}], "}"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{"route2", ",", " ", 
               RowBox[{"{", 
                RowBox[{"ch11", ",", " ", "ch12"}], "}"}]}], "}"}]}], "}"}], 
           ",", " ", "\n", "       ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"route1", ",", " ", 
               RowBox[{"{", 
                RowBox[{"ch21", ",", " ", "ch22"}], "}"}]}], "}"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{"route2", ",", " ", 
               RowBox[{"{", 
                RowBox[{"ch21", ",", " ", "ch22"}], "}"}]}], "}"}]}], "}"}], 
           ",", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"route1", ",", " ", 
               RowBox[{"{", 
                RowBox[{"ch11", ",", " ", "ch12"}], "}"}]}], "}"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{"route2", ",", " ", 
               RowBox[{"{", 
                RowBox[{"ch21", ",", " ", "ch22"}], "}"}]}], "}"}]}], "}"}], 
           ",", " ", "\n", "       ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"route2", ",", " ", 
               RowBox[{"{", 
                RowBox[{"ch21", ",", " ", "ch22"}], "}"}]}], "}"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{"route1", ",", " ", 
               RowBox[{"{", 
                RowBox[{"ch11", ",", " ", "ch12"}], "}"}]}], "}"}]}], "}"}]}],
           "}"}], ",", " ", "tstart", ",", " ", "tstop"}], "]"}]}], ";", "  ",
       "\n", "    ", 
      RowBox[{
       RowBox[{"c11", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "1"}], "]"}], "]"}], " ", "*=", " ", "1000."}], 
      ";", " ", 
      RowBox[{
       RowBox[{"c12", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "1"}], "]"}], "]"}], " ", "*=", " ", "1000."}], 
      ";", " ", 
      RowBox[{
       RowBox[{"c22", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "1"}], "]"}], "]"}], " ", "*=", " ", "1000."}], 
      ";", " ", 
      RowBox[{
       RowBox[{"c21", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "1"}], "]"}], "]"}], " ", "*=", " ", "1000."}], 
      ";", " ", "\n", "    ", 
      RowBox[{"{", 
       RowBox[{"c11", ",", "c22", ",", "c12", ",", "c21"}], "}"}]}]}], 
    "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{"F2fFCSFromTTTR", "[", " ", 
   RowBox[{
   "logtaumin_", ",", " ", "logtaumax_", ",", " ", "dlogtau_", ",", " ", 
    RowBox[{"route1", ":", "FRouteList"}], ",", " ", 
    RowBox[{"route2", ":", "FRouteList"}], ",", " ", "\n", "   ", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{
       RowBox[{"(", "ch11_", ")"}], "?", "FValidChannelQ"}], ",", " ", 
      RowBox[{
       RowBox[{"(", "ch12_", ")"}], "?", "FValidChannelQ"}]}], "}"}], ",", 
    " ", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{
       RowBox[{"(", "ch21_", ")"}], "?", "FValidChannelQ"}], ",", " ", 
      RowBox[{
       RowBox[{"(", "ch22_", ")"}], "?", "FValidChannelQ"}]}], "}"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", "\n", 
  "  ", 
  RowBox[{"F2fFCSFromTTTR", "[", " ", 
   RowBox[{
   "logtaumin", ",", " ", "logtaumax", ",", " ", "dlogtau", ",", " ", 
    "route1", ",", " ", "route2", ",", " ", 
    RowBox[{"{", 
     RowBox[{"ch11", ",", " ", "ch12"}], "}"}], ",", " ", 
    RowBox[{"{", 
     RowBox[{"ch21", ",", " ", "ch22"}], "}"}], ",", " ", 
    RowBox[{"-", "1."}], ",", " ", 
    RowBox[{"-", "1."}], ",", "opts"}], "]"}]}]}], "Input",
 CellChangeTimes->{
  3.7506772425649753`*^9},ExpressionUUID->"1497e937-83a7-493d-85ef-\
5d949135f032"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"F2focusFCSInit", "[", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"LambdaEx_", "?", "FRealNumberQ"}], ",", 
      RowBox[{"LambdaEm_", "?", "FRealNumberQ"}], ",", 
      RowBox[{"FociDistance_", "?", "FRealNumberQ"}], ",", 
      RowBox[{"PinholeDiameter_", "?", "FRealNumberQ"}], ",", 
      RowBox[{"magnification_", "?", "FRealNumberQ"}]}], "}"}], "]"}], ":=", 
   " ", 
   RowBox[{"FP2fFCSInit", "[", 
    RowBox[{
     RowBox[{"N", "@", "LambdaEx"}], ",", 
     RowBox[{"N", "@", "LambdaEm"}], ",", 
     RowBox[{"N", "@", "FociDistance"}], ",", 
     RowBox[{"N", "@", "PinholeDiameter"}], ",", 
     RowBox[{"N", "@", "magnification"}]}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"F2focusFCSSetData", "[", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"times", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "FRealNumberQ"}], ".."}], "}"}]}], ",", 
      RowBox[{"g11", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "FRealNumberQ"}], ".."}], "}"}]}], ",", 
      RowBox[{"g22", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "FRealNumberQ"}], ".."}], "}"}]}], ",", 
      RowBox[{"g12", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "FRealNumberQ"}], ".."}], "}"}]}], ",", 
      RowBox[{"g21", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "FRealNumberQ"}], ".."}], "}"}]}]}], "}"}], "]"}], 
   ":=", " ", 
   RowBox[{"FP2fFCSSetData", "[", 
    RowBox[{
     RowBox[{"N", "@", "times"}], ",", 
     RowBox[{"N", "@", "g11"}], ",", 
     RowBox[{"N", "@", "g22"}], ",", 
     RowBox[{"N", "@", "g12"}], ",", 
     RowBox[{"N", "@", "g21"}]}], "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"F2focusFCSChiSqr", "[", 
    RowBox[{
     RowBox[{"diffs", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "FRealNumberQ"}], ".."}], "}"}]}], ",", 
     RowBox[{"kTs", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "FRealNumberQ"}], ".."}], "}"}]}], ",", 
     RowBox[{"w0_", "?", "FRealNumberQ"}], ",", 
     RowBox[{"R0_", "?", "FRealNumberQ"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"vx_", "?", "FRealNumberQ"}], ",", 
       RowBox[{"vy_", "?", "FRealNumberQ"}], ",", 
       RowBox[{"vz_", "?", "FRealNumberQ"}]}], "}"}]}], "]"}], ":=", " ", 
   RowBox[{"FP2fFCSChiSqr", "[", 
    RowBox[{
     RowBox[{"N", "@", 
      RowBox[{"Abs", "@", "diffs"}]}], ",", 
     RowBox[{"Abs", "@", 
      RowBox[{"N", "@", "kTs"}]}], ",", 
     RowBox[{"Abs", "@", 
      RowBox[{"N", "@", "w0"}]}], ",", 
     RowBox[{"Abs", "@", 
      RowBox[{"N", "@", "R0"}]}], ",", 
     RowBox[{"N", "@", "vx"}], ",", 
     RowBox[{"N", "@", "vy"}], ",", 
     RowBox[{"N", "@", "vz"}]}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"F2focusFCSModel", "[", 
    RowBox[{
     RowBox[{"diffs", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "FRealNumberQ"}], ".."}], "}"}]}], ",", 
     RowBox[{"kTs", ":", 
      RowBox[{"{", 
       RowBox[{"___", "?", "FRealNumberQ"}], "}"}]}], ",", 
     RowBox[{"w0_", "?", "FRealNumberQ"}], ",", 
     RowBox[{"R0_", "?", "FRealNumberQ"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"vx_", "?", "FRealNumberQ"}], ",", 
       RowBox[{"vy_", "?", "FRealNumberQ"}], ",", 
       RowBox[{"vz_", "?", "FRealNumberQ"}]}], "}"}]}], "]"}], ":=", " ", 
   RowBox[{"FP2fFCSModel", "[", 
    RowBox[{
     RowBox[{"N", "@", 
      RowBox[{"Abs", "@", "diffs"}]}], ",", 
     RowBox[{"N", "@", 
      RowBox[{"Abs", "@", "kTs"}]}], ",", 
     RowBox[{"Abs", "@", 
      RowBox[{"N", "@", "w0"}]}], ",", 
     RowBox[{"Abs", "@", 
      RowBox[{"N", "@", "R0"}]}], ",", 
     RowBox[{"N", "@", "vx"}], ",", 
     RowBox[{"N", "@", "vy"}], ",", 
     RowBox[{"N", "@", "vz"}]}], "]"}]}], ";"}], "\n"}], "Code",ExpressionUUID\
->"c143438d-f5ed-4b84-9a3d-a110897f8ecc"],

Cell[BoxData[
 RowBox[{
  RowBox[{"F2fFCSSettings", "[", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"\[Lambda]ex_", "?", "NumberQ"}], ",", 
     RowBox[{"\[Lambda]em_", "?", "NumberQ"}], ",", 
     RowBox[{"focidistance_", "?", "NumberQ"}], ",", 
     RowBox[{"pinhole_", "?", "NumberQ"}], ",", 
     RowBox[{"magnification_", "?", "NumberQ"}]}], "}"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "set", "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"set", "=", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"F2fFCSLambdaex", "->", "\[Lambda]ex"}], ",", 
        RowBox[{"F2fFCSLambdaem", "->", "\[Lambda]em"}], ",", 
        RowBox[{"F2fFCSfocidistance", "->", "focidistance"}], ",", 
        RowBox[{"F2fFCSpinhole", "->", "pinhole"}], ",", 
        RowBox[{"F2fFCSmagnification", "->", "magnification"}]}], "}"}]}], 
     ";", "\n", 
     RowBox[{"SetOptions", "[", 
      RowBox[{"F2fFCSGetModel", ",", "set"}], "]"}], ";", "\n", 
     RowBox[{"SetOptions", "[", 
      RowBox[{"F2fFCSFit", ",", "set"}], "]"}], ";", "\n", 
     RowBox[{"SetOptions", "[", 
      RowBox[{"F2fFCSGetLinearCoefficients", ",", "set"}], "]"}]}]}], "\n", 
   "]"}]}]], "Code",
 CellChangeTimes->{3.8075076860052185`*^9, 
  3.80750772006514*^9},ExpressionUUID->"61a3aa7b-79cb-4aa1-9886-16d56696bcd3"],

Cell[BoxData[{
 RowBox[{"Clear", "[", "F2fFCSGetModel", "]"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "F2fFCSGetModel", "]"}], "=", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"FOutput", "->", "FGraph"}], ",", 
       RowBox[{"F2fFCSLambdaex", "->", ".485"}], ",", 
       RowBox[{"F2fFCSLambdaem", "->", ".515"}], ",", 
       RowBox[{"F2fFCSfocidistance", "->", ".440"}], ",", 
       RowBox[{"F2fFCSpinhole", "->", "150."}], ",", 
       RowBox[{"F2fFCSmagnification", "->", "60"}]}], "}"}], "~", "Join", "~",
      " ", 
     RowBox[{"Options", "[", "ListPlot", "]"}]}]}], ";"}], "\n", "\n", 
  RowBox[{"(*", 
   RowBox[{
   "Version", " ", "where", " ", "amplitudes", " ", "are", " ", "obtained", 
    " ", 
    RowBox[{"internally", "."}]}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{"F2fFCSGetModel", "[", 
   RowBox[{
    RowBox[{"data", ":", 
     RowBox[{"{", 
      RowBox[{"Repeated", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}], ",", "5"}], "]"}], 
      "}"}]}], ",", 
    RowBox[{"diffs", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
    RowBox[{"velocities", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumberQ"}], ",", 
       RowBox[{"_", "?", "NumberQ"}], ",", 
       RowBox[{"_", "?", "NumberQ"}]}], "}"}]}], ",", 
    RowBox[{"kTs", ":", 
     RowBox[{"{", 
      RowBox[{"___", "?", "NumberQ"}], "}"}]}], ",", 
    RowBox[{"w0_", "?", "NumberQ"}], ",", 
    RowBox[{"R0_", "?", "NumberQ"}], ",", 
    RowBox[{"nrefractive_", "?", "NumberQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"model", ",", "output", ",", "pl1", ",", "pl2"}], "}"}], ",", 
    RowBox[{
     RowBox[{"F2focusFCSInit", "[", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "F2fFCSLambdaex", "]"}], "/", 
         "nrefractive"}], ",", 
        RowBox[{
         RowBox[{"OptionValue", "[", "F2fFCSLambdaem", "]"}], "/", 
         "nrefractive"}], ",", 
        RowBox[{"OptionValue", "@", "F2fFCSfocidistance"}], ",", 
        RowBox[{"OptionValue", "@", "F2fFCSpinhole"}], ",", 
        RowBox[{"OptionValue", "@", "F2fFCSmagnification"}]}], "}"}], "]"}], 
     ";", "\n", 
     RowBox[{"F2focusFCSSetData", "[", "data", "]"}], ";", "\n", 
     RowBox[{"model", "=", 
      RowBox[{"F2focusFCSModel", "[", 
       RowBox[{"diffs", ",", "kTs", ",", "w0", ",", "R0", ",", "velocities"}],
        "]"}]}], ";", "\n", 
     RowBox[{"output", "=", 
      RowBox[{"Map", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"Log", "[", 
             RowBox[{"10", ",", 
              RowBox[{"data", "[", 
               RowBox[{"[", "1", "]"}], "]"}]}], "]"}], ",", "#"}], "}"}], 
          "\[Transpose]"}], "&"}], ",", "model"}], "]"}]}], ";", "\n", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FGraph"}], ",", 
       "\n", 
       RowBox[{
        RowBox[{"pl1", "=", 
         RowBox[{"ListPlot", "[", 
          RowBox[{"output", ",", 
           RowBox[{"FilterRules", "[", 
            RowBox[{
             RowBox[{"{", "opts", "}"}], ",", " ", 
             RowBox[{"Options", "[", "ListPlot", "]"}]}], "]"}], ",", 
           RowBox[{"Joined", "->", "True"}], ",", 
           RowBox[{"PlotRange", "->", "All"}], ",", 
           RowBox[{"Frame", "->", "True"}], ",", 
           RowBox[{"Axes", "->", "False"}], ",", 
           RowBox[{"FrameLabel", "->", 
            RowBox[{"{", 
             RowBox[{
             "\"\<log(\[Tau]/ms)\>\"", ",", " ", "\"\<G(\[Tau])\>\""}], 
             "}"}]}], ",", 
           RowBox[{"LabelStyle", "->", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"FontFamily", "->", " ", "\"\<Helvetica\>\""}], ",", 
              RowBox[{"FontSize", "->", " ", "12"}], ",", 
              RowBox[{"FontWeight", "->", " ", "Bold"}]}], "}"}]}], ",", 
           RowBox[{"PlotStyle", "->", 
            RowBox[{"AbsoluteThickness", "[", "2", "]"}]}]}], "]"}]}], ";", 
        RowBox[{"pl2", "=", 
         RowBox[{"ListPlot", "[", 
          RowBox[{
           RowBox[{"Map", "[", 
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"Log", "[", 
                  RowBox[{"10", ",", 
                   RowBox[{"data", "[", 
                    RowBox[{"[", "1", "]"}], "]"}]}], "]"}], ",", "#"}], 
                "}"}], "\[Transpose]"}], "&"}], ",", 
             RowBox[{"data", "[", 
              RowBox[{"[", 
               RowBox[{"2", ";;"}], "]"}], "]"}]}], "]"}], ",", 
           RowBox[{"FilterRules", "[", 
            RowBox[{
             RowBox[{"{", "opts", "}"}], ",", " ", 
             RowBox[{"Options", "[", "ListPlot", "]"}]}], "]"}], ",", 
           RowBox[{"PlotRange", "->", "All"}]}], "]"}]}], ";", 
        RowBox[{"output", "=", 
         RowBox[{"Show", "[", 
          RowBox[{"pl1", ",", "pl2"}], "]"}]}], ";"}]}], "\n", "]"}], ";", 
     "\n", "output"}]}], "\n", "]"}]}], "\n"}], "Code",
 CellChangeTimes->{{3.807507686021203*^9, 3.8075076860271587`*^9}, {
  3.8075077200751443`*^9, 
  3.807507720081097*^9}},ExpressionUUID->"e0925ef3-8ea0-4fee-be89-\
e0d8f80591e2"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"F2fFCSGetModel", "[", 
     RowBox[{
      RowBox[{"data", ":", 
       RowBox[{"{", 
        RowBox[{"Repeated", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"_", "?", "NumberQ"}], ",", 
              RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}], ",", 
          "4"}], "]"}], "}"}]}], ",", 
      RowBox[{"diffs", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
      RowBox[{"velocities", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumberQ"}], ",", 
         RowBox[{"_", "?", "NumberQ"}], ",", 
         RowBox[{"_", "?", "NumberQ"}]}], "}"}]}], ",", 
      RowBox[{"kTs", ":", 
       RowBox[{"{", 
        RowBox[{"___", "?", "NumberQ"}], "}"}]}], ",", "w0_", ",", "R0_", ",", 
      RowBox[{"nrefractive_", "?", "NumberQ"}], ",", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "dat5", "}"}], ",", "\n", 
      RowBox[{
       RowBox[{"dat5", "=", 
        RowBox[{"Join", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"data", "[", 
            RowBox[{"[", 
             RowBox[{"1", ",", "All", ",", "1"}], "]"}], "]"}], "}"}], ",", 
          RowBox[{"data", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "All", ",", "2"}], "]"}], "]"}]}], "]"}]}], 
       ";", "\n", 
       RowBox[{"F2fFCSGetModel", "[", 
        RowBox[{
        "dat5", ",", "diffs", ",", "velocities", ",", "kTs", ",", "w0", ",", 
         "R0", ",", "nrefractive", ",", "opts"}], "]"}]}]}], "\n", "]"}]}], 
   "*)"}], "\n", "\n", 
  RowBox[{"(*", 
   RowBox[{
   "Version", " ", "where", " ", "amplitudes", " ", "are", " ", "given", " ", 
    "as", " ", "functions", " ", 
    RowBox[{"arguments", "."}]}], "*)"}], "\n", 
  RowBox[{
   RowBox[{
    RowBox[{"F2fFCSGetModel", "[", 
     RowBox[{
      RowBox[{"lagtimes", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
      RowBox[{"diffs", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumberQ"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"_", "?", "NumberQ"}], ",", 
             RowBox[{"_", "?", "NumberQ"}]}], "}"}]}], "}"}], ".."}], "}"}]}],
       ",", 
      RowBox[{"velocities", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"vx_", "?", "FRealNumberQ"}], ",", 
         RowBox[{"vy_", "?", "FRealNumberQ"}], ",", 
         RowBox[{"vz_", "?", "FRealNumberQ"}]}], "}"}]}], ",", 
      RowBox[{"kTs", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumberQ"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"_", "?", "NumberQ"}], ",", 
             RowBox[{"_", "?", "NumberQ"}], ",", 
             RowBox[{"_", "?", "NumberQ"}], ",", 
             RowBox[{"_", "?", "NumberQ"}]}], "}"}]}], "}"}], "..."}], 
        "}"}]}], ",", 
      RowBox[{"offsets", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumberQ"}], ",", 
         RowBox[{"_", "?", "NumberQ"}], ",", 
         RowBox[{"_", "?", "NumberQ"}], ",", 
         RowBox[{"_", "?", "NumberQ"}]}], "}"}]}], ",", 
      RowBox[{"w0_", "?", "NumberQ"}], ",", 
      RowBox[{"R0_", "?", "NumberQ"}], ",", 
      RowBox[{"nrefractive_", "?", "NumberQ"}], ",", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", "\n", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"vecdat", ",", "coeff", ",", "output"}], "}"}], ",", 
      RowBox[{
       RowBox[{"F2focusFCSInit", "[", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{
           RowBox[{"OptionValue", "[", "F2fFCSLambdaex", "]"}], "/", 
           "nrefractive"}], ",", 
          RowBox[{
           RowBox[{"OptionValue", "[", "F2fFCSLambdaem", "]"}], "/", 
           "nrefractive"}], ",", 
          RowBox[{"OptionValue", "@", "F2fFCSfocidistance"}], ",", 
          RowBox[{"OptionValue", "@", "F2fFCSpinhole"}], ",", 
          RowBox[{"OptionValue", "@", "F2fFCSmagnification"}]}], "}"}], "]"}],
        ";", "\n", 
       RowBox[{"vecdat", "=", 
        RowBox[{"FP2fFCSModelVectors", "[", 
         RowBox[{"lagtimes", ",", 
          RowBox[{"diffs", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", 
          RowBox[{"kTs", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", "w0", ",", "R0", 
          ",", 
          RowBox[{"N", "@", "vx"}], ",", 
          RowBox[{"N", "@", "vy"}], ",", 
          RowBox[{"N", "@", "vz"}]}], "]"}]}], ";", "\n", 
       RowBox[{"coeff", "=", 
        RowBox[{"Map", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"#", "[", 
              RowBox[{"[", "1", "]"}], "]"}], ",", 
             RowBox[{"#", "[", 
              RowBox[{"[", "2", "]"}], "]"}], ",", 
             RowBox[{"Sqrt", "[", 
              RowBox[{
               RowBox[{"#", "[", 
                RowBox[{"[", "1", "]"}], "]"}], "*", 
               RowBox[{"#", "[", 
                RowBox[{"[", "2", "]"}], "]"}]}], "]"}], ",", 
             RowBox[{"Sqrt", "[", 
              RowBox[{
               RowBox[{"#", "[", 
                RowBox[{"[", "1", "]"}], "]"}], "*", 
               RowBox[{"#", "[", 
                RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}], "}"}], "&"}], ",", 
          RowBox[{"diffs", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "2"}], "]"}], "]"}]}], "]"}]}], ";", "\n", 
       RowBox[{"coeff", "=", 
        RowBox[{
         RowBox[{"Join", "[", 
          RowBox[{"coeff", ",", 
           RowBox[{"kTs", "[", 
            RowBox[{"[", 
             RowBox[{"All", ",", "2"}], "]"}], "]"}], ",", 
           RowBox[{"{", "offsets", "}"}]}], "]"}], "\[Transpose]"}]}], ";", 
       "\n", 
       RowBox[{"output", "=", 
        RowBox[{"MapThread", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"Log", "[", 
               RowBox[{"10", ",", "lagtimes"}], "]"}], ",", 
              RowBox[{"Total", "[", 
               RowBox[{
                RowBox[{"#1", "\[Transpose]"}], "#2"}], "]"}]}], "}"}], 
            "\[Transpose]"}], "&"}], ",", 
          RowBox[{"{", 
           RowBox[{"vecdat", ",", "coeff"}], "}"}]}], "]"}]}], ";", "\n", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FGraph"}], 
         ",", "\n", 
         RowBox[{
          RowBox[{"output", "=", 
           RowBox[{"ListPlot", "[", 
            RowBox[{"output", ",", 
             RowBox[{"FilterRules", "[", 
              RowBox[{
               RowBox[{"{", "opts", "}"}], ",", " ", 
               RowBox[{"Options", "[", "ListPlot", "]"}]}], "]"}], ",", 
             RowBox[{"Joined", "->", "True"}], ",", 
             RowBox[{"PlotRange", "->", "All"}], ",", 
             RowBox[{"Frame", "->", "True"}], ",", 
             RowBox[{"Axes", "->", "False"}], ",", 
             RowBox[{"FrameLabel", "->", 
              RowBox[{"{", 
               RowBox[{
               "\"\<log(\[Tau]/ms)\>\"", ",", " ", "\"\<G(\[Tau])\>\""}], 
               "}"}]}], ",", 
             RowBox[{"LabelStyle", "->", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"FontFamily", "->", " ", "\"\<Helvetica\>\""}], ",", 
                RowBox[{"FontSize", "->", " ", "12"}], ",", 
                RowBox[{"FontWeight", "->", " ", "Bold"}]}], "}"}]}], ",", 
             RowBox[{"PlotStyle", "->", 
              RowBox[{"AbsoluteThickness", "[", "2", "]"}]}]}], "]"}]}], 
          ";"}]}], "\n", "]"}], ";", "\n", "output"}]}], "\n", "]"}]}], "\n", 
   "\n", 
   RowBox[{
    RowBox[{"F2fFCSGetModel", "[", 
     RowBox[{
      RowBox[{"data", ":", 
       RowBox[{"{", 
        RowBox[{"Repeated", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}], ",", "5"}], "]"}], 
        "}"}]}], ",", 
      RowBox[{"diffs", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumberQ"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"_", "?", "NumberQ"}], ",", 
             RowBox[{"_", "?", "NumberQ"}]}], "}"}]}], "}"}], ".."}], "}"}]}],
       ",", 
      RowBox[{"velocities", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumberQ"}], ",", 
         RowBox[{"_", "?", "NumberQ"}], ",", 
         RowBox[{"_", "?", "NumberQ"}]}], "}"}]}], ",", 
      RowBox[{"kTs", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumberQ"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"_", "?", "NumberQ"}], ",", 
             RowBox[{"_", "?", "NumberQ"}], ",", 
             RowBox[{"_", "?", "NumberQ"}], ",", 
             RowBox[{"_", "?", "NumberQ"}]}], "}"}]}], "}"}], "..."}], 
        "}"}]}], ",", 
      RowBox[{"offsets", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumberQ"}], ",", 
         RowBox[{"_", "?", "NumberQ"}], ",", 
         RowBox[{"_", "?", "NumberQ"}], ",", 
         RowBox[{"_", "?", "NumberQ"}]}], "}"}]}], ",", 
      RowBox[{"w0_", "?", "NumberQ"}], ",", 
      RowBox[{"R0_", "?", "NumberQ"}], ",", 
      RowBox[{"nrefractive_", "?", "NumberQ"}], ",", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{"F2fFCSGetModel", "[", 
     RowBox[{
      RowBox[{"data", "[", 
       RowBox[{"[", "1", "]"}], "]"}], ",", "diffs", ",", "velocities", ",", 
      "kTs", ",", "offsets", ",", "w0", ",", "R0", ",", "nrefractive", ",", 
      "opts"}], "]"}]}]}]}]], "Code",
 CellChangeTimes->{3.807507686046136*^9, 
  3.807507720093094*^9},ExpressionUUID->"694aed78-46ce-4a8c-807a-\
556fd040f739"],

Cell[BoxData[
 RowBox[{
  RowBox[{"F2fFCSGetModel", "[", 
   RowBox[{
    RowBox[{"data", ":", 
     RowBox[{"{", 
      RowBox[{"Repeated", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumberQ"}], ",", 
            RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}], ",", "4"}],
        "]"}], "}"}]}], ",", "var__"}], "]"}], ":=", "\n", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "dat5", "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"dat5", "=", 
      RowBox[{"Join", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"data", "[", 
          RowBox[{"[", 
           RowBox[{"1", ",", "All", ",", "1"}], "]"}], "]"}], "}"}], ",", 
        RowBox[{"data", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "All", ",", "2"}], "]"}], "]"}]}], "]"}]}], ";", 
     RowBox[{"F2fFCSGetModel", "[", 
      RowBox[{"dat5", ",", "var"}], "]"}]}]}], "\n", "]"}]}]], "Code",Expressi\
onUUID->"292ddab8-0f13-4598-873e-7f2c09cbfe78"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "F2fFCSGetLinearCoefficients", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"F2fFCSLambdaex", "->", ".485"}], ",", 
     RowBox[{"F2fFCSLambdaem", "->", ".515"}], ",", 
     RowBox[{"F2fFCSfocidistance", "->", ".440"}], ",", 
     RowBox[{"F2fFCSpinhole", "->", "150."}], ",", 
     RowBox[{"F2fFCSmagnification", "->", "60"}]}], "}"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"F2fFCSGetLinearCoefficients", "[", 
    RowBox[{
     RowBox[{"data", ":", 
      RowBox[{"{", 
       RowBox[{"Repeated", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}], ",", "5"}], "]"}], 
       "}"}]}], ",", 
     RowBox[{"diffs", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"vx_", "?", "FRealNumberQ"}], ",", 
       RowBox[{"vy_", "?", "FRealNumberQ"}], ",", 
       RowBox[{"vz_", "?", "FRealNumberQ"}]}], "}"}], ",", 
     RowBox[{"kTs", ":", 
      RowBox[{"{", 
       RowBox[{"___", "?", "NumberQ"}], "}"}]}], ",", "w0_", ",", "R0_", ",", 
     RowBox[{"nrefractive_", "?", "NumberQ"}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "}"}], ",", "\n", 
     RowBox[{
      RowBox[{"F2focusFCSInit", "[", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"OptionValue", "[", "F2fFCSLambdaex", "]"}], "/", 
          "nrefractive"}], ",", 
         RowBox[{
          RowBox[{"OptionValue", "[", "F2fFCSLambdaem", "]"}], "/", 
          "nrefractive"}], ",", 
         RowBox[{"OptionValue", "@", "F2fFCSfocidistance"}], ",", 
         RowBox[{"OptionValue", "@", "F2fFCSpinhole"}], ",", 
         RowBox[{"OptionValue", "@", "F2fFCSmagnification"}]}], "}"}], "]"}], 
      ";", "\n", 
      RowBox[{"F2focusFCSSetData", "[", "data", "]"}], ";", "\n", 
      RowBox[{"FP2fFCSLinearCoefficients", "[", 
       RowBox[{
        RowBox[{"N", "@", 
         RowBox[{"Abs", "@", "diffs"}]}], ",", 
        RowBox[{"N", "@", 
         RowBox[{"Abs", "@", "kTs"}]}], ",", 
        RowBox[{"N", "@", 
         RowBox[{"Abs", "@", "w0"}]}], ",", 
        RowBox[{"N", "@", 
         RowBox[{"Abs", "@", "R0"}]}], ",", 
        RowBox[{"N", "@", "vx"}], ",", 
        RowBox[{"N", "@", "vy"}], ",", 
        RowBox[{"N", "@", "vz"}]}], "]"}]}]}], "\n", "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{"F2fFCSGetLinearCoefficients", "[", 
   RowBox[{
    RowBox[{"data", ":", 
     RowBox[{"{", 
      RowBox[{"Repeated", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumberQ"}], ",", 
            RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}], ",", "4"}],
        "]"}], "}"}]}], ",", 
    RowBox[{"diffs", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
    RowBox[{"velocities", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumberQ"}], ",", 
       RowBox[{"_", "?", "NumberQ"}], ",", 
       RowBox[{"_", "?", "NumberQ"}]}], "}"}]}], ",", 
    RowBox[{"kTs", ":", 
     RowBox[{"{", 
      RowBox[{"___", "?", "NumberQ"}], "}"}]}], ",", "w0_", ",", "R0_", ",", 
    RowBox[{"nrefractive_", "?", "NumberQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "dat5", "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"dat5", "=", 
      RowBox[{"Join", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"data", "[", 
          RowBox[{"[", 
           RowBox[{"1", ",", "All", ",", "1"}], "]"}], "]"}], "}"}], ",", 
        RowBox[{"data", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "All", ",", "2"}], "]"}], "]"}]}], "]"}]}], ";",
      "\n", 
     RowBox[{"F2fFCSGetLinearCoefficients", "[", 
      RowBox[{
      "dat5", ",", "diffs", ",", "velocities", ",", "kTs", ",", "w0", ",", 
       "R0", ",", "nrefractive", ",", "opts"}], "]"}]}]}], "\n", 
   "]"}]}]}], "Code",
 CellChangeTimes->{{3.8075076860551157`*^9, 3.807507686060102*^9}, {
  3.807507720099078*^9, 
  3.8075077201030703`*^9}},ExpressionUUID->"ac17c663-b89f-4287-8f1e-\
0d90077dd0f9"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "F2fFCSFit", "]"}], "=", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"FConstraints", "->", "None"}], ",", 
      RowBox[{"PrecisionGoal", "->", "5"}], ",", 
      RowBox[{"AccuracyGoal", "->", "Automatic"}]}], "}"}], "~", "Join", "~", 
    RowBox[{"Options", "[", "F2fFCSGetModel", "]"}], "~", "Join", "~", " ", 
    RowBox[{"Options", "[", "ListPlot", "]"}], "~", "Join", "~", 
    RowBox[{"Options", "[", "FindMinimum", "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"F2fFCSFit", "[", 
    RowBox[{
     RowBox[{"data", ":", 
      RowBox[{"{", 
       RowBox[{"Repeated", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}], ",", "5"}], "]"}], 
       "}"}]}], ",", "diffs_List", ",", 
     RowBox[{"velocities", ":", 
      RowBox[{"{", 
       RowBox[{"_", ",", "_", ",", "_"}], "}"}]}], ",", "kTs_List", ",", 
     "w0_", ",", "R0_", ",", "nrefractive_", ",", 
     RowBox[{"guess", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"_", ",", 
          RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}]}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "gdata", ",", "f", ",", "R", ",", "objectiveFunction", ",", "params", 
       ",", "fitresult", ",", "output"}], "}"}], ",", "\n", 
     RowBox[{
      RowBox[{"F2focusFCSInit", "[", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"OptionValue", "[", "F2fFCSLambdaex", "]"}], "/", 
          "nrefractive"}], ",", 
         RowBox[{
          RowBox[{"OptionValue", "[", "F2fFCSLambdaem", "]"}], "/", 
          "nrefractive"}], ",", 
         RowBox[{"OptionValue", "@", "F2fFCSfocidistance"}], ",", 
         RowBox[{"OptionValue", "@", "F2fFCSpinhole"}], ",", 
         RowBox[{"OptionValue", "@", "F2fFCSmagnification"}]}], "}"}], "]"}], 
      ";", "\n", 
      RowBox[{"F2focusFCSSetData", "[", "data", "]"}], ";", "\n", 
      RowBox[{"gdata", "=", 
       RowBox[{"Flatten", "[", 
        RowBox[{"data", "[", 
         RowBox[{"[", 
          RowBox[{"2", ";;"}], "]"}], "]"}], "]"}]}], ";", "\n", 
      RowBox[{"params", "=", 
       RowBox[{"guess", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ";", "\n", 
      RowBox[{
       RowBox[{"f", "[", 
        RowBox[{"var", ":", 
         RowBox[{"{", 
          RowBox[{"___", "?", "NumberQ"}], "}"}]}], "]"}], ":=", 
       RowBox[{"Flatten", "@", 
        RowBox[{"F2focusFCSModel", "[", 
         RowBox[{"Sequence", "@@", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"Abs", "@", "diffs"}], ",", 
              RowBox[{"Abs", "@", "kTs"}], ",", 
              RowBox[{"Abs", "@", "w0"}], ",", 
              RowBox[{"Abs", "@", "R0"}], ",", "velocities"}], "}"}], "/.", 
            RowBox[{"Map", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Rule", "@@", "#"}], "&"}], ",", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"params", ",", "var"}], "}"}], "\[Transpose]"}]}], 
             "]"}]}], ")"}]}], "]"}]}]}], ";", "\n", 
      RowBox[{
       RowBox[{"R", "[", 
        RowBox[{"{", 
         RowBox[{"vars___", "?", "NumericQ"}], "}"}], "]"}], ":=", 
       RowBox[{
        RowBox[{"f", "[", 
         RowBox[{"{", "vars", "}"}], "]"}], "-", "gdata"}]}], ";", "\n", 
      RowBox[{
       RowBox[{"objectiveFunction", "[", 
        RowBox[{"{", 
         RowBox[{"params___", "?", "NumericQ"}], "}"}], "]"}], ":=", 
       RowBox[{"Norm", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"f", "[", 
           RowBox[{"{", "params", "}"}], "]"}], "-", "gdata"}], ",", "2"}], 
        "]"}]}], ";", "\n", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "FConstraints", "]"}], "=!=", "None"}], 
        ",", 
        RowBox[{"fitresult", "=", 
         RowBox[{"FindMinimum", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"objectiveFunction", "[", "params", "]"}], ",", 
             RowBox[{"OptionValue", "[", "FConstraints", "]"}]}], "}"}], ",", 
           "guess", ",", 
           RowBox[{"Evaluate", "[", 
            RowBox[{"Sequence", "@@", 
             RowBox[{"FilterRules", "[", 
              RowBox[{
               RowBox[{"{", "opts", "}"}], ",", " ", 
               RowBox[{"Options", "[", "FindMinimum", "]"}]}], "]"}]}], "]"}],
            ",", 
           RowBox[{"Evaluate", "[", 
            RowBox[{"Sequence", "@@", 
             RowBox[{"FilterRules", "[", 
              RowBox[{
               RowBox[{"Options", "[", "F2fFCSFit", "]"}], ",", " ", 
               RowBox[{"Options", "[", "FindMinimum", "]"}]}], "]"}]}], 
            "]"}]}], "]"}]}], ",", 
        RowBox[{
         RowBox[{"fitresult", "=", 
          RowBox[{"FindMinimum", "[", 
           RowBox[{
            RowBox[{"objectiveFunction", "[", "params", "]"}], ",", "guess", 
            ",", 
            RowBox[{"Evaluate", "[", 
             RowBox[{"Sequence", "@@", 
              RowBox[{"FilterRules", "[", 
               RowBox[{
                RowBox[{"{", "opts", "}"}], ",", " ", 
                RowBox[{"Options", "[", "FindMinimum", "]"}]}], "]"}]}], 
             "]"}], ",", 
            RowBox[{"Method", "->", 
             RowBox[{"{", 
              RowBox[{"\"\<LevenbergMarquardt\>\"", ",", 
               RowBox[{"\"\<Residual\>\"", "->", 
                RowBox[{"R", "[", "params", "]"}]}]}], "}"}]}], ",", 
            RowBox[{"Evaluate", "[", 
             RowBox[{"Sequence", "@@", 
              RowBox[{"FilterRules", "[", 
               RowBox[{
                RowBox[{"Options", "[", "F2fFCSFit", "]"}], ",", " ", 
                RowBox[{"Options", "[", "FindMinimum", "]"}]}], "]"}]}], 
             "]"}]}], "]"}]}], ";", 
         RowBox[{
          RowBox[{"fitresult", "[", 
           RowBox[{"[", "1", "]"}], "]"}], "*=", "2."}], ";"}]}], "\n", "]"}],
       ";", "\n", 
      RowBox[{"output", "=", 
       RowBox[{
        RowBox[{"F2fFCSGetModel", "[", 
         RowBox[{"data", ",", 
          RowBox[{"Abs", "@", "diffs"}], ",", "velocities", ",", 
          RowBox[{"Abs", "@", "kTs"}], ",", 
          RowBox[{"Abs", "@", "w0"}], ",", 
          RowBox[{"Abs", "@", "R0"}], ",", "nrefractive", ",", 
          RowBox[{"FilterRules", "[", 
           RowBox[{
            RowBox[{"{", "opts", "}"}], ",", " ", 
            RowBox[{"Options", "[", "F2fFCSGetModel", "]"}]}], "]"}]}], "]"}],
         "/.", 
        RowBox[{"fitresult", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}]}], ";", "\n", 
      RowBox[{"{", " ", 
       RowBox[{
        RowBox[{"fitresult", "[", 
         RowBox[{"[", "1", "]"}], "]"}], ",", 
        RowBox[{"fitresult", "[", 
         RowBox[{"[", "2", "]"}], "]"}], ",", "output"}], "}"}]}]}], "\n", 
    "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{"F2fFCSFit", "[", 
   RowBox[{
    RowBox[{"data", ":", 
     RowBox[{"{", 
      RowBox[{"Repeated", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumberQ"}], ",", 
            RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}], ",", "4"}],
        "]"}], "}"}]}], ",", "diffs_List", ",", 
    RowBox[{"velocities", ":", 
     RowBox[{"{", 
      RowBox[{"_", ",", "_", ",", "_"}], "}"}]}], ",", "kTs_List", ",", "w0_",
     ",", "R0_", ",", "nrefractive_", ",", 
    RowBox[{"guess", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"_", ",", 
         RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}]}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "dat5", "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"dat5", "=", 
      RowBox[{"Join", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"data", "[", 
          RowBox[{"[", 
           RowBox[{"1", ",", "All", ",", "1"}], "]"}], "]"}], "}"}], ",", 
        RowBox[{"data", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "All", ",", "2"}], "]"}], "]"}]}], "]"}]}], ";",
      "\n", 
     RowBox[{"F2fFCSFit", "[", 
      RowBox[{
      "dat5", ",", "diffs", ",", "velocities", ",", "kTs", ",", "w0", ",", 
       "R0", ",", "nrefractive", ",", "guess", ",", "opts"}], "]"}]}]}], "\n",
    "]"}]}], "\n"}], "Code",
 CellChangeTimes->{3.8075076860780506`*^9, 
  3.8075077201120424`*^9},ExpressionUUID->"82126477-b200-4ef1-a926-\
6f1cd061edd8"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "F2fFCSGlobalFit", "]"}], "=", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"FConstraints", "->", "None"}], ",", 
       RowBox[{"PrecisionGoal", "->", "5"}], ",", 
       RowBox[{"AccuracyGoal", "->", "Automatic"}]}], "}"}], "~", "Join", "~", 
     RowBox[{"Options", "[", "F2fFCSGetModel", "]"}], "~", "Join", "~", 
     RowBox[{"Options", "[", "FindMinimum", "]"}], "~", "Join", "~", " ", 
     RowBox[{"Options", "[", "ListPlot", "]"}]}]}], ";"}], "\n"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"F2fFCSGlobalFit", "[", 
    RowBox[{
     RowBox[{"dataset", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"Repeated", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{
               RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}], ",", "5"}], 
            "]"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"_List", ",", 
            RowBox[{"{", 
             RowBox[{"_", ",", "_", ",", "_"}], "}"}], ",", "_List", ",", "_",
             ",", "_", ",", "_"}], "}"}]}], "}"}], ".."}], "}"}]}], ",", 
     RowBox[{"guess", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"_", ",", 
          RowBox[{"_", "?", "NumericQ"}]}], "}"}], ".."}], "}"}]}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", "\n", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "gdata", ",", "f", ",", "R", ",", "objectiveFunction", ",", "params", 
       ",", "fitresult", ",", "output"}], "}"}], ",", "\n", 
     RowBox[{
      RowBox[{"gdata", "=", 
       RowBox[{"Flatten", "[", 
        RowBox[{"dataset", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "1", ",", 
           RowBox[{"2", ";;"}]}], "]"}], "]"}], "]"}]}], ";", "\n", 
      RowBox[{"params", "=", 
       RowBox[{"guess", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ";", "\n", 
      RowBox[{
       RowBox[{"f", "[", 
        RowBox[{"var", ":", 
         RowBox[{"{", 
          RowBox[{"___", "?", "NumericQ"}], "}"}]}], "]"}], ":=", "\n", 
       RowBox[{"Module", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"rules", "=", 
           RowBox[{"Map", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Rule", "@@", "#"}], "&"}], ",", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"params", ",", "var"}], "}"}], "\[Transpose]"}]}], 
            "]"}]}], "}"}], ",", "\n", 
         RowBox[{"Flatten", "@", 
          RowBox[{"Map", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"(", "\n", 
              RowBox[{
               RowBox[{"F2focusFCSInit", "[", 
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"OptionValue", "[", "F2fFCSLambdaex", "]"}], "/", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", 
                    RowBox[{"2", ",", 
                    RowBox[{"-", "1"}]}], "]"}], "]"}]}], ",", 
                   RowBox[{
                    RowBox[{"OptionValue", "[", "F2fFCSLambdaem", "]"}], "/", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", 
                    RowBox[{"2", ",", 
                    RowBox[{"-", "1"}]}], "]"}], "]"}]}], ",", 
                   RowBox[{"OptionValue", "@", "F2fFCSfocidistance"}], ",", 
                   RowBox[{"OptionValue", "@", "F2fFCSpinhole"}], ",", 
                   RowBox[{"OptionValue", "@", "F2fFCSmagnification"}]}], 
                  "}"}], "/.", "rules"}], "]"}], ";", "\n", 
               RowBox[{"F2focusFCSSetData", "[", 
                RowBox[{"#", "[", 
                 RowBox[{"[", "1", "]"}], "]"}], "]"}], ";", "\n", 
               RowBox[{"Flatten", "@", 
                RowBox[{"F2focusFCSModel", "[", 
                 RowBox[{"Sequence", "@@", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"Abs", "@", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", 
                    RowBox[{"2", ",", "1"}], "]"}], "]"}]}], ",", 
                    RowBox[{"Abs", "@", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", 
                    RowBox[{"2", ",", "3"}], "]"}], "]"}]}], ",", 
                    RowBox[{"Abs", "@", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", 
                    RowBox[{"2", ",", "4"}], "]"}], "]"}]}], ",", 
                    RowBox[{"Abs", "@", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", 
                    RowBox[{"2", ",", "5"}], "]"}], "]"}]}], ",", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", 
                    RowBox[{"2", ",", "2"}], "]"}], "]"}]}], "}"}], "/.", 
                    "rules"}], ")"}]}], "]"}]}]}], ")"}], "&"}], ",", "\n", 
            "dataset"}], "]"}]}]}], "\n", "]"}]}], ";", "\n", 
      RowBox[{
       RowBox[{"R", "[", 
        RowBox[{"{", 
         RowBox[{"vars___", "?", "NumericQ"}], "}"}], "]"}], ":=", 
       RowBox[{
        RowBox[{"f", "[", 
         RowBox[{"{", "vars", "}"}], "]"}], "-", "gdata"}]}], ";", "\n", 
      RowBox[{
       RowBox[{"objectiveFunction", "[", 
        RowBox[{"{", 
         RowBox[{"params___", "?", "NumericQ"}], "}"}], "]"}], ":=", 
       RowBox[{"Norm", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"f", "[", 
           RowBox[{"{", "params", "}"}], "]"}], "-", "gdata"}], ",", "2"}], 
        "]"}]}], ";", "\n", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "FConstraints", "]"}], "=!=", "None"}], 
        ",", 
        RowBox[{"fitresult", "=", 
         RowBox[{"FindMinimum", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"objectiveFunction", "[", "params", "]"}], ",", 
             RowBox[{"OptionValue", "[", "FConstraints", "]"}]}], "}"}], ",", 
           "guess", ",", 
           RowBox[{"Evaluate", "[", 
            RowBox[{"Sequence", "@@", 
             RowBox[{"FilterRules", "[", 
              RowBox[{
               RowBox[{"{", "opts", "}"}], ",", " ", 
               RowBox[{"Options", "[", "FindMinimum", "]"}]}], "]"}]}], "]"}],
            ",", 
           RowBox[{"Evaluate", "[", 
            RowBox[{"Sequence", "@@", 
             RowBox[{"FilterRules", "[", 
              RowBox[{
               RowBox[{"Options", "[", "F2fFCSGlobalFit", "]"}], ",", " ", 
               RowBox[{"Options", "[", "FindMinimum", "]"}]}], "]"}]}], 
            "]"}]}], "]"}]}], ",", 
        RowBox[{
         RowBox[{"fitresult", "=", 
          RowBox[{"FindMinimum", "[", 
           RowBox[{
            RowBox[{"objectiveFunction", "[", "params", "]"}], ",", "guess", 
            ",", 
            RowBox[{"Evaluate", "[", 
             RowBox[{"Sequence", "@@", 
              RowBox[{"FilterRules", "[", 
               RowBox[{
                RowBox[{"{", "opts", "}"}], ",", " ", 
                RowBox[{"Options", "[", "FindMinimum", "]"}]}], "]"}]}], 
             "]"}], ",", 
            RowBox[{"Method", "->", 
             RowBox[{"{", 
              RowBox[{"\"\<LevenbergMarquardt\>\"", ",", 
               RowBox[{"\"\<Residual\>\"", "->", 
                RowBox[{"R", "[", "params", "]"}]}]}], "}"}]}], ",", 
            RowBox[{"Evaluate", "[", 
             RowBox[{"Sequence", "@@", 
              RowBox[{"FilterRules", "[", 
               RowBox[{
                RowBox[{"Options", "[", "F2fFCSGlobalFit", "]"}], ",", " ", 
                RowBox[{"Options", "[", "FindMinimum", "]"}]}], "]"}]}], 
             "]"}]}], "]"}]}], ";", 
         RowBox[{
          RowBox[{"fitresult", "[", 
           RowBox[{"[", "1", "]"}], "]"}], "*=", "2."}], ";"}]}], "]"}], ";", 
      "\n", 
      RowBox[{"output", "=", 
       RowBox[{
        RowBox[{"Map", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"F2fFCSGetModel", "[", 
            RowBox[{
             RowBox[{"#", "[", 
              RowBox[{"[", "1", "]"}], "]"}], ",", 
             RowBox[{"Abs", "@", 
              RowBox[{"#", "[", 
               RowBox[{"[", 
                RowBox[{"2", ",", "1"}], "]"}], "]"}]}], ",", 
             RowBox[{"#", "[", 
              RowBox[{"[", 
               RowBox[{"2", ",", "2"}], "]"}], "]"}], ",", 
             RowBox[{"Abs", "@", 
              RowBox[{"#", "[", 
               RowBox[{"[", 
                RowBox[{"2", ",", "3"}], "]"}], "]"}]}], ",", 
             RowBox[{"Abs", "@", 
              RowBox[{"#", "[", 
               RowBox[{"[", 
                RowBox[{"2", ",", "4"}], "]"}], "]"}]}], ",", 
             RowBox[{"Abs", "@", 
              RowBox[{"#", "[", 
               RowBox[{"[", 
                RowBox[{"2", ",", "5"}], "]"}], "]"}]}], ",", 
             RowBox[{"#", "[", 
              RowBox[{"[", 
               RowBox[{"2", ",", "6"}], "]"}], "]"}], ",", 
             RowBox[{"FilterRules", "[", 
              RowBox[{
               RowBox[{"{", "opts", "}"}], ",", " ", 
               RowBox[{"Options", "[", "F2fFCSGetModel", "]"}]}], "]"}]}], 
            "]"}], "&"}], ",", "dataset"}], "]"}], "/.", 
        RowBox[{"fitresult", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}]}], ";", "\n", 
      RowBox[{"{", " ", 
       RowBox[{
        RowBox[{"fitresult", "[", 
         RowBox[{"[", "1", "]"}], "]"}], ",", 
        RowBox[{"fitresult", "[", 
         RowBox[{"[", "2", "]"}], "]"}], ",", "output"}], "}"}]}]}], "\n", 
    "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{"F2fFCSGlobalFit", "[", 
   RowBox[{
    RowBox[{"dataset", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"Repeated", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{
                RowBox[{"_", "?", "NumericQ"}], ",", 
                RowBox[{"_", "?", "NumericQ"}]}], "}"}], ".."}], "}"}], ",", 
            "4"}], "]"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"_List", ",", 
           RowBox[{"{", 
            RowBox[{"_", ",", "_", ",", "_"}], "}"}], ",", "_List", ",", "_", 
           ",", "_", ",", "_"}], "}"}]}], "}"}], ".."}], "}"}]}], ",", 
    RowBox[{"guess", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"_", ",", 
         RowBox[{"_", "?", "NumericQ"}]}], "}"}], ".."}], "}"}]}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "dat5", "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"dat5", "=", 
      RowBox[{"Map", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Join", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"#", "[", 
               RowBox[{"[", 
                RowBox[{"1", ",", "1", ",", "All", ",", "1"}], "]"}], "]"}], 
              "}"}], ",", 
             RowBox[{"#", "[", 
              RowBox[{"[", 
               RowBox[{"1", ",", "All", ",", "All", ",", "2"}], "]"}], 
              "]"}]}], "]"}], ",", 
           RowBox[{"#", "[", 
            RowBox[{"[", "2", "]"}], "]"}]}], "}"}], "&"}], ",", "dataset"}], 
       "]"}]}], ";", "\n", 
     RowBox[{"F2fFCSGlobalFit", "[", 
      RowBox[{"dat5", ",", "guess", ",", "opts"}], "]"}]}]}], "\n", 
   "]"}]}]}], "Code",
 CellChangeTimes->{3.8075076860940084`*^9, 
  3.807507720122016*^9},ExpressionUUID->"e8f62cdf-a044-47f8-b640-\
10873a059eb4"]
}, Closed]],

Cell[CellGroupData[{

Cell["scan images", "Subsubsection",
 CellChangeTimes->{
  3.7927526214627714`*^9, {3.8142658654429464`*^9, 3.8142658654549046`*^9}, 
   3.82757683210215*^9},ExpressionUUID->"f2897549-3e12-424e-86fd-\
2e0dd6818d40"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
   "FCalculateBurstListFromScanImagePixels", "[", "frame_Integer", "]"}], ":=", 
   RowBox[{"FPCalculateBurstListFromScanImagePixels", "[", 
    RowBox[{"frame", "-", "1"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"FCalculateBurstListFromScanImagePixels", "[", "]"}], ":=", 
  RowBox[{
  "FCalculateBurstListFromScanImagePixels", "[", "1", "]"}]}]}], "Input",
 CellChangeTimes->{{3.76864952595117*^9, 3.768649547946286*^9}, {
   3.76864964976394*^9, 3.768649664523962*^9}, {3.7686504833104553`*^9, 
   3.7686504840135098`*^9}, 
   3.7743456541570473`*^9},ExpressionUUID->"f0dab527-3c4d-4d1c-81ed-\
444a60e1ff9e"],

Cell[BoxData[
 RowBox[{"\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"FGetFromPiezoScan", "::", "noscan"}], "=", 
     "\"\<No image scan is loaded\>\""}], ";"}], " ", "\n", 
   RowBox[{
    RowBox[{"FGetFromPiezoScan", "[", 
     RowBox[{"expr_", ",", "frame_Integer"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "dat", "}"}], ",", "\n", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Length", "[", 
          RowBox[{"StringCases", "[", 
           RowBox[{
            RowBox[{"FShowHeader", "[", "]"}], ",", 
            "\"\<ImgHdr_Dimensions\>\""}], "]"}], "]"}], "==", "1"}], ",", 
        "\n", 
        RowBox[{
         RowBox[{
         "FCalculateBurstListFromScanImagePixels", "[", "frame", "]"}], ";", 
         "\n", 
         RowBox[{"dat", "=", 
          RowBox[{"Partition", "[", 
           RowBox[{
            RowBox[{"FGetFromBurstList", "[", "expr", "]"}], ",", 
            RowBox[{"FGetFromHeader", "[", "\"\<ImgHdr_PixX\>\"", "]"}]}], 
           "]"}]}], ";", "\n", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"FGetFromHeader", "[", "\"\<ImgHdr_BiDirect\>\"", "]"}], "!=",
             "0"}], ",", "\n", 
           RowBox[{"Do", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"dat", "[", 
               RowBox[{"[", "i", "]"}], "]"}], "=", 
              RowBox[{"Reverse", "[", 
               RowBox[{"dat", "[", 
                RowBox[{"[", "i", "]"}], "]"}], "]"}]}], ",", 
             RowBox[{"{", 
              RowBox[{"i", ",", "2", ",", 
               RowBox[{"Length", "[", "dat", "]"}], ",", "2"}], "}"}]}], 
            "]"}]}], "]"}], ";", "\n", "dat"}], ",", 
        RowBox[{"Message", "[", 
         RowBox[{"FGetFromPiezoScan", "::", "noscan"}], "]"}]}], "\n", 
       "]"}]}], "\n", "]"}]}], "\n", 
   RowBox[{
    RowBox[{"FGetFromPiezoScan", "[", "expr_", "]"}], ":=", 
    RowBox[{"FGetFromPiezoScan", "[", 
     RowBox[{"expr", ",", "1"}], "]"}]}]}]}]], "Input",
 CellChangeTimes->{{3.7686496947350206`*^9, 3.768649765734391*^9}, {
   3.7741787839364223`*^9, 3.7741787845298357`*^9}, {3.774345613154591*^9, 
   3.7743456145987425`*^9}, {3.827554981736185*^9, 3.8275550107184324`*^9}, 
   3.827576857241988*^9},ExpressionUUID->"d80f79f0-7400-4fa2-ae38-\
40195ce3ae78"],

Cell[BoxData[
 RowBox[{
  RowBox[{"ReleaseHoldAt", "[", 
   RowBox[{"expr_", ",", "partspec_"}], "]"}], ":=", 
  RowBox[{"ReplacePart", "[", 
   RowBox[{"expr", ",", 
    RowBox[{"partspec", "\[Rule]", 
     RowBox[{"Extract", "[", 
      RowBox[{"expr", ",", "partspec"}], "]"}]}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.827574526543292*^9, 
  3.827574526545288*^9}},ExpressionUUID->"9c8bacef-3459-414c-b494-\
391d3ceaf448"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"lifetimecolor", "[", 
    RowBox[{"{", 
     RowBox[{"intensity_", ",", "tau_"}], "}"}], "]"}], ":=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{
      RowBox[{"(", 
       RowBox[{"1", "-", "tau"}], ")"}], " ", "0.7"}], ",", "1", ",", 
     "intensity"}], " ", "}"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ScaleTo", "[", 
     RowBox[{"datas_", ",", 
      RowBox[{"{", 
       RowBox[{"i1_", ",", "i2_"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"tau1_", ",", "tau2_"}], "}"}]}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"dat", "=", "datas"}], "}"}], ",", "\n", 
      RowBox[{
       RowBox[{
        RowBox[{"dat", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "All", ",", "1"}], "]"}], "]"}], "=", 
        RowBox[{"Rescale", "[", 
         RowBox[{
          RowBox[{"dat", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "All", ",", "1"}], "]"}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"i1", ",", "i2"}], "}"}]}], "]"}]}], ";", "\n", 
       RowBox[{
        RowBox[{"dat", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "All", ",", "2"}], "]"}], "]"}], "=", 
        RowBox[{"Rescale", "[", 
         RowBox[{
          RowBox[{"dat", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "All", ",", "2"}], "]"}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"tau1", ",", "tau2"}], "}"}]}], "]"}]}], ";", "\n", 
       RowBox[{"Clip", "[", 
        RowBox[{"dat", ",", 
         RowBox[{"{", 
          RowBox[{"0", ",", "1"}], "}"}]}], "]"}]}]}], "\n", "]"}]}], ";"}], 
  "\n"}], "\n", 
 RowBox[{
  RowBox[{"Clear", "[", "FScanImage", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FScanImage", "]"}], "=", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"FScanImageParamName", "->", "\"\<param\>\""}], "}"}], "~", 
    "Join", "~", 
    RowBox[{"Options", "[", "Graphics", "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FScanImage", "[", 
    RowBox[{
     RowBox[{"data_", "?", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"ArrayQ", "[", 
         RowBox[{"#", ",", "2"}], "]"}], "&"}], ")"}]}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"intensity1_", "?", "NumberQ"}], ",", 
       RowBox[{"intensity2_", "?", "NumberQ"}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"x0_", "?", "NumberQ"}], ",", 
       RowBox[{"y0_", "?", "NumberQ"}], ",", 
       RowBox[{"resolx_", "?", "NumberQ"}], ",", 
       RowBox[{"resoly_", "?", "NumberQ"}]}], "}"}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "ndat", ",", "img", ",", "nx", ",", "ny", ",", "xmax", ",", "ymax", ",",
        "GetPixel", ",", "dfunc", ",", "flim"}], "}"}], ",", "\n", 
     RowBox[{
      RowBox[{"ndat", "=", 
       RowBox[{"Clip", "[", 
        RowBox[{
         RowBox[{"Rescale", "[", 
          RowBox[{"data", ",", 
           RowBox[{"{", 
            RowBox[{"intensity1", ",", "intensity2"}], "}"}]}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"0", ",", "1"}], "}"}]}], "]"}]}], ";", "\n", 
      RowBox[{"img", "=", 
       RowBox[{"Image", "[", "ndat", "]"}]}], ";", "\n", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"ny", ",", "nx"}], "}"}], "=", 
       RowBox[{
        RowBox[{"Dimensions", "[", "data", "]"}], "[", 
        RowBox[{"[", 
         RowBox[{"1", ";;", "2"}], "]"}], "]"}]}], ";", "\n", 
      RowBox[{"xmax", "=", 
       RowBox[{"x0", "+", 
        RowBox[{"nx", " ", "resolx"}]}]}], " ", ";", "\n", 
      RowBox[{"ymax", "=", 
       RowBox[{"y0", "+", 
        RowBox[{"ny", " ", "resoly"}]}]}], " ", ";", "\n", 
      RowBox[{
       RowBox[{"GetPixel", "[", 
        RowBox[{"{", 
         RowBox[{"x_", ",", "y_"}], "}"}], "]"}], ":=", 
       RowBox[{"Ceiling", "[", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"x", "-", "x0"}], ")"}], "/", "resolx"}], ",", 
          RowBox[{"ny", "-", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"y", "-", "y0"}], ")"}], "/", "resoly"}]}]}], "}"}], 
        "]"}]}], ";", "\n", 
      RowBox[{
       RowBox[{"dfunc", "[", "pt_", "]"}], ":=", 
       RowBox[{"Module", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"pix", "=", 
            RowBox[{"GetPixel", "[", "pt", "]"}]}], ",", "int"}], "}"}], ",", 
         RowBox[{
          RowBox[{"int", "=", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"0", "<", 
               RowBox[{"pix", "[", 
                RowBox[{"[", "1", "]"}], "]"}], "<=", "nx"}], " ", "&&", " ", 
              RowBox[{"0", "<", 
               RowBox[{"pix", "[", 
                RowBox[{"[", "2", "]"}], "]"}], "<=", "ny"}]}], " ", ",", 
             RowBox[{"data", "[", 
              RowBox[{"[", 
               RowBox[{"Sequence", "@@", 
                RowBox[{"Reverse", "@", 
                 RowBox[{"GetPixel", "[", "pt", "]"}]}]}], "]"}], "]"}], ",", 
             "0"}], "]"}]}], ";", 
          RowBox[{"Column", "[", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"\"\<{x,y}=\>\"", "<>", 
              RowBox[{"ToString", "[", 
               RowBox[{
                RowBox[{"Round", "[", 
                 RowBox[{"100.", "pt"}], "]"}], "/", "100."}], "]"}]}], ",", 
             RowBox[{"\"\<intensity=\>\"", "<>", 
              RowBox[{"ToString", "[", "int", "]"}]}]}], "}"}], "]"}]}]}], 
        "\n", "]"}]}], ";", "\n", 
      RowBox[{"flim", "=", 
       RowBox[{"Graphics", "[", 
        RowBox[{
         RowBox[{"Inset", "[", 
          RowBox[{
           RowBox[{"Show", "[", 
            RowBox[{"img", ",", 
             RowBox[{"AspectRatio", "->", "Full"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"x0", ",", "y0"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"0", ",", "0"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"xmax", "-", "x0"}], ",", 
             RowBox[{"ymax", "-", "y0"}]}], "}"}]}], "]"}], ",", 
         RowBox[{"FilterRules", "[", 
          RowBox[{
           RowBox[{"{", "opts", "}"}], ",", " ", 
           RowBox[{"Options", "[", "Graphics", "]"}]}], "]"}], ",", 
         RowBox[{"PlotRange", "->", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"x0", ",", "xmax"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"y0", ",", "ymax"}], "}"}]}], "}"}]}], ",", 
         RowBox[{"Frame", "->", "True"}], ",", 
         RowBox[{"FrameLabel", "->", 
          RowBox[{"{", 
           RowBox[{"\"\<\[Mu]m\>\"", ",", "\"\<\[Mu]m\>\""}], "}"}]}], ",", 
         RowBox[{"CoordinatesToolOptions", "->", 
          RowBox[{"{", 
           RowBox[{"\"\<DisplayFunction\>\"", "->", "dfunc"}], "}"}]}], ",", 
         RowBox[{"ImageSize", "->", "300"}], ",", 
         RowBox[{"LabelStyle", "->", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"FontFamily", "->", " ", "\"\<Helvetica\>\""}], ",", 
            RowBox[{"FontSize", "->", " ", "12"}], ",", 
            RowBox[{"FontWeight", "->", " ", "Bold"}]}], "}"}]}]}], "]"}]}], 
      ";", "\n", "flim"}]}], "\n", "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FScanImage", "[", 
    RowBox[{
     RowBox[{"dat_", "?", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"ArrayQ", "[", 
         RowBox[{"#", ",", "2"}], "]"}], "&"}], ")"}]}], ",", 
     RowBox[{"{", 
      RowBox[{"intensity1_", ",", "intensity2_"}], "}"}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"ScanDirection", ",", "origin"}], "}"}], ",", "\n", 
     RowBox[{
      RowBox[{"ScanDirection", "=", 
       RowBox[{"FGetFromHeader", "[", "\"\<ImgHdr_ScanDirection\>\"", "]"}]}],
       ";", "\n", 
      RowBox[{"origin", "=", 
       RowBox[{"Which", "[", "\n", 
        RowBox[{
         RowBox[{"ScanDirection", "==", "0"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"FGetFromHeader", "[", "\"\<ImgHdr_X0\>\"", "]"}], ",", 
           RowBox[{"FGetFromHeader", "[", "\"\<ImgHdr_Y0\>\"", "]"}]}], "}"}],
          ",", "\n", 
         RowBox[{"ScanDirection", "==", "1"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"FGetFromHeader", "[", "\"\<ImgHdr_X0\>\"", "]"}], ",", 
           RowBox[{"FGetFromHeader", "[", "\"\<ImgHdr_Z0\>\"", "]"}]}], "}"}],
          ",", "\n", 
         RowBox[{"ScanDirection", "==", "2"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"FGetFromHeader", "[", "\"\<ImgHdr_Y0\>\"", "]"}], ",", 
           RowBox[{"FGetFromHeader", "[", "\"\<ImgHdr_Z0\>\"", "]"}]}], "}"}],
          ",", "\n", "True", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"FGetFromHeader", "[", "\"\<ImgHdr_X0\>\"", "]"}], ",", 
           RowBox[{"FGetFromHeader", "[", "\"\<ImgHdr_Y0\>\"", "]"}]}], 
          "}"}]}], "\n", "]"}]}], ";", "\n", 
      RowBox[{"FScanImage", "[", 
       RowBox[{"dat", ",", 
        RowBox[{"{", 
         RowBox[{"intensity1", ",", "intensity2"}], "}"}], ",", 
        RowBox[{"origin", "~", "Join", "~", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"FGetFromHeader", "[", "\"\<ImgHdr_PixResol\>\"", "]"}], 
           ",", 
           RowBox[{"FGetFromHeader", "[", "\"\<ImgHdr_PixResol\>\"", "]"}]}], 
          "}"}]}], ",", "opts"}], "]"}]}]}], "\n", "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FScanImage", "[", 
    RowBox[{
     RowBox[{"data_", "?", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"ArrayQ", "[", 
         RowBox[{"#", ",", "3"}], "]"}], "&"}], ")"}]}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"intensity1_", "?", "NumberQ"}], ",", 
       RowBox[{"intensity2_", "?", "NumberQ"}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"param1_", "?", "NumberQ"}], ",", 
       RowBox[{"param2_", "?", "NumberQ"}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"x0_", "?", "NumberQ"}], ",", 
       RowBox[{"y0_", "?", "NumberQ"}], ",", 
       RowBox[{"resolx_", "?", "NumberQ"}], ",", 
       RowBox[{"resoly_", "?", "NumberQ"}]}], "}"}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "ndat", ",", "img", ",", "nx", ",", "ny", ",", "xmax", ",", "ymax", ",",
        "GetPixel", ",", "dfunc", ",", "flim"}], "}"}], ",", "\n", 
     RowBox[{
      RowBox[{"ndat", "=", 
       RowBox[{"ScaleTo", "[", 
        RowBox[{"data", ",", 
         RowBox[{"{", 
          RowBox[{"intensity1", ",", "intensity2"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"param1", ",", "param2"}], "}"}]}], "]"}]}], ";", "\n", 
      RowBox[{"img", "=", 
       RowBox[{"Image", "[", 
        RowBox[{
         RowBox[{"Map", "[", 
          RowBox[{"lifetimecolor", ",", "ndat", ",", 
           RowBox[{"{", "2", "}"}]}], "]"}], ",", 
         RowBox[{"ColorSpace", "->", "\"\<HSB\>\""}]}], "]"}]}], ";", "\n", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"ny", ",", "nx"}], "}"}], "=", 
       RowBox[{
        RowBox[{"Dimensions", "[", "data", "]"}], "[", 
        RowBox[{"[", 
         RowBox[{"1", ";;", "2"}], "]"}], "]"}]}], ";", "\n", 
      RowBox[{"xmax", "=", 
       RowBox[{"x0", "+", 
        RowBox[{"nx", " ", "resolx"}]}]}], " ", ";", "\n", 
      RowBox[{"ymax", "=", 
       RowBox[{"y0", "+", 
        RowBox[{"ny", " ", "resoly"}]}]}], " ", ";", "\n", 
      RowBox[{
       RowBox[{"GetPixel", "[", 
        RowBox[{"{", 
         RowBox[{"x_", ",", "y_"}], "}"}], "]"}], ":=", 
       RowBox[{"Ceiling", "[", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"x", "-", "x0"}], ")"}], "/", "resolx"}], ",", 
          RowBox[{"ny", "-", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"y", "-", "y0"}], ")"}], "/", "resoly"}]}]}], "}"}], 
        "]"}]}], ";", 
      RowBox[{
       RowBox[{"dfunc", "[", "pt_", "]"}], ":=", 
       RowBox[{"Module", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"pix", "=", 
            RowBox[{"GetPixel", "[", "pt", "]"}]}], ",", "itau"}], "}"}], ",", 
         RowBox[{
          RowBox[{"itau", "=", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"0", "<", 
               RowBox[{"pix", "[", 
                RowBox[{"[", "1", "]"}], "]"}], "<=", "nx"}], " ", "&&", " ", 
              RowBox[{"0", "<", 
               RowBox[{"pix", "[", 
                RowBox[{"[", "2", "]"}], "]"}], "<=", "ny"}]}], " ", ",", 
             RowBox[{"data", "[", 
              RowBox[{"[", 
               RowBox[{"Sequence", "@@", 
                RowBox[{"Reverse", "@", 
                 RowBox[{"GetPixel", "[", "pt", "]"}]}]}], "]"}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"0", ",", "0"}], "}"}]}], "]"}]}], ";", 
          RowBox[{"Column", "[", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"\"\<{x,y}=\>\"", "<>", 
              RowBox[{"ToString", "[", 
               RowBox[{
                RowBox[{"Round", "[", 
                 RowBox[{"100.", "pt"}], "]"}], "/", "100."}], "]"}]}], ",", 
             RowBox[{"\"\<intensity=\>\"", "<>", 
              RowBox[{"ToString", "[", 
               RowBox[{"itau", "[", 
                RowBox[{"[", "1", "]"}], "]"}], "]"}]}], ",", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"OptionValue", "[", "FScanImageParamName", "]"}], 
               ")"}], "<>", 
              RowBox[{"ToString", "[", 
               RowBox[{"itau", "[", 
                RowBox[{"[", "2", "]"}], "]"}], "]"}]}]}], "}"}], "]"}]}]}], 
        "\n", "]"}]}], ";", "\n", 
      RowBox[{"flim", "=", 
       RowBox[{"Graphics", "[", 
        RowBox[{
         RowBox[{"Inset", "[", 
          RowBox[{
           RowBox[{"Show", "[", 
            RowBox[{"img", ",", 
             RowBox[{"AspectRatio", "->", "Full"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"x0", ",", "y0"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"0", ",", "0"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"xmax", "-", "x0"}], ",", 
             RowBox[{"ymax", "-", "y0"}]}], "}"}]}], "]"}], ",", 
         RowBox[{"FilterRules", "[", 
          RowBox[{
           RowBox[{"{", "opts", "}"}], ",", " ", 
           RowBox[{"Options", "[", "Graphics", "]"}]}], "]"}], ",", 
         RowBox[{"PlotRange", "->", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"x0", ",", "xmax"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"y0", ",", "ymax"}], "}"}]}], "}"}]}], ",", 
         RowBox[{"Frame", "->", "True"}], ",", 
         RowBox[{"FrameLabel", "->", 
          RowBox[{"{", 
           RowBox[{"\"\<\[Mu]m\>\"", ",", "\"\<\[Mu]m\>\""}], "}"}]}], ",", 
         RowBox[{"CoordinatesToolOptions", "->", 
          RowBox[{"{", 
           RowBox[{"\"\<DisplayFunction\>\"", "->", "dfunc"}], "}"}]}], ",", 
         RowBox[{"ImageSize", "->", "300"}], ",", 
         RowBox[{"LabelStyle", "->", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"FontFamily", "->", " ", "\"\<Helvetica\>\""}], ",", 
            RowBox[{"FontSize", "->", " ", "12"}], ",", 
            RowBox[{"FontWeight", "->", " ", "Bold"}]}], "}"}]}]}], "]"}]}], 
      ";", "\n", "flim"}]}], "\n", "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FScanImage", "[", 
    RowBox[{
     RowBox[{"dat_", "?", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"ArrayQ", "[", 
         RowBox[{"#", ",", "3"}], "]"}], "&"}], ")"}]}], ",", 
     RowBox[{"{", 
      RowBox[{"intensity1_", ",", "intensity2_"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"param1_", ",", "param2_"}], "}"}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"ScanDirection", ",", "origin"}], "}"}], ",", "\n", 
     RowBox[{
      RowBox[{"ScanDirection", "=", 
       RowBox[{"FGetFromHeader", "[", "\"\<ImgHdr_ScanDirection\>\"", "]"}]}],
       ";", "\n", 
      RowBox[{"origin", "=", 
       RowBox[{"Which", "[", "\n", 
        RowBox[{
         RowBox[{"ScanDirection", "==", "0"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"FGetFromHeader", "[", "\"\<ImgHdr_X0\>\"", "]"}], ",", 
           RowBox[{"FGetFromHeader", "[", "\"\<ImgHdr_Y0\>\"", "]"}]}], "}"}],
          ",", "\n", 
         RowBox[{"ScanDirection", "==", "1"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"FGetFromHeader", "[", "\"\<ImgHdr_X0\>\"", "]"}], ",", 
           RowBox[{"FGetFromHeader", "[", "\"\<ImgHdr_Z0\>\"", "]"}]}], "}"}],
          ",", "\n", 
         RowBox[{"ScanDirection", "==", "2"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"FGetFromHeader", "[", "\"\<ImgHdr_Y0\>\"", "]"}], ",", 
           RowBox[{"FGetFromHeader", "[", "\"\<ImgHdr_Z0\>\"", "]"}]}], "}"}],
          ",", "\n", "True", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"FGetFromHeader", "[", "\"\<ImgHdr_X0\>\"", "]"}], ",", 
           RowBox[{"FGetFromHeader", "[", "\"\<ImgHdr_Y0\>\"", "]"}]}], 
          "}"}]}], "\n", "]"}]}], ";", "\n", 
      RowBox[{"FScanImage", "[", 
       RowBox[{"dat", ",", 
        RowBox[{"{", 
         RowBox[{"intensity1", ",", "intensity2"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"param1", ",", "param2"}], "}"}], ",", 
        RowBox[{"origin", "~", "Join", "~", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"FGetFromHeader", "[", "\"\<ImgHdr_PixResol\>\"", "]"}], 
           ",", 
           RowBox[{"FGetFromHeader", "[", "\"\<ImgHdr_PixResol\>\"", "]"}]}], 
          "}"}]}], ",", "opts"}], "]"}]}]}], "\n", "]"}]}], "\n"}], "\n", 
 RowBox[{"Clear", "[", "FFastFLIM", "]"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FFastFLIM", "]"}], "=", 
   RowBox[{
    RowBox[{"{", "}"}], "~", "Join", "~", 
    RowBox[{"Options", "[", "FScanImage", "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"FFastFLIM", "[", 
   RowBox[{
    RowBox[{"routes", ":", "FRouteList"}], ",", "t0_", ",", 
    RowBox[{"{", 
     RowBox[{"i1_", ",", "i2_"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"tau1_", ",", "tau2_"}], "}"}], ",", "frame_Integer", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "r", ",", "p", ",", "dat", ",", "ndat", ",", "img", ",", "nx", ",", "ny",
       ",", "xmin", ",", "xmax", ",", "ymin", ",", "ymax", ",", 
      "\[CapitalDelta]pix", ",", "GetPixel", ",", "dfunc", ",", "flim"}], 
     "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"r", "=", 
      RowBox[{"Select", "[", 
       RowBox[{
        RowBox[{"MapIndexed", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"#1", " ", 
            RowBox[{"#2", "[", 
             RowBox[{"[", "1", "]"}], "]"}]}], "&"}], ",", "routes"}], "]"}], 
        ",", 
        RowBox[{
         RowBox[{"#", ">", "0"}], "&"}]}], "]"}]}], ";", 
     RowBox[{"p", "=", 
      RowBox[{"Map", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"\"\<n\>\"", "<>", 
            RowBox[{"ToString", "[", "#", "]"}]}], ",", 
           RowBox[{"\"\<tau\>\"", "<>", 
            RowBox[{"ToString", "[", "#", "]"}]}]}], "}"}], "&"}], ",", "r"}],
        "]"}]}], ";", 
     RowBox[{"p", "=", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"Total", "[", 
         RowBox[{"p", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "1"}], "]"}], "]"}], "]"}], ",", 
        RowBox[{"Total", "@", 
         RowBox[{"Map", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Times", "@@", "#"}], "&"}], ",", "p"}], "]"}]}]}], 
       "}"}]}], ";", 
     RowBox[{"dat", "=", 
      RowBox[{"FGetFromPiezoScan", "[", 
       RowBox[{
        RowBox[{"ReleaseHoldAt", "[", 
         RowBox[{
          RowBox[{"Hold", "[", 
           RowBox[{"Transpose", "[", "p", "]"}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"1", ",", "1"}], "}"}]}], "]"}], ",", "frame"}], "]"}]}], 
     ";", 
     RowBox[{"dat", "=", 
      RowBox[{"Map", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"#", "[", 
            RowBox[{"[", "1", "]"}], "]"}], ",", 
           RowBox[{
            RowBox[{
             RowBox[{"#", "[", 
              RowBox[{"[", "2", "]"}], "]"}], "/", 
             RowBox[{"Max", "[", 
              RowBox[{
               RowBox[{"#", "[", 
                RowBox[{"[", "1", "]"}], "]"}], ",", "1"}], "]"}]}], "-", 
            "t0"}]}], "}"}], "&"}], ",", "dat", ",", 
        RowBox[{"{", "2", "}"}]}], "]"}]}], ";", 
     RowBox[{"flim", "=", 
      RowBox[{"FScanImage", "[", 
       RowBox[{"dat", ",", 
        RowBox[{"{", 
         RowBox[{"i1", ",", "i2"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"tau1", ",", "tau2"}], "}"}], ",", 
        RowBox[{"FilterRules", "[", 
         RowBox[{
          RowBox[{"{", "opts", "}"}], ",", " ", 
          RowBox[{"Options", "[", "FScanImage", "]"}]}], "]"}], ",", 
        RowBox[{"FScanImageParamName", "->", "\"\<tau=\>\""}]}], "]"}]}], ";", 
     RowBox[{"{", 
      RowBox[{"dat", ",", "flim"}], "}"}]}]}], "\[IndentingNewLine]", 
   "]"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FFastFLIM", "[", 
    RowBox[{
     RowBox[{"routes", ":", "FRouteList"}], ",", "t0_", ",", 
     RowBox[{"{", 
      RowBox[{"i1_", ",", "i2_"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"tau1_", ",", "tau2_"}], "}"}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"FFastFLIM", "[", 
    RowBox[{"routes", ",", "t0", ",", 
     RowBox[{"{", 
      RowBox[{"i1", ",", "i2"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"tau1", ",", "tau2"}], "}"}], ",", "1", ",", "opts"}], "]"}]}], 
  "\n"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FScanImageColorLegend", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"i1_", ",", "i2_"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"tau1_", ",", "tau2_"}], "}"}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"dat", ",", "di", ",", "dt"}], "}"}], ",", "\n", 
     RowBox[{
      RowBox[{"dat", "=", 
       RowBox[{"Reverse", "@", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"i", ",", "t"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", "i1", ",", "i2", ",", 
            RowBox[{"di", "=", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"i2", "-", "i1"}], ")"}], "/", "10."}]}]}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"t", ",", "tau1", ",", "tau2", ",", 
            RowBox[{"dt", "=", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"tau2", "-", "tau1"}], ")"}], "/", "50."}]}]}], 
           "}"}]}], "]"}]}]}], ";", "\n", 
      RowBox[{"FScanImage", "[", 
       RowBox[{"dat", ",", 
        RowBox[{"{", 
         RowBox[{"i1", ",", "i2"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"tau1", ",", "tau2"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"tau1", ",", "i1", ",", "dt", ",", "di"}], "}"}], ",", 
        RowBox[{"FilterRules", "[", 
         RowBox[{
          RowBox[{"{", "opts", "}"}], ",", " ", 
          RowBox[{"Options", "[", "FScanImage", "]"}]}], "]"}], ",", 
        RowBox[{"AspectRatio", "->", "0.3"}], ",", 
        RowBox[{"FrameLabel", "->", 
         RowBox[{"{", 
          RowBox[{"\"\<parameter\>\"", ",", "\"\<intensity\>\""}], "}"}]}]}], 
       "]"}]}]}], "\n", "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{"FGetScanImageCoordinatesFromTime", "[", 
   RowBox[{"time_", "?", "NumberQ"}], "]"}], ":=", 
  RowBox[{"FPGetScanImageCoordinatesFromTime", "[", 
   RowBox[{"N", "@", "time"}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"FGetScanImageCoordinatesFromTime", ",", "Listable"}], "]"}], 
  ";"}]}], "Input",
 CellChangeTimes->{{3.768803229558674*^9, 3.768803259054781*^9}, {
   3.7743490446856565`*^9, 3.7743491125692077`*^9}, {3.7743491638152294`*^9, 
   3.7743491660971193`*^9}, 3.7743540868009644`*^9, {3.8275623934073133`*^9, 
   3.827562427865013*^9}, {3.8275649209663105`*^9, 3.8275649289933395`*^9}, {
   3.8275774867407155`*^9, 
   3.8275776299877505`*^9}},ExpressionUUID->"948d21bc-b551-4953-a22e-\
c4780d511627"]
}, Closed]],

Cell[CellGroupData[{

Cell["Discrete time HMM (time-binned data)", "Subsubsection",
 CellChangeTimes->{
  3.8580460505776887`*^9},ExpressionUUID->"7a2d703a-a65e-417d-8e26-\
18d5c654466f"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"FHmmTrajectory", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumberQ"}], " ", ".."}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumberQ"}], " ", ".."}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumberQ"}], " ", ".."}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumberQ"}], " ", ".."}], "}"}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumberQ"}], " ", ",", 
          RowBox[{"_", "?", "NumberQ"}]}], " ", "}"}], ".."}], "}"}]}], 
     "}"}]}], ";"}], 
  RowBox[{"(*", 
   RowBox[{"acceptor", " ", "and", " ", "donor", " ", "counts"}], 
   "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FHmmClearTrajectoryList", "[", "]"}], ":=", 
   RowBox[{"FPHmmClearTrajectoryList", "[", "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{"FHmmAppendToTrajectoryList", "[", 
   RowBox[{"tr", ":", "FHmmTrajectory"}], "]"}], ":=", 
  RowBox[{"FPHmmAppendTrajectory", "[", 
   RowBox[{
    RowBox[{"Round", "@", 
     RowBox[{"Flatten", "@", 
      RowBox[{"tr", "[", 
       RowBox[{"[", "2", "]"}], "]"}]}]}], ",", 
    RowBox[{"N", "@", 
     RowBox[{"tr", "[", 
      RowBox[{"[", 
       RowBox[{"1", ",", "1"}], "]"}], "]"}]}], ",", 
    RowBox[{"N", "@", 
     RowBox[{"tr", "[", 
      RowBox[{"[", 
       RowBox[{"1", ",", "2"}], "]"}], "]"}]}], ",", 
    RowBox[{"FHmmBinning", "*", 
     RowBox[{"N", "@", 
      RowBox[{"tr", "[", 
       RowBox[{"[", 
        RowBox[{"1", ",", "3"}], "]"}], "]"}]}]}], ",", 
    RowBox[{"FHmmBinning", "*", 
     RowBox[{"Round", "@", 
      RowBox[{"N", "@", 
       RowBox[{"tr", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "4"}], "]"}], "]"}]}]}]}]}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.749985922226966*^9, 3.749985949939994*^9}, {
  3.7499860997553673`*^9, 3.7499861000745106`*^9}, {3.7499863082274475`*^9, 
  3.749986310187211*^9}, {3.7783905543020277`*^9, 
  3.7783905604366217`*^9}},ExpressionUUID->"61e8fc86-cd5e-48c8-a8d3-\
75f9d4d3ab4d"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FHmmBinning", "=", "1."}], ";"}], "\n", 
 RowBox[{
  RowBox[{"FHmmInitTrajectoryList", "[", 
   RowBox[{
    RowBox[{"trajectorylist", ":", 
     RowBox[{"{", 
      RowBox[{"FHmmTrajectory", ".."}], "}"}]}], ",", 
    RowBox[{"binning_", "?", "NumberQ"}]}], "]"}], ":=", 
  "\[IndentingNewLine]", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"FHmmBinning", "=", "binning"}], ";", "\[IndentingNewLine]", 
     RowBox[{"FHmmClearTrajectoryList", "[", "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Map", "[", 
      RowBox[{"FPHmmAppendTrajectory2", ",", 
       RowBox[{"Round", "@", 
        RowBox[{"N", "@", 
         RowBox[{"trajectorylist", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "2"}], "]"}], "]"}]}]}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"FPHmmSetPhotonRates", "[", 
      RowBox[{
       RowBox[{"N", "@", "FHmmBinning"}], "*", 
       RowBox[{"trajectorylist", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "1", ",", 
          RowBox[{"3", ";;", "4"}]}], "]"}], "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"FPHmmSetPinPfin", "[", 
      RowBox[{
       RowBox[{"N", "@", 
        RowBox[{"Flatten", "@", 
         RowBox[{"trajectorylist", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "1", ",", "1"}], "]"}], "]"}]}]}], ",", 
       RowBox[{"N", "@", 
        RowBox[{"Flatten", "@", 
         RowBox[{"trajectorylist", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "1", ",", "2"}], "]"}], "]"}]}]}], ",", 
       RowBox[{"Length", "@", 
        RowBox[{"trajectorylist", "[", 
         RowBox[{"[", 
          RowBox[{"1", ",", "1", ",", "1"}], "]"}], "]"}]}]}], "]"}], ";"}]}],
    "\[IndentingNewLine]", "\n", "]"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FHmmSetPhotonRates", "[", 
    RowBox[{"rates", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"_List", ",", "_List"}], "}"}], ".."}], "}"}]}], "]"}], ":=", 
   RowBox[{"FPHmmSetPhotonRates", "[", 
    RowBox[{
     RowBox[{"N", "@", "FHmmBinning"}], "*", "rates"}], "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{"FHmmLikelihood", "[", 
   RowBox[{"Km_", "?", "SquareMatrixQ"}], "]"}], ":=", 
  RowBox[{"FPHmmGetLikelihood", "[", 
   RowBox[{"FHmmBinning", "*", 
    RowBox[{"N", "@", "Km"}]}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FHmmLikelihoodPeqFromK", "[", 
   RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], "]"}], ":=", 
  RowBox[{"FPHmmGetLikelihoodPeqFromK", "[", 
   RowBox[{"FHmmBinning", "*", 
    RowBox[{"N", "@", "Km"}]}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FHmmLikelihoodPeqFromK", "[", 
   RowBox[{
    RowBox[{"na", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
    RowBox[{"nd", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
    RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}]}], "]"}], ":=", 
  RowBox[{"FPHmmGetLikelihoodPeqFromKrates", "[", 
   RowBox[{
    RowBox[{"FHmmBinning", "*", 
     RowBox[{"N", "@", "Km"}]}], ",", 
    RowBox[{"FHmmBinning", "*", 
     RowBox[{"N", "@", 
      RowBox[{"{", 
       RowBox[{"na", ",", "nd"}], "}"}]}]}]}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FHmmViterbiPeqFromK", "[", 
   RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "tr", "}"}], ",", 
    RowBox[{"tr", "=", 
     RowBox[{
      RowBox[{"FPHmmViterbiPeqFromK", "[", 
       RowBox[{"FHmmBinning", "*", 
        RowBox[{"N", "@", "Km"}]}], "]"}], "/.", 
      RowBox[{
       RowBox[{"FDwell", "[", 
        RowBox[{"t_", ",", "s_", ",", "dt_", ",", "p___"}], "]"}], ":>", 
       RowBox[{"FDwell", "[", 
        RowBox[{
         RowBox[{"FHmmBinning", "*", "t"}], ",", "s", ",", 
         RowBox[{"FHmmBinning", "*", "dt"}], ",", "p"}], "]"}]}]}]}]}], 
   "]"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FHmmViterbi", "[", 
    RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "tr", "}"}], ",", 
     RowBox[{"tr", "=", 
      RowBox[{
       RowBox[{"FPHmmViterbi", "[", 
        RowBox[{"FHmmBinning", "*", 
         RowBox[{"N", "@", "Km"}]}], "]"}], "/.", 
       RowBox[{
        RowBox[{"FDwell", "[", 
         RowBox[{"t_", ",", "s_", ",", "dt_", ",", "p___"}], "]"}], ":>", 
        RowBox[{"FDwell", "[", 
         RowBox[{
          RowBox[{"FHmmBinning", "*", "t"}], ",", "s", ",", 
          RowBox[{"FHmmBinning", "*", "dt"}], ",", "p"}], "]"}]}]}]}]}], 
    "]"}]}], "\[IndentingNewLine]", "\[IndentingNewLine]"}], "\n"}], "Input",
 CellChangeTimes->{{3.749986107730672*^9, 3.749986146296548*^9}, {
   3.749986311743021*^9, 3.7499863544019504`*^9}, {3.7528254373770485`*^9, 
   3.7528254553500066`*^9}, {3.761042322194938*^9, 3.7610423490910473`*^9}, {
   3.761042391034957*^9, 3.761042423027446*^9}, 3.7610425396472626`*^9, 
   3.761050544426596*^9, {3.777355595481183*^9, 3.777355606745101*^9}, 
   3.777355733667988*^9, {3.7776316469412317`*^9, 3.777631681579638*^9}, {
   3.7776317209293776`*^9, 3.777631742134725*^9}, {3.778320644551231*^9, 
   3.7783206634975805`*^9}, {3.7783207458319445`*^9, 
   3.7783207943921437`*^9}, {3.7783903716083593`*^9, 
   3.7783903941331415`*^9}, {3.7783904473828382`*^9, 3.778390513271695*^9}, {
   3.7783905762004805`*^9, 3.778390588202392*^9}, {3.7783907672298613`*^9, 
   3.778390809409115*^9}, {3.778390892511487*^9, 3.778390921857999*^9}, {
   3.7783911254627056`*^9, 3.778391128279189*^9}, {3.7783911692457037`*^9, 
   3.7783912509382787`*^9}, {3.780148208907544*^9, 3.780148209192785*^9}, {
   3.780148242151814*^9, 
   3.780148243462309*^9}},ExpressionUUID->"9a571947-bd18-49ac-812c-\
b0254154b553"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Continuous time HMM (Irina Gopich)", "Subsubsection",
 CellChangeTimes->{
  3.8094184144952517`*^9},ExpressionUUID->"bd6cf92e-acb7-47e8-a693-\
af03de4daaf5"],

Cell[BoxData[
 RowBox[{"\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"FMLHTrajectory", "=", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumberQ"}], " ", ".."}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumberQ"}], " ", ".."}], "}"}]}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumberQ"}], ",", "_Integer"}], "}"}], ".."}], 
         "}"}]}], "}"}], "|", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumberQ"}], " ", ".."}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumberQ"}], " ", ".."}], "}"}], ",", 
          RowBox[{"_", "?", "FNumericMatrixQ"}]}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumberQ"}], ",", "_Integer"}], "}"}], ".."}], 
         "}"}]}], "}"}], "|", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumberQ"}], ",", "_Integer"}], "}"}], ".."}], 
         "}"}]}], "}"}]}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{"FMLHClearBurstList", "[", "]"}], ":=", 
    RowBox[{"FPClearMLHBurstList", "[", "]"}]}], "\n", 
   RowBox[{
    RowBox[{"FMLHBurstListLength", "[", "]"}], ":=", 
    RowBox[{"FPMLHBurstListLength", "[", "]"}]}], "\n", 
   RowBox[{
    RowBox[{"FMLHAppendToBurstList", "[", 
     RowBox[{"burst", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumberQ"}], ",", "_Integer"}], "}"}], ".."}], 
       "}"}]}], "]"}], ":=", 
    RowBox[{"FPMLHAppendBurst", "[", 
     RowBox[{
      RowBox[{"burst", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", 
      RowBox[{"burst", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "2"}], "]"}], "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"1.", ",", "1."}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"1.", ",", "1."}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"1.", ",", "1."}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"1.", ",", "1."}], "}"}]}], "}"}]}], "]"}]}], "\n", 
   RowBox[{
    RowBox[{"FMLHAppendToBurstList", "[", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"pinital", ":", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumberQ"}], " ", ".."}], "}"}]}], ",", 
         RowBox[{"pfinal", ":", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumberQ"}], " ", ".."}], "}"}]}]}], "}"}], ",", 
       RowBox[{"burst", ":", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumberQ"}], ",", "_Integer"}], "}"}], ".."}], 
         "}"}]}]}], "}"}], "]"}], ":=", 
    RowBox[{"FPMLHAppendBurst", "[", 
     RowBox[{
      RowBox[{"N", "@", 
       RowBox[{"burst", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ",", 
      RowBox[{"burst", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "2"}], "]"}], "]"}], ",", 
      RowBox[{"N", "@", "pinital"}], ",", 
      RowBox[{"N", "@", "pfinal"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"1.", ",", "1."}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"1.", ",", "1."}], "}"}]}], "}"}]}], "]"}]}], "\n", 
   RowBox[{
    RowBox[{"FMLHAppendToBurstList", "[", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"pinital", ":", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumberQ"}], " ", ".."}], "}"}]}], ",", 
         RowBox[{"pfinal", ":", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumberQ"}], " ", ".."}], "}"}]}], ",", 
         RowBox[{"photonrates_", "?", "FNumericMatrixQ"}]}], " ", "}"}], ",", 
       RowBox[{"burst", ":", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumberQ"}], ",", "_Integer"}], "}"}], ".."}], 
         "}"}]}]}], "}"}], "]"}], ":=", 
    RowBox[{"FPMLHAppendBurst", "[", 
     RowBox[{
      RowBox[{"N", "@", 
       RowBox[{"burst", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ",", 
      RowBox[{"burst", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "2"}], "]"}], "]"}], ",", 
      RowBox[{"N", "@", "pinital"}], ",", 
      RowBox[{"N", "@", "pfinal"}], ",", 
      RowBox[{"N", "@", "photonrates"}]}], "]"}]}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"FMLHAppendToBurstList", "[", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"pinital", ":", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
         RowBox[{"pfinal", ":", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
         RowBox[{"na", ":", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
         RowBox[{"nd", ":", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}]}], "}"}], ",", 
       RowBox[{"burst", ":", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumberQ"}], ",", "_Integer"}], "}"}], ".."}], 
         "}"}]}]}], "}"}], "]"}], ":=", 
    RowBox[{"FPMLHAppendBurst", "[", 
     RowBox[{
      RowBox[{"N", "@", 
       RowBox[{"burst", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ",", 
      RowBox[{"burst", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "2"}], "]"}], "]"}], ",", 
      RowBox[{"N", "@", "pinital"}], ",", 
      RowBox[{"N", "@", "pfinal"}], ",", 
      RowBox[{"N", "@", 
       RowBox[{"{", 
        RowBox[{"na", ",", "nd"}], "}"}]}]}], "]"}]}], "\[IndentingNewLine]", 
   "\n", 
   RowBox[{
    RowBox[{"FMLHSetPhotonRates", "[", 
     RowBox[{"photonrates", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "FNumericMatrixQ"}], " ", ".."}], "}"}]}], "]"}], ":=", 
    RowBox[{"FPMLHSetPhotonRates", "[", 
     RowBox[{"N", "@", "photonrates"}], "]"}]}], "\n", "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"Options", "[", "FMLHInitBurstList", "]"}], "=", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"FBurstData", "->", "All"}], ",", 
       RowBox[{"FMLHFirstTauZero", "->", "True"}]}], "}"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{"FMLHInitBurstList", "[", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"selected", "=", "0"}], ",", 
        RowBox[{"tau0", "=", "1"}]}], "}"}], ",", "\n", 
      RowBox[{
       RowBox[{"Which", "[", "\n", 
        RowBox[{
         RowBox[{
          RowBox[{"OptionValue", "[", "FBurstData", "]"}], "===", "All"}], 
         ",", 
         RowBox[{"selected", "=", "0"}], "\n", ",", 
         RowBox[{
          RowBox[{"OptionValue", "[", "FBurstData", "]"}], "===", 
          "FSelectedBursts"}], ",", 
         RowBox[{"selected", "=", "1"}], "\n", ",", "True", ",", 
         RowBox[{"{", "}"}]}], "\n", "]"}], ";", "\n", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"OptionValue", "[", "FMLHFirstTauZero", "]"}], ",", 
         RowBox[{"tau0", "=", "1"}], ",", 
         RowBox[{"tau0", "=", "0"}]}], "]"}], ";", "\n", 
       RowBox[{"FPInitBurstListForMLH", "[", 
        RowBox[{"selected", ",", "tau0", ",", 
         RowBox[{"{", 
          RowBox[{"1", ",", "2", ",", "1", ",", "2", ",", "0", ",", "0"}], 
          "}"}]}], "]"}]}]}], "\n", "]"}]}], "\n", "\n", 
   RowBox[{
    RowBox[{"FMLHInitBurstList", "[", 
     RowBox[{"trajectorylist", ":", 
      RowBox[{"{", 
       RowBox[{"FMLHTrajectory", ".."}], "}"}]}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "}"}], ",", "\n", 
      RowBox[{
       RowBox[{"FMLHClearBurstList", "[", "]"}], ";", "\n", 
       RowBox[{"FMLHAppendToBurstList", "/@", "trajectorylist"}], ";", "\n", 
       RowBox[{"FMLHBurstListLength", "[", "]"}]}]}], "\n", "]"}]}], "\n", 
   "\n"}]}]], "Input",
 CellChangeTimes->{{3.777625072674184*^9, 3.7776250730232487`*^9}, 
   3.7776251206279774`*^9, {3.7776259617160845`*^9, 3.777626024707609*^9}, 
   3.777626112892738*^9, {3.7776261429064007`*^9, 3.7776261921224737`*^9}, {
   3.777626248364094*^9, 3.7776262854359407`*^9}, {3.7776263336245117`*^9, 
   3.7776263700211697`*^9}, 3.777626550219167*^9, {3.7776266094662747`*^9, 
   3.777626667850461*^9}, 3.7776303095644875`*^9, 3.7778746873397665`*^9, 
   3.7783187352424126`*^9, {3.7784114299824095`*^9, 3.7784114978595095`*^9}, 
   3.7945542629147987`*^9, {3.7945551955812387`*^9, 3.794555198282007*^9}, 
   3.794571430340437*^9, {3.7945718142248535`*^9, 3.794571817790286*^9}, 
   3.794571964360196*^9, 
   3.794573034102578*^9},ExpressionUUID->"396af31a-a006-41b0-8deb-\
c522a99070d9"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FMLHGetLikelihoodVpeqFromK", "[", 
   RowBox[{
    RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], ",", 
    RowBox[{"VList", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "FNumericSquareMatrixQ"}], " ", ".."}], "}"}]}]}], 
   "]"}], ":=", 
  RowBox[{"FPMLHGetLikelihoodVpeqFromK", "[", 
   RowBox[{"Km", ",", "VList"}], "]"}]}]], "Input",
 CellChangeTimes->{{3.828154087604344*^9, 
  3.828154159938531*^9}},ExpressionUUID->"08551f0a-8f76-4f9a-901b-\
68603f498510"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FMLHGetLikelihoodpeqFromKconstNtot", "[", 
   RowBox[{
    RowBox[{"photonrates_", "?", "FNumericMatrixQ"}], ",", 
    RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}]}], "]"}], ":=", 
  RowBox[{"FPMLHGetLikelihoodpeqFromKconstNtot", "[", 
   RowBox[{
    RowBox[{"N", "@", "photonrates"}], ",", 
    RowBox[{"N", "@", "Km"}]}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FMLHGetLikelihood", "[", 
   RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], "]"}], ":=", 
  RowBox[{"FPMLHGetLikelihood", "[", 
   RowBox[{"N", "@", "Km"}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FMLHGetLikelihood", "[", 
   RowBox[{
    RowBox[{"photonrates_", "?", "FNumericMatrixQ"}], ",", 
    RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}]}], "]"}], ":=", 
  RowBox[{"FPMLHGetLikelihood", "[", 
   RowBox[{
    RowBox[{"N", "@", "photonrates"}], ",", 
    RowBox[{"N", "@", "Km"}]}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FMLHGetLikelihoodPeqFromK", "[", 
   RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], "]"}], ":=", 
  RowBox[{"FPMLHGetLikelihoodPeqFromK", "[", 
   RowBox[{"N", "@", "Km"}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FMLHGetLikelihoodPeqFromK", "[", 
    RowBox[{
     RowBox[{"photonrates_", "?", "FNumericMatrixQ"}], ",", 
     RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}]}], "]"}], ":=", 
   RowBox[{"FPMLHGetLikelihoodPeqFromK", "[", 
    RowBox[{
     RowBox[{"N", "@", "photonrates"}], ",", 
     RowBox[{"N", "@", "Km"}]}], "]"}]}], "\n", "\n"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FMLHTransitionStatesGetLikelihoods", "[", 
    RowBox[{
     RowBox[{"Km", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "SquareMatrixQ"}], ".."}], "}"}]}], ",", 
     "tslevels_List"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "}"}], ",", "\n", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Length", "[", 
         RowBox[{"Km", "[", 
          RowBox[{"[", "1", "]"}], "]"}], "]"}], "==", 
        RowBox[{
         RowBox[{"Length", "[", "tslevels", "]"}], "+", "2"}]}], "\n", ",", 
       RowBox[{"Partition", "[", 
        RowBox[{
         RowBox[{"FPMLHTransitionStatesGetLikelihoods", "[", 
          RowBox[{
           RowBox[{"N", "@", 
            RowBox[{"Flatten", "@", "Km"}]}], ",", 
           RowBox[{"Length", "[", 
            RowBox[{"Km", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "]"}], ",", 
           RowBox[{"Length", "[", "Km", "]"}], ",", "tslevels"}], "]"}], ",", 
         RowBox[{"Length", "[", "Km", "]"}]}], "]"}], "\n", ",", "4711"}], 
      "]"}]}], "\n", "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{"FMLHTransitionStatesGetLikelihoods", "[", 
   RowBox[{"Km", ":", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"_", "?", "SquareMatrixQ"}], ".."}], "}"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "}"}], ",", "\n", 
    RowBox[{"Partition", "[", 
     RowBox[{
      RowBox[{"FPMLHTransitionStatesGetLikelihoods", "[", 
       RowBox[{
        RowBox[{"N", "@", 
         RowBox[{"Flatten", "@", "Km"}]}], ",", 
        RowBox[{"Length", "[", 
         RowBox[{"Km", "[", 
          RowBox[{"[", "1", "]"}], "]"}], "]"}], ",", 
        RowBox[{"Length", "[", "Km", "]"}]}], "]"}], ",", 
      RowBox[{"Length", "[", "Km", "]"}]}], "]"}]}], "\n", "]"}]}]}], "Input",
 CellChangeTimes->{
  3.7776267371974473`*^9, {3.7776267775973644`*^9, 3.7776268452184634`*^9}, {
   3.777630316797395*^9, 3.777630321255452*^9}, {3.778309778164096*^9, 
   3.7783097840354033`*^9}, {3.7783220257207894`*^9, 
   3.77832205913253*^9}},ExpressionUUID->"1d25ade8-747a-493b-b830-\
7acdf1efb927"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"FMLHViterbi", "[", 
    RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], "]"}], ":=", 
   RowBox[{"FPMLHViterbi", "[", 
    RowBox[{"N", "@", "Km"}], "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FMLHViterbi", "[", 
    RowBox[{
     RowBox[{"photonrates_", "?", "FNumericMatrixQ"}], ",", " ", 
     RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], ",", 
     RowBox[{"p0", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}]}], "]"}], ":=", "\n", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "cpts", "}"}], ",", "\n", 
     RowBox[{
      RowBox[{"cpts", "=", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"Dimensions", "[", "photonrates", "]"}], "[", 
           RowBox[{"[", "2", "]"}], "]"}], "==", 
          RowBox[{"Length", "[", "Km", "]"}]}], "\n", ",", 
         RowBox[{"FPMLHViterbi", "[", 
          RowBox[{
           RowBox[{"N", "@", "photonrates"}], ",", 
           RowBox[{"N", "@", "Km"}], ",", 
           RowBox[{"N", "@", "p0"}]}], "]"}], "\n", ",", "4711"}], "]"}]}], 
      ";", "\n", "cpts"}]}], "\n", "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{"FMLHViterbiPeqFromK", "[", 
   RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "}"}], ",", "\n", 
    RowBox[{"FPMLHViterbiPeqFromK", "[", 
     RowBox[{"N", "@", "Km"}], "]"}]}], "\n", "]"}]}]}], "Code",
 CellChangeTimes->{{3.777626890070489*^9, 3.7776269339164724`*^9}, 
   3.777626968525858*^9, {3.777627016108574*^9, 3.777627055780485*^9}, 
   3.777630323933309*^9, {3.7783220747448463`*^9, 
   3.7783221049370904`*^9}},ExpressionUUID->"7b5d2610-6780-4287-a1b8-\
762eec13487a"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", "\n", 
   RowBox[{
    RowBox[{"FMLHRecolor", "[", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"efret", ":", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
       RowBox[{"\[Lambda]", ":", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
       RowBox[{"U", ":", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}], ".."}], "}"}]}], 
       ",", 
       RowBox[{"Uinv", ":", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}], ".."}], "}"}]}], 
       ",", 
       RowBox[{"p0", ":", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}]}], ",", 
       RowBox[{"kother_", "?", "NumberQ"}]}], "}"}], "]"}], ":=", "\n", 
    RowBox[{
     RowBox[{
      RowBox[{"Module", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"na", ",", "nd"}], "}"}], ",", "\n", 
        RowBox[{
         RowBox[{"na", "=", 
          RowBox[{"N", "@", "efret"}]}], ";", "\n", 
         RowBox[{"nd", "=", 
          RowBox[{"N", "[", 
           RowBox[{"1", "-", "efret"}], "]"}]}], ";", "\n", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"Length", "[", "efret", "]"}], "==", 
             RowBox[{"Length", "[", "\[Lambda]", "]"}], "==", 
             RowBox[{"Length", "[", "U", "]"}], "==", 
             RowBox[{"Length", "[", "Uinv", "]"}], "==", 
             RowBox[{"Length", "[", "p0", "]"}]}], " ", "&&", 
            RowBox[{"Equal", "@@", 
             RowBox[{"Dimensions", "[", "U", "]"}]}], " ", "&&", 
            RowBox[{"Equal", "@@", 
             RowBox[{"Dimensions", "[", "Uinv", "]"}]}]}], "\n", ",", 
           RowBox[{"FPMLHRecolor2", "[", 
            RowBox[{"na", ",", "nd", ",", "\[Lambda]", ",", 
             RowBox[{"Flatten", "[", "U", "]"}], ",", 
             RowBox[{"Flatten", "[", "Uinv", "]"}], ",", "p0", ",", 
             RowBox[{"N", "@", "kother"}]}], "]"}], "\n", ",", "4711"}], 
          "]"}]}]}], "\n", "]"}], "\n", "\n", 
      RowBox[{"FMLHFret", "[", "burst_", "]"}]}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"nd", ",", "na"}], "}"}], ",", "\n", 
       RowBox[{
        RowBox[{"na", "=", 
         RowBox[{"Count", "[", 
          RowBox[{"burst", ",", 
           RowBox[{"{", 
            RowBox[{"_", ",", "0"}], "}"}]}], "]"}]}], ";", "\n", 
        RowBox[{"nd", "=", 
         RowBox[{"Count", "[", 
          RowBox[{"burst", ",", 
           RowBox[{"{", 
            RowBox[{"_", ",", "1"}], "}"}]}], "]"}]}], ";", "\n", 
        RowBox[{"na", "/", 
         RowBox[{"(", 
          RowBox[{"na", "+", "nd"}], ")"}]}]}]}], "\n", "]"}]}]}], "\n", 
   "*)"}], "\n", 
  RowBox[{
   RowBox[{"FMLHGetBursts", "[", 
    RowBox[{"istart_Integer", ",", "istop_Integer"}], "]"}], ":=", 
   RowBox[{"FPGetMLHBurstList", "[", 
    RowBox[{"istart", ",", "istop"}], "]"}]}]}]], "Code",
 CellChangeTimes->{{3.777627116855152*^9, 
  3.777627131126938*^9}},ExpressionUUID->"fbed1ddc-9103-4ba3-8b1c-\
67b833b1f3cb"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"FDwellList", "[", "]"}], "[", "transition_Rule", "]"}], ":=", 
  RowBox[{"FDwellList", "[", "]"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FDwellList", "[", 
    RowBox[{"dwells", ":", 
     RowBox[{"_FDwell", " ", ".."}]}], "]"}], "[", "transition_Rule", "]"}], ":=", 
  RowBox[{"FDwellList", "@@", 
   RowBox[{"Cases", "[", 
    RowBox[{
     RowBox[{"{", "dwells", "}"}], ",", 
     RowBox[{"FDwell", "[", 
      RowBox[{"_", ",", "transition", ",", "___"}], "]"}]}], "]"}]}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"FDwellList", "[", 
     RowBox[{"dwells", ":", 
      RowBox[{"_FDwellList", " ", ".."}]}], "]"}], "[", "transition_Rule", 
    "]"}], ":=", 
   RowBox[{"FDwellList", "@@", 
    RowBox[{"Map", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"#", "[", "transition", "]"}], "&"}], ",", 
      RowBox[{"{", "dwells", "}"}]}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FDwellList", "[", "dwells___", "]"}], "[", "\"\<t\>\"", "]"}], ":=", 
  RowBox[{
   RowBox[{
    RowBox[{"{", "dwells", "}"}], "/.", 
    RowBox[{
     RowBox[{"FDwell", "[", 
      RowBox[{"t_", ",", "___"}], "]"}], "->", "t"}]}], "/.", 
   RowBox[{"FDwellList", "->", "List"}]}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FDwellList", "[", "dwells___", "]"}], "[", "\"\<transition\>\"", 
   "]"}], ":=", 
  RowBox[{
   RowBox[{
    RowBox[{"{", "dwells", "}"}], "/.", 
    RowBox[{
     RowBox[{"FDwell", "[", 
      RowBox[{"_", ",", "transition_", ",", "___"}], "]"}], "->", 
     "transition"}]}], "/.", 
   RowBox[{"FDwellList", "->", "List"}]}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FDwellList", "[", "dwells___", "]"}], "[", "\"\<state\>\"", "]"}],
   ":=", 
  RowBox[{
   RowBox[{
    RowBox[{"{", "dwells", "}"}], "/.", 
    RowBox[{
     RowBox[{"FDwell", "[", 
      RowBox[{"_", ",", 
       RowBox[{"s_", "->", "_"}], ",", "___"}], "]"}], "->", "s"}]}], "/.", 
   RowBox[{"FDwellList", "->", "List"}]}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FDwellList", "[", "dwells___", "]"}], "[", "\"\<dt\>\"", "]"}], ":=", 
  RowBox[{
   RowBox[{
    RowBox[{"{", "dwells", "}"}], "/.", 
    RowBox[{
     RowBox[{"FDwell", "[", 
      RowBox[{"_", ",", "_", ",", "dt_", ",", "___"}], "]"}], "->", "dt"}]}], 
   "/.", 
   RowBox[{"FDwellList", "->", "List"}]}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FDwellList", "[", "dwells___", "]"}], "[", "\"\<Na\>\"", "]"}], ":=", 
  RowBox[{
   RowBox[{
    RowBox[{"{", "dwells", "}"}], "/.", 
    RowBox[{
     RowBox[{"FDwell", "[", 
      RowBox[{"_", ",", "_", ",", "_", ",", 
       RowBox[{"{", 
        RowBox[{"na_", ",", "___"}], "}"}], ",", "___"}], "]"}], "->", 
     "na"}]}], "/.", 
   RowBox[{"FDwellList", "->", "List"}]}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FDwellList", "[", "dwells___", "]"}], "[", "\"\<Nd\>\"", "]"}], ":=", 
  RowBox[{
   RowBox[{
    RowBox[{"{", "dwells", "}"}], "/.", 
    RowBox[{
     RowBox[{"FDwell", "[", 
      RowBox[{"_", ",", "_", ",", "_", ",", 
       RowBox[{"{", 
        RowBox[{"_", ",", "nd_", ",", "___"}], "}"}], ",", "___"}], "]"}], "->",
      "nd"}]}], "/.", 
   RowBox[{"FDwellList", "->", "List"}]}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FDwellList", "[", "dwells___", "]"}], "[", "\"\<PhotonRates\>\"", 
   "]"}], ":=", 
  RowBox[{
   RowBox[{
    RowBox[{"{", "dwells", "}"}], "/.", 
    RowBox[{
     RowBox[{"FDwell", "[", 
      RowBox[{"_", ",", "_", ",", "dt_", ",", "n_", ",", "___"}], "]"}], "->", 
     RowBox[{"n", "/", "dt"}]}]}], "/.", 
   RowBox[{"FDwellList", "->", "List"}]}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FDwellList", "[", "dwells___", "]"}], "[", 
   RowBox[{"expr_", "?", 
    RowBox[{"(", 
     RowBox[{
      RowBox[{"!", 
       RowBox[{"StringQ", "[", "#", "]"}]}], "&"}], ")"}]}], "]"}], ":=", 
  RowBox[{"expr", "/.", 
   RowBox[{"s_String", ":>", 
    RowBox[{
     RowBox[{"FDwellList", "[", "dwells", "]"}], "[", "s", 
     "]"}]}]}]}]}], "Code",ExpressionUUID->"c8b54af8-14b9-4bf4-bae8-\
e94d039bcbe2"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"FDwellList", "[", "dwells___", "]"}], "[", 
   RowBox[{"\"\<stategraph\>\"", ",", "t0_", ",", "scale_", ",", "offset_"}], 
   "]"}], ":=", 
  RowBox[{
   RowBox[{"{", "dwells", "}"}], "/.", 
   RowBox[{
    RowBox[{"FDwell", "[", 
     RowBox[{"t_", ",", 
      RowBox[{"s1_", "->", "s2_"}], ",", "dt_", ",", "___"}], "]"}], ":>", 
    RowBox[{"Sequence", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"t0", "+", "t"}], ",", 
        RowBox[{
         RowBox[{"scale", " ", "s1"}], "+", "offset"}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"t0", "+", "t", "+", "dt"}], ",", 
        RowBox[{
         RowBox[{"scale", " ", "s1"}], "+", "offset"}]}], "}"}]}], 
     "]"}]}]}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FDwellList", "[", "dwells___", "]"}], "[", 
   RowBox[{"\"\<mcs\>\"", ",", "t0_", ",", "ratefunc_"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"{", "dwells", "}"}], "/.", 
   RowBox[{
    RowBox[{"FDwell", "[", 
     RowBox[{"t_", ",", 
      RowBox[{"s1_", "->", "s2_"}], ",", "dt_", ",", "___"}], "]"}], ":>", 
    RowBox[{"Sequence", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"t0", "+", "t"}], ",", 
        RowBox[{"ratefunc", "[", "s1", "]"}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"t0", "+", "t", "+", "dt"}], ",", 
        RowBox[{"ratefunc", "[", "s1", "]"}]}], "}"}]}], "]"}]}]}]}]}], "Code",
 CellChangeTimes->{3.8503788651807065`*^9, 
  3.8503813953515654`*^9},ExpressionUUID->"6c4d416f-4f1e-42ed-bb2e-\
f92419bc5862"],

Cell[BoxData[""], "Input",ExpressionUUID->"cea870cb-9b76-4279-9b2b-ef4baf2ff53a"],

Cell[BoxData[
 RowBox[{
  RowBox[{"CombineTransitions", "[", 
   RowBox[{"dwells", ":", 
    RowBox[{"FDwellList", "[", 
     RowBox[{"_FDwell", ".."}], "]"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "}"}], ",", "\n", 
    RowBox[{"FDwell", "[", 
     RowBox[{
      RowBox[{"dwells", "[", 
       RowBox[{"[", 
        RowBox[{"1", ",", "1"}], "]"}], "]"}], ",", 
      RowBox[{
       RowBox[{"dwells", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "2", ",", "1"}], "]"}], "]"}], "->", 
       RowBox[{"dwells", "[", 
        RowBox[{"[", 
         RowBox[{
          RowBox[{"-", "1"}], ",", "2", ",", "2"}], "]"}], "]"}]}], ",", 
      RowBox[{"Total", "[", 
       RowBox[{"List", "@@", 
        RowBox[{"dwells", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "3"}], "]"}], "]"}]}], "]"}], ",", 
      RowBox[{"Total", "[", 
       RowBox[{"List", "@@", 
        RowBox[{"dwells", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "4"}], "]"}], "]"}]}], "]"}]}], "]"}]}], "\n", 
   "]"}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.767529303146427*^9, 
  3.7675293283699284`*^9}},ExpressionUUID->"da8352fd-6027-46d8-9662-\
054a4d368a14"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FJoinSelftransitions", "[", 
   RowBox[{"dwells", ":", 
    RowBox[{"FDwellList", "[", 
     RowBox[{"_FDwell", ".."}], "]"}]}], "]"}], ":=", 
  RowBox[{"CombineTransitions", "/@", 
   RowBox[{"Split", "[", 
    RowBox[{"dwells", ",", 
     RowBox[{
      RowBox[{
       RowBox[{"#2", "[", 
        RowBox[{"[", 
         RowBox[{"2", ",", "1"}], "]"}], "]"}], "==", 
       RowBox[{"#1", "[", 
        RowBox[{"[", 
         RowBox[{"2", ",", "1"}], "]"}], "]"}]}], "&"}]}], "]"}]}]}], "\n", 
 RowBox[{
  RowBox[{"FJoinSelftransitions", "[", 
   RowBox[{"dwells", ":", 
    RowBox[{"FDwellList", "[", 
     RowBox[{"_FDwellList", ".."}], "]"}]}], "]"}], ":=", 
  RowBox[{"FJoinSelftransitions", "/@", "dwells"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{
  3.850377279270754*^9, {3.85038121576444*^9, 
   3.8503812219831114`*^9}},ExpressionUUID->"49853eb2-e62f-48ca-b328-\
15203172dbde"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FRenameStates", "[", 
   RowBox[{
    RowBox[{"dwells", ":", 
     RowBox[{"FDwellList", "[", 
      RowBox[{"_FDwell", ".."}], "]"}]}], ",", 
    RowBox[{"rename", ":", 
     RowBox[{"{", 
      RowBox[{"_Rule", ".."}], "}"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"newdwells", ",", "pos", ",", "new", ",", "deletepos"}], "}"}], 
    ",", "\n", 
    RowBox[{
     RowBox[{"newdwells", "=", "dwells"}], ";", "\n", 
     RowBox[{
      RowBox[{"newdwells", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "2"}], "]"}], "]"}], "=", 
      RowBox[{
       RowBox[{"List", "@@", 
        RowBox[{"newdwells", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "2"}], "]"}], "]"}]}], "/.", "rename"}]}], ";", 
     "\n", 
     RowBox[{"FJoinSelftransitions", "@", "newdwells"}]}]}], "\n", 
   "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FRenameStates", "[", 
   RowBox[{
    RowBox[{"FDwellList", "[", "]"}], ",", "_"}], "]"}], ":=", 
  RowBox[{"FDwellList", "[", "]"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FRenameStates", "[", 
    RowBox[{
     RowBox[{"dwells", ":", 
      RowBox[{"FDwellList", "[", 
       RowBox[{"_FDwellList", ".."}], "]"}]}], ",", 
     RowBox[{"rename", ":", 
      RowBox[{"{", 
       RowBox[{"_Rule", ".."}], "}"}]}]}], "]"}], ":=", 
   RowBox[{"Map", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"FRenameStates", "[", 
       RowBox[{"#", ",", "rename"}], "]"}], "&"}], ",", "dwells"}], "]"}]}], 
  "\n", "\n"}], "\n"}], "Input",
 InitializationCell->
  True,ExpressionUUID->"b2f8255b-f5cf-4acf-adb8-cfd5b372eea2"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FSplitTrajectory", "[", 
   RowBox[{
    RowBox[{"dwells", ":", 
     RowBox[{"FDwellList", "[", 
      RowBox[{"_FDwell", " ", ".."}], "]"}]}], ",", "T_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "t0", ",", "tf", ",", "nbins", ",", "split", ",", "dw", ",", "s", ",", 
      "sf", ",", "dwi"}], "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"t0", "=", 
      RowBox[{"dwells", "[", 
       RowBox[{"[", 
        RowBox[{"1", ",", "1"}], "]"}], "]"}]}], ";", "\n", 
     RowBox[{"tf", "=", 
      RowBox[{
       RowBox[{"dwells", "[", 
        RowBox[{"[", 
         RowBox[{
          RowBox[{"-", "1"}], ",", "1"}], "]"}], "]"}], "+", 
       RowBox[{"dwells", "[", 
        RowBox[{"[", 
         RowBox[{
          RowBox[{"-", "1"}], ",", "3"}], "]"}], "]"}]}]}], ";", "\n", 
     RowBox[{"nbins", "=", 
      RowBox[{
       RowBox[{"Floor", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{"tf", "-", "t0"}], ")"}], "/", "T"}], "]"}], "+", "1"}]}], 
     ";", "\n", "\n", 
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"split", "[", "i", "]"}], "=", 
        RowBox[{"FDwellList", "[", "]"}]}], ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", "nbins"}], "}"}]}], "]"}], ";", "\n", 
     RowBox[{"Do", "[", "\n", "\n", 
      RowBox[{
       RowBox[{
        RowBox[{"dw", "=", 
         RowBox[{"dwells", "[", 
          RowBox[{"[", "i", "]"}], "]"}]}], ";", "\n", 
        RowBox[{"s", "=", 
         RowBox[{
          RowBox[{"Floor", "[", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"dw", "[", 
               RowBox[{"[", "1", "]"}], "]"}], "-", "t0"}], ")"}], "/", "T"}],
            "]"}], "+", "1"}]}], ";", "\n", 
        RowBox[{"sf", "=", 
         RowBox[{"Ceiling", "[", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             RowBox[{"dw", "[", 
              RowBox[{"[", "1", "]"}], "]"}], "+", 
             RowBox[{"dw", "[", 
              RowBox[{"[", "3", "]"}], "]"}], "-", "t0"}], ")"}], "/", "T"}], 
          "]"}]}], ";", "\n", 
        RowBox[{"While", "[", 
         RowBox[{
          RowBox[{"sf", "!=", "s"}], ",", "\n", 
          RowBox[{
           RowBox[{"dwi", "=", "dw"}], ";", "\n", 
           RowBox[{
            RowBox[{"dwi", "[", 
             RowBox[{"[", 
              RowBox[{"2", ",", "2"}], "]"}], "]"}], "=", 
            RowBox[{"dwi", "[", 
             RowBox[{"[", 
              RowBox[{"2", ",", "1"}], "]"}], "]"}]}], ";", "\n", 
           RowBox[{
            RowBox[{"dwi", "[", 
             RowBox[{"[", "3", "]"}], "]"}], "=", 
            RowBox[{"t0", "+", 
             RowBox[{"s", "*", "T"}], "-", 
             RowBox[{"dwi", "[", 
              RowBox[{"[", "1", "]"}], "]"}]}]}], ";", "\n", 
           RowBox[{"AppendTo", "[", 
            RowBox[{
             RowBox[{"split", "[", "s", "]"}], ",", "dwi"}], "]"}], ";", "\n", 
           RowBox[{
            RowBox[{"dw", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "=", 
            RowBox[{"t0", "+", 
             RowBox[{"s", "*", "T"}]}]}], ";", "\n", 
           RowBox[{
            RowBox[{"dw", "[", 
             RowBox[{"[", "3", "]"}], "]"}], "-=", 
            RowBox[{"dwi", "[", 
             RowBox[{"[", "3", "]"}], "]"}]}], ";", "\n", 
           RowBox[{"s", "=", 
            RowBox[{
             RowBox[{"Floor", "[", 
              RowBox[{
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"dw", "[", 
                  RowBox[{"[", "1", "]"}], "]"}], "-", "t0"}], ")"}], "/", 
               "T"}], "]"}], "+", "1"}]}], ";", "\n", 
           RowBox[{"sf", "=", 
            RowBox[{"Ceiling", "[", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{
                RowBox[{"dw", "[", 
                 RowBox[{"[", "1", "]"}], "]"}], "+", 
                RowBox[{"dw", "[", 
                 RowBox[{"[", "3", "]"}], "]"}], "-", "t0"}], ")"}], "/", 
              "T"}], "]"}]}], ";"}]}], "\n", "]"}], ";", "\n", 
        RowBox[{"AppendTo", "[", 
         RowBox[{
          RowBox[{"split", "[", "s", "]"}], ",", "dw"}], "]"}], ";"}], "\n", 
       "\n", ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", 
         RowBox[{"Length", "[", "dwells", "]"}]}], "}"}]}], "\n", "]"}], ";", 
     "\n", 
     RowBox[{"FDwellList", "@@", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"split", "[", "s", "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"s", ",", "nbins"}], "}"}]}], "]"}]}]}]}], "\n", 
   "]"}]}]], "Code",ExpressionUUID->"ecc43d5a-8dc0-4bf6-be9b-861f286f4365"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Unified HMM commands", "Subsubsection",
 CellChangeTimes->{{3.7494544408115234`*^9, 
  3.749454452559103*^9}},ExpressionUUID->"9393f1e2-ef74-4638-b681-\
91f23d820156"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FHmmBinning", "=", "1."}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FHMMmode", "=", "None"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FHMMTrajectoryCount", "=", "0"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FHMMStateCount", "=", "0"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FHMMGlobalRates", "=", "False"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FHMMNa", "=", 
   RowBox[{"{", 
    RowBox[{"1", ",", "1"}], "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FHMMNd", "=", 
   RowBox[{"{", 
    RowBox[{"1", ",", "1"}], "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FHMMRate", "=", 
   RowBox[{"{", "}"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.749466891328204*^9, 3.7494669049603567`*^9}, {
  3.749467005772902*^9, 3.7494670232095947`*^9}, {3.7494676232807198`*^9, 
  3.749467657154451*^9}, {3.7494678877648816`*^9, 3.749467917318637*^9}, {
  3.749468076795555*^9, 3.749468108091424*^9}, {3.749981906934828*^9, 
  3.7499819069487925`*^9}, {3.7501481401679487`*^9, 3.7501481452912493`*^9}, {
  3.7501497107406206`*^9, 3.750149715913785*^9}, {3.7529205203288183`*^9, 
  3.7529205243969293`*^9}, {3.7748619096441956`*^9, 
  3.7748619464428473`*^9}},ExpressionUUID->"8d0f6a08-c92c-42a4-b85c-\
d657bd0d4aad"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FHMMInitWithBinnedData", "[", 
   RowBox[{
    RowBox[{"trlist", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"_Integer", ".."}], " ", "}"}], ".."}], "}"}], ".."}], 
      "}"}]}], ",", 
    RowBox[{"Tbinning_", "?", "NumericQ"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"FHmmBinning", "=", "Tbinning"}], ";", "\[IndentingNewLine]", 
     RowBox[{"FHmmClearTrajectoryList", "[", "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"unitv", "=", 
        RowBox[{"ConstantArray", "[", 
         RowBox[{"1.", ",", "2"}], "]"}]}], ";"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"FPHmmAppendTrajectory", "[", 
           RowBox[{
            RowBox[{"Round", "@", 
             RowBox[{"Flatten", "@", "#"}]}], ",", "unitv", ",", "unitv", ",",
             "unitv", ",", "unitv"}], "]"}], "&"}], ",", "trlist"}], "]"}], 
       ";"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"Map", "[", 
      RowBox[{"FPHmmAppendTrajectory2", ",", "trlist"}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"FHMMmode", "=", "FHMMBinned"}], ";", "\[IndentingNewLine]", 
     RowBox[{"FHMMTrajectoryCount", "=", 
      RowBox[{"Length", "[", "trlist", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"FHMMStateCount", "=", "0"}], ";"}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.7494661201885214`*^9, 3.749466120532586*^9}, {
   3.749466161046032*^9, 3.7494662052479744`*^9}, {3.749466287389041*^9, 
   3.7494663459640927`*^9}, {3.7494664027681656`*^9, 
   3.7494665253417253`*^9}, {3.7494668457956057`*^9, 
   3.7494668736904063`*^9}, {3.749467030735467*^9, 3.7494670541789494`*^9}, 
   3.749467752422865*^9, {3.7495336861652555`*^9, 3.74953373240164*^9}, {
   3.749533821786525*^9, 3.7495338871610546`*^9}, 3.7495469326926785`*^9, {
   3.749549558536272*^9, 3.749549563590763*^9}, {3.7499819069527817`*^9, 
   3.7499819069777136`*^9}, {3.749986186962763*^9, 3.7499862226812525`*^9}, {
   3.750148204514877*^9, 3.7501482285405917`*^9}, {3.7501497996563396`*^9, 
   3.7501498032736645`*^9}, {3.7529194625061884`*^9, 
   3.7529194698676977`*^9}, {3.752919609214021*^9, 3.7529196514660215`*^9}, {
   3.752919688349354*^9, 3.7529197190641994`*^9}, {3.7529197517084403`*^9, 
   3.7529198488925*^9}, {3.774786244390152*^9, 3.7747862850894146`*^9}, {
   3.7748507252670813`*^9, 3.774850738726137*^9}, {3.7748515620663166`*^9, 
   3.7748515738737545`*^9}, {3.774861572299647*^9, 3.774861601488654*^9}, 
   3.7748626316175632`*^9, {3.7783907111447363`*^9, 
   3.7783907243424687`*^9}},ExpressionUUID->"310afc62-c6a5-475b-af7a-\
9b0e89e9109f"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FHMMInitWithPhotonByPhotonData", "[", 
   RowBox[{"trlist", ":", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumericQ"}], " ", ",", "_Integer"}], " ", "}"}], 
        ".."}], "}"}], ".."}], "}"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"unitv", ",", "tr"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"FMLHClearBurstList", "[", "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"unitv", "=", 
      RowBox[{"ConstantArray", "[", 
       RowBox[{"1", ",", "2"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Map", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"FMLHAppendToBurstList", "[", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"tr", "=", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"unitv", ",", "unitv", ",", 
                RowBox[{"{", 
                 RowBox[{"unitv", ",", "unitv"}], "}"}]}], "}"}], ",", "#"}], 
             "}"}]}], ";", 
           RowBox[{
            RowBox[{"tr", "[", 
             RowBox[{"[", 
              RowBox[{"2", ",", "All", ",", "2"}], "]"}], "]"}], "-=", "1"}], 
           ";", "tr"}], ")"}], "]"}], "&"}], ",", "trlist"}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"FHMMmode", "=", "FHMMPhotonByPhoton"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"FHMMTrajectoryCount", "=", 
      RowBox[{"Length", "[", "trlist", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"FHMMStateCount", "=", "0"}], ";"}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.7494665806668053`*^9, 3.749466595347588*^9}, {
   3.7494666486188655`*^9, 3.7494667175235643`*^9}, {3.7494667937131996`*^9, 
   3.7494668279855375`*^9}, {3.7494670644684296`*^9, 3.749467064855386*^9}, 
   3.749467756632594*^9, {3.749533746674418*^9, 3.749533748154462*^9}, {
   3.7495339057144794`*^9, 3.7495339643276663`*^9}, 3.749547094344572*^9, 
   3.7495473685809216`*^9, 3.7495479042654405`*^9, {3.749549540641127*^9, 
   3.7495495513983564`*^9}, {3.749550510890293*^9, 3.7495505729397707`*^9}, {
   3.749981906985693*^9, 3.74998190700068*^9}, {3.7501482735003414`*^9, 
   3.750148297429345*^9}, {3.750149816314785*^9, 3.7501498169900713`*^9}, {
   3.7778747309581757`*^9, 
   3.777874736044568*^9}},ExpressionUUID->"49226366-0c32-4424-b424-\
f6342a00513e"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
   "Options", "[", "FHMMInitWithPhotonByPhotonDataFromBurstList", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"FBurstData", "->", "All"}], ",", 
     RowBox[{"FHMMFirstTauZero", "->", "True"}]}], "}"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"FHMMInitWithPhotonByPhotonDataFromBurstList", "[", 
   RowBox[{
    RowBox[{"colormap", ":", 
     RowBox[{"{", 
      RowBox[{"_Integer", ".."}], "}"}]}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"selected", "=", "0"}], ",", 
      RowBox[{"tau0", "=", "1"}], ",", "n"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"Which", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FBurstData", "]"}], "===", "All"}], ",", 
       RowBox[{"selected", "=", "0"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"OptionValue", "[", "FBurstData", "]"}], "===", 
        "FSelectedBursts"}], ",", 
       RowBox[{"selected", "=", "1"}], ",", "True", ",", 
       RowBox[{"{", "}"}]}], "\[IndentingNewLine]", "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"OptionValue", "[", "FHMMFirstTauZero", "]"}], ",", 
       RowBox[{"tau0", "=", "1"}], ",", 
       RowBox[{"tau0", "=", "0"}]}], "]"}], ";", 
     RowBox[{"n", "=", 
      RowBox[{"FPInitBurstListForMLH", "[", 
       RowBox[{"selected", ",", "tau0", ",", "colormap"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"FHMMmode", "=", "FHMMPhotonByPhoton"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"FHMMTrajectoryCount", "=", "n"}], ";", "\[IndentingNewLine]", 
     RowBox[{"FHMMStateCount", "=", "0"}], ";", "\[IndentingNewLine]", 
     "n"}]}], "\n", "]"}]}]}], "Input",
 CellChangeTimes->{{3.778411723019599*^9, 3.778411762299594*^9}, {
  3.7784118783792973`*^9, 3.7784119527903657`*^9}, {3.7784129894210167`*^9, 
  3.778412992336274*^9}, {3.8721500867521267`*^9, 3.8721502191682234`*^9}, {
  3.8721516130653505`*^9, 
  3.872151613604893*^9}},ExpressionUUID->"3d5f3dae-36b1-4ca9-805f-\
c31fcda8297e"],

Cell[BoxData[""], "Input",
 CellChangeTimes->{{3.750141335889906*^9, 3.750141336553132*^9}, {
   3.7501416790790157`*^9, 3.7501417106316257`*^9}, {3.750147993930109*^9, 
   3.7501480031204967`*^9}, 
   3.7501504339601994`*^9},ExpressionUUID->"06810b55-8f53-462d-9225-\
e14333597be7"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"FHMMSetPhotonRates", "[", 
     RowBox[{"rates", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], "}"}], ".."}], 
       "}"}]}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "nstates", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"nstates", "=", 
        RowBox[{"Length", "[", 
         RowBox[{"rates", "[", 
          RowBox[{"[", 
           RowBox[{"1", ",", "1"}], "]"}], "]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"AnyTrue", "[", 
          RowBox[{"rates", ",", 
           RowBox[{
            RowBox[{
             RowBox[{"Length", "[", "#", "]"}], "\[NotEqual]", "nstates"}], 
            "&"}], ",", "2"}], "]"}], ",", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Message", "[", 
            RowBox[{"FHMMSetPhotonRates", "::", "dimerr"}], "]"}], ";", 
           RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"FHMMGlobalRates", "=", "False"}], ";", "\[IndentingNewLine]", 
       RowBox[{"Which", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"FHMMmode", "===", "FHMMBinned"}], ",", 
         RowBox[{"FPHmmSetPhotonRates", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"N", "@", "FHmmBinning"}], "*", 
            RowBox[{"Flatten", "@", 
             RowBox[{"rates", "[", 
              RowBox[{"[", 
               RowBox[{"All", ",", "1"}], "]"}], "]"}]}]}], ",", 
           RowBox[{
            RowBox[{"N", "@", "FHmmBinning"}], "*", 
            RowBox[{"Flatten", "@", 
             RowBox[{"rates", "[", 
              RowBox[{"[", 
               RowBox[{"All", ",", "2"}], "]"}], "]"}]}]}], ",", 
           RowBox[{"Length", "@", 
            RowBox[{"rates", "[", 
             RowBox[{"[", 
              RowBox[{"1", ",", "1"}], "]"}], "]"}]}]}], "]"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"FHMMmode", "===", "FHMMPhotonByPhoton"}], ",", 
         RowBox[{"FMLHSetPhotonRates", "[", "rates", "]"}], ",", 
         "\[IndentingNewLine]", "True", ",", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Message", "[", 
            RowBox[{"FHMMSetPhotonRates", "::", "erroptval"}], "]"}], ";", 
           RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
        "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"FHMMStateCount", "=", "nstates"}], ";"}]}], 
     "\[IndentingNewLine]", "]"}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"FHMMSetPhotonRates", "[", 
     RowBox[{"rates", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "FNumericMatrixQ"}], ".."}], "}"}]}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "nstates", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"nstates", "=", 
        RowBox[{"Length", "[", 
         RowBox[{"rates", "[", 
          RowBox[{"[", 
           RowBox[{"1", ",", "1"}], "]"}], "]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"AnyTrue", "[", 
          RowBox[{"rates", ",", 
           RowBox[{
            RowBox[{
             RowBox[{"Length", "[", "#", "]"}], "\[NotEqual]", "nstates"}], 
            "&"}], ",", "2"}], "]"}], ",", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Message", "[", 
            RowBox[{"FHMMSetPhotonRates", "::", "dimerr"}], "]"}], ";", 
           RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"FHMMGlobalRates", "=", "False"}], ";", "\[IndentingNewLine]", 
       RowBox[{"Which", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"FHMMmode", "===", "FHMMBinned"}], ",", 
         RowBox[{"FPHmmSetPhotonRates", "[", 
          RowBox[{
           RowBox[{"N", "@", "FHmmBinning"}], "*", "rates"}], "]"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"FHMMmode", "===", "FHMMPhotonByPhoton"}], ",", 
         RowBox[{"FMLHSetPhotonRates", "[", "rates", "]"}], ",", 
         "\[IndentingNewLine]", "True", ",", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Message", "[", 
            RowBox[{"FHMMSetPhotonRates", "::", "erroptval"}], "]"}], ";", 
           RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
        "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"FHMMStateCount", "=", "nstates"}], ";"}]}], 
     "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"FHMMSetPhotonRates", "[", 
     RowBox[{"rates_", "?", "FNumericMatrixQ"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Length", "[", "nA", "]"}], "!=", 
           RowBox[{"Length", "[", "nD", "]"}]}], " ", ",", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"Message", "[", 
             RowBox[{"FHMMSetPhotonRates", "::", "dimerr"}], "]"}], ";", 
            RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], "]"}], ";"}], 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"FHMMSetPhotonRates", "[", 
        RowBox[{"ConstantArray", "[", 
         RowBox[{"rates", ",", "FHMMTrajectoryCount"}], "]"}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"FHMMGlobalRates", "=", "True"}], ";", "\[IndentingNewLine]", 
       RowBox[{"FHMMRate", "=", "rates"}]}]}], "\[IndentingNewLine]", 
     "]"}]}]}]}]], "Input",
 CellChangeTimes->{{3.7494669861464057`*^9, 3.749466989115467*^9}, {
   3.749467078550751*^9, 3.749467117840347*^9}, {3.7494671535495186`*^9, 
   3.749467323666687*^9}, {3.7494674164462223`*^9, 3.7494674725061264`*^9}, {
   3.7494676919993315`*^9, 3.749467735241808*^9}, 3.749467847597299*^9, {
   3.7494679600687523`*^9, 3.749468066351487*^9}, {3.749468125382179*^9, 
   3.7494681506695447`*^9}, {3.7495291519840097`*^9, 
   3.7495291583489857`*^9}, {3.7495291886959157`*^9, 
   3.7495292289412794`*^9}, {3.749530356519924*^9, 3.7495304082841578`*^9}, 
   3.7495337694175897`*^9, {3.7495340745957456`*^9, 3.749534075370719*^9}, {
   3.7495341504598513`*^9, 3.749534157962826*^9}, {3.7495343379712057`*^9, 
   3.7495343636468368`*^9}, {3.7495344608907485`*^9, 
   3.7495345002582293`*^9}, {3.7495349392642612`*^9, 3.749535006577127*^9}, {
   3.7495351419298134`*^9, 3.7495352261623807`*^9}, {3.749536792135975*^9, 
   3.7495368115989943`*^9}, {3.749546502985573*^9, 3.749546512482171*^9}, {
   3.749981907005665*^9, 3.749981907082461*^9}, {3.749985522786653*^9, 
   3.7499855235366573`*^9}, {3.7501408679689856`*^9, 3.750140918503724*^9}, {
   3.7501411529511895`*^9, 3.7501411579468307`*^9}, {3.750141209161852*^9, 
   3.750141225144103*^9}, {3.7501412950880346`*^9, 3.7501413150576243`*^9}, {
   3.7501463755161533`*^9, 3.7501464124244413`*^9}, {3.750147953247884*^9, 
   3.7501479707640686`*^9}, 3.750148051796307*^9, {3.7501483323499403`*^9, 
   3.750148426298667*^9}, {3.750149746881489*^9, 3.7501497563342094`*^9}, 
   3.7501508727313433`*^9, 3.7528250614918556`*^9, {3.774858247308624*^9, 
   3.7748582602421055`*^9}, 3.774858295475873*^9, 3.7748586435138946`*^9, {
   3.774859871056409*^9, 3.7748598744822507`*^9}, {3.7748617010993576`*^9, 
   3.7748617013826017`*^9}, {3.7748618150221186`*^9, 3.774861887836534*^9}, {
   3.7748619632409277`*^9, 3.774861984745446*^9}, 3.7748626500582714`*^9, 
   3.7773557488004637`*^9, 3.7776273311267757`*^9, 
   3.7776274283048506`*^9},ExpressionUUID->"dd349617-9be1-4e38-ab2b-\
2d4175e866c2"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"FHMMSetPinPfin", "[", 
    RowBox[{"pinpfin", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], "}"}], ".."}], 
      "}"}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "nstates", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"nstates", "=", 
       RowBox[{"Length", "[", 
        RowBox[{"pinpfin", "[", 
         RowBox[{"[", 
          RowBox[{"1", ",", "1"}], "]"}], "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"AnyTrue", "[", 
         RowBox[{"pinpfin", ",", 
          RowBox[{
           RowBox[{
            RowBox[{"Length", "[", "#", "]"}], "\[NotEqual]", "nstates"}], 
           "&"}], ",", "2"}], "]"}], ",", 
        RowBox[{"Return", "[", "$Failed", "]"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"FHMMGlobalRates", "=", "False"}], ";", "\[IndentingNewLine]", 
      RowBox[{"Which", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"FHMMmode", "===", "FHMMBinned"}], "\[IndentingNewLine]", ",", 
        RowBox[{"FPHmmSetPinPfin", "[", 
         RowBox[{
          RowBox[{"N", "@", 
           RowBox[{"Flatten", "@", 
            RowBox[{"pinpfin", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "1"}], "]"}], "]"}]}]}], ",", 
          RowBox[{"N", "@", 
           RowBox[{"Flatten", "@", 
            RowBox[{"pinpfin", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "2"}], "]"}], "]"}]}]}], ",", 
          RowBox[{"Length", "@", 
           RowBox[{"pinpfin", "[", 
            RowBox[{"[", 
             RowBox[{"1", ",", "1"}], "]"}], "]"}]}]}], "]"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"FHMMmode", "===", "FHMMPhotonByPhoton"}], 
        "\[IndentingNewLine]", ",", 
        RowBox[{"FPMLHSetPinPfin", "[", 
         RowBox[{
          RowBox[{"N", "@", 
           RowBox[{"Flatten", "@", 
            RowBox[{"pinpfin", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "1"}], "]"}], "]"}]}]}], ",", 
          RowBox[{"N", "@", 
           RowBox[{"Flatten", "@", 
            RowBox[{"pinpfin", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "2"}], "]"}], "]"}]}]}], ",", 
          RowBox[{"Length", "@", 
           RowBox[{"pinpfin", "[", 
            RowBox[{"[", 
             RowBox[{"1", ",", "1"}], "]"}], "]"}]}]}], "]"}], ",", 
        "\[IndentingNewLine]", "True", ",", "$Failed"}], 
       "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  "\n"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FHMMSetPinPfin", "[", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"pin", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], ",", " ", 
     RowBox[{"pfin", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}]}], "}"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{"(*", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"Length", "[", "pin", "]"}], "!=", "FHMMStateCount"}], " ", 
         "||", " ", 
         RowBox[{
          RowBox[{"Length", "[", "pfin", "]"}], "!=", "FHMMStateCount"}]}], 
        ",", 
        RowBox[{"Return", "[", "$Failed", "]"}]}], "]"}], ";"}], "*)"}], 
    "\[IndentingNewLine]", 
    RowBox[{"FHMMSetPinPfin", "[", 
     RowBox[{"ConstantArray", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"pin", ",", "pfin"}], "}"}], ",", "FHMMTrajectoryCount"}], 
      "]"}], "]"}]}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   "]"}]}], "\[IndentingNewLine]"}], "Input",
 CellChangeTimes->{{3.7499847584301777`*^9, 3.7499847963729277`*^9}, {
   3.749985054632259*^9, 3.749985062665756*^9}, 3.749985108100808*^9, {
   3.749985168185115*^9, 3.749985261087639*^9}, {3.749985371306799*^9, 
   3.7499854247179956`*^9}, {3.7499855375800905`*^9, 3.749985586477364*^9}, 
   3.7501479608435717`*^9, {3.7501485228833456`*^9, 3.750148632110212*^9}, 
   3.7501498634265327`*^9, {3.7501508989217916`*^9, 3.7501509319225984`*^9}, {
   3.860148070021688*^9, 3.8601480745906086`*^9}, 
   3.8721405650731473`*^9},ExpressionUUID->"ecd71fcf-840f-4d25-b73b-\
11c2d9a98064"],

Cell[BoxData[""], "Input",
 CellChangeTimes->{{3.7501471083479934`*^9, 3.750147154727939*^9}, {
   3.750147804156641*^9, 3.7501478448129015`*^9}, {3.750149587326657*^9, 
   3.7501496251490383`*^9}, {3.7501500787774844`*^9, 
   3.7501500914695425`*^9}, {3.7501501271391487`*^9, 3.750150182314536*^9}, 
   3.750150396853924*^9},ExpressionUUID->"bf2e467c-a506-4058-98ea-\
2f225a7b3a3a"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FHMMLogLikelihood", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"FHMMpinpfin", "->", "FHMMPeqOne"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FHMMLogLikelihood", "[", 
   RowBox[{
    RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "lh", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Length", "[", "Km", "]"}], "!=", "FHMMStateCount"}], ",", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"FHMMLogLikelihood", "::", "dimerr"}], "]"}], ";", 
         RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Which", "[", 
      RowBox[{
       RowBox[{"FHMMmode", "===", "FHMMBinned"}], ",", "\[IndentingNewLine]", 
       RowBox[{"lh", "=", 
        RowBox[{"Which", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
           "FHMMPeqOne"}], "\[IndentingNewLine]", ",", 
          RowBox[{"If", "[", 
           RowBox[{"FHMMGlobalRates", ",", 
            RowBox[{"FPHmmGetLikelihoodPeqFromKrates", "[", 
             RowBox[{
              RowBox[{"FHmmBinning", "*", 
               RowBox[{"N", "@", "Km"}]}], ",", 
              RowBox[{"FHmmBinning", "*", 
               RowBox[{"N", "@", "FHMMRate"}]}]}], "]"}], ",", 
            RowBox[{"FPHmmGetLikelihoodPeqFromK", "[", 
             RowBox[{"FHmmBinning", "*", 
              RowBox[{"N", "@", "Km"}]}], "]"}]}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
           "FHMMTraceWise"}], "\[IndentingNewLine]", ",", 
          RowBox[{"FPHmmGetLikelihood", "[", 
           RowBox[{"FHmmBinning", "*", 
            RowBox[{"N", "@", "Km"}]}], "]"}], ",", "\[IndentingNewLine]", 
          "True", "\[IndentingNewLine]", ",", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"Message", "[", 
             RowBox[{"FHMMLogLikelihood", "::", "erroptval"}], "]"}], ";", 
            RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
         "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", ",", 
       RowBox[{"FHMMmode", "===", "FHMMPhotonByPhoton"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"lh", "=", 
        RowBox[{"-", "\[IndentingNewLine]", 
         RowBox[{"Which", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
            "FHMMPeqOne"}], "\[IndentingNewLine]", ",", 
           RowBox[{"If", "[", 
            RowBox[{"FHMMGlobalRates", ",", 
             RowBox[{"FPMLHGetLikelihoodPeqFromK", "[", 
              RowBox[{
               RowBox[{"N", "@", "FHMMRate"}], ",", 
               RowBox[{"N", "@", "Km"}]}], "]"}], ",", 
             RowBox[{"FPMLHGetLikelihoodPeqFromK", "[", 
              RowBox[{"N", "@", "Km"}], "]"}]}], "]"}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
            "FHMMTraceWise"}], "\[IndentingNewLine]", ",", 
           RowBox[{"If", "[", 
            RowBox[{"FHMMGlobalRates", ",", 
             RowBox[{"FPMLHGetLikelihood", "[", 
              RowBox[{
               RowBox[{"N", "@", "FHMMRate"}], ",", 
               RowBox[{"N", "@", "Km"}]}], "]"}], ",", 
             RowBox[{"FPMLHGetLikelihood", "[", 
              RowBox[{"N", "@", "Km"}], "]"}]}], "]"}], ",", 
           "\[IndentingNewLine]", "True", "\[IndentingNewLine]", ",", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"Message", "[", 
              RowBox[{"FHMMLogLikelihood", "::", "erroptval"}], "]"}], ";", 
             RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
          "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", ",", 
       "True", ",", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"FHMMLogLikelihood", "::", "noinit"}], "]"}], ";", 
         RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
      "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", "lh"}]}], 
   "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FHMMLogLikelihood", "[", 
   RowBox[{
    RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], ",", " ", 
    RowBox[{"photonrates", ":", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "FNumericMatrixQ"}], ".."}], "}"}], "|", 
      RowBox[{"_", "?", "FNumericMatrixQ"}]}]}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "lh", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"FHMMSetPhotonRates", "[", "photonrates", "]"}], "===", 
        "$Failed"}], ",", 
       RowBox[{"Return", "[", "$Failed", "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"FHMMLogLikelihood", "[", 
      RowBox[{"Km", ",", "opts"}], "]"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.749467521023334*^9, 3.749467556934556*^9}, {
   3.749467590913252*^9, 3.7494675915096474`*^9}, {3.7494681936954703`*^9, 
   3.7494682213066154`*^9}, 3.7494682554626927`*^9, {3.749529268800666*^9, 
   3.7495292719193797`*^9}, {3.7495293260097322`*^9, 3.7495293593465*^9}, {
   3.7495293903785048`*^9, 3.749529403858449*^9}, {3.749529434522078*^9, 
   3.749529435655052*^9}, {3.7495295323891997`*^9, 3.7495295855859027`*^9}, {
   3.7495296195689726`*^9, 3.7495296351703873`*^9}, 3.74952970359116*^9, {
   3.7495297632394404`*^9, 3.7495297792346463`*^9}, {3.749529828519842*^9, 
   3.749529837228266*^9}, {3.749530122952064*^9, 3.7495301951280766`*^9}, {
   3.749530505387927*^9, 3.749530519654763*^9}, {3.7495305557871227`*^9, 
   3.749530586543863*^9}, {3.7495307227864676`*^9, 3.749530753269283*^9}, {
   3.749530885149269*^9, 3.749530925975073*^9}, {3.749531133021701*^9, 
   3.7495312097185216`*^9}, {3.7495312715243855`*^9, 3.749531276779001*^9}, {
   3.749531332335064*^9, 3.749531384034936*^9}, {3.7495314295108967`*^9, 
   3.7495314589540577`*^9}, 3.749531551168411*^9, {3.7495316070469584`*^9, 
   3.7495316178580513`*^9}, {3.7495319139867163`*^9, 
   3.7495319475656977`*^9}, {3.7495324345643153`*^9, 3.7495324585231905`*^9}, 
   3.749533415585991*^9, {3.7495352784994035`*^9, 3.749535292553809*^9}, 
   3.749536428731695*^9, {3.749536879415386*^9, 3.749536880993176*^9}, {
   3.7495374022673163`*^9, 3.7495374090352182`*^9}, {3.7495481887678685`*^9, 
   3.7495482162583447`*^9}, 3.74954869938413*^9, 3.7495487390520487`*^9, {
   3.749548844666698*^9, 3.74954887240451*^9}, {3.749549039873412*^9, 
   3.74954908108419*^9}, {3.7497911227223296`*^9, 3.7497911814861617`*^9}, {
   3.74998190709044*^9, 3.749981907200118*^9}, {3.750146880567348*^9, 
   3.7501469853998375`*^9}, {3.750147036686735*^9, 3.750147088691083*^9}, {
   3.7501471886671658`*^9, 3.7501471975737696`*^9}, {3.7501472441762934`*^9, 
   3.7501472539293036`*^9}, {3.7501473287622795`*^9, 
   3.7501473349267635`*^9}, {3.7501474057809353`*^9, 
   3.7501474378424373`*^9}, {3.7501477808749104`*^9, 3.7501477925586605`*^9}, 
   3.750149000247304*^9, {3.750149916087717*^9, 3.7501499621706276`*^9}, {
   3.750149992561561*^9, 3.750150017500571*^9}, {3.7501500647691455`*^9, 
   3.7501500679459343`*^9}, {3.7501510691240573`*^9, 
   3.7501510953964014`*^9}, {3.751196023225656*^9, 3.751196032326316*^9}, {
   3.751196866791787*^9, 3.75119687813146*^9}, {3.751196916050259*^9, 
   3.7511969213384104`*^9}, 3.752920024613032*^9, 3.752920082843291*^9, {
   3.7529201513855333`*^9, 3.752920193843111*^9}, {3.7748612597056675`*^9, 
   3.774861286193861*^9}, {3.7748613375555716`*^9, 3.774861401434822*^9}, 
   3.774862028222232*^9, {3.774862121425132*^9, 3.7748621369266605`*^9}, 
   3.7748621810616827`*^9, {3.777354110027478*^9, 3.777354129573213*^9}, 
   3.7773560071914988`*^9, {3.7776275129195604`*^9, 3.777627535472556*^9}, {
   3.77762761030441*^9, 3.777627668944504*^9}, {3.777627791510722*^9, 
   3.7776278010072613`*^9}, {3.7776278799271708`*^9, 
   3.7776278870720572`*^9}, {3.7776303318062525`*^9, 3.777630342161518*^9}, {
   3.7783098368023415`*^9, 3.7783098414419394`*^9}, {3.778320849375602*^9, 
   3.778320881293219*^9}, {3.778320983052799*^9, 3.7783209882638683`*^9}, {
   3.860148020838842*^9, 3.8601480254770365`*^9}, {3.8721434263670845`*^9, 
   3.8721434633996696`*^9}, {3.8721439850063505`*^9, 
   3.8721440037460337`*^9}, {3.8721443138933477`*^9, 3.872144316323046*^9}, {
   3.872144672482723*^9, 
   3.8721446961930504`*^9}},ExpressionUUID->"5a37ddc1-3e1a-4b1a-a8b4-\
83750398d014"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FHMMGetLogLikelihoodList", "[", "]"}], ":=", " ", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{"Which", "[", 
     RowBox[{
      RowBox[{"FHMMmode", "===", "FHMMBinned"}], ",", "\[IndentingNewLine]", 
      RowBox[{"FPHmmGetLikelihoodList", "[", "]"}], "\[IndentingNewLine]", 
      ",", 
      RowBox[{"FHMMmode", "===", "FHMMPhotonByPhoton"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"FPMLHGetLikelihoodList", "[", "]"}], "\[IndentingNewLine]", 
      ",", "True", ",", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"Message", "[", 
         RowBox[{"FHMMLogLikelihood", "::", "noinit"}], "]"}], ";", 
        RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
     "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{
  3.8463021912418127`*^9, {3.846302268172823*^9, 3.846302319457017*^9}, 
   3.846302363237991*^9},ExpressionUUID->"b3957040-b8ab-4356-80a9-\
5f0affe6b105"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FHMMTransitionStatesLogLikelihoods", "[", "expr___", "]"}], ":=", 
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{"FHMMmode", "===", "FHMMPhotonByPhoton"}], ",", 
    RowBox[{"FMLHTransitionStatesGetLikelihoods", "[", "expr", "]"}], ",", 
    "$Failed"}], "]"}]}]], "Input",
 CellChangeTimes->{{3.7499868855054502`*^9, 3.7499869467007275`*^9}, {
  3.7499869771203814`*^9, 
  3.7499870247919683`*^9}},ExpressionUUID->"2300abb0-5b86-43b7-9705-\
e1713c944e4a"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"BinnedViterbiPeqFromK", "[", 
   RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "tr", "}"}], ",", 
    RowBox[{"tr", "=", 
     RowBox[{
      RowBox[{"FPHmmViterbiPeqFromK", "[", 
       RowBox[{"FHmmBinning", "*", 
        RowBox[{"N", "@", "Km"}]}], "]"}], "/.", 
      RowBox[{
       RowBox[{"FDwell", "[", 
        RowBox[{"t_", ",", "s_", ",", "dt_", ",", "p___"}], "]"}], ":>", 
       RowBox[{"FDwell", "[", 
        RowBox[{
         RowBox[{"FHmmBinning", "*", "t"}], ",", "s", ",", 
         RowBox[{"FHmmBinning", "*", "dt"}], ",", "p"}], "]"}]}]}]}]}], 
   "]"}]}], "\n", 
 RowBox[{
  RowBox[{"BinnedViterbi", "[", 
   RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "tr", "}"}], ",", 
    RowBox[{"tr", "=", 
     RowBox[{
      RowBox[{"FPHmmViterbi", "[", 
       RowBox[{"FHmmBinning", "*", 
        RowBox[{"N", "@", "Km"}]}], "]"}], "/.", 
      RowBox[{
       RowBox[{"FDwell", "[", 
        RowBox[{"t_", ",", "s_", ",", "dt_", ",", "p___"}], "]"}], ":>", 
       RowBox[{"FDwell", "[", 
        RowBox[{
         RowBox[{"FHmmBinning", "*", "t"}], ",", "s", ",", 
         RowBox[{"FHmmBinning", "*", "dt"}], ",", "p"}], "]"}]}]}]}]}], 
   "]"}]}], "\n"}], "Input",
 CellChangeTimes->{{3.752920394857087*^9, 3.752920408164277*^9}, {
  3.778321109325886*^9, 
  3.778321122562501*^9}},ExpressionUUID->"91b8ef68-ee25-4041-be8d-\
633e29a497a7"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FHMMViterbi", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"FHMMpinpfin", "->", "FHMMPeqOne"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FHMMViterbi", "[", 
   RowBox[{
    RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "statetrajectory", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Length", "[", "Km", "]"}], "!=", "FHMMStateCount"}], ",", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"FHMMViterbi", "::", "dimerr"}], "]"}], ";", 
         RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Which", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"FHMMmode", "===", "FHMMBinned"}], "\[IndentingNewLine]", ",", 
       RowBox[{"statetrajectory", "=", "\[IndentingNewLine]", 
        RowBox[{"Which", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
           "FHMMPeqOne"}], "\[IndentingNewLine]", ",", 
          RowBox[{"If", "[", 
           RowBox[{"FHMMGlobalRates", ",", 
            RowBox[{"BinnedViterbiPeqFromK", "[", "Km", "]"}], ",", 
            RowBox[{"BinnedViterbiPeqFromK", "[", "Km", "]"}]}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
           "FHMMTraceWise"}], "\[IndentingNewLine]", ",", 
          RowBox[{"BinnedViterbi", "[", "Km", "]"}], ",", 
          "\[IndentingNewLine]", "True", "\[IndentingNewLine]", ",", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"Message", "[", 
             RowBox[{"FHMMViterbi", "::", "erroptval"}], "]"}], ";", 
            RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
         "\[IndentingNewLine]", "]"}]}], ",", "\[IndentingNewLine]", 
       RowBox[{"FHMMmode", "===", "FHMMPhotonByPhoton"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"statetrajectory", "=", "\[IndentingNewLine]", 
        RowBox[{"Which", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
           "FHMMPeqOne"}], "\[IndentingNewLine]", ",", 
          RowBox[{"FPMLHViterbiPeqFromK", "[", 
           RowBox[{"N", "@", "Km"}], "]"}], ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
           "FHMMTraceWise"}], "\[IndentingNewLine]", ",", 
          RowBox[{"FPMLHViterbi", "[", 
           RowBox[{"N", "@", "Km"}], "]"}], ",", "\[IndentingNewLine]", 
          "True", "\[IndentingNewLine]", ",", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"Message", "[", 
             RowBox[{"FHMMViterbi", "::", "erroptval"}], "]"}], ";", 
            RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
         "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", ",", "True", 
       ",", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"FHMMViterbi", "::", "noinit"}], "]"}], ";", 
         RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
      "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
     "statetrajectory"}]}], "\[IndentingNewLine]", 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FHMMViterbi", "[", 
   RowBox[{
    RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], ",", " ", "photonrates_", 
    ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "lh", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"FHMMSetPhotonRates", "[", "photonrates", "]"}], "===", 
        "$Failed"}], ",", 
       RowBox[{"Return", "[", "$Failed", "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"FHMMViterbi", "[", "Km", "]"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.749467521023334*^9, 3.749467556934556*^9}, {
   3.749467590913252*^9, 3.7494675915096474`*^9}, {3.7494681936954703`*^9, 
   3.7494682213066154`*^9}, 3.7494682554626927`*^9, {3.749529268800666*^9, 
   3.7495292719193797`*^9}, {3.7495293260097322`*^9, 3.7495293593465*^9}, {
   3.7495293903785048`*^9, 3.749529403858449*^9}, {3.749529434522078*^9, 
   3.749529435655052*^9}, {3.7495295323891997`*^9, 3.7495295855859027`*^9}, {
   3.7495296195689726`*^9, 3.7495296351703873`*^9}, 3.74952970359116*^9, {
   3.7495297632394404`*^9, 3.7495297792346463`*^9}, {3.749529828519842*^9, 
   3.749529837228266*^9}, {3.749530122952064*^9, 3.7495301951280766`*^9}, {
   3.749530505387927*^9, 3.749530519654763*^9}, {3.7495305557871227`*^9, 
   3.749530586543863*^9}, {3.7495307227864676`*^9, 3.749530753269283*^9}, {
   3.749530885149269*^9, 3.749530925975073*^9}, {3.749531133021701*^9, 
   3.7495312097185216`*^9}, {3.7495312715243855`*^9, 3.749531276779001*^9}, {
   3.749531332335064*^9, 3.749531384034936*^9}, {3.7495314295108967`*^9, 
   3.7495314589540577`*^9}, 3.749531551168411*^9, {3.7495316070469584`*^9, 
   3.7495316178580513`*^9}, {3.7495319139867163`*^9, 
   3.7495319475656977`*^9}, {3.7495324345643153`*^9, 3.7495324585231905`*^9}, 
   3.749533415585991*^9, {3.7495352784994035`*^9, 3.749535292553809*^9}, 
   3.749536428731695*^9, {3.749536879415386*^9, 3.749536880993176*^9}, {
   3.749536922761497*^9, 3.7495369314103165`*^9}, 3.7495370533671722`*^9, 
   3.7495371182893276`*^9, {3.749537231776632*^9, 3.7495372592348585`*^9}, {
   3.749537333768547*^9, 3.74953739237178*^9}, {3.74954910520767*^9, 
   3.7495491150663023`*^9}, {3.749791241417869*^9, 3.749791282805175*^9}, {
   3.7499819072061048`*^9, 3.7499819072789097`*^9}, {3.7501488626685553`*^9, 
   3.750148936013038*^9}, {3.750149024512638*^9, 3.750149113678056*^9}, {
   3.7501491691338305`*^9, 3.7501492309135566`*^9}, {3.7501493038348193`*^9, 
   3.750149323812806*^9}, 3.7501493671622295`*^9, {3.7501494011281652`*^9, 
   3.7501494248627205`*^9}, 3.750149507116145*^9, {3.7501502008580713`*^9, 
   3.750150214569867*^9}, {3.7529204436743245`*^9, 3.752920452052907*^9}, {
   3.7529295350295134`*^9, 3.7529295470896187`*^9}, 3.754209490016601*^9, 
   3.761050895677702*^9, 3.774862299711108*^9, 3.7748623318681607`*^9, {
   3.777627905775033*^9, 3.7776279249487505`*^9}, {3.7783211549549103`*^9, 
   3.778321170275964*^9}, 
   3.787990722627548*^9},ExpressionUUID->"04f8c69e-5b99-4920-8bec-\
2c9d2aebd2f6"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FHMMForwardBackward", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"FHMMpinpfin", "->", "FHMMPeqOne"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FHMMForwardBackward", "[", 
   RowBox[{
    RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "statetrajectory", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Length", "[", "Km", "]"}], "!=", "FHMMStateCount"}], ",", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"FHMMViterbi", "::", "dimerr"}], "]"}], ";", 
         RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Which", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"FHMMmode", "===", "FHMMBinned"}], "\[IndentingNewLine]", ",", 
       RowBox[{"statetrajectory", "=", "\[IndentingNewLine]", 
        RowBox[{"Which", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
           "FHMMPeqOne"}], "\[IndentingNewLine]", ",", 
          RowBox[{"If", "[", 
           RowBox[{"FHMMGlobalRates", ",", "$False", ",", 
            RowBox[{"FPHmmForwardBackwardPeqFromK", "[", 
             RowBox[{"FHmmBinning", "*", 
              RowBox[{"N", "@", "Km"}]}], "]"}]}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
           "FHMMTraceWise"}], "\[IndentingNewLine]", ",", 
          RowBox[{"FPHmmForwardBackward", "[", 
           RowBox[{"FHmmBinning", "*", 
            RowBox[{"N", "@", "Km"}]}], "]"}], ",", "\[IndentingNewLine]", 
          "True", "\[IndentingNewLine]", ",", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"Message", "[", 
             RowBox[{"FHMMViterbi", "::", "erroptval"}], "]"}], ";", 
            RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
         "\[IndentingNewLine]", "]"}]}], ",", "\[IndentingNewLine]", 
       RowBox[{"FHMMmode", "===", "FHMMPhotonByPhoton"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"statetrajectory", "=", "\[IndentingNewLine]", 
        RowBox[{"Which", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
           "FHMMPeqOne"}], "\[IndentingNewLine]", ",", 
          RowBox[{"FPMLHForwardBackwardiPeqFromK", "[", 
           RowBox[{"N", "@", "Km"}], "]"}], ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
           "FHMMTraceWise"}], "\[IndentingNewLine]", ",", 
          RowBox[{"FPMLHForwardBackward", "[", 
           RowBox[{"N", "@", "Km"}], "]"}], ",", "\[IndentingNewLine]", 
          "True", "\[IndentingNewLine]", ",", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"Message", "[", 
             RowBox[{"FHMMViterbi", "::", "erroptval"}], "]"}], ";", 
            RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
         "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", ",", "True", 
       ",", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"FHMMViterbi", "::", "noinit"}], "]"}], ";", 
         RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
      "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
     "statetrajectory"}]}], "\[IndentingNewLine]", 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FHMMForwardBackward", "[", 
   RowBox[{
    RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], ",", " ", "photonrates_", 
    ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "lh", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"FHMMSetPhotonRates", "[", "photonrates", "]"}], "===", 
        "$Failed"}], ",", 
       RowBox[{"Return", "[", "$Failed", "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"FHMMForwardBackward", "[", "Km", "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->{{3.749467521023334*^9, 3.749467556934556*^9}, {
   3.749467590913252*^9, 3.7494675915096474`*^9}, {3.7494681936954703`*^9, 
   3.7494682213066154`*^9}, 3.7494682554626927`*^9, {3.749529268800666*^9, 
   3.7495292719193797`*^9}, {3.7495293260097322`*^9, 3.7495293593465*^9}, {
   3.7495293903785048`*^9, 3.749529403858449*^9}, {3.749529434522078*^9, 
   3.749529435655052*^9}, {3.7495295323891997`*^9, 3.7495295855859027`*^9}, {
   3.7495296195689726`*^9, 3.7495296351703873`*^9}, 3.74952970359116*^9, {
   3.7495297632394404`*^9, 3.7495297792346463`*^9}, {3.749529828519842*^9, 
   3.749529837228266*^9}, {3.749530122952064*^9, 3.7495301951280766`*^9}, {
   3.749530505387927*^9, 3.749530519654763*^9}, {3.7495305557871227`*^9, 
   3.749530586543863*^9}, {3.7495307227864676`*^9, 3.749530753269283*^9}, {
   3.749530885149269*^9, 3.749530925975073*^9}, {3.749531133021701*^9, 
   3.7495312097185216`*^9}, {3.7495312715243855`*^9, 3.749531276779001*^9}, {
   3.749531332335064*^9, 3.749531384034936*^9}, {3.7495314295108967`*^9, 
   3.7495314589540577`*^9}, 3.749531551168411*^9, {3.7495316070469584`*^9, 
   3.7495316178580513`*^9}, {3.7495319139867163`*^9, 
   3.7495319475656977`*^9}, {3.7495324345643153`*^9, 3.7495324585231905`*^9}, 
   3.749533415585991*^9, {3.7495352784994035`*^9, 3.749535292553809*^9}, 
   3.749536428731695*^9, {3.749536879415386*^9, 3.749536880993176*^9}, {
   3.749536922761497*^9, 3.7495369314103165`*^9}, 3.7495370533671722`*^9, 
   3.7495371182893276`*^9, {3.749537231776632*^9, 3.7495372592348585`*^9}, {
   3.749537333768547*^9, 3.74953739237178*^9}, {3.74954910520767*^9, 
   3.7495491150663023`*^9}, {3.749791241417869*^9, 3.749791282805175*^9}, {
   3.7499819072061048`*^9, 3.7499819072789097`*^9}, {3.7501488626685553`*^9, 
   3.750148936013038*^9}, {3.750149024512638*^9, 3.750149113678056*^9}, {
   3.7501491691338305`*^9, 3.7501492309135566`*^9}, {3.7501493038348193`*^9, 
   3.750149323812806*^9}, 3.7501493671622295`*^9, {3.7501494011281652`*^9, 
   3.7501494248627205`*^9}, 3.750149507116145*^9, {3.7501502008580713`*^9, 
   3.750150214569867*^9}, {3.7529204436743245`*^9, 3.752920452052907*^9}, {
   3.7529295350295134`*^9, 3.7529295470896187`*^9}, 3.754209490016601*^9, {
   3.761050645481476*^9, 3.761050696968856*^9}, 3.7610509210927677`*^9, {
   3.761050968923918*^9, 3.7610510205668745`*^9}, {3.7610511911738443`*^9, 
   3.7610512000501204`*^9}, {3.7783211906275473`*^9, 3.778321231893262*^9}, 
   3.8503793589610167`*^9},ExpressionUUID->"24e6c68e-a39e-4b19-8edb-\
46aa3569d323"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FHMMSimulatePhotonByPhotonTrace", "[", 
   RowBox[{
    RowBox[{"photonrates_", "?", "FNumericMatrixQ"}], ",", 
    RowBox[{"stateTraj", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumericQ"}], " ", ",", 
         RowBox[{"_", "?", "NumericQ"}]}], " ", "}"}], ".."}], "}"}]}]}], 
   "]"}], ":=", 
  RowBox[{"Module", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{"distL", ",", 
      RowBox[{"kL", "=", 
       RowBox[{"Total", "[", "photonrates", "]"}]}], " ", ",", "choiceL", ",",
       "state", ",", 
      RowBox[{"photonTraj", "=", 
       RowBox[{"{", "}"}]}], ",", "ft", ",", "t", ",", "dt", ",", "lt", ",", 
      "color", ",", "channelcount"}], "\[IndentingNewLine]", " ", "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"channelcount", "=", 
      RowBox[{"Length", "[", "photonrates", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"distL", "=", 
      RowBox[{"Map", "[", 
       RowBox[{"ExponentialDistribution", ",", "kL"}], "]"}]}], ";", " ", 
     RowBox[{"(*", " ", 
      RowBox[{"distributions", " ", "of", " ", "escape", " ", "times"}], 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{"choiceL", "=", 
      RowBox[{"photonrates", "\[Transpose]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"photonTraj", "=", 
      RowBox[{"First", "@", 
       RowBox[{"Last", "@", 
        RowBox[{"Reap", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"lt", "=", 
           RowBox[{"stateTraj", "[", 
            RowBox[{"[", 
             RowBox[{"1", ",", "1"}], "]"}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"Do", "[", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"state", "=", 
              RowBox[{"stateTraj", "[", 
               RowBox[{"[", 
                RowBox[{"itr", ",", "2"}], "]"}], "]"}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"dt", "=", 
              RowBox[{"RandomVariate", "[", 
               RowBox[{"distL", "[", 
                RowBox[{"[", "state", "]"}], "]"}], "]"}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"t", "=", 
              RowBox[{
               RowBox[{"stateTraj", "[", 
                RowBox[{"[", 
                 RowBox[{"itr", ",", "1"}], "]"}], "]"}], "+", "dt"}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"dt", "=", 
              RowBox[{
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"stateTraj", "[", 
                  RowBox[{"[", 
                   RowBox[{"itr", ",", "1"}], "]"}], "]"}], "-", "lt"}], 
                ")"}], "+", "dt"}]}], ";", "\[IndentingNewLine]", 
             RowBox[{"ft", "=", 
              RowBox[{"stateTraj", "[", 
               RowBox[{"[", 
                RowBox[{
                 RowBox[{"itr", "+", "1"}], ",", "1"}], "]"}], "]"}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"While", "[", 
              RowBox[{
               RowBox[{"t", "<", "ft"}], ",", "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{"color", "=", 
                 RowBox[{"RandomChoice", "[", 
                  RowBox[{
                   RowBox[{"choiceL", "[", 
                    RowBox[{"[", "state", "]"}], "]"}], "\[Rule]", 
                   RowBox[{"Range", "[", "channelcount", "]"}]}], "]"}]}], 
                ";", "\[IndentingNewLine]", 
                RowBox[{"Sow", "[", 
                 RowBox[{"{", 
                  RowBox[{"dt", ",", "color"}], "}"}], "]"}], ";", 
                "\[IndentingNewLine]", 
                RowBox[{"lt", "=", "t"}], ";", "\[IndentingNewLine]", 
                RowBox[{"dt", "=", 
                 RowBox[{"RandomVariate", "[", 
                  RowBox[{"distL", "[", 
                   RowBox[{"[", "state", "]"}], "]"}], "]"}]}], ";", 
                "\[IndentingNewLine]", 
                RowBox[{"t", "+=", "dt"}], ";"}]}], "\[IndentingNewLine]", 
              "]"}], ";"}], "\[IndentingNewLine]", ",", 
            RowBox[{"{", 
             RowBox[{"itr", ",", "1", ",", 
              RowBox[{
               RowBox[{"Length", "[", "stateTraj", "]"}], "-", "1"}]}], 
             "}"}]}], "\[IndentingNewLine]", "]"}], ";"}], 
         "\[IndentingNewLine]", "]"}]}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"{", 
      RowBox[{"photonTraj", ",", "stateTraj"}], "}"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.542362527938327*^9, 3.542362555544087*^9}, {
   3.542362588366369*^9, 3.5423626539139233`*^9}, {3.542362731732704*^9, 
   3.542362733140845*^9}, 3.542362796630193*^9, {3.54236284930146*^9, 
   3.5423628851010394`*^9}, {3.5423633222457495`*^9, 
   3.5423634711206355`*^9}, {3.5423635364181643`*^9, 
   3.5423636163751593`*^9}, {3.5423636547359953`*^9, 3.542363661343656*^9}, 
   3.542363789627483*^9, {3.542363842723792*^9, 3.542363884467966*^9}, 
   3.5423641900825243`*^9, {3.54236454137465*^9, 3.542364547624275*^9}, {
   3.5423646501845303`*^9, 3.5423646927847896`*^9}, 3.542364835863096*^9, {
   3.5423648883413434`*^9, 3.542364961653674*^9}, {3.542365050376545*^9, 
   3.5423650581793256`*^9}, {3.5423651196764746`*^9, 3.542365155655072*^9}, {
   3.5423652120937157`*^9, 3.5423652495214577`*^9}, {3.542365334992004*^9, 
   3.542365340027508*^9}, {3.542365479913495*^9, 3.542365563895892*^9}, 
   3.542365594795982*^9, {3.5423656325867605`*^9, 3.5423656787013717`*^9}, {
   3.5423657148949904`*^9, 3.542365761664667*^9}, {3.5423659054850473`*^9, 
   3.5423659060551043`*^9}, {3.5423659463451333`*^9, 3.542365970785577*^9}, {
   3.5423660075432525`*^9, 3.5423660081633143`*^9}, {3.5423660417706747`*^9, 
   3.5423660557270703`*^9}, {3.5423661227297697`*^9, 
   3.5423661278972864`*^9}, {3.542366214878984*^9, 3.542366297618257*^9}, {
   3.5423664277962737`*^9, 3.5423664643679304`*^9}, {3.5423665951420064`*^9, 
   3.542366626509143*^9}, {3.5424328816239967`*^9, 3.542432910729907*^9}, 
   3.544271951742566*^9, {3.5442741053291893`*^9, 3.544274139697091*^9}, {
   3.5442743560292244`*^9, 3.5442743615206003`*^9}, {3.5442748029211473`*^9, 
   3.544274878879982*^9}, {3.544275157713477*^9, 3.5442751826898775`*^9}, {
   3.544276020299574*^9, 3.5442760205325966`*^9}, {3.5442763472122617`*^9, 
   3.5442763484723873`*^9}, {3.5442764951759872`*^9, 3.5442764998873386`*^9}, 
   3.551611446728836*^9, {3.5529795495226583`*^9, 3.5529796042363987`*^9}, {
   3.5529797459907312`*^9, 3.5529798294621696`*^9}, {3.5529798874758825`*^9, 
   3.552979971962165*^9}, 3.552980067041255*^9, {3.552980387135404*^9, 
   3.552980393510975*^9}, 3.5529804552830396`*^9, {3.5529805551310863`*^9, 
   3.5529805697248487`*^9}, 3.552980627068468*^9, {3.5529809695302505`*^9, 
   3.5529809733238697`*^9}, {3.552981019428948*^9, 3.5529811544269342`*^9}, {
   3.552981192310916*^9, 3.5529811930193496`*^9}, {3.5529812245407476`*^9, 
   3.552981225251211*^9}, {3.5529812579712124`*^9, 3.5529812585662203`*^9}, {
   3.5529813124840517`*^9, 3.552981437903535*^9}, {3.5529920486356516`*^9, 
   3.552992360736583*^9}, {3.552992440328901*^9, 3.552992444738927*^9}, 
   3.5529942380657005`*^9, 3.5529943059562144`*^9, {3.604401110888466*^9, 
   3.604401196893471*^9}, 3.6977930773972535`*^9, 3.710676438878685*^9, {
   3.7106773213592854`*^9, 3.710677374368085*^9}, {3.7106775319436855`*^9, 
   3.710677553892885*^9}, {3.710677833159685*^9, 3.710677845748885*^9}, {
   3.7106782944894853`*^9, 3.710678317062685*^9}, {3.7106783523186855`*^9, 
   3.7106783549394855`*^9}, {3.710678858304685*^9, 3.710678890035085*^9}, {
   3.710679014710285*^9, 3.7106790175182853`*^9}, 3.7492128789938784`*^9, {
   3.749212909744645*^9, 3.7492129229283824`*^9}, {3.7492130163185596`*^9, 
   3.749213055893755*^9}, {3.7492131142675934`*^9, 3.7492131551133833`*^9}, {
   3.749213189127409*^9, 3.7492132238146353`*^9}, {3.749213306613185*^9, 
   3.7492133309251127`*^9}, {3.749213384809041*^9, 3.7492133861962857`*^9}, 
   3.7492138229302*^9, 3.7492144583617287`*^9, {3.7492806283105736`*^9, 
   3.749280629292943*^9}, 3.7492807481829696`*^9, {3.749554962834201*^9, 
   3.7495549718690796`*^9}, {3.749555429920493*^9, 3.7495554307931123`*^9}, {
   3.749557239527176*^9, 3.749557244280463*^9}, {3.7495573162135315`*^9, 
   3.749557319012081*^9}, 3.7499819072869143`*^9, 
   3.8142721496820717`*^9},ExpressionUUID->"f630026c-17c6-4da3-ba94-\
492c4961b0c4"],

Cell[BoxData[
 RowBox[{"(*", "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"FHMMSimulatePhotonByPhotonTrace", "[", 
    RowBox[{
     RowBox[{"photonrates", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], "}"}]}], ",", 
     RowBox[{"kMatrix_", "?", "FNumericSquareMatrixQ"}], ",", 
     RowBox[{"pini", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], ",", "t_"}], "]"}], ":=", 
   RowBox[{"Module", "[", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"channelcount", ",", "statecount", ",", 
       RowBox[{"it", "=", "0"}], ",", "transition", ",", 
       "\[IndentingNewLine]", "distL", ",", 
       RowBox[{"kL", "=", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"Diagonal", "[", "kMatrix", "]"}]}], "+", 
         RowBox[{"Total", "[", "photonrates", "]"}]}]}], " ", ",", "choiceL", 
       ",", "state", ",", 
       RowBox[{"photonTraj", "=", 
        RowBox[{"{", "}"}]}], ",", "stateTraj", ",", "peqL", ",", 
       RowBox[{"tau", "=", "0"}], ",", "dt"}], "\[IndentingNewLine]", " ", 
      "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"channelcount", "=", 
       RowBox[{"Length", "[", "photonrates", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"statecount", "=", 
       RowBox[{"Length", "[", "pini", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"distL", "=", 
       RowBox[{"Map", "[", 
        RowBox[{"ExponentialDistribution", ",", "kL"}], "]"}]}], ";", " ", 
      RowBox[{"(*", " ", 
       RowBox[{"distributions", " ", "of", " ", "escape", " ", "times"}], 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{"choiceL", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Join", "[", 
           RowBox[{
            RowBox[{"photonrates", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "ns"}], "]"}], "]"}], ",", 
            RowBox[{"kMatrix", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "ns"}], "]"}], "]"}]}], "]"}], "/.", 
          RowBox[{
           RowBox[{"x_", "/;", 
            RowBox[{"x", "<", "0"}]}], "\[Rule]", "0"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"ns", ",", "1", ",", 
           RowBox[{"Length", "[", "pini", "]"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"state", "=", 
       RowBox[{"RandomChoice", "[", 
        RowBox[{"pini", "\[Rule]", 
         RowBox[{"Range", "[", 
          RowBox[{"Length", "[", "pini", "]"}], "]"}]}], "]"}]}], ";", 
      RowBox[{"(*", " ", 
       RowBox[{"set", " ", "initial", " ", "state", " ", "values"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"stateTraj", "=", 
       RowBox[{"{", 
        RowBox[{"{", 
         RowBox[{"0", ",", "state"}], "}"}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"it", "=", 
       RowBox[{"tau", "=", 
        RowBox[{"RandomVariate", "[", 
         RowBox[{"distL", "[", 
          RowBox[{"[", "state", "]"}], "]"}], "]"}]}]}], ";", 
      RowBox[{"(*", " ", 
       RowBox[{
       "time", " ", "of", " ", "the", " ", "first", " ", "transition"}], 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{"photonTraj", "=", 
       RowBox[{"First", "@", 
        RowBox[{"Last", "@", 
         RowBox[{"Reap", "[", "\[IndentingNewLine]", 
          RowBox[{"While", "[", 
           RowBox[{
            RowBox[{"it", "<", "t"}], ",", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"transition", "=", 
              RowBox[{"RandomChoice", "[", 
               RowBox[{
                RowBox[{"choiceL", "[", 
                 RowBox[{"[", "state", "]"}], "]"}], "\[Rule]", 
                RowBox[{"Range", "[", 
                 RowBox[{"channelcount", "+", "statecount"}], "]"}]}], 
               "]"}]}], ";", "\[IndentingNewLine]", 
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{"transition", "\[LessEqual]", "channelcount"}], 
               "\[IndentingNewLine]", ",", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"Sow", "[", 
                  RowBox[{"{", 
                   RowBox[{"tau", ",", "transition"}], "}"}], "]"}], ";", 
                 RowBox[{"tau", "=", "0"}]}], ")"}], "\[IndentingNewLine]", 
               ",", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"state", "=", 
                  RowBox[{"transition", "-", "channelcount"}]}], ";", 
                 RowBox[{"(*", 
                  RowBox[{"AppendTo", "[", 
                   RowBox[{"stateTraj", ",", 
                    RowBox[{"{", 
                    RowBox[{"it", ",", 
                    RowBox[{"stateTraj", "[", 
                    RowBox[{"[", 
                    RowBox[{
                    RowBox[{"-", "1"}], ",", "2"}], "]"}], "]"}]}], "}"}]}], 
                   "]"}], "*)"}], ";", 
                 RowBox[{"AppendTo", "[", 
                  RowBox[{"stateTraj", ",", 
                   RowBox[{"{", 
                    RowBox[{"it", ",", "state"}], "}"}]}], "]"}]}], ")"}]}], 
              "]"}], ";", "\[IndentingNewLine]", 
             RowBox[{"dt", "=", 
              RowBox[{"RandomVariate", "[", 
               RowBox[{"distL", "[", 
                RowBox[{"[", "state", "]"}], "]"}], "]"}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"tau", "+=", "dt"}], ";", "\[IndentingNewLine]", 
             RowBox[{"it", "+=", "dt"}], ";"}]}], "\[IndentingNewLine]", 
           "]"}], "\[IndentingNewLine]", "]"}]}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"AppendTo", "[", 
       RowBox[{"stateTraj", ",", 
        RowBox[{"{", 
         RowBox[{"it", ",", "state"}], "}"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"{", 
       RowBox[{"photonTraj", ",", "stateTraj"}], "}"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", "*)"}]], "Input",
 CellChangeTimes->{{3.542362527938327*^9, 3.542362555544087*^9}, {
   3.542362588366369*^9, 3.5423626539139233`*^9}, {3.542362731732704*^9, 
   3.542362733140845*^9}, 3.542362796630193*^9, {3.54236284930146*^9, 
   3.5423628851010394`*^9}, {3.5423633222457495`*^9, 
   3.5423634711206355`*^9}, {3.5423635364181643`*^9, 
   3.5423636163751593`*^9}, {3.5423636547359953`*^9, 3.542363661343656*^9}, 
   3.542363789627483*^9, {3.542363842723792*^9, 3.542363884467966*^9}, 
   3.5423641900825243`*^9, {3.54236454137465*^9, 3.542364547624275*^9}, {
   3.5423646501845303`*^9, 3.5423646927847896`*^9}, 3.542364835863096*^9, {
   3.5423648883413434`*^9, 3.542364961653674*^9}, {3.542365050376545*^9, 
   3.5423650581793256`*^9}, {3.5423651196764746`*^9, 3.542365155655072*^9}, {
   3.5423652120937157`*^9, 3.5423652495214577`*^9}, {3.542365334992004*^9, 
   3.542365340027508*^9}, {3.542365479913495*^9, 3.542365563895892*^9}, 
   3.542365594795982*^9, {3.5423656325867605`*^9, 3.5423656787013717`*^9}, {
   3.5423657148949904`*^9, 3.542365761664667*^9}, {3.5423659054850473`*^9, 
   3.5423659060551043`*^9}, {3.5423659463451333`*^9, 3.542365970785577*^9}, {
   3.5423660075432525`*^9, 3.5423660081633143`*^9}, {3.5423660417706747`*^9, 
   3.5423660557270703`*^9}, {3.5423661227297697`*^9, 
   3.5423661278972864`*^9}, {3.542366214878984*^9, 3.542366297618257*^9}, {
   3.5423664277962737`*^9, 3.5423664643679304`*^9}, {3.5423665951420064`*^9, 
   3.542366626509143*^9}, {3.5424328816239967`*^9, 3.542432910729907*^9}, 
   3.544271951742566*^9, {3.5442741053291893`*^9, 3.544274139697091*^9}, {
   3.5442743560292244`*^9, 3.5442743615206003`*^9}, {3.5442748029211473`*^9, 
   3.544274878879982*^9}, {3.544275157713477*^9, 3.5442751826898775`*^9}, {
   3.544276020299574*^9, 3.5442760205325966`*^9}, {3.5442763472122617`*^9, 
   3.5442763484723873`*^9}, {3.5442764951759872`*^9, 3.5442764998873386`*^9}, 
   3.551611446728836*^9, {3.552994196242507*^9, 3.5529942000559344`*^9}, {
   3.552994743713354*^9, 3.5529947485728273`*^9}, 3.6043999539940023`*^9, {
   3.6043999866768403`*^9, 3.604400022682564*^9}, {3.6044000544137774`*^9, 
   3.604400097283676*^9}, 3.69779308148448*^9, {3.74921336750727*^9, 
   3.7492135230861716`*^9}, {3.7492135835863934`*^9, 
   3.7492136473926907`*^9}, {3.749213873916881*^9, 3.7492139788860903`*^9}, 
   3.7492140395309286`*^9, {3.7492166100719585`*^9, 3.7492166109226904`*^9}, {
   3.7492806670489697`*^9, 3.7492806679306016`*^9}, {3.749280759564573*^9, 
   3.7492807602587156`*^9}, 3.7495549834600425`*^9, {3.7495554143740263`*^9, 
   3.749555417060887*^9}, {3.7495566160456495`*^9, 3.7495566503495426`*^9}, 
   3.7499819072948933`*^9, {3.754049819744254*^9, 
   3.7540498265760517`*^9}},ExpressionUUID->"be00b588-c46c-4ba7-8dc0-\
a91e5bf2ed0a"],

Cell[BoxData[
 RowBox[{"\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"FHMMSimulatePhotonByPhotonTrace", "[", 
    RowBox[{
     RowBox[{"photonrates_", "?", "FNumericMatrixQ"}], ",", 
     RowBox[{"kMatrix_", "?", "FNumericSquareMatrixQ"}], ",", 
     RowBox[{"pini", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], ",", "t_"}], "]"}], ":=", 
   RowBox[{"Module", "[", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"FPSimulatePhotonTrace", "[", 
       RowBox[{
        RowBox[{"N", "@", 
         RowBox[{"Flatten", "@", "kMatrix"}]}], ",", 
        RowBox[{"N", "@", 
         RowBox[{"photonrates", "[", 
          RowBox[{"[", "1", "]"}], "]"}]}], ",", 
        RowBox[{"N", "@", 
         RowBox[{"photonrates", "[", 
          RowBox[{"[", "2", "]"}], "]"}]}], ",", 
        RowBox[{"N", "@", "pini"}], ",", 
        RowBox[{"N", "@", "t"}], ",", "0", ",", "0."}], "]"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"FPSimulatePhotonTrace2", "[", 
      RowBox[{
       RowBox[{"N", "@", "t"}], ",", "0", ",", "0.", ",", 
       RowBox[{"N", "@", "kMatrix"}], ",", 
       RowBox[{"N", "@", "pini"}], ",", 
       RowBox[{"N", "@", "photonrates"}]}], "]"}]}], "\[IndentingNewLine]", 
    "]"}]}]}]], "Input",
 CellChangeTimes->{{3.542362527938327*^9, 3.542362555544087*^9}, {
   3.542362588366369*^9, 3.5423626539139233`*^9}, {3.542362731732704*^9, 
   3.542362733140845*^9}, 3.542362796630193*^9, {3.54236284930146*^9, 
   3.5423628851010394`*^9}, {3.5423633222457495`*^9, 
   3.5423634711206355`*^9}, {3.5423635364181643`*^9, 
   3.5423636163751593`*^9}, {3.5423636547359953`*^9, 3.542363661343656*^9}, 
   3.542363789627483*^9, {3.542363842723792*^9, 3.542363884467966*^9}, 
   3.5423641900825243`*^9, {3.54236454137465*^9, 3.542364547624275*^9}, {
   3.5423646501845303`*^9, 3.5423646927847896`*^9}, 3.542364835863096*^9, {
   3.5423648883413434`*^9, 3.542364961653674*^9}, {3.542365050376545*^9, 
   3.5423650581793256`*^9}, {3.5423651196764746`*^9, 3.542365155655072*^9}, {
   3.5423652120937157`*^9, 3.5423652495214577`*^9}, {3.542365334992004*^9, 
   3.542365340027508*^9}, {3.542365479913495*^9, 3.542365563895892*^9}, 
   3.542365594795982*^9, {3.5423656325867605`*^9, 3.5423656787013717`*^9}, {
   3.5423657148949904`*^9, 3.542365761664667*^9}, {3.5423659054850473`*^9, 
   3.5423659060551043`*^9}, {3.5423659463451333`*^9, 3.542365970785577*^9}, {
   3.5423660075432525`*^9, 3.5423660081633143`*^9}, {3.5423660417706747`*^9, 
   3.5423660557270703`*^9}, {3.5423661227297697`*^9, 
   3.5423661278972864`*^9}, {3.542366214878984*^9, 3.542366297618257*^9}, {
   3.5423664277962737`*^9, 3.5423664643679304`*^9}, {3.5423665951420064`*^9, 
   3.542366626509143*^9}, {3.5424328816239967`*^9, 3.542432910729907*^9}, 
   3.544271951742566*^9, {3.5442741053291893`*^9, 3.544274139697091*^9}, {
   3.5442743560292244`*^9, 3.5442743615206003`*^9}, {3.5442748029211473`*^9, 
   3.544274878879982*^9}, {3.544275157713477*^9, 3.5442751826898775`*^9}, {
   3.544276020299574*^9, 3.5442760205325966`*^9}, {3.5442763472122617`*^9, 
   3.5442763484723873`*^9}, {3.5442764951759872`*^9, 3.5442764998873386`*^9}, 
   3.551611446728836*^9, {3.552994196242507*^9, 3.5529942000559344`*^9}, {
   3.552994743713354*^9, 3.5529947485728273`*^9}, 3.6043999539940023`*^9, {
   3.6043999866768403`*^9, 3.604400022682564*^9}, {3.6044000544137774`*^9, 
   3.604400097283676*^9}, 3.69779308148448*^9, {3.74921336750727*^9, 
   3.7492135230861716`*^9}, {3.7492135835863934`*^9, 
   3.7492136473926907`*^9}, {3.749213873916881*^9, 3.7492139788860903`*^9}, 
   3.7492140395309286`*^9, {3.7492166100719585`*^9, 3.7492166109226904`*^9}, {
   3.7492806670489697`*^9, 3.7492806679306016`*^9}, {3.749280759564573*^9, 
   3.7492807602587156`*^9}, 3.7495549834600425`*^9, {3.7495554143740263`*^9, 
   3.749555417060887*^9}, {3.7495566160456495`*^9, 3.7495566503495426`*^9}, 
   3.7499819072948933`*^9, 3.7540443829732704`*^9, {3.7540444466571193`*^9, 
   3.7540445247004237`*^9}, {3.7540452015304546`*^9, 3.7540452410867844`*^9}, 
   3.754049834530779*^9, {3.762179714189654*^9, 3.762179721770387*^9}, {
   3.762240884261486*^9, 3.7622408902119827`*^9}, {3.7622497909082613`*^9, 
   3.762249794655026*^9}, 3.762249963139697*^9, {3.762250169107664*^9, 
   3.762250171020599*^9}, {3.7622502100861692`*^9, 3.7622502309569936`*^9}, {
   3.762250380401802*^9, 3.762250389626469*^9}, 3.762250438142288*^9, {
   3.7749461899002295`*^9, 3.77494620315379*^9}, {3.7749463953755884`*^9, 
   3.774946425793254*^9}, {3.774955903067193*^9, 3.774955911469737*^9}, {
   3.777628055348359*^9, 3.7776280659340415`*^9}, {3.8340506927522926`*^9, 
   3.8340507176379023`*^9}},ExpressionUUID->"66d19c29-be8c-40bf-ad38-\
f1348ac79128"],

Cell[BoxData[
 RowBox[{"\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"FHMMSimulatePhotonByPhotonTrace", "[", 
    RowBox[{"params", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"photonrates_", "?", "FNumericMatrixQ"}], ",", 
         RowBox[{"kMatrix_", "?", "FNumericSquareMatrixQ"}], ",", 
         RowBox[{"pini", ":", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], ",", "t_"}], 
        "}"}], ".."}], "}"}]}], "]"}], ":=", 
   RowBox[{"Module", "[", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"FPSimulatePhotonTraceParallel", "[", 
      RowBox[{"0", ",", "0.", ",", 
       RowBox[{"N", "@", 
        RowBox[{"params", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "2"}], "]"}], "]"}]}], ",", 
       RowBox[{"N", "@", 
        RowBox[{"Transpose", "[", 
         RowBox[{"params", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "3"}], "]"}], "]"}], "]"}]}], ",", 
       RowBox[{"N", "@", 
        RowBox[{"params", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ",", 
       RowBox[{"N", "@", 
        RowBox[{"params", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "4"}], "]"}], "]"}]}]}], "]"}]}], 
    "\[IndentingNewLine]", "]"}]}]}]], "Input",
 CellChangeTimes->{{3.542362527938327*^9, 3.542362555544087*^9}, {
   3.542362588366369*^9, 3.5423626539139233`*^9}, {3.542362731732704*^9, 
   3.542362733140845*^9}, 3.542362796630193*^9, {3.54236284930146*^9, 
   3.5423628851010394`*^9}, {3.5423633222457495`*^9, 
   3.5423634711206355`*^9}, {3.5423635364181643`*^9, 
   3.5423636163751593`*^9}, {3.5423636547359953`*^9, 3.542363661343656*^9}, 
   3.542363789627483*^9, {3.542363842723792*^9, 3.542363884467966*^9}, 
   3.5423641900825243`*^9, {3.54236454137465*^9, 3.542364547624275*^9}, {
   3.5423646501845303`*^9, 3.5423646927847896`*^9}, 3.542364835863096*^9, {
   3.5423648883413434`*^9, 3.542364961653674*^9}, {3.542365050376545*^9, 
   3.5423650581793256`*^9}, {3.5423651196764746`*^9, 3.542365155655072*^9}, {
   3.5423652120937157`*^9, 3.5423652495214577`*^9}, {3.542365334992004*^9, 
   3.542365340027508*^9}, {3.542365479913495*^9, 3.542365563895892*^9}, 
   3.542365594795982*^9, {3.5423656325867605`*^9, 3.5423656787013717`*^9}, {
   3.5423657148949904`*^9, 3.542365761664667*^9}, {3.5423659054850473`*^9, 
   3.5423659060551043`*^9}, {3.5423659463451333`*^9, 3.542365970785577*^9}, {
   3.5423660075432525`*^9, 3.5423660081633143`*^9}, {3.5423660417706747`*^9, 
   3.5423660557270703`*^9}, {3.5423661227297697`*^9, 
   3.5423661278972864`*^9}, {3.542366214878984*^9, 3.542366297618257*^9}, {
   3.5423664277962737`*^9, 3.5423664643679304`*^9}, {3.5423665951420064`*^9, 
   3.542366626509143*^9}, {3.5424328816239967`*^9, 3.542432910729907*^9}, 
   3.544271951742566*^9, {3.5442741053291893`*^9, 3.544274139697091*^9}, {
   3.5442743560292244`*^9, 3.5442743615206003`*^9}, {3.5442748029211473`*^9, 
   3.544274878879982*^9}, {3.544275157713477*^9, 3.5442751826898775`*^9}, {
   3.544276020299574*^9, 3.5442760205325966`*^9}, {3.5442763472122617`*^9, 
   3.5442763484723873`*^9}, {3.5442764951759872`*^9, 3.5442764998873386`*^9}, 
   3.551611446728836*^9, {3.552994196242507*^9, 3.5529942000559344`*^9}, {
   3.552994743713354*^9, 3.5529947485728273`*^9}, 3.6043999539940023`*^9, {
   3.6043999866768403`*^9, 3.604400022682564*^9}, {3.6044000544137774`*^9, 
   3.604400097283676*^9}, 3.69779308148448*^9, {3.74921336750727*^9, 
   3.7492135230861716`*^9}, {3.7492135835863934`*^9, 
   3.7492136473926907`*^9}, {3.749213873916881*^9, 3.7492139788860903`*^9}, 
   3.7492140395309286`*^9, {3.7492166100719585`*^9, 3.7492166109226904`*^9}, {
   3.7492806670489697`*^9, 3.7492806679306016`*^9}, {3.749280759564573*^9, 
   3.7492807602587156`*^9}, 3.7495549834600425`*^9, {3.7495554143740263`*^9, 
   3.749555417060887*^9}, {3.7495566160456495`*^9, 3.7495566503495426`*^9}, 
   3.7499819072948933`*^9, 3.7540443829732704`*^9, {3.7540444466571193`*^9, 
   3.7540445247004237`*^9}, {3.7540452015304546`*^9, 3.7540452410867844`*^9}, 
   3.754049834530779*^9, {3.762179714189654*^9, 3.762179721770387*^9}, {
   3.762240884261486*^9, 3.7622408902119827`*^9}, {3.7622497909082613`*^9, 
   3.762249794655026*^9}, 3.762249963139697*^9, {3.762250169107664*^9, 
   3.762250171020599*^9}, {3.7622502100861692`*^9, 3.7622502309569936`*^9}, {
   3.762250380401802*^9, 3.762250389626469*^9}, 3.762250438142288*^9, {
   3.7749461899002295`*^9, 3.77494620315379*^9}, {3.7749463953755884`*^9, 
   3.774946425793254*^9}, {3.774955903067193*^9, 3.774955911469737*^9}, {
   3.777628055348359*^9, 3.7776280659340415`*^9}, {3.8340506927522926`*^9, 
   3.8340507176379023`*^9}, {3.8340542846095324`*^9, 3.834054341879739*^9}, {
   3.8340545887276487`*^9, 3.834054589448926*^9}, {3.8340546295000467`*^9, 
   3.8340547196295366`*^9}, 3.8340547604455986`*^9, 3.83405480174265*^9, {
   3.8340552120134587`*^9, 
   3.8340552258477044`*^9}},ExpressionUUID->"15ab92db-012c-4fe8-92af-\
745ff56f93e6"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FHMMSimulatePhotonByPhotonTrace", "[", 
   RowBox[{
    RowBox[{"photonrates_", "?", "FNumericMatrixQ"}], ",", 
    RowBox[{"kMatrix_", "?", "FNumericSquareMatrixQ"}], ",", "t_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "peq", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"peq", "=", 
      RowBox[{
       RowBox[{"NullSpace", "[", "kMatrix", "]"}], "[", 
       RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"peq", "/=", 
      RowBox[{"Total", "[", "peq", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"FHMMSimulatePhotonByPhotonTrace", "[", 
      RowBox[{"photonrates", ",", "kMatrix", ",", "peq", ",", "t"}], 
      "]"}]}]}], "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.749556679826701*^9, 3.7495566971001263`*^9}, {
   3.749556735270765*^9, 3.7495567580199995`*^9}, {3.749556790529049*^9, 
   3.7495568255047207`*^9}, {3.7499819073018465`*^9, 3.749981907305835*^9}, {
   3.7621795617465315`*^9, 3.7621795976180024`*^9}, 3.7621797049109955`*^9, {
   3.762180094445475*^9, 3.762180094937696*^9}, 3.774946216672656*^9, 
   3.7776280906588554`*^9},ExpressionUUID->"f4b16581-1ff5-403e-a706-\
cb92e0f04d09"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FHMMSimulatePhotonByPhotonTrace", "[", 
   RowBox[{"params", ":", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"photonrates_", "?", "FNumericMatrixQ"}], ",", 
        RowBox[{"kMatrix_", "?", "FNumericSquareMatrixQ"}], ",", "t_"}], 
       "}"}], ".."}], "}"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"{", "peq", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"peq", "=", 
      RowBox[{"Map", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"NullSpace", "[", "#", "]"}], "[", 
          RowBox[{"[", "1", "]"}], "]"}], "&"}], ",", 
        RowBox[{"params", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "2"}], "]"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"peq", "=", 
      RowBox[{"Map", "[", 
       RowBox[{
        RowBox[{
         FractionBox["#", 
          RowBox[{"Total", "[", "#", "]"}]], "&"}], ",", "peq"}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"FPSimulatePhotonTraceParallel", "[", 
      RowBox[{"0", ",", "0.", ",", 
       RowBox[{"N", "@", 
        RowBox[{"params", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "2"}], "]"}], "]"}]}], ",", 
       RowBox[{"N", "@", 
        RowBox[{"Transpose", "[", "peq", "]"}]}], ",", 
       RowBox[{"N", "@", 
        RowBox[{"params", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ",", 
       RowBox[{"N", "@", 
        RowBox[{"params", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "4"}], "]"}], "]"}]}]}], "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.834055485051558*^9, 3.834055525136203*^9}, {
  3.8340555810640244`*^9, 3.834055713616501*^9}, {3.8340557436251597`*^9, 
  3.8340557444629736`*^9}},ExpressionUUID->"6b3cb7f1-fa51-4be2-8c3f-\
55237328a214"],

Cell[BoxData[
 RowBox[{"\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"FHMMSimulateBinnedTrace", "[", 
    RowBox[{
     RowBox[{"photonrates_", "?", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"MatrixQ", "[", 
         RowBox[{"#", ",", "NumericQ"}], "]"}], "&"}], ")"}]}], ",", 
     RowBox[{"kMatrix_", "?", "FNumericSquareMatrixQ"}], ",", 
     RowBox[{"pini", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], ",", 
     RowBox[{"t_", "?", "NumericQ"}], ",", 
     RowBox[{"binning_", "?", "NumericQ"}]}], "]"}], ":=", 
   RowBox[{"Module", "[", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"FPSimulatePhotonTrace2", "[", 
      RowBox[{
       RowBox[{"N", "@", "t"}], ",", "1", ",", 
       RowBox[{"N", "@", "binning"}], ",", 
       RowBox[{"N", "@", "kMatrix"}], ",", 
       RowBox[{"N", "@", "pini"}], ",", 
       RowBox[{"N", "@", "photonrates"}]}], "]"}]}], "\[IndentingNewLine]", 
    "]"}]}]}]], "Input",
 CellChangeTimes->{{3.542362527938327*^9, 3.542362555544087*^9}, {
   3.542362588366369*^9, 3.5423626539139233`*^9}, {3.542362731732704*^9, 
   3.542362733140845*^9}, 3.542362796630193*^9, {3.54236284930146*^9, 
   3.5423628851010394`*^9}, {3.5423633222457495`*^9, 
   3.5423634711206355`*^9}, {3.5423635364181643`*^9, 
   3.5423636163751593`*^9}, {3.5423636547359953`*^9, 3.542363661343656*^9}, 
   3.542363789627483*^9, {3.542363842723792*^9, 3.542363884467966*^9}, 
   3.5423641900825243`*^9, {3.54236454137465*^9, 3.542364547624275*^9}, {
   3.5423646501845303`*^9, 3.5423646927847896`*^9}, 3.542364835863096*^9, {
   3.5423648883413434`*^9, 3.542364961653674*^9}, {3.542365050376545*^9, 
   3.5423650581793256`*^9}, {3.5423651196764746`*^9, 3.542365155655072*^9}, {
   3.5423652120937157`*^9, 3.5423652495214577`*^9}, {3.542365334992004*^9, 
   3.542365340027508*^9}, {3.542365479913495*^9, 3.542365563895892*^9}, 
   3.542365594795982*^9, {3.5423656325867605`*^9, 3.5423656787013717`*^9}, {
   3.5423657148949904`*^9, 3.542365761664667*^9}, {3.5423659054850473`*^9, 
   3.5423659060551043`*^9}, {3.5423659463451333`*^9, 3.542365970785577*^9}, {
   3.5423660075432525`*^9, 3.5423660081633143`*^9}, {3.5423660417706747`*^9, 
   3.5423660557270703`*^9}, {3.5423661227297697`*^9, 
   3.5423661278972864`*^9}, {3.542366214878984*^9, 3.542366297618257*^9}, {
   3.5423664277962737`*^9, 3.5423664643679304`*^9}, {3.5423665951420064`*^9, 
   3.542366626509143*^9}, {3.5424328816239967`*^9, 3.542432910729907*^9}, 
   3.544271951742566*^9, {3.5442741053291893`*^9, 3.544274139697091*^9}, {
   3.5442743560292244`*^9, 3.5442743615206003`*^9}, {3.5442748029211473`*^9, 
   3.544274878879982*^9}, {3.544275157713477*^9, 3.5442751826898775`*^9}, {
   3.544276020299574*^9, 3.5442760205325966`*^9}, {3.5442763472122617`*^9, 
   3.5442763484723873`*^9}, {3.5442764951759872`*^9, 3.5442764998873386`*^9}, 
   3.551611446728836*^9, {3.552994196242507*^9, 3.5529942000559344`*^9}, {
   3.552994743713354*^9, 3.5529947485728273`*^9}, 3.6043999539940023`*^9, {
   3.6043999866768403`*^9, 3.604400022682564*^9}, {3.6044000544137774`*^9, 
   3.604400097283676*^9}, 3.69779308148448*^9, {3.74921336750727*^9, 
   3.7492135230861716`*^9}, {3.7492135835863934`*^9, 
   3.7492136473926907`*^9}, {3.749213873916881*^9, 3.7492139788860903`*^9}, 
   3.7492140395309286`*^9, {3.7492166100719585`*^9, 3.7492166109226904`*^9}, {
   3.7492806670489697`*^9, 3.7492806679306016`*^9}, {3.749280759564573*^9, 
   3.7492807602587156`*^9}, 3.7495549834600425`*^9, {3.7495554143740263`*^9, 
   3.749555417060887*^9}, {3.7495566160456495`*^9, 3.7495566503495426`*^9}, 
   3.7499819072948933`*^9, 3.7540443829732704`*^9, {3.7540444466571193`*^9, 
   3.7540445247004237`*^9}, {3.7540452015304546`*^9, 3.7540452410867844`*^9}, 
   3.754049834530779*^9, {3.762179714189654*^9, 3.762179721770387*^9}, {
   3.762240884261486*^9, 3.7622408902119827`*^9}, {3.7622497909082613`*^9, 
   3.762249794655026*^9}, 3.762249963139697*^9, {3.762250169107664*^9, 
   3.762250171020599*^9}, {3.7622502100861692`*^9, 3.7622502309569936`*^9}, {
   3.762250380401802*^9, 3.762250389626469*^9}, {3.762250438142288*^9, 
   3.7622505044695296`*^9}, 3.762766232342186*^9, {3.764068377532216*^9, 
   3.7640683817918277`*^9}, {3.7645031999079847`*^9, 3.764503202290614*^9}, 
   3.774946242013069*^9, {3.7749464491956773`*^9, 3.7749464691973057`*^9}, 
   3.774946763424835*^9, {3.774955887109886*^9, 3.7749558943754478`*^9}, {
   3.8340508089865527`*^9, 3.834050829444939*^9}, {3.834055781926004*^9, 
   3.834055782445332*^9}},ExpressionUUID->"622963b4-bbf7-4930-b104-\
aa0583f7dc77"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FHMMSimulateBinnedTrace", "[", 
   RowBox[{
    RowBox[{"params", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"photonrates_", "?", "FNumericMatrixQ"}], ",", 
         RowBox[{"kMatrix_", "?", "FNumericSquareMatrixQ"}], ",", 
         RowBox[{"pini", ":", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], ",", "t_"}], 
        "}"}], ".."}], "}"}]}], ",", 
    RowBox[{"binning_", "?", "NumericQ"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{"FPSimulatePhotonTraceParallel", "[", 
     RowBox[{"1", ",", 
      RowBox[{"N", "@", "binning"}], ",", 
      RowBox[{"N", "@", 
       RowBox[{"params", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "2"}], "]"}], "]"}]}], ",", 
      RowBox[{"N", "@", 
       RowBox[{"Transpose", "[", 
        RowBox[{"params", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "3"}], "]"}], "]"}], "]"}]}], ",", 
      RowBox[{"N", "@", 
       RowBox[{"params", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ",", 
      RowBox[{"N", "@", 
       RowBox[{"params", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "4"}], "]"}], "]"}]}]}], "]"}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.8340558971311073`*^9, 
  3.8340559329285545`*^9}},ExpressionUUID->"321b8d9d-d90c-418a-a0c0-\
1853667d683e"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FHMMSimulateBinnedTrace", "[", 
   RowBox[{
    RowBox[{"photonrates_", "?", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{"MatrixQ", "[", 
        RowBox[{"#", ",", "NumericQ"}], "]"}], "&"}], ")"}]}], ",", 
    RowBox[{"kMatrix_", "?", "FNumericSquareMatrixQ"}], ",", "t_", ",", 
    "binning_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "peq", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"peq", "=", 
      RowBox[{
       RowBox[{"NullSpace", "[", "kMatrix", "]"}], "[", 
       RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"peq", "/=", 
      RowBox[{"Total", "[", "peq", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"FHMMSimulateBinnedTrace", "[", 
      RowBox[{
      "photonrates", ",", "kMatrix", ",", "peq", ",", "t", ",", "binning"}], 
      "]"}]}]}], "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.749556679826701*^9, 3.7495566971001263`*^9}, {
   3.749556735270765*^9, 3.7495567580199995`*^9}, {3.749556790529049*^9, 
   3.7495568255047207`*^9}, {3.7499819073018465`*^9, 3.749981907305835*^9}, {
   3.7621795617465315`*^9, 3.7621795976180024`*^9}, 3.7621797049109955`*^9, {
   3.762180094445475*^9, 3.762180094937696*^9}, {3.7622505512634916`*^9, 
   3.762250583305919*^9}, {3.762766235131732*^9, 3.7627662410239744`*^9}, 
   3.7749462510269637`*^9},ExpressionUUID->"5aa08b61-a629-4e5c-a922-\
069b5b458cb1"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FHMMSimulateBinnedTrace", "[", 
   RowBox[{
    RowBox[{"params", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"photonrates_", "?", "FNumericMatrixQ"}], ",", 
         RowBox[{"kMatrix_", "?", "FNumericSquareMatrixQ"}], ",", "t_"}], 
        "}"}], ".."}], "}"}]}], ",", "binning_"}], "]"}], ":=", 
  RowBox[{"Module", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"{", "peq", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"peq", "=", 
      RowBox[{"Map", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"NullSpace", "[", "#", "]"}], "[", 
          RowBox[{"[", "1", "]"}], "]"}], "&"}], ",", 
        RowBox[{"params", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "2"}], "]"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"peq", "=", 
      RowBox[{"Map", "[", 
       RowBox[{
        RowBox[{
         FractionBox["#", 
          RowBox[{"Total", "[", "#", "]"}]], "&"}], ",", "peq"}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"FPSimulatePhotonTraceParallel", "[", 
      RowBox[{"1", ",", 
       RowBox[{"N", "@", "binning"}], ",", 
       RowBox[{"N", "@", 
        RowBox[{"params", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "2"}], "]"}], "]"}]}], ",", 
       RowBox[{"N", "@", 
        RowBox[{"Transpose", "[", "peq", "]"}]}], ",", 
       RowBox[{"N", "@", 
        RowBox[{"params", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ",", 
       RowBox[{"N", "@", 
        RowBox[{"params", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "4"}], "]"}], "]"}]}]}], "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.8340559606239557`*^9, 
  3.834055998697657*^9}},ExpressionUUID->"03517174-e0df-40cc-880a-\
ef303981fd1d"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"FHMMBinPhotonByPhotonTrace", "[", 
    RowBox[{
     RowBox[{"photonTraj", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumericQ"}], " ", ",", "_Integer"}], " ", "}"}], 
        ".."}], "}"}]}], ",", 
     RowBox[{"dt_", "?", "NumericQ"}], ",", 
     RowBox[{"channelcount_Integer", ":", "2"}]}], "]"}], ":=", 
   RowBox[{"FPBinPhotonByPhotonTrace", "[", 
    RowBox[{
     RowBox[{"N", "@", 
      RowBox[{"photonTraj", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ",", 
     RowBox[{"photonTraj", "[", 
      RowBox[{"[", 
       RowBox[{"All", ",", "2"}], "]"}], "]"}], ",", 
     RowBox[{"N", "@", "dt"}], ",", "channelcount"}], "]"}]}], 
  RowBox[{"(*", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"data", "=", "photonTraj"}], ","}], "*)"}], 
      RowBox[{"mcs", ",", "mint", ",", "maxt"}], "}"}], ",", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"data", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "1"}], "]"}], "]"}], "=", 
       RowBox[{"Accumulate", "[", 
        RowBox[{"photonTraj", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "1"}], "]"}], "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"mcs", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Cases", "[", 
           RowBox[{"data", ",", 
            RowBox[{"{", 
             RowBox[{"_", ",", "c", ",", "___"}], "}"}]}], "]"}], "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"c", ",", "channelcount"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"mint", "=", 
       RowBox[{"data", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "1"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"maxt", "=", 
       RowBox[{
        RowBox[{"data", "[", 
         RowBox[{"[", 
          RowBox[{
           RowBox[{"-", "1"}], ",", "1"}], "]"}], "]"}], "+", "dt"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"mcs", "=", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"BinCounts", "[", 
           RowBox[{"#", ",", 
            RowBox[{"{", 
             RowBox[{"mint", ",", "maxt", ",", "dt"}], "}"}]}], "]"}], "&"}], 
         ",", "mcs"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"mcs", "\[Transpose]"}]}]}], "\[IndentingNewLine]", 
    "\[IndentingNewLine]", "]"}], "*)"}], "\[IndentingNewLine]"}]], "Input",
 CellChangeTimes->{{3.74921550245887*^9, 3.7492155179255033`*^9}, {
   3.74921555274933*^9, 3.749215604720352*^9}, {3.749215680517606*^9, 
   3.74921576148903*^9}, {3.749215793033656*^9, 3.7492158433750153`*^9}, {
   3.7492160259467587`*^9, 3.7492161204777455`*^9}, 3.7492162208838882`*^9, 
   3.749555005975812*^9, {3.749555184345601*^9, 3.7495552038216963`*^9}, {
   3.7495570015754786`*^9, 3.7495570033587537`*^9}, {3.7495580897487955`*^9, 
   3.7495580923249063`*^9}, 3.749558132750782*^9, 3.7499819073128195`*^9, 
   3.7516342622267847`*^9, 3.751634337940733*^9, {3.751634376391214*^9, 
   3.751634387747734*^9}, {3.8600578940883284`*^9, 3.860057916047781*^9}, {
   3.8600579682666883`*^9, 3.860058067389902*^9}, 3.8600596931164303`*^9, {
   3.860059765206168*^9, 3.8600597979700017`*^9}, {3.8600599013361063`*^9, 
   3.860059922339345*^9}},ExpressionUUID->"7d3550a0-d019-4e91-aefb-\
5503c1a9da06"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FGetPhotonData", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"tstart_", "?", "NumericQ"}], ",", 
      RowBox[{"tend_", "?", "NumericQ"}]}], "}"}], ",", 
    RowBox[{"routes", ":", "FRouteList"}]}], "]"}], ":=", 
  RowBox[{"FPGetPhotonInformation", "[", 
   RowBox[{
    RowBox[{"N", "@", "tstart"}], ",", 
    RowBox[{"N", "@", "tend"}], ",", 
    RowBox[{"FRouteListToByte", "[", "routes", "]"}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.809424107224169*^9, 3.809424205741895*^9}, 
   3.810037296922624*^9, {3.8100381197149386`*^9, 
   3.810038120381146*^9}},ExpressionUUID->"326cef38-712b-4a36-bc0c-\
647e1fd2ef4f"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FGetPhotonDataRaw", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"tstart_", "?", "NumericQ"}], ",", 
      RowBox[{"tend_", "?", "NumericQ"}]}], "}"}], ",", 
    RowBox[{"routes", ":", "FRouteList"}]}], "]"}], ":=", 
  RowBox[{"FPGetPhotonInformation2", "[", 
   RowBox[{
    RowBox[{"N", "@", "tstart"}], ",", 
    RowBox[{"N", "@", "tend"}], ",", 
    RowBox[{"FRouteListToByte", "[", "routes", "]"}]}], "]"}]}]], "Input",
 CellChangeTimes->{
  3.8100372160835466`*^9, {3.810037312789203*^9, 3.8100373356231546`*^9}, {
   3.8100381153735356`*^9, 
   3.8100381160826397`*^9}},ExpressionUUID->"3a3f9be2-014c-46ed-8541-\
908f5759d482"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FExportTTTRToH5", "[", 
   RowBox[{"filename_String", ",", 
    RowBox[{"{", 
     RowBox[{"t1_", ",", "t2_"}], "}"}], ",", 
    RowBox[{"routes", ":", "FRouteList"}]}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", "data", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"data", "=", 
      RowBox[{"FGetPhotonDataRaw", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"t1", ",", "t2"}], "}"}], ",", "routes"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"FileExtension", "[", "filename", "]"}], "=!=", " ", 
        "\"\<h5\>\""}], ",", 
       RowBox[{"Return", "[", "$Failed", "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Export", "[", 
      RowBox[{"filename", ",", "\[IndentingNewLine]", 
       RowBox[{"{", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"\"\<InterPhotonTimes\>\"", "\[Rule]", 
          RowBox[{"{", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"\"\<Data\>\"", "\[Rule]", " ", 
             RowBox[{"data", "[", 
              RowBox[{"[", 
               RowBox[{"2", ",", "1"}], "]"}], "]"}]}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{
            "\"\<DataFormat\>\"", "\[Rule]", "\"\<UnsignedInteger32\>\""}], 
            ",", "\[IndentingNewLine]", 
            RowBox[{"\"\<Attributes\>\"", "\[Rule]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"\"\<MacroTimeUnitInPicoSeconds\>\"", "\[Rule]", 
                RowBox[{"(", 
                 RowBox[{"\"\<MacroTimeToPicoseconds\>\"", "/.", 
                  RowBox[{"data", "[", 
                   RowBox[{"[", "1", "]"}], "]"}]}], ")"}]}], ",", 
               RowBox[{"\"\<StartTimeInSeconds\>\"", "\[Rule]", 
                RowBox[{"(", 
                 RowBox[{"\"\<StartTime\>\"", "/.", 
                  RowBox[{"data", "[", 
                   RowBox[{"[", "1", "]"}], "]"}]}], ")"}]}]}], "}"}]}]}], 
           "\[IndentingNewLine]", "}"}]}], ",", "\[IndentingNewLine]", 
         RowBox[{"\"\<Detectors\>\"", "\[Rule]", 
          RowBox[{"{", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"\"\<Data\>\"", "\[Rule]", " ", 
             RowBox[{"data", "[", 
              RowBox[{"[", 
               RowBox[{"2", ",", "2"}], "]"}], "]"}]}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{
            "\"\<DataFormat\>\"", "\[Rule]", "\"\<UnsignedInteger8\>\""}]}], 
           "\[IndentingNewLine]", "}"}]}], "\[IndentingNewLine]", ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\"\<MicroTimes\>\"", "\[Rule]", 
          RowBox[{"{", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"\"\<Data\>\"", "\[Rule]", " ", 
             RowBox[{"data", "[", 
              RowBox[{"[", 
               RowBox[{"2", ",", "3"}], "]"}], "]"}]}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{
            "\"\<DataFormat\>\"", "\[Rule]", "\"\<UnsignedInteger16\>\""}], 
            ",", "\[IndentingNewLine]", 
            RowBox[{"\"\<Attributes\>\"", "\[Rule]", 
             RowBox[{"{", 
              RowBox[{"\"\<MicroTimeTimeUnitInPicoSeconds\>\"", "\[Rule]", 
               RowBox[{"(", 
                RowBox[{"\"\<MicroTimeToPicoseconds\>\"", "/.", 
                 RowBox[{"data", "[", 
                  RowBox[{"[", "1", "]"}], "]"}]}], ")"}]}], "}"}]}]}], 
           "\[IndentingNewLine]", "}"}]}]}], "\[IndentingNewLine]", "}"}]}], 
      "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",ExpressionUUID->"4ce49241-0be5-47de-a878-379d9c35f5c3"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"FHMMGetPhotonByPhotonTraceFromTTTR", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"tstart_", "?", "NumericQ"}], ",", 
       RowBox[{"tend_", "?", "NumericQ"}]}], "}"}], ",", 
     RowBox[{"routes", ":", 
      RowBox[{"{", 
       RowBox[{"FRouteList", ".."}], "}"}], ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"FGetAcceptorRoutes", "[", "]"}], ",", 
        RowBox[{"FGetDonorRoutes", "[", "]"}]}], "}"}]}]}], "]"}], ":=", 
   "\[IndentingNewLine]", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"r", ",", "rall", ",", "data"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"r", "=", 
       RowBox[{"FExpandRoutelist", "/@", "routes"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"rall", "=", 
       RowBox[{"Total", "[", "r", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"!", 
         RowBox[{"MatchQ", "[", 
          RowBox[{"rall", ",", "FRouteList"}], "]"}]}], ",", 
        RowBox[{"Return", "[", "$Failed", "]"}]}], "]"}], ";", 
      RowBox[{"(*", 
       RowBox[{
       "At", " ", "least", " ", "one", " ", "detector", " ", "channel", " ", 
        "is", " ", "selected", " ", "in", " ", "more", " ", "than", " ", 
        "one", " ", "Routelist"}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"data", "=", 
       RowBox[{
        RowBox[{"FPGetPhotonInformation", "[", 
         RowBox[{
          RowBox[{"N", "@", "tstart"}], ",", 
          RowBox[{"N", "@", "tend"}], ",", 
          RowBox[{"FRouteListToByte", "[", "rall", "]"}]}], "]"}], "[", 
        RowBox[{"[", 
         RowBox[{"2", ",", "All", ",", 
          RowBox[{"1", ";;", "2"}]}], "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"r", "=", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Flatten", "@", 
           RowBox[{"Position", "[", 
            RowBox[{"#", ",", "1"}], "]"}]}], "&"}], ",", "r"}], "]"}]}], ";",
       "\[IndentingNewLine]", 
      RowBox[{"r", "=", 
       RowBox[{"Join", "@@", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"Map", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"(", 
              RowBox[{"#", "\[Rule]", "i"}], ")"}], "&"}], ",", 
            RowBox[{"r", "[", 
             RowBox[{"[", "i", "]"}], "]"}]}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", 
            RowBox[{"Length", "[", "r", "]"}]}], "}"}]}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"data", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "2"}], "]"}], "]"}], "=", 
       RowBox[{
        RowBox[{"data", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "2"}], "]"}], "]"}], "/.", "r"}]}], ";", 
      "\[IndentingNewLine]", "data"}]}], "\[IndentingNewLine]", "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FHMMGetBinnedTraceFromTTTR", "[", 
   RowBox[{
    RowBox[{"Tbinning_", "?", "NumericQ"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"tstart_", "?", "NumericQ"}], ",", 
      RowBox[{"tend_", "?", "NumericQ"}]}], "}"}], ",", 
    RowBox[{"routes", ":", 
     RowBox[{"{", 
      RowBox[{"FRouteList", ".."}], "}"}], ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"FGetAcceptorRoutes", "[", "]"}], ",", 
       RowBox[{"FGetDonorRoutes", "[", "]"}]}], "}"}]}]}], "]"}], ":=", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"Round", "[", 
    RowBox[{
     RowBox[{"FMCStrace", "[", 
      RowBox[{"routes", ",", 
       RowBox[{"Tbinning", "*", "1000."}], ",", "tstart", ",", "tend", ",", 
       " ", 
       RowBox[{"FOutput", "\[Rule]", "FData"}]}], "]"}], "[", 
     RowBox[{"[", 
      RowBox[{"All", ",", "All", ",", "2"}], "]"}], "]"}], "]"}], 
   "\[Transpose]"}]}]}], "Input",
 CellChangeTimes->{{3.750055415620926*^9, 3.750055417116925*^9}, {
   3.750055638486764*^9, 3.7500556509494276`*^9}, {3.750055684172576*^9, 
   3.7500557495256033`*^9}, {3.7500558183824368`*^9, 
   3.7500558377961454`*^9}, {3.7500560006455956`*^9, 3.750056002652663*^9}, {
   3.7500560709250593`*^9, 3.7500560869890976`*^9}, 3.7500562450146966`*^9, {
   3.7500562953091793`*^9, 3.75005629751696*^9}, {3.750056343578764*^9, 
   3.7500563547818003`*^9}, {3.7500564436401405`*^9, 3.750056445934007*^9}, {
   3.7500565080538645`*^9, 3.7500565165561223`*^9}, {3.750056663904028*^9, 
   3.7500566676849174`*^9}, {3.7500754830283117`*^9, 3.750075577877781*^9}, {
   3.7500786886775875`*^9, 3.7500786957975426`*^9}, {3.7500787708662815`*^9, 
   3.7500787864037247`*^9}, {3.7500790462503567`*^9, 
   3.7500790500651407`*^9}, {3.750079433777219*^9, 3.7500796584533076`*^9}, {
   3.7500798896826515`*^9, 3.7500799164406357`*^9}, 3.750080249944455*^9, {
   3.750080647562833*^9, 3.750080655013789*^9}, {3.750497305488871*^9, 
   3.7504973069342194`*^9}, {3.7504973705420933`*^9, 3.7504973734283733`*^9}, 
   3.75049742527271*^9, {3.750497550694274*^9, 3.7504975784332285`*^9}, {
   3.750497655965871*^9, 3.7504976742903805`*^9}, {3.7504978114948497`*^9, 
   3.750497925374343*^9}, 3.750497972060519*^9, 3.750498025970052*^9, {
   3.7773565454130535`*^9, 3.7773565545944557`*^9}, {3.809426231475649*^9, 
   3.8094262317588844`*^9}},ExpressionUUID->"7fad413a-63af-4928-86ed-\
4dca3c936d1d"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Accessible Volume (AV) calculation", "Subsubsection",
 CellChangeTimes->{{3.7494544408115234`*^9, 3.749454452559103*^9}, {
  3.8378452731453*^9, 3.8378452760194807`*^9}, {3.8739768733595867`*^9, 
  3.8739768928980207`*^9}},ExpressionUUID->"c9c89ad6-1272-4bcf-98a6-\
59fbf2b56d6f"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FCalcAV", "[", 
   RowBox[{
    RowBox[{"atoms_", "?", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{
        RowBox[{"FNumericMatrixQ", "[", "#", "]"}], " ", "&&", " ", 
        RowBox[{
         RowBox[{
          RowBox[{"Dimensions", "[", "#", "]"}], "[", 
          RowBox[{"[", "2", "]"}], "]"}], "==", "4"}]}], "&"}], ")"}]}], ",", 
    RowBox[{"dyeparams", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumericQ"}], ",", 
           RowBox[{"_", "?", "NumericQ"}], ",", 
           RowBox[{"_", "?", "NumericQ"}]}], "}"}], ",", 
         RowBox[{"_", "?", "NumericQ"}], ",", 
         RowBox[{"_", "?", "NumericQ"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumericQ"}], ",", 
           RowBox[{"_", "?", "NumericQ"}], ",", 
           RowBox[{"_", "?", "NumericQ"}]}], "}"}]}], "}"}], ".."}], "}"}]}], 
    ",", 
    RowBox[{"gridspaceing_", "?", "NumericQ"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{"Transpose", "/@", 
     RowBox[{"FPCalcAV", "[", 
      RowBox[{
       RowBox[{"N", "@", 
        RowBox[{"Transpose", "@", "atoms"}]}], ",", 
       RowBox[{"N", "@", 
        RowBox[{"dyeparams", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ",", 
       RowBox[{"N", "@", 
        RowBox[{"dyeparams", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "2"}], "]"}], "]"}]}], ",", 
       RowBox[{"N", "@", 
        RowBox[{"dyeparams", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "3"}], "]"}], "]"}]}], ",", 
       RowBox[{"N", "@", 
        RowBox[{"dyeparams", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "4"}], "]"}], "]"}]}], ",", 
       RowBox[{"N", "@", "gridspaceing"}]}], "]"}]}]}], "\[IndentingNewLine]",
    "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FCalcAV", "[", 
   RowBox[{
    RowBox[{"atoms_", "?", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{
        RowBox[{"FNumericMatrixQ", "[", "#", "]"}], " ", "&&", " ", 
        RowBox[{
         RowBox[{
          RowBox[{"Dimensions", "[", "#", "]"}], "[", 
          RowBox[{"[", "2", "]"}], "]"}], "==", "4"}]}], "&"}], ")"}]}], ",", 
    RowBox[{"dyeattachmentpoint", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumericQ"}], ",", 
       RowBox[{"_", "?", "NumericQ"}], ",", 
       RowBox[{"_", "?", "NumericQ"}]}], "}"}]}], ",", 
    RowBox[{"linkerL_", "?", "NumericQ"}], ",", 
    RowBox[{"linkerD_", "?", "NumericQ"}], ",", 
    RowBox[{"dyeradii", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumericQ"}], ",", 
       RowBox[{"_", "?", "NumericQ"}], ",", 
       RowBox[{"_", "?", "NumericQ"}]}], "}"}]}], ",", 
    RowBox[{"gridspaceing_", "?", "NumericQ"}]}], "]"}], ":=", 
  RowBox[{
   RowBox[{"FCalcAV", "[", 
    RowBox[{"atoms", ",", 
     RowBox[{"{", 
      RowBox[{"{", 
       RowBox[{
       "dyeattachmentpoint", ",", "linkerL", ",", "linkerD", ",", 
        "dyeradii"}], "}"}], "}"}], ",", "gridspaceing"}], "]"}], "[", 
   RowBox[{"[", "1", "]"}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.8741447468515387`*^9, 3.874144769949256*^9}, {
  3.874144809124651*^9, 3.874144978959915*^9}, {3.8741450157501016`*^9, 
  3.8741450165233965`*^9}, {3.874145048194765*^9, 3.8741451130861964`*^9}, {
  3.8741461153439875`*^9, 3.8741461238252025`*^9}, {3.8741462984741488`*^9, 
  3.8741463011123433`*^9}},ExpressionUUID->"e77519d7-f141-4b37-80f4-\
262750ebe9b8"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FCalcAVMinLinkerLength", "[", 
   RowBox[{
    RowBox[{"atoms_", "?", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{
        RowBox[{"FNumericMatrixQ", "[", "#", "]"}], " ", "&&", " ", 
        RowBox[{
         RowBox[{
          RowBox[{"Dimensions", "[", "#", "]"}], "[", 
          RowBox[{"[", "2", "]"}], "]"}], "==", "4"}]}], "&"}], ")"}]}], ",", 
    RowBox[{"dyeparams", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumericQ"}], ",", 
           RowBox[{"_", "?", "NumericQ"}], ",", 
           RowBox[{"_", "?", "NumericQ"}]}], "}"}], ",", 
         RowBox[{"_", "?", "NumericQ"}], ",", 
         RowBox[{"_", "?", "NumericQ"}], ",", 
         RowBox[{"_", "?", "NumericQ"}]}], "}"}], ".."}], "}"}]}], ",", 
    RowBox[{"gridspaceing_", "?", "NumericQ"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{"Transpose", "/@", 
     RowBox[{"FPCalcMinLinkerLength", "[", 
      RowBox[{
       RowBox[{"N", "@", 
        RowBox[{"Transpose", "@", "atoms"}]}], ",", 
       RowBox[{"N", "@", 
        RowBox[{"dyeparams", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ",", 
       RowBox[{"N", "@", 
        RowBox[{"dyeparams", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "2"}], "]"}], "]"}]}], ",", 
       RowBox[{"N", "@", 
        RowBox[{"dyeparams", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "3"}], "]"}], "]"}]}], ",", 
       RowBox[{"N", "@", 
        RowBox[{"dyeparams", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "4"}], "]"}], "]"}]}], ",", 
       RowBox[{"N", "@", "gridspaceing"}]}], "]"}]}]}], "\[IndentingNewLine]",
    "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FCalcAVMinLinkerLength", "[", 
   RowBox[{
    RowBox[{"atoms_", "?", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{
        RowBox[{"FNumericMatrixQ", "[", "#", "]"}], " ", "&&", " ", 
        RowBox[{
         RowBox[{
          RowBox[{"Dimensions", "[", "#", "]"}], "[", 
          RowBox[{"[", "2", "]"}], "]"}], "==", "4"}]}], "&"}], ")"}]}], ",", 
    RowBox[{"dyeattachmentpoint", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumericQ"}], ",", 
       RowBox[{"_", "?", "NumericQ"}], ",", 
       RowBox[{"_", "?", "NumericQ"}]}], "}"}]}], ",", 
    RowBox[{"linkerL_", "?", "NumericQ"}], ",", 
    RowBox[{"linkerD_", "?", "NumericQ"}], ",", 
    RowBox[{"dyeradius_", "?", "NumericQ"}], ",", 
    RowBox[{"gridspaceing_", "?", "NumericQ"}]}], "]"}], ":=", 
  RowBox[{
   RowBox[{"FCalcAVMinLinkerLength", "[", 
    RowBox[{"atoms", ",", 
     RowBox[{"{", 
      RowBox[{"{", 
       RowBox[{
       "dyeattachmentpoint", ",", "linkerL", ",", "linkerD", ",", 
        "dyeradius"}], "}"}], "}"}], ",", "gridspaceing"}], "]"}], "[", 
   RowBox[{"[", "1", "]"}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.8741447468515387`*^9, 3.874144769949256*^9}, {
   3.874144809124651*^9, 3.874144978959915*^9}, {3.8741450157501016`*^9, 
   3.8741450165233965`*^9}, {3.874145048194765*^9, 3.8741451130861964`*^9}, {
   3.8741461153439875`*^9, 3.8741461238252025`*^9}, {3.8741462984741488`*^9, 
   3.8741463011123433`*^9}, 3.8746418680650654`*^9, 3.874641907391781*^9, {
   3.8746419843672905`*^9, 
   3.8746420471410513`*^9}},ExpressionUUID->"7cdd49cc-5239-4a32-ad87-\
8883e1d3c665"]
}, Open  ]],

Cell[CellGroupData[{

Cell["TRBP model", "Subsubsection",
 CellChangeTimes->{{3.7494544408115234`*^9, 3.749454452559103*^9}, {
  3.8378452731453*^9, 
  3.8378452760194807`*^9}},ExpressionUUID->"33e5c9e7-599f-4a71-9d70-\
8d20f6789b23"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FTRBPInit", "[", 
   RowBox[{
    RowBox[{"minmaxpos_", "?", "FNumericMatrixQ"}], ",", "kofflist_List", ",", 
    RowBox[{"prlist_", "?", "FNumericMatrixQ"}], ",", "pDifflist_List", ",", 
    "statelist_List"}], "]"}], ":=", 
  RowBox[{"FPTRBPInit", "[", 
   RowBox[{
    RowBox[{"N", "@", "minmaxpos"}], ",", 
    RowBox[{"N", "@", "kofflist"}], ",", 
    RowBox[{"N", "@", "prlist"}], ",", 
    RowBox[{"N", "@", "pDifflist"}], ",", 
    RowBox[{"N", "@", 
     RowBox[{"Transpose", "[", 
      RowBox[{"Flatten", "/@", "statelist"}], "]"}]}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.8378453199252577`*^9, 3.837845382945069*^9}, {
  3.8382772930520096`*^9, 3.838277301937311*^9}, {3.8399256592496214`*^9, 
  3.839925708778782*^9}, {3.839934284081993*^9, 3.839934286240444*^9}, {
  3.839934906226822*^9, 
  3.8399349091466675`*^9}},ExpressionUUID->"c0c40f22-e466-4e22-9e8d-\
73570eefd73a"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FTRBPGetKMatrix", "[", "]"}], ":=", 
  RowBox[{"FPTRBPGetKMatrix", "[", "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FTRBPGetPeq", "[", "]"}], ":=", 
  RowBox[{"FPTRBPGetPeq", "[", "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FTRBPGetPeqFast", "[", 
   RowBox[{
    RowBox[{"kofflist_", "?", "FNumericMatrixQ"}], ",", 
    RowBox[{"prlist_", "?", "FNumericMatrixQ"}]}], "]"}], ":=", 
  RowBox[{"FPTRBPGetPeqFast", "[", 
   RowBox[{
    RowBox[{"N", "@", "kofflist"}], ",", 
    RowBox[{"N", "@", "prlist"}]}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.837845406324218*^9, 3.837845419571665*^9}, {
  3.8381812053492794`*^9, 3.838181219057643*^9}, {3.8395839396701107`*^9, 
  3.8395839519332323`*^9}, {3.8396604018268223`*^9, 3.8396604282194138`*^9}, {
  3.8396610435292478`*^9, 3.8396610600296717`*^9}, {3.8399256452723637`*^9, 
  3.8399256481631784`*^9}},ExpressionUUID->"ec263ad9-9a1e-4b32-a1bd-\
a55ea4b66e20"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FTRBPSimulatePhotonByPhotonTrace", "[", 
   RowBox[{"params", ":", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"(*", "photonrates", "*)"}], 
       RowBox[{
        RowBox[{"_", "?", "FNumericMatrixQ"}], ",", 
        RowBox[{"(*", 
         RowBox[{"pini", ":"}], "*)"}], 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}], ",", 
        RowBox[{"(*", "t", "*)"}], "_"}], "}"}], ".."}], "}"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{"FPTRBPSimulatePhotonTraceParallel", "[", 
     RowBox[{"0", ",", "0.", ",", 
      RowBox[{"N", "@", 
       RowBox[{"Transpose", "[", 
        RowBox[{"params", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}]}], ",", 
      RowBox[{"N", "@", 
       RowBox[{"params", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ",", 
      RowBox[{"N", "@", 
       RowBox[{"params", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "3"}], "]"}], "]"}]}]}], "]"}]}], 
   "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FTRBPSimulateBinnedTrace", "[", 
   RowBox[{
    RowBox[{"params", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"(*", "photonrates", "*)"}], 
        RowBox[{
         RowBox[{"_", "?", "FNumericMatrixQ"}], ",", 
         RowBox[{"(*", 
          RowBox[{"pini", ":"}], "*)"}], 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}], ",", 
         RowBox[{"(*", "t", "*)"}], "_"}], "}"}], ".."}], "}"}]}], ",", 
    "binning_"}], "]"}], ":=", 
  RowBox[{"Module", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{"FPTRBPSimulatePhotonTraceParallel", "[", 
     RowBox[{"1", ",", "binning", ",", 
      RowBox[{"N", "@", 
       RowBox[{"Transpose", "[", 
        RowBox[{"params", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}]}], ",", 
      RowBox[{"N", "@", 
       RowBox[{"params", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ",", 
      RowBox[{"N", "@", 
       RowBox[{"params", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "3"}], "]"}], "]"}]}]}], "]"}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->{{3.8381154260130615`*^9, 3.8381154957218723`*^9}, 
   3.8381158512485666`*^9, {3.859894777859482*^9, 3.859894802692577*^9}, {
   3.8600604307343206`*^9, 3.860060442317601*^9}, {3.8600605098831625`*^9, 
   3.860060523930011*^9}},ExpressionUUID->"5e0753d3-7fd1-4b83-9381-\
0e55ad217dd6"]
}, Open  ]],

Cell[CellGroupData[{

Cell["FretHMM commands", "Subsubsection",
 CellChangeTimes->{{3.7494544408115234`*^9, 3.749454452559103*^9}, {
  3.7638000707748685`*^9, 
  3.763800072327905*^9}},ExpressionUUID->"5e74dc89-df49-4d9a-acaa-\
4fd9ba7b7cd0"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FFretHmmBinning", "=", "1."}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FFretHMMmode", "=", "None"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FFretHMMTrajectoryCount", "=", "0"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FFretHMMStateCount", "=", "0"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FFretHMMGlobalRates", "=", "False"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FFretHMMFmean", "=", 
   RowBox[{"{", 
    RowBox[{"1.", ",", "1."}], "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FFretHMMmu", "=", "0."}], ";"}]}], "Input",
 CellChangeTimes->{{3.749466891328204*^9, 3.7494669049603567`*^9}, {
  3.749467005772902*^9, 3.7494670232095947`*^9}, {3.7494676232807198`*^9, 
  3.749467657154451*^9}, {3.7494678877648816`*^9, 3.749467917318637*^9}, {
  3.749468076795555*^9, 3.749468108091424*^9}, {3.749981906934828*^9, 
  3.7499819069487925`*^9}, {3.7501481401679487`*^9, 3.7501481452912493`*^9}, {
  3.7501497107406206`*^9, 3.750149715913785*^9}, {3.7529205203288183`*^9, 
  3.7529205243969293`*^9}, {3.7638001263923063`*^9, 3.7638001632028613`*^9}, {
  3.7638804062925124`*^9, 3.7638804337720222`*^9}, {3.763880468758442*^9, 
  3.7638804810804873`*^9}},ExpressionUUID->"34253a5b-f82c-405e-9408-\
a09ff95b6c75"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FFretHMMInitWithBinnedData", "[", 
   RowBox[{
    RowBox[{"trlist", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumericQ"}], " ", ",", 
           RowBox[{"_", "?", "NumericQ"}]}], " ", "}"}], ".."}], "}"}], 
       ".."}], "}"}]}], ",", 
    RowBox[{"Tbinning_", "?", "NumericQ"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "unitv", "}"}], ",", "\[IndentingNewLine]", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"FFretHmmBinning", "=", "Tbinning"}], ";", "\[IndentingNewLine]", 
     RowBox[{"FPFretHmmClearTrajectoryList", "[", "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"unitv", "=", 
      RowBox[{"ConstantArray", "[", 
       RowBox[{"1.", ",", "2"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Map", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"FPFretHmmAppendTrajectory", "[", 
         RowBox[{"Round", "@", 
          RowBox[{"Flatten", "@", "#"}]}], "]"}], "&"}], ",", "trlist"}], 
      "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"FFretHMMmode", "=", "FHMMBinned"}], ";", "\[IndentingNewLine]", 
     RowBox[{"FFretHMMTrajectoryCount", "=", 
      RowBox[{"Length", "[", "trlist", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"FFretHMMStateCount", "=", "0"}], ";"}]}], "\[IndentingNewLine]",
    "]"}]}]], "Input",
 CellChangeTimes->{{3.7494661201885214`*^9, 3.749466120532586*^9}, {
   3.749466161046032*^9, 3.7494662052479744`*^9}, {3.749466287389041*^9, 
   3.7494663459640927`*^9}, {3.7494664027681656`*^9, 
   3.7494665253417253`*^9}, {3.7494668457956057`*^9, 
   3.7494668736904063`*^9}, {3.749467030735467*^9, 3.7494670541789494`*^9}, 
   3.749467752422865*^9, {3.7495336861652555`*^9, 3.74953373240164*^9}, {
   3.749533821786525*^9, 3.7495338871610546`*^9}, 3.7495469326926785`*^9, {
   3.749549558536272*^9, 3.749549563590763*^9}, {3.7499819069527817`*^9, 
   3.7499819069777136`*^9}, {3.749986186962763*^9, 3.7499862226812525`*^9}, {
   3.750148204514877*^9, 3.7501482285405917`*^9}, {3.7501497996563396`*^9, 
   3.7501498032736645`*^9}, {3.7529194625061884`*^9, 
   3.7529194698676977`*^9}, {3.752919609214021*^9, 3.7529196514660215`*^9}, {
   3.752919688349354*^9, 3.7529197190641994`*^9}, {3.7529197517084403`*^9, 
   3.7529198488925*^9}, {3.7638001727752533`*^9, 3.7638002282638493`*^9}, 
   3.764046617504424*^9},ExpressionUUID->"eeefcda5-7c6f-4975-aa81-\
b5b39d4363d3"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FFretHMMInitWithPhotonByPhotonData", "[", 
   RowBox[{"trlist", ":", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumericQ"}], " ", ",", "_Integer"}], " ", "}"}], 
        ".."}], "}"}], ".."}], "}"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"unitv", ",", "tr"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"FMLHClearBurstList", "[", "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"unitv", "=", 
      RowBox[{"ConstantArray", "[", 
       RowBox[{"1", ",", "2"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Map", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"FMLHAppendToBurstList", "[", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"tr", "=", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"unitv", ",", "unitv", ",", "unitv", ",", "unitv"}], 
               "}"}], ",", "#"}], "}"}]}], ";", 
           RowBox[{
            RowBox[{"tr", "[", 
             RowBox[{"[", 
              RowBox[{"2", ",", "All", ",", "2"}], "]"}], "]"}], "-=", "1"}], 
           ";", "tr"}], ")"}], "]"}], "&"}], ",", "trlist"}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"FFretHMMmode", "=", "FHMMPhotonByPhoton"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"FFretHMMTrajectoryCount", "=", 
      RowBox[{"Length", "[", "trlist", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"FFretHMMStateCount", "=", "0"}], ";"}]}], "\[IndentingNewLine]",
    "]"}]}]], "Input",
 CellChangeTimes->{{3.7494665806668053`*^9, 3.749466595347588*^9}, {
   3.7494666486188655`*^9, 3.7494667175235643`*^9}, {3.7494667937131996`*^9, 
   3.7494668279855375`*^9}, {3.7494670644684296`*^9, 3.749467064855386*^9}, 
   3.749467756632594*^9, {3.749533746674418*^9, 3.749533748154462*^9}, {
   3.7495339057144794`*^9, 3.7495339643276663`*^9}, 3.749547094344572*^9, 
   3.7495473685809216`*^9, 3.7495479042654405`*^9, {3.749549540641127*^9, 
   3.7495495513983564`*^9}, {3.749550510890293*^9, 3.7495505729397707`*^9}, {
   3.749981906985693*^9, 3.74998190700068*^9}, {3.7501482735003414`*^9, 
   3.750148297429345*^9}, {3.750149816314785*^9, 3.7501498169900713`*^9}, 
   3.763800675187502*^9, {3.7638007348978024`*^9, 
   3.763800740653413*^9}},ExpressionUUID->"2281c2bb-016c-4b9b-ba16-\
85a0f8f0ebe1"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FFretHMMSetPhotonRates", "[", 
   RowBox[{"rateparams", ":", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumericQ"}], ",", " ", 
            RowBox[{"_", "?", "NumericQ"}], ",", " ", 
            RowBox[{"_", "?", "NumericQ"}]}], "}"}], ".."}], "}"}], ",", " ", 
        RowBox[{"_", "?", "NumericQ"}], ",", " ", 
        RowBox[{"_", "?", "NumericQ"}]}], "}"}], ".."}], "}"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "nstates", ",", "Fmean", ",", "mu", ",", "nu", ",", "bgA", ",", "bgD"}], 
     "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"nstates", "=", 
      RowBox[{"Length", "[", 
       RowBox[{"rateparams", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "1"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Fmean", "=", 
      RowBox[{
       RowBox[{"N", "@", "FFretHmmBinning"}], "*", 
       RowBox[{"Flatten", "@", 
        RowBox[{"rateparams", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "1", ",", "All", ",", "1"}], "]"}], "]"}]}]}]}],
      ";", "\[IndentingNewLine]", 
     RowBox[{"mu", "=", 
      RowBox[{"N", "@", 
       RowBox[{"Flatten", "@", 
        RowBox[{"rateparams", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "1", ",", "All", ",", "2"}], "]"}], "]"}]}]}]}],
      ";", "\[IndentingNewLine]", 
     RowBox[{"nu", "=", 
      RowBox[{"N", "@", 
       RowBox[{"Flatten", "@", 
        RowBox[{"rateparams", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "1", ",", "All", ",", "3"}], "]"}], "]"}]}]}]}],
      ";", "\[IndentingNewLine]", 
     RowBox[{"bgA", "=", 
      RowBox[{
       RowBox[{"N", "@", "FFretHmmBinning"}], "*", 
       RowBox[{"Flatten", "@", 
        RowBox[{"Map", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"ConstantArray", "[", 
            RowBox[{"#", ",", "nstates"}], "]"}], "&"}], ",", 
          RowBox[{"rateparams", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "2"}], "]"}], "]"}]}], "]"}]}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"bgD", "=", 
      RowBox[{
       RowBox[{"N", "@", "FFretHmmBinning"}], "*", 
       RowBox[{"Flatten", "@", 
        RowBox[{"Map", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"ConstantArray", "[", 
            RowBox[{"#", ",", "nstates"}], "]"}], "&"}], ",", 
          RowBox[{"rateparams", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "3"}], "]"}], "]"}]}], "]"}]}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"nstates", "=", 
      RowBox[{"Length", "[", 
       RowBox[{"rateparams", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "1"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"FFretHMMGlobalRates", "=", "False"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Which", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"FFretHMMmode", "===", "FHMMBinned"}], ",", 
       RowBox[{"FPFretHmmSetPhotonRates", "[", 
        RowBox[{
        "bgA", ",", "bgD", ",", "Fmean", ",", "mu", ",", "nu", ",", 
         "nstates"}], "]"}], ",", "\[IndentingNewLine]", 
       RowBox[{"FFretHMMmode", "===", "FHMMPhotonByPhoton"}], ",", 
       RowBox[{"Return", "[", "$Failed", "]"}], ",", "\[IndentingNewLine]", 
       "True", ",", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"FHMMSetPhotonRates", "::", "erroptval"}], "]"}], ";", 
         RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
      "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"FFretHMMStateCount", "=", "nstates"}], ";"}]}], 
   "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"FFretHMMSetPhotonRates", "[", 
     RowBox[{"rateparams", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"Fmean_", "?", "NumericQ"}], ",", " ", 
        RowBox[{"mu_", "?", "NumericQ"}], ",", 
        RowBox[{"nu_", "?", "NumericQ"}], ",", " ", 
        RowBox[{"bgA_", "?", "NumericQ"}], ",", " ", 
        RowBox[{"bgD_", "?", "NumericQ"}]}], "}"}]}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"FFretHMMSetPhotonRates", "[", 
        RowBox[{"ConstantArray", "[", 
         RowBox[{"rateparams", ",", "FFretHMMTrajectoryCount"}], "]"}], "]"}],
        ";", "\[IndentingNewLine]", 
       RowBox[{"FFretHMMGlobalRates", "=", "True"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"FFretHMMFmean", "=", "Fmean"}], ";", "\[IndentingNewLine]", 
       RowBox[{"FFretHMMmu", "=", "mu"}], ";", "\[IndentingNewLine]", 
       RowBox[{"FFretHMMnu", "=", "nu"}], ";", "\[IndentingNewLine]", 
       RowBox[{"FFretHMMbgA", "=", "bgA"}], ";", "\[IndentingNewLine]", 
       RowBox[{"FFretHMMbgD", "=", "bgD"}], ";"}]}], "\[IndentingNewLine]", 
     "]"}]}], "*)"}]}]}], "Input",
 CellChangeTimes->{{3.7494669861464057`*^9, 3.749466989115467*^9}, {
   3.749467078550751*^9, 3.749467117840347*^9}, {3.7494671535495186`*^9, 
   3.749467323666687*^9}, {3.7494674164462223`*^9, 3.7494674725061264`*^9}, {
   3.7494676919993315`*^9, 3.749467735241808*^9}, 3.749467847597299*^9, {
   3.7494679600687523`*^9, 3.749468066351487*^9}, {3.749468125382179*^9, 
   3.7494681506695447`*^9}, {3.7495291519840097`*^9, 
   3.7495291583489857`*^9}, {3.7495291886959157`*^9, 
   3.7495292289412794`*^9}, {3.749530356519924*^9, 3.7495304082841578`*^9}, 
   3.7495337694175897`*^9, {3.7495340745957456`*^9, 3.749534075370719*^9}, {
   3.7495341504598513`*^9, 3.749534157962826*^9}, {3.7495343379712057`*^9, 
   3.7495343636468368`*^9}, {3.7495344608907485`*^9, 
   3.7495345002582293`*^9}, {3.7495349392642612`*^9, 3.749535006577127*^9}, {
   3.7495351419298134`*^9, 3.7495352261623807`*^9}, {3.749536792135975*^9, 
   3.7495368115989943`*^9}, {3.749546502985573*^9, 3.749546512482171*^9}, {
   3.749981907005665*^9, 3.749981907082461*^9}, {3.749985522786653*^9, 
   3.7499855235366573`*^9}, {3.7501408679689856`*^9, 3.750140918503724*^9}, {
   3.7501411529511895`*^9, 3.7501411579468307`*^9}, {3.750141209161852*^9, 
   3.750141225144103*^9}, {3.7501412950880346`*^9, 3.7501413150576243`*^9}, {
   3.7501463755161533`*^9, 3.7501464124244413`*^9}, {3.750147953247884*^9, 
   3.7501479707640686`*^9}, 3.750148051796307*^9, {3.7501483323499403`*^9, 
   3.750148426298667*^9}, {3.750149746881489*^9, 3.7501497563342094`*^9}, 
   3.7501508727313433`*^9, 3.7528250614918556`*^9, {3.763800750733449*^9, 
   3.763800780892786*^9}, {3.7638008688375683`*^9, 3.7638009099964848`*^9}, {
   3.763800942266178*^9, 3.7638009761036825`*^9}, {3.763801052641961*^9, 
   3.763801115440015*^9}, {3.7638020834303226`*^9, 3.763802173884395*^9}, {
   3.7638022502860885`*^9, 3.763802297123788*^9}, {3.7638023455831795`*^9, 
   3.7638024287906313`*^9}, {3.763880277236682*^9, 3.7638803550056825`*^9}, {
   3.7638808775792513`*^9, 3.7638808954465084`*^9}, {3.763880927410019*^9, 
   3.7638809422522745`*^9}, {3.763881056281296*^9, 3.76388108642268*^9}, {
   3.7638869357885184`*^9, 3.763887071861861*^9}, {3.7638871260429497`*^9, 
   3.763887127750385*^9}, 3.763887170636692*^9, {3.7638896559632196`*^9, 
   3.76388967843716*^9}, {3.763891607711111*^9, 3.7638918372741346`*^9}, 
   3.763891875050042*^9, {3.763891906608636*^9, 3.7638920392758064`*^9}, {
   3.7638920973734207`*^9, 3.763892158379306*^9}, {3.76389285240574*^9, 
   3.7638928722785826`*^9}, {3.764306180172612*^9, 3.764306228676947*^9}, {
   3.7643063650105405`*^9, 3.7643064037918634`*^9}, {3.7643064370908613`*^9, 
   3.7643065443381915`*^9}, {3.764306902144442*^9, 3.764306952620555*^9}, {
   3.764307066639735*^9, 3.764307216712243*^9}, {3.7643072703120117`*^9, 
   3.7643073008992085`*^9}, {3.7643074488797045`*^9, 
   3.7643074681491613`*^9}, {3.7643075345905647`*^9, 3.764307567601328*^9}, {
   3.764307907091278*^9, 3.7643079080826693`*^9}, {3.764307955911793*^9, 
   3.764307970291348*^9}, {3.7643080132146206`*^9, 3.7643081116963787`*^9}, {
   3.7643081901876016`*^9, 3.7643082014335117`*^9}, 3.7643084484821377`*^9, {
   3.7643115491561885`*^9, 
   3.7643115953537045`*^9}},ExpressionUUID->"1ffb495c-e5ec-4b74-a4b4-\
4867651c246b"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"FFretHMMSetPinPfin", "[", 
    RowBox[{"pinpfin", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], "}"}], ".."}], 
      "}"}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "nstates", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"nstates", "=", 
       RowBox[{"Length", "[", 
        RowBox[{"pinpfin", "[", 
         RowBox[{"[", 
          RowBox[{"1", ",", "1"}], "]"}], "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"AnyTrue", "[", 
         RowBox[{"pinpfin", ",", 
          RowBox[{
           RowBox[{
            RowBox[{"Length", "[", "#", "]"}], "\[NotEqual]", "nstates"}], 
           "&"}], ",", "2"}], "]"}], ",", 
        RowBox[{"Return", "[", "$Failed", "]"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"FFretHMMGlobalRates", "=", "False"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Which", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"FFretHMMmode", "===", "FHMMBinned"}], "\[IndentingNewLine]", 
        ",", 
        RowBox[{"FPFretHmmSetPinPfin", "[", 
         RowBox[{
          RowBox[{"N", "@", 
           RowBox[{"Flatten", "@", 
            RowBox[{"pinpfin", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "1"}], "]"}], "]"}]}]}], ",", 
          RowBox[{"N", "@", 
           RowBox[{"Flatten", "@", 
            RowBox[{"pinpfin", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "2"}], "]"}], "]"}]}]}], ",", 
          RowBox[{"Length", "@", 
           RowBox[{"pinpfin", "[", 
            RowBox[{"[", 
             RowBox[{"1", ",", "1"}], "]"}], "]"}]}]}], "]"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"FFretHMMmode", "===", "FHMMPhotonByPhoton"}], 
        "\[IndentingNewLine]", ",", 
        RowBox[{"FPMLHSetPinPfin", "[", 
         RowBox[{
          RowBox[{"N", "@", 
           RowBox[{"Flatten", "@", 
            RowBox[{"pinpfin", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "1"}], "]"}], "]"}]}]}], ",", 
          RowBox[{"N", "@", 
           RowBox[{"Flatten", "@", 
            RowBox[{"pinpfin", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "2"}], "]"}], "]"}]}]}], ",", 
          RowBox[{"Length", "@", 
           RowBox[{"pinpfin", "[", 
            RowBox[{"[", 
             RowBox[{"1", ",", "1"}], "]"}], "]"}]}]}], "]"}], ",", 
        "\[IndentingNewLine]", "True", ",", "$Failed"}], 
       "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  "\[IndentingNewLine]"}], "\n", 
 RowBox[{
  RowBox[{"FFretHMMSetPinPfin", "[", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"pin", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], ",", " ", 
     RowBox[{"pfin", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}]}], "}"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"Length", "[", "pin", "]"}], "!=", "FFretHMMStateCount"}], 
        " ", "||", " ", 
        RowBox[{
         RowBox[{"Length", "[", "pfin", "]"}], "!=", "FFretHMMStateCount"}]}],
        ",", 
       RowBox[{"Return", "[", "$Failed", "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"FFretHMMSetPinPfin", "[", 
      RowBox[{"ConstantArray", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"pin", ",", "pfin"}], "}"}], ",", 
        "FFretHMMTrajectoryCount"}], "]"}], "]"}], ";"}]}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   "]"}]}], "\[IndentingNewLine]"}], "Input",
 CellChangeTimes->{{3.7499847584301777`*^9, 3.7499847963729277`*^9}, {
   3.749985054632259*^9, 3.749985062665756*^9}, 3.749985108100808*^9, {
   3.749985168185115*^9, 3.749985261087639*^9}, {3.749985371306799*^9, 
   3.7499854247179956`*^9}, {3.7499855375800905`*^9, 3.749985586477364*^9}, 
   3.7501479608435717`*^9, {3.7501485228833456`*^9, 3.750148632110212*^9}, 
   3.7501498634265327`*^9, {3.7501508989217916`*^9, 3.7501509319225984`*^9}, {
   3.763887098703071*^9, 3.7638871097086906`*^9}, {3.7638872081792746`*^9, 
   3.763887273143513*^9}},ExpressionUUID->"a81d6626-1de7-4c63-9ab6-\
91ab3722332a"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FFretHMMLogLikelihood", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"FHMMpinpfin", "->", "FHMMPeqOne"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FFretHMMLogLikelihood", "[", 
   RowBox[{
    RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "lh", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Length", "[", "Km", "]"}], "!=", "FFretHMMStateCount"}], ",", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"FHMMLogLikelihood", "::", "dimerr"}], "]"}], ";", 
         RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Which", "[", 
      RowBox[{
       RowBox[{"FFretHMMmode", "===", "FHMMBinned"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"lh", "=", 
        RowBox[{"Which", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
           "FHMMPeqOne"}], "\[IndentingNewLine]", ",", 
          RowBox[{"If", "[", 
           RowBox[{"FFretHMMGlobalRates", ",", " ", 
            RowBox[{"FPFretHmmGetLikelihoodPeqFromK", "[", 
             RowBox[{
              RowBox[{"FFretHmmBinning", "*", 
               RowBox[{"N", "@", "FFretHMMbgA"}]}], ",", 
              RowBox[{"FFretHmmBinning", "*", 
               RowBox[{"N", "@", "FFretHMMbgD"}]}], ",", 
              RowBox[{"FFretHmmBinning", "*", 
               RowBox[{"N", "@", "FFretHMMFmean"}]}], ",", 
              RowBox[{"N", "@", "FFretHMMmu"}], ",", 
              RowBox[{"N", "@", "FFretHMMnu"}], ",", 
              RowBox[{"FFretHmmBinning", "*", 
               RowBox[{"N", "@", 
                RowBox[{"Flatten", "@", "Km"}]}]}]}], "]"}], ",", 
            RowBox[{"FPFretHmmGetLikelihoodPeqFromK", "[", 
             RowBox[{
              RowBox[{"FFretHmmBinning", "*", 
               RowBox[{"N", "@", 
                RowBox[{"Flatten", "@", "Km"}]}]}], ",", 
              RowBox[{"Length", "[", "Km", "]"}]}], "]"}]}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
           "FHMMTraceWise"}], "\[IndentingNewLine]", ",", 
          RowBox[{"FPHmmGetLikelihood", "[", 
           RowBox[{
            RowBox[{"FFretHmmBinning", "*", 
             RowBox[{"N", "@", 
              RowBox[{"Flatten", "@", "Km"}]}]}], ",", 
            RowBox[{"Length", "[", "Km", "]"}]}], "]"}], ",", 
          "\[IndentingNewLine]", "True", "\[IndentingNewLine]", ",", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"Message", "[", 
             RowBox[{"FHMMLogLikelihood", "::", "erroptval"}], "]"}], ";", 
            RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
         "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", ",", 
       RowBox[{"FFretHMMmode", "===", "FHMMPhotonByPhoton"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"lh", "=", 
        RowBox[{"-", "\[IndentingNewLine]", 
         RowBox[{"Which", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
            "FHMMPeqOne"}], "\[IndentingNewLine]", ",", 
           RowBox[{"If", "[", 
            RowBox[{"FHMMGlobalRates", ",", 
             RowBox[{"FPMLHGetLikelihoodPeqFromK", "[", 
              RowBox[{
               RowBox[{"N", "@", "FHMMNa"}], ",", 
               RowBox[{"N", "@", "FHMMNd"}], ",", 
               RowBox[{"N", "@", 
                RowBox[{"Flatten", "@", "Km"}]}]}], "]"}], ",", 
             RowBox[{"FPMLHGetLikelihoodPeqFromK", "[", 
              RowBox[{"N", "@", "Km"}], "]"}]}], "]"}], ",", 
           RowBox[{
            RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
            "FHMMTraceWise"}], "\[IndentingNewLine]", ",", 
           RowBox[{"If", "[", 
            RowBox[{"FHMMGlobalRates", ",", 
             RowBox[{"FPMLHGetLikelihood", "[", 
              RowBox[{
               RowBox[{"N", "@", "FHMMNa"}], ",", 
               RowBox[{"N", "@", "FHMMNd"}], ",", 
               RowBox[{"N", "@", 
                RowBox[{"Flatten", "@", "Km"}]}]}], "]"}], ",", 
             RowBox[{"FPMLHGetLikelihood", "[", 
              RowBox[{
               RowBox[{"N", "@", 
                RowBox[{"Flatten", "@", "Km"}]}], ",", 
               RowBox[{"Length", "[", "Km", "]"}]}], "]"}]}], "]"}], ",", 
           "\[IndentingNewLine]", "True", "\[IndentingNewLine]", ",", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"Message", "[", 
              RowBox[{"FHMMLogLikelihood", "::", "erroptval"}], "]"}], ";", 
             RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
          "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", ",", 
       "True", ",", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"FHMMLogLikelihood", "::", "noinit"}], "]"}], ";", 
         RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
      "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", "lh"}]}], 
   "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FFretHMMLogLikelihood", "[", 
   RowBox[{
    RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], ",", " ", 
    RowBox[{"rateparams", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"_", "?", "NumericQ"}], ",", " ", 
             RowBox[{"_", "?", "NumericQ"}], ",", " ", 
             RowBox[{"_", "?", "NumericQ"}]}], "}"}], ".."}], "}"}], ",", " ", 
         RowBox[{"_", "?", "NumericQ"}], ",", " ", 
         RowBox[{"_", "?", "NumericQ"}]}], "}"}], ".."}], "}"}]}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "lh", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"FFretHMMSetPhotonRates", "[", "photonrates", "]"}], "===", 
        "$Failed"}], ",", 
       RowBox[{"Return", "[", "$Failed", "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"FFretHMMLogLikelihood", "[", "Km", "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->{{3.749467521023334*^9, 3.749467556934556*^9}, {
   3.749467590913252*^9, 3.7494675915096474`*^9}, {3.7494681936954703`*^9, 
   3.7494682213066154`*^9}, 3.7494682554626927`*^9, {3.749529268800666*^9, 
   3.7495292719193797`*^9}, {3.7495293260097322`*^9, 3.7495293593465*^9}, {
   3.7495293903785048`*^9, 3.749529403858449*^9}, {3.749529434522078*^9, 
   3.749529435655052*^9}, {3.7495295323891997`*^9, 3.7495295855859027`*^9}, {
   3.7495296195689726`*^9, 3.7495296351703873`*^9}, 3.74952970359116*^9, {
   3.7495297632394404`*^9, 3.7495297792346463`*^9}, {3.749529828519842*^9, 
   3.749529837228266*^9}, {3.749530122952064*^9, 3.7495301951280766`*^9}, {
   3.749530505387927*^9, 3.749530519654763*^9}, {3.7495305557871227`*^9, 
   3.749530586543863*^9}, {3.7495307227864676`*^9, 3.749530753269283*^9}, {
   3.749530885149269*^9, 3.749530925975073*^9}, {3.749531133021701*^9, 
   3.7495312097185216`*^9}, {3.7495312715243855`*^9, 3.749531276779001*^9}, {
   3.749531332335064*^9, 3.749531384034936*^9}, {3.7495314295108967`*^9, 
   3.7495314589540577`*^9}, 3.749531551168411*^9, {3.7495316070469584`*^9, 
   3.7495316178580513`*^9}, {3.7495319139867163`*^9, 
   3.7495319475656977`*^9}, {3.7495324345643153`*^9, 3.7495324585231905`*^9}, 
   3.749533415585991*^9, {3.7495352784994035`*^9, 3.749535292553809*^9}, 
   3.749536428731695*^9, {3.749536879415386*^9, 3.749536880993176*^9}, {
   3.7495374022673163`*^9, 3.7495374090352182`*^9}, {3.7495481887678685`*^9, 
   3.7495482162583447`*^9}, 3.74954869938413*^9, 3.7495487390520487`*^9, {
   3.749548844666698*^9, 3.74954887240451*^9}, {3.749549039873412*^9, 
   3.74954908108419*^9}, {3.7497911227223296`*^9, 3.7497911814861617`*^9}, {
   3.74998190709044*^9, 3.749981907200118*^9}, {3.750146880567348*^9, 
   3.7501469853998375`*^9}, {3.750147036686735*^9, 3.750147088691083*^9}, {
   3.7501471886671658`*^9, 3.7501471975737696`*^9}, {3.7501472441762934`*^9, 
   3.7501472539293036`*^9}, {3.7501473287622795`*^9, 
   3.7501473349267635`*^9}, {3.7501474057809353`*^9, 
   3.7501474378424373`*^9}, {3.7501477808749104`*^9, 3.7501477925586605`*^9}, 
   3.750149000247304*^9, {3.750149916087717*^9, 3.7501499621706276`*^9}, {
   3.750149992561561*^9, 3.750150017500571*^9}, {3.7501500647691455`*^9, 
   3.7501500679459343`*^9}, {3.7501510691240573`*^9, 
   3.7501510953964014`*^9}, {3.751196023225656*^9, 3.751196032326316*^9}, {
   3.751196866791787*^9, 3.75119687813146*^9}, {3.751196916050259*^9, 
   3.7511969213384104`*^9}, 3.752920024613032*^9, 3.752920082843291*^9, {
   3.7529201513855333`*^9, 3.752920193843111*^9}, {3.7638872836703634`*^9, 
   3.7638872947218046`*^9}, {3.7638873273998203`*^9, 3.763887335984869*^9}, {
   3.7638892326579385`*^9, 3.763889482629815*^9}, {3.7638895514527955`*^9, 
   3.763889612069629*^9}, 3.7638897405500326`*^9, 3.763892196259951*^9, 
   3.7638928942039456`*^9, {3.763892940437291*^9, 3.763892957462756*^9}, {
   3.7640627455700035`*^9, 3.76406275743629*^9}, 3.7643083924618936`*^9, {
   3.778309915391262*^9, 
   3.778309923676111*^9}},ExpressionUUID->"496ef6b6-0d5a-42b1-b828-\
c5b192bba341"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FretBinnedViterbiPeqFromK", "[", 
   RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "tr", "}"}], ",", 
    RowBox[{"tr", "=", 
     RowBox[{
      RowBox[{"FFretPHmmViterbiPeqFromK", "[", 
       RowBox[{
        RowBox[{"FFretHmmBinning", "*", 
         RowBox[{"N", "@", 
          RowBox[{"Flatten", "@", "Km"}]}]}], ",", 
        RowBox[{"Length", "[", "Km", "]"}]}], "]"}], "/.", 
      RowBox[{
       RowBox[{"FDwell", "[", 
        RowBox[{"t_", ",", "s_", ",", "dt_", ",", "p___"}], "]"}], ":>", 
       RowBox[{"FDwell", "[", 
        RowBox[{
         RowBox[{"FFretHmmBinning", "*", "t"}], ",", "s", ",", 
         RowBox[{"FFretHmmBinning", "*", "dt"}], ",", "p"}], "]"}]}]}]}]}], 
   "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FretBinnedViterbi", "[", 
   RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "tr", "}"}], ",", 
    RowBox[{"tr", "=", 
     RowBox[{
      RowBox[{"FFretPHmmViterbi", "[", 
       RowBox[{
        RowBox[{"FFretHmmBinning", "*", 
         RowBox[{"N", "@", 
          RowBox[{"Flatten", "@", "Km"}]}]}], ",", 
        RowBox[{"Length", "[", "Km", "]"}]}], "]"}], "/.", 
      RowBox[{
       RowBox[{"FDwell", "[", 
        RowBox[{"t_", ",", "s_", ",", "dt_", ",", "p___"}], "]"}], ":>", 
       RowBox[{"FDwell", "[", 
        RowBox[{
         RowBox[{"FFretHmmBinning", "*", "t"}], ",", "s", ",", 
         RowBox[{"FFretHmmBinning", "*", "dt"}], ",", "p"}], "]"}]}]}]}]}], 
   "]"}]}], "\n"}], "Input",
 CellChangeTimes->{{3.752920394857087*^9, 3.752920408164277*^9}, {
  3.7638922662358365`*^9, 3.763892302389845*^9}, {3.763892346808017*^9, 
  3.7638923725870557`*^9}},ExpressionUUID->"1d1d8613-8d17-4ce1-8703-\
3016d587824d"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FFretHMMViterbi", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"FHMMpinpfin", "->", "FHMMPeqOne"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FFretHMMViterbi", "[", 
   RowBox[{
    RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "statetrajectory", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Length", "[", "Km", "]"}], "!=", "FFretHMMStateCount"}], ",", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"FHMMViterbi", "::", "dimerr"}], "]"}], ";", 
         RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Which", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"FFretHMMmode", "===", "FHMMBinned"}], "\[IndentingNewLine]", 
       ",", 
       RowBox[{"statetrajectory", "=", "\[IndentingNewLine]", 
        RowBox[{"Which", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
           "FHMMPeqOne"}], "\[IndentingNewLine]", ",", 
          RowBox[{"If", "[", 
           RowBox[{"FFretHMMGlobalRates", ",", 
            RowBox[{"FretBinnedViterbiPeqFromK", "[", "Km", "]"}], ",", 
            RowBox[{"BinnedViterbiPeqFromK", "[", "Km", "]"}]}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
           "FHMMTraceWise"}], "\[IndentingNewLine]", ",", 
          RowBox[{"FretBinnedViterbi", "[", "Km", "]"}], ",", 
          "\[IndentingNewLine]", "True", "\[IndentingNewLine]", ",", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"Message", "[", 
             RowBox[{"FHMMViterbi", "::", "erroptval"}], "]"}], ";", 
            RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
         "\[IndentingNewLine]", "]"}]}], ",", "\[IndentingNewLine]", 
       RowBox[{"FFretHMMmode", "===", "FHMMPhotonByPhoton"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"statetrajectory", "=", "\[IndentingNewLine]", 
        RowBox[{"Which", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
           "FHMMPeqOne"}], "\[IndentingNewLine]", ",", 
          RowBox[{"FPMLHViterbiPeqFromK", "[", 
           RowBox[{"N", "@", "Km"}], "]"}], ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
           "FHMMTraceWise"}], "\[IndentingNewLine]", ",", 
          RowBox[{"FPMLHViterbi", "[", 
           RowBox[{"N", "@", "Km"}], "]"}], ",", "\[IndentingNewLine]", 
          "True", "\[IndentingNewLine]", ",", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"Message", "[", 
             RowBox[{"FHMMViterbi", "::", "erroptval"}], "]"}], ";", 
            RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
         "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", ",", "True", 
       ",", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"FHMMViterbi", "::", "noinit"}], "]"}], ";", 
         RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
      "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
     "statetrajectory"}]}], "\[IndentingNewLine]", 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FFretHMMViterbi", "[", 
   RowBox[{
    RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], ",", " ", "photonrates_", 
    ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "lh", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"FFretHMMSetPhotonRates", "[", "photonrates", "]"}], "===", 
        "$Failed"}], ",", 
       RowBox[{"Return", "[", "$Failed", "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"FFretHMMViterbi", "[", "Km", "]"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.749467521023334*^9, 3.749467556934556*^9}, {
   3.749467590913252*^9, 3.7494675915096474`*^9}, {3.7494681936954703`*^9, 
   3.7494682213066154`*^9}, 3.7494682554626927`*^9, {3.749529268800666*^9, 
   3.7495292719193797`*^9}, {3.7495293260097322`*^9, 3.7495293593465*^9}, {
   3.7495293903785048`*^9, 3.749529403858449*^9}, {3.749529434522078*^9, 
   3.749529435655052*^9}, {3.7495295323891997`*^9, 3.7495295855859027`*^9}, {
   3.7495296195689726`*^9, 3.7495296351703873`*^9}, 3.74952970359116*^9, {
   3.7495297632394404`*^9, 3.7495297792346463`*^9}, {3.749529828519842*^9, 
   3.749529837228266*^9}, {3.749530122952064*^9, 3.7495301951280766`*^9}, {
   3.749530505387927*^9, 3.749530519654763*^9}, {3.7495305557871227`*^9, 
   3.749530586543863*^9}, {3.7495307227864676`*^9, 3.749530753269283*^9}, {
   3.749530885149269*^9, 3.749530925975073*^9}, {3.749531133021701*^9, 
   3.7495312097185216`*^9}, {3.7495312715243855`*^9, 3.749531276779001*^9}, {
   3.749531332335064*^9, 3.749531384034936*^9}, {3.7495314295108967`*^9, 
   3.7495314589540577`*^9}, 3.749531551168411*^9, {3.7495316070469584`*^9, 
   3.7495316178580513`*^9}, {3.7495319139867163`*^9, 
   3.7495319475656977`*^9}, {3.7495324345643153`*^9, 3.7495324585231905`*^9}, 
   3.749533415585991*^9, {3.7495352784994035`*^9, 3.749535292553809*^9}, 
   3.749536428731695*^9, {3.749536879415386*^9, 3.749536880993176*^9}, {
   3.749536922761497*^9, 3.7495369314103165`*^9}, 3.7495370533671722`*^9, 
   3.7495371182893276`*^9, {3.749537231776632*^9, 3.7495372592348585`*^9}, {
   3.749537333768547*^9, 3.74953739237178*^9}, {3.74954910520767*^9, 
   3.7495491150663023`*^9}, {3.749791241417869*^9, 3.749791282805175*^9}, {
   3.7499819072061048`*^9, 3.7499819072789097`*^9}, {3.7501488626685553`*^9, 
   3.750148936013038*^9}, {3.750149024512638*^9, 3.750149113678056*^9}, {
   3.7501491691338305`*^9, 3.7501492309135566`*^9}, {3.7501493038348193`*^9, 
   3.750149323812806*^9}, 3.7501493671622295`*^9, {3.7501494011281652`*^9, 
   3.7501494248627205`*^9}, 3.750149507116145*^9, {3.7501502008580713`*^9, 
   3.750150214569867*^9}, {3.7529204436743245`*^9, 3.752920452052907*^9}, {
   3.7529295350295134`*^9, 3.7529295470896187`*^9}, 3.754209490016601*^9, 
   3.761050895677702*^9, {3.763892381818365*^9, 3.7638924319472895`*^9}, 
   3.763892515316313*^9, {3.763892557987232*^9, 3.7638925756050644`*^9}, {
   3.7638926134279027`*^9, 3.7638926249301453`*^9}, {3.7783240990218515`*^9, 
   3.7783241055474052`*^9}, {3.7783241400721426`*^9, 
   3.7783241449221516`*^9}},ExpressionUUID->"a10bcaad-3358-4cef-bd8c-\
771baa8ce987"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FFretHMMForwardBackward", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"FHMMpinpfin", "->", "FHMMPeqOne"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FFretHMMForwardBackward", "[", 
   RowBox[{
    RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "statetrajectory", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Length", "[", "Km", "]"}], "!=", "FFretHMMStateCount"}], ",", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"FHMMViterbi", "::", "dimerr"}], "]"}], ";", 
         RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Which", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"FFretHMMmode", "===", "FHMMBinned"}], "\[IndentingNewLine]", 
       ",", 
       RowBox[{"statetrajectory", "=", "\[IndentingNewLine]", 
        RowBox[{"Which", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
           "FHMMPeqOne"}], "\[IndentingNewLine]", ",", 
          RowBox[{"If", "[", 
           RowBox[{"FFretHMMGlobalRates", ",", "$False", ",", 
            RowBox[{"FPFretHmmForwardBackwardPeqFromK", "[", 
             RowBox[{
              RowBox[{"FFretHmmBinning", "*", 
               RowBox[{"N", "@", 
                RowBox[{"Flatten", "@", "Km"}]}]}], ",", 
              RowBox[{"Length", "[", "Km", "]"}]}], "]"}]}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
           "FHMMTraceWise"}], "\[IndentingNewLine]", ",", 
          RowBox[{"FPFretHmmForwardBackward", "[", 
           RowBox[{
            RowBox[{"FFretHmmBinning", "*", 
             RowBox[{"N", "@", 
              RowBox[{"Flatten", "@", "Km"}]}]}], ",", 
            RowBox[{"Length", "[", "Km", "]"}]}], "]"}], ",", 
          "\[IndentingNewLine]", "True", "\[IndentingNewLine]", ",", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"Message", "[", 
             RowBox[{"FHMMViterbi", "::", "erroptval"}], "]"}], ";", 
            RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
         "\[IndentingNewLine]", "]"}]}], ",", "\[IndentingNewLine]", 
       RowBox[{"FFretHMMmode", "===", "FHMMPhotonByPhoton"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"statetrajectory", "=", "\[IndentingNewLine]", 
        RowBox[{"Which", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
           "FHMMPeqOne"}], "\[IndentingNewLine]", ",", 
          RowBox[{"FPMLHForwardBackwardiPeqFromK", "[", 
           RowBox[{
            RowBox[{"N", "@", 
             RowBox[{"Flatten", "@", "Km"}]}], ",", 
            RowBox[{"Length", "[", "Km", "]"}]}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
           "FHMMTraceWise"}], "\[IndentingNewLine]", ",", 
          RowBox[{"FPMLHForwardBackward", "[", 
           RowBox[{
            RowBox[{"N", "@", 
             RowBox[{"Flatten", "@", "Km"}]}], ",", 
            RowBox[{"Length", "[", "Km", "]"}]}], "]"}], ",", 
          "\[IndentingNewLine]", "True", "\[IndentingNewLine]", ",", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"Message", "[", 
             RowBox[{"FHMMViterbi", "::", "erroptval"}], "]"}], ";", 
            RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
         "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", ",", "True", 
       ",", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"FHMMViterbi", "::", "noinit"}], "]"}], ";", 
         RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
      "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
     "statetrajectory"}]}], "\[IndentingNewLine]", 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FFretHMMForwardBackward", "[", 
   RowBox[{
    RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], ",", " ", "photonrates_", 
    ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "lh", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"FFretHMMSetPhotonRates", "[", "photonrates", "]"}], "===", 
        "$Failed"}], ",", 
       RowBox[{"Return", "[", "$Failed", "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"FFretHMMForwardBackward", "[", "Km", "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->{{3.749467521023334*^9, 3.749467556934556*^9}, {
   3.749467590913252*^9, 3.7494675915096474`*^9}, {3.7494681936954703`*^9, 
   3.7494682213066154`*^9}, 3.7494682554626927`*^9, {3.749529268800666*^9, 
   3.7495292719193797`*^9}, {3.7495293260097322`*^9, 3.7495293593465*^9}, {
   3.7495293903785048`*^9, 3.749529403858449*^9}, {3.749529434522078*^9, 
   3.749529435655052*^9}, {3.7495295323891997`*^9, 3.7495295855859027`*^9}, {
   3.7495296195689726`*^9, 3.7495296351703873`*^9}, 3.74952970359116*^9, {
   3.7495297632394404`*^9, 3.7495297792346463`*^9}, {3.749529828519842*^9, 
   3.749529837228266*^9}, {3.749530122952064*^9, 3.7495301951280766`*^9}, {
   3.749530505387927*^9, 3.749530519654763*^9}, {3.7495305557871227`*^9, 
   3.749530586543863*^9}, {3.7495307227864676`*^9, 3.749530753269283*^9}, {
   3.749530885149269*^9, 3.749530925975073*^9}, {3.749531133021701*^9, 
   3.7495312097185216`*^9}, {3.7495312715243855`*^9, 3.749531276779001*^9}, {
   3.749531332335064*^9, 3.749531384034936*^9}, {3.7495314295108967`*^9, 
   3.7495314589540577`*^9}, 3.749531551168411*^9, {3.7495316070469584`*^9, 
   3.7495316178580513`*^9}, {3.7495319139867163`*^9, 
   3.7495319475656977`*^9}, {3.7495324345643153`*^9, 3.7495324585231905`*^9}, 
   3.749533415585991*^9, {3.7495352784994035`*^9, 3.749535292553809*^9}, 
   3.749536428731695*^9, {3.749536879415386*^9, 3.749536880993176*^9}, {
   3.749536922761497*^9, 3.7495369314103165`*^9}, 3.7495370533671722`*^9, 
   3.7495371182893276`*^9, {3.749537231776632*^9, 3.7495372592348585`*^9}, {
   3.749537333768547*^9, 3.74953739237178*^9}, {3.74954910520767*^9, 
   3.7495491150663023`*^9}, {3.749791241417869*^9, 3.749791282805175*^9}, {
   3.7499819072061048`*^9, 3.7499819072789097`*^9}, {3.7501488626685553`*^9, 
   3.750148936013038*^9}, {3.750149024512638*^9, 3.750149113678056*^9}, {
   3.7501491691338305`*^9, 3.7501492309135566`*^9}, {3.7501493038348193`*^9, 
   3.750149323812806*^9}, 3.7501493671622295`*^9, {3.7501494011281652`*^9, 
   3.7501494248627205`*^9}, 3.750149507116145*^9, {3.7501502008580713`*^9, 
   3.750150214569867*^9}, {3.7529204436743245`*^9, 3.752920452052907*^9}, {
   3.7529295350295134`*^9, 3.7529295470896187`*^9}, 3.754209490016601*^9, {
   3.761050645481476*^9, 3.761050696968856*^9}, 3.7610509210927677`*^9, {
   3.761050968923918*^9, 3.7610510205668745`*^9}, {3.7610511911738443`*^9, 
   3.7610512000501204`*^9}, {3.763892659884699*^9, 
   3.7638927498251038`*^9}},ExpressionUUID->"3c26bd06-56ae-4fcf-82d6-\
7d39c58d6b29"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FFretHMMSimulateBinnedTrace", "[", 
   RowBox[{
    RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], ",", " ", 
    RowBox[{"rateparams", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumericQ"}], ",", " ", 
         RowBox[{"_", "?", "NumericQ"}], ",", " ", 
         RowBox[{"_", "?", "NumericQ"}], ",", " ", 
         RowBox[{"_", "?", "NumericQ"}], ",", " ", 
         RowBox[{"_", "?", "NumericQ"}]}], "}"}], ".."}], "}"}]}], ",", 
    "Smax_Integer", ",", 
    RowBox[{"t_", "?", "NumericQ"}], ",", " ", 
    RowBox[{"binning_", "?", "NumericQ"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "Fmean", ",", "mu", ",", "nu", ",", "bgA", ",", "bgD", ",", "length", 
      ",", "dat"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"Fmean", ",", "mu", ",", "nu", ",", "bgA", ",", "bgD"}], "}"}],
       "=", 
      RowBox[{"rateparams", "\[Transpose]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"length", "=", 
      RowBox[{"Round", "[", 
       RowBox[{"t", "/", "binning"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"dat", "=", 
      RowBox[{"FPFretHmmSimulateTrajectoryPeqFromK", "[", 
       RowBox[{"length", ",", "Smax", ",", 
        RowBox[{
         RowBox[{"N", "@", "binning"}], "*", 
         RowBox[{"Flatten", "@", "bgA"}]}], ",", 
        RowBox[{
         RowBox[{"N", "@", "binning"}], "*", 
         RowBox[{"Flatten", "@", "bgD"}]}], ",", 
        RowBox[{
         RowBox[{"N", "@", "binning"}], "*", 
         RowBox[{"Flatten", "@", "Fmean"}]}], ",", 
        RowBox[{"N", "@", 
         RowBox[{"Flatten", "@", "mu"}]}], ",", 
        RowBox[{"N", "@", 
         RowBox[{"Flatten", "@", "nu"}]}], ",", 
        RowBox[{"binning", "*", 
         RowBox[{"N", "@", 
          RowBox[{"Flatten", "@", "Km"}]}]}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"dat", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", 
          RowBox[{"1", ";;", "2"}]}], "]"}], "]"}], ",", 
       RowBox[{"dat", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "3"}], "]"}], "]"}]}], "}"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.7639773468967724`*^9, 3.7639773730934997`*^9}, {
   3.7639774570062294`*^9, 3.7639774944655375`*^9}, {3.763977527376547*^9, 
   3.7639775806530976`*^9}, {3.7639776302993917`*^9, 3.763977651360569*^9}, {
   3.763977708359214*^9, 3.7639777091261587`*^9}, {3.7639777445215445`*^9, 
   3.763977773435787*^9}, {3.763977866583568*^9, 3.763977875905648*^9}, {
   3.76398393511434*^9, 3.763983947586006*^9}, {3.7640684583731246`*^9, 
   3.7640685776453133`*^9}, {3.7640686150393553`*^9, 3.7640686206633224`*^9}, 
   3.76431569853681*^9, 3.76431592706695*^9, {3.7643248375680456`*^9, 
   3.7643248872801647`*^9}},ExpressionUUID->"c8311786-1064-42ce-98c2-\
5389d7ad8a0f"]
}, Closed]],

Cell[CellGroupData[{

Cell["1D HMM commands", "Subsubsection",
 CellChangeTimes->{{3.7494544408115234`*^9, 3.749454452559103*^9}, {
  3.7616451658102226`*^9, 
  3.761645166456732*^9}},ExpressionUUID->"dc5b1a7a-1fe7-44af-b1d8-\
d8e0d950091d"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"F1DHMMBinning", "=", "1."}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"F1DHMMmode", "=", "None"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"F1DHMMTrajectoryCount", "=", "0"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"F1DHMMStateCount", "=", "0"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"F1DHMMGlobalPobs", "=", "False"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"F1DHMMPobs", "=", 
   RowBox[{"{", "}"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.749466891328204*^9, 3.7494669049603567`*^9}, {
   3.749467005772902*^9, 3.7494670232095947`*^9}, {3.7494676232807198`*^9, 
   3.749467657154451*^9}, {3.7494678877648816`*^9, 3.749467917318637*^9}, {
   3.749468076795555*^9, 3.749468108091424*^9}, {3.749981906934828*^9, 
   3.7499819069487925`*^9}, {3.7501481401679487`*^9, 
   3.7501481452912493`*^9}, {3.7501497107406206`*^9, 3.750149715913785*^9}, {
   3.7529205203288183`*^9, 3.7529205243969293`*^9}, {3.761645307275818*^9, 
   3.761645314396783*^9}, 3.761645557322358*^9, {3.76164664294862*^9, 
   3.761646673153867*^9}, {3.761648388205434*^9, 3.7616483991786613`*^9}, {
   3.7616485757028804`*^9, 
   3.7616486069333754`*^9}},ExpressionUUID->"3ad75544-6460-4d95-ba23-\
59eae3084a87"],

Cell[BoxData[
 RowBox[{
  RowBox[{"F1DHMMInit", "[", 
   RowBox[{
    RowBox[{"observations", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"_Integer", ".."}], "}"}], ".."}], "}"}]}], ",", 
    RowBox[{"Tbinning_", "?", "NumericQ"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"F1DHMMBinning", "=", "Tbinning"}], ";", "\[IndentingNewLine]", 
     RowBox[{"FPHmm1DClearTrajectoryList", "[", "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"Map", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"FPHmm1DAppendTrajectory", "[", "#", "]"}], "&"}], ",", 
       "observations"}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"F1DHMMTrajectoryCount", "=", 
      RowBox[{"Length", "[", "observations", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"F1DHMMStateCount", "=", "0"}], ";"}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.7494661201885214`*^9, 3.749466120532586*^9}, {
   3.749466161046032*^9, 3.7494662052479744`*^9}, {3.749466287389041*^9, 
   3.7494663459640927`*^9}, {3.7494664027681656`*^9, 
   3.7494665253417253`*^9}, {3.7494668457956057`*^9, 
   3.7494668736904063`*^9}, {3.749467030735467*^9, 3.7494670541789494`*^9}, 
   3.749467752422865*^9, {3.7495336861652555`*^9, 3.74953373240164*^9}, {
   3.749533821786525*^9, 3.7495338871610546`*^9}, 3.7495469326926785`*^9, {
   3.749549558536272*^9, 3.749549563590763*^9}, {3.7499819069527817`*^9, 
   3.7499819069777136`*^9}, {3.749986186962763*^9, 3.7499862226812525`*^9}, {
   3.750148204514877*^9, 3.7501482285405917`*^9}, {3.7501497996563396`*^9, 
   3.7501498032736645`*^9}, {3.7529194625061884`*^9, 
   3.7529194698676977`*^9}, {3.752919609214021*^9, 3.7529196514660215`*^9}, {
   3.752919688349354*^9, 3.7529197190641994`*^9}, {3.7529197517084403`*^9, 
   3.7529198488925*^9}, {3.7616453151708035`*^9, 3.761645320411231*^9}, 
   3.761645568418967*^9, {3.7616456145117865`*^9, 3.7616456166500463`*^9}, {
   3.7616456589325757`*^9, 3.7616457534024286`*^9}, {3.7616458965016823`*^9, 
   3.761645911576521*^9}, 3.761646475814639*^9, {3.7616466804663305`*^9, 
   3.7616466807735214`*^9}},ExpressionUUID->"4d3b239b-1afb-4163-b43d-\
319453f3ccdb"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"F1DHMMSetPobs", "[", 
   RowBox[{"pobs", ":", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"_", "?", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"MatrixQ", "[", 
          RowBox[{"#", ",", "NumericQ"}], "]"}], "&"}], ")"}]}], " ", ".."}], 
     "}"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"FPHmm1DClearPobsList", "[", "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Map", "[", 
      RowBox[{"FPHmm1DAppendPobs", ",", 
       RowBox[{"N", "@", "pobs"}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"F1DHMMStateCount", "=", 
      RowBox[{"Length", "[", 
       RowBox[{"pobs", "[", 
        RowBox[{"[", "1", "]"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"F1DHMMGlobalPobs", "=", "False"}], ";"}]}], 
   "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"F1DHMMSetPobs", "[", 
   RowBox[{"pobs_", "?", 
    RowBox[{"(", 
     RowBox[{
      RowBox[{"MatrixQ", "[", 
       RowBox[{"#", ",", "NumericQ"}], "]"}], "&"}], ")"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"FPHmm1DClearPobsList", "[", "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{"FPHmm1DAppendPobs", "[", 
        RowBox[{"N", "@", "pobs"}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", "F1DHMMTrajectoryCount"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"F1DHMMStateCount", "=", 
      RowBox[{"Length", "[", "pobs", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"F1DHMMGlobalPobs", "=", "True"}], ";", "\[IndentingNewLine]", 
     RowBox[{"F1DHMMPobs", "=", "pobs"}], ";"}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.7494661201885214`*^9, 3.749466120532586*^9}, {
   3.749466161046032*^9, 3.7494662052479744`*^9}, {3.749466287389041*^9, 
   3.7494663459640927`*^9}, {3.7494664027681656`*^9, 
   3.7494665253417253`*^9}, {3.7494668457956057`*^9, 
   3.7494668736904063`*^9}, {3.749467030735467*^9, 3.7494670541789494`*^9}, 
   3.749467752422865*^9, {3.7495336861652555`*^9, 3.74953373240164*^9}, {
   3.749533821786525*^9, 3.7495338871610546`*^9}, 3.7495469326926785`*^9, {
   3.749549558536272*^9, 3.749549563590763*^9}, {3.7499819069527817`*^9, 
   3.7499819069777136`*^9}, {3.749986186962763*^9, 3.7499862226812525`*^9}, {
   3.750148204514877*^9, 3.7501482285405917`*^9}, {3.7501497996563396`*^9, 
   3.7501498032736645`*^9}, {3.7529194625061884`*^9, 
   3.7529194698676977`*^9}, {3.752919609214021*^9, 3.7529196514660215`*^9}, {
   3.752919688349354*^9, 3.7529197190641994`*^9}, {3.7529197517084403`*^9, 
   3.7529198488925*^9}, {3.7616453151708035`*^9, 3.761645320411231*^9}, 
   3.761645568418967*^9, {3.7616456145117865`*^9, 3.7616456166500463`*^9}, {
   3.7616456589325757`*^9, 3.7616457534024286`*^9}, {3.76164587668262*^9, 
   3.76164588483582*^9}, {3.7616459211868315`*^9, 3.761645964937579*^9}, {
   3.761645997484568*^9, 3.7616460197098303`*^9}, {3.761646159242313*^9, 
   3.761646373147603*^9}, {3.7616464036330996`*^9, 3.761646486347515*^9}, {
   3.7616467018920507`*^9, 3.7616467315248413`*^9}, {3.761648148305805*^9, 
   3.761648181090171*^9}, {3.7616484153564596`*^9, 3.7616484872318506`*^9}, {
   3.7616485591182146`*^9, 3.7616485603297834`*^9}, {3.761648621823777*^9, 
   3.761648628456996*^9}, {3.7626033290321827`*^9, 3.7626033391157603`*^9}, {
   3.811825481216386*^9, 3.8118254887622023`*^9}, {3.8118258663966155`*^9, 
   3.8118259679729085`*^9}, {3.8118260593335156`*^9, 
   3.8118261319653363`*^9}},ExpressionUUID->"7adaeb42-f6d0-44a2-9dba-\
ce9fd5bd26ea"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"F1DHMMSetPinPfin", "[", 
    RowBox[{"pinpfin", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], "}"}], ".."}], 
      "}"}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "nstates", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"nstates", "=", 
       RowBox[{"Length", "[", 
        RowBox[{"pinpfin", "[", 
         RowBox[{"[", 
          RowBox[{"1", ",", "1"}], "]"}], "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"AnyTrue", "[", 
         RowBox[{"pinpfin", ",", 
          RowBox[{
           RowBox[{
            RowBox[{"Length", "[", "#", "]"}], "\[NotEqual]", "nstates"}], 
           "&"}], ",", "2"}], "]"}], ",", 
        RowBox[{"Return", "[", "$Failed", "]"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"F1DHMMGlobalPobs", "=", "False"}], ";", "\[IndentingNewLine]", 
      RowBox[{"FPHmm1DAppendPobs", "[", 
       RowBox[{
        RowBox[{"N", "@", 
         RowBox[{"pinpfin", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ",", 
        RowBox[{"N", "@", 
         RowBox[{"pinpfin", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "2"}], "]"}], "]"}]}]}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], "\n"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"F1DHMMSetPinPfin", "[", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"pin", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], ",", " ", 
     RowBox[{"pfin", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}]}], "}"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"Length", "[", "pin", "]"}], "!=", "F1DHMMStateCount"}], " ",
         "||", " ", 
        RowBox[{
         RowBox[{"Length", "[", "pfin", "]"}], "!=", "F1DHMMStateCount"}]}], 
       ",", 
       RowBox[{"Return", "[", "$Failed", "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"F1DHMMSetPinPfin", "[", 
      RowBox[{"ConstantArray", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"pin", ",", "pfin"}], "}"}], ",", "F1DHMMTrajectoryCount"}], 
       "]"}], "]"}], ";"}]}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   "]"}]}], "\[IndentingNewLine]"}], "Input",
 CellChangeTimes->{{3.8120910928836145`*^9, 3.8120911248281293`*^9}, {
   3.8120911826295166`*^9, 3.8120912009495335`*^9}, {3.812091275179532*^9, 
   3.812091344338542*^9}, 3.812091394946243*^9, 
   3.8121765515836635`*^9},ExpressionUUID->"b4ce0d3c-1678-4d7d-9954-\
23bdd0e81373"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "F1DHMMLogLikelihood", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"FHMMpinpfin", "->", "FHMMPeqOne"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"F1DHMMLogLikelihood", "[", 
   RowBox[{
    RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "lh", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Length", "[", "Km", "]"}], "!=", "F1DHMMStateCount"}], ",", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"F1DHMMLogLikelihood", "::", "dimerr"}], "]"}], ";", 
         RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"lh", "=", 
      RowBox[{"Which", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
         "FHMMPeqOne"}], "\[IndentingNewLine]", ",", 
        RowBox[{"If", "[", 
         RowBox[{"F1DHMMGlobalPobs", ",", " ", 
          RowBox[{"FPHmm1DGetLikelihoodPeqFromKGlobalPobs", "[", 
           RowBox[{
            RowBox[{"F1DHMMBinning", "*", 
             RowBox[{"N", "@", "Km"}]}], ",", 
            RowBox[{"N", "@", "F1DHMMPobs"}]}], "]"}], ",", 
          RowBox[{"FPHmm1DGetLikelihoodPeqFromK", "[", 
           RowBox[{"F1DHMMBinning", "*", 
            RowBox[{"N", "@", "Km"}]}], "]"}]}], "]"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
         "FHMMTraceWise"}], "\[IndentingNewLine]", ",", 
        RowBox[{"FPHmm1DGetLikelihood", "[", 
         RowBox[{"F1DHMMBinning", "*", 
          RowBox[{"N", "@", "Km"}]}], "]"}], ",", "\[IndentingNewLine]", 
        "True", "\[IndentingNewLine]", ",", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Message", "[", 
           RowBox[{"F1DHMMLogLikelihood", "::", "erroptval"}], "]"}], ";", 
          RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
       "\[IndentingNewLine]", "]"}]}], ";", "\[IndentingNewLine]", "lh"}]}], 
   "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"F1DHMMLogLikelihood", "[", 
   RowBox[{
    RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], ",", " ", 
    RowBox[{"pobs", ":", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"MatrixQ", "[", 
            RowBox[{"#", ",", "NumericQ"}], "]"}], "&"}], ")"}]}], " ", 
        ".."}], "}"}], "|", 
      RowBox[{"_", "?", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"MatrixQ", "[", 
          RowBox[{"#", ",", "NumericQ"}], "]"}], "&"}], ")"}]}]}]}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "lh", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"F1DHMMSetPobs", "[", "pobs", "]"}], "===", "$Failed"}], ",", 
       RowBox[{"Return", "[", "$Failed", "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"F1DHMMLogLikelihood", "[", "Km", "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->{{3.749467521023334*^9, 3.749467556934556*^9}, {
   3.749467590913252*^9, 3.7494675915096474`*^9}, {3.7494681936954703`*^9, 
   3.7494682213066154`*^9}, 3.7494682554626927`*^9, {3.749529268800666*^9, 
   3.7495292719193797`*^9}, {3.7495293260097322`*^9, 3.7495293593465*^9}, {
   3.7495293903785048`*^9, 3.749529403858449*^9}, {3.749529434522078*^9, 
   3.749529435655052*^9}, {3.7495295323891997`*^9, 3.7495295855859027`*^9}, {
   3.7495296195689726`*^9, 3.7495296351703873`*^9}, 3.74952970359116*^9, {
   3.7495297632394404`*^9, 3.7495297792346463`*^9}, {3.749529828519842*^9, 
   3.749529837228266*^9}, {3.749530122952064*^9, 3.7495301951280766`*^9}, {
   3.749530505387927*^9, 3.749530519654763*^9}, {3.7495305557871227`*^9, 
   3.749530586543863*^9}, {3.7495307227864676`*^9, 3.749530753269283*^9}, {
   3.749530885149269*^9, 3.749530925975073*^9}, {3.749531133021701*^9, 
   3.7495312097185216`*^9}, {3.7495312715243855`*^9, 3.749531276779001*^9}, {
   3.749531332335064*^9, 3.749531384034936*^9}, {3.7495314295108967`*^9, 
   3.7495314589540577`*^9}, 3.749531551168411*^9, {3.7495316070469584`*^9, 
   3.7495316178580513`*^9}, {3.7495319139867163`*^9, 
   3.7495319475656977`*^9}, {3.7495324345643153`*^9, 3.7495324585231905`*^9}, 
   3.749533415585991*^9, {3.7495352784994035`*^9, 3.749535292553809*^9}, 
   3.749536428731695*^9, {3.749536879415386*^9, 3.749536880993176*^9}, {
   3.7495374022673163`*^9, 3.7495374090352182`*^9}, {3.7495481887678685`*^9, 
   3.7495482162583447`*^9}, 3.74954869938413*^9, 3.7495487390520487`*^9, {
   3.749548844666698*^9, 3.74954887240451*^9}, {3.749549039873412*^9, 
   3.74954908108419*^9}, {3.7497911227223296`*^9, 3.7497911814861617`*^9}, {
   3.74998190709044*^9, 3.749981907200118*^9}, {3.750146880567348*^9, 
   3.7501469853998375`*^9}, {3.750147036686735*^9, 3.750147088691083*^9}, {
   3.7501471886671658`*^9, 3.7501471975737696`*^9}, {3.7501472441762934`*^9, 
   3.7501472539293036`*^9}, {3.7501473287622795`*^9, 
   3.7501473349267635`*^9}, {3.7501474057809353`*^9, 
   3.7501474378424373`*^9}, {3.7501477808749104`*^9, 3.7501477925586605`*^9}, 
   3.750149000247304*^9, {3.750149916087717*^9, 3.7501499621706276`*^9}, {
   3.750149992561561*^9, 3.750150017500571*^9}, {3.7501500647691455`*^9, 
   3.7501500679459343`*^9}, {3.7501510691240573`*^9, 
   3.7501510953964014`*^9}, {3.751196023225656*^9, 3.751196032326316*^9}, {
   3.751196866791787*^9, 3.75119687813146*^9}, {3.751196916050259*^9, 
   3.7511969213384104`*^9}, 3.752920024613032*^9, 3.752920082843291*^9, {
   3.7529201513855333`*^9, 3.752920193843111*^9}, {3.7616453551025815`*^9, 
   3.7616453870429153`*^9}, 3.761648218725526*^9, {3.761648699172032*^9, 
   3.7616487214894037`*^9}, 3.761648762482998*^9, {3.761648807599227*^9, 
   3.761648863194363*^9}, {3.761648914048678*^9, 3.7616489215247374`*^9}, 
   3.761649058482546*^9, {3.7616490960531535`*^9, 3.7616491379092207`*^9}, 
   3.7616526900244703`*^9, {3.7643144910517454`*^9, 3.764314525924485*^9}, {
   3.8120904658618765`*^9, 3.8120904904571013`*^9}, {3.8120905718065696`*^9, 
   3.812090577444436*^9}},ExpressionUUID->"eabb5d96-2bb9-4ec5-9ddb-\
51fd2b8f60f8"],

Cell[BoxData[
 RowBox[{
  RowBox[{"F1DHMMGetLogLikelihoodList", "[", "]"}], ":=", " ", 
  RowBox[{"FPHmm1DGetLikelihoodList", "[", "]"}]}]], "Input",
 CellChangeTimes->{{3.8462399243250246`*^9, 
  3.846239981759898*^9}},ExpressionUUID->"48f009f8-0c1d-4101-b5b9-\
3867a738da96"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"F1DHMMBinnedViterbiPeqFromK", "[", 
   RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "tr", "}"}], ",", 
    RowBox[{"tr", "=", 
     RowBox[{
      RowBox[{"FPHmm1DViterbiPeqFromK", "[", 
       RowBox[{"F1DHMMBinning", "*", 
        RowBox[{"N", "@", "Km"}]}], "]"}], "/.", 
      RowBox[{
       RowBox[{"FDwell", "[", 
        RowBox[{"t_", ",", "s_", ",", "dt_", ",", "p___"}], "]"}], ":>", 
       RowBox[{"FDwell", "[", 
        RowBox[{
         RowBox[{"F1DHMMBinning", "*", "t"}], ",", "s", ",", 
         RowBox[{"F1DHMMBinning", "*", "dt"}], ",", "p"}], "]"}]}]}]}]}], 
   "]"}]}], "\n", 
 RowBox[{
  RowBox[{"F1DHMMBinnedViterbi", "[", 
   RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "tr", "}"}], ",", 
    RowBox[{"tr", "=", 
     RowBox[{
      RowBox[{"FPHmm1DViterbi", "[", 
       RowBox[{"F1DHMMBinning", "*", 
        RowBox[{"N", "@", "Km"}]}], "]"}], "/.", 
      RowBox[{
       RowBox[{"FDwell", "[", 
        RowBox[{"t_", ",", "s_", ",", "dt_", ",", "p___"}], "]"}], ":>", 
       RowBox[{"FDwell", "[", 
        RowBox[{
         RowBox[{"F1DHMMBinning", "*", "t"}], ",", "s", ",", 
         RowBox[{"F1DHMMBinning", "*", "dt"}], ",", "p"}], "]"}]}]}]}]}], 
   "]"}]}], "\n"}], "Input",
 CellChangeTimes->{{3.752920394857087*^9, 3.752920408164277*^9}, {
   3.761645403319927*^9, 3.7616454100160246`*^9}, {3.7621521358597317`*^9, 
   3.7621521652506094`*^9}, 3.7626039194557247`*^9, {3.762604786524736*^9, 
   3.762604787305935*^9}, {3.812090642400795*^9, 3.812090647972901*^9}, {
   3.8120907008187923`*^9, 
   3.8120907067858367`*^9}},ExpressionUUID->"01361fce-dbf4-42c8-b9f5-\
ddb13d849dd9"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "F1DHMMViterbi", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"FHMMpinpfin", "->", "FHMMPeqOne"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"F1DHMMViterbi", "[", 
   RowBox[{
    RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "statetrajectory", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Length", "[", "Km", "]"}], "!=", "F1DHMMStateCount"}], ",", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"F1DHMMViterbi", "::", "dimerr"}], "]"}], ";", 
         RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"statetrajectory", "=", "\[IndentingNewLine]", 
      RowBox[{"Which", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
         "FHMMPeqOne"}], "\[IndentingNewLine]", ",", 
        RowBox[{"If", "[", 
         RowBox[{"F1DHMMGlobalPobs", ",", 
          RowBox[{"F1DHMMBinnedViterbiPeqFromK", "[", "Km", "]"}], ",", 
          RowBox[{"F1DHMMBinnedViterbiPeqFromK", "[", "Km", "]"}]}], "]"}], 
        ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
         "FHMMTraceWise"}], "\[IndentingNewLine]", ",", 
        RowBox[{"F1DHMMBinnedViterbi", "[", "Km", "]"}], ",", 
        "\[IndentingNewLine]", "True", "\[IndentingNewLine]", ",", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Message", "[", 
           RowBox[{"F1DHMMViterbi", "::", "erroptval"}], "]"}], ";", 
          RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
       "\[IndentingNewLine]", "]"}]}], ";", "\[IndentingNewLine]", 
     "statetrajectory"}]}], "\[IndentingNewLine]", 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"F1DHMMViterbi", "[", 
   RowBox[{
    RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], ",", " ", "photonrates_", 
    ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "lh", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"F1DHMMSetPhotonRates", "[", "photonrates", "]"}], "===", 
        "$Failed"}], ",", 
       RowBox[{"Return", "[", "$Failed", "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"F1DHMMViterbi", "[", "Km", "]"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.749467521023334*^9, 3.749467556934556*^9}, {
   3.749467590913252*^9, 3.7494675915096474`*^9}, {3.7494681936954703`*^9, 
   3.7494682213066154`*^9}, 3.7494682554626927`*^9, {3.749529268800666*^9, 
   3.7495292719193797`*^9}, {3.7495293260097322`*^9, 3.7495293593465*^9}, {
   3.7495293903785048`*^9, 3.749529403858449*^9}, {3.749529434522078*^9, 
   3.749529435655052*^9}, {3.7495295323891997`*^9, 3.7495295855859027`*^9}, {
   3.7495296195689726`*^9, 3.7495296351703873`*^9}, 3.74952970359116*^9, {
   3.7495297632394404`*^9, 3.7495297792346463`*^9}, {3.749529828519842*^9, 
   3.749529837228266*^9}, {3.749530122952064*^9, 3.7495301951280766`*^9}, {
   3.749530505387927*^9, 3.749530519654763*^9}, {3.7495305557871227`*^9, 
   3.749530586543863*^9}, {3.7495307227864676`*^9, 3.749530753269283*^9}, {
   3.749530885149269*^9, 3.749530925975073*^9}, {3.749531133021701*^9, 
   3.7495312097185216`*^9}, {3.7495312715243855`*^9, 3.749531276779001*^9}, {
   3.749531332335064*^9, 3.749531384034936*^9}, {3.7495314295108967`*^9, 
   3.7495314589540577`*^9}, 3.749531551168411*^9, {3.7495316070469584`*^9, 
   3.7495316178580513`*^9}, {3.7495319139867163`*^9, 
   3.7495319475656977`*^9}, {3.7495324345643153`*^9, 3.7495324585231905`*^9}, 
   3.749533415585991*^9, {3.7495352784994035`*^9, 3.749535292553809*^9}, 
   3.749536428731695*^9, {3.749536879415386*^9, 3.749536880993176*^9}, {
   3.749536922761497*^9, 3.7495369314103165`*^9}, 3.7495370533671722`*^9, 
   3.7495371182893276`*^9, {3.749537231776632*^9, 3.7495372592348585`*^9}, {
   3.749537333768547*^9, 3.74953739237178*^9}, {3.74954910520767*^9, 
   3.7495491150663023`*^9}, {3.749791241417869*^9, 3.749791282805175*^9}, {
   3.7499819072061048`*^9, 3.7499819072789097`*^9}, {3.7501488626685553`*^9, 
   3.750148936013038*^9}, {3.750149024512638*^9, 3.750149113678056*^9}, {
   3.7501491691338305`*^9, 3.7501492309135566`*^9}, {3.7501493038348193`*^9, 
   3.750149323812806*^9}, 3.7501493671622295`*^9, {3.7501494011281652`*^9, 
   3.7501494248627205`*^9}, 3.750149507116145*^9, {3.7501502008580713`*^9, 
   3.750150214569867*^9}, {3.7529204436743245`*^9, 3.752920452052907*^9}, {
   3.7529295350295134`*^9, 3.7529295470896187`*^9}, 3.754209490016601*^9, 
   3.761050895677702*^9, {3.7616454118362823`*^9, 3.7616454349840775`*^9}, {
   3.7621521786337786`*^9, 3.762152188683118*^9}, 3.762603061273463*^9, 
   3.7626034249401245`*^9, {3.76431454540841*^9, 3.7643145796209555`*^9}, 
   3.812090822496784*^9},ExpressionUUID->"44feaaa9-9293-4507-97ac-\
ffdebacbf6b5"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "F1DHMMForwardBackward", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"FHMMpinpfin", "->", "FHMMPeqOne"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"F1DHMMForwardBackward", "[", 
   RowBox[{
    RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "statetrajectory", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Length", "[", "Km", "]"}], "!=", "F1DHMMStateCount"}], ",", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"F1DHMMViterbi", "::", "dimerr"}], "]"}], ";", 
         RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"statetrajectory", "=", 
      RowBox[{"Which", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
         "FHMMPeqOne"}], "\[IndentingNewLine]", ",", 
        RowBox[{"If", "[", 
         RowBox[{"F1DHMMGlobalPobs", ",", "$False", ",", 
          RowBox[{"FPHmm1DForwardBackwardPeqFromK", "[", 
           RowBox[{"F1DHMMBinning", "*", 
            RowBox[{"N", "@", "Km"}]}], "]"}]}], "]"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
         "FHMMTraceWise"}], "\[IndentingNewLine]", ",", 
        RowBox[{"FPHmm1DForwardBackward", "[", 
         RowBox[{"F1DHMMBinning", "*", 
          RowBox[{"N", "@", "Km"}]}], "]"}], ",", "\[IndentingNewLine]", 
        "True", "\[IndentingNewLine]", ",", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Message", "[", 
           RowBox[{"F1DHMMViterbi", "::", "erroptval"}], "]"}], ";", 
          RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
       "\[IndentingNewLine]", "]"}]}], ";", "\[IndentingNewLine]", 
     "statetrajectory"}]}], "\[IndentingNewLine]", 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"F1DHMMForwardBackward", "[", 
   RowBox[{
    RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], ",", " ", "photonrates_", 
    ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "lh", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"F1DHMMSetPhotonRates", "[", "photonrates", "]"}], "===", 
        "$Failed"}], ",", 
       RowBox[{"Return", "[", "$Failed", "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"F1DHMMForwardBackward", "[", "Km", "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->{{3.749467521023334*^9, 3.749467556934556*^9}, {
   3.749467590913252*^9, 3.7494675915096474`*^9}, {3.7494681936954703`*^9, 
   3.7494682213066154`*^9}, 3.7494682554626927`*^9, {3.749529268800666*^9, 
   3.7495292719193797`*^9}, {3.7495293260097322`*^9, 3.7495293593465*^9}, {
   3.7495293903785048`*^9, 3.749529403858449*^9}, {3.749529434522078*^9, 
   3.749529435655052*^9}, {3.7495295323891997`*^9, 3.7495295855859027`*^9}, {
   3.7495296195689726`*^9, 3.7495296351703873`*^9}, 3.74952970359116*^9, {
   3.7495297632394404`*^9, 3.7495297792346463`*^9}, {3.749529828519842*^9, 
   3.749529837228266*^9}, {3.749530122952064*^9, 3.7495301951280766`*^9}, {
   3.749530505387927*^9, 3.749530519654763*^9}, {3.7495305557871227`*^9, 
   3.749530586543863*^9}, {3.7495307227864676`*^9, 3.749530753269283*^9}, {
   3.749530885149269*^9, 3.749530925975073*^9}, {3.749531133021701*^9, 
   3.7495312097185216`*^9}, {3.7495312715243855`*^9, 3.749531276779001*^9}, {
   3.749531332335064*^9, 3.749531384034936*^9}, {3.7495314295108967`*^9, 
   3.7495314589540577`*^9}, 3.749531551168411*^9, {3.7495316070469584`*^9, 
   3.7495316178580513`*^9}, {3.7495319139867163`*^9, 
   3.7495319475656977`*^9}, {3.7495324345643153`*^9, 3.7495324585231905`*^9}, 
   3.749533415585991*^9, {3.7495352784994035`*^9, 3.749535292553809*^9}, 
   3.749536428731695*^9, {3.749536879415386*^9, 3.749536880993176*^9}, {
   3.749536922761497*^9, 3.7495369314103165`*^9}, 3.7495370533671722`*^9, 
   3.7495371182893276`*^9, {3.749537231776632*^9, 3.7495372592348585`*^9}, {
   3.749537333768547*^9, 3.74953739237178*^9}, {3.74954910520767*^9, 
   3.7495491150663023`*^9}, {3.749791241417869*^9, 3.749791282805175*^9}, {
   3.7499819072061048`*^9, 3.7499819072789097`*^9}, {3.7501488626685553`*^9, 
   3.750148936013038*^9}, {3.750149024512638*^9, 3.750149113678056*^9}, {
   3.7501491691338305`*^9, 3.7501492309135566`*^9}, {3.7501493038348193`*^9, 
   3.750149323812806*^9}, 3.7501493671622295`*^9, {3.7501494011281652`*^9, 
   3.7501494248627205`*^9}, 3.750149507116145*^9, {3.7501502008580713`*^9, 
   3.750150214569867*^9}, {3.7529204436743245`*^9, 3.752920452052907*^9}, {
   3.7529295350295134`*^9, 3.7529295470896187`*^9}, 3.754209490016601*^9, {
   3.761050645481476*^9, 3.761050696968856*^9}, 3.7610509210927677`*^9, {
   3.761050968923918*^9, 3.7610510205668745`*^9}, {3.7610511911738443`*^9, 
   3.7610512000501204`*^9}, {3.761645436607351*^9, 3.7616454619715605`*^9}, 
   3.76260345990695*^9, {3.7626047677236795`*^9, 3.7626047734539537`*^9}, {
   3.7626052633979597`*^9, 3.7626052644479885`*^9}, 3.7626054196923227`*^9, {
   3.7643145979001074`*^9, 3.764314627557844*^9}, {3.8120909462128496`*^9, 
   3.812090967143922*^9}},ExpressionUUID->"bf5f9e68-c6a1-49ea-b019-\
aedc563e6c43"]
}, Closed]],

Cell[CellGroupData[{

Cell["GUnified HMM commands", "Subsubsection",
 CellChangeTimes->{{3.7494544408115234`*^9, 3.749454452559103*^9}, 
   3.7529265781142254`*^9},ExpressionUUID->"db77c6e0-548a-4ce1-bb60-\
2c60b5792fbd"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FHmmBinning", "=", "1."}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FHMMmode", "=", "None"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FHMMTrajectoryCount", "=", "0"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FHMMStateCount", "=", "0"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FHMMGlobalRates", "=", "False"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FHMMNa", "=", 
   RowBox[{"{", 
    RowBox[{"1", ",", "1"}], "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FHMMNd", "=", 
   RowBox[{"{", 
    RowBox[{"1", ",", "1"}], "}"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.749466891328204*^9, 3.7494669049603567`*^9}, {
  3.749467005772902*^9, 3.7494670232095947`*^9}, {3.7494676232807198`*^9, 
  3.749467657154451*^9}, {3.7494678877648816`*^9, 3.749467917318637*^9}, {
  3.749468076795555*^9, 3.749468108091424*^9}, {3.749981906934828*^9, 
  3.7499819069487925`*^9}, {3.7501481401679487`*^9, 3.7501481452912493`*^9}, {
  3.7501497107406206`*^9, 3.750149715913785*^9}, {3.7529205203288183`*^9, 
  3.7529205243969293`*^9}},ExpressionUUID->"799a38b9-28c8-4697-aab1-\
b4755fa4797b"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FGHMMSetNumberOfModels", "[", "modelsize_Integer", "]"}], ":=", 
  RowBox[{"FPGHmmSetNumberOfModels", "[", "modelsize", "]"}]}]], "Input",
 CellChangeTimes->{{3.7537685776502514`*^9, 
  3.7537686250020456`*^9}},ExpressionUUID->"7b32d1f4-61be-476b-aec1-\
fc11d8cae5b9"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FGHMMInitWithBinnedData", "[", 
   RowBox[{"mi_Integer", ",", " ", 
    RowBox[{"trlist", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumericQ"}], " ", ",", 
           RowBox[{"_", "?", "NumericQ"}]}], " ", "}"}], ".."}], "}"}], 
       ".."}], "}"}]}], ",", 
    RowBox[{"Tbinning_", "?", "NumericQ"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"unitv", ",", "result"}], "}"}], ",", "\[IndentingNewLine]", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"FHmmBinning", "=", "Tbinning"}], ";", "\[IndentingNewLine]", 
     RowBox[{"FPGHmmClearTrajectoryList", "[", 
      RowBox[{"mi", "-", "1"}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"unitv", "=", 
      RowBox[{"ConstantArray", "[", 
       RowBox[{"1.", ",", "2"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"result", "=", 
      RowBox[{"Map", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"FPGHmmAppendTrajectory", "[", 
          RowBox[{
           RowBox[{"mi", "-", "1"}], ",", " ", 
           RowBox[{"Round", "@", 
            RowBox[{"Flatten", "@", "#"}]}], ",", "unitv", ",", "unitv", ",", 
           "unitv", ",", "unitv"}], "]"}], "&"}], ",", "trlist"}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"FHMMmode", "=", "FHMMBinned"}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"FGHMMTrajectoryCount", "[", "mi", "]"}], "=", 
      RowBox[{"Length", "[", "trlist", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"FHMMStateCount", "=", "0"}], ";", "\[IndentingNewLine]", 
     "result"}]}], "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.7494661201885214`*^9, 3.749466120532586*^9}, {
   3.749466161046032*^9, 3.7494662052479744`*^9}, {3.749466287389041*^9, 
   3.7494663459640927`*^9}, {3.7494664027681656`*^9, 
   3.7494665253417253`*^9}, {3.7494668457956057`*^9, 
   3.7494668736904063`*^9}, {3.749467030735467*^9, 3.7494670541789494`*^9}, 
   3.749467752422865*^9, {3.7495336861652555`*^9, 3.74953373240164*^9}, {
   3.749533821786525*^9, 3.7495338871610546`*^9}, 3.7495469326926785`*^9, {
   3.749549558536272*^9, 3.749549563590763*^9}, {3.7499819069527817`*^9, 
   3.7499819069777136`*^9}, {3.749986186962763*^9, 3.7499862226812525`*^9}, {
   3.750148204514877*^9, 3.7501482285405917`*^9}, {3.7501497996563396`*^9, 
   3.7501498032736645`*^9}, {3.7529194625061884`*^9, 
   3.7529194698676977`*^9}, {3.752919609214021*^9, 3.7529196514660215`*^9}, {
   3.752919688349354*^9, 3.7529197190641994`*^9}, {3.7529197517084403`*^9, 
   3.7529198488925*^9}, {3.75292721124003*^9, 3.7529272475484467`*^9}, {
   3.752927289130271*^9, 3.752927334893838*^9}, {3.752927395332922*^9, 
   3.752927408112734*^9}, {3.753770709472325*^9, 3.7537707212249374`*^9}, {
   3.7537780410320454`*^9, 3.753778060041167*^9}, {3.753778090764001*^9, 
   3.753778106444067*^9}, {3.753778784647764*^9, 
   3.7537787871031995`*^9}},ExpressionUUID->"23079244-b275-4bdd-bc03-\
5d307f381b4c"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FGHMMInitWithPhotonByPhotonData", "[", 
   RowBox[{"trlist", ":", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumericQ"}], " ", ",", "_Integer"}], " ", "}"}], 
        ".."}], "}"}], ".."}], "}"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"unitv", ",", "tr"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"FMLHClearBurstList", "[", "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"unitv", "=", 
      RowBox[{"ConstantArray", "[", 
       RowBox[{"1", ",", "2"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Map", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"FMLHAppendToBurstList", "[", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"tr", "=", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"unitv", ",", "unitv", ",", "unitv", ",", "unitv"}], 
               "}"}], ",", "#"}], "}"}]}], ";", 
           RowBox[{
            RowBox[{"tr", "[", 
             RowBox[{"[", 
              RowBox[{"2", ",", "All", ",", "2"}], "]"}], "]"}], "-=", "1"}], 
           ";", "tr"}], ")"}], "]"}], "&"}], ",", "trlist"}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"FHMMmode", "=", "FHMMPhotonByPhoton"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"FHMMTrajectoryCount", "=", 
      RowBox[{"Length", "[", "trlist", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"FHMMStateCount", "=", "0"}], ";"}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.7494665806668053`*^9, 3.749466595347588*^9}, {
   3.7494666486188655`*^9, 3.7494667175235643`*^9}, {3.7494667937131996`*^9, 
   3.7494668279855375`*^9}, {3.7494670644684296`*^9, 3.749467064855386*^9}, 
   3.749467756632594*^9, {3.749533746674418*^9, 3.749533748154462*^9}, {
   3.7495339057144794`*^9, 3.7495339643276663`*^9}, 3.749547094344572*^9, 
   3.7495473685809216`*^9, 3.7495479042654405`*^9, {3.749549540641127*^9, 
   3.7495495513983564`*^9}, {3.749550510890293*^9, 3.7495505729397707`*^9}, {
   3.749981906985693*^9, 3.74998190700068*^9}, {3.7501482735003414`*^9, 
   3.750148297429345*^9}, {3.750149816314785*^9, 3.7501498169900713`*^9}, 
   3.752927438878496*^9},ExpressionUUID->"c62d6e44-e42c-4bb9-ac8c-\
54fabd1d8f3b"],

Cell[BoxData[""], "Input",
 CellChangeTimes->{{3.750141335889906*^9, 3.750141336553132*^9}, {
   3.7501416790790157`*^9, 3.7501417106316257`*^9}, {3.750147993930109*^9, 
   3.7501480031204967`*^9}, 
   3.7501504339601994`*^9},ExpressionUUID->"7e8bb271-56aa-4389-aa3f-\
b862bf103ea0"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FGHMMSetPhotonRates", "[", 
   RowBox[{"mi_Integer", ",", 
    RowBox[{"rates", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], "}"}], ".."}], 
      "}"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "nstates", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"nstates", "=", 
      RowBox[{"Length", "[", 
       RowBox[{"rates", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "1"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"AnyTrue", "[", 
        RowBox[{"rates", ",", 
         RowBox[{
          RowBox[{
           RowBox[{"Length", "[", "#", "]"}], "\[NotEqual]", "nstates"}], 
          "&"}], ",", "2"}], "]"}], ",", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"FHMMSetPhotonRates", "::", "dimerr"}], "]"}], ";", 
         RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"FHMMGlobalRates", "=", "False"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Which", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"FHMMmode", "===", "FHMMBinned"}], ",", 
       RowBox[{"FPGHmmSetPhotonRates", "[", 
        RowBox[{
         RowBox[{"mi", "-", "1"}], ",", 
         RowBox[{
          RowBox[{"N", "@", "FHmmBinning"}], "*", 
          RowBox[{"Flatten", "@", 
           RowBox[{"rates", "[", 
            RowBox[{"[", 
             RowBox[{"All", ",", "1"}], "]"}], "]"}]}]}], ",", 
         RowBox[{
          RowBox[{"N", "@", "FHmmBinning"}], "*", 
          RowBox[{"Flatten", "@", 
           RowBox[{"rates", "[", 
            RowBox[{"[", 
             RowBox[{"All", ",", "2"}], "]"}], "]"}]}]}], ",", 
         RowBox[{"Length", "@", 
          RowBox[{"rates", "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "1"}], "]"}], "]"}]}]}], "]"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"FHMMmode", "===", "FHMMPhotonByPhoton"}], ",", 
       RowBox[{"FMLHSetPhotonRates", "[", "rates", "]"}], ",", 
       "\[IndentingNewLine]", "True", ",", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"FHMMSetPhotonRates", "::", "erroptval"}], "]"}], ";", 
         RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
      "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"FHMMStateCount", "=", "nstates"}], ";"}]}], 
   "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FGHMMSetPhotonRates", "[", 
   RowBox[{"mi_Integer", ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"nA", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], ",", " ", 
      RowBox[{"nD", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}]}], "}"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Length", "[", "nA", "]"}], "!=", 
        RowBox[{"Length", "[", "nD", "]"}]}], " ", ",", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"FHMMSetPhotonRates", "::", "dimerr"}], "]"}], ";", 
         RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"FGHMMSetPhotonRates", "[", 
      RowBox[{"mi", ",", 
       RowBox[{"ConstantArray", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"nA", ",", "nD"}], "}"}], ",", 
         RowBox[{"FGHMMTrajectoryCount", "[", "mi", "]"}]}], "]"}]}], "]"}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"FHMMGlobalRates", "=", "True"}], ";", "\[IndentingNewLine]", 
     RowBox[{"FHMMNa", "=", "nA"}], ";", "\[IndentingNewLine]", 
     RowBox[{"FHMMNd", "=", "nD"}], ";"}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.7494669861464057`*^9, 3.749466989115467*^9}, {
   3.749467078550751*^9, 3.749467117840347*^9}, {3.7494671535495186`*^9, 
   3.749467323666687*^9}, {3.7494674164462223`*^9, 3.7494674725061264`*^9}, {
   3.7494676919993315`*^9, 3.749467735241808*^9}, 3.749467847597299*^9, {
   3.7494679600687523`*^9, 3.749468066351487*^9}, {3.749468125382179*^9, 
   3.7494681506695447`*^9}, {3.7495291519840097`*^9, 
   3.7495291583489857`*^9}, {3.7495291886959157`*^9, 
   3.7495292289412794`*^9}, {3.749530356519924*^9, 3.7495304082841578`*^9}, 
   3.7495337694175897`*^9, {3.7495340745957456`*^9, 3.749534075370719*^9}, {
   3.7495341504598513`*^9, 3.749534157962826*^9}, {3.7495343379712057`*^9, 
   3.7495343636468368`*^9}, {3.7495344608907485`*^9, 
   3.7495345002582293`*^9}, {3.7495349392642612`*^9, 3.749535006577127*^9}, {
   3.7495351419298134`*^9, 3.7495352261623807`*^9}, {3.749536792135975*^9, 
   3.7495368115989943`*^9}, {3.749546502985573*^9, 3.749546512482171*^9}, {
   3.749981907005665*^9, 3.749981907082461*^9}, {3.749985522786653*^9, 
   3.7499855235366573`*^9}, {3.7501408679689856`*^9, 3.750140918503724*^9}, {
   3.7501411529511895`*^9, 3.7501411579468307`*^9}, {3.750141209161852*^9, 
   3.750141225144103*^9}, {3.7501412950880346`*^9, 3.7501413150576243`*^9}, {
   3.7501463755161533`*^9, 3.7501464124244413`*^9}, {3.750147953247884*^9, 
   3.7501479707640686`*^9}, 3.750148051796307*^9, {3.7501483323499403`*^9, 
   3.750148426298667*^9}, {3.750149746881489*^9, 3.7501497563342094`*^9}, 
   3.7501508727313433`*^9, 3.7528250614918556`*^9, {3.7529274420161037`*^9, 
   3.7529274445971622`*^9}, 3.7529278326160173`*^9, {3.7529279332020226`*^9, 
   3.752927969719326*^9}, {3.752928014983329*^9, 3.752928025951001*^9}, 
   3.7537698306593914`*^9, {3.7537711880497646`*^9, 
   3.753771188589325*^9}},ExpressionUUID->"4cd4df46-706c-46c6-9c95-\
7d1e2a87e5ec"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"FGHMMSetPinPfin", "[", 
    RowBox[{"mi_Integer", ",", 
     RowBox[{"pinpfin", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], "}"}], ".."}], 
       "}"}]}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "nstates", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"nstates", "=", 
       RowBox[{"Length", "[", 
        RowBox[{"pinpfin", "[", 
         RowBox[{"[", 
          RowBox[{"1", ",", "1"}], "]"}], "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"AnyTrue", "[", 
         RowBox[{"pinpfin", ",", 
          RowBox[{
           RowBox[{
            RowBox[{"Length", "[", "#", "]"}], "\[NotEqual]", "nstates"}], 
           "&"}], ",", "2"}], "]"}], ",", 
        RowBox[{"Return", "[", "$Failed", "]"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"FHMMGlobalRates", "=", "False"}], ";", "\[IndentingNewLine]", 
      RowBox[{"Which", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"FHMMmode", "===", "FHMMBinned"}], "\[IndentingNewLine]", ",", 
        RowBox[{"FPGHmmSetPinPfin", "[", 
         RowBox[{
          RowBox[{"mi", "-", "1"}], ",", " ", 
          RowBox[{"N", "@", 
           RowBox[{"Flatten", "@", 
            RowBox[{"pinpfin", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "1"}], "]"}], "]"}]}]}], ",", 
          RowBox[{"N", "@", 
           RowBox[{"Flatten", "@", 
            RowBox[{"pinpfin", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "2"}], "]"}], "]"}]}]}], ",", 
          RowBox[{"Length", "@", 
           RowBox[{"pinpfin", "[", 
            RowBox[{"[", 
             RowBox[{"1", ",", "1"}], "]"}], "]"}]}]}], "]"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"FHMMmode", "===", "FHMMPhotonByPhoton"}], 
        "\[IndentingNewLine]", ",", 
        RowBox[{"FPMLHSetPinPfin", "[", 
         RowBox[{
          RowBox[{"N", "@", 
           RowBox[{"Flatten", "@", 
            RowBox[{"pinpfin", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "1"}], "]"}], "]"}]}]}], ",", 
          RowBox[{"N", "@", 
           RowBox[{"Flatten", "@", 
            RowBox[{"pinpfin", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "2"}], "]"}], "]"}]}]}], ",", 
          RowBox[{"Length", "@", 
           RowBox[{"pinpfin", "[", 
            RowBox[{"[", 
             RowBox[{"1", ",", "1"}], "]"}], "]"}]}]}], "]"}], ",", 
        "\[IndentingNewLine]", "True", ",", "$Failed"}], 
       "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  "\[IndentingNewLine]"}], "\n", 
 RowBox[{
  RowBox[{"FGHMMSetPinPfin", "[", 
   RowBox[{"mi_Integer", ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"pin", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], ",", " ", 
      RowBox[{"pfin", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}]}], "}"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"Length", "[", "pin", "]"}], "!=", "FHMMStateCount"}], " ", "||",
         " ", 
        RowBox[{
         RowBox[{"Length", "[", "pfin", "]"}], "!=", "FHMMStateCount"}]}], 
       ",", 
       RowBox[{"Return", "[", "$Failed", "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"FGHMMSetPinPfin", "[", 
      RowBox[{"mi", ",", 
       RowBox[{"ConstantArray", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"pin", ",", "pfin"}], "}"}], ",", 
         RowBox[{"FGHMMTrajectoryCount", "[", "mi", "]"}]}], "]"}]}], "]"}], 
     ";"}]}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   "]"}]}], "\[IndentingNewLine]"}], "Input",
 CellChangeTimes->{{3.7499847584301777`*^9, 3.7499847963729277`*^9}, {
   3.749985054632259*^9, 3.749985062665756*^9}, 3.749985108100808*^9, {
   3.749985168185115*^9, 3.749985261087639*^9}, {3.749985371306799*^9, 
   3.7499854247179956`*^9}, {3.7499855375800905`*^9, 3.749985586477364*^9}, 
   3.7501479608435717`*^9, {3.7501485228833456`*^9, 3.750148632110212*^9}, 
   3.7501498634265327`*^9, {3.7501508989217916`*^9, 3.7501509319225984`*^9}, {
   3.7529274500246363`*^9, 3.7529274535502543`*^9}, {3.752927839143607*^9, 
   3.7529278466914043`*^9}, {3.7529280611708307`*^9, 3.752928114087223*^9}, {
   3.753771220397256*^9, 
   3.7537712236126614`*^9}},ExpressionUUID->"6cf11a7d-22bb-448c-9e5d-\
9b40b43e76de"],

Cell[BoxData[""], "Input",
 CellChangeTimes->{{3.7501471083479934`*^9, 3.750147154727939*^9}, {
   3.750147804156641*^9, 3.7501478448129015`*^9}, {3.750149587326657*^9, 
   3.7501496251490383`*^9}, {3.7501500787774844`*^9, 
   3.7501500914695425`*^9}, {3.7501501271391487`*^9, 3.750150182314536*^9}, 
   3.750150396853924*^9},ExpressionUUID->"63f3bbbc-a976-429d-a377-\
bd20fd3656d5"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FGHMMLogLikelihood", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"FHMMpinpfin", "->", "FHMMPeqOne"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FGHMMLogLikelihood", "[", 
   RowBox[{"mi_Integer", ",", 
    RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "lh", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Length", "[", "Km", "]"}], "!=", "FHMMStateCount"}], ",", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"FHMMLogLikelihood", "::", "dimerr"}], "]"}], ";", 
         RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Which", "[", 
      RowBox[{
       RowBox[{"FHMMmode", "===", "FHMMBinned"}], ",", "\[IndentingNewLine]", 
       RowBox[{"lh", "=", 
        RowBox[{"Which", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
           "FHMMPeqOne"}], "\[IndentingNewLine]", ",", 
          RowBox[{"If", "[", 
           RowBox[{"FHMMGlobalRates", ",", " ", 
            RowBox[{"FPGHmmGetLikelihoodPeqFromK", "[", 
             RowBox[{
              RowBox[{"mi", "-", "1"}], ",", 
              RowBox[{"FHmmBinning", "*", 
               RowBox[{"N", "@", "FHMMNa"}]}], ",", 
              RowBox[{"FHmmBinning", "*", 
               RowBox[{"N", "@", "FHMMNd"}]}], ",", 
              RowBox[{"FHmmBinning", "*", 
               RowBox[{"N", "@", 
                RowBox[{"Flatten", "@", "Km"}]}]}]}], "]"}], ",", 
            RowBox[{"FPGHmmGetLikelihoodPeqFromK", "[", 
             RowBox[{
              RowBox[{"mi", "-", "1"}], ",", 
              RowBox[{"FHmmBinning", "*", 
               RowBox[{"N", "@", 
                RowBox[{"Flatten", "@", "Km"}]}]}], ",", 
              RowBox[{"Length", "[", "Km", "]"}]}], "]"}]}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
           "FHMMTraceWise"}], "\[IndentingNewLine]", ",", 
          RowBox[{"FPGHmmGetLikelihood", "[", 
           RowBox[{
            RowBox[{"mi", "-", "1"}], ",", " ", 
            RowBox[{"FHmmBinning", "*", 
             RowBox[{"N", "@", 
              RowBox[{"Flatten", "@", "Km"}]}]}], ",", 
            RowBox[{"Length", "[", "Km", "]"}]}], "]"}], ",", 
          "\[IndentingNewLine]", "True", "\[IndentingNewLine]", ",", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"Message", "[", 
             RowBox[{"FHMMLogLikelihood", "::", "erroptval"}], "]"}], ";", 
            RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
         "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", ",", 
       RowBox[{"FHMMmode", "===", "FHMMPhotonByPhoton"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"lh", "=", 
        RowBox[{"-", "\[IndentingNewLine]", 
         RowBox[{"Which", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
            "FHMMPeqOne"}], "\[IndentingNewLine]", ",", 
           RowBox[{"If", "[", 
            RowBox[{"FHMMGlobalRates", ",", 
             RowBox[{"FPMLHGetLikelihoodPeqFromK", "[", 
              RowBox[{
               RowBox[{"N", "@", "FHMMNa"}], ",", 
               RowBox[{"N", "@", "FHMMNd"}], ",", 
               RowBox[{"N", "@", 
                RowBox[{"Flatten", "@", "Km"}]}]}], "]"}], ",", 
             RowBox[{"FPMLHGetLikelihoodPeqFromK", "[", 
              RowBox[{
               RowBox[{"N", "@", 
                RowBox[{"Flatten", "@", "Km"}]}], ",", 
               RowBox[{"Length", "[", "Km", "]"}]}], "]"}]}], "]"}], ",", 
           RowBox[{
            RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
            "FHMMTraceWise"}], "\[IndentingNewLine]", ",", 
           RowBox[{"If", "[", 
            RowBox[{"FHMMGlobalRates", ",", 
             RowBox[{"FPMLHGetLikelihood", "[", 
              RowBox[{
               RowBox[{"N", "@", "FHMMNa"}], ",", 
               RowBox[{"N", "@", "FHMMNd"}], ",", 
               RowBox[{"N", "@", 
                RowBox[{"Flatten", "@", "Km"}]}]}], "]"}], ",", 
             RowBox[{"FPMLHGetLikelihood", "[", 
              RowBox[{
               RowBox[{"N", "@", 
                RowBox[{"Flatten", "@", "Km"}]}], ",", 
               RowBox[{"Length", "[", "Km", "]"}]}], "]"}]}], "]"}], ",", 
           "\[IndentingNewLine]", "True", "\[IndentingNewLine]", ",", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"Message", "[", 
              RowBox[{"FHMMLogLikelihood", "::", "erroptval"}], "]"}], ";", 
             RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
          "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", ",", 
       "True", ",", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"FHMMLogLikelihood", "::", "noinit"}], "]"}], ";", 
         RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
      "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", "lh"}]}], 
   "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FGHMMLogLikelihood", "[", 
   RowBox[{"mi_Integer", ",", 
    RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], ",", " ", 
    RowBox[{"photonrates", ":", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], "}"}], ".."}], 
       "}"}], "|", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], "}"}]}]}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "lh", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"FGHMMSetPhotonRates", "[", 
         RowBox[{"mi", ",", "photonrates"}], "]"}], "===", "$Failed"}], ",", 
       RowBox[{"Return", "[", "$Failed", "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"FGHMMLogLikelihood", "[", 
      RowBox[{"mi", ",", "Km"}], "]"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.749467521023334*^9, 3.749467556934556*^9}, {
   3.749467590913252*^9, 3.7494675915096474`*^9}, {3.7494681936954703`*^9, 
   3.7494682213066154`*^9}, 3.7494682554626927`*^9, {3.749529268800666*^9, 
   3.7495292719193797`*^9}, {3.7495293260097322`*^9, 3.7495293593465*^9}, {
   3.7495293903785048`*^9, 3.749529403858449*^9}, {3.749529434522078*^9, 
   3.749529435655052*^9}, {3.7495295323891997`*^9, 3.7495295855859027`*^9}, {
   3.7495296195689726`*^9, 3.7495296351703873`*^9}, 3.74952970359116*^9, {
   3.7495297632394404`*^9, 3.7495297792346463`*^9}, {3.749529828519842*^9, 
   3.749529837228266*^9}, {3.749530122952064*^9, 3.7495301951280766`*^9}, {
   3.749530505387927*^9, 3.749530519654763*^9}, {3.7495305557871227`*^9, 
   3.749530586543863*^9}, {3.7495307227864676`*^9, 3.749530753269283*^9}, {
   3.749530885149269*^9, 3.749530925975073*^9}, {3.749531133021701*^9, 
   3.7495312097185216`*^9}, {3.7495312715243855`*^9, 3.749531276779001*^9}, {
   3.749531332335064*^9, 3.749531384034936*^9}, {3.7495314295108967`*^9, 
   3.7495314589540577`*^9}, 3.749531551168411*^9, {3.7495316070469584`*^9, 
   3.7495316178580513`*^9}, {3.7495319139867163`*^9, 
   3.7495319475656977`*^9}, {3.7495324345643153`*^9, 3.7495324585231905`*^9}, 
   3.749533415585991*^9, {3.7495352784994035`*^9, 3.749535292553809*^9}, 
   3.749536428731695*^9, {3.749536879415386*^9, 3.749536880993176*^9}, {
   3.7495374022673163`*^9, 3.7495374090352182`*^9}, {3.7495481887678685`*^9, 
   3.7495482162583447`*^9}, 3.74954869938413*^9, 3.7495487390520487`*^9, {
   3.749548844666698*^9, 3.74954887240451*^9}, {3.749549039873412*^9, 
   3.74954908108419*^9}, {3.7497911227223296`*^9, 3.7497911814861617`*^9}, {
   3.74998190709044*^9, 3.749981907200118*^9}, {3.750146880567348*^9, 
   3.7501469853998375`*^9}, {3.750147036686735*^9, 3.750147088691083*^9}, {
   3.7501471886671658`*^9, 3.7501471975737696`*^9}, {3.7501472441762934`*^9, 
   3.7501472539293036`*^9}, {3.7501473287622795`*^9, 
   3.7501473349267635`*^9}, {3.7501474057809353`*^9, 
   3.7501474378424373`*^9}, {3.7501477808749104`*^9, 3.7501477925586605`*^9}, 
   3.750149000247304*^9, {3.750149916087717*^9, 3.7501499621706276`*^9}, {
   3.750149992561561*^9, 3.750150017500571*^9}, {3.7501500647691455`*^9, 
   3.7501500679459343`*^9}, {3.7501510691240573`*^9, 
   3.7501510953964014`*^9}, {3.751196023225656*^9, 3.751196032326316*^9}, {
   3.751196866791787*^9, 3.75119687813146*^9}, {3.751196916050259*^9, 
   3.7511969213384104`*^9}, 3.752920024613032*^9, 3.752920082843291*^9, {
   3.7529201513855333`*^9, 3.752920193843111*^9}, {3.752927460729021*^9, 
   3.752927469310104*^9}, {3.7529278515862913`*^9, 3.752927856823303*^9}, {
   3.75292814882432*^9, 3.752928212414285*^9}, {3.7529291424039555`*^9, 
   3.7529291439388695`*^9}, {3.7529291829531574`*^9, 3.752929218145396*^9}, {
   3.75377124306065*^9, 
   3.75377127866444*^9}},ExpressionUUID->"b18ff2f6-c23e-4280-827e-\
d588276af4a6"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"BinnedViterbiPeqFromK", "[", 
   RowBox[{"mi_Integer", ",", 
    RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "tr", "}"}], ",", 
    RowBox[{"tr", "=", 
     RowBox[{
      RowBox[{"FPGHmmViterbiPeqFromK", "[", 
       RowBox[{
        RowBox[{"mi", "-", "1"}], ",", " ", 
        RowBox[{"FHmmBinning", "*", 
         RowBox[{"N", "@", 
          RowBox[{"Flatten", "@", "Km"}]}]}], ",", 
        RowBox[{"Length", "[", "Km", "]"}]}], "]"}], "/.", 
      RowBox[{
       RowBox[{"FDwell", "[", 
        RowBox[{"t_", ",", "s_", ",", "dt_", ",", "p___"}], "]"}], ":>", 
       RowBox[{"FDwell", "[", 
        RowBox[{
         RowBox[{"FHmmBinning", "*", "t"}], ",", "s", ",", 
         RowBox[{"FHmmBinning", "*", "dt"}], ",", "p"}], "]"}]}]}]}]}], 
   "]"}]}], "\n", 
 RowBox[{
  RowBox[{"BinnedViterbi", "[", 
   RowBox[{"mi_Integer", ",", " ", 
    RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "tr", "}"}], ",", 
    RowBox[{"tr", "=", 
     RowBox[{
      RowBox[{"FPGHmmViterbi", "[", 
       RowBox[{
        RowBox[{"mi", "-", "1"}], " ", ",", 
        RowBox[{"FHmmBinning", "*", 
         RowBox[{"N", "@", 
          RowBox[{"Flatten", "@", "Km"}]}]}], ",", 
        RowBox[{"Length", "[", "Km", "]"}]}], "]"}], "/.", 
      RowBox[{
       RowBox[{"FDwell", "[", 
        RowBox[{"t_", ",", "s_", ",", "dt_", ",", "p___"}], "]"}], ":>", 
       RowBox[{"FDwell", "[", 
        RowBox[{
         RowBox[{"FHmmBinning", "*", "t"}], ",", "s", ",", 
         RowBox[{"FHmmBinning", "*", "dt"}], ",", "p"}], "]"}]}]}]}]}], 
   "]"}]}], "\n"}], "Input",
 CellChangeTimes->{{3.752920394857087*^9, 3.752920408164277*^9}, 
   3.7529278948794937`*^9, {3.752929237680313*^9, 3.7529292954396114`*^9}, {
   3.7537779620124097`*^9, 
   3.7537779819929843`*^9}},ExpressionUUID->"3e361d83-b552-409d-b079-\
3336b014c232"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FGHMMViterbi", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"FHMMpinpfin", "->", "FHMMPeqOne"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FGHMMViterbi", "[", 
   RowBox[{"mi_Integer", ",", 
    RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "statetrajectory", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Length", "[", "Km", "]"}], "!=", "FHMMStateCount"}], ",", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"FHMMViterbi", "::", "dimerr"}], "]"}], ";", 
         RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Which", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"FHMMmode", "===", "FHMMBinned"}], "\[IndentingNewLine]", ",", 
       RowBox[{"statetrajectory", "=", "\[IndentingNewLine]", 
        RowBox[{"Which", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
           "FHMMPeqOne"}], "\[IndentingNewLine]", ",", 
          RowBox[{"If", "[", 
           RowBox[{"FHMMGlobalRates", ",", 
            RowBox[{"BinnedViterbiPeqFromK", "[", 
             RowBox[{"mi", ",", "FHMMNa", ",", "FHMMNd", ",", "Km"}], "]"}], 
            ",", 
            RowBox[{"BinnedViterbiPeqFromK", "[", 
             RowBox[{"mi", ",", "Km"}], "]"}]}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
           "FHMMTraceWise"}], "\[IndentingNewLine]", ",", 
          RowBox[{"BinnedViterbi", "[", "Km", "]"}], ",", 
          "\[IndentingNewLine]", "True", "\[IndentingNewLine]", ",", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"Message", "[", 
             RowBox[{"FHMMViterbi", "::", "erroptval"}], "]"}], ";", 
            RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
         "\[IndentingNewLine]", "]"}]}], ",", "\[IndentingNewLine]", 
       RowBox[{"FHMMmode", "===", "FHMMPhotonByPhoton"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"statetrajectory", "=", "\[IndentingNewLine]", 
        RowBox[{"Which", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
           "FHMMPeqOne"}], "\[IndentingNewLine]", ",", 
          RowBox[{"FPMLHViterbiPeqFromK", "[", 
           RowBox[{"N", "@", "Km"}], "]"}], ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"OptionValue", "[", "FHMMpinpfin", "]"}], "===", 
           "FHMMTraceWise"}], "\[IndentingNewLine]", ",", 
          RowBox[{"FPMLHViterbi", "[", 
           RowBox[{"N", "@", "Km"}], "]"}], ",", "\[IndentingNewLine]", 
          "True", "\[IndentingNewLine]", ",", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"Message", "[", 
             RowBox[{"FHMMViterbi", "::", "erroptval"}], "]"}], ";", 
            RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
         "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", ",", "True", 
       ",", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"FHMMViterbi", "::", "noinit"}], "]"}], ";", 
         RowBox[{"Return", "[", "$Failed", "]"}]}], ")"}]}], 
      "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
     "statetrajectory"}]}], "\[IndentingNewLine]", 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FGHMMViterbi", "[", 
   RowBox[{"mi_Integer", ",", 
    RowBox[{"Km_", "?", "FNumericSquareMatrixQ"}], ",", " ", "photonrates_", 
    ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "lh", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"FHMMSetPhotonRates", "[", "photonrates", "]"}], "===", 
        "$Failed"}], ",", 
       RowBox[{"Return", "[", "$Failed", "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"FHMMViterbi", "[", "Km", "]"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.749467521023334*^9, 3.749467556934556*^9}, {
   3.749467590913252*^9, 3.7494675915096474`*^9}, {3.7494681936954703`*^9, 
   3.7494682213066154`*^9}, 3.7494682554626927`*^9, {3.749529268800666*^9, 
   3.7495292719193797`*^9}, {3.7495293260097322`*^9, 3.7495293593465*^9}, {
   3.7495293903785048`*^9, 3.749529403858449*^9}, {3.749529434522078*^9, 
   3.749529435655052*^9}, {3.7495295323891997`*^9, 3.7495295855859027`*^9}, {
   3.7495296195689726`*^9, 3.7495296351703873`*^9}, 3.74952970359116*^9, {
   3.7495297632394404`*^9, 3.7495297792346463`*^9}, {3.749529828519842*^9, 
   3.749529837228266*^9}, {3.749530122952064*^9, 3.7495301951280766`*^9}, {
   3.749530505387927*^9, 3.749530519654763*^9}, {3.7495305557871227`*^9, 
   3.749530586543863*^9}, {3.7495307227864676`*^9, 3.749530753269283*^9}, {
   3.749530885149269*^9, 3.749530925975073*^9}, {3.749531133021701*^9, 
   3.7495312097185216`*^9}, {3.7495312715243855`*^9, 3.749531276779001*^9}, {
   3.749531332335064*^9, 3.749531384034936*^9}, {3.7495314295108967`*^9, 
   3.7495314589540577`*^9}, 3.749531551168411*^9, {3.7495316070469584`*^9, 
   3.7495316178580513`*^9}, {3.7495319139867163`*^9, 
   3.7495319475656977`*^9}, {3.7495324345643153`*^9, 3.7495324585231905`*^9}, 
   3.749533415585991*^9, {3.7495352784994035`*^9, 3.749535292553809*^9}, 
   3.749536428731695*^9, {3.749536879415386*^9, 3.749536880993176*^9}, {
   3.749536922761497*^9, 3.7495369314103165`*^9}, 3.7495370533671722`*^9, 
   3.7495371182893276`*^9, {3.749537231776632*^9, 3.7495372592348585`*^9}, {
   3.749537333768547*^9, 3.74953739237178*^9}, {3.74954910520767*^9, 
   3.7495491150663023`*^9}, {3.749791241417869*^9, 3.749791282805175*^9}, {
   3.7499819072061048`*^9, 3.7499819072789097`*^9}, {3.7501488626685553`*^9, 
   3.750148936013038*^9}, {3.750149024512638*^9, 3.750149113678056*^9}, {
   3.7501491691338305`*^9, 3.7501492309135566`*^9}, {3.7501493038348193`*^9, 
   3.750149323812806*^9}, 3.7501493671622295`*^9, {3.7501494011281652`*^9, 
   3.7501494248627205`*^9}, 3.750149507116145*^9, {3.7501502008580713`*^9, 
   3.750150214569867*^9}, {3.7529204436743245`*^9, 3.752920452052907*^9}, {
   3.7529274854419575`*^9, 3.7529274960216155`*^9}, {3.7529279001833024`*^9, 
   3.752927905330575*^9}, {3.752929318914818*^9, 3.752929319647857*^9}, {
   3.75292939152929*^9, 3.7529294001432514`*^9}, 3.761376232159975*^9, {
   3.7783241665243998`*^9, 
   3.77832419210402*^9}},ExpressionUUID->"93430b58-1c9d-4624-b6f4-\
ea996d9c4496"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Trajectory Simulation", "Subsubsection",ExpressionUUID->"c576b0e9-eb9e-4477-961e-2b4ccf10ea02"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FTSSetNumberOfSpecies", "[", "SpeciesNumber_Integer", "]"}], ":=", 
  RowBox[{"FTSSetNumberOfSpeciesP", "[", "SpeciesNumber", "]"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FTSGetNumberOfSpecies", "[", "]"}], ":=", 
   RowBox[{"FTSGetNumberOfSpeciesP", "[", "]"}]}], 
  "\n"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FTSSimulateParticleDiffusion", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"Method", "\[Rule]", "\"\<1D\>\""}], "}"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"FTSSimulateParticleDiffusion", "[", 
   RowBox[{"SpeciesIndex_Integer", ",", 
    RowBox[{"ShpereRadius_", "?", "NumberQ"}], ",", 
    RowBox[{"DiffConstant_", "?", "NumberQ"}], ",", 
    RowBox[{"ParticleConcentration_", "?", "NumberQ"}], ",", 
    RowBox[{"SimulationTime_", "?", "NumberQ"}], ",", 
    RowBox[{"TimeStep_", "?", "NumberQ"}], ",", "NewParticleDeltaT_Integer", 
    ",", "MinimalTrajectoryLength_Integer", ",", 
    RowBox[{"RMinThreshold_", "?", "NumberQ"}], ",", 
    RowBox[{"RMaxThreshold_", "?", "NumberQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{"DiffConstant", ">", "0"}], ",", "\[IndentingNewLine]", 
    RowBox[{"FTSSimulateParticleDiffusionP", "[", 
     RowBox[{
      RowBox[{"SpeciesIndex", "-", "1"}], ",", 
      RowBox[{"N", "@", "ShpereRadius"}], ",", 
      RowBox[{"N", "@", "DiffConstant"}], ",", 
      RowBox[{"N", "@", "ParticleConcentration"}], ",", 
      RowBox[{"N", "@", "SimulationTime"}], ",", 
      RowBox[{"N", "@", "TimeStep"}], ",", "NewParticleDeltaT", ",", 
      "MinimalTrajectoryLength", ",", 
      RowBox[{"N", "@", "RMinThreshold"}], ",", 
      RowBox[{"N", "@", "RMaxThreshold"}], ",", 
      RowBox[{"Which", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "Method", "]"}], "===", "\"\<1D\>\""}], 
        ",", "1", ",", 
        RowBox[{
         RowBox[{"OptionValue", "[", "Method", "]"}], "===", "\"\<2D\>\""}], 
        ",", "2", ",", "True", ",", "2"}], "]"}]}], "]"}], 
    "\[IndentingNewLine]", ",", "0"}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FTSSimulateParticleDiffusion", "[", 
   RowBox[{"SpeciesIndex_Integer", ",", 
    RowBox[{"ShpereRadius_", "?", "NumberQ"}], ",", 
    RowBox[{"DiffConstant_", "?", "NumberQ"}], ",", 
    RowBox[{"ParticleConcentration_", "?", "NumberQ"}], ",", 
    RowBox[{"SimulationTime_", "?", "NumberQ"}], ",", 
    RowBox[{"TimeStep_", "?", "NumberQ"}], ",", "NewParticleDeltaT_Integer", 
    ",", "MinimalTrajectoryLength_Integer", ",", 
    RowBox[{"RMinThreshold_", "?", "NumberQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"FTSSimulateParticleDiffusion", "[", 
   RowBox[{
   "SpeciesIndex", ",", "ShpereRadius", ",", "DiffConstant", ",", 
    "ParticleConcentration", ",", "SimulationTime", ",", "TimeStep", ",", 
    "NewParticleDeltaT", ",", "MinimalTrajectoryLength", ",", "RMinThreshold",
     ",", "ShpereRadius", ",", "opts"}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.7857603930742416`*^9, 3.785760498925152*^9}, {
  3.785760551243198*^9, 3.785760553668701*^9}, {3.785760665421033*^9, 
  3.7857606723105564`*^9}, {3.7857607544970474`*^9, 3.785760845509571*^9}, {
  3.7857608829913034`*^9, 3.785760888642205*^9}, {3.785760929215638*^9, 
  3.785760946802602*^9}},ExpressionUUID->"764a1b51-4c4b-495b-ac58-\
30ceeeda9f60"],

Cell[BoxData[
 RowBox[{" ", 
  RowBox[{
   RowBox[{"FTSSimulateParticleDiffusionInClosedSphere", "[", 
    RowBox[{"SpeciesIndex_Integer", ",", 
     RowBox[{"ShpereRadius_", "?", "NumberQ"}], ",", 
     RowBox[{"DiffConstant_", "?", "NumberQ"}], ",", "ParticleNumber_Integer",
      ",", 
     RowBox[{"SimulationTime_", "?", "NumberQ"}], ",", 
     RowBox[{"TimeStep_", "?", "NumberQ"}], ",", 
     RowBox[{"RMaxThreshold_", "?", "NumberQ"}], ",", " ", 
     RowBox[{"WallStickyness_", "?", "NumberQ"}]}], "]"}], ":=", 
   RowBox[{"FTSSimulateParticleDiffusionInClosedSphereP", "[", 
    RowBox[{
     RowBox[{"SpeciesIndex", "-", "1"}], ",", 
     RowBox[{"N", "@", "ShpereRadius"}], ",", 
     RowBox[{"N", "@", 
      RowBox[{"Abs", "@", "DiffConstant"}]}], ",", "ParticleNumber", ",", 
     RowBox[{"N", "@", "SimulationTime"}], ",", 
     RowBox[{"N", "@", "TimeStep"}], ",", 
     RowBox[{"N", "@", "RMaxThreshold"}], ",", " ", 
     RowBox[{"N", "@", "WallStickyness"}]}], "]"}]}]}]], "Input",
 CellChangeTimes->{{3.783677638203571*^9, 
  3.7836776497018423`*^9}},ExpressionUUID->"665b2f3e-8fdc-480d-89a5-\
0c87ac22486c"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FTSSimulateParticleDiffusionInClosedCylinder", "[", 
   RowBox[{"SpeciesIndex_Integer", ",", 
    RowBox[{"CylinderRadius_", "?", "NumberQ"}], ",", 
    RowBox[{"CylinderHalfLength_", "?", "NumberQ"}], ",", 
    RowBox[{"DiffConstant_", "?", "NumberQ"}], ",", "ParticleNumber_Integer", 
    ",", 
    RowBox[{"SimulationTime_", "?", "NumberQ"}], ",", 
    RowBox[{"TimeStep_", "?", "NumberQ"}], ",", 
    RowBox[{"RMaxThreshold_", "?", "NumberQ"}], ",", " ", 
    RowBox[{"WallStickyness_", "?", "NumberQ"}]}], "]"}], ":=", 
  RowBox[{"FTSSimulateParticleDiffusionInClosedCylinderP", "[", 
   RowBox[{
    RowBox[{"SpeciesIndex", "-", "1"}], ",", 
    RowBox[{"N", "@", "CylinderRadius"}], ",", 
    RowBox[{"N", "@", "CylinderHalfLength"}], ",", 
    RowBox[{"N", "@", 
     RowBox[{"Abs", "@", "DiffConstant"}]}], ",", "ParticleNumber", ",", 
    RowBox[{"N", "@", "SimulationTime"}], ",", 
    RowBox[{"N", "@", "TimeStep"}], ",", 
    RowBox[{"N", "@", "RMaxThreshold"}], ",", " ", 
    RowBox[{"N", "@", "WallStickyness"}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.783677765837721*^9, 
  3.783677775355282*^9}},ExpressionUUID->"e27c3c33-c7a1-43b3-8a1e-\
26dd97bac80b"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FTSSimulateImmobilizedParticle", "[", 
   RowBox[{
    RowBox[{"SimulationTime_", "?", "NumberQ"}], ",", 
    RowBox[{"TimeStep_", "?", "NumberQ"}]}], "]"}], ":=", 
  RowBox[{"FTSSimulateImobilizedParticleP", "[", 
   RowBox[{
    RowBox[{"N", "@", "SimulationTime"}], ",", 
    RowBox[{"N", "@", "TimeStep"}]}], "]"}]}]], "Input",
 CellChangeTimes->{
  3.765195077885104*^9},ExpressionUUID->"a857cb07-ff7b-4014-8772-\
e5a4419142d0"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FTSSimulateFRETpair", "[", 
   RowBox[{
    RowBox[{"trajectory", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], ",", 
    RowBox[{"R0_", "?", "NumericQ"}], ",", 
    RowBox[{"TimeStep_", "?", "NumericQ"}]}], "]"}], ":=", 
  RowBox[{"FTSSimulateFRETpairP", "[", 
   RowBox[{
    RowBox[{"N", "@", "trajectory"}], ",", 
    RowBox[{"N", "@", "R0"}], ",", 
    RowBox[{"N", "@", "TimeStep"}]}], "]"}]}]], "Input",ExpressionUUID->\
"aa623f78-a90d-4610-b3d4-508f20dbea06"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FTSNewParticleConcentration", "[", 
   RowBox[{
    RowBox[{"ShpereRadius_", "?", "NumberQ"}], ",", 
    RowBox[{"DiffConstant_", "?", "NumberQ"}], ",", 
    RowBox[{"ParticleConcentration_", "?", "NumberQ"}], ",", 
    RowBox[{"radius_", "?", "NumberQ"}], ",", 
    RowBox[{"time_", "?", "NumberQ"}]}], "]"}], ":=", 
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{"radius", ">", "ShpereRadius"}], ",", "ParticleConcentration", 
    ",", "\n", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{"time", "<=", "0"}], ",", "0", ",", 
      RowBox[{
       RowBox[{"FTSProbabilityDensityP", "[", 
        RowBox[{
         RowBox[{"N", "@", "ShpereRadius"}], ",", 
         RowBox[{"N", "@", "DiffConstant"}], ",", 
         RowBox[{"N", "@", "ParticleConcentration"}], ",", 
         RowBox[{"N", "@", "radius"}], ",", 
         RowBox[{"N", "@", "time"}]}], "]"}], "/", 
       RowBox[{"(", 
        RowBox[{"4", "\[Pi]", " ", 
         RowBox[{"radius", "^", "2"}]}], ")"}]}]}], "]"}]}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FTSMeanNewParticleNumberInSphere", "[", 
    RowBox[{
     RowBox[{"ShpereRadius_", "?", "NumberQ"}], ",", 
     RowBox[{"DiffConstant_", "?", "NumberQ"}], ",", 
     RowBox[{"ParticleConcentration_", "?", "NumberQ"}], ",", 
     RowBox[{"time_", "?", "NumberQ"}]}], "]"}], ":=", 
   RowBox[{"FTSMeanParticelNumberEnteringTheSphereP", "[", 
    RowBox[{
     RowBox[{"N", "@", "ShpereRadius"}], ",", 
     RowBox[{"N", "@", "DiffConstant"}], ",", 
     RowBox[{"N", "@", "ParticleConcentration"}], ",", 
     RowBox[{"N", "@", "time"}]}], "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{"FTSRandomPositionInSphere", "[", 
   RowBox[{
    RowBox[{"ShpereRadius_", "?", "NumberQ"}], ",", 
    RowBox[{"DiffConstant_", "?", "NumberQ"}], ",", 
    RowBox[{"ParticleConcentration_", "?", "NumberQ"}], ",", 
    RowBox[{"time_", "?", "NumberQ"}]}], "]"}], ":=", 
  RowBox[{"FTSRandomPositionInSphereP", "[", 
   RowBox[{
    RowBox[{"N", "@", "ShpereRadius"}], ",", 
    RowBox[{"N", "@", "DiffConstant"}], ",", 
    RowBox[{"N", "@", "ParticleConcentration"}], ",", 
    RowBox[{"N", "@", "time"}]}], "]"}]}]}], "Input",
 CellChangeTimes->{
  3.765195682630679*^9},ExpressionUUID->"3667f74d-3b78-4270-98e1-\
ecae41725671"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"FTSGetTrajectories", "[", 
    RowBox[{"SpeciesIndex_Integer", ",", 
     RowBox[{"Span", "[", 
      RowBox[{"trajecIndex1_Integer", ",", "trajecIndex2_Integer"}], "]"}], 
     ",", 
     RowBox[{"rmax_", "?", "NumberQ"}], ",", " ", "rstep_Integer"}], "]"}], ":=", 
   RowBox[{"FTSGetTrajectories2P", "[", 
    RowBox[{
     RowBox[{"SpeciesIndex", "-", "1"}], ",", 
     RowBox[{"trajecIndex1", "-", "1"}], ",", "trajecIndex2", ",", 
     RowBox[{"N", "@", "rmax"}], ",", "rstep"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"FTSGetTrajectories", "[", 
     RowBox[{"SpeciesIndex_Integer", ",", 
      RowBox[{"Span", "[", 
       RowBox[{"trajecIndex1_Integer", ",", "All"}], "]"}], ",", 
      RowBox[{"rmax_", "?", "NumberQ"}], ",", "rstep_Integer"}], "]"}], ":=", 
    RowBox[{"FTSGetTrajectories", "[", 
     RowBox[{"SpeciesIndex", ",", 
      RowBox[{"Span", "[", 
       RowBox[{"trajecIndex1", ",", 
        RowBox[{"-", "1"}]}], "]"}], ",", "rmax", ",", "rstep"}], "]"}]}], 
   ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", "\n", 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FTSDistanceTrajectory", "[", "tr_", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"\[CapitalDelta]", ",", "f"}], "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"\[CapitalDelta]", "=", 
      RowBox[{"Global`TsTimestep", "/.", 
       RowBox[{"tr", "[", 
        RowBox[{"[", "1", "]"}], "]"}]}]}], ";", "\n", 
     RowBox[{
      RowBox[{"f", "[", "dat_", "]"}], ":=", 
      RowBox[{"Module", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"d", "=", 
          RowBox[{"dat", "[", 
           RowBox[{"[", "2", "]"}], "]"}]}], "}"}], ",", "\n", 
        RowBox[{
         RowBox[{
          RowBox[{"d", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "2"}], "]"}], "]"}], "=", 
          RowBox[{"Map", "[", 
           RowBox[{"Norm", ",", 
            RowBox[{"d", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "2"}], "]"}], "]"}]}], "]"}]}], ";", "\n", 
         RowBox[{
          RowBox[{"d", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "1"}], "]"}], "]"}], "=", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             RowBox[{"\[CapitalDelta]", " ", 
              RowBox[{"d", "[", 
               RowBox[{"[", 
                RowBox[{"All", ",", "1"}], "]"}], "]"}]}], "+", 
             RowBox[{"dat", "[", 
              RowBox[{"[", "1", "]"}], "]"}]}], ")"}], 
           RowBox[{"10", "^", 
            RowBox[{"-", "6"}]}]}]}], ";", "\n", "d"}]}], "\n", "]"}]}], ";", 
     "\n", 
     RowBox[{"Map", "[", 
      RowBox[{"f", ",", 
       RowBox[{"tr", "[", 
        RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}]}], "\n", "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FTSIntensityTrajectory", "[", 
   RowBox[{"tr_", ",", "I0_", ",", "w0_", ",", "z0_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"\[CapitalDelta]", ",", "f", ",", "intensity"}], "}"}], ",", 
    "\n", 
    RowBox[{
     RowBox[{"\[CapitalDelta]", "=", 
      RowBox[{"Global`TsTimestep", "/.", 
       RowBox[{"tr", "[", 
        RowBox[{"[", "1", "]"}], "]"}]}]}], ";", "\n", 
     RowBox[{
      RowBox[{"intensity", "[", 
       RowBox[{"{", 
        RowBox[{"r_", ",", "z_"}], "}"}], "]"}], ":=", 
      RowBox[{"I0", " ", 
       RowBox[{"Exp", "[", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"2.", 
              RowBox[{"r", "^", "2"}]}], ")"}], "/", 
            RowBox[{"w0", "^", "2"}]}], ")"}]}], "-", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{"2.", 
            RowBox[{"z", "^", "2"}]}], ")"}], "/", 
          RowBox[{"z0", "^", "2"}]}]}], "]"}]}]}], ";", "\n", 
     RowBox[{
      RowBox[{"intensity", "[", "r_", "]"}], ":=", 
      RowBox[{"I0", " ", 
       RowBox[{"Exp", "[", 
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{"2.", 
             RowBox[{"r", "^", "2"}]}], ")"}], "/", 
           RowBox[{"w0", "^", "2"}]}], ")"}]}], "]"}]}]}], ";", "\n", 
     RowBox[{
      RowBox[{"f", "[", "dat_", "]"}], ":=", 
      RowBox[{"Module", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"d", "=", 
          RowBox[{"dat", "[", 
           RowBox[{"[", "2", "]"}], "]"}]}], "}"}], ",", "\n", 
        RowBox[{
         RowBox[{
          RowBox[{"d", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "2"}], "]"}], "]"}], "=", 
          RowBox[{"Map", "[", 
           RowBox[{"intensity", ",", 
            RowBox[{"d", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "2"}], "]"}], "]"}]}], "]"}]}], ";", "\n", 
         RowBox[{
          RowBox[{"d", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "1"}], "]"}], "]"}], "=", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             RowBox[{"\[CapitalDelta]", " ", 
              RowBox[{"d", "[", 
               RowBox[{"[", 
                RowBox[{"All", ",", "1"}], "]"}], "]"}]}], "+", 
             RowBox[{"dat", "[", 
              RowBox[{"[", "1", "]"}], "]"}]}], ")"}], 
           RowBox[{"10", "^", 
            RowBox[{"-", "6"}]}]}]}], ";", "\n", "d"}]}], "\n", "]"}]}], ";", 
     "\n", 
     RowBox[{"Map", "[", 
      RowBox[{"f", ",", 
       RowBox[{"tr", "[", 
        RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}]}], "\n", 
   "]"}]}], "\n"}], "Input",
 CellChangeTimes->{{3.78384946397736*^9, 3.783849629693509*^9}, {
  3.783851382582235*^9, 3.783851391086506*^9}, {3.783851448638694*^9, 
  3.783851450019003*^9}, {3.7838515121185513`*^9, 3.7838515175639997`*^9}, {
  3.7838516798692217`*^9, 3.7838518369048567`*^9}, {3.783851868200779*^9, 
  3.7838519841837606`*^9}, {3.7838520259491377`*^9, 3.7838520311123476`*^9}, {
  3.783852088001467*^9, 3.7838520893787804`*^9}, {3.783852129916447*^9, 
  3.7838521686977935`*^9}, {3.7838522287333546`*^9, 3.783852311447281*^9}, {
  3.7838528403337235`*^9, 3.7838528582927265`*^9}, {3.783855174465029*^9, 
  3.783855341944414*^9}, {3.7838554256552896`*^9, 3.7838555194464607`*^9}, {
  3.785762336503123*^9, 3.7857623370825777`*^9}, {3.785762734887272*^9, 
  3.7857627356313405`*^9}, {3.7857660405089703`*^9, 3.7857660619675927`*^9}, {
  3.7857661047242656`*^9, 
  3.7857661262147884`*^9}},ExpressionUUID->"9c55edec-7bef-49df-b02d-\
96c1a4cbb096"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"FTSRateList", "=", 
    RowBox[{"{", 
     RowBox[{"Repeated", "[", 
      RowBox[{
       RowBox[{"_", "?", "NumberQ"}], ",", "FNumberOfRoutes"}], "]"}], 
     "}"}]}], ";"}], "\n"}], "\n", 
 RowBox[{
  RowBox[{"FTSGetRDistribution", "[", 
   RowBox[{"speciesindex_Integer", ",", 
    RowBox[{"binwidth_", "?", "NumberQ"}], ",", " ", "bincount_Integer"}], 
   "]"}], ":=", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"(", 
         RowBox[{"i", "-", "0.5"}], ")"}], " ", "binwidth"}], ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", "bincount"}], "}"}]}], "]"}], ",", 
     RowBox[{"FTSGetRDistributionP", "[", 
      RowBox[{
       RowBox[{"speciesindex", "-", "1"}], ",", 
       RowBox[{"N", "@", "binwidth"}], ",", " ", "bincount"}], "]"}]}], "}"}],
    "\[Transpose]"}]}], "\n", 
 RowBox[{
  RowBox[{"FTSGetNumberOfParticleTrajectory", "[", 
   RowBox[{"speciesindex_Integer", ",", "binwidth_Integer", ",", " ", 
    RowBox[{"rmax_", "?", "NumberQ"}]}], "]"}], ":=", " ", 
  RowBox[{"FTSGetNumberOfParticleTrajectoryP", "[", 
   RowBox[{
    RowBox[{"speciesindex", "-", "1"}], ",", "binwidth", ",", " ", "rmax"}], 
   "]"}]}]}], "Input",ExpressionUUID->"4128ab50-2e91-4143-81b8-1b52854a5c95"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"FTSSimulateStateTrajectories", "[", 
    RowBox[{"{", 
     RowBox[{"species_Integer", ",", 
      RowBox[{"brightnesslist", ":", 
       RowBox[{"{", 
        RowBox[{"FTSRateList", ".."}], "}"}]}], ",", 
      RowBox[{"p0", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "FRealNumberQ"}], ".."}], "}"}]}], ",", 
      RowBox[{"Kmatrix", ":", 
       RowBox[{"_", "?", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"MatrixQ", "[", 
           RowBox[{"#", ",", "FRealNumberQ"}], "]"}], "&"}], ")"}]}]}]}], 
     "}"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"dim", "=", 
        RowBox[{"Length", "[", "p0", "]"}]}], ",", "escaperates", ",", 
       "transitionprobs"}], "}"}], ",", "\n", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"!", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"dim", "==", 
           RowBox[{"Length", "[", "brightnesslist", "]"}]}], " ", "&&", " ", 
          RowBox[{
           RowBox[{"Dimensions", "[", "Kmatrix", "]"}], "==", 
           RowBox[{"{", 
            RowBox[{"dim", ",", "dim"}], "}"}]}]}], ")"}]}], ",", "$Failed", 
       ",", "\n", 
       RowBox[{"(", "\n", 
        RowBox[{
         RowBox[{"escaperates", "=", 
          RowBox[{"Abs", "@", 
           RowBox[{"Diagonal", "[", "Kmatrix", "]"}]}]}], ";", "\n", 
         RowBox[{"transitionprobs", "=", 
          RowBox[{
           RowBox[{"Kmatrix", "\[Transpose]"}], "-", 
           RowBox[{"DiagonalMatrix", "[", 
            RowBox[{"Diagonal", "[", "Kmatrix", "]"}], "]"}]}]}], ";", "\n", 
         RowBox[{"transitionprobs", "=", 
          RowBox[{"MapIndexed", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{"#1", "==", 
                RowBox[{"ConstantArray", "[", 
                 RowBox[{"0", ",", 
                  RowBox[{"Length", "@", "transitionprobs"}]}], "]"}]}], ",", 
               RowBox[{"UnitVector", "[", 
                RowBox[{
                 RowBox[{"Length", "@", "transitionprobs"}], ",", 
                 RowBox[{"#2", "[", 
                  RowBox[{"[", "1", "]"}], "]"}]}], "]"}], ",", "#1"}], "]"}],
              "&"}], ",", "transitionprobs"}], "]"}]}], ";", "\n", 
         RowBox[{"FTSSimulateStateTrajectoriesP", "[", 
          RowBox[{
           RowBox[{"species", "-", "1"}], ",", "6", ",", 
           RowBox[{"N", "@", 
            RowBox[{"Flatten", "[", 
             RowBox[{"FExpandRoutelist", "/@", "brightnesslist"}], "]"}]}], 
           ",", 
           RowBox[{"N", "@", "p0"}], ",", 
           RowBox[{"N", "@", "escaperates"}], ",", 
           RowBox[{"N", "@", 
            RowBox[{"Flatten", "@", "transitionprobs"}]}]}], "]"}]}], "\n", 
        ")"}]}], "\n", "]"}]}], "\n", "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FTSSimulateStateTrajectories", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"species_Integer", ",", 
       RowBox[{"brightnesslist", ":", 
        RowBox[{"{", 
         RowBox[{"FTSRateList", ".."}], "}"}]}], ",", 
       RowBox[{"p0", ":", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "FRealNumberQ"}], ".."}], "}"}]}], ",", 
       RowBox[{"Kmatrix", ":", 
        RowBox[{"_", "?", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"MatrixQ", "[", 
            RowBox[{"#", ",", "FRealNumberQ"}], "]"}], "&"}], ")"}]}]}], ",", 
       RowBox[{"Kpowermatrix", ":", 
        RowBox[{"_", "?", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"MatrixQ", "[", 
            RowBox[{"#", ",", "FRealNumberQ"}], "]"}], "&"}], ")"}]}]}]}], 
      "}"}], ",", 
     RowBox[{"w0_", "?", "FRealNumberQ"}], ",", 
     RowBox[{"z0_", "?", "FRealNumberQ"}], ",", 
     RowBox[{"rmax_", "?", "FRealNumberQ"}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"dim", "=", 
        RowBox[{"Length", "[", "p0", "]"}]}], ",", "escaperates", ",", 
       "transitionprobs", ",", "pescaperates", ",", "ptransitionprobs"}], 
      "}"}], ",", "\n", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"!", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"dim", "==", 
           RowBox[{"Length", "[", "brightnesslist", "]"}]}], " ", "&&", " ", 
          RowBox[{
           RowBox[{"Dimensions", "[", "Kmatrix", "]"}], "==", 
           RowBox[{"{", 
            RowBox[{"dim", ",", "dim"}], "}"}]}]}], ")"}]}], ",", "$Failed", 
       ",", "\n", 
       RowBox[{"(", "\n", "\n", 
        RowBox[{
         RowBox[{"escaperates", "=", 
          RowBox[{"Abs", "@", 
           RowBox[{"Diagonal", "[", "Kmatrix", "]"}]}]}], ";", "\n", 
         RowBox[{"transitionprobs", "=", 
          RowBox[{
           RowBox[{"Kmatrix", "\[Transpose]"}], "-", 
           RowBox[{"DiagonalMatrix", "[", 
            RowBox[{"Diagonal", "[", "Kmatrix", "]"}], "]"}]}]}], ";", "\n", 
         RowBox[{"transitionprobs", "=", 
          RowBox[{"MapIndexed", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{"#1", "==", 
                RowBox[{"ConstantArray", "[", 
                 RowBox[{"0", ",", 
                  RowBox[{"Length", "@", "transitionprobs"}]}], "]"}]}], ",", 
               RowBox[{"UnitVector", "[", 
                RowBox[{
                 RowBox[{"Length", "@", "transitionprobs"}], ",", 
                 RowBox[{"#2", "[", 
                  RowBox[{"[", "1", "]"}], "]"}]}], "]"}], ",", "#1"}], "]"}],
              "&"}], ",", "transitionprobs"}], "]"}]}], ";", "\n", 
         RowBox[{"pescaperates", "=", 
          RowBox[{"Abs", "@", 
           RowBox[{"Diagonal", "[", "Kpowermatrix", "]"}]}]}], ";", "\n", 
         "\n", 
         RowBox[{"ptransitionprobs", "=", 
          RowBox[{
           RowBox[{"Kpowermatrix", "\[Transpose]"}], "-", 
           RowBox[{"DiagonalMatrix", "[", 
            RowBox[{"Diagonal", "[", "Kpowermatrix", "]"}], "]"}]}]}], ";", 
         "\n", 
         RowBox[{"ptransitionprobs", "=", 
          RowBox[{"MapIndexed", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{"#1", "==", 
                RowBox[{"ConstantArray", "[", 
                 RowBox[{"0", ",", 
                  RowBox[{"Length", "@", "ptransitionprobs"}]}], "]"}]}], ",", 
               RowBox[{"UnitVector", "[", 
                RowBox[{
                 RowBox[{"Length", "@", "ptransitionprobs"}], ",", 
                 RowBox[{"#2", "[", 
                  RowBox[{"[", "1", "]"}], "]"}]}], "]"}], ",", "#1"}], "]"}],
              "&"}], ",", "ptransitionprobs"}], "]"}]}], ";", "\n", 
         RowBox[{"FTSSimulateStateTrajectoriesPowerDependentP", "[", 
          RowBox[{
           RowBox[{"species", "-", "1"}], ",", "6", ",", 
           RowBox[{"N", "@", 
            RowBox[{"Flatten", "[", 
             RowBox[{"FExpandRoutelist", "/@", "brightnesslist"}], "]"}]}], 
           ",", 
           RowBox[{"N", "@", "p0"}], ",", 
           RowBox[{"N", "@", "escaperates"}], ",", 
           RowBox[{"N", "@", 
            RowBox[{"Flatten", "@", "transitionprobs"}]}], ",", 
           RowBox[{"N", "@", "pescaperates"}], ",", 
           RowBox[{"N", "@", 
            RowBox[{"Flatten", "@", "ptransitionprobs"}]}], ",", 
           RowBox[{"N", "@", "w0"}], ",", 
           RowBox[{"N", "@", "z0"}], ",", 
           RowBox[{"N", "@", "rmax"}]}], "]"}]}], "\n", ")"}]}], "\n", 
      "]"}]}], "\n", "\n", "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{"FTSSimulateStateTrajectories", "[", 
   RowBox[{"{", 
    RowBox[{"species_Integer", ",", 
     RowBox[{"brightnesslist", ":", 
      RowBox[{"{", 
       RowBox[{"FTSRateList", ".."}], "}"}]}], ",", 
     RowBox[{"p0", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "FRealNumberQ"}], ".."}], "}"}]}]}], "}"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"dim", "=", 
      RowBox[{"Length", "[", "p0", "]"}]}], "}"}], ",", "\n", 
    RowBox[{"FTSSimulateStateTrajectories", "[", 
     RowBox[{"{", 
      RowBox[{"species", ",", "brightnesslist", ",", "p0", ",", 
       RowBox[{"ConstantArray", "[", 
        RowBox[{"0", ",", 
         RowBox[{"{", 
          RowBox[{"dim", ",", "dim"}], "}"}]}], "]"}]}], "}"}], "]"}]}], "\n",
    "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FTSSimulateStateTrajectories", "[", 
   RowBox[{"{", 
    RowBox[{"species_Integer", ",", 
     RowBox[{"brightness", ":", "FTSRateList"}]}], "}"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "}"}], ",", "\n", 
    RowBox[{"FTSSimulateStateTrajectories", "[", 
     RowBox[{"{", 
      RowBox[{"species", ",", 
       RowBox[{"{", "brightness", "}"}], ",", 
       RowBox[{"{", "1", "}"}], ",", 
       RowBox[{"ConstantArray", "[", 
        RowBox[{"0", ",", 
         RowBox[{"{", 
          RowBox[{"1", ",", "1"}], "}"}]}], "]"}]}], "}"}], "]"}]}], "\n", 
   "]"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FTSSimulateStateTrajectories", "[", 
    RowBox[{"specieslist", ":", 
     RowBox[{"{", 
      RowBox[{"_List", ".."}], "}"}]}], "]"}], ":=", 
   RowBox[{"Map", "[", 
    RowBox[{"FTSSimulateStateTrajectories", ",", "specieslist"}], "]"}]}], 
  "\n"}], "\n", 
 RowBox[{
  RowBox[{"FTSClearStateTrajectories", "[", "SpeciesIndex_Integer", "]"}], ":=", 
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"SpeciesIndex", ">", "0"}], " ", "&&", " ", 
     RowBox[{"SpeciesIndex", "<=", 
      RowBox[{"FTSGetNumberOfSpecies", "[", "]"}]}]}], ",", 
    RowBox[{"FTSClearStateTrajectoriesP", "[", 
     RowBox[{"SpeciesIndex", "-", "1"}], "]"}], ",", "0"}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FTSClearStateTrajectories", "[", "]"}], ":=", 
  RowBox[{"Do", "[", 
   RowBox[{
    RowBox[{"FTSClearStateTrajectories", "[", "si", "]"}], ",", 
    RowBox[{"{", 
     RowBox[{"si", ",", "1", ",", 
      RowBox[{"FTSGetNumberOfSpecies", "[", "]"}]}], "}"}]}], 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.7999935306669903`*^9, 
  3.7999935456240253`*^9}},ExpressionUUID->"9bc7558b-e43f-40ce-94e8-\
e04e60095d04"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"FTSSimulateFRETStateTrajectories", "[", 
    RowBox[{"{", 
     RowBox[{"species_Integer", ",", 
      RowBox[{"rateparams", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumericQ"}], ",", " ", 
           RowBox[{"_", "?", "NumericQ"}], ",", " ", 
           RowBox[{"_", "?", "NumericQ"}]}], "}"}], ".."}], "}"}]}], ",", 
      RowBox[{"p0", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "FRealNumberQ"}], ".."}], "}"}]}], ",", 
      RowBox[{"Kmatrix", ":", 
       RowBox[{"_", "?", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"MatrixQ", "[", 
           RowBox[{"#", ",", "FRealNumberQ"}], "]"}], "&"}], ")"}]}]}], ",", 
      " ", 
      RowBox[{"rcm", ":", 
       RowBox[{"_", "?", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"MatrixQ", "[", 
           RowBox[{"#", ",", "FRealNumberQ"}], "]"}], "&"}], ")"}]}]}], ",", 
      RowBox[{"AcceptorDirectExcitation_", "?", "NumericQ"}]}], "}"}], "]"}], 
   ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"dim", "=", 
        RowBox[{"Length", "[", "p0", "]"}]}], ",", "escaperates", ",", 
       "transitionprobs"}], "}"}], ",", "\n", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"!", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"dim", "==", 
           RowBox[{"Length", "[", "rateparams", "]"}]}], " ", "&&", " ", 
          RowBox[{
           RowBox[{"Dimensions", "[", "Kmatrix", "]"}], "==", 
           RowBox[{"{", 
            RowBox[{"dim", ",", "dim"}], "}"}]}]}], ")"}]}], ",", "$Failed", 
       ",", "\n", 
       RowBox[{"(", "\n", 
        RowBox[{"FTSSimulateFRETStateTrajectoriesP", "[", 
         RowBox[{
          RowBox[{"species", "-", "1"}], ",", 
          RowBox[{"N", "@", "AcceptorDirectExcitation"}], ",", 
          RowBox[{"N", "@", "rateparams"}], ",", 
          RowBox[{"N", "@", "p0"}], ",", 
          RowBox[{"N", "@", "Kmatrix"}], ",", 
          RowBox[{"N", "@", "rcm"}]}], "]"}], "\n", ")"}]}], "\n", "]"}]}], 
    "\n", "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FTSSimulateFRETStateTrajectories", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"species_Integer", ",", 
       RowBox[{"rateparams", ":", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"_", "?", "NumericQ"}], ",", " ", 
            RowBox[{"_", "?", "NumericQ"}], ",", " ", 
            RowBox[{"_", "?", "NumericQ"}]}], "}"}], ".."}], "}"}]}], ",", 
       RowBox[{"p0", ":", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "FRealNumberQ"}], ".."}], "}"}]}], ",", 
       RowBox[{"Kmatrix", ":", 
        RowBox[{"_", "?", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"MatrixQ", "[", 
            RowBox[{"#", ",", "FRealNumberQ"}], "]"}], "&"}], ")"}]}]}], ",", 
       RowBox[{"Kpowermatrix", ":", 
        RowBox[{"_", "?", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"MatrixQ", "[", 
            RowBox[{"#", ",", "FRealNumberQ"}], "]"}], "&"}], ")"}]}]}], ",", 
       " ", 
       RowBox[{"rcm", ":", 
        RowBox[{"_", "?", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"MatrixQ", "[", 
            RowBox[{"#", ",", "FRealNumberQ"}], "]"}], "&"}], ")"}]}]}], ",", 
       RowBox[{"AcceptorDirectExcitation_", "?", "NumericQ"}]}], "}"}], ",", 
     RowBox[{"w0_", "?", "FRealNumberQ"}], ",", 
     RowBox[{"z0_", "?", "FRealNumberQ"}], ",", 
     RowBox[{"rmax_", "?", "FRealNumberQ"}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"dim", "=", 
        RowBox[{"Length", "[", "p0", "]"}]}], ",", "escaperates", ",", 
       "transitionprobs", ",", "pescaperates", ",", "ptransitionprobs"}], 
      "}"}], ",", "\n", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"!", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"dim", "==", 
           RowBox[{"Length", "[", "rateparams", "]"}]}], " ", "&&", " ", 
          RowBox[{
           RowBox[{"Dimensions", "[", "Kmatrix", "]"}], "==", 
           RowBox[{"{", 
            RowBox[{"dim", ",", "dim"}], "}"}]}]}], ")"}]}], ",", "$Failed", 
       ",", "\n", 
       RowBox[{"(", "\n", 
        RowBox[{"FTSSimulateFRETStateTrajectoriesPowerDependentP", "[", 
         RowBox[{
          RowBox[{"species", "-", "1"}], ",", "AcceptorDirectExcitation", ",", 
          RowBox[{"N", "@", "w0"}], ",", 
          RowBox[{"N", "@", "z0"}], ",", 
          RowBox[{"N", "@", "rmax"}], ",", 
          RowBox[{"N", "@", "rateparams"}], ",", 
          RowBox[{"N", "@", "p0"}], ",", 
          RowBox[{"N", "@", "Kmatrix"}], ",", 
          RowBox[{"N", "@", "Kpowermatrix"}], ",", 
          RowBox[{"N", "@", "rcm"}]}], "]"}], "\n", ")"}]}], "\n", "]"}]}], 
    "\n", "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FTSSimulateFRETStateTrajectories", "[", 
    RowBox[{"{", 
     RowBox[{"species_Integer", ",", 
      RowBox[{"rateparams", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumericQ"}], ",", " ", 
           RowBox[{"_", "?", "NumericQ"}], ",", " ", 
           RowBox[{"_", "?", "NumericQ"}]}], "}"}], ".."}], "}"}]}], ",", 
      RowBox[{"p0", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "FRealNumberQ"}], ".."}], "}"}]}]}], "}"}], "]"}], 
   ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"dim", "=", 
       RowBox[{"Length", "[", "p0", "]"}]}], "}"}], ",", "\n", 
     RowBox[{"FTSSimulateFRETStateTrajectories", "[", 
      RowBox[{"{", 
       RowBox[{"species", ",", "rateparams", ",", "p0", ",", 
        RowBox[{"ConstantArray", "[", 
         RowBox[{"0", ",", 
          RowBox[{"{", 
           RowBox[{"dim", ",", "dim"}], "}"}]}], "]"}]}], "}"}], "]"}]}], 
    "\n", "]"}]}], "\n", "\n"}], "\n"}], "Input",
 CellChangeTimes->{{3.7999935306669903`*^9, 3.7999935456240253`*^9}, {
   3.799993853624518*^9, 3.799993929475791*^9}, {3.7999941220281496`*^9, 
   3.799994143953556*^9}, 3.7999941751761026`*^9, {3.7999942337984285`*^9, 
   3.7999943277513123`*^9}, {3.7999943656181145`*^9, 
   3.7999944028775187`*^9}, {3.8000102593322916`*^9, 3.800010339162962*^9}, {
   3.800010433015253*^9, 3.8000105320754976`*^9}, {3.8000125182146225`*^9, 
   3.8000125316048393`*^9}, 3.8000125900128384`*^9, {3.800012631167863*^9, 
   3.800012702626873*^9}, {3.8000128940018167`*^9, 
   3.8000129232267046`*^9}},ExpressionUUID->"3b179d0a-b381-4ee0-9853-\
58e2fc48f6b3"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FTSSimulateTTTR", "[", 
   RowBox[{
    RowBox[{"bg", ":", "FTSRateList"}], ",", 
    RowBox[{"rmax_", "?", "NumberQ"}], ",", 
    RowBox[{"w0_", "?", "NumberQ"}], ",", 
    RowBox[{"z0_", "?", "NumberQ"}]}], "]"}], ":=", 
  RowBox[{"FTSSimulateTTTRP", "[", 
   RowBox[{
    RowBox[{"N", "@", 
     RowBox[{"FExpandRoutelist", "@", "bg"}]}], ",", 
    RowBox[{"N", "@", "rmax"}], ",", 
    RowBox[{"N", "@", "w0"}], ",", 
    RowBox[{"N", "@", "z0"}]}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FTSSimulateTTTR", "[", 
   RowBox[{
    RowBox[{"bg", ":", "FTSRateList"}], ",", 
    RowBox[{"rmax_", "?", "NumberQ"}], ",", 
    RowBox[{"w0_", "?", "NumberQ"}]}], "]"}], ":=", 
  RowBox[{"FTSSimulateTTTR", "[", 
   RowBox[{"bg", ",", "rmax", ",", "w0", ",", "w0"}], "]"}]}]}], "Input",Expre\
ssionUUID->"6ab27073-a462-426a-80e5-8fff8938ccfd"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FTSSimulateTTTRLifeTimes", "[", 
   RowBox[{
    RowBox[{"bg", ":", "FTSRateList"}], ",", 
    RowBox[{"rmax_", "?", "NumberQ"}], ",", 
    RowBox[{"w0_", "?", "NumberQ"}], ",", 
    RowBox[{"z0_", "?", "NumberQ"}], ",", 
    RowBox[{"decayrates", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"FTSRateList", ".."}], "}"}], ".."}], "}"}]}]}], "]"}], ":=", 
  RowBox[{"FTSSimulateTTTRLifeTimesP", "[", 
   RowBox[{
    RowBox[{"N", "@", 
     RowBox[{"FExpandRoutelist", "@", "bg"}]}], ",", 
    RowBox[{"N", "@", "rmax"}], ",", 
    RowBox[{"N", "@", "w0"}], ",", 
    RowBox[{"N", "@", "z0"}], ",", 
    RowBox[{"Length", "/@", "decayrates"}], ",", 
    RowBox[{"N", "@", 
     RowBox[{"Flatten", "@", " ", 
      RowBox[{"Map", "[", 
       RowBox[{"FExpandRoutelist", ",", "decayrates", ",", 
        RowBox[{"{", "2", "}"}]}], "]"}]}]}]}], "]"}]}]], "Input",ExpressionUU\
ID->"fc023317-99f4-4411-a8ff-b9798d83b48a"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FTSSimulateTTTRLifeTimes", "[", 
   RowBox[{
    RowBox[{"bg", ":", "FTSRateList"}], ",", 
    RowBox[{"rmax_", "?", "NumberQ"}], ",", 
    RowBox[{"w0_", "?", "NumberQ"}], ",", 
    RowBox[{"z0_", "?", "NumberQ"}], ",", 
    RowBox[{"liftimedecays", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}], ".."}], "}"}], 
         ".."}], "}"}], ".."}], "}"}]}], ",", 
    RowBox[{"bgdecays", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumberQ"}], ".."}], "}"}], ".."}], "}"}]}]}], 
   "]"}], ":=", 
  RowBox[{"FTSSimulateTTTRLifeTimesP2", "[", 
   RowBox[{
    RowBox[{"N", "@", 
     RowBox[{"FExpandRoutelist", "@", "bg"}]}], ",", 
    RowBox[{"N", "@", "rmax"}], ",", 
    RowBox[{"N", "@", "w0"}], ",", 
    RowBox[{"N", "@", "z0"}], ",", 
    RowBox[{"N", "@", "liftimedecays"}], ",", 
    RowBox[{"N", "@", "bgdecays"}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.765629150675257*^9, 3.7656292818048553`*^9}, {
  3.765629312434827*^9, 
  3.765629348507918*^9}},ExpressionUUID->"215346d4-1044-4b8b-99c7-\
4b576a79e4c3"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FTSSimulateTTTRLifeTimes", "[", 
   RowBox[{
    RowBox[{"bg", ":", "FTSRateList"}], ",", 
    RowBox[{"rmax_", "?", "NumberQ"}], ",", 
    RowBox[{"w0_", "?", "NumberQ"}], ",", 
    RowBox[{"decayrates", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"FTSRateList", ".."}], "}"}], ".."}], "}"}]}]}], "]"}], ":=", 
  RowBox[{"FTSSimulateTTTRLifeTimes", "[", 
   RowBox[{"bg", ",", "rmax", ",", "w0", ",", "w0", ",", "decayrates"}], 
   "]"}]}]], "Input",ExpressionUUID->"a2991603-290f-486a-875e-9f0711e3c0e0"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FTSGetIntensityTrajectory", "[", 
   RowBox[{
    RowBox[{"bg", ":", "FTSRateList"}], ",", 
    RowBox[{"rmax_", "?", "NumberQ"}], ",", 
    RowBox[{"w0_", "?", "NumberQ"}], ",", 
    RowBox[{"z0_", "?", "NumberQ"}], ",", "start_Integer", ",", " ", 
    "bincount_Integer"}], "]"}], ":=", 
  RowBox[{"FTSGetIntensityTrajectoryP", "[", 
   RowBox[{
    RowBox[{"N", "@", 
     RowBox[{"FExpandRoutelist", "@", "bg"}]}], ",", 
    RowBox[{"N", "@", "rmax"}], ",", 
    RowBox[{"N", "@", "w0"}], ",", 
    RowBox[{"N", "@", "z0"}], ",", "start", ",", " ", "bincount"}], 
   "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FTSGetIntensityTrajectory", "[", 
   RowBox[{
    RowBox[{"bg", ":", "FTSRateList"}], ",", 
    RowBox[{"rmax_", "?", "NumberQ"}], ",", 
    RowBox[{"w0_", "?", "NumberQ"}], ",", "start_Integer", ",", " ", 
    "bincount_Integer"}], "]"}], ":=", 
  RowBox[{"FTSGetIntensityTrajectory", "[", 
   RowBox[{
   "bg", ",", "rmax", ",", "w0", ",", "w0", ",", "start", ",", " ", 
    "bincount"}], "]"}]}]}], "Input",ExpressionUUID->"9b8ab34b-5af1-438a-8195-\
449d43211bbb"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"FTSSaveTrajectories", "[", "filename_String", "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "fn", "}"}], ",", "\n", 
     RowBox[{
      RowBox[{"fn", "=", 
       RowBox[{"StringReplace", "[", 
        RowBox[{
         RowBox[{"ExpandFileName", "[", "filename", "]"}], ",", 
         RowBox[{"\"\<\\\\\>\"", "->", "\"\</\>\""}]}], "]"}]}], ";", "\n", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"!", 
         RowBox[{"FileExistsQ", "[", "fn", "]"}]}], ",", 
        RowBox[{"FTSSaveTrajectoriesP", "[", "fn", "]"}], ",", "0"}], 
       "]"}]}]}], "\n", "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{"FTSLoadTrajectories", "[", "filename_String", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "fn", "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"fn", "=", 
      RowBox[{"StringReplace", "[", 
       RowBox[{
        RowBox[{"ExpandFileName", "[", "filename", "]"}], ",", 
        RowBox[{"\"\<\\\\\>\"", "->", "\"\</\>\""}]}], "]"}]}], ";", "\n", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"FileExistsQ", "[", "fn", "]"}], ",", 
       RowBox[{"FTSLoadTrajectoriesP", "[", "fn", "]"}], ",", "0"}], 
      "]"}]}]}], "\n", "]"}]}]}], "Input",ExpressionUUID->"cd505e48-1393-4a30-\
a832-c9e76186e2fe"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"FSimulatePhotonTrajectory", "[", 
    RowBox[{
    "p0_List", ",", "Kstatic_List", ",", "KFRET_List", ",", "VD_List", ",", 
     "VA_List", ",", 
     RowBox[{"kFTrajectory", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], ",", 
     RowBox[{"EmissivityTrajD", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], ",", 
     RowBox[{"EmissivityTrajA", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], ",", 
     "substeps_Integer"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"Length", "[", "EmissivityTrajD", "]"}], "\[NotEqual]", 
          RowBox[{"Length", "[", "kFTrajectory", "]"}]}], "||", " ", 
         RowBox[{
          RowBox[{"Length", "[", "EmissivityTrajA", "]"}], "\[NotEqual]", 
          RowBox[{"Length", "[", "kFTrajectory", "]"}]}]}], ",", 
        RowBox[{"Return", "[", "$Failed", "]"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"FSimulatePhotonTrajectoryP", "[", 
       RowBox[{
        RowBox[{"N", "@", "p0"}], ",", 
        RowBox[{"N", "[", "Kstatic", "]"}], ",", 
        RowBox[{"N", "[", "KFRET", "]"}], ",", 
        RowBox[{"N", "[", "VD", "]"}], ",", 
        RowBox[{"N", "[", "VA", "]"}], ",", 
        RowBox[{"N", "@", "kFTrajectory"}], ",", 
        RowBox[{"N", "@", "EmissivityTrajD"}], ",", 
        RowBox[{"N", "@", "EmissivityTrajA"}], ",", "substeps"}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FSimulatePhotonTrajectory", "[", 
    RowBox[{
    "p0_List", ",", "Kstatic_List", ",", "KFRET_List", ",", "VD_List", ",", 
     "VA_List", ",", 
     RowBox[{"kFTrajectory", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], ",", 
     RowBox[{"EmissivityTraj", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], ",", 
     "substeps_Integer"}], "]"}], ":=", 
   RowBox[{"FSimulatePhotonTrajectory", "[", 
    RowBox[{
    "p0", ",", "Kstatic", ",", "KFRET", ",", "VD", ",", "VA", ",", 
     "kFTrajectory", ",", "EmissivityTraj", ",", "EmissivityTraj", ",", 
     "substeps"}], "]"}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FSimulatePhotonTrajectory", "[", 
   RowBox[{
   "p0_List", ",", "Kstatic_List", ",", "KFRET_List", ",", "VD_List", ",", 
    "VA_List", ",", 
    RowBox[{"kFTrajectory", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], ",", 
    "substeps_Integer"}], "]"}], ":=", 
  RowBox[{"FSimulatePhotonTrajectory", "[", 
   RowBox[{
   "p0", ",", "Kstatic", ",", "KFRET", ",", "VD", ",", "VA", ",", 
    "kFTrajectory", ",", 
    RowBox[{"ConstantArray", "[", 
     RowBox[{"1.", ",", 
      RowBox[{"Length", "[", "kFTrajectory", "]"}]}], "]"}], ",", 
    RowBox[{"ConstantArray", "[", 
     RowBox[{"1.", ",", 
      RowBox[{"Length", "[", "kFTrajectory", "]"}]}], "]"}], ",", 
    "substeps"}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.8135801986778903`*^9, 3.813580241067562*^9}, {
   3.813580429541086*^9, 3.8135804589440165`*^9}, {3.8135805046009054`*^9, 
   3.8135805427268834`*^9}, {3.813580716811273*^9, 3.813580765059269*^9}, {
   3.8296409739999623`*^9, 3.8296409746730576`*^9}, {3.829641013039677*^9, 
   3.829641110222222*^9}, {3.8296415477588263`*^9, 3.8296416031588244`*^9}, 
   3.8296423027296762`*^9, {3.8509006380379696`*^9, 3.8509006898335547`*^9}, {
   3.8509071754601717`*^9, 
   3.850907188248757*^9}},ExpressionUUID->"f5741080-3d35-4a47-96f8-\
b7b16ab2bb80"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FSimulateNanoSecondFCS", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"FOutput", "->", "FData"}], "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FSimulateNanoSecondFCS", "[", 
    RowBox[{
     RowBox[{"p0", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], ",", 
     RowBox[{"Kstatic_", "?", "FNumericMatrixQ"}], ",", 
     RowBox[{"KFRET_", "?", "FNumericMatrixQ"}], ",", 
     RowBox[{"VD_", "?", "FNumericMatrixQ"}], ",", 
     RowBox[{"VA_", "?", "FNumericMatrixQ"}], ",", 
     RowBox[{"kFTrajectory", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], ",", 
     RowBox[{"EmissivityTrajD", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], ",", 
     RowBox[{"EmissivityTrajA", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], ",", 
     RowBox[{"dt_", "?", "NumericQ"}], ",", "substeps_Integer", ",", 
     RowBox[{"taumax_", "?", "NumericQ"}], ",", 
     RowBox[{"dtau_", "?", "NumericQ"}], ",", "repeats_Integer", ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "cdata", ",", "gdd", ",", "gda", ",", "gad", ",", "gaa", ",", "taulist",
        ",", 
       RowBox[{"dtsub", "=", 
        RowBox[{"N", "[", 
         RowBox[{"dt", "/", "substeps"}], "]"}]}]}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"Length", "[", "EmissivityTrajD", "]"}], "\[NotEqual]", 
          RowBox[{"Length", "[", "kFTrajectory", "]"}]}], "||", " ", 
         RowBox[{
          RowBox[{"Length", "[", "EmissivityTrajA", "]"}], "\[NotEqual]", 
          RowBox[{"Length", "[", "kFTrajectory", "]"}]}]}], ",", 
        RowBox[{"Return", "[", "$Failed", "]"}]}], "]"}], ";", 
      RowBox[{"cdata", "=", 
       RowBox[{
        RowBox[{"FSimulateNanoSecondFCSP", "[", 
         RowBox[{
          RowBox[{"N", "@", "p0"}], ",", 
          RowBox[{
           RowBox[{"N", "[", "Kstatic", "]"}], "dtsub"}], ",", 
          RowBox[{
           RowBox[{"N", "[", "KFRET", "]"}], "dtsub"}], ",", 
          RowBox[{
           RowBox[{"N", "[", "VD", "]"}], "dtsub"}], ",", 
          RowBox[{
           RowBox[{"N", "[", "VA", "]"}], "dtsub"}], ",", 
          RowBox[{"N", "@", "kFTrajectory"}], ",", 
          RowBox[{"N", "@", "EmissivityTrajD"}], ",", 
          RowBox[{"N", "@", "EmissivityTrajA"}], ",", "substeps", ",", 
          RowBox[{"Round", "[", 
           RowBox[{"taumax", "/", "dtsub"}], "]"}], ",", 
          RowBox[{"Round", "[", 
           RowBox[{"dtau", "/", "dtsub"}], "]"}], ",", "repeats"}], "]"}], "/.", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{"CorrelikonTimeUnitSec", "\[Rule]", "_"}], ")"}], "->", 
         RowBox[{"(", 
          RowBox[{"CorrelikonTimeUnitSec", "\[Rule]", "dtsub"}], ")"}]}]}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"Which", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "FOutput", "]"}], " ", "===", " ", 
         "FData"}], ",", "\[IndentingNewLine]", 
        RowBox[{"(", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"{", 
            RowBox[{"gdd", ",", "gda", ",", "gad", ",", "gaa"}], "}"}], "=", 
           RowBox[{"N", "@", 
            RowBox[{"Map", "[", 
             RowBox[{"FCorrelTransformRawData", ",", "cdata"}], "]"}]}]}], 
          ";", "\[IndentingNewLine]", 
          RowBox[{"taulist", "=", 
           RowBox[{"Join", "[", 
            RowBox[{
             RowBox[{"-", 
              RowBox[{"Reverse", "@", 
               RowBox[{"gdd", "[", 
                RowBox[{"[", 
                 RowBox[{"All", ",", "1"}], "]"}], "]"}]}]}], ",", 
             RowBox[{"gdd", "[", 
              RowBox[{"[", 
               RowBox[{"All", ",", "1"}], "]"}], "]"}]}], "]"}]}], ";", 
          RowBox[{"(*", 
           RowBox[{
            RowBox[{"Range", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"-", "taumax"}], "+", 
               RowBox[{"0.5", "dtau"}]}], ",", "taumax", ",", "dtau"}], "]"}],
             ";"}], "*)"}], 
          RowBox[{"Map", "[", 
           RowBox[{
            RowBox[{
             RowBox[{
              RowBox[{"{", 
               RowBox[{"taulist", ",", "#"}], "}"}], "\[Transpose]"}], "&"}], 
            ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"Join", "[", 
               RowBox[{
                RowBox[{"Reverse", "[", 
                 RowBox[{"gdd", "[", 
                  RowBox[{"[", 
                   RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}], ",", 
                RowBox[{"gdd", "[", 
                 RowBox[{"[", 
                  RowBox[{"All", ",", "2"}], "]"}], "]"}]}], "]"}], ",", 
              RowBox[{"Join", "[", 
               RowBox[{
                RowBox[{"Reverse", "[", 
                 RowBox[{"gda", "[", 
                  RowBox[{"[", 
                   RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}], ",", 
                RowBox[{"gad", "[", 
                 RowBox[{"[", 
                  RowBox[{"All", ",", "2"}], "]"}], "]"}]}], "]"}], ",", 
              RowBox[{"Join", "[", 
               RowBox[{
                RowBox[{"Reverse", "[", 
                 RowBox[{"gaa", "[", 
                  RowBox[{"[", 
                   RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}], ",", 
                RowBox[{"gaa", "[", 
                 RowBox[{"[", 
                  RowBox[{"All", ",", "2"}], "]"}], "]"}]}], "]"}]}], "}"}]}],
            "]"}]}], "\[IndentingNewLine]", ")"}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FRawData"}], 
        ",", "\[IndentingNewLine]", 
        RowBox[{"(", "cdata", ")"}]}], "\[IndentingNewLine]", "]"}]}]}], 
    "\[IndentingNewLine]", "\n", "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FSimulateNanoSecondFCS", "[", 
    RowBox[{
     RowBox[{"p0", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], ",", 
     RowBox[{"Kstatic_", "?", "FNumericMatrixQ"}], ",", 
     RowBox[{"KFRET_", "?", "FNumericMatrixQ"}], ",", 
     RowBox[{"VD_", "?", "FNumericMatrixQ"}], ",", 
     RowBox[{"VA_", "?", "FNumericMatrixQ"}], ",", 
     RowBox[{"kFTrajectory", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], ",", 
     RowBox[{"EmissivityTraj", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], ",", 
     RowBox[{"dt_", "?", "NumericQ"}], ",", "substeps_Integer", ",", 
     RowBox[{"taumax_", "?", "NumericQ"}], ",", 
     RowBox[{"dtau_", "?", "NumericQ"}], ",", "repeats_Integer", ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"FSimulateNanoSecondFCS", "[", 
    RowBox[{
    "p0", ",", "Kstatic", ",", "KFRET", ",", "VD", ",", "VA", ",", 
     "kFTrajectory", ",", "EmissivityTraj", ",", "EmissivityTraj", ",", "dt", 
     ",", "substeps", ",", "taumax", ",", "dtau", ",", "repeats", ",", 
     "opts"}], "]"}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FSimulateNanoSecondFCS", "[", 
   RowBox[{
    RowBox[{"p0", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], ",", 
    RowBox[{"Kstatic_", "?", "FNumericMatrixQ"}], ",", 
    RowBox[{"KFRET_", "?", "FNumericMatrixQ"}], ",", 
    RowBox[{"VD_", "?", "FNumericMatrixQ"}], ",", 
    RowBox[{"VA_", "?", "FNumericMatrixQ"}], ",", 
    RowBox[{"kFTrajectory", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}]}], ",", 
    RowBox[{"dt_", "?", "NumericQ"}], ",", "substeps_Integer", ",", 
    RowBox[{"taumax_", "?", "NumericQ"}], ",", 
    RowBox[{"dtau_", "?", "NumericQ"}], ",", "repeats_Integer", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"FSimulateNanoSecondFCS", "[", 
   RowBox[{
   "p0", ",", "Kstatic", ",", "KFRET", ",", "VD", ",", "VA", ",", 
    "kFTrajectory", ",", 
    RowBox[{"ConstantArray", "[", 
     RowBox[{"1.", ",", 
      RowBox[{"Length", "[", "kFTrajectory", "]"}]}], "]"}], ",", 
    RowBox[{"ConstantArray", "[", 
     RowBox[{"1.", ",", 
      RowBox[{"Length", "[", "kFTrajectory", "]"}]}], "]"}], ",", "dt", ",", 
    "substeps", ",", "taumax", ",", "dtau", ",", "repeats", ",", "opts"}], 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.8135802571724396`*^9, 3.813580257707012*^9}, {
   3.8135802893693266`*^9, 3.813580411937213*^9}, {3.8135805859024363`*^9, 
   3.81358070121701*^9}, {3.813636935276382*^9, 3.813636959934563*^9}, {
   3.813637007707795*^9, 3.8136370790330224`*^9}, {3.8136373435594363`*^9, 
   3.813637439016182*^9}, {3.8136375688658953`*^9, 3.8136375744340506`*^9}, 
   3.8136376093875713`*^9, {3.8136376610773163`*^9, 3.813637679386345*^9}, {
   3.8136381469934654`*^9, 3.8136381475848837`*^9}, {3.813638679591851*^9, 
   3.813638745531682*^9}, {3.813638795668586*^9, 3.813638805833428*^9}, 
   3.829641134857684*^9, 3.829641193849514*^9, {3.8296412487108746`*^9, 
   3.8296414170740767`*^9}, 3.8296422239813533`*^9, {3.829642262408928*^9, 
   3.8296422824587507`*^9}, {3.8316371884835205`*^9, 3.8316374286181984`*^9}, 
   3.831637606347622*^9, {3.8316376520954623`*^9, 3.83163770600344*^9}, {
   3.831637768842331*^9, 3.8316377708474245`*^9}, {3.831637802085561*^9, 
   3.8316378324549046`*^9}, {3.8316379870897293`*^9, 3.8316379902910843`*^9}, 
   3.831638042160201*^9, {3.831638151892923*^9, 3.8316382286568117`*^9}, {
   3.8316382605908184`*^9, 3.8316382975803146`*^9}, {3.8316383465191836`*^9, 
   3.83163839882685*^9}, {3.8317121441337023`*^9, 3.8317121450313883`*^9}, {
   3.8317863439901342`*^9, 3.8317864297206326`*^9}, {3.832142915452314*^9, 
   3.832142989664459*^9}, 3.832659698282052*^9, 3.832659744322384*^9, {
   3.8509072055341673`*^9, 3.850907236693894*^9}, 
   3.856590812334628*^9},ExpressionUUID->"b7ea4099-994f-4282-8730-\
f80373b3942d"],

Cell[BoxData[
 RowBox[{" ", 
  RowBox[{
   RowBox[{
    RowBox[{"FMoveIn2DPot", "[", 
     RowBox[{
      RowBox[{"r0", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"_", ",", "_"}], "}"}], ".."}], "}"}]}], ",", "dt_", ",", 
      "timesteps_Integer", ",", "k_", ",", "ktrans_", ",", "xC_", ",", 
      "k4_"}], "]"}], ":=", " ", 
    RowBox[{"FMoveIn2DPotP", "[", 
     RowBox[{
      RowBox[{"N", "@", 
       RowBox[{"r0", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ",", 
      RowBox[{"N", "@", 
       RowBox[{"r0", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "2"}], "]"}], "]"}]}], ",", 
      RowBox[{"N", "@", "dt"}], ",", "timesteps", ",", 
      RowBox[{"N", "@", "k"}], ",", 
      RowBox[{"N", "@", "ktrans"}], ",", 
      RowBox[{"N", "@", "xC"}], ",", 
      RowBox[{"N", "@", "k4"}]}], "]"}]}], "\n", "  ", 
   RowBox[{
    RowBox[{"FMoveIn2DPot", "[", 
     RowBox[{
      RowBox[{"r0", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"_", ",", "_"}], "}"}], ".."}], "}"}]}], ",", "dt_", ",", 
      "timesteps_Integer", ",", "k_", ",", "ktrans_", ",", "xC_", ",", "k4_", 
      ",", "ra_", ",", "rb_"}], "]"}], ":=", " ", 
    RowBox[{"FMoveIn2DPotP", "[", 
     RowBox[{
      RowBox[{"N", "@", 
       RowBox[{"r0", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ",", 
      RowBox[{"N", "@", 
       RowBox[{"r0", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "2"}], "]"}], "]"}]}], ",", 
      RowBox[{"N", "@", "dt"}], ",", "timesteps", ",", 
      RowBox[{"N", "@", "k"}], ",", 
      RowBox[{"N", "@", "ktrans"}], ",", 
      RowBox[{"N", "@", "xC"}], ",", 
      RowBox[{"N", "@", "k4"}], ",", 
      RowBox[{"N", "@", "ra"}], ",", 
      RowBox[{"N", "@", "rb"}]}], "]"}]}]}]}]], "Input",ExpressionUUID->\
"bd6bfcea-b1ee-4492-a6f7-17cec4b7215b"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FSimulatePullingInOpticalTrap", "[", 
   RowBox[{
    RowBox[{"r0", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"_", ",", "_"}], "}"}], ".."}], "}"}]}], ",", "dt_", ",", 
    "timesteps_Integer", ",", "SnapshotPeriod_Integer", ",", 
    RowBox[{"Dm_", "?", "NumericQ"}], ",", 
    RowBox[{"DB_", "?", "NumericQ"}], ",", 
    RowBox[{"x0_", "?", "NumericQ"}], ",", 
    RowBox[{"DeltaG_", "?", "NumericQ"}], ",", 
    RowBox[{"k_", "?", "NumericQ"}], ",", 
    RowBox[{"FTrap_", "?", "NumericQ"}]}], "]"}], ":=", " ", 
  RowBox[{"FSimulatePullingInOpticalTrapP", "[", 
   RowBox[{
    RowBox[{"N", "@", 
     RowBox[{"r0", "[", 
      RowBox[{"[", 
       RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ",", 
    RowBox[{"N", "@", 
     RowBox[{"r0", "[", 
      RowBox[{"[", 
       RowBox[{"All", ",", "2"}], "]"}], "]"}]}], ",", 
    RowBox[{"N", "@", "dt"}], ",", "timesteps", ",", "SnapshotPeriod", ",", 
    RowBox[{"N", "@", "Dm"}], ",", 
    RowBox[{"N", "@", "DB"}], ",", 
    RowBox[{"N", "@", "x0"}], ",", 
    RowBox[{"N", "@", "DeltaG"}], ",", 
    RowBox[{"N", "@", "k"}], ",", 
    RowBox[{"N", "@", "FTrap"}]}], "]"}]}]], "Input",ExpressionUUID->\
"21d69ea2-426b-4e27-a1c9-d9aba4f249f6"]
}, Open  ]],

Cell[CellGroupData[{

Cell["PDA", "Subsubsection",ExpressionUUID->"bf417ba2-e9f3-4c77-99ab-7645de67d4e0"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FPDASettings", "[", 
   RowBox[{
    RowBox[{"gamma_", "?", "NumericQ"}], ",", 
    RowBox[{"crosstalk_", "?", "NumericQ"}], ",", 
    RowBox[{"directexcitation_", "?", "NumericQ"}], ",", " ", 
    RowBox[{"bgA_", "?", "NumericQ"}], ",", " ", 
    RowBox[{"bgD_", "?", "NumericQ"}]}], "]"}], ":=", 
  RowBox[{"FPDASettingsP", "[", 
   RowBox[{
    RowBox[{"N", "@", "gamma"}], ",", 
    RowBox[{"N", "@", "crosstalk"}], ",", 
    RowBox[{"N", "@", "directexcitation"}], ",", " ", 
    RowBox[{"N", "@", "bgA"}], ",", " ", 
    RowBox[{"N", "@", "bgD"}]}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FPDASetpF", "[", 
    RowBox[{"pFdata", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}], ".."}], "}"}]}], 
    "]"}], ":=", 
   RowBox[{"FPDASetpFP", "[", 
    RowBox[{
     RowBox[{"Length", "/@", "pFdata"}], ",", 
     RowBox[{"N", "@", 
      RowBox[{"Flatten", "@", "pFdata"}]}]}], "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FPDACalcPSA", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"FPDAMethod", "->", "\"\<Approximate pF by pS\>\""}], "}"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{"FPDACalcPSA", "[", 
   RowBox[{
    RowBox[{"model", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumericQ"}], ",", 
         RowBox[{"_", "?", "NumericQ"}], ",", 
         RowBox[{"_", "?", "NumericQ"}]}], "}"}], ".."}], "}"}]}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"params", "=", 
       RowBox[{"N", "@", 
        RowBox[{"Transpose", "[", "model", "]"}]}]}], ",", 
      RowBox[{"mode", "=", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"OptionValue", "[", "FPDAMethod", "]"}], "===", 
          "\"\<Approximate pF by pS\>\""}], ",", "1", ",", "0"}], "]"}]}]}], 
     "}"}], ",", 
    RowBox[{"FPdaCalcPsaP", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"params", "[", 
        RowBox[{"[", "1", "]"}], "]"}], "/", 
       RowBox[{"Total", "[", 
        RowBox[{"params", "[", 
         RowBox[{"[", "1", "]"}], "]"}], "]"}]}], ",", 
      RowBox[{"params", "[", 
       RowBox[{"[", "2", "]"}], "]"}], ",", 
      RowBox[{"params", "[", 
       RowBox[{"[", "3", "]"}], "]"}], ",", "mode"}], "]"}]}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FPDAEhisto", "[", 
   RowBox[{
    RowBox[{"e1_", "?", "NumericQ"}], ",", 
    RowBox[{"e2_", "?", "NumericQ"}], ",", "bins_Integer", ",", 
    "Smin_Integer"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"de", "=", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{"e2", "-", "e1"}], ")"}], "/", "bins"}]}], ",", "p"}], "}"}],
     ",", "\n", 
    RowBox[{
     RowBox[{"p", "=", 
      RowBox[{"FPdaEhistoP", "[", 
       RowBox[{"e1", ",", "e2", ",", "bins", ",", "Smin"}], "]"}]}], ";", 
     "\n", 
     RowBox[{"p", "/=", 
      RowBox[{"Total", "[", "p", "]"}]}], ";", "\n", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"e1", "+", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"i", "-", "0.5"}], ")"}], "de"}]}], ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", "bins"}], "}"}]}], "]"}], ",", "p"}], "}"}], 
      "\[Transpose]"}]}]}], "\n", "]"}]}], "\n"}], "Input",ExpressionUUID->\
"82b3d452-686f-4c11-b839-b393f503b941"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"FProximityRatio", "[", 
    RowBox[{"\[Alpha]_", ",", "\[Beta]_", ",", "\[Gamma]_"}], "]"}], "[", 
   "e_", "]"}], ":=", 
  RowBox[{
   RowBox[{"(", 
    RowBox[{
     RowBox[{
      RowBox[{"(", 
       RowBox[{
        RowBox[{"-", "1"}], "+", "e"}], ")"}], " ", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"-", "1"}], "+", "\[Alpha]"}], ")"}], " ", "\[Beta]"}], "+", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{"e", "+", "\[Alpha]", "-", 
        RowBox[{"e", " ", "\[Alpha]"}]}], ")"}], " ", "\[Gamma]"}]}], ")"}], 
   "/", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{
      RowBox[{"(", 
       RowBox[{
        RowBox[{"-", "1"}], "+", "e"}], ")"}], " ", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"-", "1"}], "+", "\[Alpha]"}], ")"}], " ", 
      RowBox[{"(", 
       RowBox[{"1", "+", "\[Beta]"}], ")"}]}], "+", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{"e", "+", "\[Alpha]", "-", 
        RowBox[{"e", " ", "\[Alpha]"}]}], ")"}], " ", "\[Gamma]"}]}], 
    ")"}]}]}]], "Input",ExpressionUUID->"0369f812-5cd8-451e-8822-\
a8c6afa59ae2"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"FBetaPeak", "[", 
    RowBox[{"\[Mu]_", ",", "v_"}], "]"}], "[", "p1_", "]"}], ":=", 
  TagBox[GridBox[{
     {"\[Piecewise]", GridBox[{
        {
         FractionBox[
          RowBox[{
           SuperscriptBox[
            RowBox[{"(", 
             RowBox[{"1", "-", "p1"}], ")"}], 
            RowBox[{
             RowBox[{"-", "1"}], "+", "v", "-", 
             RowBox[{"v", " ", "\[Mu]"}]}]], " ", 
           SuperscriptBox["p1", 
            RowBox[{
             RowBox[{"-", "1"}], "+", 
             RowBox[{"v", " ", "\[Mu]"}]}]]}], 
          RowBox[{"Beta", "[", 
           RowBox[{
            RowBox[{"v", " ", "\[Mu]"}], ",", 
            RowBox[{"v", "-", 
             RowBox[{"v", " ", "\[Mu]"}]}]}], "]"}]], 
         RowBox[{"0", "<", "p1", "<", "1"}]},
        {"0", 
         TagBox["True",
          "PiecewiseDefault",
          AutoDelete->True]}
       },
       AllowedDimensions->{2, Automatic},
       Editable->True,
       GridBoxAlignment->{
        "Columns" -> {{Left}}, "ColumnsIndexed" -> {}, "Rows" -> {{Baseline}},
          "RowsIndexed" -> {}, "Items" -> {}, "ItemsIndexed" -> {}},
       GridBoxItemSize->{
        "Columns" -> {{Automatic}}, "ColumnsIndexed" -> {}, "Rows" -> {{1.}}, 
         "RowsIndexed" -> {}, "Items" -> {}, "ItemsIndexed" -> {}},
       GridBoxSpacings->{"Columns" -> {
           Offset[0.27999999999999997`], {
            Offset[0.84]}, 
           Offset[0.27999999999999997`]}, "ColumnsIndexed" -> {}, "Rows" -> {
           Offset[0.2], {
            Offset[0.4]}, 
           Offset[0.2]}, "RowsIndexed" -> {}, "Items" -> {}, 
         "ItemsIndexed" -> {}},
       Selectable->True]}
    },
    GridBoxAlignment->{
     "Columns" -> {{Left}}, "ColumnsIndexed" -> {}, "Rows" -> {{Baseline}}, 
      "RowsIndexed" -> {}, "Items" -> {}, "ItemsIndexed" -> {}},
    GridBoxItemSize->{
     "Columns" -> {{Automatic}}, "ColumnsIndexed" -> {}, "Rows" -> {{1.}}, 
      "RowsIndexed" -> {}, "Items" -> {}, "ItemsIndexed" -> {}},
    GridBoxSpacings->{"Columns" -> {
        Offset[0.27999999999999997`], {
         Offset[0.35]}, 
        Offset[0.27999999999999997`]}, "ColumnsIndexed" -> {}, "Rows" -> {
        Offset[0.2], {
         Offset[0.4]}, 
        Offset[0.2]}, "RowsIndexed" -> {}, "Items" -> {}, 
      "ItemsIndexed" -> {}}],
   "Piecewise",
   DeleteWithContents->True,
   Editable->False,
   SelectWithContents->True,
   Selectable->False]}]], "Input",ExpressionUUID->"5aff6887-b285-4d13-b55e-\
dac1afca7e7a"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"FpdaPofE", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"\[Alpha]_", ",", "\[Beta]_", ",", "\[Gamma]_"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"a_", ",", "emean_", ",", "\[Nu]_"}], "}"}]}], "]"}], "[", "e_",
    "]"}], ":=", 
  RowBox[{"a", " ", 
   TagBox[GridBox[{
      {"\[Piecewise]", GridBox[{
         {
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"\[Gamma]", " ", 
               SuperscriptBox[
                RowBox[{"(", 
                 FractionBox[
                  RowBox[{
                   RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "1"}], "+", "e"}], ")"}], " ", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "1"}], "+", "\[Alpha]"}], ")"}], " ", 
                    "\[Beta]"}], "+", 
                   RowBox[{
                    RowBox[{"(", 
                    RowBox[{"e", "+", "\[Alpha]", "-", 
                    RowBox[{"e", " ", "\[Alpha]"}]}], ")"}], " ", 
                    "\[Gamma]"}]}], 
                  RowBox[{
                   RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "1"}], "+", "e"}], ")"}], " ", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "1"}], "+", "\[Alpha]"}], ")"}], " ", 
                    RowBox[{"(", 
                    RowBox[{"1", "+", "\[Beta]"}], ")"}]}], "+", 
                   RowBox[{
                    RowBox[{"(", 
                    RowBox[{"e", "+", "\[Alpha]", "-", 
                    RowBox[{"e", " ", "\[Alpha]"}]}], ")"}], " ", 
                    "\[Gamma]"}]}]], ")"}], 
                FractionBox[
                 RowBox[{
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "1"}], "+", "emean"}], ")"}], " ", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "1"}], "+", "\[Alpha]"}], ")"}], " ", 
                    "\[Beta]"}], "+", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{"emean", "+", "\[Alpha]", "-", 
                    RowBox[{"emean", " ", "\[Alpha]"}]}], ")"}], " ", 
                    "\[Gamma]"}]}], ")"}], " ", "\[Nu]"}], 
                 RowBox[{
                  RowBox[{
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "1"}], "+", "emean"}], ")"}], " ", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "1"}], "+", "\[Alpha]"}], ")"}], " ", 
                   RowBox[{"(", 
                    RowBox[{"1", "+", "\[Beta]"}], ")"}]}], "+", 
                  RowBox[{
                   RowBox[{"(", 
                    RowBox[{"emean", "+", "\[Alpha]", "-", 
                    RowBox[{"emean", " ", "\[Alpha]"}]}], ")"}], " ", 
                   "\[Gamma]"}]}]]], " ", 
               SuperscriptBox[
                RowBox[{"(", 
                 FractionBox[
                  RowBox[{
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "1"}], "+", "e"}], ")"}], " ", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "1"}], "+", "\[Alpha]"}], ")"}]}], 
                  RowBox[{"1", "+", "\[Beta]", "+", 
                   RowBox[{"e", " ", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "1"}], "+", "\[Alpha]"}], ")"}], " ", 
                    RowBox[{"(", 
                    RowBox[{"1", "+", "\[Beta]", "-", "\[Gamma]"}], ")"}]}], 
                   "+", 
                   RowBox[{"\[Alpha]", " ", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "1"}], "-", "\[Beta]", "+", "\[Gamma]"}], 
                    ")"}]}]}]], ")"}], 
                FractionBox[
                 RowBox[{
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"-", "1"}], "+", "emean"}], ")"}], " ", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"-", "1"}], "+", "\[Alpha]"}], ")"}], " ", 
                  "\[Nu]"}], 
                 RowBox[{"1", "+", "\[Beta]", "+", 
                  RowBox[{"emean", " ", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "1"}], "+", "\[Alpha]"}], ")"}], " ", 
                   RowBox[{"(", 
                    RowBox[{"1", "+", "\[Beta]", "-", "\[Gamma]"}], ")"}]}], 
                  "+", 
                  RowBox[{"\[Alpha]", " ", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "1"}], "-", "\[Beta]", "+", "\[Gamma]"}], 
                    ")"}]}]}]]]}], ")"}], "/", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"-", "1"}], "+", "e"}], ")"}], " ", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"-", "1"}], "+", "e"}], ")"}], " ", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"-", "1"}], "+", "\[Alpha]"}], ")"}], " ", 
                  "\[Beta]"}], "+", 
                 RowBox[{
                  RowBox[{"(", 
                   RowBox[{"e", "+", "\[Alpha]", "-", 
                    RowBox[{"e", " ", "\[Alpha]"}]}], ")"}], " ", 
                  "\[Gamma]"}]}], ")"}], " ", 
               RowBox[{"Beta", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "1"}], "+", "emean"}], ")"}], " ", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "1"}], "+", "\[Alpha]"}], ")"}], " ", 
                    "\[Beta]"}], "+", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{"emean", "+", "\[Alpha]", "-", 
                    RowBox[{"emean", " ", "\[Alpha]"}]}], ")"}], " ", 
                    "\[Gamma]"}]}], ")"}], " ", "\[Nu]"}], ")"}], "/", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "1"}], "+", "emean"}], ")"}], " ", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "1"}], "+", "\[Alpha]"}], ")"}], " ", 
                    RowBox[{"(", 
                    RowBox[{"1", "+", "\[Beta]"}], ")"}]}], "+", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{"emean", "+", "\[Alpha]", "-", 
                    RowBox[{"emean", " ", "\[Alpha]"}]}], ")"}], " ", 
                    "\[Gamma]"}]}], ")"}]}], ",", 
                 FractionBox[
                  RowBox[{
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "1"}], "+", "emean"}], ")"}], " ", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "1"}], "+", "\[Alpha]"}], ")"}], " ", 
                   "\[Nu]"}], 
                  RowBox[{"1", "+", "\[Beta]", "+", 
                   RowBox[{"emean", " ", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "1"}], "+", "\[Alpha]"}], ")"}], " ", 
                    RowBox[{"(", 
                    RowBox[{"1", "+", "\[Beta]", "-", "\[Gamma]"}], ")"}]}], 
                   "+", 
                   RowBox[{"\[Alpha]", " ", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "1"}], "-", "\[Beta]", "+", "\[Gamma]"}], 
                    ")"}]}]}]]}], "]"}]}], ")"}]}], ")"}]}], 
          RowBox[{"0", "<", 
           FractionBox[
            RowBox[{
             RowBox[{
              RowBox[{"(", 
               RowBox[{
                RowBox[{"-", "1"}], "+", "e"}], ")"}], " ", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"-", "1"}], "+", "\[Alpha]"}], ")"}], " ", 
              "\[Beta]"}], "+", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"e", "+", "\[Alpha]", "-", 
                RowBox[{"e", " ", "\[Alpha]"}]}], ")"}], " ", "\[Gamma]"}]}], 
            RowBox[{"1", "+", "\[Beta]", "+", 
             RowBox[{"e", " ", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"-", "1"}], "+", "\[Alpha]"}], ")"}], " ", 
              RowBox[{"(", 
               RowBox[{"1", "+", "\[Beta]", "-", "\[Gamma]"}], ")"}]}], "+", 
             RowBox[{"\[Alpha]", " ", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"-", "1"}], "-", "\[Beta]", "+", "\[Gamma]"}], 
               ")"}]}]}]], "<", "1"}]},
         {"0", 
          TagBox["True",
           "PiecewiseDefault",
           AutoDelete->True]}
        },
        AllowedDimensions->{2, Automatic},
        Editable->True,
        GridBoxAlignment->{
         "Columns" -> {{Left}}, "ColumnsIndexed" -> {}, 
          "Rows" -> {{Baseline}}, "RowsIndexed" -> {}, "Items" -> {}, 
          "ItemsIndexed" -> {}},
        GridBoxItemSize->{
         "Columns" -> {{Automatic}}, "ColumnsIndexed" -> {}, "Rows" -> {{1.}},
           "RowsIndexed" -> {}, "Items" -> {}, "ItemsIndexed" -> {}},
        GridBoxSpacings->{"Columns" -> {
            Offset[0.27999999999999997`], {
             Offset[0.84]}, 
            Offset[0.27999999999999997`]}, "ColumnsIndexed" -> {}, "Rows" -> {
            Offset[0.2], {
             Offset[0.4]}, 
            Offset[0.2]}, "RowsIndexed" -> {}, "Items" -> {}, 
          "ItemsIndexed" -> {}},
        Selectable->True]}
     },
     GridBoxAlignment->{
      "Columns" -> {{Left}}, "ColumnsIndexed" -> {}, "Rows" -> {{Baseline}}, 
       "RowsIndexed" -> {}, "Items" -> {}, "ItemsIndexed" -> {}},
     GridBoxItemSize->{
      "Columns" -> {{Automatic}}, "ColumnsIndexed" -> {}, "Rows" -> {{1.}}, 
       "RowsIndexed" -> {}, "Items" -> {}, "ItemsIndexed" -> {}},
     GridBoxSpacings->{"Columns" -> {
         Offset[0.27999999999999997`], {
          Offset[0.35]}, 
         Offset[0.27999999999999997`]}, "ColumnsIndexed" -> {}, "Rows" -> {
         Offset[0.2], {
          Offset[0.4]}, 
         Offset[0.2]}, "RowsIndexed" -> {}, "Items" -> {}, 
       "ItemsIndexed" -> {}}],
    "Piecewise",
    DeleteWithContents->True,
    Editable->False,
    SelectWithContents->True,
    Selectable->False]}]}]], "Input",ExpressionUUID->"bba9fd43-252e-4f5e-9106-\
0658b78c2869"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"FpdaIntrinsicDistribution", "[", 
     RowBox[{"model", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"_", ",", "_", ",", "_"}], "}"}], ".."}], "}"}]}], "]"}], 
    "[", "p1_", "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"n", "=", 
       RowBox[{"Total", "[", 
        RowBox[{"model", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "1"}], "]"}], "]"}], "]"}]}], "}"}], ",", 
     RowBox[{"Map", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"#", "[", 
           RowBox[{"[", "1", "]"}], "]"}], "/", "n"}], " ", 
         RowBox[{
          RowBox[{"FBetaPeak", "[", 
           RowBox[{
            RowBox[{"#", "[", 
             RowBox[{"[", "2", "]"}], "]"}], ",", 
            RowBox[{"#", "[", 
             RowBox[{"[", "3", "]"}], "]"}]}], "]"}], "[", "p1", "]"}]}], 
        "&"}], ",", "model"}], "]"}]}], "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FpdaIntrinsicDistribution", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"\[Alpha]_", ",", "\[Beta]_", ",", "\[Gamma]_"}], "}"}], ",", 
     RowBox[{"model", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"_", ",", "_", ",", "_"}], "}"}], ".."}], "}"}]}]}], "]"}], 
   "[", "e_", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"n", "=", 
      RowBox[{"Total", "[", 
       RowBox[{"model", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "1"}], "]"}], "]"}], "]"}]}], "}"}], ",", 
    RowBox[{
     RowBox[{"1", "/", "n"}], " ", 
     RowBox[{"Map", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"1", "/", "n"}], " ", 
         RowBox[{
          RowBox[{"FpdaPofE", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"\[Alpha]", ",", "\[Beta]", ",", "\[Gamma]"}], "}"}], 
            ",", "#"}], "]"}], "[", "e", "]"}]}], "&"}], ",", "model"}], 
      "]"}]}]}], "]"}]}], "\n"}], "Input",ExpressionUUID->"ca2f1a39-3aed-47fa-\
a954-e818a7f85ccd"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FpdaGetReducedRCM", "[", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "aroutes", ",", "droutes", ",", "subrcms", ",", "rcm", ",", "weights", 
      ",", "redrcm"}], "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"rcm", "=", 
      RowBox[{"FGetRCM", "[", "]"}]}], ";", "\n", 
     RowBox[{"aroutes", "=", 
      RowBox[{"Flatten", "@", 
       RowBox[{"MapIndexed", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"#1", "==", "1"}], ",", "#2", ",", 
            RowBox[{"Nothing", "[", "]"}]}], "]"}], "&"}], ",", 
         RowBox[{"FGetAcceptorRoutes", "[", "]"}]}], "]"}]}]}], ";", "\n", 
     RowBox[{"droutes", "=", 
      RowBox[{"Flatten", "@", 
       RowBox[{"MapIndexed", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"#1", "==", "1"}], ",", "#2", ",", 
            RowBox[{"Nothing", "[", "]"}]}], "]"}], "&"}], ",", 
         RowBox[{"FGetDonorRoutes", "[", "]"}]}], "]"}]}]}], ";", "\n", 
     RowBox[{"subrcms", "=", 
      RowBox[{"Map", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"rcm", "[", 
          RowBox[{"[", 
           RowBox[{"#", ",", "#"}], "]"}], "]"}], "&"}], ",", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"aroutes", ",", "droutes"}], "}"}], "\[Transpose]"}]}], 
       "]"}]}], ";", "\n", 
     RowBox[{"weights", "=", 
      RowBox[{"1", "/", 
       RowBox[{"subrcms", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "1", ",", "1"}], "]"}], "]"}]}]}], ";", "\n", 
     RowBox[{"redrcm", "=", 
      RowBox[{
       RowBox[{"Total", "[", 
        RowBox[{
         RowBox[{"weights", "^", "2"}], " ", "subrcms"}], "]"}], "/", 
       RowBox[{"Total", "[", "weights", "]"}]}]}], ";", "\n", 
     RowBox[{"redrcm", "/=", 
      RowBox[{"redrcm", "[", 
       RowBox[{"[", 
        RowBox[{"1", ",", "1"}], "]"}], "]"}]}], ";", "\n", "redrcm"}]}], 
   "\n", "]"}]}]], "Input",ExpressionUUID->"2c3fd109-9fd7-4bdf-ab53-\
673afeed7fe9"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FpdaGetCorrectionFactors\[Alpha]\[Beta]\[Gamma]", "[", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"rcm", ",", "\[Alpha]", ",", "\[Beta]", ",", "\[Gamma]"}], "}"}],
     ",", "\n", 
    RowBox[{
     RowBox[{"rcm", "=", 
      RowBox[{"FpdaGetReducedRCM", "[", "]"}]}], ";", "\n", 
     RowBox[{"\[Gamma]", "=", 
      RowBox[{"rcm", "[", 
       RowBox[{"[", 
        RowBox[{"2", ",", "2"}], "]"}], "]"}]}], ";", "\n", 
     RowBox[{"\[Beta]", "=", 
      RowBox[{"-", 
       RowBox[{"rcm", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "2"}], "]"}], "]"}]}]}], ";", "\n", 
     RowBox[{"\[Alpha]", "=", 
      RowBox[{"FGetDirectAcceptorExcitation", "[", "]"}]}], ";", "\n", 
     RowBox[{"{", 
      RowBox[{"\[Alpha]", ",", "\[Beta]", ",", "\[Gamma]"}], "}"}]}]}], "\n", 
   "]"}]}]], "Input",ExpressionUUID->"1e1fc832-f604-484f-895c-01b986e817bd"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FpdaGetDABackground", "[", 
   RowBox[{"bg_", ",", "Tmean_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"aroutes", ",", "droutes"}], "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"aroutes", "=", 
      RowBox[{"Flatten", "@", 
       RowBox[{"MapIndexed", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"#1", "==", "1"}], ",", "#2", ",", 
            RowBox[{"Nothing", "[", "]"}]}], "]"}], "&"}], ",", 
         RowBox[{"FGetAcceptorRoutes", "[", "]"}]}], "]"}]}]}], ";", "\n", 
     RowBox[{"droutes", "=", 
      RowBox[{"Flatten", "@", 
       RowBox[{"MapIndexed", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"#1", "==", "1"}], ",", "#2", ",", 
            RowBox[{"Nothing", "[", "]"}]}], "]"}], "&"}], ",", 
         RowBox[{"FGetDonorRoutes", "[", "]"}]}], "]"}]}]}], ";", "\n", 
     RowBox[{"Tmean", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"Total", "[", 
         RowBox[{"bg", "[", 
          RowBox[{"[", "droutes", "]"}], "]"}], "]"}], ",", 
        RowBox[{"Total", "@", 
         RowBox[{"bg", "[", 
          RowBox[{"[", "aroutes", "]"}], "]"}]}]}], "}"}]}]}]}], "\n", 
   "]"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FpdaGetDABackground", "[", "bg_", "]"}], ":=", 
   RowBox[{"FpdaGetDABackground", "[", 
    RowBox[{"bg", ",", 
     RowBox[{"Mean", "@", 
      RowBox[{"FGetFromBurstList", "[", "\"\<BurstDuration\>\"", "]"}]}]}], 
    "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"FpdaGetDABackground", "[", "]"}], ":=", " ", 
  RowBox[{"FpdaGetDABackground", "[", 
   RowBox[{"FGetBackground", "[", "]"}], "]"}]}]}], "Input",ExpressionUUID->\
"5a06fbb7-bea8-4ce4-b99a-d349fac4b1d3"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FpdaAutoselectSmin", "[", 
   RowBox[{"pF", ":", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}], ".."}], "}"}]}], "]"}],
   ":=", 
  RowBox[{"Min", "[", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"LengthWhile", "[", 
      RowBox[{
       RowBox[{"pF", "[", 
        RowBox[{"[", "i", "]"}], "]"}], ",", 
       RowBox[{
        RowBox[{"#", "<=", "0"}], "&"}]}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", 
       RowBox[{"Length", "[", "pF", "]"}]}], "}"}]}], "]"}], "]"}]}]], "Input",\
ExpressionUUID->"afc947b1-e116-464b-b24f-3c50a3e97ddb"],

Cell[BoxData[{
 RowBox[{"Clear", "[", "FpdaGetSubPopBurstSizeDistributions", "]"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FpdaGetSubPopBurstSizeDistributions", "]"}], "=", 
   RowBox[{"Options", "[", "FGetFromBurstList", "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"FpdaGetSubPopBurstSizeDistributions", "[", 
   RowBox[{
    RowBox[{"eranges", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumericQ"}], ",", 
         RowBox[{"_", "?", "NumericQ"}]}], "}"}], "..."}], "}"}]}], ",", 
    "Fmax_Integer", ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"elist", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumericQ"}], "..."}], "}"}]}], ",", 
      RowBox[{"burstsizelist", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumericQ"}], "..."}], "}"}]}]}], "}"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"eselect", ",", "pF"}], "}"}], ",", "\n", 
    RowBox[{
     RowBox[{
      RowBox[{"eselect", "[", 
       RowBox[{"{", 
        RowBox[{"e1_", ",", "e2_"}], "}"}], "]"}], ":=", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"pF", "=", 
         RowBox[{"BinCounts", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Select", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"{", 
                RowBox[{"elist", ",", "burstsizelist"}], "}"}], 
               "\[Transpose]"}], ",", 
              RowBox[{
               RowBox[{"e1", "<=", 
                RowBox[{"#", "[", 
                 RowBox[{"[", "1", "]"}], "]"}], "<", "e2"}], "&"}]}], "]"}], 
            "[", 
            RowBox[{"[", 
             RowBox[{"All", ",", "2"}], "]"}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"0", ",", "Fmax", ",", "1"}], "}"}]}], "]"}]}], ";", 
        RowBox[{"pF", "/=", 
         RowBox[{"N", "@", 
          RowBox[{"Total", "[", "pF", "]"}]}]}], ";", "\n", "pF"}], ")"}]}], 
     ";", "\n", 
     RowBox[{"eselect", "/@", "eranges"}]}]}], "\n", "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FpdaGetSubPopBurstSizeDistributions", "[", 
   RowBox[{
    RowBox[{"eranges", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumericQ"}], ",", 
         RowBox[{"_", "?", "NumericQ"}]}], "}"}], "..."}], "}"}]}], ",", 
    "Fmax_Integer", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"FpdaGetSubPopBurstSizeDistributions", "[", 
   RowBox[{"eranges", ",", "Fmax", ",", 
    RowBox[{"FGetFromBurstList", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"\"\<E\>\"", ",", 
        RowBox[{"\"\<nA_raw\>\"", "+", "\"\<nD_raw\>\""}]}], "}"}], ",", 
      RowBox[{"FilterRules", "[", 
       RowBox[{
        RowBox[{"{", "opts", "}"}], ",", 
        RowBox[{"Options", "[", "FGetFromBurstList", "]"}]}], "]"}]}], 
     "]"}]}], "]"}]}], "\n"}], "Input",ExpressionUUID->"b7a9b684-1bde-47f1-\
b1f8-483fd2ae3aa2"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FpdaEHistoSubpopulations", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"FpdaDonly", "->", "True"}], ",", 
     RowBox[{"FPDAMethod", "->", "\"\<Approximate pF by pS\>\""}]}], "}"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FpdaEHistoSubpopulations", "[", 
    RowBox[{
     RowBox[{"ehisto", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumericQ"}], ",", 
          RowBox[{"_", "?", "NumericQ"}], ",", 
          RowBox[{"_", "?", "NumericQ"}]}], "}"}], "..."}], "}"}]}], ",", 
     RowBox[{"pF", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}], ".."}], "}"}]}], ",", 
     RowBox[{"model", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumericQ"}], ",", 
          RowBox[{"_", "?", "NumericQ"}], ",", 
          RowBox[{"_", "?", "NumericQ"}]}], "}"}], ".."}], "}"}]}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"bgD_", "?", "NumericQ"}], ",", 
       RowBox[{"bgA_", "?", "NumericQ"}]}], "}"}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "\[Alpha]", ",", "\[Beta]", ",", "\[Gamma]", ",", "betamax", ",", 
       "pamodel", ",", "mhisto", ",", "nbursts", ",", "e1", ",", "e2", ",", 
       "de", ",", " ", "subfunc", ",", "subpopplstyle", ",", "pldat", ",", 
       "plpda", ",", "plsubpop", ",", "scale", ",", "smin"}], "}"}], ",", 
     "\n", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Length", "[", "model", "]"}], "!=", 
         RowBox[{"Length", "[", "pF", "]"}]}], ",", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"FpdaEHisto", "::", "dimerr"}], "]"}], ";", 
         RowBox[{"Return", "[", "$Failed", "]"}]}]}], "]"}], ";", "\n", "\n", 
      RowBox[{"smin", "=", 
       RowBox[{"FpdaAutoselectSmin", "[", "pF", "]"}]}], ";", "\n", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"\[Alpha]", ",", "\[Beta]", ",", "\[Gamma]"}], "}"}], "=", 
       RowBox[{
       "FpdaGetCorrectionFactors\[Alpha]\[Beta]\[Gamma]", "[", "]"}]}], ";", 
      "\n", "\n", 
      RowBox[{"pamodel", "=", 
       RowBox[{"Abs", "@", "model"}]}], ";", "\n", 
      RowBox[{
       RowBox[{"pamodel", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "2"}], "]"}], "]"}], "=", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{"FProximityRatio", "[", 
          RowBox[{"\[Alpha]", ",", "\[Beta]", ",", "\[Gamma]"}], "]"}], ",", 
         RowBox[{"pamodel", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "2"}], "]"}], "]"}]}], "]"}]}], ";", "\n", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "FpdaDonly", "]"}], "===", "True"}], ",",
         "\n", 
        RowBox[{
         RowBox[{"pamodel", "[", 
          RowBox[{"[", 
           RowBox[{"1", ",", "2"}], "]"}], "]"}], "=", 
         RowBox[{
          RowBox[{"FProximityRatio", "[", 
           RowBox[{"0", ",", "\[Beta]", ",", "\[Gamma]"}], "]"}], "[", 
          RowBox[{"model", "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "2"}], "]"}], "]"}], "]"}]}]}], "\n", "]"}], 
      ";", "\n", 
      RowBox[{"nbursts", "=", 
       RowBox[{"Total", "[", 
        RowBox[{"ehisto", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}]}], ";", "\n", 
      RowBox[{"de", "=", 
       RowBox[{
        RowBox[{"ehisto", "[", 
         RowBox[{"[", 
          RowBox[{"2", ",", "1"}], "]"}], "]"}], "-", 
        RowBox[{"ehisto", "[", 
         RowBox[{"[", 
          RowBox[{"1", ",", "1"}], "]"}], "]"}]}]}], ";", "\n", 
      RowBox[{"e1", "=", 
       RowBox[{
        RowBox[{"ehisto", "[", 
         RowBox[{"[", 
          RowBox[{"1", ",", "1"}], "]"}], "]"}], "-", 
        RowBox[{"0.5", " ", "de"}]}]}], ";", "\n", 
      RowBox[{"e2", "=", 
       RowBox[{
        RowBox[{"ehisto", "[", 
         RowBox[{"[", 
          RowBox[{
           RowBox[{"-", "1"}], ",", "1"}], "]"}], "]"}], "+", " ", 
        RowBox[{"0.5", "de"}]}]}], ";", "\n", 
      RowBox[{"FPDASettings", "[", 
       RowBox[{
       "\[Gamma]", ",", "\[Beta]", ",", "\[Alpha]", ",", "bgA", ",", "bgD"}], 
       "]"}], ";", "\n", 
      RowBox[{"Table", "[", "\n", 
       RowBox[{
        RowBox[{
         RowBox[{"FPDASetpF", "[", 
          RowBox[{"pF", "[", 
           RowBox[{"[", 
            RowBox[{"i", ";;", "i"}], "]"}], "]"}], "]"}], ";", "\n", 
         RowBox[{"FPDACalcPSA", "[", 
          RowBox[{
           RowBox[{"pamodel", "[", 
            RowBox[{"[", 
             RowBox[{"i", ";;", "i"}], "]"}], "]"}], ",", 
           RowBox[{"FilterRules", "[", 
            RowBox[{
             RowBox[{"{", "opts", "}"}], ",", 
             RowBox[{"Options", "[", "FPDACalcPSA", "]"}]}], "]"}]}], "]"}], 
         ";", "\n", 
         RowBox[{"mhisto", "=", 
          RowBox[{"FPDAEhisto", "[", 
           RowBox[{"e1", ",", "e2", ",", 
            RowBox[{"Length", "[", "ehisto", "]"}], ",", "smin"}], "]"}]}], 
         ";", "\n", 
         RowBox[{
          RowBox[{"mhisto", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "2"}], "]"}], "]"}], "*=", 
          RowBox[{"nbursts", "*", 
           RowBox[{"model", "[", 
            RowBox[{"[", 
             RowBox[{"i", ",", "1"}], "]"}], "]"}]}]}], ";", "\n", 
         RowBox[{
          RowBox[{"Append", "[", "de", "]"}], "/@", "mhisto"}]}], "\n", ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", 
          RowBox[{"Length", "[", "model", "]"}]}], "}"}]}], "]"}]}]}], "\n", 
    "\n", "]"}]}], "\n", "\n", "\n"}], "\n"}], "Input",ExpressionUUID->\
"27e9c06c-02c1-42b0-b36a-fa0d86ffc7a3"],

Cell[BoxData[{
 RowBox[{"Clear", "[", "FpdaEHisto", "]"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "FpdaEHisto", "]"}], "=", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"FpdaShowIntrinsicDistribution", "->", "True"}], ",", 
       RowBox[{"FpdaIntrinsicDistributionPlotOptions", "\[Rule]", 
        RowBox[{"{", 
         RowBox[{"PlotStyle", "->", 
          RowBox[{"Darker", "@", "Green"}]}], "}"}]}], ",", 
       RowBox[{"FOutput", "->", "FGraph"}], ",", 
       RowBox[{"FpdaDonly", "->", "True"}], ",", 
       RowBox[{"FPDAMethod", "->", "\"\<Approximate pF by pS\>\""}], ",", 
       RowBox[{"FFitCurveOptions", "->", 
        RowBox[{"{", "}"}]}], ",", 
       RowBox[{"FSubPopCurveOptions", "->", 
        RowBox[{"{", "}"}]}]}], "}"}], "~", "Join", "~", 
     RowBox[{"Options", "[", "Graphics", "]"}], "~", "Join", "~", 
     RowBox[{"Options", "[", "FPlotHisto", "]"}], "~", "Join", "~", 
     RowBox[{"Options", "[", "FGetFromBurstList", "]"}]}]}], ";"}], 
  "\n"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FpdaEHisto", "[", 
    RowBox[{
     RowBox[{"ehisto", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumericQ"}], ",", 
          RowBox[{"_", "?", "NumericQ"}], ",", 
          RowBox[{"_", "?", "NumericQ"}]}], "}"}], "..."}], "}"}]}], ",", 
     RowBox[{"pF", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}], ".."}], "}"}]}], ",", 
     RowBox[{"model", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumericQ"}], ",", 
          RowBox[{"_", "?", "NumericQ"}], ",", 
          RowBox[{"_", "?", "NumericQ"}]}], "}"}], ".."}], "}"}]}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"bgD_", "?", "NumericQ"}], ",", 
       RowBox[{"bgA_", "?", "NumericQ"}]}], "}"}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "\[Alpha]", ",", "\[Beta]", ",", "\[Gamma]", ",", "betamax", ",", 
       "pamodel", ",", "mhisto", ",", "nbursts", ",", "e1", ",", "e2", ",", 
       "de", ",", " ", "subfunc", ",", "subpopplstyle", ",", "pldat", ",", 
       "plpda", ",", "plintrinsic", ",", "plsubpop", ",", "plall", ",", 
       "scale", ",", "smin"}], "}"}], ",", "\n", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Length", "[", "model", "]"}], "!=", 
         RowBox[{"Length", "[", "pF", "]"}]}], ",", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"FpdaEHisto", "::", "dimerr"}], "]"}], ";", 
         RowBox[{"Return", "[", "$Failed", "]"}]}]}], "]"}], ";", "\n", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{
         RowBox[{"betamax", "[", 
          RowBox[{"{", 
           RowBox[{"\[Mu]_", ",", "\[Nu]_"}], "}"}], "]"}], ":=", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"\[Piecewise]", "\t", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"-", "1"}], "+", "\[Nu]", "-", 
                    RowBox[{"\[Mu]", " ", "\[Nu]"}]}], ")"}], "/", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"-", "2"}], "+", "\[Nu]"}], ")"}]}], ")"}], "^", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"-", "1"}], "+", "\[Nu]", "-", 
                  RowBox[{"\[Mu]", " ", "\[Nu]"}]}], ")"}]}], " ", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"-", "1"}], "+", 
                    RowBox[{"\[Mu]", " ", "\[Nu]"}]}], ")"}], "/", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"-", "2"}], "+", "\[Nu]"}], ")"}]}], ")"}], "^", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"-", "1"}], "+", 
                  RowBox[{"\[Mu]", " ", "\[Nu]"}]}], ")"}]}]}], ")"}]}], "/", 
            RowBox[{"Beta", "[", 
             RowBox[{
              RowBox[{"\[Mu]", " ", "\[Nu]"}], ",", 
              RowBox[{"\[Nu]", "-", 
               RowBox[{"\[Mu]", " ", "\[Nu]"}]}]}], "]"}]}], "\t", "0"}], "<", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             RowBox[{"-", "1"}], "+", 
             RowBox[{"\[Mu]", " ", "\[Nu]"}]}], ")"}], "/", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"-", "2"}], "+", "\[Nu]"}], ")"}]}], "<", 
          RowBox[{"1", "\n", "0", "\t", "True"}]}]}], "\n", "\n", ";"}], 
       "*)"}], "\n", "\n", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{
         RowBox[{"betamax", "[", 
          RowBox[{"{", 
           RowBox[{"a_", ",", "\[Mu]_", ",", "\[Nu]_"}], "}"}], "]"}], ":=", 
         RowBox[{
          RowBox[{"FpdaPofE", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"\[Alpha]", ",", "\[Beta]", ",", "\[Gamma]"}], "}"}], 
            ",", 
            RowBox[{"{", 
             RowBox[{"a", ",", "\[Mu]", ",", "\[Nu]"}], "}"}]}], "]"}], "[", 
          "\[Mu]", "]"}]}], ";"}], "*)"}], "\n", 
      RowBox[{"smin", "=", 
       RowBox[{"FpdaAutoselectSmin", "[", "pF", "]"}]}], ";", "\n", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"\[Alpha]", ",", "\[Beta]", ",", "\[Gamma]"}], "}"}], "=", 
       RowBox[{
       "FpdaGetCorrectionFactors\[Alpha]\[Beta]\[Gamma]", "[", "]"}]}], ";", 
      "\n", 
      RowBox[{"FPDASettings", "[", 
       RowBox[{
       "\[Gamma]", ",", "\[Beta]", ",", "\[Alpha]", ",", "bgA", ",", "bgD"}], 
       "]"}], ";", "\n", 
      RowBox[{"FPDASetpF", "[", "pF", "]"}], ";", "\n", 
      RowBox[{"pamodel", "=", 
       RowBox[{"Abs", "@", "model"}]}], ";", "\n", 
      RowBox[{
       RowBox[{"pamodel", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "2"}], "]"}], "]"}], "=", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{"FProximityRatio", "[", 
          RowBox[{"\[Alpha]", ",", "\[Beta]", ",", "\[Gamma]"}], "]"}], ",", 
         RowBox[{"pamodel", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "2"}], "]"}], "]"}]}], "]"}]}], ";", "\n", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "FpdaDonly", "]"}], "===", "True"}], ",",
         "\n", 
        RowBox[{
         RowBox[{"pamodel", "[", 
          RowBox[{"[", 
           RowBox[{"1", ",", "2"}], "]"}], "]"}], "=", 
         RowBox[{
          RowBox[{"FProximityRatio", "[", 
           RowBox[{"0", ",", "\[Beta]", ",", "\[Gamma]"}], "]"}], "[", 
          RowBox[{"model", "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "2"}], "]"}], "]"}], "]"}]}]}], "\n", "]"}], 
      ";", "\n", 
      RowBox[{"FPDACalcPSA", "[", 
       RowBox[{"pamodel", ",", 
        RowBox[{"FilterRules", "[", 
         RowBox[{
          RowBox[{"{", "opts", "}"}], ",", 
          RowBox[{"Options", "[", "FPDACalcPSA", "]"}]}], "]"}]}], "]"}], ";",
       "\n", 
      RowBox[{"nbursts", "=", 
       RowBox[{"Total", "[", 
        RowBox[{"ehisto", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}]}], ";", "\n", 
      RowBox[{"de", "=", 
       RowBox[{
        RowBox[{"ehisto", "[", 
         RowBox[{"[", 
          RowBox[{"2", ",", "1"}], "]"}], "]"}], "-", 
        RowBox[{"ehisto", "[", 
         RowBox[{"[", 
          RowBox[{"1", ",", "1"}], "]"}], "]"}]}]}], ";", "\n", 
      RowBox[{"e1", "=", 
       RowBox[{
        RowBox[{"ehisto", "[", 
         RowBox[{"[", 
          RowBox[{"1", ",", "1"}], "]"}], "]"}], "-", 
        RowBox[{"0.5", " ", "de"}]}]}], ";", "\n", 
      RowBox[{"e2", "=", 
       RowBox[{
        RowBox[{"ehisto", "[", 
         RowBox[{"[", 
          RowBox[{
           RowBox[{"-", "1"}], ",", "1"}], "]"}], "]"}], "+", " ", 
        RowBox[{"0.5", "de"}]}]}], ";", "\n", 
      RowBox[{"mhisto", "=", 
       RowBox[{"FPDAEhisto", "[", 
        RowBox[{"e1", ",", "e2", ",", 
         RowBox[{"Length", "[", "ehisto", "]"}], ",", "smin"}], "]"}]}], ";", 
      "\n", 
      RowBox[{
       RowBox[{"mhisto", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "2"}], "]"}], "]"}], "*=", 
       RowBox[{"nbursts", "*", 
        RowBox[{"Total", "[", 
         RowBox[{"model", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "1"}], "]"}], "]"}], "]"}]}]}], ";", "\n", 
      RowBox[{"mhisto", "=", 
       RowBox[{
        RowBox[{"Append", "[", "de", "]"}], "/@", "mhisto"}]}], ";", "\n", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "FOutput", "]"}], "===", "FGraph"}], ",",
         "\n", "\n", 
        RowBox[{
         RowBox[{"pldat", "=", 
          RowBox[{"FPlotHisto", "[", 
           RowBox[{"ehisto", ",", 
            RowBox[{"FilterRules", "[", 
             RowBox[{
              RowBox[{"{", "opts", "}"}], ",", 
              RowBox[{"Options", "[", "FPlotHisto", "]"}]}], "]"}], ",", 
            RowBox[{"PlotRange", "->", "All"}]}], "]"}]}], ";", "\n", "\n", 
         "\n", 
         RowBox[{"plpda", "=", 
          RowBox[{"FPlotContourHisto", "[", 
           RowBox[{"mhisto", ",", 
            RowBox[{"Sequence", "@@", 
             RowBox[{"OptionValue", "[", "FFitCurveOptions", "]"}]}], ",", 
            RowBox[{"PlotRange", "->", "All"}], ",", 
            RowBox[{"PlotStyle", "->", 
             RowBox[{"Directive", "[", 
              RowBox[{"Red", ",", 
               RowBox[{"AbsoluteThickness", "[", "1.5", "]"}]}], "]"}]}], ",", 
            RowBox[{"Filling", "->", "Axis"}], ",", 
            RowBox[{"FillingStyle", "->", 
             RowBox[{"Directive", "[", 
              RowBox[{"White", ",", 
               RowBox[{"Opacity", "[", "0.2", "]"}]}], "]"}]}]}], "]"}]}], 
         ";", "\n", "\n", 
         RowBox[{"plsubpop", "=", 
          RowBox[{"FPlotContourHisto", "[", 
           RowBox[{
            RowBox[{"FpdaEHistoSubpopulations", "[", 
             RowBox[{"ehisto", ",", "pF", ",", "model", ",", 
              RowBox[{"{", 
               RowBox[{"bgD", ",", "bgA"}], "}"}], ",", 
              RowBox[{"FilterRules", "[", 
               RowBox[{
                RowBox[{"{", "opts", "}"}], ",", 
                RowBox[{"Options", "[", "FpdaEHistoSubpopulations", "]"}]}], 
               "]"}]}], "]"}], ",", 
            RowBox[{"Sequence", "@@", 
             RowBox[{"OptionValue", "[", "FSubPopCurveOptions", "]"}]}], ",", 
            RowBox[{"PlotRange", "->", "All"}]}], "]"}]}], ";", "\n", 
         RowBox[{"plall", "=", 
          RowBox[{"Show", "[", 
           RowBox[{"pldat", ",", "plsubpop", ",", "plpda", ",", 
            RowBox[{"FilterRules", "[", 
             RowBox[{
              RowBox[{"{", "opts", "}"}], ",", 
              RowBox[{"Options", "[", "Graphics", "]"}]}], "]"}], ",", 
            RowBox[{"ImageSize", "->", "400"}], ",", 
            RowBox[{"AspectRatio", "->", 
             RowBox[{"1", "/", "2"}]}], ",", 
            RowBox[{"Axes", "->", "False"}], ",", 
            RowBox[{"Frame", "->", "True"}], ",", 
            RowBox[{"LabelStyle", "->", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"FontFamily", "->", "\"\<Helvetica\>\""}], ",", 
               RowBox[{"FontSize", "->", "12"}], ",", 
               RowBox[{"FontWeight", "->", "Bold"}]}], "}"}]}], ",", 
            RowBox[{"FrameStyle", "->", 
             RowBox[{"Directive", "[", 
              RowBox[{"Black", ",", 
               RowBox[{"AbsoluteThickness", "[", "1", "]"}]}], "]"}]}], ",", 
            RowBox[{"FrameLabel", "->", 
             RowBox[{"{", 
              RowBox[{"\"\<E\>\"", ",", 
               RowBox[{"\"\<# (total: \>\"", "<>", 
                RowBox[{"ToString", "[", 
                 RowBox[{"Total", "@", 
                  RowBox[{"ehisto", "[", 
                   RowBox[{"[", 
                    RowBox[{"All", ",", "2"}], "]"}], "]"}]}], "]"}], "<>", 
                "\"\<)\>\""}]}], "}"}]}]}], "]"}]}], ";", "\n", "\n", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{
            "OptionValue", "[", "FpdaShowIntrinsicDistribution", "]"}], "===",
             "True"}], ",", "\n", 
           RowBox[{"(", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"plintrinsic", "=", 
              RowBox[{"Plot", "[", 
               RowBox[{
                RowBox[{"Evaluate", "[", 
                 RowBox[{
                  RowBox[{"FpdaIntrinsicDistribution", "[", 
                   RowBox[{
                    RowBox[{"{", 
                    RowBox[{"\[Alpha]", ",", "\[Beta]", ",", "\[Gamma]"}], 
                    "}"}], ",", "model"}], "]"}], "[", "e", "]"}], "]"}], ",", 
                RowBox[{"{", 
                 RowBox[{"e", ",", "e1", ",", "e2"}], "}"}], ",", 
                RowBox[{"Evaluate", "[", 
                 RowBox[{
                 "OptionValue", "[", "FpdaIntrinsicDistributionPlotOptions", 
                  "]"}], "]"}], ",", 
                RowBox[{"PlotRange", "->", "All"}]}], "]"}]}], ";", "\n", 
             RowBox[{"plintrinsic", "=", 
              RowBox[{"Show", "[", 
               RowBox[{"plintrinsic", ",", 
                RowBox[{"ImageSize", "->", "400"}], ",", 
                RowBox[{"AspectRatio", "->", "0.2"}], ",", 
                RowBox[{"Axes", "->", "False"}], ",", 
                RowBox[{"Frame", "->", "True"}], ",", 
                RowBox[{"LabelStyle", "->", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"FontFamily", "->", "\"\<Helvetica\>\""}], ",", 
                   RowBox[{"FontSize", "->", "12"}], ",", 
                   RowBox[{"FontWeight", "->", "Bold"}]}], "}"}]}], ",", 
                RowBox[{"FrameStyle", "->", 
                 RowBox[{"Directive", "[", 
                  RowBox[{"Black", ",", 
                   RowBox[{"AbsoluteThickness", "[", "1", "]"}]}], "]"}]}], 
                ",", 
                RowBox[{"FrameLabel", "->", 
                 RowBox[{"{", 
                  RowBox[{"\"\<E\>\"", ",", "\"\<\>\""}], "}"}]}]}], "]"}]}], 
             ";", "\n", 
             RowBox[{"Column", "[", 
              RowBox[{"{", 
               RowBox[{"plall", ",", "plintrinsic"}], "}"}], "]"}]}], ")"}], 
           ",", "plall"}], "]"}]}], "\n", ",", "mhisto"}], "]"}]}]}], "\n", 
    "]"}]}], "\n"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FpdaEHisto", "[", 
    RowBox[{
     RowBox[{"ehisto", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumericQ"}], ",", 
          RowBox[{"_", "?", "NumericQ"}], ",", 
          RowBox[{"_", "?", "NumericQ"}]}], "}"}], "..."}], "}"}]}], ",", 
     RowBox[{"pF", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}], ".."}], "}"}]}], ",", 
     RowBox[{"model", ":", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"_", "?", "NumericQ"}], ",", 
          RowBox[{"_", "?", "NumericQ"}], ",", 
          RowBox[{"_", "?", "NumericQ"}]}], "}"}], ".."}], "}"}]}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"FpdaEHisto", "[", 
    RowBox[{"ehisto", ",", "pF", ",", "model", ",", 
     RowBox[{"FpdaGetDABackground", "[", "]"}], ",", "opts"}], "]"}]}], 
  "\n"}], "\n", 
 RowBox[{
  RowBox[{"FpdaEHisto", "[", 
   RowBox[{
    RowBox[{"erange", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"e1_", "?", "NumericQ"}], ",", 
       RowBox[{"e2_", "?", "NumericQ"}], ",", 
       RowBox[{"de_", "?", "NumericQ"}]}], "}"}]}], ",", "x__", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"FpdaEHisto", "[", 
   RowBox[{
    RowBox[{"FParamHisto", "[", 
     RowBox[{"\"\<E\>\"", ",", "erange", ",", 
      RowBox[{"FOutput", "->", "FData"}], ",", 
      RowBox[{"FilterRules", "[", 
       RowBox[{
        RowBox[{"{", "opts", "}"}], ",", 
        RowBox[{"Options", "[", "FGetFromBurstList", "]"}]}], "]"}]}], "]"}], 
    ",", "x", ",", "opts"}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.7498970242153997`*^9, 3.749897024239337*^9}, {
   3.7790206441981077`*^9, 3.7790206450498323`*^9}, {3.779020981269385*^9, 
   3.7790209821450443`*^9}, {3.7939515152565336`*^9, 3.793951555486905*^9}, 
   3.7939515873416924`*^9, {3.793951679226879*^9, 3.793951700290532*^9}, 
   3.793952466843239*^9, {3.7939526980706882`*^9, 3.793952709332611*^9}, 
   3.793953004023197*^9, 3.7939530846724415`*^9, {3.7939531161093683`*^9, 
   3.7939531249008245`*^9}, {3.7939535433866944`*^9, 
   3.7939536131414547`*^9}, {3.7939601874960623`*^9, 
   3.7939601891306877`*^9}, {3.793960813491285*^9, 3.7939608680977793`*^9}, {
   3.793960920788822*^9, 
   3.79396092174427*^9}},ExpressionUUID->"74a85bde-78ed-4e4f-9161-\
c165a2a6fea1"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FpdaChiqr", "[", 
   RowBox[{"ehisto_", ",", 
    RowBox[{"model", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumberQ"}], ",", 
         RowBox[{"_", "?", "NumberQ"}], ",", 
         RowBox[{"_", "?", "NumberQ"}]}], "}"}], ".."}], "}"}]}], ",", 
    "smin_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "mhisto", ",", "diff", ",", "nbursts", ",", "e1", ",", "e2", ",", "de"}],
      "}"}], ",", "\n", "\n", 
    RowBox[{
     RowBox[{"nbursts", "=", 
      RowBox[{"Total", "[", 
       RowBox[{"ehisto", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}]}], ";", "\n", 
     RowBox[{"de", "=", 
      RowBox[{
       RowBox[{"ehisto", "[", 
        RowBox[{"[", 
         RowBox[{"2", ",", "1"}], "]"}], "]"}], "-", 
       RowBox[{"ehisto", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "1"}], "]"}], "]"}]}]}], ";", "\n", 
     RowBox[{"e1", "=", 
      RowBox[{
       RowBox[{"ehisto", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "1"}], "]"}], "]"}], "-", 
       RowBox[{"0.5", " ", "de"}]}]}], ";", "\n", 
     RowBox[{"e2", "=", 
      RowBox[{
       RowBox[{"ehisto", "[", 
        RowBox[{"[", 
         RowBox[{
          RowBox[{"-", "1"}], ",", "1"}], "]"}], "]"}], "+", " ", 
       RowBox[{"0.5", "de"}]}]}], ";", "\n", 
     RowBox[{
      RowBox[{"FPDACalcPSA", "[", "model", "]"}], "[", "model", "]"}], ";", 
     "\n", 
     RowBox[{"mhisto", "=", 
      RowBox[{"FPDAEhisto", "[", 
       RowBox[{"e1", ",", "e2", ",", 
        RowBox[{"Length", "[", "ehisto", "]"}], ",", "smin"}], "]"}]}], ";", 
     "\n", 
     RowBox[{
      RowBox[{"mhisto", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "2"}], "]"}], "]"}], "*=", 
      RowBox[{"nbursts", "*", 
       RowBox[{"Total", "[", 
        RowBox[{"model", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "1"}], "]"}], "]"}], "]"}]}]}], ";", "\n", 
     RowBox[{"diff", "=", 
      RowBox[{
       RowBox[{"ehisto", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "2"}], "]"}], "]"}], "-", 
       RowBox[{"mhisto", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "2"}], "]"}], "]"}]}]}], ";", "\n", 
     RowBox[{"diff", ".", "diff"}]}]}], "\n", "]"}]}]], "Input",ExpressionUUID\
->"c6d5605e-ac73-464f-ac4f-77658150b9df"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FpdaChiqrGlobal", "[", 
   RowBox[{"ehistolist_", ",", "modellist_", ",", "smin_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "}"}], ",", "\n", 
    RowBox[{"Total", "@", 
     RowBox[{"MapThread", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"FpdaChiqr", "[", 
         RowBox[{"#1", ",", "#2", ",", "smin"}], "]"}], "&"}], ",", 
       RowBox[{"{", 
        RowBox[{"ehistolist", ",", "modellist"}], "}"}]}], "]"}]}]}], "\n", 
   "]"}]}]], "Input",ExpressionUUID->"9e823de7-0f35-4585-b18a-4898832eb76e"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"Clear", "[", "FpdaFitEHisto", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "FpdaFitEHisto", "]"}], "=", 
    RowBox[{"Join", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"FpdaDonly", "->", "True"}], ",", 
        RowBox[{"FConstraints", "->", "None"}]}], "}"}], ",", 
      RowBox[{"Options", "[", "FpdaEHisto", "]"}], ",", 
      RowBox[{"Options", "[", "FindMinimum", "]"}]}], "]"}]}], ";"}], 
  "\n"}], "\n", 
 RowBox[{
  RowBox[{"FpdaFitEHisto", "[", 
   RowBox[{
    RowBox[{"ehisto", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumericQ"}], ",", 
         RowBox[{"_", "?", "NumericQ"}], ",", 
         RowBox[{"_", "?", "NumericQ"}]}], "}"}], "..."}], "}"}]}], ",", 
    RowBox[{"pF", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}], ".."}], "}"}]}], ",", 
    RowBox[{"model", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"_", ",", "_", ",", "_"}], "}"}], ".."}], "}"}]}], ",", 
    "guess_List", ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"bgD_", "?", "NumericQ"}], ",", 
      RowBox[{"bgA_", "?", "NumericQ"}]}], "}"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  "\[IndentingNewLine]", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "\[Alpha]", ",", "\[Beta]", ",", "\[Gamma]", ",", "smin", ",", "fit", 
      ",", "pamodel", ",", "meritfunc"}], "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Length", "[", "model", "]"}], "!=", 
        RowBox[{"Length", "[", "pF", "]"}]}], ",", 
       RowBox[{
        RowBox[{"Message", "[", 
         RowBox[{"FpdaFitEHisto", "::", "dimerr"}], "]"}], ";", 
        RowBox[{"Return", "[", "$Failed", "]"}]}]}], "]"}], ";", "\n", 
     RowBox[{"smin", "=", 
      RowBox[{"FpdaAutoselectSmin", "[", "pF", "]"}]}], ";", "\n", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"\[Alpha]", ",", "\[Beta]", ",", "\[Gamma]"}], "}"}], "=", 
      RowBox[{"FpdaGetCorrectionFactors\[Alpha]\[Beta]\[Gamma]", "[", "]"}]}],
      ";", "\n", 
     RowBox[{"FPDASettings", "[", 
      RowBox[{
      "\[Gamma]", ",", "\[Beta]", ",", "\[Alpha]", ",", "bgA", ",", "bgD"}], 
      "]"}], ";", "\n", 
     RowBox[{"FPDASetpF", "[", "pF", "]"}], ";", "\n", 
     RowBox[{"pamodel", "=", 
      RowBox[{"Abs", "@", "model"}]}], ";", "\n", 
     RowBox[{
      RowBox[{"pamodel", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "2"}], "]"}], "]"}], "=", 
      RowBox[{"Map", "[", 
       RowBox[{
        RowBox[{"FProximityRatio", "[", 
         RowBox[{"\[Alpha]", ",", "\[Beta]", ",", "\[Gamma]"}], "]"}], ",", 
        RowBox[{"pamodel", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "2"}], "]"}], "]"}]}], "]"}]}], ";", "\n", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FpdaDonly", "]"}], "===", "True"}], ",", 
       "\n", 
       RowBox[{
        RowBox[{"pamodel", "[", 
         RowBox[{"[", 
          RowBox[{"1", ",", "2"}], "]"}], "]"}], "=", 
        RowBox[{
         RowBox[{"FProximityRatio", "[", 
          RowBox[{"0", ",", "\[Beta]", ",", "\[Gamma]"}], "]"}], "[", 
         RowBox[{"model", "[", 
          RowBox[{"[", 
           RowBox[{"1", ",", "2"}], "]"}], "]"}], "]"}]}]}], "\n", "]"}], ";",
      "\[IndentingNewLine]", 
     RowBox[{"meritfunc", "=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "FConstraints", "]"}], "=!=", "None"}], 
        ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"FpdaChiqr", "[", 
           RowBox[{"ehisto", ",", "pamodel", ",", "smin"}], "]"}], ",", 
          RowBox[{"OptionValue", "[", "FConstraints", "]"}]}], "}"}], ",", 
        RowBox[{"FpdaChiqr", "[", 
         RowBox[{"ehisto", ",", "pamodel", ",", "smin"}], "]"}]}], "]"}]}], 
     ";", "\n", 
     RowBox[{"fit", "=", 
      RowBox[{"FindMinimum", "[", 
       RowBox[{"meritfunc", ",", "guess", ",", 
        RowBox[{"Evaluate", "[", 
         RowBox[{"FilterRules", "[", 
          RowBox[{
           RowBox[{"{", "opts", "}"}], ",", 
           RowBox[{"Options", "[", "FindMinimum", "]"}]}], "]"}], "]"}], ",", 
        RowBox[{"AccuracyGoal", "->", "3"}]}], "]"}]}], ";", "\n", 
     RowBox[{"{", 
      RowBox[{"fit", ",", 
       RowBox[{"FpdaEHisto", "[", 
        RowBox[{"ehisto", ",", "pF", ",", 
         RowBox[{"model", "/.", 
          RowBox[{"fit", "[", 
           RowBox[{"[", "2", "]"}], "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"bgD", ",", "bgA"}], "}"}], ",", 
         RowBox[{"FilterRules", "[", 
          RowBox[{
           RowBox[{"{", "opts", "}"}], ",", 
           RowBox[{"Options", "[", "FpdaEHisto", "]"}]}], "]"}]}], "]"}]}], 
      "}"}]}]}], "\n", "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FpdaFitEHisto", "[", 
   RowBox[{
    RowBox[{"ehisto", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumericQ"}], ",", 
         RowBox[{"_", "?", "NumericQ"}], ",", 
         RowBox[{"_", "?", "NumericQ"}]}], "}"}], "..."}], "}"}]}], ",", 
    RowBox[{"pF", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}], ".."}], "}"}]}], ",", 
    RowBox[{"model", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"_", ",", "_", ",", "_"}], "}"}], ".."}], "}"}]}], ",", 
    "guess_List", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"FpdaFitEHisto", "[", 
   RowBox[{"ehisto", ",", "pF", ",", "model", ",", "guess", ",", 
    RowBox[{"FpdaGetDABackground", "[", "]"}], ",", "opts"}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FpdaFitEHisto", "[", 
   RowBox[{
    RowBox[{"erange", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"e1_", "?", "NumericQ"}], ",", 
       RowBox[{"e2_", "?", "NumericQ"}], ",", 
       RowBox[{"de_", "?", "NumericQ"}]}], "}"}]}], ",", "x__"}], "]"}], ":=", 
  RowBox[{"FpdaFitEHisto", "[", 
   RowBox[{
    RowBox[{"FParamHisto", "[", 
     RowBox[{"\"\<E\>\"", ",", "erange", ",", 
      RowBox[{"FOutput", "->", "FData"}]}], "]"}], ",", "x"}], 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.79394894783435*^9, 3.793948948792784*^9}, {
   3.793949039991564*^9, 3.7939490650744267`*^9}, 3.7939492222009554`*^9, {
   3.7939493191625605`*^9, 
   3.7939494129027925`*^9}},ExpressionUUID->"0b5d5f08-9ff5-4587-91a5-\
bd4e0d1ecd90"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FpdaFitEHisto", "[", 
   RowBox[{
    RowBox[{"ehisto", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumericQ"}], ",", 
           RowBox[{"_", "?", "NumericQ"}], ",", 
           RowBox[{"_", "?", "NumericQ"}]}], "}"}], "..."}], "}"}], ".."}], 
      "}"}]}], ",", 
    RowBox[{"pF", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}], ".."}], "}"}]}], ",", 
    RowBox[{"model", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"_", ",", "_", ",", "_"}], "}"}], ".."}], "}"}], ".."}], 
      "}"}]}], ",", "guess_List", ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"bgD_", "?", "NumericQ"}], ",", 
      RowBox[{"bgA_", "?", "NumericQ"}]}], "}"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "\[Alpha]", ",", "\[Beta]", ",", "\[Gamma]", ",", "smin", ",", "fit", 
      ",", "pamodel", ",", "meritfunc"}], "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Length", "[", "model", "]"}], "!=", 
        RowBox[{"Length", "[", "ehisto", "]"}]}], ",", 
       RowBox[{
        RowBox[{"Message", "[", 
         RowBox[{"FpdaFitEHisto", "::", "dimerr"}], "]"}], ";", 
        RowBox[{"Return", "[", "$Failed", "]"}]}]}], "]"}], ";", "\n", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"Or", "@@", 
        RowBox[{"Map", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"Length", "[", "#", "]"}], "!=", 
            RowBox[{"Length", "[", "pF", "]"}]}], "&"}], ",", "model"}], 
         "]"}]}], ",", 
       RowBox[{
        RowBox[{"Message", "[", 
         RowBox[{"FpdaFitEHisto", "::", "dimerr"}], "]"}], ";", 
        RowBox[{"Return", "[", "$Failed", "]"}]}]}], "]"}], ";", "\n", 
     RowBox[{"smin", "=", 
      RowBox[{"FpdaAutoselectSmin", "[", "pF", "]"}]}], ";", "\n", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"\[Alpha]", ",", "\[Beta]", ",", "\[Gamma]"}], "}"}], "=", 
      RowBox[{"FpdaGetCorrectionFactors\[Alpha]\[Beta]\[Gamma]", "[", "]"}]}],
      ";", "\n", 
     RowBox[{"FPDASettings", "[", 
      RowBox[{
      "\[Gamma]", ",", "\[Beta]", ",", "\[Alpha]", ",", "bgA", ",", "bgD"}], 
      "]"}], ";", "\n", 
     RowBox[{"FPDASetpF", "[", "pF", "]"}], ";", "\n", 
     RowBox[{"pamodel", "=", 
      RowBox[{"Abs", "@", "model"}]}], ";", "\n", 
     RowBox[{
      RowBox[{"pamodel", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "All", ",", "2"}], "]"}], "]"}], "=", 
      RowBox[{"Map", "[", 
       RowBox[{
        RowBox[{"FProximityRatio", "[", 
         RowBox[{"\[Alpha]", ",", "\[Beta]", ",", "\[Gamma]"}], "]"}], ",", 
        RowBox[{"pamodel", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "All", ",", "2"}], "]"}], "]"}]}], "]"}]}], ";",
      "\n", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "FpdaDonly", "]"}], "===", "True"}], ",", 
       "\n", 
       RowBox[{
        RowBox[{"pamodel", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "1", ",", "2"}], "]"}], "]"}], "=", 
        RowBox[{
         RowBox[{"FProximityRatio", "[", 
          RowBox[{"0", ",", "\[Beta]", ",", "\[Gamma]"}], "]"}], "[", 
         RowBox[{"model", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "1", ",", "2"}], "]"}], "]"}], "]"}]}]}], "\n",
       "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"meritfunc", "=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "FConstraints", "]"}], "=!=", "None"}], 
        ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"FpdaChiqrGlobal", "[", 
           RowBox[{"ehisto", ",", "pamodel", ",", "smin"}], "]"}], ",", 
          RowBox[{"OptionValue", "[", "FConstraints", "]"}]}], "}"}], ",", 
        RowBox[{"FpdaChiqrGlobal", "[", 
         RowBox[{"ehisto", ",", "pamodel", ",", "smin"}], "]"}]}], "]"}]}], 
     ";", "\n", 
     RowBox[{"fit", "=", 
      RowBox[{"FindMinimum", "[", 
       RowBox[{"meritfunc", ",", "guess", ",", 
        RowBox[{"Evaluate", "[", 
         RowBox[{"FilterRules", "[", 
          RowBox[{
           RowBox[{"{", "opts", "}"}], ",", 
           RowBox[{"Options", "[", "FindMinimum", "]"}]}], "]"}], "]"}], ",", 
        RowBox[{"AccuracyGoal", "->", "3"}]}], "]"}]}], ";", "\n", 
     RowBox[{"{", 
      RowBox[{"fit", ",", 
       RowBox[{"MapThread", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"FpdaEHisto", "[", 
           RowBox[{"#1", ",", "pF", ",", "#2", ",", 
            RowBox[{"{", 
             RowBox[{"bgD", ",", "bgA"}], "}"}], ",", 
            RowBox[{"FilterRules", "[", 
             RowBox[{
              RowBox[{"{", "opts", "}"}], ",", 
              RowBox[{"Options", "[", "FpdaEHisto", "]"}]}], "]"}]}], "]"}], 
          "&"}], ",", 
         RowBox[{"{", 
          RowBox[{"ehisto", ",", 
           RowBox[{"model", "/.", 
            RowBox[{"fit", "[", 
             RowBox[{"[", "2", "]"}], "]"}]}]}], "}"}]}], "]"}]}], "}"}]}]}], 
   "\n", "]"}]}], "\n", 
 RowBox[{
  RowBox[{"FpdaFitEHisto", "[", 
   RowBox[{
    RowBox[{"ehisto", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_", "?", "NumericQ"}], ",", 
           RowBox[{"_", "?", "NumericQ"}], ",", 
           RowBox[{"_", "?", "NumericQ"}]}], "}"}], "..."}], "}"}], ".."}], 
      "}"}]}], ",", 
    RowBox[{"pF", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"_", "?", "NumericQ"}], ".."}], "}"}], ".."}], "}"}]}], ",", 
    RowBox[{"model", ":", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"_", ",", "_", ",", "_"}], "}"}], ".."}], "}"}], ".."}], 
      "}"}]}], ",", "guess_List", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"FpdaFitEHisto", "[", 
   RowBox[{"ehisto", ",", "pF", ",", "model", ",", "guess", ",", 
    RowBox[{"FpdaGetDABackground", "[", "]"}], ",", "opts"}], 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.793949502047311*^9, 
  3.7939495369788585`*^9}},ExpressionUUID->"42b22b1a-152d-4bd2-832b-\
0bfff4bbe62f"]
}, Closed]],

Cell[CellGroupData[{

Cell["End of Fretica Package", "Subsubsection",ExpressionUUID->"0ee36883-06d9-4c86-b1ce-0f116a2bab4e"],

Cell[BoxData[
 RowBox[{
  RowBox[{"End", "[", "]"}], ";"}]], "Code",ExpressionUUID->"e1479055-0f9e-4aab-a4e6-69ba8e9eb244"],

Cell[BoxData[
 RowBox[{"(*", " ", 
  RowBox[{":", 
   RowBox[{"Code", " ", "Section", " ", 
    RowBox[{"(", 
     RowBox[{"Call", " ", "Protect"}], ")"}]}], ":"}], " ", "*)"}]], "Input",E\
xpressionUUID->"a0566da8-c2e4-4666-bdb2-5fbb502d7167"],

Cell[BoxData[
 RowBox[{
  RowBox[{"EndPackage", "[", "]"}], ";"}]], "Code",ExpressionUUID->"c9649a9d-0eca-4695-b984-1014204bb4ae"],

Cell[BoxData[
 RowBox[{
  RowBox[{"Print", "[", 
   RowBox[{"FAboutFretica", "[", "]"}], "]"}], ";"}]], "Input",
 CellChangeTimes->{
  3.748329655638426*^9, 3.807522738691182*^9, {3.807524339481407*^9, 
   3.80752434343285*^9}, {3.8075325428419137`*^9, 
   3.8075325458009977`*^9}},ExpressionUUID->"024c6b46-48f8-4938-9644-\
e6e54abefe46"]
}, Open  ]]
}, Open  ]]
}, Open  ]]
},
AutoGeneratedPackage->Automatic,
WindowSize->{1140., 567.6},
WindowMargins->{{0.6, Automatic}, {Automatic, 0.6}},
TaggingRules->None,
Magnification:>1. Inherited,
FrontEndVersion->"13.2 for Microsoft Windows (64-bit) (January 30, 2023)",
StyleDefinitions->Notebook[{
   Cell[
    StyleData[StyleDefinitions -> "Default.nb"]], 
   Cell[
    StyleData["Input"], InitializationCell -> True]}, Visible -> False, 
  FrontEndVersion -> "13.2 for Microsoft Windows (64-bit) (January 30, 2023)",
   StyleDefinitions -> "PrivateStylesheetFormatting.nb"],
ExpressionUUID->"1eb48650-19e1-41c6-a6a7-c340d3c014f5"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[558, 20, 1372, 34, 173, "Code",ExpressionUUID->"5da14fe6-0a4c-47d9-84fc-9c5c36c7eaef"],
Cell[1933, 56, 152, 3, 44, "Input",ExpressionUUID->"13d1e953-44db-4551-b4e3-e4ab92efdeb1"],
Cell[2088, 61, 201, 5, 50, "Code",ExpressionUUID->"8acfce9a-4628-438e-8ba8-adb1acc480d1"],
Cell[2292, 68, 930, 25, 64, "Input",ExpressionUUID->"b5aaa088-b671-413c-bc61-c06706fea52c"],
Cell[3225, 95, 279, 7, 44, "Input",ExpressionUUID->"6247b2a0-bf5c-4df7-bdff-ae1809f0babc"],
Cell[3507, 104, 512, 12, 44, "Input",ExpressionUUID->"9f6655d2-e071-48cb-b8b8-413a531203b3"],
Cell[4022, 118, 612, 13, 102, "Input",ExpressionUUID->"7eeb3db9-c3ac-4c47-a223-29a212877451"],
Cell[4637, 133, 360, 9, 44, "Input",ExpressionUUID->"64afba57-5648-4775-a5bd-6ab6ae871979"],
Cell[5000, 144, 651, 13, 83, "Input",ExpressionUUID->"fd38d1a9-1cd1-40f9-963f-a69ec23de402"],
Cell[5654, 159, 367, 8, 64, "Input",ExpressionUUID->"f74cb62d-0f4e-444d-8fc9-3df72f21d694"],
Cell[6024, 169, 2829, 43, 170, "Input",ExpressionUUID->"f9808b69-9bbf-40fc-ac65-cd6e597ddf9d"],
Cell[8856, 214, 2879, 45, 249, "Input",ExpressionUUID->"e473ebd6-7043-4a3b-bd45-c883ac9c4908"],
Cell[11738, 261, 997, 18, 83, "Input",ExpressionUUID->"e3f22fce-f285-4f6e-9f94-2907529e7ed0"],
Cell[12738, 281, 913, 15, 83, "Input",ExpressionUUID->"9570c7e0-4c0b-4b8e-9c3e-f1f1e4407376"],
Cell[13654, 298, 392, 10, 44, "Input",ExpressionUUID->"830f8bbe-9adc-478f-8b05-5a8947dd33b8"],
Cell[14049, 310, 641, 12, 44, "Input",ExpressionUUID->"1a7c93c4-eb1c-4b55-a29e-5fb7397052bf"],
Cell[14693, 324, 350, 8, 44, "Input",ExpressionUUID->"03232659-e573-46a9-ac20-3377db5849e1"],
Cell[15046, 334, 466, 10, 102, "Input",ExpressionUUID->"5a157596-aec1-4d74-868b-aec9e17f243e"],
Cell[15515, 346, 447, 10, 83, "Input",ExpressionUUID->"f91c8ab9-cb19-4514-9289-c0b8ea0a6058"],
Cell[15965, 358, 1455, 34, 178, "Input",ExpressionUUID->"cb433ffd-cc15-45aa-8504-f3233184262a"],
Cell[17423, 394, 1777, 29, 216, "Input",ExpressionUUID->"5ad63650-decf-44f1-a3b7-88aeeb3eccdc"],
Cell[19203, 425, 443, 9, 83, "Input",ExpressionUUID->"643907c9-1a4b-4c82-9634-bffa22b272a2"],
Cell[19649, 436, 438, 9, 83, "Input",ExpressionUUID->"dedee7db-ef5b-4c70-9d25-7deca165ab32"],
Cell[20090, 447, 1858, 38, 254, "Input",ExpressionUUID->"f5bf219e-d205-43d2-82a8-fc644478660b"],
Cell[21951, 487, 922, 19, 140, "Input",ExpressionUUID->"c7c288d9-05aa-498b-97da-779174fdbef5"],
Cell[22876, 508, 1078, 22, 83, "Input",ExpressionUUID->"8f371adf-d376-45a1-b325-e342e2d30af9"],
Cell[23957, 532, 1348, 26, 197, "Input",ExpressionUUID->"93b57c06-f236-4a2a-aa5d-1dbc6bcb4a06"],
Cell[CellGroupData[{
Cell[25330, 562, 215, 4, 54, "Subsection",ExpressionUUID->"3de04541-925b-4b8e-adf0-48a12b6f33a1"],
Cell[25548, 568, 174, 4, 44, "Input",ExpressionUUID->"2a7e1ec1-f417-4d9c-a13b-9d56c48b08e2"],
Cell[25725, 574, 175, 4, 50, "Code",ExpressionUUID->"ecc55701-bc99-4a40-b396-005bf96c4b17"],
Cell[25903, 580, 755, 22, 83, "Input",ExpressionUUID->"ca9242ee-8804-4f9d-953a-4484fce52547"],
Cell[26661, 604, 1125, 31, 121, "Input",ExpressionUUID->"472c0f29-1489-493a-906c-a24ee3842714"],
Cell[27789, 637, 498, 10, 44, "Input",ExpressionUUID->"e5747f1f-893d-49ea-a8d9-f63333b350ae"],
Cell[28290, 649, 174, 4, 44, "Input",ExpressionUUID->"9e6dbcd1-5a0e-4578-9a23-d38686f58633"]
}, Open  ]],
Cell[CellGroupData[{
Cell[28501, 658, 92, 0, 64, "Subchapter",ExpressionUUID->"406c29a5-b1ed-4193-953a-f1a696efe4d5"],
Cell[28596, 660, 219, 5, 50, "Code",ExpressionUUID->"3cae0149-d38b-4d4d-a6f0-10feb90442ab"],
Cell[28818, 667, 8541, 143, 261, "Code",ExpressionUUID->"43ffc1c7-7840-4a7e-86e5-54e86305cf8c"],
Cell[37362, 812, 243, 6, 44, "Input",ExpressionUUID->"5b22b420-2183-42fc-8828-690704fffe53"],
Cell[CellGroupData[{
Cell[37630, 822, 94, 0, 54, "Subsection",ExpressionUUID->"47c7e253-c030-4aa1-bb0c-0430554025dd"],
Cell[37727, 824, 2447, 74, 85, "Code",ExpressionUUID->"128ef719-0a02-4d4a-9772-2fed5f5c78ef"],
Cell[40177, 900, 2763, 72, 173, "Code",ExpressionUUID->"4fc5406d-e493-4a73-9318-c569eaf9f1dc"],
Cell[42943, 974, 2891, 75, 254, "Input",ExpressionUUID->"08d66829-9388-482c-b506-53579a7ace6d"],
Cell[45837, 1051, 3999, 119, 350, "Input",ExpressionUUID->"c333ae48-f6a9-4cd5-98f4-e2e00d3514d9",
 InitializationCell->True],
Cell[49839, 1172, 4983, 130, 260, "Code",ExpressionUUID->"b74bf700-d247-4aa7-adec-e9c8a909fe56"],
Cell[54825, 1304, 2491, 69, 173, "Code",ExpressionUUID->"96e63556-10ad-4167-ac36-0a31d2fc3b3f"],
Cell[57319, 1375, 6570, 187, 446, "Input",ExpressionUUID->"3c8596a7-94e8-48e2-919d-f06daa734f2e"],
Cell[63892, 1564, 6841, 190, 465, "Input",ExpressionUUID->"0f93c200-3fed-4caf-852f-82b70f18166c"],
Cell[70736, 1756, 9191, 262, 717, "Input",ExpressionUUID->"f401cc4a-62bb-42e5-a905-1481c214d409"],
Cell[CellGroupData[{
Cell[79952, 2022, 110, 0, 44, "Subsubsection",ExpressionUUID->"c89a5c52-1392-40aa-9384-1b394385bbaf"],
Cell[80065, 2024, 20583, 457, 1701, "Input",ExpressionUUID->"2050be54-b1ec-43e2-8739-fe7ad6f355ab"]
}, Open  ]]
}, Closed]],
Cell[CellGroupData[{
Cell[100697, 2487, 94, 0, 38, "Subsection",ExpressionUUID->"a1a4b916-3d2d-439e-93a0-7cd4457bdb62"],
Cell[100794, 2489, 185, 4, 44, "Input",ExpressionUUID->"99c9c72b-8fa8-4967-be81-e1ed4ce7a501"],
Cell[100982, 2495, 277, 6, 44, "Input",ExpressionUUID->"8f3a755e-410a-4152-972e-b2dea542b9c1"],
Cell[CellGroupData[{
Cell[101284, 2505, 94, 0, 45, "Subsubsection",ExpressionUUID->"08f3d953-c94b-4926-a07f-88f392733a5e"],
Cell[101381, 2507, 251, 7, 68, "Code",ExpressionUUID->"c9c25d50-38cf-454a-b87e-eff8d7728272"],
Cell[101635, 2516, 171, 4, 50, "Code",ExpressionUUID->"1444c74d-6967-481e-be5a-22045075d525"],
Cell[101809, 2522, 261, 7, 51, "Code",ExpressionUUID->"5758ca9d-e0b3-40b5-835a-e4abc858b437"],
Cell[102073, 2531, 235, 5, 50, "Code",ExpressionUUID->"9c71fa9b-1f43-4dc5-9e54-42a092fea69e"],
Cell[102311, 2538, 526, 15, 50, "Code",ExpressionUUID->"39a92572-ab4d-41ed-bb92-5f25a278d75b"],
Cell[102840, 2555, 527, 13, 68, "Code",ExpressionUUID->"f194950f-65ad-478b-8f55-c69f103fe900"],
Cell[103370, 2570, 412, 11, 50, "Code",ExpressionUUID->"a438be64-3f99-43c9-a60e-c9e86c6d35fa"],
Cell[103785, 2583, 384, 10, 50, "Code",ExpressionUUID->"1365dfa5-6b38-4828-9f98-958c4dfe9557"],
Cell[104172, 2595, 309, 9, 50, "Code",ExpressionUUID->"2896fbdf-911c-47b1-9e78-8f61a694838d"],
Cell[104484, 2606, 2449, 70, 191, "Code",ExpressionUUID->"f7bd3ad6-7825-439c-ac46-c4803c64c606"],
Cell[106936, 2678, 441, 11, 68, "Code",ExpressionUUID->"226ec1eb-8aeb-4e57-9f03-e801c6e7d356"],
Cell[107380, 2691, 3795, 110, 209, "Code",ExpressionUUID->"3dedd067-5238-4898-a506-fcf3a0b9e62f"]
}, Open  ]],
Cell[CellGroupData[{
Cell[111212, 2806, 95, 0, 45, "Subsubsection",ExpressionUUID->"dba62beb-c9a8-4cc0-81f7-48487602bad4"],
Cell[111310, 2808, 5617, 150, 654, "Input",ExpressionUUID->"8d559a9a-0418-4c8a-8a63-cf7b23a5e5f9"],
Cell[116930, 2960, 677, 18, 121, "Input",ExpressionUUID->"6809ee8b-282a-4220-88e2-7ea8d1d1b1c6"],
Cell[117610, 2980, 229, 5, 44, "Input",ExpressionUUID->"2958cd6a-aff6-40d3-9404-cc91359e9adb"],
Cell[117842, 2987, 541, 14, 64, "Input",ExpressionUUID->"19436db9-611a-4af6-b178-b7f805520c36"],
Cell[118386, 3003, 180, 4, 44, "Input",ExpressionUUID->"18298a43-b03d-4b84-8861-cf7098d907a7"],
Cell[118569, 3009, 202, 5, 44, "Input",ExpressionUUID->"71f8278d-7905-4847-b655-e3edb9780d45"],
Cell[118774, 3016, 410, 11, 64, "Input",ExpressionUUID->"b7f1cb43-6dfb-4d9d-89cc-18a90eeb66cd"]
}, Closed]],
Cell[CellGroupData[{
Cell[119221, 3032, 162, 2, 37, "Subsubsection",ExpressionUUID->"ccb381ff-30d1-4f94-80e2-8f2837c56f64"],
Cell[119386, 3036, 4407, 100, 467, "Input",ExpressionUUID->"9f015de6-5570-4559-ac20-34d038997742"]
}, Closed]],
Cell[CellGroupData[{
Cell[123830, 3141, 101, 0, 37, "Subsubsection",ExpressionUUID->"833ab911-f50a-4143-b31c-c93edc3c7b9d"],
Cell[123934, 3143, 4182, 110, 292, "Input",ExpressionUUID->"d617e34a-f211-4dbd-a349-cef8b2f383d1"],
Cell[128119, 3255, 502, 12, 83, "Input",ExpressionUUID->"4aded511-0862-473a-ab11-4c5a4c1fca19"],
Cell[128624, 3269, 286, 6, 44, "Input",ExpressionUUID->"b6119ebb-4c68-4f4d-8dcd-1259cc5c107e"],
Cell[128913, 3277, 443, 11, 64, "Input",ExpressionUUID->"5e37eb47-947a-4787-ba7d-1c3cf183277d"],
Cell[129359, 3290, 958, 26, 140, "Input",ExpressionUUID->"6fa8f4dd-195f-43af-9cd7-cf15cc601e30"],
Cell[130320, 3318, 1826, 55, 217, "Input",ExpressionUUID->"81fea334-871d-497d-8428-240c21f4f0e3"],
Cell[132149, 3375, 5139, 143, 465, "Input",ExpressionUUID->"879e76ad-9fbf-4bfc-904e-a5f9372e7c02"],
Cell[137291, 3520, 377, 9, 44, "Input",ExpressionUUID->"90613110-976a-4282-8f6a-4556c4f969a2"],
Cell[137671, 3531, 1119, 27, 102, "Input",ExpressionUUID->"e9c42455-3a98-42ca-9417-7ec39139d878"],
Cell[138793, 3560, 4074, 115, 335, "Input",ExpressionUUID->"08e68066-a6da-4e37-9d0a-fea34f0b022c"],
Cell[142870, 3677, 952, 25, 83, "Input",ExpressionUUID->"bcf93a95-ea9e-423b-9dd9-331f7cc6a235"],
Cell[143825, 3704, 5041, 136, 366, "Input",ExpressionUUID->"330e259a-f412-41f8-91c6-795b22cc826b"],
Cell[148869, 3842, 3575, 98, 179, "Input",ExpressionUUID->"384d21e4-6362-4d68-9c30-cb879f1d943f"]
}, Closed]],
Cell[CellGroupData[{
Cell[152481, 3945, 108, 0, 37, "Subsubsection",ExpressionUUID->"6c3afbbc-44f9-4575-83e4-96989598816e"],
Cell[152592, 3947, 395, 9, 50, "Code",ExpressionUUID->"94659f00-2dd0-4087-8002-0d60ee8c55af"],
Cell[152990, 3958, 519, 12, 68, "Code",ExpressionUUID->"f0fc9216-4e8f-4e0f-b877-e12350da02d4"],
Cell[153512, 3972, 1036, 29, 68, "Code",ExpressionUUID->"405917ca-9fad-4453-a1ef-d6f5d7de1a69"]
}, Closed]],
Cell[CellGroupData[{
Cell[154585, 4006, 114, 0, 37, "Subsubsection",ExpressionUUID->"0d655b6b-cb3d-4d1f-bd30-78f4516cee18"],
Cell[154702, 4008, 350, 9, 50, "Code",ExpressionUUID->"c1c6cef6-3141-4fc8-b683-873d069d84c6"],
Cell[155055, 4019, 485, 13, 68, "Code",ExpressionUUID->"8ac0b758-162e-4c3c-9bde-9e1dce923f6c"],
Cell[155543, 4034, 531, 12, 68, "Code",ExpressionUUID->"7c2dfb7e-ed1b-4889-838c-5abff0c4c826"],
Cell[156077, 4048, 1048, 29, 68, "Code",ExpressionUUID->"362899c5-e89e-4b62-93aa-ad941e610cb8"],
Cell[157128, 4079, 427, 11, 68, "Code",ExpressionUUID->"535f336b-d79a-47c8-800f-784f4198b557"],
Cell[157558, 4092, 8162, 216, 471, "Code",ExpressionUUID->"ef098b91-b16b-4bd1-b460-c85857c3647c"],
Cell[165723, 4310, 865, 18, 83, "Input",ExpressionUUID->"e9cfd54d-8bf0-4847-b440-5757a4c31119"],
Cell[166591, 4330, 651, 13, 83, "Input",ExpressionUUID->"19bbd7e4-3ce0-4090-b15c-d20c891ba960"]
}, Closed]],
Cell[CellGroupData[{
Cell[167279, 4348, 83, 0, 37, "Subsubsection",ExpressionUUID->"01705c34-4d66-4819-8009-5a81088e3fc0"],
Cell[167365, 4350, 1869, 48, 313, "Code",ExpressionUUID->"8b48a083-3437-44a3-8c1b-0b181733688a"],
Cell[169237, 4400, 232, 5, 50, "Code",ExpressionUUID->"4dd590c3-c7f9-4183-b0f8-783b3bd0d32b"],
Cell[169472, 4407, 217, 5, 50, "Code",ExpressionUUID->"2855e9e2-88b1-41a4-8cdd-7026353d3440"],
Cell[169692, 4414, 9615, 224, 940, "Input",ExpressionUUID->"65addf99-5e27-4dce-b07e-aea365b8f9e5"],
Cell[179310, 4640, 184, 4, 50, "Code",ExpressionUUID->"fa2abef7-6a17-4267-bd7b-c4f5b675e248"],
Cell[179497, 4646, 1120, 32, 50, "Code",ExpressionUUID->"7a309d8e-765b-4378-adf3-c9d702d6dbde"],
Cell[180620, 4680, 1262, 39, 50, "Code",ExpressionUUID->"56c36983-d025-4646-9c82-82572ebeb012"],
Cell[181885, 4721, 7748, 207, 384, "Code",ExpressionUUID->"9d91f019-8811-4303-9fda-8c62acbdad89"],
Cell[189636, 4930, 9033, 242, 471, "Code",ExpressionUUID->"678dd477-a1ce-4661-a2a0-d5269b570c26"]
}, Closed]],
Cell[CellGroupData[{
Cell[198706, 5177, 100, 0, 37, "Subsubsection",ExpressionUUID->"786470b7-b211-48cf-84f4-7cae729a3903"],
Cell[198809, 5179, 523, 15, 44, "Input",ExpressionUUID->"1922385f-9c93-4409-b228-1ef1a1a240c7"],
Cell[199335, 5196, 3975, 89, 387, "Input",ExpressionUUID->"9631ae43-ccd5-44c3-bebc-cdc51383f735"],
Cell[203313, 5287, 4656, 104, 463, "Input",ExpressionUUID->"a2364b3e-e193-46cd-86f2-7dfdd14c7b39"],
Cell[207972, 5393, 295, 8, 68, "Code",ExpressionUUID->"1a4ead41-d37b-4e6d-a6ca-9406da32ee9d"],
Cell[208270, 5403, 300, 7, 50, "Code",ExpressionUUID->"331dc274-c359-40e1-9c16-ae62d8f8001a"]
}, Closed]],
Cell[CellGroupData[{
Cell[208607, 5415, 115, 0, 37, "Subsubsection",ExpressionUUID->"5be665fc-33dd-42aa-9435-ab09e2e4442b"],
Cell[208725, 5417, 8026, 195, 597, "Input",ExpressionUUID->"c0466ca5-e107-42d5-a618-d859a4cec108"]
}, Closed]],
Cell[CellGroupData[{
Cell[216788, 5617, 97, 0, 37, "Subsubsection",ExpressionUUID->"20bbccc3-26c4-409c-b5f4-b99b941ca4a1"],
Cell[216888, 5619, 373, 6, 57, "Text",ExpressionUUID->"52672ceb-e179-472a-9794-bebed40930d8"],
Cell[217264, 5627, 1641, 47, 57, "Code",ExpressionUUID->"fdfaeb12-105f-4de0-aaf1-8896e875c545"]
}, Closed]],
Cell[CellGroupData[{
Cell[218942, 5679, 138, 3, 37, "Subsubsection",ExpressionUUID->"3b5bd711-c32f-4857-a443-8ebfd037a155"],
Cell[219083, 5684, 3786, 94, 401, "Code",ExpressionUUID->"53256f91-6bf9-41b7-a9dd-603c375d797b"],
Cell[222872, 5780, 11112, 319, 631, "Code",ExpressionUUID->"a02bb63f-aa44-4028-b375-a3a4b7401fd0"]
}, Closed]],
Cell[CellGroupData[{
Cell[234021, 6104, 103, 0, 37, "Subsubsection",ExpressionUUID->"cc40fb79-e6ef-4d3d-b2e2-e4215483eabf"],
Cell[234127, 6106, 652, 18, 57, "Code",ExpressionUUID->"64c0f068-1db9-41b0-8bbf-ae1f692743eb"],
Cell[234782, 6126, 545, 15, 57, "Code",ExpressionUUID->"d2d65750-398c-412b-8e2e-1dd12a6ccaa9"]
}, Closed]],
Cell[CellGroupData[{
Cell[235364, 6146, 181, 3, 37, "Subsubsection",ExpressionUUID->"dfd9f3c9-ef33-4010-8060-cbb825c0288c"],
Cell[235548, 6151, 1669, 43, 236, "Input",ExpressionUUID->"ba171a15-4093-4d88-a828-e375e854ad82"],
Cell[237220, 6196, 1078, 28, 160, "Input",ExpressionUUID->"38ad409e-e6b7-47a9-8ced-d1055e94351d"],
Cell[238301, 6226, 1417, 39, 140, "Input",ExpressionUUID->"b3e30207-a1a0-410c-8f02-e6bda300a9b8"],
Cell[239721, 6267, 1688, 44, 159, "Input",ExpressionUUID->"3a1d042a-1bde-4521-a2fa-4ce57eb76415"],
Cell[241412, 6313, 1506, 43, 178, "Input",ExpressionUUID->"e59d199e-0728-4f94-ab2c-350ae66de1cc"],
Cell[242921, 6358, 1171, 33, 140, "Input",ExpressionUUID->"eea74870-afdd-4261-83a4-39b6ee89f119"],
Cell[244095, 6393, 261, 6, 50, "Code",ExpressionUUID->"255e70d1-285a-4767-bac0-b5dbe351309e"],
Cell[244359, 6401, 361, 10, 50, "Code",ExpressionUUID->"c205e4b3-b633-4fc4-8712-37faccbdd5f3"],
Cell[244723, 6413, 545, 13, 103, "Code",ExpressionUUID->"9285795e-0686-49e1-9bab-f8b615a32693"]
}, Closed]],
Cell[CellGroupData[{
Cell[245305, 6431, 102, 0, 37, "Subsubsection",ExpressionUUID->"a33f7e8c-ecaa-4bca-b9a3-c92051c7d2ca"],
Cell[245410, 6433, 2474, 75, 102, "Input",ExpressionUUID->"6d49cd1a-8636-486b-ba84-5baf6433cd53"],
Cell[247887, 6510, 1046, 24, 64, "Input",ExpressionUUID->"7c1828bc-8e94-4f83-a4e3-18cf51eb215e"],
Cell[248936, 6536, 4360, 114, 294, "Input",ExpressionUUID->"2fcf7ccc-573e-4297-bd06-759753fca825"],
Cell[253299, 6652, 2093, 58, 198, "Input",ExpressionUUID->"dd69b5ab-dafc-44b4-9d90-08485fa057bb"],
Cell[255395, 6712, 4204, 112, 294, "Input",ExpressionUUID->"f83d90c6-73cb-49ef-9dab-f93c4e2687cf"],
Cell[259602, 6826, 2008, 57, 179, "Input",ExpressionUUID->"49d3c036-891d-43c0-bfa0-b28a67a62200"],
Cell[261613, 6885, 4196, 117, 199, "Input",ExpressionUUID->"31ea8635-6265-4a93-9972-ae5418307d65"],
Cell[265812, 7004, 1792, 54, 160, "Input",ExpressionUUID->"7ae271ee-13f5-47bf-90c4-f976f022a296"],
Cell[267607, 7060, 2876, 84, 218, "Input",ExpressionUUID->"83b905ba-addc-4d23-a62a-5be777d31f88"],
Cell[270486, 7146, 8395, 199, 522, "Input",ExpressionUUID->"0375373b-2b00-49d4-bbe5-ed2cac089932"],
Cell[278884, 7347, 1485, 43, 122, "Input",ExpressionUUID->"1124f70d-efd0-4695-be9c-522a08757d7c"],
Cell[280372, 7392, 7197, 195, 467, "Input",ExpressionUUID->"ed37c1e1-23c1-4a2e-a5b1-dffb863cbc13"],
Cell[287572, 7589, 1022, 28, 83, "Input",ExpressionUUID->"d7d25d64-cbee-4488-a71f-ce0057af91e8"],
Cell[288597, 7619, 3264, 84, 274, "Input",ExpressionUUID->"a740eb6d-b2ae-4a15-82d5-ea0ce333ca52"],
Cell[291864, 7705, 7938, 209, 524, "Input",ExpressionUUID->"a688e9aa-b637-45a3-b4a9-04e259cfe99a"],
Cell[299805, 7916, 13688, 367, 884, "Input",ExpressionUUID->"9484be41-06ba-4e8e-9581-47bd869040c0"]
}, Closed]],
Cell[CellGroupData[{
Cell[313530, 8288, 504, 7, 37, "Subsubsection",ExpressionUUID->"50445282-856f-451f-a2bf-dc5f9e0d90b3"],
Cell[314037, 8297, 2174, 55, 128, "Input",ExpressionUUID->"e5aae152-ba0c-401b-9439-364de2d6935e"],
Cell[316214, 8354, 1160, 32, 128, "Input",ExpressionUUID->"38233775-3347-4ec3-9a3d-f70fda13d5da"],
Cell[317377, 8388, 1995, 47, 159, "Input",ExpressionUUID->"aacec986-0e69-4f24-ba78-4eca118885cc"],
Cell[319375, 8437, 3521, 88, 159, "Input",ExpressionUUID->"a3ac5a1c-df30-4d73-8a5f-04e7c6de2373"],
Cell[322899, 8527, 10351, 241, 597, "Input",ExpressionUUID->"862a85b7-fdce-442a-ab57-8050479a9229"]
}, Closed]],
Cell[CellGroupData[{
Cell[333287, 8773, 99, 0, 37, "Subsubsection",ExpressionUUID->"a103a181-6394-4b7f-9c94-486f72a15755"],
Cell[333389, 8775, 2874, 74, 273, "Input",ExpressionUUID->"7a89ccf8-3900-4656-a4b5-bdb1e91a7d4d"],
Cell[336266, 8851, 275, 6, 45, "Input",ExpressionUUID->"1c61d8df-9986-41c0-9a29-fc798174944a"],
Cell[336544, 8859, 3002, 77, 273, "Input",ExpressionUUID->"ec4b012c-71ed-48b0-95c4-8d4e4ffba1dd"],
Cell[339549, 8938, 352, 8, 45, "Input",ExpressionUUID->"02dfdf07-bb3e-47e6-8f6b-66107cdd994f"]
}, Closed]],
Cell[CellGroupData[{
Cell[339938, 8951, 83, 0, 37, "Subsubsection",ExpressionUUID->"cccf334b-db88-4a4b-8cc2-f82e353465ac"],
Cell[340024, 8953, 490, 14, 44, "Input",ExpressionUUID->"a0e1f2c7-1121-4822-8831-21de1f3396c8"],
Cell[340517, 8969, 775, 24, 44, "Input",ExpressionUUID->"d39ca530-afb0-4deb-9f7e-5163fdfc21a5"],
Cell[341295, 8995, 5543, 138, 520, "Input",ExpressionUUID->"cacad20e-d68d-400b-8179-1f595c491965"],
Cell[346841, 9135, 567, 15, 44, "Input",ExpressionUUID->"6f24a41b-3942-403e-ab3d-5975ffdddb80"],
Cell[347411, 9152, 15595, 389, 1491, "Input",ExpressionUUID->"e610a7a9-c345-421b-abf1-8942f797ae83"],
Cell[363009, 9543, 27038, 715, 2309, "Input",ExpressionUUID->"066bc509-88f8-409a-a289-982b26641e86"],
Cell[390050, 10260, 15566, 378, 1453, "Input",ExpressionUUID->"86dca3ab-e2d9-4d4a-b9a0-fb1a7dbc97c7"],
Cell[405619, 10640, 3942, 122, 264, "Input",ExpressionUUID->"25b08610-fbb7-41a4-9bf9-3d45ec80f91a"],
Cell[409564, 10764, 1086, 28, 68, "Code",ExpressionUUID->"7c7e7da4-98de-4239-87dc-9c99b9d23422"]
}, Open  ]],
Cell[CellGroupData[{
Cell[410687, 10797, 158, 3, 45, "Subsubsection",ExpressionUUID->"3530d1b6-48b1-4877-9d8c-8f08fc67858a"],
Cell[410848, 10802, 4303, 109, 559, "Input",ExpressionUUID->"899cd1f8-ef89-4a93-bd22-5f2dab6efea6"],
Cell[415154, 10913, 4888, 129, 484, "Input",ExpressionUUID->"9f54689f-0a49-4ccd-9265-b9b90537c1fd"],
Cell[420045, 11044, 204, 5, 43, "Input",ExpressionUUID->"cde10978-f8ef-470b-b369-bd171a5aa611"]
}, Closed]],
Cell[CellGroupData[{
Cell[420286, 11054, 169, 3, 37, "Subsubsection",ExpressionUUID->"598ddec6-ef22-46aa-b459-cd2900c016b4"],
Cell[420458, 11059, 1143, 31, 120, "Code",ExpressionUUID->"2a092ad0-760f-4d24-ad69-56d0abc6ea90"],
Cell[421604, 11092, 3862, 97, 295, "Code",ExpressionUUID->"4fcc71aa-e2bf-4890-9405-ec9fc89ab40d"],
Cell[425469, 11191, 4842, 130, 260, "Code",ExpressionUUID->"0202f3c5-8029-4267-9f57-13c3ea038df1"]
}, Closed]],
Cell[CellGroupData[{
Cell[430348, 11326, 106, 0, 37, "Subsubsection",ExpressionUUID->"f25a2094-2c0e-4920-b686-67b0800d63cd"],
Cell[430457, 11328, 1973, 53, 178, "Input",ExpressionUUID->"b80c42b3-2a99-4116-9658-54fc610ee0b9"]
}, Closed]],
Cell[CellGroupData[{
Cell[432467, 11386, 99, 0, 37, "Subsubsection",ExpressionUUID->"c9d78b76-f4a7-48da-9fa6-10af450da720"],
Cell[432569, 11388, 357, 6, 80, "Text",ExpressionUUID->"c4fd7b84-423c-4bea-9610-2e93363c83ab"],
Cell[432929, 11396, 4398, 122, 313, "Code",ExpressionUUID->"5b8b54f2-ad05-42e7-89c9-070abf96f92a"],
Cell[437330, 11520, 4489, 123, 401, "Code",ExpressionUUID->"f0f12ea8-0af2-425a-942c-c3fdd6a580a4"],
Cell[441822, 11645, 380, 6, 126, "Text",ExpressionUUID->"90eef429-b4db-4424-87f5-5b0f7e5d44ff"],
Cell[442205, 11653, 488, 11, 126, "Text",ExpressionUUID->"ecd360d5-c7da-4b1b-a016-c8a9434ce45b"],
Cell[442696, 11666, 7189, 192, 471, "Code",ExpressionUUID->"c583f88f-059a-4595-a2f0-07425bacad1f"],
Cell[449888, 11860, 912, 16, 241, "Text",ExpressionUUID->"51dc4c4b-4119-406a-b806-9f44162efb4a"],
Cell[450803, 11878, 7083, 182, 437, "Code",ExpressionUUID->"43df7618-5086-4aef-88bb-84f641dc85db"],
Cell[457889, 12062, 278, 4, 57, "Text",ExpressionUUID->"995c3a32-8fb7-4c33-9a24-45d8fa060ec6"],
Cell[458170, 12068, 1677, 46, 103, "Code",ExpressionUUID->"18468321-90a4-4a5e-9c0e-eb8879e8baeb"],
Cell[459850, 12116, 1339, 34, 103, "Code",ExpressionUUID->"06736f6c-968d-476d-a1f0-d00d41e02848"],
Cell[461192, 12152, 9894, 247, 825, "Input",ExpressionUUID->"bcc4ea39-0a38-4c48-9e27-9e73e589c5c4"],
Cell[471089, 12401, 160, 3, 34, "Text",ExpressionUUID->"79b3110e-f9e1-464d-ab04-fd48d18e8191"],
Cell[471252, 12406, 3920, 99, 120, "Code",ExpressionUUID->"66489b1d-eadb-455e-aac6-9c6b7d2964e7"],
Cell[475175, 12507, 3169, 83, 103, "Code",ExpressionUUID->"b2f1f802-17f2-46e0-9a71-95378b7c626b"]
}, Closed]],
Cell[CellGroupData[{
Cell[478381, 12595, 85, 0, 37, "Subsubsection",ExpressionUUID->"54a36465-1c8a-4d6e-a02f-11449ca184d0"],
Cell[478469, 12597, 2843, 74, 226, "Code",ExpressionUUID->"1602d177-bdf1-45b3-88dd-3a6c39a24759"],
Cell[481315, 12673, 1432, 46, 103, "Code",ExpressionUUID->"b4e15537-67e7-437d-bee9-1a64f5d9740a"],
Cell[482750, 12721, 1666, 50, 86, "Code",ExpressionUUID->"2d664a9e-e1da-49da-97c2-33cae3bb5f81"]
}, Open  ]],
Cell[CellGroupData[{
Cell[484453, 12776, 90, 0, 45, "Subsubsection",ExpressionUUID->"f7c3aa43-612f-4bb4-9f71-3157856a3e0f"],
Cell[484546, 12778, 235, 6, 50, "Code",ExpressionUUID->"77d2befc-7edb-4cd2-97d1-185e80c45ed5"],
Cell[484784, 12786, 10796, 270, 402, "Code",ExpressionUUID->"1e0da07f-f19c-4ada-91a9-1aba3e52b7b9"],
Cell[495583, 13058, 6854, 178, 349, "Input",ExpressionUUID->"1497e937-83a7-493d-85ef-5d949135f032"],
Cell[502440, 13238, 3974, 115, 138, "Code",ExpressionUUID->"c143438d-f5ed-4b84-9a3d-a110897f8ecc"],
Cell[506417, 13355, 1314, 31, 138, "Code",ExpressionUUID->"61a3aa7b-79cb-4aa1-9886-16d56696bcd3"],
Cell[507734, 13388, 5551, 145, 279, "Code",ExpressionUUID->"e0925ef3-8ea0-4fee-be89-e0d8f80591e2"],
Cell[513288, 13535, 10390, 281, 367, "Code",ExpressionUUID->"694aed78-46ce-4a8c-807a-556fd040f739"],
Cell[523681, 13818, 1050, 31, 103, "Code",ExpressionUUID->"292ddab8-0f13-4598-873e-7f2c09cbfe78"],
Cell[524734, 13851, 4416, 122, 226, "Code",ExpressionUUID->"ac17c663-b89f-4287-8f1e-0d90077dd0f9"],
Cell[529153, 13975, 8828, 234, 384, "Code",ExpressionUUID->"82126477-b200-4ef1-a926-6f1cd061edd8"],
Cell[537984, 14211, 11916, 312, 472, "Code",ExpressionUUID->"e8f62cdf-a044-47f8-b640-10873a059eb4"]
}, Closed]],
Cell[CellGroupData[{
Cell[549937, 14528, 215, 4, 37, "Subsubsection",ExpressionUUID->"f2897549-3e12-424e-86fd-2e0dd6818d40"],
Cell[550155, 14534, 663, 15, 82, "Input",ExpressionUUID->"f0dab527-3c4d-4d1c-81ed-444a60e1ff9e"],
Cell[550821, 14551, 2382, 60, 256, "Input",ExpressionUUID->"d80f79f0-7400-4fa2-ae38-40195ce3ae78"],
Cell[553206, 14613, 429, 11, 45, "Input",ExpressionUUID->"9c8bacef-3459-414c-b494-391d3ceaf448"],
Cell[553638, 14626, 25344, 679, 2150, "Input",ExpressionUUID->"948d21bc-b551-4953-a22e-c4780d511627"]
}, Closed]],
Cell[CellGroupData[{
Cell[579019, 15310, 165, 3, 37, "Subsubsection",ExpressionUUID->"7a2d703a-a65e-417d-8e26-18d5c654466f"],
Cell[579187, 15315, 2241, 66, 159, "Input",ExpressionUUID->"61e8fc86-cd5e-48c8-a8d3-75f9d4d3ab4d"],
Cell[581431, 15383, 5855, 149, 520, "Input",ExpressionUUID->"9a571947-bd18-49ac-812c-b0254154b553"]
}, Open  ]],
Cell[CellGroupData[{
Cell[587323, 15537, 163, 3, 45, "Subsubsection",ExpressionUUID->"bd6cf92e-acb7-47e8-a693-af03de4daaf5"],
Cell[587489, 15542, 10062, 282, 788, "Input",ExpressionUUID->"396af31a-a006-41b0-8deb-c522a99070d9"],
Cell[597554, 15826, 518, 14, 64, "Input",ExpressionUUID->"08551f0a-8f76-4f9a-901b-68603f498510"],
Cell[598075, 15842, 3651, 96, 368, "Input",ExpressionUUID->"1d25ade8-747a-493b-b830-7acdf1efb927"],
Cell[601729, 15940, 1792, 47, 261, "Code",ExpressionUUID->"7b5d2610-6780-4287-a1b8-762eec13487a"],
Cell[603524, 15989, 3354, 92, 332, "Code",ExpressionUUID->"fbed1ddc-9103-4ba3-8b1c-67b833b1f3cb"],
Cell[606881, 16083, 4044, 125, 226, "Code",ExpressionUUID->"c8b54af8-14b9-4bf4-bae8-e94d039bcbe2"],
Cell[610928, 16210, 1601, 47, 68, "Code",ExpressionUUID->"6c4d416f-4f1e-42ed-bb2e-f92419bc5862"],
Cell[612532, 16259, 81, 0, 44, "Input",ExpressionUUID->"cea870cb-9b76-4279-9b2b-ef4baf2ff53a"],
Cell[612616, 16261, 1222, 36, 83, "Input",ExpressionUUID->"da8352fd-6027-46d8-9662-054a4d368a14",
 InitializationCell->True],
Cell[613841, 16299, 943, 27, 64, "Input",ExpressionUUID->"49853eb2-e62f-48ca-b328-15203172dbde",
 InitializationCell->True],
Cell[614787, 16328, 1641, 51, 216, "Input",ExpressionUUID->"b2f8255b-f5cf-4acf-adb8-cfd5b372eea2",
 InitializationCell->True],
Cell[616431, 16381, 4715, 132, 507, "Code",ExpressionUUID->"ecc43d5a-8dc0-4bf6-be9b-861f286f4365"]
}, Open  ]],
Cell[CellGroupData[{
Cell[621183, 16518, 173, 3, 45, "Subsubsection",ExpressionUUID->"9393f1e2-ef74-4638-b681-91f23d820156"],
Cell[621359, 16523, 1331, 30, 178, "Input",ExpressionUUID->"8d0f6a08-c92c-42a4-b85c-d657bd0d4aad"],
Cell[622693, 16555, 2937, 63, 235, "Input",ExpressionUUID->"310afc62-c6a5-475b-af7a-9b0e89e9109f"],
Cell[625633, 16620, 2488, 58, 216, "Input",ExpressionUUID->"49226366-0c32-4424-b424-f6342a00513e"],
Cell[628124, 16680, 2239, 55, 292, "Input",ExpressionUUID->"3d5f3dae-36b1-4ca9-805f-c31fcda8297e"],
Cell[630366, 16737, 283, 5, 44, "Input",ExpressionUUID->"06810b55-8f53-462d-9225-e14333597be7"],
Cell[630652, 16744, 8032, 180, 597, "Input",ExpressionUUID->"dd349617-9be1-4e38-ab2b-2d4175e866c2"],
Cell[638687, 16926, 4602, 121, 387, "Input",ExpressionUUID->"ecd71fcf-840f-4d25-b73b-11c2d9a98064"],
Cell[643292, 17049, 383, 6, 44, "Input",ExpressionUUID->"bf2e467c-a506-4058-98ea-2f225a7b3a3a"],
Cell[643678, 17057, 9012, 181, 635, "Input",ExpressionUUID->"5a37ddc1-3e1a-4b1a-a8b4-83750398d014"],
Cell[652693, 17240, 1031, 24, 178, "Input",ExpressionUUID->"b3957040-b8ab-4356-80a9-5f0affe6b105"],
Cell[653727, 17266, 491, 11, 64, "Input",ExpressionUUID->"2300abb0-5b86-43b7-9705-e1713c944e4a"],
Cell[654221, 17279, 1537, 42, 159, "Input",ExpressionUUID->"91b8ef68-ee25-4041-be8d-633e29a497a7"],
Cell[655761, 17323, 6768, 137, 635, "Input",ExpressionUUID->"04f8c69e-5b99-4920-8bec-2c9d2aebd2f6"],
Cell[662532, 17462, 6985, 140, 635, "Input",ExpressionUUID->"24e6c68e-a39e-4b19-8edb-46aa3569d323"],
Cell[669520, 17604, 8526, 164, 539, "Input",ExpressionUUID->"f630026c-17c6-4da3-ba94-492c4961b0c4"],
Cell[678049, 17770, 8927, 189, 597, "Input",ExpressionUUID->"be00b588-c46c-4ba7-8dc0-a91e5bf2ed0a"],
Cell[686979, 17961, 4823, 82, 159, "Input",ExpressionUUID->"66d19c29-be8c-40bf-ad38-f1348ac79128"],
Cell[691805, 18045, 5130, 90, 140, "Input",ExpressionUUID->"15ab92db-012c-4fe8-92af-745ff56f93e6"],
Cell[696938, 18137, 1246, 25, 121, "Input",ExpressionUUID->"f4b16581-1ff5-403e-a706-cb92e0f04d09"],
Cell[698187, 18164, 1944, 53, 196, "Input",ExpressionUUID->"6b3cb7f1-fa51-4be2-8c3f-55237328a214"],
Cell[700134, 18219, 4658, 77, 140, "Input",ExpressionUUID->"622963b4-bbf7-4930-b104-aa0583f7dc77"],
Cell[704795, 18298, 1558, 43, 159, "Input",ExpressionUUID->"321b8d9d-d90c-418a-a0c0-1853667d683e"],
Cell[706356, 18343, 1462, 32, 140, "Input",ExpressionUUID->"5aa08b61-a629-4e5c-a922-069b5b458cb1"],
Cell[707821, 18377, 1909, 54, 196, "Input",ExpressionUUID->"03517174-e0df-40cc-880a-ef303981fd1d"],
Cell[709733, 18433, 3662, 90, 311, "Input",ExpressionUUID->"7d3550a0-d019-4e91-aefb-5503c1a9da06"],
Cell[713398, 18525, 675, 17, 64, "Input",ExpressionUUID->"326cef38-712b-4a36-bc0c-647e1fd2ef4f"],
Cell[714076, 18544, 688, 18, 64, "Input",ExpressionUUID->"3a3f9be2-014c-46ed-8541-908f5759d482"],
Cell[714767, 18564, 3714, 85, 482, "Input",ExpressionUUID->"4ce49241-0be5-47de-a878-379d9c35f5c3"],
Cell[718484, 18651, 5399, 130, 349, "Input",ExpressionUUID->"7fad413a-63af-4928-86ed-4dca3c936d1d"]
}, Open  ]],
Cell[CellGroupData[{
Cell[723920, 18786, 286, 4, 45, "Subsubsection",ExpressionUUID->"c9c89ad6-1272-4bcf-98a6-59fbf2b56d6f"],
Cell[724209, 18792, 3672, 99, 216, "Input",ExpressionUUID->"e77519d7-f141-4b37-80f4-262750ebe9b8"],
Cell[727884, 18893, 3524, 91, 235, "Input",ExpressionUUID->"7cdd49cc-5239-4a32-ad87-8883e1d3c665"]
}, Open  ]],
Cell[CellGroupData[{
Cell[731445, 18989, 212, 4, 45, "Subsubsection",ExpressionUUID->"33e5c9e7-599f-4a71-9d70-8d20f6789b23"],
Cell[731660, 18995, 928, 21, 64, "Input",ExpressionUUID->"c0c40f22-e466-4e22-9e8d-73570eefd73a"],
Cell[732591, 19018, 966, 21, 83, "Input",ExpressionUUID->"ec263ad9-9a1e-4b32-a1bd-a55ea4b66e20"],
Cell[733560, 19041, 2798, 75, 216, "Input",ExpressionUUID->"5e0753d3-7fd1-4b83-9381-0e55ad217dd6"]
}, Open  ]],
Cell[CellGroupData[{
Cell[736395, 19121, 220, 4, 45, "Subsubsection",ExpressionUUID->"5e74dc89-df49-4d9a-acaa-4fd9ba7b7cd0"],
Cell[736618, 19127, 1323, 26, 159, "Input",ExpressionUUID->"34253a5b-f82c-405e-9408-a09ff95b6c75"],
Cell[737944, 19155, 2522, 53, 216, "Input",ExpressionUUID->"eeefcda5-7c6f-4975-aa81-b5b39d4363d3"],
Cell[740469, 19210, 2463, 56, 216, "Input",ExpressionUUID->"2281c2bb-016c-4b9b-ba16-85a0f8f0ebe1"],
Cell[742935, 19268, 8457, 177, 578, "Input",ExpressionUUID->"1ffb495c-e5ec-4b74-a4b4-4867651c246b"],
Cell[751395, 19447, 4661, 123, 388, "Input",ExpressionUUID->"a81d6626-1de7-4c63-9ab6-91ab3722332a"],
Cell[756059, 19572, 9750, 201, 711, "Input",ExpressionUUID->"496ef6b6-0d5a-42b1-b828-c5b192bba341"],
Cell[765812, 19775, 1841, 48, 180, "Input",ExpressionUUID->"1d1d8613-8d17-4ce1-8703-3016d587824d"],
Cell[767656, 19825, 6928, 139, 635, "Input",ExpressionUUID->"a10bcaad-3358-4cef-bd8c-771baa8ce987"],
Cell[774587, 19966, 7510, 154, 711, "Input",ExpressionUUID->"3c26bd06-56ae-4fcf-82d6-7d39c58d6b29"],
Cell[782100, 20122, 3004, 72, 236, "Input",ExpressionUUID->"c8311786-1064-42ce-98c2-5389d7ad8a0f"]
}, Closed]],
Cell[CellGroupData[{
Cell[785141, 20199, 219, 4, 37, "Subsubsection",ExpressionUUID->"dc5b1a7a-1fe7-44af-b1d8-d8e0d950091d"],
Cell[785363, 20205, 1278, 25, 140, "Input",ExpressionUUID->"3ad75544-6460-4d95-ba23-59eae3084a87"],
Cell[786644, 20232, 2324, 45, 197, "Input",ExpressionUUID->"4d3b239b-1afb-4163-b43d-319453f3ccdb"],
Cell[788971, 20279, 3757, 76, 273, "Input",ExpressionUUID->"7adaeb42-f6d0-44a2-9dba-ce9fd5bd26ea"],
Cell[792731, 20357, 3043, 86, 273, "Input",ExpressionUUID->"b4ce0d3c-1678-4d7d-9954-23bdd0e81373"],
Cell[795777, 20445, 6598, 134, 427, "Input",ExpressionUUID->"eabb5d96-2bb9-4ec5-9ddb-51fd2b8f60f8"],
Cell[802378, 20581, 277, 6, 43, "Input",ExpressionUUID->"48f009f8-0c1d-4101-b5b9-3867a738da96"],
Cell[802658, 20589, 1797, 45, 199, "Input",ExpressionUUID->"01361fce-dbf4-42c8-b9f5-ddb13d849dd9"],
Cell[804458, 20636, 5291, 105, 388, "Input",ExpressionUUID->"44feaaa9-9293-4507-97ac-ffdebacbf6b5"],
Cell[809752, 20743, 5632, 111, 426, "Input",ExpressionUUID->"bf5f9e68-c6a1-49ea-b019-aedc563e6c43"]
}, Closed]],
Cell[CellGroupData[{
Cell[815421, 20859, 199, 3, 37, "Subsubsection",ExpressionUUID->"db77c6e0-548a-4ce1-bb60-2c60b5792fbd"],
Cell[815623, 20864, 1184, 26, 159, "Input",ExpressionUUID->"799a38b9-28c8-4697-aab1-b4755fa4797b"],
Cell[816810, 20892, 303, 6, 44, "Input",ExpressionUUID->"7b32d1f4-61be-476b-aec1-fc11d8cae5b9"],
Cell[817116, 20900, 3096, 63, 254, "Input",ExpressionUUID->"23079244-b275-4bdd-bc03-5d307f381b4c"],
Cell[820215, 20965, 2396, 55, 216, "Input",ExpressionUUID->"c62d6e44-e42c-4bb9-ac8c-54fabd1d8f3b"],
Cell[822614, 21022, 283, 5, 44, "Input",ExpressionUUID->"7e8bb271-56aa-4389-aa3f-b862bf103ea0"],
Cell[822900, 21029, 6115, 141, 406, "Input",ExpressionUUID->"4cd4df46-706c-46c6-9c95-7d1e2a87e5ec"],
Cell[829018, 21172, 4913, 127, 387, "Input",ExpressionUUID->"6cf11a7d-22bb-448c-9e5d-9b40b43e76de"],
Cell[833934, 21301, 383, 6, 44, "Input",ExpressionUUID->"63f3bbbc-a976-429d-a377-bd20fd3656d5"],
Cell[834320, 21309, 9786, 208, 673, "Input",ExpressionUUID->"b18ff2f6-c23e-4280-827e-d588276af4a6"],
Cell[844109, 21519, 1998, 53, 178, "Input",ExpressionUUID->"3e361d83-b552-409d-b079-3336b014c232"],
Cell[846110, 21574, 6924, 140, 635, "Input",ExpressionUUID->"93430b58-1c9d-4624-b6f4-ea996d9c4496"]
}, Open  ]],
Cell[CellGroupData[{
Cell[853071, 21719, 101, 0, 45, "Subsubsection",ExpressionUUID->"c576b0e9-eb9e-4477-961e-2b4ccf10ea02"],
Cell[853175, 21721, 3495, 73, 349, "Input",ExpressionUUID->"764a1b51-4c4b-495b-ac58-30ceeeda9f60"],
Cell[856673, 21796, 1130, 24, 102, "Input",ExpressionUUID->"665b2f3e-8fdc-480d-89a5-0c87ac22486c"],
Cell[857806, 21822, 1210, 25, 121, "Input",ExpressionUUID->"e27c3c33-c7a1-43b3-8a1e-26dd97bac80b"],
Cell[859019, 21849, 468, 12, 64, "Input",ExpressionUUID->"a857cb07-ff7b-4014-8772-e5a4419142d0"],
Cell[859490, 21863, 552, 15, 64, "Input",ExpressionUUID->"aa623f78-a90d-4610-b3d4-508f20dbea06"],
Cell[860045, 21880, 2287, 56, 216, "Input",ExpressionUUID->"3667f74d-3b78-4270-98e1-ecae41725671"],
Cell[862335, 21938, 6587, 174, 577, "Input",ExpressionUUID->"9c55edec-7bef-49df-b02d-96c1a4cbb096"],
Cell[868925, 22114, 1326, 36, 140, "Input",ExpressionUUID->"4128ab50-2e91-4143-81b8-1b52854a5c95"],
Cell[870254, 22152, 10316, 268, 1015, "Input",ExpressionUUID->"9bc7558b-e43f-40ce-94e8-e04e60095d04"],
Cell[880573, 22422, 6711, 176, 597, "Input",ExpressionUUID->"3b179d0a-b381-4ee0-9853-58e2fc48f6b3"],
Cell[887287, 22600, 872, 23, 83, "Input",ExpressionUUID->"6ab27073-a462-426a-80e5-8fff8938ccfd"],
Cell[888162, 22625, 985, 26, 83, "Input",ExpressionUUID->"fc023317-99f4-4411-a8ff-b9798d83b48a"],
Cell[889150, 22653, 1293, 38, 83, "Input",ExpressionUUID->"215346d4-1044-4b8b-99c7-4b576a79e4c3"],
Cell[890446, 22693, 574, 14, 64, "Input",ExpressionUUID->"a2991603-290f-486a-875e-9f0711e3c0e0"],
Cell[891023, 22709, 1111, 28, 102, "Input",ExpressionUUID->"9b8ab34b-5af1-438a-8195-449d43211bbb"],
Cell[892137, 22739, 1324, 35, 197, "Input",ExpressionUUID->"cd505e48-1393-4a30-a832-c9e76186e2fe"],
Cell[893464, 22776, 3896, 96, 292, "Input",ExpressionUUID->"f5741080-3d35-4a47-96f8-b7b16ab2bb80"],
Cell[897363, 22874, 10462, 242, 692, "Input",ExpressionUUID->"b7ea4099-994f-4282-8730-f80373b3942d"],
Cell[907828, 23118, 1941, 55, 102, "Input",ExpressionUUID->"bd6bfcea-b1ee-4492-a6f7-17cec4b7215b"],
Cell[909772, 23175, 1266, 33, 102, "Input",ExpressionUUID->"21d69ea2-426b-4e27-a1c9-d9aba4f249f6"]
}, Open  ]],
Cell[CellGroupData[{
Cell[911075, 23213, 83, 0, 45, "Subsubsection",ExpressionUUID->"bf417ba2-e9f3-4c77-99ab-7645de67d4e0"],
Cell[911161, 23215, 3626, 110, 430, "Input",ExpressionUUID->"82b3d452-686f-4c11-b839-b393f503b941"],
Cell[914790, 23327, 1122, 37, 85, "Input",ExpressionUUID->"0369f812-5cd8-451e-8822-a8c6afa59ae2"],
Cell[915915, 23366, 2546, 68, 71, "Input",ExpressionUUID->"5aff6887-b285-4d13-b55e-dac1afca7e7a"],
Cell[918464, 23436, 11154, 276, 561, "Input",ExpressionUUID->"bba9fd43-252e-4f5e-9106-0658b78c2869"],
Cell[929621, 23714, 2150, 68, 174, "Input",ExpressionUUID->"ca2f1a39-3aed-47fa-a954-e818a7f85ccd"],
Cell[931774, 23784, 2106, 59, 211, "Input",ExpressionUUID->"2c3fd109-9fd7-4bdf-ab53-673afeed7fe9"],
Cell[933883, 23845, 937, 24, 155, "Input",ExpressionUUID->"1e1fc832-f604-484f-895c-01b986e817bd"],
Cell[934823, 23871, 1826, 51, 174, "Input",ExpressionUUID->"5a06fbb7-bea8-4ce4-b99a-d349fac4b1d3"],
Cell[936652, 23924, 678, 22, 61, "Input",ExpressionUUID->"afc947b1-e116-464b-b24f-3c50a3e97ddb"],
Cell[937333, 23948, 3059, 87, 363, "Input",ExpressionUUID->"b7a9b684-1bde-47f1-b1f8-483fd2ae3aa2"],
Cell[940395, 24037, 5988, 163, 700, "Input",ExpressionUUID->"27e9c06c-02c1-42b0-b36a-fa0d86ffc7a3"],
Cell[946386, 24202, 17367, 432, 1598, "Input",ExpressionUUID->"74a85bde-78ed-4e4f-9161-c165a2a6fea1"],
Cell[963756, 24636, 2430, 72, 270, "Input",ExpressionUUID->"c6d5605e-ac73-464f-ac4f-77658150b9df"],
Cell[966189, 24710, 576, 15, 80, "Input",ExpressionUUID->"9e823de7-0f35-4585-b18a-4898832eb76e"],
Cell[966768, 24727, 6741, 187, 644, "Input",ExpressionUUID->"0b5d5f08-9ff5-4587-91a5-bd4e0d1ecd90"],
Cell[973512, 24916, 6611, 186, 607, "Input",ExpressionUUID->"42b22b1a-152d-4bd2-832b-0bfff4bbe62f"]
}, Closed]],
Cell[CellGroupData[{
Cell[980160, 25107, 102, 0, 37, "Subsubsection",ExpressionUUID->"0ee36883-06d9-4c86-b1ce-0f116a2bab4e"],
Cell[980265, 25109, 123, 2, 50, "Code",ExpressionUUID->"e1479055-0f9e-4aab-a4e6-69ba8e9eb244"],
Cell[980391, 25113, 244, 6, 44, "Input",ExpressionUUID->"a0566da8-c2e4-4666-bdb2-5fbb502d7167"],
Cell[980638, 25121, 130, 2, 50, "Code",ExpressionUUID->"c9649a9d-0eca-4695-b984-1014204bb4ae"],
Cell[980771, 25125, 339, 8, 44, "Input",ExpressionUUID->"024c6b46-48f8-4938-9644-e6e54abefe46"]
}, Open  ]]
}, Open  ]]
}, Open  ]]
}
]
*)

